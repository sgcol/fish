var express = require('express');
var crypto = require('crypto'),
    argv = require('yargs').argv,
    debugout = require('debugout')(argv.debugout);;
var router = express.Router();
var qs = require('querystring').stringify,
    url = require('url');
var httpf = require('httpf');
var getDB = require('../db.js'),
    ObjectID = require('mongodb').ObjectID;
var User = require('../User.js');
var merge=require('gy-merge'), sortObj=require('sort-object'), qs=require('querystring').stringify;

const MatchVS_APP_KEY='abcd',  MatchVS_APP_SECRET='qwer';

function md5(_str) {
	return crypto.createHash('md5').update(_str).digest('hex');
}
function chksign(req, res, next) {
    var allp=merge(req.query, req.body);
    var sign=allp.sign;
    delete allp.sign;
    var str=MatchVS_APP_KEY+'&'+qs(allp=sortObj(allp))+'&'+MatchVS_APP_SECRET;
    if (md5(str)==sign) return next();
    res.json({err:'sign err', param:allp, str:str, wanted:md5(str), recved:sign}).end();
};

router.all('/pay', chksign, httpf({ openOrderID: 'string', amount: 'number', callback: true }, function(orderid, money, callback) {
    // console.log('pay')
    var self = this;
    confirmOrder(orderid, money, self.req.ip, callback);
}));

module.exports = router;