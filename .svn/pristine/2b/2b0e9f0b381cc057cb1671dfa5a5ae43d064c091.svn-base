webpackJsonp([2],[,,,,,,,function(module,exports,__webpack_require__){(function(global){(function(){var window=window||global,document=document||(window.document={}),Laya=window.Laya=function(t,e){var i={__internals:[],__packages:{},__classmap:{Object:Object,Function:Function,Array:Array,String:String},__sysClass:{object:"Object",array:"Array",string:"String",dictionary:"Dictionary"},__propun:{writable:!0,enumerable:!1,configurable:!0},__presubstr:String.prototype.substr,__substr:function(t,e){return 1==arguments.length?i.__presubstr.call(this,t):i.__presubstr.call(this,t,e>0?e:this.length+e)},__init:function(t){t.forEach(function(t){t.__init$&&t.__init$()})},__isClass:function(t){return t&&(t.__isclass||t==Object||t==String||t==Array)},__newvec:function(t,e){var i=[];i.length=t;for(var n=0;t>n;n++)i[n]=e;return i},__extend:function(t,e){function n(){i.un(this,"constructor",t)}for(var r in e)if(e.hasOwnProperty(r)){var a=Object.getOwnPropertyDescriptor(e,r),s=a.get,o=a.set;s||o?s&&o?Object.defineProperty(t,r,a):(s&&Object.defineProperty(t,r,s),o&&Object.defineProperty(t,r,o)):t[r]=e[r]}n.prototype=e.prototype,t.prototype=new n,i.un(t.prototype,"__imps",i.__copy({},e.prototype.__imps))},__copy:function(t,e){if(!e)return null;t=t||{};for(var i in e)t[i]=e[i];return t},__package:function(e,n){if(!i.__packages[e]){i.__packages[e]=!0;var r=t,a=e.split(".");if(a.length>1)for(var s=0,o=a.length-1;o>s;s++){var h=r[a[s]];r=h?h:r[a[s]]={}}r[a[a.length-1]]||(r[a[a.length-1]]=n||{})}},__hasOwnProperty:function(t,e){function i(t,e){if(Object.hasOwnProperty.call(e.prototype,t))return!0;var n=e.prototype.__super;return null==n?null:i(t,n)}return e=e||this,Object.hasOwnProperty.call(e,t)||i(t,e.__class)},__typeof:function(t,e){if(!t||!e)return!1;if(e===String)return"string"==typeof t;if(e===Number)return"number"==typeof t;if(e.__interface__)e=e.__interface__;else if("string"!=typeof e)return t instanceof e;return t.__imps&&t.__imps[e]||t.__class==e},__as:function(t,e){return this.__typeof(t,e)?t:null},"interface":function(e,n){i.__package(e,{});var r=i.__internals,a=r[e]=r[e]||{self:e};if(n){var s=n.split(",");a.extend=[];for(var o=0;o<s.length;o++){var e=s[o];r[e]=r[e]||{self:e},a.extend.push(r[e])}}for(var h=t,l=e.split("."),o=0;o<l.length-1;o++)h=h[l[o]];h[l[l.length-1]]={__interface__:e}},"class":function(e,n,r,a){if(r&&i.__extend(e,r),n)if(i.__package(n,e),i.__classmap[n]=e,n.indexOf(".")>0){if(0==n.indexOf("laya.")){var s=n.split(".");a=a||s[s.length-1],i[a]&&console.log("Warning!,this class["+a+"] already exist:",i[a]),i[a]=e}}else"Main"==n?t.Main=e:(i[n]&&console.log("Error!,this class["+n+"] already exist:",i[n]),i[n]=e);var o=i.un,h=e.prototype;o(h,"hasOwnProperty",i.__hasOwnProperty),o(h,"__class",e),o(h,"__super",r),o(h,"__className",n),o(e,"__super",r),o(e,"__className",n),o(e,"__isclass",!0),o(e,"super",function(t){this.__super.call(t)})},imps:function(t,e){function n(t){var e,a;if((e=i.__internals[t])&&(r[t]=!0,a=e.extend))for(var s=0;s<a.length;s++)n(a[s].self)}if(!e)return null;var r=t.__imps||i.un(t,"__imps",{});for(var a in e)n(a)},getset:function(t,e,n,r,a){t?(r&&(e["_$GET_"+n]=r),a&&(e["_$SET_"+n]=a)):(r&&i.un(e,"_$get_"+n,r),a&&i.un(e,"_$set_"+n,a)),r&&a?Object.defineProperty(e,n,{get:r,set:a,enumerable:!1}):(r&&Object.defineProperty(e,n,{get:r,enumerable:!1}),a&&Object.defineProperty(e,n,{set:a,enumerable:!1}))},"static":function(t,e){function i(){var i=e[n],r=e[n+1];Object.defineProperty(t,i,{get:function(){return delete this[i],this[i]=r.call(this)},set:function(t){delete this[i],this[i]=t},enumerable:!0,configurable:!0})}for(var n=0,r=e.length;r>n;n+=2)"length"==e[n]?t.length=e[n+1].call(t):i()},un:function(t,e,n){return n||(n=t[e]),i.__propun.value=n,Object.defineProperty(t,e,i.__propun),n},uns:function(t,e){e.forEach(function(e){i.un(t,e)})}};return t.console=t.console||{log:function(){}},t.trace=t.console.log,Error.prototype.throwError=function(){throw arguments},String.prototype.substr=i.__substr,Object.defineProperty(Array.prototype,"fixed",{enumerable:!1}),i}(window,document);!function(t,e,i){i.un,i.uns,i["static"],i["class"],i.getset,i.__newvec}(window,document,Laya),function(window,document,Laya){var __un=Laya.un,__uns=Laya.uns,__static=Laya["static"],__class=Laya["class"],__getset=Laya.getset,__newvec=Laya.__newvec;Laya["interface"]("laya.runtime.IMarket"),Laya["interface"]("laya.filters.IFilter"),Laya["interface"]("laya.display.ILayout"),Laya["interface"]("laya.resource.IDispose"),Laya["interface"]("laya.runtime.IPlatform"),Laya["interface"]("laya.resource.IDestroy"),Laya["interface"]("laya.runtime.IConchNode"),Laya["interface"]("laya.filters.IFilterAction"),Laya["interface"]("laya.runtime.ICPlatformClass"),Laya["interface"]("laya.resource.ICreateResource"),Laya["interface"]("laya.runtime.IConchRenderObject"),Laya["interface"]("laya.runtime.IPlatformClass","laya.runtime.IPlatform");var RunDriver=function(){function t(){}return __class(t,"laya.utils.RunDriver"),t.FILTER_ACTIONS=[],t.pixelRatio=-1,t._charSizeTestDiv=null,t.now=function(){return Date.now()},t.getWindow=function(){return window},t.getPixelRatio=function(){if(t.pixelRatio<0){var e=Browser.context,i=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||e.msBackingStorePixelRatio||e.oBackingStorePixelRatio||e.backingStorePixelRatio||1;t.pixelRatio=(Browser.window.devicePixelRatio||1)/i,t.pixelRatio<1&&(t.pixelRatio=1)}return t.pixelRatio},t.getIncludeStr=function(t){return null},t.createShaderCondition=function(t){var e="(function() {return "+t+";})";return Browser.window.eval(e)},t.fontMap=[],t.measureText=function(e,i){var n=t.hanzi.test(e);if(n&&t.fontMap[i])return t.fontMap[i];var r=Browser.context;r.font=i;var a=r.measureText(e);return n&&(t.fontMap[i]=a),a},t.getWebGLContext=function(t){},t.beginFlush=function(){},t.endFinish=function(){},t.addToAtlas=null,t.flashFlushImage=function(t){},t.drawToCanvas=function(t,e,i,n,r,a){var s=HTMLCanvas.create("2D"),o=new RenderContext(i,n,s);return RenderSprite.renders[e]._fun(t,o,r,a),s},t.createParticleTemplate2D=null,t.createGLTextur=null,t.createWebGLContext2D=null,t.changeWebGLSize=function(t,e){},t.createRenderSprite=function(t,e){return new RenderSprite(t,e)},t.createFilterAction=function(t){return new ColorFilterAction},t.createGraphics=function(){return new Graphics},t.clear=function(t){Render._context.ctx.clear()},t.clearAtlas=function(t){},t.addTextureToAtlas=function(t){},t.getTexturePixels=function(t,e,i,n,r){return null},t.skinAniSprite=function(){return null},__static(t,["hanzi",function(){return this.hanzi=new RegExp("^[一-龥]$")}]),t}(),___Laya=function(){return __getset(1,Laya,"alertGlobalError",null,function(t){var e=0;t?Browser.window.onerror=function(t,i,n,r,a){e++<5&&a&&alert("出错啦，请把此信息截图给研发商\n"+t+"\n"+a.stack)}:Browser.window.onerror=null}),Laya.init=function(t,e,i){for(var n=[],r=2,a=arguments.length;a>r;r++)n.push(arguments[r]);if(!Laya._isinit){ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=Laya._arrayBufferSlice),Laya._isinit=!0,Browser.__init__(),Context.__init__(),Graphics.__init__(),Laya.timer=new Timer,Laya.loader=new LoaderManager;for(var r=0,s=n.length;s>r;r++)n[r].enable&&n[r].enable();Font.__init__(),Style.__init__(),ResourceManager.__init__(),CacheManger.beginCheck(),Laya._currentStage=Laya.stage=new Stage,Laya.stage.conchModel&&Laya.stage.conchModel.setRootNode();var o=Browser.window.location,h=o.pathname;return h=":"==h.charAt(2)?h.substring(1):h,URL.rootPath=URL.basePath=URL.getPath("file:"==o.protocol?h:o.protocol+"//"+o.host+o.pathname),Laya.render=new Render(0,0),Laya.stage.size(t,e),RenderSprite.__init__(),KeyBoardManager.__init__(),MouseManager.instance.__init__(Laya.stage,Render.canvas),Input.__init__(),SoundManager.autoStopMusic=!0,LocalStorage.__init__(),Render.canvas}},Laya._arrayBufferSlice=function(t,e){var i=this,n=new Uint8Array(i,t,e-t),r=new Uint8Array(n.length);return r.set(n),r.buffer},Laya.stage=null,Laya.timer=null,Laya.loader=null,Laya.version="1.7.9beta",Laya.render=null,Laya._currentStage=null,Laya._isinit=!1,__static(Laya,["conchMarket",function(){return this.conchMarket=window.conch?conchMarket:null},"PlatformClass",function(){return this.PlatformClass=window.PlatformClass}]),Laya}(),Config=function(){function t(){}return __class(t,"Config"),t.WebGLTextCacheCount=500,t.atlasEnable=!1,t.showCanvasMark=!1,t.animationInterval=50,t.isAntialias=!1,t.isAlpha=!1,t.premultipliedAlpha=!0,t.isStencil=!0,t.preserveDrawingBuffer=!1,t}(),EventDispatcher=function(){function t(){this._events=null}var e;__class(t,"laya.events.EventDispatcher");var i=t.prototype;return i.hasListener=function(t){var e=this._events&&this._events[t];return!!e},i.event=function(t,e){if(!this._events||!this._events[t])return!1;var i=this._events[t];if(i.run)i.once&&delete this._events[t],null!=e?i.runWith(e):i.run();else{for(var n=0,r=i.length;r>n;n++){var a=i[n];a&&(null!=e?a.runWith(e):a.run()),(!a||a.once)&&(i.splice(n,1),n--,r--)}0===i.length&&this._events&&delete this._events[t]}return!0},i.on=function(t,e,i,n){return this._createListener(t,e,i,n,!1)},i.once=function(t,e,i,n){return this._createListener(t,e,i,n,!0)},i._createListener=function(t,i,n,r,a,s){void 0===s&&(s=!0),s&&this.off(t,i,n,a);var o=e.create(i||this,n,r,a);this._events||(this._events={});var h=this._events;return h[t]?h[t].run?h[t]=[h[t],o]:h[t].push(o):h[t]=o,this},i.off=function(t,e,i,n){if(void 0===n&&(n=!1),!this._events||!this._events[t])return this;var r=this._events[t];if(null!=i)if(r.run)e&&r.caller!==e||r.method!==i||n&&!r.once||(delete this._events[t],r.recover());else{for(var a=0,s=0,o=r.length;o>s;s++){var h=r[s];!h||e&&h.caller!==e||h.method!==i||n&&!h.once||(a++,r[s]=null,h.recover())}a===o&&delete this._events[t]}return this},i.offAll=function(t){var e=this._events;if(!e)return this;if(t)this._recoverHandlers(e[t]),delete e[t];else{for(var i in e)this._recoverHandlers(e[i]);this._events=null}return this},i._recoverHandlers=function(t){if(t)if(t.run)t.recover();else for(var e=t.length-1;e>-1;e--)t[e]&&(t[e].recover(),t[e]=null)},i.isMouseEvent=function(e){return t.MOUSE_EVENTS[e]},t.MOUSE_EVENTS={rightmousedown:!0,rightmouseup:!0,rightclick:!0,mousedown:!0,mouseup:!0,mousemove:!0,mouseover:!0,mouseout:!0,click:!0,doubleclick:!0},t.__init$=function(){Object.defineProperty(laya.events.EventDispatcher.prototype,"_events",{enumerable:!1,writable:!0}),e=function(t){function e(t,i,n,r){e.__super.call(this,t,i,n,r)}__class(e,"",t);var i=e.prototype;return i.recover=function(){this._id>0&&(this._id=0,e._pool.push(this.clear()))},e.create=function(t,i,n,r){return void 0===r&&(r=!0),e._pool.length?e._pool.pop().setTo(t,i,n,r):new e(t,i,n,r)},e._pool=[],e}(Handler)},t}(),Handler=function(){function t(t,e,i,n){this.once=!1,this._id=0,void 0===n&&(n=!1),this.setTo(t,e,i,n)}__class(t,"laya.utils.Handler");var e=t.prototype;return e.setTo=function(e,i,n,r){return this._id=t._gid++,this.caller=e,this.method=i,this.args=n,this.once=r,this},e.run=function(){if(null==this.method)return null;var t=this._id,e=this.method.apply(this.caller,this.args);return this._id===t&&this.once&&this.recover(),e},e.runWith=function(t){if(null==this.method)return null;var e=this._id;if(null==t)var i=this.method.apply(this.caller,this.args);else i=this.args||t.unshift?this.args?this.method.apply(this.caller,this.args.concat(t)):this.method.apply(this.caller,t):this.method.call(this.caller,t);return this._id===e&&this.once&&this.recover(),i},e.clear=function(){return this.caller=null,this.method=null,this.args=null,this},e.recover=function(){this._id>0&&(this._id=0,t._pool.push(this.clear()))},t.create=function(e,i,n,r){return void 0===r&&(r=!0),t._pool.length?t._pool.pop().setTo(e,i,n,r):new t(e,i,n,r)},t._pool=[],t._gid=1,t}(),BitmapFont=function(){function t(){this._texture=null,this._fontCharDic={},this._fontWidthMap={},this._complete=null,this._path=null,this._maxWidth=0,this._spaceWidth=10,this._padding=null,this.fontSize=12,this.autoScaleSize=!1,this.letterSpacing=0}__class(t,"laya.display.BitmapFont");var e=t.prototype;return e.loadFont=function(t,e){this._path=t,this._complete=e,Laya.loader.load([{url:this._path,type:"xml"},{url:this._path.replace(".fnt",".png"),type:"image"}],Handler.create(this,this.onLoaded))},e.onLoaded=function(){this.parseFont(Loader.getRes(this._path),Loader.getRes(this._path.replace(".fnt",".png"))),this._complete&&this._complete.run()},e.parseFont=function(t,e){if(null!=t&&null!=e){this._texture=e;var i=1,n=t.getElementsByTagName("info");this.fontSize=parseInt(n[0].attributes.size.nodeValue);var r=n[0].attributes.padding.nodeValue,a=r.split(",");this._padding=[parseInt(a[0]),parseInt(a[1]),parseInt(a[2]),parseInt(a[3])];var s=t.getElementsByTagName("char"),o=0;for(o=0;o<s.length;o++){var h=s[o].attributes,l=parseInt(h.id.nodeValue),u=parseInt(h.xoffset.nodeValue)/i,c=parseInt(h.yoffset.nodeValue)/i,_=parseInt(h.xadvance.nodeValue)/i,d=new Rectangle;d.x=parseInt(h.x.nodeValue),d.y=parseInt(h.y.nodeValue),d.width=parseInt(h.width.nodeValue),d.height=parseInt(h.height.nodeValue);var f=Texture.create(e,d.x,d.y,d.width,d.height,u,c);this._maxWidth=Math.max(this._maxWidth,_+this.letterSpacing),this._fontCharDic[l]=f,this._fontWidthMap[l]=_}}},e.getCharTexture=function(t){return this._fontCharDic[t.charCodeAt(0)]},e.destroy=function(){if(this._texture){for(var t in this._fontCharDic){var e=this._fontCharDic[t];e&&e.destroy()}this._texture.destroy(),this._fontCharDic=null,this._fontWidthMap=null,this._texture=null}},e.setSpaceWidth=function(t){this._spaceWidth=t},e.getCharWidth=function(t){var e=t.charCodeAt(0);return this._fontWidthMap[e]?this._fontWidthMap[e]+this.letterSpacing:" "==t?this._spaceWidth+this.letterSpacing:0},e.getTextWidth=function(t){for(var e=0,i=0,n=t.length;n>i;i++)e+=this.getCharWidth(t.charAt(i));return e},e.getMaxWidth=function(){return this._maxWidth},e.getMaxHeight=function(){return this.fontSize},e.drawText=function(t,e,i,n,r,a){var s,o=this.getTextWidth(t),h=0;"center"===r&&(h=(a-o)/2),"right"===r&&(h=a-o);for(var l=0,u=0,c=t.length;c>u;u++)s=this.getCharTexture(t.charAt(u)),s&&(e.graphics.drawTexture(s,i+l+h,n),l+=this.getCharWidth(t.charAt(u)))},t}(),Style=function(){function t(){this.alpha=1,this.visible=!0,this.scrollRect=null,this.blendMode=null,this._type=0,this._tf=t._TF_EMPTY}__class(t,"laya.display.css.Style");var e=t.prototype;return e.getTransform=function(){return this._tf},e.setTransform=function(e){this._tf="none"!==e&&e?e:t._TF_EMPTY},e.setTranslateX=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.translateX=e},e.setTranslateY=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.translateY=e},e.setScaleX=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.scaleX=e},e.setScale=function(e,i){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.scaleX=e,this._tf.scaleY=i},e.setScaleY=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.scaleY=e},e.setRotate=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.rotate=e},e.setSkewX=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.skewX=e},e.setSkewY=function(e){this._tf===t._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.skewY=e},e.destroy=function(){this.scrollRect=null},e.render=function(t,e,i,n){},e.getCSSStyle=function(){return CSSStyle.EMPTY},e._enableLayout=function(){return!1},__getset(0,e,"scaleX",function(){return this._tf.scaleX},function(t){this.setScaleX(t)}),__getset(0,e,"transform",function(){return this.getTransform()},function(t){this.setTransform(t)}),__getset(0,e,"translateX",function(){return this._tf.translateX},function(t){this.setTranslateX(t)}),__getset(0,e,"translateY",function(){return this._tf.translateY},function(t){this.setTranslateY(t)}),__getset(0,e,"scaleY",function(){return this._tf.scaleY},function(t){this.setScaleY(t)}),__getset(0,e,"block",function(){return 0!=(1&this._type)}),__getset(0,e,"skewY",function(){return this._tf.skewY},function(t){this.setSkewY(t)}),__getset(0,e,"rotate",function(){return this._tf.rotate},function(t){this.setRotate(t)}),__getset(0,e,"skewX",function(){return this._tf.skewX},function(t){this.setSkewX(t)}),__getset(0,e,"paddingLeft",function(){return 0}),__getset(0,e,"paddingTop",function(){return 0}),__getset(0,e,"absolute",function(){return!0}),t.__init__=function(){t._TF_EMPTY=new TransformInfo,t.EMPTY=new t},t.EMPTY=null,t._TF_EMPTY=null,t}(),Font=function(){function t(e){this._type=0,this._weight=0,this._decoration=null,this._text=null,this.indent=0,this._color=Color.create(t.defaultColor),this.family=t.defaultFamily,this.stroke=t._STROKE,this.size=t.defaultSize,e&&e!==t.EMPTY&&e.copyTo(this)}__class(t,"laya.display.css.Font");var e=t.prototype;return e.set=function(t){this._text=null;for(var e=t.split(" "),i=0,n=e.length;n>i;i++){var r=e[i];switch(r){case"italic":this.italic=!0;continue;case"bold":this.bold=!0;continue}r.indexOf("px")>0&&(this.size=parseInt(r),this.family=e[i+1],i++)}},e.toString=function(){return this._text="",this.italic&&(this._text+="italic "),this.bold&&(this._text+="bold "),this._text+=this.size+"px "+this.family},e.copyTo=function(e){e._type=this._type,e._text=this._text,e._weight=this._weight,e._color=this._color,e.family=this.family,e.stroke=this.stroke!=t._STROKE?this.stroke.slice():t._STROKE,e.indent=this.indent,e.size=this.size},__getset(0,e,"password",function(){return 0!==(1024&this._type)},function(t){t?this._type|=1024:this._type&=-1025}),__getset(0,e,"color",function(){return this._color.strColor},function(t){this._color=Color.create(t)}),__getset(0,e,"italic",function(){return 0!==(512&this._type)},function(t){t?this._type|=512:this._type&=-513}),__getset(0,e,"bold",function(){return 0!==(2048&this._type)},function(t){t?this._type|=2048:this._type&=-2049}),__getset(0,e,"weight",function(){return""+this._weight},function(t){var e=0;switch(t){case"normal":break;case"bold":this.bold=!0,e=700;break;case"bolder":e=800;break;case"lighter":e=100;break;default:e=parseInt(t)}this._weight=e,this._text=null}),__getset(0,e,"decoration",function(){return this._decoration?this._decoration.value:"none"},function(t){var e=t.split(" ");switch(this._decoration||(this._decoration={}),e[0]){case"_":this._decoration.type="underline";break;case"-":this._decoration.type="line-through";break;case"overline":this._decoration.type="overline";break;default:this._decoration.type=e[0]}e[1]&&(this._decoration.color=Color.create(e)),this._decoration.value=t}),t.__init__=function(){t.EMPTY=new t(null)},t.EMPTY=null,t.defaultColor="#000000",t.defaultSize=12,t.defaultFamily="Arial",t.defaultFont="12px Arial",t._STROKE=[0,"#000000"],t._ITALIC=512,t._PASSWORD=1024,t._BOLD=2048,t}(),TransformInfo=function(){function t(){this.translateX=0,this.translateY=0,this.scaleX=1,this.scaleY=1,this.rotate=0,this.skewX=0,this.skewY=0}return __class(t,"laya.display.css.TransformInfo"),t}(),Graphics=function(){function t(){this._one=null,this._cmds=null,this._render=this._renderEmpty,Render.isConchNode&&(this._nativeObj=new _conchGraphics,this.id=this._nativeObj.conchID)}__class(t,"laya.display.Graphics");var e=t.prototype;return e.destroy=function(){this.clear(),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0),this._sp=null},e.clear=function(e){if(void 0===e&&(e=!1),e){var i=this._one;if(this._cmds){var n=0,r=this._cmds.length;for(n=0;r>n;n++)i=this._cmds[n],!i||i.callee!==Render._context._drawTexture&&i.callee!==Render._context._drawTextureWithTransform||(i[0]=null,t._cache.push(i));this._cmds.length=0}else i&&(!i||i.callee!==Render._context._drawTexture&&i.callee!==Render._context._drawTextureWithTransform||(i[0]=null,t._cache.push(i)))}else this._cmds=null;if(this._one=null,this._render=this._renderEmpty,this._sp&&(this._sp._renderType&=-514),this._repaint(),this._vectorgraphArray){for(n=0,r=this._vectorgraphArray.length;r>n;n++)VectorGraphManager.getInstance().deleteShape(this._vectorgraphArray[n]);this._vectorgraphArray.length=0}},e._clearBoundsCache=function(){this._graphicBounds&&this._graphicBounds.reset()},e._initGraphicBounds=function(){this._graphicBounds||(this._graphicBounds=new GraphicsBounds,this._graphicBounds._graphics=this)},e._repaint=function(){this._clearBoundsCache(),this._sp&&this._sp.repaint()},e._isOnlyOne=function(){return!this._cmds||0===this._cmds.length},e.getBounds=function(t){return void 0===t&&(t=!1),this._initGraphicBounds(),this._graphicBounds.getBounds(t)},e.getBoundPoints=function(t){return void 0===t&&(t=!1),this._initGraphicBounds(),this._graphicBounds.getBoundPoints(t)},e._addCmd=function(t){this._cmds=this._cmds||[],t.callee=t.shift(),this._cmds.push(t)},e.drawTexture=function(e,i,n,r,a,s,o){if(void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===o&&(o=1),!e||.01>o)return null;r||(r=e.sourceWidth),a||(a=e.sourceHeight);var h=r/e.sourceWidth,l=a/e.sourceHeight;if(r=e.width*h,a=e.height*l,e.loaded&&(0>=r||0>=a))return null;if(i+=e.offsetX*h,n+=e.offsetY*l,this._sp&&(this._sp._renderType|=512),t._cache.length){var u=t._cache.pop();u[0]=e,u[1]=i,u[2]=n,u[3]=r,u[4]=a,u[5]=s,u[6]=o}else u=[e,i,n,r,a,s,o];return u.callee=s||1!=o?Render._context._drawTextureWithTransform:Render._context._drawTexture,null!=this._one||s||1!=o?this._saveToCmd(u.callee,u):(this._one=u,this._render=this._renderOneImg),e.loaded||e.once("loaded",this,this._textureLoaded,[e,u]),this._repaint(),u},e.cleanByTexture=function(t,e,i,n,r){if(void 0===n&&(n=0),void 0===r&&(r=0),!t)return this.clear();if(this._one&&this._render===this._renderOneImg){n||(n=t.sourceWidth),r||(r=t.sourceHeight);var a=n/t.sourceWidth,s=r/t.sourceHeight;n=t.width*a,r=t.height*s,e+=t.offsetX*a,i+=t.offsetY*s,this._one[0]=t,this._one[1]=e,this._one[2]=i,this._one[3]=n,this._one[4]=r}else this.clear(),t&&this.drawTexture(t,e,i,n,r)},e.drawTextures=function(t,e){t&&this._saveToCmd(Render._context._drawTextures,[t,e])},e.fillTexture=function(t,e,i,n,r,a,s){if(void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a="repeat"),t){var o=[t,e,i,n,r,a,s||Point.EMPTY,{}];t.loaded||t.once("loaded",this,this._textureLoaded,[t,o]),this._saveToCmd(Render._context._fillTexture,o)}},e._textureLoaded=function(t,e){e[3]=e[3]||t.width,e[4]=e[4]||t.height,this._repaint()},e._saveToCmd=function(t,e){return this._sp&&(this._sp._renderType|=512),null==this._one?(this._one=e,this._render=this._renderOne):(this._sp&&(this._sp._renderType&=-2),this._render=this._renderAll,0===(this._cmds||(this._cmds=[])).length&&this._cmds.push(this._one),this._cmds.push(e)),e.callee=t,this._repaint(),e},e.clipRect=function(t,e,i,n){this._saveToCmd(Render._context._clipRect,[t,e,i,n])},e.fillText=function(t,e,i,n,r,a){this._saveToCmd(Render._context._fillText,[t,e,i,n||Font.defaultFont,r,a])},e.fillBorderText=function(t,e,i,n,r,a,s,o){this._saveToCmd(Render._context._fillBorderText,[t,e,i,n||Font.defaultFont,r,a,s,o])},e.strokeText=function(t,e,i,n,r,a,s){this._saveToCmd(Render._context._strokeText,[t,e,i,n||Font.defaultFont,r,a,s])},e.alpha=function(t){this._saveToCmd(Render._context._alpha,[t])},e.setAlpha=function(t){this._saveToCmd(Render._context._setAlpha,[t])},e.transform=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0),this._saveToCmd(Render._context._transform,[t,e,i])},e.rotate=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=0),this._saveToCmd(Render._context._rotate,[t,e,i])},e.scale=function(t,e,i,n){void 0===i&&(i=0),void 0===n&&(n=0),this._saveToCmd(Render._context._scale,[t,e,i,n])},e.translate=function(t,e){this._saveToCmd(Render._context._translate,[t,e])},e.save=function(){this._saveToCmd(Render._context._save,[])},e.restore=function(){this._saveToCmd(Render._context._restore,[])},e.replaceText=function(t){this._repaint();var e=this._cmds;if(e){for(var i=e.length-1;i>-1;i--)if(this._isTextCmd(e[i].callee))return e[i][0].toUpperCase?e[i][0]=t:e[i][0].setText(t),!0}else if(this._one&&this._isTextCmd(this._one.callee))return this._one[0].toUpperCase?this._one[0]=t:this._one[0].setText(t),!0;return!1},e._isTextCmd=function(t){return t===Render._context._fillText||t===Render._context._fillBorderText||t===Render._context._strokeText},e.replaceTextColor=function(t){this._repaint();var e=this._cmds;if(e)for(var i=e.length-1;i>-1;i--)this._isTextCmd(e[i].callee)&&(e[i][4]=t,e[i][0].toUpperCase||(e[i][0].changed=!0));else this._one&&this._isTextCmd(this._one.callee)&&(this._one[4]=t,this._one[0].toUpperCase||(this._one[0].changed=!0))},e.loadImage=function(t,e,i,n,r,a){function s(t){t&&(o.drawTexture(t,e,i,n,r),null!=a&&a.call(o._sp,t))}var o=this;void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0);var h=Loader.getRes(t);h?s(h):Laya.loader.load(t,Handler.create(null,s),null,"image")},e._renderEmpty=function(t,e,i,n){},e._renderAll=function(t,e,i,n){for(var r,a=this._cmds,s=0,o=a.length;o>s;s++)(r=a[s]).callee.call(e,i,n,r)},e._renderOne=function(t,e,i,n){this._one.callee.call(e,i,n,this._one)},e._renderOneImg=function(t,e,i,n){this._one.callee.call(e,i,n,this._one),2305!==t._renderType&&(t._renderType|=1)},e.drawLine=function(t,e,i,n,r,a){void 0===a&&(a=1);var s=0;Render.isWebGL&&(s=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(s));var o=a%2===0?0:.5,h=[t+o,e+o,i+o,n+o,r,a,s];this._saveToCmd(Render._context._drawLine,h)},e.drawLines=function(t,e,i,n,r){void 0===r&&(r=1);var a=0;if(i&&!(i.length<4)){Render.isWebGL&&(a=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(a));var s=r%2===0?0:.5,o=[t+s,e+s,i,n,r,a];this._saveToCmd(Render._context._drawLines,o)}},e.drawCurves=function(t,e,i,n,r){void 0===r&&(r=1);var a=[t,e,i,n,r];this._saveToCmd(Render._context._drawCurves,a)},e.drawRect=function(t,e,i,n,r,a,s){void 0===s&&(s=1);var o=a?s/2:0,h=a?s:0,l=[t+o,e+o,i-h,n-h,r,a,s];this._saveToCmd(Render._context._drawRect,l)},e.drawCircle=function(t,e,i,n,r,a){void 0===a&&(a=1);var s=r?a/2:0,o=0;Render.isWebGL&&(o=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(o));var h=[t,e,i-s,n,r,a,o];this._saveToCmd(Render._context._drawCircle,h)},e.drawPie=function(t,e,i,n,r,a,s,o){void 0===o&&(o=1);var h=s?o/2:0,l=s?o:0,u=0;Render.isWebGL&&(u=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(u));var c=[t+h,e+h,i-l,n,r,a,s,o,u];c[3]=Utils.toRadian(n),c[4]=Utils.toRadian(r),this._saveToCmd(Render._context._drawPie,c)},e.drawPoly=function(t,e,i,n,r,a){void 0===a&&(a=1);var s=0;if(Render.isWebGL){s=VectorGraphManager.getInstance().getId(),null==this._vectorgraphArray&&(this._vectorgraphArray=[]),this._vectorgraphArray.push(s);var o=!1;o=i.length>6?!1:!0}var h=r?a%2===0?0:.5:0,l=[t+h,e+h,i,n,r,a,s,o];this._saveToCmd(Render._context._drawPoly,l)},e.drawPath=function(t,e,i,n,r){var a=[t,e,i,n,r];this._saveToCmd(Render._context._drawPath,a)},__getset(0,e,"cmds",function(){return this._cmds},function(t){this._sp&&(this._sp._renderType|=512),this._cmds=t,this._render=this._renderAll,this._repaint()}),t.__init__=function(){if(Render.isConchNode){for(var t=laya.display.Graphics.prototype,e=ConchGraphics.prototype,i=["clear","destroy","alpha","rotate","transform","scale","translate","save","restore","clipRect","blendMode","fillText","fillBorderText","_fands","drawRect","drawCircle","drawPie","drawPoly","drawPath","drawImageM","drawLine","drawLines","_drawPs","drawCurves","replaceText","replaceTextColor","_fillImage","fillTexture","setSkinMesh","drawParticle","drawImageS"],n=0,r=i.length;r>=n;n++){var a=i[n];t[a]=e[a]}t._saveToCmd=null,e.drawImageS&&(t.drawTextures=function(t,e){if(t&&t.loaded&&t.bitmap&&t.source){var i=t.uv,n=t.bitmap.width,r=t.bitmap.height;this.drawImageS(t.bitmap.source,i[0]*n,i[1]*r,(i[2]-i[0])*n,(i[5]-i[3])*r,t.offsetX,t.offsetY,t.width,t.height,e)}}),t.drawTexture=function(t,e,i,n,r,a,s){if(void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===s&&(s=1),t){if(!t.loaded)return void t.once("loaded",this,function(){this.drawTexture(t,e,i,n,r,a)});if(t.loaded&&t.bitmap&&t.source&&(n||(n=t.sourceWidth),r||(r=t.sourceHeight),n=n-t.sourceWidth+t.width,r=r-t.sourceHeight+t.height,!(0>=n||0>=r))){e+=t.offsetX,i+=t.offsetY;var o=t.uv,h=t.bitmap.width,l=t.bitmap.height;this.drawImageM(t.bitmap.source,o[0]*h,o[1]*l,(o[2]-o[0])*h,(o[5]-o[3])*l,e,i,n,r,a,s),this._repaint()}}},t.fillTexture=function(t,e,i,n,r,a,s){if(void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a="repeat"),t&&t.loaded){var o,h=Render._context.ctx,l=t.bitmap.width,u=t.bitmap.height,c=t.uv;o=t.uv!=Texture.DEF_UV?h.createPattern(t.bitmap.source,a,c[0]*l,c[1]*u,(c[2]-c[0])*l,(c[5]-c[3])*u):h.createPattern(t.bitmap.source,a);var _=0,d=0;s&&(e+=s.x%t.width,i+=s.y%t.height,_-=s.x%t.width,d-=s.y%t.height),this._fillImage(o,e,i,_,d,n,r)}}}},t._cache=[],t}(),GraphicsBounds=function(){function t(){this._cacheBoundsType=!1}__class(t,"laya.display.GraphicsBounds");var e=t.prototype;return e.destroy=function(){this._graphics=null,this._temp=null,this._rstBoundPoints=null,this._bounds=null},e.reset=function(){this._temp&&(this._temp.length=0)},e.getBounds=function(t){return void 0===t&&(t=!1),(!this._bounds||!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._bounds=Rectangle._getWrapRec(this.getBoundPoints(t),this._bounds)),this._cacheBoundsType=t,this._bounds},e.getBoundPoints=function(t){return void 0===t&&(t=!1),(!this._temp||this._temp.length<1||t!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(t)),this._cacheBoundsType=t,this._rstBoundPoints=Utils.copyArray(this._rstBoundPoints,this._temp)},e._getCmdPoints=function(e){void 0===e&&(e=!1);var i,n=Render._context,r=this._graphics.cmds;if(i=this._temp||(this._temp=[]),i.length=0,r||null==this._graphics._one||(t._tempCmds.length=0,t._tempCmds.push(this._graphics._one),r=t._tempCmds),!r)return i;var a;a=t._tempMatrixArrays,a.length=0;var s=t._initMatrix;s.identity();for(var o,h,l=t._tempMatrix,u=0,c=r.length;c>u;u++)switch(o=r[u],o.callee){case n._save:case 7:a.push(s),s=s.clone();break;case n._restore:case 8:s=a.pop();break;case n._scale:case 5:l.identity(),l.translate(-o[2],-o[3]),l.scale(o[0],o[1]),l.translate(o[2],o[3]),this._switchMatrix(s,l);break;case n._rotate:case 3:l.identity(),l.translate(-o[1],-o[2]),l.rotate(o[0]),l.translate(o[1],o[2]),this._switchMatrix(s,l);break;case n._translate:case 6:l.identity(),l.translate(o[0],o[1]),this._switchMatrix(s,l);break;case n._transform:case 4:l.identity(),l.translate(-o[1],-o[2]),l.concat(o[0]),l.translate(o[1],o[2]),this._switchMatrix(s,l);break;case 16:case 24:t._addPointArrToRst(i,Rectangle._getBoundPointS(o[0],o[1],o[2],o[3]),s);break;case 17:s.copyTo(l),l.concat(o[4]),t._addPointArrToRst(i,Rectangle._getBoundPointS(o[0],o[1],o[2],o[3]),l);break;case n._drawTexture:if(h=o[0],e)o[3]&&o[4]?t._addPointArrToRst(i,Rectangle._getBoundPointS(o[1],o[2],o[3],o[4]),s):(h=o[0],t._addPointArrToRst(i,Rectangle._getBoundPointS(o[1],o[2],h.width,h.height),s));else{var _=(o[3]||h.sourceWidth)/h.width,d=(o[4]||h.sourceHeight)/h.height,f=_*h.sourceWidth,p=d*h.sourceHeight,m=h.offsetX>0?h.offsetX:0,g=h.offsetY>0?h.offsetY:0;m*=_,g*=d,t._addPointArrToRst(i,Rectangle._getBoundPointS(o[1]-m,o[2]-g,f,p),s)}break;case n._fillTexture:o[3]&&o[4]?t._addPointArrToRst(i,Rectangle._getBoundPointS(o[1],o[2],o[3],o[4]),s):(h=o[0],t._addPointArrToRst(i,Rectangle._getBoundPointS(o[1],o[2],h.width,h.height),s));break;case n._drawTextureWithTransform:var y;o[5]?(s.copyTo(l),l.concat(o[5]),y=l):y=s,e?o[3]&&o[4]?t._addPointArrToRst(i,Rectangle._getBoundPointS(o[1],o[2],o[3],o[4]),y):(h=o[0],t._addPointArrToRst(i,Rectangle._getBoundPointS(o[1],o[2],h.width,h.height),y)):(h=o[0],_=(o[3]||h.sourceWidth)/h.width,
d=(o[4]||h.sourceHeight)/h.height,f=_*h.sourceWidth,p=d*h.sourceHeight,m=h.offsetX>0?h.offsetX:0,g=h.offsetY>0?h.offsetY:0,m*=_,g*=d,t._addPointArrToRst(i,Rectangle._getBoundPointS(o[1]-m,o[2]-g,f,p),y));break;case n._drawRect:case 13:t._addPointArrToRst(i,Rectangle._getBoundPointS(o[0],o[1],o[2],o[3]),s);break;case n._drawCircle:case n._fillCircle:case 14:t._addPointArrToRst(i,Rectangle._getBoundPointS(o[0]-o[2],o[1]-o[2],o[2]+o[2],o[2]+o[2]),s);break;case n._drawLine:case 20:t._tempPoints.length=0;var x=NaN;x=.5*o[5],o[0]==o[2]?t._tempPoints.push(o[0]+x,o[1],o[2]+x,o[3],o[0]-x,o[1],o[2]-x,o[3]):o[1]==o[3]?t._tempPoints.push(o[0],o[1]+x,o[2],o[3]+x,o[0],o[1]-x,o[2],o[3]-x):t._tempPoints.push(o[0],o[1],o[2],o[3]),t._addPointArrToRst(i,t._tempPoints,s);break;case n._drawCurves:case 22:t._addPointArrToRst(i,Bezier.I.getBezierPoints(o[2]),s,o[0],o[1]);break;case n._drawPoly:case n._drawLines:case 18:t._addPointArrToRst(i,o[2],s,o[0],o[1]);break;case n._drawPath:case 19:t._addPointArrToRst(i,this._getPathPoints(o[2]),s,o[0],o[1]);break;case n._drawPie:case 15:t._addPointArrToRst(i,this._getPiePoints(o[0],o[1],o[2],o[3],o[4]),s)}return i.length>200?i=Utils.copyArray(i,Rectangle._getWrapRec(i)._getBoundPoints()):i.length>8&&(i=GrahamScan.scanPList(i)),i},e._switchMatrix=function(t,e){e.concat(t),e.copyTo(t)},e._getPiePoints=function(e,i,n,r,a){var s=t._tempPoints;t._tempPoints.length=0,s.push(e,i);var o=Math.PI/10,h=NaN;for(h=r;a>h;h+=o)s.push(e+n*Math.cos(h),i+n*Math.sin(h));return a!=h&&s.push(e+n*Math.cos(a),i+n*Math.sin(a)),s},e._getPathPoints=function(e){var i=0,n=0,r=t._tempPoints;r.length=0,n=e.length;var a;for(i=0;n>i;i++)a=e[i],a.length>1&&(r.push(a[1],a[2]),a.length>3&&r.push(a[3],a[4]));return r},t._addPointArrToRst=function(e,i,n,r,a){void 0===r&&(r=0),void 0===a&&(a=0);var s=0,o=0;for(o=i.length,s=0;o>s;s+=2)t._addPointToRst(e,i[s]+r,i[s+1]+a,n)},t._addPointToRst=function(t,e,i,n){var r=Point.TEMP;r.setTo(e?e:0,i?i:0),n.transformPoint(r),t.push(r.x,r.y)},t._tempPoints=[],t._tempMatrixArrays=[],t._tempCmds=[],__static(t,["_tempMatrix",function(){return this._tempMatrix=new Matrix},"_initMatrix",function(){return this._initMatrix=new Matrix}]),t}(),Event=function(){function t(){}__class(t,"laya.events.Event");var e=t.prototype;return e.setTo=function(t,e,i){return this.type=t,this.currentTarget=e,this.target=i,this},e.stopPropagation=function(){this._stoped=!0},__getset(0,e,"stageY",function(){return Laya.stage.mouseY}),__getset(0,e,"charCode",function(){return this.nativeEvent.charCode}),__getset(0,e,"touches",function(){var t=this.nativeEvent.touches;if(t)for(var e=Laya.stage,i=0,n=t.length;n>i;i++){var r=t[i],a=Point.TEMP;a.setTo(r.clientX,r.clientY),e._canvasTransform.invertTransformPoint(a),e.transform.invertTransformPoint(a),r.stageX=a.x,r.stageY=a.y}return t}),__getset(0,e,"keyLocation",function(){return this.nativeEvent.keyLocation}),__getset(0,e,"ctrlKey",function(){return this.nativeEvent.ctrlKey}),__getset(0,e,"altKey",function(){return this.nativeEvent.altKey}),__getset(0,e,"shiftKey",function(){return this.nativeEvent.shiftKey}),__getset(0,e,"stageX",function(){return Laya.stage.mouseX}),t.EMPTY=new t,t.MOUSE_DOWN="mousedown",t.MOUSE_UP="mouseup",t.CLICK="click",t.RIGHT_MOUSE_DOWN="rightmousedown",t.RIGHT_MOUSE_UP="rightmouseup",t.RIGHT_CLICK="rightclick",t.MOUSE_MOVE="mousemove",t.MOUSE_OVER="mouseover",t.MOUSE_OUT="mouseout",t.MOUSE_WHEEL="mousewheel",t.ROLL_OVER="mouseover",t.ROLL_OUT="mouseout",t.DOUBLE_CLICK="doubleclick",t.CHANGE="change",t.CHANGED="changed",t.RESIZE="resize",t.ADDED="added",t.REMOVED="removed",t.DISPLAY="display",t.UNDISPLAY="undisplay",t.ERROR="error",t.COMPLETE="complete",t.LOADED="loaded",t.PROGRESS="progress",t.INPUT="input",t.RENDER="render",t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.KEY_DOWN="keydown",t.KEY_PRESS="keypress",t.KEY_UP="keyup",t.FRAME="enterframe",t.DRAG_START="dragstart",t.DRAG_MOVE="dragmove",t.DRAG_END="dragend",t.ENTER="enter",t.SELECT="select",t.BLUR="blur",t.FOCUS="focus",t.VISIBILITY_CHANGE="visibilitychange",t.FOCUS_CHANGE="focuschange",t.PLAYED="played",t.PAUSED="paused",t.STOPPED="stopped",t.START="start",t.END="end",t.ENABLE_CHANGED="enablechanged",t.ACTIVE_IN_HIERARCHY_CHANGED="activeinhierarchychanged",t.COMPONENT_ADDED="componentadded",t.COMPONENT_REMOVED="componentremoved",t.LAYER_CHANGED="layerchanged",t.HIERARCHY_LOADED="hierarchyloaded",t.RECOVERED="recovered",t.RELEASED="released",t.LINK="link",t.LABEL="label",t.FULL_SCREEN_CHANGE="fullscreenchange",t.DEVICE_LOST="devicelost",t.MESH_CHANGED="meshchanged",t.MATERIAL_CHANGED="materialchanged",t.WORLDMATRIX_NEEDCHANGE="worldmatrixneedchanged",t.ANIMATION_CHANGED="animationchanged",t}(),Keyboard=function(){function t(){}return __class(t,"laya.events.Keyboard"),t.NUMBER_0=48,t.NUMBER_1=49,t.NUMBER_2=50,t.NUMBER_3=51,t.NUMBER_4=52,t.NUMBER_5=53,t.NUMBER_6=54,t.NUMBER_7=55,t.NUMBER_8=56,t.NUMBER_9=57,t.A=65,t.B=66,t.C=67,t.D=68,t.E=69,t.F=70,t.G=71,t.H=72,t.I=73,t.J=74,t.K=75,t.L=76,t.M=77,t.N=78,t.O=79,t.P=80,t.Q=81,t.R=82,t.S=83,t.T=84,t.U=85,t.V=86,t.W=87,t.X=88,t.Y=89,t.Z=90,t.F1=112,t.F2=113,t.F3=114,t.F4=115,t.F5=116,t.F6=117,t.F7=118,t.F8=119,t.F9=120,t.F10=121,t.F11=122,t.F12=123,t.F13=124,t.F14=125,t.F15=126,t.NUMPAD=21,t.NUMPAD_0=96,t.NUMPAD_1=97,t.NUMPAD_2=98,t.NUMPAD_3=99,t.NUMPAD_4=100,t.NUMPAD_5=101,t.NUMPAD_6=102,t.NUMPAD_7=103,t.NUMPAD_8=104,t.NUMPAD_9=105,t.NUMPAD_ADD=107,t.NUMPAD_DECIMAL=110,t.NUMPAD_DIVIDE=111,t.NUMPAD_ENTER=108,t.NUMPAD_MULTIPLY=106,t.NUMPAD_SUBTRACT=109,t.SEMICOLON=186,t.EQUAL=187,t.COMMA=188,t.MINUS=189,t.PERIOD=190,t.SLASH=191,t.BACKQUOTE=192,t.LEFTBRACKET=219,t.BACKSLASH=220,t.RIGHTBRACKET=221,t.QUOTE=222,t.ALTERNATE=18,t.BACKSPACE=8,t.CAPS_LOCK=20,t.COMMAND=15,t.CONTROL=17,t.DELETE=46,t.ENTER=13,t.ESCAPE=27,t.PAGE_UP=33,t.PAGE_DOWN=34,t.END=35,t.HOME=36,t.LEFT=37,t.UP=38,t.RIGHT=39,t.DOWN=40,t.SHIFT=16,t.SPACE=32,t.TAB=9,t.INSERT=45,t}(),KeyBoardManager=function(){function t(){}return __class(t,"laya.events.KeyBoardManager"),t.__init__=function(){t._addEvent("keydown"),t._addEvent("keypress"),t._addEvent("keyup")},t._addEvent=function(t){Browser.document.addEventListener(t,function(e){laya.events.KeyBoardManager._dispatch(e,t)},!0)},t._dispatch=function(e,i){if(t.enabled){t._event._stoped=!1,t._event.nativeEvent=e,t._event.keyCode=e.keyCode||e.which||e.charCode,"keydown"===i?t._pressKeys[t._event.keyCode]=!0:"keyup"===i&&(t._pressKeys[t._event.keyCode]=null);for(var n=Laya.stage.focus&&null!=Laya.stage.focus.event&&Laya.stage.focus.displayedInStage?Laya.stage.focus:Laya.stage,r=n;r;)r.event(i,t._event.setTo(i,r,n)),r=r.parent}},t.hasKeyDown=function(e){return t._pressKeys[e]},t._pressKeys={},t.enabled=!0,__static(t,["_event",function(){return this._event=new Event}]),t}(),KeyLocation=function(){function t(){}return __class(t,"laya.events.KeyLocation"),t.STANDARD=0,t.LEFT=1,t.RIGHT=2,t.NUM_PAD=3,t}(),MouseManager=function(){function t(){this.mouseX=0,this.mouseY=0,this.disableMouseEvent=!1,this.mouseDownTime=0,this.mouseMoveAccuracy=2,this._stage=null,this._target=null,this._lastMoveTimer=0,this._isLeftMouse=!1,this._eventList=[],this._touchIDs={},this._id=1,this._tTouchID=0,this._event=new Event,this._matrix=new Matrix,this._point=new Point,this._rect=new Rectangle,this._prePoint=new Point,this._curTouchID=NaN}__class(t,"laya.events.MouseManager");var e=t.prototype;return e.__init__=function(e,i){this._stage=e;var n=this,r=this._eventList;i.oncontextmenu=function(e){return t.enabled?!1:void 0},i.addEventListener("mousedown",function(e){t.enabled&&(Browser.onIE||e.preventDefault(),r.push(e),n.mouseDownTime=Browser.now())}),i.addEventListener("mouseup",function(e){t.enabled&&(e.preventDefault(),r.push(e),n.mouseDownTime=-Browser.now())},!0),i.addEventListener("mousemove",function(e){if(t.enabled){e.preventDefault();var i=Browser.now();if(i-n._lastMoveTimer<10)return;n._lastMoveTimer=i,r.push(e)}},!0),i.addEventListener("mouseout",function(e){t.enabled&&r.push(e)}),i.addEventListener("mouseover",function(e){t.enabled&&r.push(e)}),i.addEventListener("touchstart",function(e){t.enabled&&(r.push(e),Input.isInputting||e.preventDefault(),n.mouseDownTime=Browser.now())}),i.addEventListener("touchend",function(e){t.enabled&&(Input.isInputting||e.preventDefault(),r.push(e),n.mouseDownTime=-Browser.now())},!0),i.addEventListener("touchmove",function(e){t.enabled&&(e.preventDefault(),r.push(e))},!0),i.addEventListener("touchcancel",function(e){t.enabled&&(e.preventDefault(),r.push(e))},!0),i.addEventListener("mousewheel",function(e){t.enabled&&r.push(e)}),i.addEventListener("DOMMouseScroll",function(e){t.enabled&&r.push(e)})},e.initEvent=function(t,e){var i=this;i._event._stoped=!1,i._event.nativeEvent=e||t,i._target=null,this._point.setTo(t.pageX||t.clientX,t.pageY||t.clientY),this._stage._canvasTransform.invertTransformPoint(this._point),i.mouseX=this._point.x,i.mouseY=this._point.y,i._event.touchId=t.identifier||0,this._tTouchID=i._event.touchId;var n;n=TouchManager.I._event,n._stoped=!1,n.nativeEvent=i._event.nativeEvent,n.touchId=i._event.touchId},e.checkMouseWheel=function(t){this._event.delta=t.wheelDelta?.025*t.wheelDelta:-t.detail;for(var e=TouchManager.I.getLastOvers(),i=0,n=e.length;n>i;i++){var r=e[i];r.event("mousewheel",this._event.setTo("mousewheel",r,this._target))}},e.onMouseMove=function(t){TouchManager.I.onMouseMove(t,this._tTouchID)},e.onMouseDown=function(t){if(Input.isInputting&&Laya.stage.focus&&Laya.stage.focus.focus&&!Laya.stage.focus.contains(this._target)){var e=Laya.stage.focus._tf||Laya.stage.focus,i=t._tf||t;i instanceof laya.display.Input&&i.multiline==e.multiline?e._focusOut():e.focus=!1}TouchManager.I.onMouseDown(t,this._tTouchID,this._isLeftMouse)},e.onMouseUp=function(t){TouchManager.I.onMouseUp(t,this._tTouchID,this._isLeftMouse)},e.check=function(t,e,i,n){this._point.setTo(e,i),t.fromParentPoint(this._point),e=this._point.x,i=this._point.y;var r=t.scrollRect;if(r&&(this._rect.setTo(r.x,r.y,r.width,r.height),!this._rect.contains(e,i)))return!1;if(!this.disableMouseEvent){if(t.hitTestPrior&&!t.mouseThrough&&!this.hitTest(t,e,i))return!1;for(var a=t._childs.length-1;a>-1;a--){var s=t._childs[a];if(!s.destroyed&&s.mouseEnabled&&s.visible&&this.check(s,e,i,n))return!0}}var o=!t.hitTestPrior||t.mouseThrough||this.disableMouseEvent?this.hitTest(t,e,i):!0;return o?(this._target=t,n.call(this,t)):n===this.onMouseUp&&t===this._stage&&(this._target=this._stage,n.call(this,this._target)),o},e.hitTest=function(t,e,i){var n=!1;if(t.scrollRect&&(e-=t.scrollRect.x,i-=t.scrollRect.y),t.hitArea instanceof laya.utils.HitArea)return t.hitArea.isHit(e,i);if(t.width>0&&t.height>0||t.mouseThrough||t.hitArea)if(t.mouseThrough)n=t.getGraphicBounds().contains(e,i);else{var r=this._rect;t.hitArea?r=t.hitArea:r.setTo(0,0,t.width,t.height),n=r.contains(e,i)}return n},e.runEvent=function(){var e=this._eventList.length;if(e){for(var i=this,n=0;e>n;){var r=this._eventList[n];switch("mousemove"!==r.type&&(this._prePoint.x=this._prePoint.y=-1e6),r.type){case"mousedown":this._touchIDs[0]=this._id++,t._isTouchRespond?t._isTouchRespond=!1:(i._isLeftMouse=0===r.button,i.initEvent(r),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseDown));break;case"mouseup":i._isLeftMouse=0===r.button,i.initEvent(r),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseUp);break;case"mousemove":Math.abs(this._prePoint.x-r.clientX)+Math.abs(this._prePoint.y-r.clientY)>=this.mouseMoveAccuracy&&(this._prePoint.x=r.clientX,this._prePoint.y=r.clientY,i.initEvent(r),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseMove));break;case"touchstart":t._isTouchRespond=!0,i._isLeftMouse=!0;for(var a=r.changedTouches,s=0,o=a.length;o>s;s++){var h=a[s];(t.multiTouchEnabled||isNaN(this._curTouchID))&&(this._curTouchID=h.identifier,this._id%200===0&&(this._touchIDs={}),this._touchIDs[h.identifier]=this._id++,i.initEvent(h,r),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseDown))}break;case"touchend":case"touchcancel":t._isTouchRespond=!0,i._isLeftMouse=!0;var l=r.changedTouches;for(s=0,o=l.length;o>s;s++)if(h=l[s],t.multiTouchEnabled||h.identifier==this._curTouchID){this._curTouchID=NaN,i.initEvent(h,r);var u=!1;u=i.check(i._stage,i.mouseX,i.mouseY,i.onMouseUp),u||i.onMouseUp(null)}break;case"touchmove":var c=r.changedTouches;for(s=0,o=c.length;o>s;s++)h=c[s],(t.multiTouchEnabled||h.identifier==this._curTouchID)&&(i.initEvent(h,r),i.check(i._stage,i.mouseX,i.mouseY,i.onMouseMove));break;case"wheel":case"mousewheel":case"DOMMouseScroll":i.checkMouseWheel(r);break;case"mouseout":i._stage.event("mouseout",i._event.setTo("mouseout",i._stage,i._stage));break;case"mouseover":i._stage.event("mouseover",i._event.setTo("mouseover",i._stage,i._stage))}n++}this._eventList.length=0}},t.enabled=!0,t.multiTouchEnabled=!0,t._isTouchRespond=!1,__static(t,["instance",function(){return this.instance=new t}]),t}(),TouchManager=function(){function t(){this.preOvers=[],this.preDowns=[],this.preRightDowns=[],this.enable=!0,this._lastClickTime=0,this._event=new Event}__class(t,"laya.events.TouchManager");var e=t.prototype;return e.getTouchFromArr=function(t,e){var i=0,n=0;n=e.length;var r;for(i=0;n>i;i++)if(r=e[i],r.id==t)return r;return null},e.removeTouchFromArr=function(t,e){var i=0;for(i=e.length-1;i>=0;i--)e[i].id==t&&e.splice(i,1)},e.createTouchO=function(t,e){var i;return i=Pool.getItem("TouchData")||{},i.id=e,i.tar=t,i},e.onMouseDown=function(e,i,n){if(void 0===n&&(n=!1),this.enable){var r,a,s;r=this.getTouchFromArr(i,this.preOvers),s=this.getEles(e,null,t._tEleArr),r?r.tar=e:(a=this.createTouchO(e,i),this.preOvers.push(a)),Browser.onMobile&&this.sendEvents(s,"mouseover",i);var o;o=n?this.preDowns:this.preRightDowns,r=this.getTouchFromArr(i,o),r?r.tar=e:(a=this.createTouchO(e,i),o.push(a)),this.sendEvents(s,n?"mousedown":"rightmousedown",i)}},e.sendEvents=function(t,e,i){void 0===i&&(i=0);var n=0,r=0;r=t.length,this._event._stoped=!1;var a;a=t[0];var s;for(n=0;r>n;n++){if(s=t[n],s.destroyed)return;if(s.event(e,this._event.setTo(e,s,a)),this._event._stoped)break}},e.getEles=function(t,e,i){for(i?i.length=0:i=[];t&&t!=e;)i.push(t),t=t.parent;return i},e.checkMouseOutAndOverOfMove=function(e,i,n){if(void 0===n&&(n=0),i!=e){var r,a,s=0,o=0;if(i.contains(e))a=this.getEles(e,i,t._tEleArr),this.sendEvents(a,"mouseover",n);else if(e.contains(i))a=this.getEles(i,e,t._tEleArr),this.sendEvents(a,"mouseout",n);else{a=t._tEleArr,a.length=0;var h;h=this.getEles(i,null,t._oldArr);var l;l=this.getEles(e,null,t._newArr),o=h.length;var u=0;for(s=0;o>s;s++){if(r=h[s],u=l.indexOf(r),u>=0){l.splice(u,l.length-u);break}a.push(r)}a.length>0&&this.sendEvents(a,"mouseout",n),l.length>0&&this.sendEvents(l,"mouseover",n)}}},e.onMouseMove=function(e,i){if(this.enable){var n;n=this.getTouchFromArr(i,this.preOvers);var r;n?(this.checkMouseOutAndOverOfMove(e,n.tar),n.tar=e,r=this.getEles(e,null,t._tEleArr)):(r=this.getEles(e,null,t._tEleArr),this.sendEvents(r,"mouseover",i),this.preOvers.push(this.createTouchO(e,i))),this.sendEvents(r,"mousemove",i)}},e.getLastOvers=function(){return t._tEleArr.length=0,this.preOvers.length>0&&this.preOvers[0].tar?this.getEles(this.preOvers[0].tar,null,t._tEleArr):(t._tEleArr.push(Laya.stage),t._tEleArr)},e.onMouseUp=function(e,i,n){if(void 0===n&&(n=!1),this.enable){var r,a,s,o,h,l=0,u=0,c=Browser.onMobile;a=this.getEles(e,null,t._tEleArr),this.sendEvents(a,n?"mouseup":"rightmouseup",i);var _;if(_=n?this.preDowns:this.preRightDowns,r=this.getTouchFromArr(i,_)){var d=!1,f=Browser.now();if(d=f-this._lastClickTime<300,this._lastClickTime=f,e==r.tar)h=a;else for(s=this.getEles(r.tar,null,t._oldArr),h=t._newArr,h.length=0,u=s.length,l=0;u>l;l++)o=s[l],a.indexOf(o)>=0&&h.push(o);h.length>0&&this.sendEvents(h,n?"click":"rightclick",i),n&&d&&this.sendEvents(h,"doubleclick",i),this.removeTouchFromArr(i,_),r.tar=null,Pool.recover("TouchData",r)}else;r=this.getTouchFromArr(i,this.preOvers),r&&c&&(h=this.getEles(r.tar,null,h),h&&h.length>0&&this.sendEvents(h,"mouseout",i),this.removeTouchFromArr(i,this.preOvers),r.tar=null,Pool.recover("TouchData",r))}},t._oldArr=[],t._newArr=[],t._tEleArr=[],__static(t,["I",function(){return this.I=new t}]),t}(),Filter=function(){function t(){this._action=null}__class(t,"laya.filters.Filter");var e=t.prototype;return Laya.imps(e,{"laya.filters.IFilter":!0}),e.callNative=function(t){},__getset(0,e,"type",function(){return-1}),__getset(0,e,"action",function(){return this._action}),t.BLUR=16,t.COLOR=32,t.GLOW=8,t._filterStart=null,t._filterEnd=null,t._EndTarget=null,t._recycleScope=null,t._filter=null,t._useSrc=null,t._endSrc=null,t._useOut=null,t._endOut=null,t}(),ColorFilterAction=function(){function t(){this.data=null}__class(t,"laya.filters.ColorFilterAction");var e=t.prototype;return Laya.imps(e,{"laya.filters.IFilterAction":!0}),e.apply=function(t){var e=t.ctx.ctx,i=t.ctx.ctx.canvas;if(0==i.width||0==i.height)return i;for(var n,r=e.getImageData(0,0,i.width,i.height),a=r.data,s=0,o=a.length;o>s;s+=4)n=this.getColor(a[s],a[s+1],a[s+2],a[s+3]),0!=a[s+3]&&(a[s]=n[0],a[s+1]=n[1],a[s+2]=n[2],a[s+3]=n[3]);return e.putImageData(r,0,0),t},e.getColor=function(t,e,i,n){var r=[];if(this.data._mat&&this.data._alpha){var a=this.data._mat,s=this.data._alpha;r[0]=a[0]*t+a[1]*e+a[2]*i+a[3]*n+s[0],r[1]=a[4]*t+a[5]*e+a[6]*i+a[7]*n+s[1],r[2]=a[8]*t+a[9]*e+a[10]*i+a[11]*n+s[2],r[3]=a[12]*t+a[13]*e+a[14]*i+a[15]*n+s[3]}return r},t}(),Arith=function(){function t(){}return __class(t,"laya.maths.Arith"),t.formatR=function(t){return t>Math.PI&&(t-=2*Math.PI),t<-Math.PI&&(t+=2*Math.PI),t},t.isPOT=function(t,e){return t>0&&0===(t&t-1)&&e>0&&0===(e&e-1)},t.setMatToArray=function(t,e){t.a,t.b,t.c,t.d,t.tx+20,t.ty+20,1,e[0]=t.a,e[1]=t.b,e[4]=t.c,e[5]=t.d,e[12]=t.tx,e[13]=t.ty},t}(),Bezier=function(){function t(){this._controlPoints=[new Point,new Point,new Point],this._calFun=this.getPoint2}__class(t,"laya.maths.Bezier");var e=t.prototype;return e._switchPoint=function(t,e){var i=this._controlPoints.shift();i.setTo(t,e),this._controlPoints.push(i)},e.getPoint2=function(t,e){var i=this._controlPoints[0],n=this._controlPoints[1],r=this._controlPoints[2],a=Math.pow(1-t,2)*i.x+2*t*(1-t)*n.x+Math.pow(t,2)*r.x,s=Math.pow(1-t,2)*i.y+2*t*(1-t)*n.y+Math.pow(t,2)*r.y;e.push(a,s)},e.getPoint3=function(t,e){var i=this._controlPoints[0],n=this._controlPoints[1],r=this._controlPoints[2],a=this._controlPoints[3],s=Math.pow(1-t,3)*i.x+3*n.x*t*(1-t)*(1-t)+3*r.x*t*t*(1-t)+a.x*Math.pow(t,3),o=Math.pow(1-t,3)*i.y+3*n.y*t*(1-t)*(1-t)+3*r.y*t*t*(1-t)+a.y*Math.pow(t,3);e.push(s,o)},e.insertPoints=function(t,e){var i=NaN;t=t>0?t:5;var n=NaN;for(n=1/t,i=0;1>=i;i+=n)this._calFun(i,e)},e.getBezierPoints=function(t,e,i){void 0===e&&(e=5),void 0===i&&(i=2);var n=0,r=0;if(r=t.length,2*(i+1)>r)return[];var a;switch(a=[],i){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=i;)this._controlPoints.push(new Point);for(n=0;2*i>n;n+=2)this._switchPoint(t[n],t[n+1]);for(n=2*i;r>n;n+=2)this._switchPoint(t[n],t[n+1]),n/2%i==0&&this.insertPoints(e,a);return a},__static(t,["I",function(){return this.I=new t}]),t}(),GrahamScan=function(){function t(){}return __class(t,"laya.maths.GrahamScan"),t.multiply=function(t,e,i){return(t.x-i.x)*(e.y-i.y)-(e.x-i.x)*(t.y-i.y)},t.dis=function(t,e){return(t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y)},t._getPoints=function(e,i,n){for(void 0===i&&(i=!1),t._mPointList||(t._mPointList=[]);t._mPointList.length<e;)t._mPointList.push(new Point);return n||(n=[]),n.length=0,i?t.getFrom(n,t._mPointList,e):t.getFromR(n,t._mPointList,e),n},t.getFrom=function(t,e,i){var n=0;for(n=0;i>n;n++)t.push(e[n]);return t},t.getFromR=function(t,e,i){var n=0;for(n=0;i>n;n++)t.push(e.pop());return t},t.pListToPointList=function(e,i){void 0===i&&(i=!1);var n=0,r=e.length/2,a=t._getPoints(r,i,t._tempPointList);for(n=0;r>n;n++)a[n].setTo(e[n+n],e[n+n+1]);return a},t.pointListToPlist=function(e){var i,n=0,r=e.length,a=t._temPList;for(a.length=0,n=0;r>n;n++)i=e[n],a.push(i.x,i.y);return a},t.scanPList=function(e){return Utils.copyArray(e,t.pointListToPlist(t.scan(t.pListToPointList(e,!0))))},t.scan=function(e){var i,n,r,a=0,s=0,o=0,h=e.length,l={};for(n=t._temArr,n.length=0,h=e.length,a=h-1;a>=0;a--)i=e[a],r=i.x+"_"+i.y,l.hasOwnProperty(r)||(l[r]=!0,n.push(i));for(h=n.length,Utils.copyArray(e,n),a=1;h>a;a++)(e[a].y<e[o].y||e[a].y==e[o].y&&e[a].x<e[o].x)&&(o=a);for(i=e[0],e[0]=e[o],e[o]=i,a=1;h-1>a;a++){for(o=a,s=a+1;h>s;s++)(t.multiply(e[s],e[o],e[0])>0||0==t.multiply(e[s],e[o],e[0])&&t.dis(e[0],e[s])<t.dis(e[0],e[o]))&&(o=s);i=e[a],e[a]=e[o],e[o]=i}if(n=t._temArr,n.length=0,e.length<3)return Utils.copyArray(n,e);for(n.push(e[0],e[1],e[2]),a=3;h>a;a++){for(;n.length>=2&&t.multiply(e[a],n[n.length-1],n[n.length-2])>=0;)n.pop();e[a]&&n.push(e[a])}return n},t._mPointList=null,t._tempPointList=[],t._temPList=[],t._temArr=[],t}(),MathUtil=function(){function t(){}return __class(t,"laya.maths.MathUtil"),t.subtractVector3=function(t,e,i){i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2]},t.lerp=function(t,e,i){return t*(1-i)+e*i},t.scaleVector3=function(t,e,i){i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e},t.lerpVector3=function(t,e,i,n){var r=t[0],a=t[1],s=t[2];n[0]=r+i*(e[0]-r),n[1]=a+i*(e[1]-a),n[2]=s+i*(e[2]-s)},t.lerpVector4=function(t,e,i,n){var r=t[0],a=t[1],s=t[2],o=t[3];n[0]=r+i*(e[0]-r),n[1]=a+i*(e[1]-a),n[2]=s+i*(e[2]-s),n[3]=o+i*(e[3]-o)},t.slerpQuaternionArray=function(t,e,i,n,r,a,s){var o,h,l,u,c,_=t[e+0],d=t[e+1],f=t[e+2],p=t[e+3],m=i[n+0],g=i[n+1],y=i[n+2],x=i[n+3];return h=_*m+d*g+f*y+p*x,0>h&&(h=-h,m=-m,g=-g,y=-y,x=-x),1-h>1e-6?(o=Math.acos(h),l=Math.sin(o),u=Math.sin((1-r)*o)/l,c=Math.sin(r*o)/l):(u=1-r,c=r),a[s+0]=u*_+c*m,a[s+1]=u*d+c*g,a[s+2]=u*f+c*y,a[s+3]=u*p+c*x,a},t.getRotation=function(t,e,i,n){return Math.atan2(n-e,i-t)/Math.PI*180},t.sortBigFirst=function(t,e){return t==e?0:e>t?1:-1},t.sortSmallFirst=function(t,e){return t==e?0:e>t?-1:1},t.sortNumBigFirst=function(t,e){return parseFloat(e)-parseFloat(t)},t.sortNumSmallFirst=function(t,e){return parseFloat(t)-parseFloat(e)},t.sortByKey=function(e,i,n){void 0===i&&(i=!1),void 0===n&&(n=!0);var r;return r=i?n?t.sortNumBigFirst:t.sortBigFirst:n?t.sortNumSmallFirst:t.sortSmallFirst,function(t,i){return r(t[e],i[e])}},t}(),Matrix=function(){function t(t,e,i,n,r,a){this.inPool=!1,this.bTransform=!1,void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===r&&(r=0),void 0===a&&(a=0),this.a=t,this.b=e,this.c=i,this.d=n,this.tx=r,this.ty=a,this._checkTransform()}__class(t,"laya.maths.Matrix");var e=t.prototype;return e.identity=function(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this.bTransform=!1,this},e._checkTransform=function(){return this.bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d},e.setTranslate=function(t,e){return this.tx=t,this.ty=e,this},e.translate=function(t,e){return this.tx+=t,this.ty+=e,this},e.scale=function(t,e){this.a*=t,this.d*=e,this.c*=t,this.b*=e,this.tx*=t,this.ty*=e,this.bTransform=!0},e.rotate=function(t){var e=Math.cos(t),i=Math.sin(t),n=this.a,r=this.c,a=this.tx;this.a=n*e-this.b*i,this.b=n*i+this.b*e,this.c=r*e-this.d*i,this.d=r*i+this.d*e,this.tx=a*e-this.ty*i,this.ty=a*i+this.ty*e,this.bTransform=!0},e.skew=function(t,e){var i=Math.tan(t),n=Math.tan(e),r=this.a,a=this.b;return this.a+=n*this.c,this.b+=n*this.d,this.c+=i*r,this.d+=i*a,this},e.invertTransformPoint=function(t){var e=this.a,i=this.b,n=this.c,r=this.d,a=this.tx,s=e*r-i*n,o=r/s,h=-i/s,l=-n/s,u=e/s,c=(n*this.ty-r*a)/s,_=-(e*this.ty-i*a)/s;return t.setTo(o*t.x+l*t.y+c,h*t.x+u*t.y+_)},e.transformPoint=function(t){return t.setTo(this.a*t.x+this.c*t.y+this.tx,this.b*t.x+this.d*t.y+this.ty)},e.transformPointN=function(t){return t.setTo(this.a*t.x+this.c*t.y,this.b*t.x+this.d*t.y)},e.transformPointArray=function(t,e){for(var i=t.length,n=0;i>n;n+=2){var r=t[n],a=t[n+1];e[n]=this.a*r+this.c*a+this.tx,e[n+1]=this.b*r+this.d*a+this.ty}return e},e.transformPointArrayScale=function(t,e){for(var i=t.length,n=0;i>n;n+=2){var r=t[n],a=t[n+1];e[n]=this.a*r+this.c*a,e[n+1]=this.b*r+this.d*a}return e},e.getScaleX=function(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)},e.getScaleY=function(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)},e.invert=function(){var t=this.a,e=this.b,i=this.c,n=this.d,r=this.tx,a=t*n-e*i;return this.a=n/a,this.b=-e/a,this.c=-i/a,this.d=t/a,this.tx=(i*this.ty-n*r)/a,this.ty=-(t*this.ty-e*r)/a,this},e.setTo=function(t,e,i,n,r,a){return this.a=t,this.b=e,this.c=i,this.d=n,this.tx=r,this.ty=a,this},e.concat=function(t){var e=this.a,i=this.c,n=this.tx;return this.a=e*t.a+this.b*t.c,this.b=e*t.b+this.b*t.d,this.c=i*t.a+this.d*t.c,this.d=i*t.b+this.d*t.d,this.tx=n*t.a+this.ty*t.c+t.tx,this.ty=n*t.b+this.ty*t.d+t.ty,this},e.scaleEx=function(t,e){var i=this.a,n=this.b,r=this.c,a=this.d;0!==n||0!==r?(this.a=t*i,this.b=t*n,this.c=e*r,this.d=e*a):(this.a=t*i,this.b=0*a,this.c=0*i,this.d=e*a),this.bTransform=!0},e.rotateEx=function(t){var e=Math.cos(t),i=Math.sin(t),n=this.a,r=this.b,a=this.c,s=this.d;0!==r||0!==a?(this.a=e*n+i*a,this.b=e*r+i*s,this.c=-i*n+e*a,this.d=-i*r+e*s):(this.a=e*n,this.b=i*s,this.c=-i*n,this.d=e*s),this.bTransform=!0},e.clone=function(){var e=t.create();return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e.bTransform=this.bTransform,e},e.copyTo=function(t){return t.a=this.a,t.b=this.b,t.c=this.c,t.d=this.d,t.tx=this.tx,t.ty=this.ty,t.bTransform=this.bTransform,t},e.toString=function(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty},e.destroy=function(){if(!this.inPool){var e=t._cache;this.inPool=!0,e._length||(e._length=0),e[e._length++]=this,this.a=this.d=1,this.b=this.c=this.tx=this.ty=0,this.bTransform=!1}},t.mul=function(t,e,i){var n=t.a,r=t.b,a=t.c,s=t.d,o=t.tx,h=t.ty,l=e.a,u=e.b,c=e.c,_=e.d,d=e.tx,f=e.ty;return 0!==u||0!==c?(i.a=n*l+r*c,i.b=n*u+r*_,i.c=a*l+s*c,i.d=a*u+s*_,i.tx=l*o+c*h+d,i.ty=u*o+_*h+f):(i.a=n*l,i.b=r*_,i.c=a*l,i.d=s*_,i.tx=l*o+d,i.ty=_*h+f),i},t.mul16=function(t,e,i){var n=t.a,r=t.b,a=t.c,s=t.d,o=t.tx,h=t.ty,l=e.a,u=e.b,c=e.c,_=e.d,d=e.tx,f=e.ty;return 0!==u||0!==c?(i[0]=n*l+r*c,i[1]=n*u+r*_,i[4]=a*l+s*c,i[5]=a*u+s*_,i[12]=l*o+c*h+d,i[13]=u*o+_*h+f):(i[0]=n*l,i[1]=r*_,i[4]=a*l,i[5]=s*_,i[12]=l*o+d,i[13]=_*h+f),i},t.mulPre=function(t,e,i,n,r,a,s,o){var h=t.a,l=t.b,u=t.c,c=t.d,_=t.tx,d=t.ty;return 0!==i||0!==n?(o.a=h*e+l*n,o.b=h*i+l*r,o.c=u*e+c*n,o.d=u*i+c*r,o.tx=e*_+n*d+a,o.ty=i*_+r*d+s):(o.a=h*e,o.b=l*r,o.c=u*e,o.d=c*r,o.tx=e*_+a,o.ty=r*d+s),o},t.mulPos=function(t,e,i,n,r,a,s,o){var h=t.a,l=t.b,u=t.c,c=t.d,_=t.tx,d=t.ty;return 0!==l||0!==u?(o.a=e*h+i*u,o.b=e*l+i*c,o.c=n*h+r*u,o.d=n*l+r*c,o.tx=h*a+u*s+_,o.ty=l*a+c*s+d):(o.a=e*h,o.b=i*c,o.c=n*h,o.d=r*c,o.tx=h*a+_,o.ty=c*s+d),o},t.preMul=function(t,e,i){var n=t.a,r=t.b,a=t.c,s=t.d,o=e.a,h=e.b,l=e.c,u=e.d,c=e.tx,_=e.ty;return i.a=o*n,i.b=i.c=0,i.d=u*s,i.tx=c*n+t.tx,i.ty=_*s+t.ty,(0!==h||0!==l||0!==r||0!==a)&&(i.a+=h*a,i.d+=l*r,i.b+=o*r+h*s,i.c+=l*n+u*a,i.tx+=_*a,i.ty+=c*r),i},t.preMulXY=function(t,e,i,n){var r=t.a,a=t.b,s=t.c,o=t.d;return n.a=r,n.b=a,n.c=s,n.d=o,n.tx=e*r+t.tx+i*s,n.ty=i*o+t.ty+e*a,n},t.create=function(){var e=t._cache,i=e._length?e[--e._length]:new t;return i.inPool=!1,i},t.EMPTY=new t,t.TEMP=new t,t._cache=[],t}(),Point=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}__class(t,"laya.maths.Point");var e=t.prototype;return e.setTo=function(t,e){return this.x=t,this.y=e,this},e.distance=function(t,e){return Math.sqrt((this.x-t)*(this.x-t)+(this.y-e)*(this.y-e))},e.toString=function(){return this.x+","+this.y},e.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y);if(t>0){var e=1/t;this.x*=e,this.y*=e}},t.TEMP=new t,t.EMPTY=new t,t}(),Rectangle=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.width=i,this.height=n}__class(t,"laya.maths.Rectangle");var e=t.prototype;return e.setTo=function(t,e,i,n){return this.x=t,this.y=e,this.width=i,this.height=n,this},e.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},e.contains=function(t,e){return this.width<=0||this.height<=0?!1:t>=this.x&&t<this.right&&e>=this.y&&e<this.bottom?!0:!1},e.intersects=function(t){return!(t.x>this.x+this.width||t.x+t.width<this.x||t.y>this.y+this.height||t.y+t.height<this.y)},e.intersection=function(e,i){return this.intersects(e)?(i||(i=new t),i.x=Math.max(this.x,e.x),i.y=Math.max(this.y,e.y),i.width=Math.min(this.right,e.right)-i.x,i.height=Math.min(this.bottom,e.bottom)-i.y,i):null},e.union=function(e,i){return i||(i=new t),this.clone(i),e.width<=0||e.height<=0?i:(i.addPoint(e.x,e.y),i.addPoint(e.right,e.bottom),this)},e.clone=function(e){return e||(e=new t),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e},e.toString=function(){return this.x+","+this.y+","+this.width+","+this.height},e.equals=function(t){return t&&t.x===this.x&&t.y===this.y&&t.width===this.width&&t.height===this.height?!0:!1},e.addPoint=function(t,e){return this.x>t&&(this.width+=this.x-t,this.x=t),this.y>e&&(this.height+=this.y-e,this.y=e),this.width<t-this.x&&(this.width=t-this.x),this.height<e-this.y&&(this.height=e-this.y),this},e._getBoundPoints=function(){var e=t._temB;return e.length=0,0==this.width||0==this.height?e:(e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e)},e.isEmpty=function(){return this.width<=0||this.height<=0?!0:!1},__getset(0,e,"right",function(){return this.x+this.width}),__getset(0,e,"bottom",function(){return this.y+this.height}),t._getBoundPointS=function(e,i,n,r){var a=t._temA;return a.length=0,0==n||0==r?a:(a.push(e,i,e+n,i,e,i+r,e+n,i+r),a)},t._getWrapRec=function(e,i){if(!e||e.length<1)return i?i.setTo(0,0,0,0):t.TEMP.setTo(0,0,0,0);i=i?i:new t;var n,r,a,s,o,h=e.length,l=Point.TEMP;for(r=s=99999,a=o=-r,n=0;h>n;n+=2)l.x=e[n],l.y=e[n+1],r=r<l.x?r:l.x,s=s<l.y?s:l.y,a=a>l.x?a:l.x,o=o>l.y?o:l.y;return i.setTo(r,s,a-r,o-s)},t.EMPTY=new t,t.TEMP=new t,t._temB=[],t._temA=[],t}(),SoundManager=function(){function t(){}return __class(t,"laya.media.SoundManager"),__getset(1,t,"autoStopMusic",function(){return t._autoStopMusic},function(e){Laya.stage.off("blur",null,t._stageOnBlur),Laya.stage.off("focus",null,t._stageOnFocus),Laya.stage.off("visibilitychange",null,t._visibilityChange),t._autoStopMusic=e,e&&(Laya.stage.on("blur",null,t._stageOnBlur),Laya.stage.on("focus",null,t._stageOnFocus),Laya.stage.on("visibilitychange",null,t._visibilityChange))}),__getset(1,t,"muted",function(){return t._muted},function(e){e&&t.stopAllSound(),t.musicMuted=e,t._muted=e}),__getset(1,t,"musicMuted",function(){return t._musicMuted},function(e){e?(t._tMusic&&t.stopSound(t._tMusic),t._musicMuted=e):(t._musicMuted=e,t._tMusic&&t.playMusic(t._tMusic))}),__getset(1,t,"soundMuted",function(){return t._soundMuted},function(e){t._soundMuted=e}),t.addChannel=function(e){t._channels.indexOf(e)>=0||t._channels.push(e)},t.removeChannel=function(e){var i=0;for(i=t._channels.length-1;i>=0;i--)t._channels[i]==e&&t._channels.splice(i,1)},t.disposeSoundIfNotUsed=function(e){var i=0;for(i=t._channels.length-1;i>=0;i--)if(t._channels[i].url==e)return;t.destroySound(e)},t._visibilityChange=function(){Laya.stage.isVisibility?t._stageOnFocus():t._stageOnBlur()},t._stageOnBlur=function(){t._isActive=!1,t._musicChannel&&(t._musicChannel.isStopped||(t._blurPaused=!0,t._musicLoops=t._musicChannel.loops,t._musicCompleteHandler=t._musicChannel.completeHandler,t._musicPosition=t._musicChannel.position,t._musicChannel.stop(),Laya.stage.once("mousedown",null,t._stageOnFocus))),t.stopAllSound()},t._stageOnFocus=function(){t._isActive=!0,Laya.stage.off("mousedown",null,t._stageOnFocus),t._blurPaused&&(t._tMusic&&t.playMusic(t._tMusic,t._musicLoops,t._musicCompleteHandler,t._musicPosition),t._blurPaused=!1)},t.playSound=function(e,i,n,r,a){if(void 0===i&&(i=1),void 0===a&&(a=0),!t._isActive||!e)return null;if(t._muted)return null;
if(e=URL.formatURL(e),e==t._tMusic){if(t._musicMuted)return null}else{if(Render.isConchApp){var s=Utils.getFileExtension(e);if("wav"!=s&&"ogg"!=s)return alert("The sound only supports wav or ogg format,for optimal performance reason,please refer to the official website document."),null}if(t._soundMuted)return null}var o=Laya.loader.getRes(e);r||(r=t._soundClass),o||(o=new r,o.load(e),Loader.cacheRes(e,o));var h;return(h=o.play(a,i))?(h.url=e,h.volume=e==t._tMusic?t.musicVolume:t.soundVolume,h.completeHandler=n,h):null},t.destroySound=function(t){var e=Laya.loader.getRes(t);e&&(Loader.clearRes(t),e.dispose())},t.playMusic=function(e,i,n,r){return void 0===i&&(i=0),void 0===r&&(r=0),e=URL.formatURL(e),t._tMusic=e,t._musicChannel&&t._musicChannel.stop(),t._musicChannel=t.playSound(e,i,n,AudioSound,r)},t.stopSound=function(e){e=URL.formatURL(e);var i,n=0;for(n=t._channels.length-1;n>=0;n--)i=t._channels[n],i.url==e&&i.stop()},t.stopAll=function(){t._tMusic=null;var e,i=0;for(i=t._channels.length-1;i>=0;i--)e=t._channels[i],e.stop()},t.stopAllSound=function(){var e,i=0;for(i=t._channels.length-1;i>=0;i--)e=t._channels[i],e.url!=t._tMusic&&e.stop()},t.stopMusic=function(){t._musicChannel&&t._musicChannel.stop(),t._tMusic=null},t.setSoundVolume=function(e,i){if(i)i=URL.formatURL(i),t._setVolume(i,e);else{t.soundVolume=e;var n,r=0;for(r=t._channels.length-1;r>=0;r--)n=t._channels[r],n.url!=t._tMusic&&(n.volume=e)}},t.setMusicVolume=function(e){t.musicVolume=e,t._setVolume(t._tMusic,e)},t._setVolume=function(e,i){e=URL.formatURL(e);var n,r=0;for(r=t._channels.length-1;r>=0;r--)n=t._channels[r],n.url==e&&(n.volume=i)},t.musicVolume=1,t.soundVolume=1,t.playbackRate=1,t._muted=!1,t._soundMuted=!1,t._musicMuted=!1,t._tMusic=null,t._musicChannel=null,t._channels=[],t._autoStopMusic=!1,t._blurPaused=!1,t._isActive=!0,t._musicLoops=0,t._musicPosition=0,t._musicCompleteHandler=null,t._soundClass=null,t.autoReleaseSound=!0,t}(),LocalStorage=function(){function t(){}var e;return __class(t,"laya.net.LocalStorage"),t.__init__=function(){t._baseClass||(t._baseClass=e,e.init()),t.items=t._baseClass.items,t.support=t._baseClass.support},t.setItem=function(e,i){t._baseClass.setItem(e,i)},t.getItem=function(e){return t._baseClass.getItem(e)},t.setJSON=function(e,i){t._baseClass.setJSON(e,i)},t.getJSON=function(e){return t._baseClass.getJSON(e)},t.removeItem=function(e){t._baseClass.removeItem(e)},t.clear=function(){t._baseClass.clear()},t._baseClass=null,t.items=null,t.support=!1,t.__init$=function(){e=function(){function t(){}return __class(t,""),t.init=function(){try{t.items=window.localStorage,t.setItem("laya","1"),t.removeItem("laya"),t.support=!0}catch(e){}t.support||console.log("LocalStorage is not supprot or browser is private mode.")},t.setItem=function(e,i){try{t.support&&t.items.setItem(e,i)}catch(n){console.warn("set localStorage failed",n)}},t.getItem=function(e){return t.support?t.items.getItem(e):null},t.setJSON=function(e,i){try{t.support&&t.items.setItem(e,JSON.stringify(i))}catch(n){console.warn("set localStorage failed",n)}},t.getJSON=function(e){return JSON.parse(t.support?t.items.getItem(e):null)},t.removeItem=function(e){t.support&&t.items.removeItem(e)},t.clear=function(){t.support&&t.items.clear()},t.items=null,t.support=!1,t}()},t}(),ResourceVersion=function(){function t(){}return __class(t,"laya.net.ResourceVersion"),t.enable=function(e,i){Laya.loader.load(e,Handler.create(null,t.onManifestLoaded,[i]),null,"json"),URL.customFormat=t.addVersionPrefix},t.onManifestLoaded=function(e,i){t.manifest=i,e.run(),i||console.warn("资源版本清单文件不存在，不使用资源版本管理。忽略ERR_FILE_NOT_FOUND错误。")},t.addVersionPrefix=function(e){return t.manifest&&t.manifest[e]?t.manifest[e]+"/"+e:e},t.manifest=null,t}(),URL=function(){function t(e){this._url=null,this._path=null,this._url=t.formatURL(e),this._path=t.getPath(e)}__class(t,"laya.net.URL");var e=t.prototype;return __getset(0,e,"path",function(){return this._path}),__getset(0,e,"url",function(){return this._url}),t.formatURL=function(e,i){if(!e)return"null path";if(e.indexOf(":")>0)return e;null!=t.customFormat&&(e=t.customFormat(e,i));var n=e.charAt(0);if("."===n)return t.formatRelativePath((i||t.basePath)+e);if("~"===n)return t.rootPath+e.substring(1);if("d"===n){if(0===e.indexOf("data:image"))return e}else if("/"===n)return e;return(i||t.basePath)+e},t.formatRelativePath=function(t){for(var e=t.split("/"),i=0,n=e.length;n>i;i++)".."==e[i]&&(e.splice(i-1,2),i-=2);return e.join("/")},t.isAbsolute=function(t){return t.indexOf(":")>0||"/"==t.charAt(0)},t.getPath=function(t){var e=t.lastIndexOf("/");return e>0?t.substr(0,e+1):""},t.getFileName=function(t){var e=t.lastIndexOf("/");return e>0?t.substr(e+1):t},t.version={},t.basePath="",t.rootPath="",t.customFormat=function(e){var i=t.version[e];return!Render.isConchApp&&i&&(e+="?v="+i),e},t}(),Render=function(){function t(e,i){function n(){Laya.stage._loop(),Browser.window.requestAnimationFrame(n)}this._timeId=0;var r=t._mainCanvas.source.style;r.position="absolute",r.top=r.left="0px",r.background="#000000",t._mainCanvas.source.id="layaCanvas";var a=laya.renders.Render.isWebGL;t._mainCanvas.source.width=e,t._mainCanvas.source.height=i,a&&t.WebGL.init(t._mainCanvas,e,i),Browser.container.appendChild(t._mainCanvas.source),t._context=new RenderContext(e,i,a?null:t._mainCanvas),t._context.ctx.setIsMainContext(),Browser.window.requestAnimationFrame(n),Laya.stage.on("visibilitychange",this,this._onVisibilitychange)}__class(t,"laya.renders.Render");var e=t.prototype;return e._onVisibilitychange=function(){Laya.stage.isVisibility?0!=this._timeId&&Browser.window.clearInterval(this._timeId):this._timeId=Browser.window.setInterval(this._enterFrame,1e3)},e._enterFrame=function(t){Laya.stage._loop()},__getset(1,t,"context",function(){return t._context}),__getset(1,t,"canvas",function(){return t._mainCanvas.source}),t._context=null,t._mainCanvas=null,t.WebGL=null,t.isConchNode=!1,t.isConchApp=!1,t.isConchWebGL=!1,t.isWebGL=!1,t.is3DMode=!1,t.optimizeTextureMemory=function(t,e){return!0},t.__init$=function(){window.ConchRenderType=window.ConchRenderType||1,window.ConchRenderType|=window.conch?4:0,t.isConchNode=5==(5&window.ConchRenderType),t.isConchApp=4==(4&window.ConchRenderType),t.isConchWebGL=6==window.ConchRenderType},t}(),RenderContext=function(){function t(e,i,n){this.x=0,this.y=0,this._drawTexture=function(t,e,i){i[0].loaded&&this.ctx.drawTexture(i[0],i[1],i[2],i[3],i[4],t,e)},this._fillTexture=function(t,e,i){i[0].loaded&&this.ctx.fillTexture(i[0],i[1]+t,i[2]+e,i[3],i[4],i[5],i[6],i[7])},this._drawTextureWithTransform=function(t,e,i){i[0].loaded&&this.ctx.drawTextureWithTransform(i[0],i[1],i[2],i[3],i[4],i[5],t,e,i[6])},this._fillQuadrangle=function(t,e,i){this.ctx.fillQuadrangle(i[0],i[1],i[2],i[3],i[4])},this._drawRect=function(t,e,i){var n=this.ctx;null!=i[4]&&(n.fillStyle=i[4],n.fillRect(t+i[0],e+i[1],i[2],i[3],null)),null!=i[5]&&(n.strokeStyle=i[5],n.lineWidth=i[6],n.strokeRect(t+i[0],e+i[1],i[2],i[3],i[6]))},this._drawPie=function(t,e,i){var n=this.ctx;Render.isWebGL&&n.setPathId(i[8]),n.beginPath(),Render.isWebGL?(n.movePath(i[0]+t,i[1]+e),n.moveTo(0,0)):n.moveTo(t+i[0],e+i[1]),n.arc(t+i[0],e+i[1],i[2],i[3],i[4]),n.closePath(),this._fillAndStroke(i[5],i[6],i[7],!0)},this._clipRect=function(t,e,i){this.ctx.clipRect(t+i[0],e+i[1],i[2],i[3])},this._fillRect=function(t,e,i){this.ctx.fillRect(t+i[0],e+i[1],i[2],i[3],i[4])},this._drawCircle=function(e,i,n){var r=this.ctx;Render.isWebGL&&r.setPathId(n[6]),Stat.drawCall++,r.beginPath(),Render.isWebGL&&r.movePath(n[0]+e,n[1]+i),r.arc(n[0]+e,n[1]+i,n[2],0,t.PI2),r.closePath(),this._fillAndStroke(n[3],n[4],n[5],!0)},this._fillCircle=function(e,i,n){Stat.drawCall++;var r=this.ctx;r.beginPath(),r.fillStyle=n[3],r.arc(n[0]+e,n[1]+i,n[2],0,t.PI2),r.fill()},this._setShader=function(t,e,i){this.ctx.setShader(i[0])},this._drawLine=function(t,e,i){var n=this.ctx;Render.isWebGL&&n.setPathId(i[6]),n.beginPath(),n.strokeStyle=i[4],n.lineWidth=i[5],Render.isWebGL?(n.movePath(t,e),n.moveTo(i[0],i[1]),n.lineTo(i[2],i[3])):(n.moveTo(t+i[0],e+i[1]),n.lineTo(t+i[2],e+i[3])),n.stroke()},this._drawLines=function(t,e,i){var n=this.ctx;Render.isWebGL&&n.setPathId(i[5]),n.beginPath(),t+=i[0],e+=i[1],Render.isWebGL&&n.movePath(t,e),n.strokeStyle=i[3],n.lineWidth=i[4];var r=i[2],a=2,s=r.length;if(Render.isWebGL)for(n.moveTo(r[0],r[1]);s>a;)n.lineTo(r[a++],r[a++]);else for(n.moveTo(t+r[0],e+r[1]);s>a;)n.lineTo(t+r[a++],e+r[a++]);n.stroke()},this._drawLinesWebGL=function(t,e,i){this.ctx.drawLines(t+this.x+i[0],e+this.y+i[1],i[2],i[3],i[4])},this._drawCurves=function(t,e,i){this.ctx.drawCurves(t,e,i)},this._draw=function(t,e,i){i[0].call(null,this,t,e)},this._transformByMatrix=function(t,e,i){this.ctx.transformByMatrix(i[0])},this._setTransform=function(t,e,i){this.ctx.setTransform(i[0],i[1],i[2],i[3],i[4],i[5])},this._setTransformByMatrix=function(t,e,i){this.ctx.setTransformByMatrix(i[0])},this._save=function(t,e,i){this.ctx.save()},this._restore=function(t,e,i){this.ctx.restore()},this._translate=function(t,e,i){this.ctx.translate(i[0],i[1])},this._transform=function(t,e,i){this.ctx.translate(i[1]+t,i[2]+e);var n=i[0];this.ctx.transform(n.a,n.b,n.c,n.d,n.tx,n.ty),this.ctx.translate(-t-i[1],-e-i[2])},this._rotate=function(t,e,i){this.ctx.translate(i[1]+t,i[2]+e),this.ctx.rotate(i[0]),this.ctx.translate(-t-i[1],-e-i[2])},this._scale=function(t,e,i){this.ctx.translate(i[2]+t,i[3]+e),this.ctx.scale(i[0],i[1]),this.ctx.translate(-t-i[2],-e-i[3])},this._alpha=function(t,e,i){this.ctx.globalAlpha*=i[0]},this._setAlpha=function(t,e,i){this.ctx.globalAlpha=i[0]},this._fillText=function(t,e,i){this.ctx.fillText(i[0],i[1]+t,i[2]+e,i[3],i[4],i[5])},this._strokeText=function(t,e,i){this.ctx.strokeText(i[0],i[1]+t,i[2]+e,i[3],i[4],i[5],i[6])},this._fillBorderText=function(t,e,i){this.ctx.fillBorderText(i[0],i[1]+t,i[2]+e,i[3],i[4],i[5],i[6],i[7])},this._blendMode=function(t,e,i){this.ctx.globalCompositeOperation=i[0]},this._beginClip=function(t,e,i){this.ctx.beginClip&&this.ctx.beginClip(t+i[0],e+i[1],i[2],i[3])},this._setIBVB=function(t,e,i){this.ctx.setIBVB(i[0]+t,i[1]+e,i[2],i[3],i[4],i[5],i[6],i[7])},this._fillTrangles=function(t,e,i){this.ctx.fillTrangles(i[0],i[1]+t,i[2]+e,i[3],i[4])},this._drawPath=function(t,e,i){var n=this.ctx;Render.isWebGL&&n.setPathId(-1),n.beginPath(),t+=i[0],e+=i[1];for(var r=i[2],a=0,s=r.length;s>a;a++){var o=r[a];switch(o[0]){case"moveTo":n.moveTo(t+o[1],e+o[2]);break;case"lineTo":n.lineTo(t+o[1],e+o[2]);break;case"arcTo":n.arcTo(t+o[1],e+o[2],t+o[3],e+o[4],o[5]);break;case"closePath":n.closePath()}}var h=i[3];null!=h&&(n.fillStyle=h.fillStyle,n.fill());var l=i[4];null!=l&&(n.strokeStyle=l.strokeStyle,n.lineWidth=l.lineWidth||1,n.lineJoin=l.lineJoin,n.lineCap=l.lineCap,n.miterLimit=l.miterLimit,n.stroke())},this.drawPoly=function(t,e,i){this.ctx.drawPoly(t+this.x+i[0],e+this.y+i[1],i[2],i[3],i[4],i[5],i[6])},this._drawPoly=function(t,e,i){var n=this.ctx,r=i[2],a=2,s=r.length;if(Render.isWebGL)for(n.setPathId(i[6]),n.beginPath(),t+=i[0],e+=i[1],n.movePath(t,e),n.moveTo(r[0],r[1]);s>a;)n.lineTo(r[a++],r[a++]);else for(n.beginPath(),t+=i[0],e+=i[1],n.moveTo(t+r[0],e+r[1]);s>a;)n.lineTo(t+r[a++],e+r[a++]);n.closePath(),this._fillAndStroke(i[3],i[4],i[5],i[7])},this._drawSkin=function(t,e,i){var n=i[0];if(n){var r=this.ctx;n.render(r,t,e)}},this._drawParticle=function(t,e,i){this.ctx.drawParticle(t+this.x,e+this.y,i[0])},n?this.ctx=n.getContext("2d"):(n=HTMLCanvas.create("3D"),this.ctx=RunDriver.createWebGLContext2D(n),n._setContext(this.ctx)),n.size(e,i),this.canvas=n}__class(t,"laya.renders.RenderContext");var e=t.prototype;return e.destroy=function(){this.canvas&&(this.canvas.destroy(),this.canvas=null),this.ctx&&(this.ctx.destroy(),this.ctx=null)},e.drawTexture=function(t,e,i,n,r){t.loaded&&this.ctx.drawTexture(t,e,i,n,r,this.x,this.y)},e._drawTextures=function(t,e,i){i[0].loaded&&this.ctx.drawTextures(i[0],i[1],t+this.x,e+this.y)},e.drawTextureWithTransform=function(t,e,i,n,r,a,s){t.loaded&&this.ctx.drawTextureWithTransform(t,e,i,n,r,a,this.x,this.y,s)},e.fillQuadrangle=function(t,e,i,n,r){this.ctx.fillQuadrangle(t,e,i,n,r)},e.drawCanvas=function(t,e,i,n,r){this.ctx.drawCanvas(t,e+this.x,i+this.y,n,r)},e.drawRect=function(t,e,i,n,r,a){void 0===a&&(a=1);var s=this.ctx;s.strokeStyle=r,s.lineWidth=a,s.strokeRect(t+this.x,e+this.y,i,n,a)},e._fillAndStroke=function(t,e,i,n){void 0===n&&(n=!1);var r=this.ctx;null!=t&&(r.fillStyle=t,Render.isWebGL?r.fill(n):r.fill()),null!=e&&i>0&&(r.strokeStyle=e,r.lineWidth=i,r.stroke())},e.clipRect=function(t,e,i,n){this.ctx.clipRect(t+this.x,e+this.y,i,n)},e.fillRect=function(t,e,i,n,r){this.ctx.fillRect(t+this.x,e+this.y,i,n,r)},e.drawCircle=function(e,i,n,r,a){void 0===a&&(a=1),Stat.drawCall++;var s=this.ctx;s.beginPath(),s.strokeStyle=r,s.lineWidth=a,s.arc(e+this.x,i+this.y,n,0,t.PI2),s.stroke()},e.fillCircle=function(e,i,n,r){Stat.drawCall++;var a=this.ctx;a.beginPath(),a.fillStyle=r,a.arc(e+this.x,i+this.y,n,0,t.PI2),a.fill()},e.setShader=function(t){this.ctx.setShader(t)},e.drawLine=function(t,e,i,n,r,a){void 0===a&&(a=1);var s=this.ctx;s.beginPath(),s.strokeStyle=r,s.lineWidth=a,s.moveTo(this.x+t,this.y+e),s.lineTo(this.x+i,this.y+n),s.stroke()},e.clear=function(){this.ctx.clear()},e.transformByMatrix=function(t){this.ctx.transformByMatrix(t)},e.setTransform=function(t,e,i,n,r,a){this.ctx.setTransform(t,e,i,n,r,a)},e.setTransformByMatrix=function(t){this.ctx.setTransformByMatrix(t)},e.save=function(){this.ctx.save()},e.restore=function(){this.ctx.restore()},e.translate=function(t,e){this.ctx.translate(t,e)},e.transform=function(t,e,i,n,r,a){this.ctx.transform(t,e,i,n,r,a)},e.rotate=function(t){this.ctx.rotate(t)},e.scale=function(t,e){this.ctx.scale(t,e)},e.alpha=function(t){this.ctx.globalAlpha*=t},e.setAlpha=function(t){this.ctx.globalAlpha=t},e.fillWords=function(t,e,i,n,r){this.ctx.fillWords(t,e,i,n,r)},e.fillBorderWords=function(t,e,i,n,r,a,s){this.ctx.fillBorderWords(t,e,i,n,r,a,s)},e.fillText=function(t,e,i,n,r,a){this.ctx.fillText(t,e+this.x,i+this.y,n,r,a)},e.strokeText=function(t,e,i,n,r,a,s){this.ctx.strokeText(t,e+this.x,i+this.y,n,r,a,s)},e.blendMode=function(t){this.ctx.globalCompositeOperation=t},e.flush=function(){this.ctx.flush&&this.ctx.flush()},e.addRenderObject=function(t){this.ctx.addRenderObject(t)},e.beginClip=function(t,e,i,n){this.ctx.beginClip&&this.ctx.beginClip(t,e,i,n)},e.endClip=function(){this.ctx.endClip&&this.ctx.endClip()},e.fillTrangles=function(t,e,i){this.ctx.fillTrangles(i[0],i[1],i[2],i[3],i.length>4?i[4]:null)},t.PI2=2*Math.PI,t}(),RenderSprite=function(){function t(e,i){switch(this._next=i||t.NORENDER,e){case 0:return void(this._fun=this._no);case 1:return void(this._fun=this._image);case 2:return void(this._fun=this._alpha);case 4:return void(this._fun=this._transform);case 8:return void(this._fun=this._blend);case 16:return void(this._fun=this._canvas);case 64:return void(this._fun=this._mask);case 128:return void(this._fun=this._clip);case 256:return void(this._fun=this._style);case 512:return void(this._fun=this._graphics);case 2048:return void(this._fun=this._childs);case 1024:return void(this._fun=this._custom);case 513:return void(this._fun=this._image2);case 517:return void(this._fun=this._image2);case 32:return void(this._fun=Filter._filter);case 69905:return void(this._fun=t._initRenderFun)}this.onCreate(e)}__class(t,"laya.renders.RenderSprite");var e=t.prototype;return e.onCreate=function(t){},e._style=function(t,e,i,n){t._style.render(t,e,i,n);var r=this._next;r._fun.call(r,t,e,i,n)},e._no=function(t,e,i,n){},e._custom=function(t,e,i,n){t.customRender(e,i,n);var r=t._style._tf;this._next._fun.call(this._next,t,e,i-r.translateX,n-r.translateY)},e._clip=function(e,i,n,r){var a=this._next;if(a!=t.NORENDER){var s=e._style.scrollRect;i.ctx.save(),i.ctx.clipRect(n,r,s.width,s.height),a._fun.call(a,e,i,n-s.x,r-s.y),i.ctx.restore()}},e._blend=function(t,e,i,n){var r=t._style;r.blendMode&&(e.ctx.globalCompositeOperation=r.blendMode);var a=this._next;a._fun.call(a,t,e,i,n),e.ctx.globalCompositeOperation="source-over"},e._mask=function(t,e,i,n){var r=this._next;r._fun.call(r,t,e,i,n);var a=t.mask;a&&(e.ctx.globalCompositeOperation="destination-in",(a.numChildren>0||!a.graphics._isOnlyOne())&&(a.cacheAsBitmap=!0),a.render(e,i-t.pivotX,n-t.pivotY)),e.ctx.globalCompositeOperation="source-over"},e._graphics=function(t,e,i,n){var r=t._style._tf;t._graphics&&t._graphics._render(t,e,i-r.translateX,n-r.translateY);var a=this._next;a._fun.call(a,t,e,i,n)},e._image=function(t,e,i,n){var r=t._style;e.ctx.drawTexture2(i,n,r._tf.translateX,r._tf.translateY,t.transform,r.alpha,r.blendMode,t._graphics._one)},e._image2=function(t,e,i,n){var r=t._style._tf;e.ctx.drawTexture2(i,n,r.translateX,r.translateY,t.transform,1,null,t._graphics._one)},e._alpha=function(t,e,i,n){var r,a=t._style;if((r=a.alpha)>.01||t._needRepaint()){var s=e.ctx.globalAlpha;e.ctx.globalAlpha*=r;var o=this._next;o._fun.call(o,t,e,i,n),e.ctx.globalAlpha=s}},e._transform=function(e,i,n,r){var a=e.transform,s=this._next;a&&s!=t.NORENDER?(i.save(),i.transform(a.a,a.b,a.c,a.d,a.tx+n,a.ty+r),s._fun.call(s,e,i,0,0),i.restore()):s._fun.call(s,e,i,n,r)},e._childs=function(t,e,i,n){var r=t._style,a=r._tf;if(i=i-a.translateX+r.paddingLeft,n=n-a.translateY+r.paddingTop,r._calculation){var s=t._getWords();if(s){var o=r;o&&(o.stroke?e.fillBorderWords(s,i,n,o.font,o.color,o.strokeColor,o.stroke):e.fillWords(s,i,n,o.font,o.color))}}var h,l=t._childs,u=l.length;if(t.viewport||t.optimizeScrollRect&&t._style.scrollRect){var c=t.viewport||t._style.scrollRect,_=c.x,d=c.y,f=c.right,p=c.bottom,m=NaN,g=NaN;for(y=0;u>y;++y)(h=l[y]).visible&&(m=h._x)<f&&m+h.width>_&&(g=h._y)<p&&g+h.height>d&&h.render(e,i,n)}else for(var y=0;u>y;++y)(h=l[y])._style.visible&&h.render(e,i,n)},e._canvas=function(t,e,i,n){var r=t._$P.cacheCanvas;if(!r)return void this._next._fun.call(this._next,t,e,i,n);"bitmap"===r.type?Stat.canvasBitmap++:Stat.canvasNormal++;var a=r.ctx;if(t._needRepaint()||!a)this._canvas_repaint(t,e,i,n);else{var s=r._cacheRec;e.drawCanvas(a.canvas,i+s.x,n+s.y,s.width,s.height)}},e._canvas_repaint=function(t,e,i,n){var r=t._$P.cacheCanvas,a=this._next;if(!r)return void a._fun.call(a,t,u,i,n);var s,o,h,l,u=r.ctx,c=t._needRepaint()||!u,_=r.type;if("bitmap"===_?Stat.canvasBitmap++:Stat.canvasNormal++,c){r._cacheRec||(r._cacheRec=new Rectangle);var d,f;Render.isWebGL&&"bitmap"!==_?r._cacheRec.setTo(-t.pivotX,-t.pivotY,1,1):(l=t.getSelfBounds(),l.x=l.x-t.pivotX,l.y=l.y-t.pivotY,l.x=l.x-16,l.y=l.y-16,l.width=l.width+32,l.height=l.height+32,l.x=Math.floor(l.x+i)-i,l.y=Math.floor(l.y+n)-n,l.width=Math.floor(l.width),l.height=Math.floor(l.height),r._cacheRec.copyFrom(l)),l=r._cacheRec;var p=Render.isWebGL?1:Browser.pixelRatio*Laya.stage.clientScaleX,m=Render.isWebGL?1:Browser.pixelRatio*Laya.stage.clientScaleY;if(!Render.isWebGL){var g,y=1,x=1;for(g=t;g&&g!=Laya.stage;)y*=g.scaleX,x*=g.scaleY,g=g.parent;Render.isWebGL?(1>y&&(p*=y),1>x&&(m*=x)):(y>1&&(p*=y),x>1&&(m*=x))}if(t.scrollRect){var v=t.scrollRect;l.x-=v.x,l.y-=v.y}if(d=l.width*p,f=l.height*m,o=l.x,h=l.y,Render.isWebGL&&"bitmap"===_&&(d>2048||f>2048))return console.warn("cache bitmap size larger than 2048,cache ignored"),r.ctx&&(Pool.recover("RenderContext",r.ctx),r.ctx.canvas.size(0,0),r.ctx=null),void a._fun.call(a,t,e,i,n);u||(u=r.ctx=Pool.getItem("RenderContext")||new RenderContext(d,f,HTMLCanvas.create("AUTO"))),u.ctx.sprite=t,s=u.canvas,s.clear(),(s.width!=d||s.height!=f)&&s.size(d,f),"bitmap"===_?s.context.asBitmap=!0:"normal"===_&&(s.context.asBitmap=!1);var S;if(1!=p||1!=m){var T=u.ctx;T.save(),T.scale(p,m),!Render.isConchWebGL&&Render.isConchApp&&(S=t._$P.cf,S&&T.setFilterMatrix&&T.setFilterMatrix(S._mat,S._alpha)),a._fun.call(a,t,u,-o,-h),T.restore(),(!Render.isConchApp||Render.isConchWebGL)&&t._applyFilters()}else T=u.ctx,!Render.isConchWebGL&&Render.isConchApp&&(S=t._$P.cf,S&&T.setFilterMatrix&&T.setFilterMatrix(S._mat,S._alpha)),a._fun.call(a,t,u,-o,-h),(!Render.isConchApp||Render.isConchWebGL)&&t._applyFilters();t._$P.staticCache&&(r.reCache=!1),Stat.canvasReCache++}else l=r._cacheRec,o=l.x,h=l.y,s=u.canvas;e.drawCanvas(s,i+o,n+h,l.width,l.height)},t.__init__=function(){function e(e,i){for(var n=0,r=0;r<e.length;r++)n|=e[r],t.renders[n]=i}var i,n=0,r=0;for(i=RunDriver.createRenderSprite(69905,null),r=t.renders.length=4096,n=0;r>n;n++)t.renders[n]=i;t.renders[0]=RunDriver.createRenderSprite(0,null),e([1,512,4,2],new t(1,null)),t.renders[513]=RunDriver.createRenderSprite(513,null),t.renders[517]=new t(517,null)},t._initRenderFun=function(e,i,n,r){var a=e._renderType,s=t.renders[a]=t._getTypeRender(a);s._fun(e,i,n,r)},t._getTypeRender=function(t){for(var e=null,i=2048;i>1;)i&t&&(e=RunDriver.createRenderSprite(i,e)),i>>=1;return e},t.IMAGE=1,t.ALPHA=2,t.TRANSFORM=4,t.BLEND=8,t.CANVAS=16,t.FILTERS=32,t.MASK=64,t.CLIP=128,t.STYLE=256,t.GRAPHICS=512,t.CUSTOM=1024,t.CHILDS=2048,t.INIT=69905,t.renders=[],t.NORENDER=new t(0,null),t}(),Context=function(){function t(){this._repaint=!1}__class(t,"laya.resource.Context");var e=t.prototype;return e.replaceReset=function(){var e=0,i=0;i=t.replaceKeys.length;var n;for(e=0;i>e;e++)n=t.replaceKeys[e],this[t.newKeys[e]]=this[n]},e.replaceResotre=function(){this.__restore(),this.__reset()},e.setIsMainContext=function(){},e.drawTextures=function(t,e,i,n){Stat.drawCall+=e.length/2;for(var r=t.width,a=t.height,s=0,o=e.length;o>s;s+=2)this.drawTexture(t,e[s],e[s+1],r,a,i,n)},e.drawCanvas=function(t,e,i,n,r){Stat.drawCall++,this.drawImage(t.source,e,i,n,r)},e.fillRect=function(t,e,i,n,r){Stat.drawCall++,r&&(this.fillStyle=r),this.__fillRect(t,e,i,n)},e.fillText=function(t,e,i,n,r,a){Stat.drawCall++,arguments.length>3&&null!=n&&(this.font=n,this.fillStyle=r,this.textAlign=a,this.textBaseline="top"),this.__fillText(t,e,i)},e.fillBorderText=function(t,e,i,n,r,a,s,o){Stat.drawCall++,this.font=n,this.fillStyle=r,this.textBaseline="top",this.strokeStyle=a,this.lineWidth=s,this.textAlign=o,this.__strokeText(t,e,i),this.__fillText(t,e,i)},e.strokeText=function(t,e,i,n,r,a,s){Stat.drawCall++,arguments.length>3&&null!=n&&(this.font=n,this.strokeStyle=r,this.lineWidth=a,this.textAlign=s,this.textBaseline="top"),this.__strokeText(t,e,i)},e.transformByMatrix=function(t){this.transform(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.setTransformByMatrix=function(t){this.setTransform(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.clipRect=function(t,e,i,n){Stat.drawCall++,this.beginPath(),this.rect(t,e,i,n),this.clip()},e.drawTexture=function(t,e,i,n,r,a,s){Stat.drawCall++;var o=t.uv,h=t.bitmap.width,l=t.bitmap.height;this.drawImage(t.source,o[0]*h,o[1]*l,(o[2]-o[0])*h,(o[5]-o[3])*l,e+a,i+s,n,r)},e.drawTextureWithTransform=function(t,e,i,n,r,a,s,o,h){Stat.drawCall++;var l=t.uv,u=t.bitmap.width,c=t.bitmap.height;this.save(),1!=h&&(this.globalAlpha*=h),a?(this.transform(a.a,a.b,a.c,a.d,a.tx+s,a.ty+o),this.drawImage(t.source,l[0]*u,l[1]*c,(l[2]-l[0])*u,(l[5]-l[3])*c,e,i,n,r)):this.drawImage(t.source,l[0]*u,l[1]*c,(l[2]-l[0])*u,(l[5]-l[3])*c,e+s,i+o,n,r),this.restore()},e.drawTexture2=function(t,e,i,n,r,a,s,o){"use strict";var h=o[0];if(h.loaded&&h.bitmap&&h.source){Stat.drawCall++;var l=1!==a;if(l){var u=this.globalAlpha;this.globalAlpha*=a}var c=h.uv,_=h.bitmap.width,d=h.bitmap.height;r?(this.save(),this.transform(r.a,r.b,r.c,r.d,r.tx+t,r.ty+e),this.drawImage(h.source,c[0]*_,c[1]*d,(c[2]-c[0])*_,(c[5]-c[3])*d,o[1]-i,o[2]-n,o[3],o[4]),this.restore()):this.drawImage(h.source,c[0]*_,c[1]*d,(c[2]-c[0])*_,(c[5]-c[3])*d,o[1]-i+t,o[2]-n+e,o[3],o[4]),l&&(this.globalAlpha=u)}},e.fillTexture=function(t,e,i,n,r,a,s,o){if(!o.pat){if(t.uv!=Texture.DEF_UV){var h=new HTMLCanvas("2D");h.getContext("2d"),h.size(t.width,t.height),h.context.drawTexture(t,0,0,t.width,t.height,0,0),t=new Texture(h)}o.pat=this.createPattern(t.bitmap.source,a)}var l=e,u=i,c=0,_=0;s&&(l+=s.x%t.width,u+=s.y%t.height,c-=s.x%t.width,_-=s.y%t.height),this.translate(l,u),this.fillRect(c,_,n,r,o.pat),this.translate(-l,-u)},e.flush=function(){return 0},e.fillWords=function(t,e,i,n,r){n&&(this.font=n),r&&(this.fillStyle=r);this.textBaseline="top",this.textAlign="left";for(var a=0,s=t.length;s>a;a++){var o=t[a];this.__fillText(o["char"],o.x+e,o.y+i)}},e.fillBorderWords=function(t,e,i,n,r,a,s){n&&(this.font=n),r&&(this.fillStyle=r),this.textBaseline="top",this.lineWidth=s,this.textAlign="left",this.strokeStyle=a;for(var o=0,h=t.length;h>o;o++){var l=t[o];this.__strokeText(l["char"],l.x+e,l.y+i),this.__fillText(l["char"],l.x+e,l.y+i)}},e.destroy=function(){this.canvas.width=this.canvas.height=0},e.clear=function(){this.clearRect(0,0,this._canvas.width,this._canvas.height),this._repaint=!1},e.drawCurves=function(t,e,i){this.beginPath(),this.strokeStyle=i[3],this.lineWidth=i[4];var n=i[2];t+=i[0],e+=i[1],this.moveTo(t+n[0],e+n[1]);for(var r=2,a=n.length;a>r;)this.quadraticCurveTo(t+n[r++],e+n[r++],t+n[r++],e+n[r++]);this.stroke()},t.__init__=function(e){var i=laya.resource.Context.prototype;e=e||CanvasRenderingContext2D.prototype,e.__fillText=e.fillText,e.__fillRect=e.fillRect,e.__strokeText=e.strokeText;var n=["drawTextures","fillWords","fillBorderWords","setIsMainContext","fillRect","strokeText","fillTexture","fillText","transformByMatrix","setTransformByMatrix","clipRect","drawTexture","drawTexture2","drawTextureWithTransform","flush","clear","destroy","drawCanvas","fillBorderText","drawCurves"];n.forEach(function(t){e[t]=i[t]});var r=HTMLCanvasElement.prototype;if(t.replaceCanvasGetSet(r,"width")&&t.replaceCanvasGetSet(r,"height")){var a=0,s=0;for(s=t.replaceKeys.length,a=0;s>a;a++)if(!t.replaceGetSet(e,t.replaceKeys[a]))return;e.__reset=i.replaceReset,e.__restore=e.restore,e.restore=i.replaceResotre}},t.replaceCanvasGetSet=function(t,e){var i=Object.getOwnPropertyDescriptor(t,e);if(!i||!i.configurable)return!1;var n,r={};for(n in i)"set"!=n&&(r[n]=i[n]);var a=i.set;return r.set=function(t){var e=this;a.call(e,t);var i=e.getContext("2d");i&&"__reset"in i&&i.__reset()},Object.defineProperty(t,e,r),!0},t.replaceGetSet=function(e,i){var n=Object.getOwnPropertyDescriptor(e,i);if(!n||!n.configurable)return!1;var r,a={};for(r in n)"set"!=r&&(a[r]=n[r]);var s=n.set,o="___"+i+"__";return t.newKeys.push(o),a.set=function(t){var e=this;t!=e[o]&&(e[o]=t,s.call(e,t))},Object.defineProperty(e,i,a),!0},t._default=new t,t.newKeys=[],__static(t,["replaceKeys",function(){return this.replaceKeys=["font","fillStyle","textBaseline"]}]),t}(),ResourceManager=function(){function t(){this._id=0,this._name=null,this._resources=null,this._memorySize=0,this._garbageCollectionRate=NaN,this._isOverflow=!1,this.autoRelease=!1,this.autoReleaseMaxSize=0,this._id=++t._uniqueIDCounter,this._name="Content Manager",t._isResourceManagersSorted=!1,this._memorySize=0,this._isOverflow=!1,this.autoRelease=!1,this.autoReleaseMaxSize=536870912,this._garbageCollectionRate=.2,t._resourceManagers.push(this),this._resources=[]}__class(t,"laya.resource.ResourceManager");var e=t.prototype;return Laya.imps(e,{"laya.resource.IDispose":!0}),e.getResourceByIndex=function(t){return this._resources[t]},e.getResourcesLength=function(){return this._resources.length},e.addResource=function(t){t.resourceManager&&t.resourceManager.removeResource(t);var e=this._resources.indexOf(t);return-1===e?(t._resourceManager=this,this._resources.push(t),this.addSize(t.memorySize),!0):!1},e.removeResource=function(t){var e=this._resources.indexOf(t);return-1!==e?(this._resources.splice(e,1),t._resourceManager=null,this._memorySize-=t.memorySize,!0):!1},e.unload=function(){for(var t=this._resources.slice(0,this._resources.length),e=0;e<t.length;e++){var i=t[e];i.dispose()}t.length=0},e.setUniqueName=function(e){for(var i=!0,n=0;n<t._resourceManagers.length;n++)if(t._resourceManagers[n]._name===e&&t._resourceManagers[n]!==this)return void(i=!1);i?this.name!=e&&(this.name=e,t._isResourceManagersSorted=!1):this.setUniqueName(e.concat("-copy"))},e.dispose=function(){if(this===t._systemResourceManager)throw new Error("systemResourceManager不能被释放！");t._resourceManagers.splice(t._resourceManagers.indexOf(this),1),t._isResourceManagersSorted=!1;for(var e=this._resources.slice(0,this._resources.length),i=0;i<e.length;i++){var n=e[i];n.resourceManager.removeResource(n),n.dispose()}e.length=0},e.addSize=function(t){t&&(this.autoRelease&&t>0&&this._memorySize+t>this.autoReleaseMaxSize&&this.garbageCollection((1-this._garbageCollectionRate)*this.autoReleaseMaxSize),this._memorySize+=t)},e.garbageCollection=function(t){var e=this._resources;e=e.slice(),e.sort(function(t,e){if(!t||!e)throw new Error("a或b不能为空！");return t.released&&e.released?0:t.released?1:e.released?-1:t._lastUseFrameCount-e._lastUseFrameCount});for(var i=Stat.loopCount,n=0,r=e.length;r>n;n++){var a=e[n];if(!(i-a._lastUseFrameCount>1))return void(this._memorySize>=t&&(this._isOverflow=!0));if(a.releaseResource(),this._memorySize<t)return void(this._isOverflow=!1)}},__getset(0,e,"id",function(){return this._id}),__getset(0,e,"name",function(){return this._name},function(e){!e&&""===e||this._name===e||(this._name=e,t._isResourceManagersSorted=!1)}),__getset(0,e,"memorySize",function(){return this._memorySize}),__getset(1,t,"systemResourceManager",function(){return null===t._systemResourceManager&&(t._systemResourceManager=new t,t._systemResourceManager._name="System Resource Manager"),t._systemResourceManager}),__getset(1,t,"sortedResourceManagersByName",function(){return t._isResourceManagersSorted||(t._isResourceManagersSorted=!0,t._resourceManagers.sort(t.compareResourceManagersByName)),t._resourceManagers}),t.__init__=function(){t.currentResourceManager=t.systemResourceManager},t.getLoadedResourceManagerByIndex=function(e){return t._resourceManagers[e]},t.getLoadedResourceManagersCount=function(){return t._resourceManagers.length},t.recreateContentManagers=function(e){void 0===e&&(e=!1);for(var i=t.currentResourceManager,n=0;n<t._resourceManagers.length;n++){t.currentResourceManager=t._resourceManagers[n];for(var r=0;r<t.currentResourceManager._resources.length;r++)t.currentResourceManager._resources[r].releaseResource(e),t.currentResourceManager._resources[r].activeResource(e)}t.currentResourceManager=i},t.releaseContentManagers=function(e){void 0===e&&(e=!1);for(var i=t.currentResourceManager,n=0;n<t._resourceManagers.length;n++){t.currentResourceManager=t._resourceManagers[n];for(var r=0;r<t.currentResourceManager._resources.length;r++){var a=t.currentResourceManager._resources[r];!a.released&&a.releaseResource(e)}}t.currentResourceManager=i},t.compareResourceManagersByName=function(t,e){if(t==e)return 0;var i=t._name,n=e._name;if(null==i)return null==n?0:-1;if(null==n)return 1;var r=i.localeCompare(n);return 0!=r?r:(e.setUniqueName(n),n=e._name,i.localeCompare(n))},t._uniqueIDCounter=0,t._systemResourceManager=null,t._isResourceManagersSorted=!1,t._resourceManagers=[],t.currentResourceManager=null,t}(),System=function(){function System(){}return __class(System,"laya.system.System"),System.changeDefinition=function(name,classObj){Laya[name]=classObj;var str=name+"=classObj";eval(str)},System.__init__=function(){Render.isConchApp&&(conch.disableConchResManager(),conch.disableConchAutoRestoreLostedDevice())},System}(),Browser=function(){function t(){}return __class(t,"laya.utils.Browser"),__getset(1,t,"pixelRatio",function(){return t.__init__(),t.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?2:RunDriver.getPixelRatio()}),__getset(1,t,"height",function(){return t.__init__(),(Laya.stage&&Laya.stage.canvasRotation?t.clientWidth:t.clientHeight)*t.pixelRatio}),__getset(1,t,"clientWidth",function(){return t.__init__(),t.window.innerWidth||t.document.body.clientWidth}),__getset(1,t,"window",function(){return t.__init__(),t._window}),__getset(1,t,"clientHeight",function(){return t.__init__(),t.window.innerHeight||t.document.body.clientHeight||t.document.documentElement.clientHeight}),__getset(1,t,"width",function(){return t.__init__(),(Laya.stage&&Laya.stage.canvasRotation?t.clientHeight:t.clientWidth)*t.pixelRatio;
}),__getset(1,t,"container",function(){return t.__init__(),t._container||(t._container=t.createElement("div"),t._container.id="layaContainer",t.document.body.appendChild(t._container)),t._container},function(e){t._container=e}),__getset(1,t,"document",function(){return t.__init__(),t._document}),t.__init__=function(){if(!t._window){t._window=RunDriver.getWindow(),t._document=t.window.document,t._window.addEventListener("message",function(t){laya.utils.Browser._onMessage(t)},!1),t.document.__createElement=t.document.createElement,window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)};var e=window.document.body.style;e.margin=0,e.overflow="hidden";for(var i=window.document.getElementsByTagName("meta"),n=0,r=!1,a="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no";n<i.length;){var s=i[n];if("viewport"==s.name){s.content=a,r=!0;break}n++}r||(s=document.createElement("meta"),s.name="viewport",s.content=a,document.getElementsByTagName("head")[0].appendChild(s)),t.userAgent=t.window.navigator.userAgent,t.u=t.userAgent,t.onIOS=!!t.u.match(/\(i[^;]+;(U;)? CPU.+Mac OS X/),t.onMobile=t.u.indexOf("Mobile")>-1,t.onIPhone=t.u.indexOf("iPhone")>-1,t.onIPad=t.u.indexOf("iPad")>-1,t.onAndriod=t.u.indexOf("Android")>-1||t.u.indexOf("Adr")>-1,t.onWP=t.u.indexOf("Windows Phone")>-1,t.onQQBrowser=t.u.indexOf("QQBrowser")>-1,t.onMQQBrowser=t.u.indexOf("MQQBrowser")>-1||t.u.indexOf("Mobile")>-1&&t.u.indexOf("QQ")>-1,t.onIE=!!t.window.ActiveXObject||"ActiveXObject"in t.window,t.onWeiXin=t.u.indexOf("MicroMessenger")>-1,t.onPC=!t.onMobile,t.onSafari=!!t.u.match(/Version\/\d+\.\d\x20Mobile\/\S+\x20Safari/),t.httpProtocol="http:"==t.window.location.protocol,t.webAudioEnabled=t.window.AudioContext||t.window.webkitAudioContext||t.window.mozAudioContext?!0:!1,t.soundType=t.webAudioEnabled?"WEBAUDIOSOUND":"AUDIOSOUND",Sound=t.webAudioEnabled?WebAudioSound:AudioSound,t.webAudioEnabled&&WebAudioSound.initWebAudio(),t.enableTouch="ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,window.focus(),SoundManager._soundClass=Sound,Render._mainCanvas=Render._mainCanvas||HTMLCanvas.create("2D"),t.canvas||(t.canvas=HTMLCanvas.create("2D"),t.context=t.canvas.getContext("2d"))}},t._onMessage=function(e){if(e.data&&"size"==e.data.name){if(t.window.innerWidth=e.data.width,t.window.innerHeight=e.data.height,t.window.__innerHeight=e.data.clientHeight,!t.document.createEvent)return void console.warn("no document.createEvent");var i=t.document.createEvent("HTMLEvents");return i.initEvent("resize",!1,!1),void t.window.dispatchEvent(i)}},t.createElement=function(e){return t.__init__(),t.document.__createElement(e)},t.getElementById=function(e){return t.__init__(),t.document.getElementById(e)},t.removeElement=function(t){t&&t.parentNode&&t.parentNode.removeChild(t)},t.now=function(){return RunDriver.now()},t._window=null,t._document=null,t._container=null,t.userAgent=null,t.u=null,t.onIOS=!1,t.onMobile=!1,t.onIPhone=!1,t.onIPad=!1,t.onAndriod=!1,t.onAndroid=!1,t.onWP=!1,t.onQQBrowser=!1,t.onMQQBrowser=!1,t.onSafari=!1,t.onIE=!1,t.onWeiXin=!1,t.onPC=!1,t.httpProtocol=!1,t.webAudioEnabled=!1,t.soundType=null,t.enableTouch=!1,t.canvas=null,t.context=null,t.__init$=function(){},t}(),Byte=function(){function t(t){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,t?(this._u8d_=new Uint8Array(t),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this.___resizeBuffer(this._allocated_)}__class(t,"laya.utils.Byte");var e=t.prototype;return e.___resizeBuffer=function(t){try{var e=new Uint8Array(t);null!=this._u8d_&&(this._u8d_.length<=t?e.set(this._u8d_):e.set(this._u8d_.subarray(0,t))),this._u8d_=e,this._d_=new DataView(e.buffer)}catch(i){throw"___resizeBuffer err:"+t}},e.getString=function(){return this.rUTF(this.getUint16())},e.getFloat32Array=function(t,e){var i=t+e;i=i>this._length?this._length:i;var n=new Float32Array(this._d_.buffer.slice(t,i));return this._pos_=i,n},e.getUint8Array=function(t,e){var i=t+e;i=i>this._length?this._length:i;var n=new Uint8Array(this._d_.buffer.slice(t,i));return this._pos_=i,n},e.getInt16Array=function(t,e){var i=t+e;i=i>this._length?this._length:i;var n=new Int16Array(this._d_.buffer.slice(t,i));return this._pos_=i,n},e.getFloat32=function(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var t=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,t},e.getFloat64=function(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var t=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,t},e.writeFloat32=function(t){this.ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,t,this._xd_),this._pos_+=4},e.writeFloat64=function(t){this.ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,t,this._xd_),this._pos_+=8},e.getInt32=function(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var t=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,t},e.getUint32=function(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var t=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,t},e.writeInt32=function(t){this.ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,t,this._xd_),this._pos_+=4},e.writeUint32=function(t){this.ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,t,this._xd_),this._pos_+=4},e.getInt16=function(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var t=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,t},e.getUint16=function(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var t=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,t},e.writeUint16=function(t){this.ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,t,this._xd_),this._pos_+=2},e.writeInt16=function(t){this.ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,t,this._xd_),this._pos_+=2},e.getUint8=function(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._d_.getUint8(this._pos_++)},e.writeUint8=function(t){this.ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,t),this._pos_++},e._getUInt8=function(t){return this._d_.getUint8(t)},e._getUint16=function(t){return this._d_.getUint16(t,this._xd_)},e._getMatrix=function(){var t=new Matrix(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32());return t},e.rUTF=function(t){for(var e="",i=this._pos_+t,n=0,r=0,a=0,s=String.fromCharCode,o=this._u8d_,h=0;this._pos_<i;)n=o[this._pos_++],128>n?0!=n&&(e+=s(n)):224>n?e+=s((63&n)<<6|127&o[this._pos_++]):240>n?(r=o[this._pos_++],e+=s((31&n)<<12|(127&r)<<6|127&o[this._pos_++])):(r=o[this._pos_++],a=o[this._pos_++],e+=s((15&n)<<18|(127&r)<<12|a<<6&127|127&o[this._pos_++])),h++;return e},e.getCustomString=function(t){for(var e="",i=0,n=0,r=0,a=String.fromCharCode,s=this._u8d_;t>0;)if(n=s[this._pos_],128>n)e+=a(n),this._pos_++,t--;else for(i=n-128,this._pos_++,t-=i;i>0;)n=s[this._pos_++],r=s[this._pos_++],e+=a(r<<8|n),i--;return e},e.clear=function(){this._pos_=0,this.length=0},e.__getBuffer=function(){return this._d_.buffer},e.writeUTFBytes=function(t){t+="";for(var e=0,i=t.length;i>e;e++){var n=t.charCodeAt(e);127>=n?this.writeByte(n):2047>=n?(this.ensureWrite(this._pos_+2),this._u8d_.set([192|n>>6,128|63&n],this._pos_),this._pos_+=2):65535>=n?(this.ensureWrite(this._pos_+3),this._u8d_.set([224|n>>12,128|n>>6&63,128|63&n],this._pos_),this._pos_+=3):(this.ensureWrite(this._pos_+4),this._u8d_.set([240|n>>18,128|n>>12&63,128|n>>6&63,128|63&n],this._pos_),this._pos_+=4)}},e.writeUTFString=function(t){var e=this.pos;this.writeUint16(1),this.writeUTFBytes(t);var i=this.pos-e-2;if(i>=65536)throw"writeUTFString byte len more than 65536";this._d_.setUint16(e,i,this._xd_)},e.readUTFString=function(){return this.readUTFBytes(this.getUint16())},e.getUTFString=function(){return this.readUTFString()},e.readUTFBytes=function(t){if(void 0===t&&(t=-1),0==t)return"";var e=this.bytesAvailable;if(t>e)throw"readUTFBytes error - Out of bounds";return t=t>0?t:e,this.rUTF(t)},e.getUTFBytes=function(t){return void 0===t&&(t=-1),this.readUTFBytes(t)},e.writeByte=function(t){this.ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,t),this._pos_+=1},e.readByte=function(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++)},e.getByte=function(){return this.readByte()},e.ensureWrite=function(t){this._length<t&&(this._length=t),this._allocated_<t&&(this.length=t)},e.writeArrayBuffer=function(t,e,i){if(void 0===e&&(e=0),void 0===i&&(i=0),0>e||0>i)throw"writeArrayBuffer error - Out of bounds";0==i&&(i=t.byteLength-e),this.ensureWrite(this._pos_+i);var n=new Uint8Array(t);this._u8d_.set(n.subarray(e,e+i),this._pos_),this._pos_+=i},__getset(0,e,"buffer",function(){var t=this._d_.buffer;return t.byteLength==this.length?t:t.slice(0,this.length)}),__getset(0,e,"endian",function(){return this._xd_?"littleEndian":"bigEndian"},function(t){this._xd_="littleEndian"==t}),__getset(0,e,"length",function(){return this._length},function(t){this._allocated_<t?this.___resizeBuffer(this._allocated_=Math.floor(Math.max(t,2*this._allocated_))):this._allocated_>t&&this.___resizeBuffer(this._allocated_=t),this._length=t}),__getset(0,e,"pos",function(){return this._pos_},function(t){this._pos_=t}),__getset(0,e,"bytesAvailable",function(){return this._length-this._pos_}),t.getSystemEndian=function(){if(!t._sysEndian){var e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),t._sysEndian=256===new Int16Array(e)[0]?"littleEndian":"bigEndian"}return t._sysEndian},t.BIG_ENDIAN="bigEndian",t.LITTLE_ENDIAN="littleEndian",t._sysEndian=null,t}(),CacheManger=function(){function t(){}return __class(t,"laya.utils.CacheManger"),t.regCacheByFunction=function(e,i){t.unRegCacheByFunction(e,i);var n;n={tryDispose:e,getCacheList:i},t._cacheList.push(n)},t.unRegCacheByFunction=function(e,i){var n=0,r=0;for(r=t._cacheList.length,n=0;r>n;n++)if(t._cacheList[n].tryDispose==e&&t._cacheList[n].getCacheList==i)return void t._cacheList.splice(n,1)},t.forceDispose=function(){var e=0,i=t._cacheList.length;for(e=0;i>e;e++)t._cacheList[e].tryDispose(!0)},t.beginCheck=function(e){void 0===e&&(e=15e3),Laya.timer.loop(e,null,t._checkLoop)},t.stopCheck=function(){Laya.timer.clear(null,t._checkLoop)},t._checkLoop=function(){var e=t._cacheList;if(!(e.length<1)){var i=Browser.now(),n=0,r=0;for(r=n=e.length;n>0&&(t._index++,t._index=t._index%r,e[t._index].tryDispose(!1),!(Browser.now()-i>t.loopTimeLimit));)n--}},t.loopTimeLimit=2,t._cacheList=[],t._index=0,t}(),ClassUtils=function(){function t(){}return __class(t,"laya.utils.ClassUtils"),t.regClass=function(e,i){t._classMap[e]=i},t.getRegClass=function(e){return t._classMap[e]},t.getInstance=function(e){var i=t.getClass(e);return i?new i:(console.warn("[error] Undefined class:",e),null)},t.createByJson=function(e,i,n,r,a){"string"==typeof e&&(e=JSON.parse(e));var s=e.props;if(!i&&(i=a?a.runWith(e):t.getInstance(s.runtime||e.type),!i))return null;var o=e.child;if(o)for(var h=0,l=o.length;l>h;h++){var u=o[h];if("render"!==u.props.name&&"render"!==u.props.renderType||!i._$set_itemRender)if("Graphic"==u.type)t.addGraphicsToSprite(u,i);else if(t.isDrawType(u.type))t.addGraphicToSprite(u,i,!0);else{var c=t.createByJson(u,null,n,r,a);"Script"==u.type?c.hasOwnProperty("owner")?c.owner=i:c.hasOwnProperty("target")&&(c.target=i):"mask"==u.props.renderType?i.mask=c:i.addChild(c)}else i.itemRender=u}if(s)for(var _ in s){var d=s[_];"var"===_&&n?n[d]=i:d instanceof Array&&"function"==typeof i[_]?i[_].apply(i,d):i[_]=d}return r&&e.customProps&&r.runWith([i,e]),i.created&&i.created(),i},t.addGraphicsToSprite=function(e,i){var n;if(n=e.child,n&&!(n.length<1)){var r;r=t._getGraphicsFromSprite(e,i);var a=0,s=0;e.props&&(a=t._getObjVar(e.props,"x",0),s=t._getObjVar(e.props,"y",0)),0!=a&&0!=s&&r.translate(a,s);var o=0,h=0;for(h=n.length,o=0;h>o;o++)t._addGraphicToGraphics(n[o],r);0!=a&&0!=s&&r.translate(-a,-s)}},t.addGraphicToSprite=function(e,i,n){void 0===n&&(n=!1);var r;r=n?t._getGraphicsFromSprite(e,i):i.graphics,t._addGraphicToGraphics(e,r)},t._getGraphicsFromSprite=function(t,e){var i;if(!t||!t.props)return e.graphics;var n;switch(n=t.props.renderType){case"hit":case"unHit":var r;e.hitArea||(e.hitArea=new HitArea),r=e.hitArea,r[n]||(r[n]=new Graphics),i=r[n]}return i||(i=e.graphics),i},t._getTransformData=function(e){var i;(e.hasOwnProperty("pivotX")||e.hasOwnProperty("pivotY"))&&(i=i||new Matrix,i.translate(-t._getObjVar(e,"pivotX",0),-t._getObjVar(e,"pivotY",0)));var n=t._getObjVar(e,"scaleX",1),r=t._getObjVar(e,"scaleY",1),a=t._getObjVar(e,"rotation",0);t._getObjVar(e,"skewX",0),t._getObjVar(e,"skewY",0);return(1!=n||1!=r||0!=a)&&(i=i||new Matrix,i.scale(n,r),i.rotate(.0174532922222222*a)),i},t._addGraphicToGraphics=function(e,i){var n;if(n=e.props){var r;if(r=t.DrawTypeDic[e.type]){var a;a=i;var s,o=t._getParams(n,r[1],r[2],r[3]);s=t._tM,(s||1!=t._alpha)&&(a.save(),s&&a.transform(s),1!=t._alpha&&a.alpha(t._alpha)),a[r[0]].apply(a,o),(s||1!=t._alpha)&&a.restore()}}},t._adptLineData=function(t){return t[2]=parseFloat(t[0])+parseFloat(t[2]),t[3]=parseFloat(t[1])+parseFloat(t[3]),t},t._adptTextureData=function(t){return t[0]=Loader.getRes(t[0]),t},t._adptLinesData=function(e){return e[2]=t._getPointListByStr(e[2]),e},t.isDrawType=function(e){return"Image"==e?!1:t.DrawTypeDic.hasOwnProperty(e)},t._getParams=function(e,i,n,r){void 0===n&&(n=0);var a;a=t._temParam,a.length=i.length;var s=0,o=0;for(o=i.length,s=0;o>s;s++)a[s]=t._getObjVar(e,i[s][0],i[s][1]);t._alpha=t._getObjVar(e,"alpha",1);var h;return h=t._getTransformData(e),h?(n||(n=0),h.translate(a[n],a[n+1]),a[n]=a[n+1]=0,t._tM=h):t._tM=null,r&&t[r]&&(a=t[r](a)),a},t._getPointListByStr=function(t){var e;e=t.split(",");var i=0,n=0;for(n=e.length,i=0;n>i;i++)e[i]=parseFloat(e[i]);return e},t._getObjVar=function(t,e,i){return t.hasOwnProperty(e)?t[e]:i},t._temParam=[],t._classMap={Sprite:"laya.display.Sprite",Text:"laya.display.Text",Animation:"laya.display.Animation",Skeleton:"laya.ani.bone.Skeleton",Particle2D:"laya.particle.Particle2D",div:"laya.html.dom.HTMLDivElement",p:"laya.html.dom.HTMLElement",img:"laya.html.dom.HTMLImageElement",span:"laya.html.dom.HTMLElement",br:"laya.html.dom.HTMLBrElement",style:"laya.html.dom.HTMLStyleElement",font:"laya.html.dom.HTMLElement",a:"laya.html.dom.HTMLElement","#text":"laya.html.dom.HTMLElement"},t.getClass=function(e){var i=t._classMap[e]||e;return"string"==typeof i?Laya.__classmap[i]:i},t._tM=null,t._alpha=NaN,__static(t,["DrawTypeDic",function(){return this.DrawTypeDic={Rect:["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Circle:["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Pie:["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Image:["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],Texture:["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],FillTexture:["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],FillText:["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],Line:["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],Lines:["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Curves:["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Poly:["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]}}]),t}(),Color=function(){function t(e){if(this._color=[],"string"==typeof e){this.strColor=e,null===e&&(e="#000000"),"#"==e.charAt(0)&&(e=e.substr(1));var i=e.length;if(3==i||4==i){for(var n="",r=0;i>r;r++)n+=e[r]+e[r];e=n}var a=this.numColor=parseInt(e,16),s=8==e.length;if(s)return void(this._color=[parseInt(e.substr(0,2),16)/255,((16711680&a)>>16)/255,((65280&a)>>8)/255,(255&a)/255])}else a=this.numColor=e,this.strColor=Utils.toHexColor(a);this._color=[((16711680&a)>>16)/255,((65280&a)>>8)/255,(255&a)/255,1],this._color.__id=++t._COLODID}return __class(t,"laya.utils.Color"),t._initDefault=function(){t._DEFAULT={};for(var e in t._COLOR_MAP)t._SAVE[e]=t._DEFAULT[e]=new t(t._COLOR_MAP[e]);return t._DEFAULT},t._initSaveMap=function(){t._SAVE_SIZE=0,t._SAVE={};for(var e in t._DEFAULT)t._SAVE[e]=t._DEFAULT[e]},t.create=function(e){var i=t._SAVE[e+""];return null!=i?i:(t._SAVE_SIZE<1e3||t._initSaveMap(),t._SAVE[e+""]=new t(e))},t._SAVE={},t._SAVE_SIZE=0,t._COLOR_MAP={white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#AAAAAA"},t._DEFAULT=t._initDefault(),t._COLODID=1,t}(),Dictionary=function(){function t(){this._values=[],this._keys=[]}__class(t,"laya.utils.Dictionary");var e=t.prototype;return e.set=function(t,e){var i=this.indexOf(t);return i>=0?void(this._values[i]=e):(this._keys.push(t),void this._values.push(e))},e.indexOf=function(t){var e=this._keys.indexOf(t);return e>=0?e:(t="string"==typeof t?Number(t):"number"==typeof t?t.toString():t,this._keys.indexOf(t))},e.get=function(t){var e=this.indexOf(t);return 0>e?null:this._values[e]},e.remove=function(t){var e=this.indexOf(t);return e>=0?(this._keys.splice(e,1),this._values.splice(e,1),!0):!1},e.clear=function(){this._values.length=0,this._keys.length=0},__getset(0,e,"values",function(){return this._values}),__getset(0,e,"keys",function(){return this._keys}),t}(),Dragging=function(){function t(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}__class(t,"laya.utils.Dragging");var e=t.prototype;return e.start=function(t,e,i,n,r,a,s,o){void 0===o&&(o=.92),this.clearTimer(),this.target=t,this.area=e,this.hasInertia=i,this.elasticDistance=e?n:0,this.elasticBackTime=r,this.data=a,this._disableMouseEvent=s,this.ratio=o,1!=t.globalScaleX||1!=t.globalScaleY?this._parent=t.parent:this._parent=Laya.stage,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,Laya.stage.on("mouseup",this,this.onStageMouseUp),Laya.stage.on("mouseout",this,this.onStageMouseUp),Laya.timer.frameLoop(1,this,this.loop)},e.clearTimer=function(){Laya.timer.clear(this,this.loop),Laya.timer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)},e.stop=function(){this._dragging&&(MouseManager.instance.disableMouseEvent=!1,Laya.stage.off("mouseup",this,this.onStageMouseUp),Laya.stage.off("mouseout",this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())},e.loop=function(){var t=this._parent.getMousePoint(),e=t.x,i=t.y,n=e-this._lastX,r=i-this._lastY;if(this._clickOnly){if(!(Math.abs(n*Laya.stage._canvasTransform.getScaleX())>1||Math.abs(r*Laya.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event("dragstart",this.data),MouseManager.instance.disableMouseEvent=this._disableMouseEvent,this.target._set$P("$_MOUSEDOWN",!1)}else this._offsets.push(n,r);(0!==n||0!==r)&&(this._lastX=e,this._lastY=i,this.target.x+=n*this._elasticRateX,this.target.y+=r*this._elasticRateY,this.area&&this.checkArea(),this.target.event("dragmove",this.data))},e.checkArea=function(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target.x<this.area.x)var t=this.area.x-this.target.x;else t=this.target.x>this.area.x+this.area.width?this.target.x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-t/this.elasticDistance),this.target.y<this.area.y)var e=this.area.y-this.target.y;else e=this.target.y>this.area.y+this.area.height?this.target.y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-e/this.elasticDistance)}},e.backToArea=function(){this.target.x=Math.min(Math.max(this.target.x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target.y,this.area.y),this.area.y+this.area.height)},e.onStageMouseUp=function(t){if(MouseManager.instance.disableMouseEvent=!1,Laya.stage.off("mouseup",this,this.onStageMouseUp),Laya.stage.off("mouseout",this,this.onStageMouseUp),Laya.timer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var e=this._offsets.length,i=Math.min(e,6),n=this._offsets.length-i,r=e-1;r>n;r--)this._offsetY+=this._offsets[r--],this._offsetX+=this._offsets[r];this._offsetX=this._offsetX/i*2,this._offsetY=this._offsetY/i*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),Laya.timer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()},e.checkElastic=function(){var t=NaN,e=NaN;if(this.target.x<this.area.x?t=this.area.x:this.target.x>this.area.x+this.area.width&&(t=this.area.x+this.area.width),this.target.y<this.area.y?e=this.area.y:this.target.y>this.area.y+this.area.height&&(e=this.area.y+this.area.height),isNaN(t)&&isNaN(e))this.clear();else{var i={};isNaN(t)||(i.x=t),isNaN(e)||(i.y=e),this._tween=Tween.to(this.target,i,this.elasticBackTime,Ease.sineOut,Handler.create(this,this.clear),0,!1,!1)}},e.tweenMove=function(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event("dragmove",this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(Laya.timer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())},e.clear=function(){if(this.target){this.clearTimer();var t=this.target;this.target=null,this._parent=null,t.event("dragend",this.data)}},t}(),Ease=function(){function t(){}return __class(t,"laya.utils.Ease"),t.linearNone=function(t,e,i,n){return i*t/n+e},t.linearIn=function(t,e,i,n){return i*t/n+e},t.linearInOut=function(t,e,i,n){return i*t/n+e},t.linearOut=function(t,e,i,n){return i*t/n+e},t.bounceIn=function(e,i,n,r){return n-t.bounceOut(r-e,0,n,r)+i},t.bounceInOut=function(e,i,n,r){return.5*r>e?.5*t.bounceIn(2*e,0,n,r)+i:.5*t.bounceOut(2*e-r,0,n,r)+.5*n+i},t.bounceOut=function(t,e,i,n){return(t/=n)<1/2.75?i*(7.5625*t*t)+e:2/2.75>t?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:2.5/2.75>t?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e},t.backIn=function(t,e,i,n,r){return void 0===r&&(r=1.70158),i*(t/=n)*t*((r+1)*t-r)+e},t.backInOut=function(t,e,i,n,r){return void 0===r&&(r=1.70158),(t/=.5*n)<1?.5*i*(t*t*(((r*=1.525)+1)*t-r))+e:i/2*((t-=2)*t*(((r*=1.525)+1)*t+r)+2)+e},t.backOut=function(t,e,i,n,r){return void 0===r&&(r=1.70158),i*((t=t/n-1)*t*((r+1)*t+r)+1)+e},t.elasticIn=function(e,i,n,r,a,s){void 0===a&&(a=0),void 0===s&&(s=0);var o;return 0==e?i:1==(e/=r)?i+n:(s||(s=.3*r),!a||n>0&&n>a||0>n&&-n>a?(a=n,o=s/4):o=s/t.PI2*Math.asin(n/a),-(a*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*t.PI2/s))+i)},t.elasticInOut=function(e,i,n,r,a,s){void 0===a&&(a=0),void 0===s&&(s=0);var o;return 0==e?i:2==(e/=.5*r)?i+n:(s||(s=r*(.3*1.5)),!a||n>0&&n>a||0>n&&-n>a?(a=n,o=s/4):o=s/t.PI2*Math.asin(n/a),1>e?-.5*(a*Math.pow(2,10*(e-=1))*Math.sin((e*r-o)*t.PI2/s))+i:a*Math.pow(2,-10*(e-=1))*Math.sin((e*r-o)*t.PI2/s)*.5+n+i)},t.elasticOut=function(e,i,n,r,a,s){void 0===a&&(a=0),void 0===s&&(s=0);var o;return 0==e?i:1==(e/=r)?i+n:(s||(s=.3*r),!a||n>0&&n>a||0>n&&-n>a?(a=n,o=s/4):o=s/t.PI2*Math.asin(n/a),a*Math.pow(2,-10*e)*Math.sin((e*r-o)*t.PI2/s)+n+i)},t.strongIn=function(t,e,i,n){return i*(t/=n)*t*t*t*t+e},t.strongInOut=function(t,e,i,n){return(t/=.5*n)<1?.5*i*t*t*t*t*t+e:.5*i*((t-=2)*t*t*t*t+2)+e},t.strongOut=function(t,e,i,n){return i*((t=t/n-1)*t*t*t*t+1)+e},t.sineInOut=function(t,e,i,n){return.5*-i*(Math.cos(Math.PI*t/n)-1)+e},t.sineIn=function(e,i,n,r){return-n*Math.cos(e/r*t.HALF_PI)+n+i},t.sineOut=function(e,i,n,r){return n*Math.sin(e/r*t.HALF_PI)+i},t.quintIn=function(t,e,i,n){return i*(t/=n)*t*t*t*t+e},t.quintInOut=function(t,e,i,n){return(t/=.5*n)<1?.5*i*t*t*t*t*t+e:.5*i*((t-=2)*t*t*t*t+2)+e},t.quintOut=function(t,e,i,n){return i*((t=t/n-1)*t*t*t*t+1)+e},t.quartIn=function(t,e,i,n){return i*(t/=n)*t*t*t+e},t.quartInOut=function(t,e,i,n){return(t/=.5*n)<1?.5*i*t*t*t*t+e:.5*-i*((t-=2)*t*t*t-2)+e},t.quartOut=function(t,e,i,n){return-i*((t=t/n-1)*t*t*t-1)+e},t.cubicIn=function(t,e,i,n){return i*(t/=n)*t*t+e},t.cubicInOut=function(t,e,i,n){return(t/=.5*n)<1?.5*i*t*t*t+e:.5*i*((t-=2)*t*t+2)+e},t.cubicOut=function(t,e,i,n){return i*((t=t/n-1)*t*t+1)+e},t.quadIn=function(t,e,i,n){return i*(t/=n)*t+e},t.quadInOut=function(t,e,i,n){return(t/=.5*n)<1?.5*i*t*t+e:.5*-i*(--t*(t-2)-1)+e},t.quadOut=function(t,e,i,n){return-i*(t/=n)*(t-2)+e},t.expoIn=function(t,e,i,n){return 0==t?e:i*Math.pow(2,10*(t/n-1))+e-.001*i},t.expoInOut=function(t,e,i,n){return 0==t?e:t==n?e+i:(t/=.5*n)<1?.5*i*Math.pow(2,10*(t-1))+e:.5*i*(-Math.pow(2,-10*--t)+2)+e},t.expoOut=function(t,e,i,n){return t==n?e+i:i*(-Math.pow(2,-10*t/n)+1)+e},t.circIn=function(t,e,i,n){return-i*(Math.sqrt(1-(t/=n)*t)-1)+e},t.circInOut=function(t,e,i,n){return(t/=.5*n)<1?.5*-i*(Math.sqrt(1-t*t)-1)+e:.5*i*(Math.sqrt(1-(t-=2)*t)+1)+e},t.circOut=function(t,e,i,n){return i*Math.sqrt(1-(t=t/n-1)*t)+e},t.HALF_PI=.5*Math.PI,t.PI2=2*Math.PI,t}(),HitArea=function(){function t(){this._hit=null,this._unHit=null}__class(t,"laya.utils.HitArea");var e=t.prototype;return e.isHit=function(e,i){return t.isHitGraphic(e,i,this.hit)?!t.isHitGraphic(e,i,this.unHit):!1},e.contains=function(t,e){return this.isHit(t,e)},__getset(0,e,"hit",function(){return this._hit||(this._hit=new Graphics),this._hit},function(t){this._hit=t}),__getset(0,e,"unHit",function(){return this._unHit||(this._unHit=new Graphics),this._unHit},function(t){this._unHit=t}),t.isHitGraphic=function(e,i,n){if(!n)return!1;var r;if(r=n.cmds,!r&&n._one&&(r=t._cmds,r.length=1,r[0]=n._one),!r)return!1;var a=0,s=0;s=r.length;var o;for(a=0;s>a;a++)if(o=r[a]){var h=Render._context;switch(o.callee){case h._translate:case 6:e-=o[0],i-=o[1]}if(t.isHitCmd(e,i,o))return!0}return!1},t.isHitCmd=function(e,i,n){if(!n)return!1;var r=Render._context,a=!1;switch(n.callee){case r._drawRect:case 13:t._rec.setTo(n[0],n[1],n[2],n[3]),a=t._rec.contains(e,i);break;case r._drawCircle:case r._fillCircle:case 14:var s=NaN;e-=n[0],i-=n[1],s=e*e+i*i,a=s<n[2]*n[2];break;case r._drawPoly:case 18:e-=n[0],i-=n[1],a=t.ptInPolygon(e,i,n[2])}return a},t.ptInPolygon=function(e,i,n){var r;r=t._ptPoint,r.setTo(e,i);var a=0,s=NaN,o=NaN,h=NaN,l=NaN,u=0;u=n.length;for(var c=0;u>c;c+=2)if(s=n[c],o=n[c+1],h=n[(c+2)%u],l=n[(c+3)%u],o!=l&&!(r.y<Math.min(o,l)||r.y>=Math.max(o,l))){var _=(r.y-o)*(h-s)/(l-o)+s;_>r.x&&a++}return a%2==1},t._cmds=[],__static(t,["_rec",function(){return this._rec=new Rectangle},"_ptPoint",function(){return this._ptPoint=new Point}]),t}(),HTMLChar=function(){function t(e,i,n,r){this["char"]=e,this.charNum=e.charCodeAt(0),this._x=this._y=0,this.width=i,this.height=n,this.style=r,this.isWord=!t._isWordRegExp.test(e)}__class(t,"laya.utils.HTMLChar");var e=t.prototype;return Laya.imps(e,{"laya.display.ILayout":!0}),e.setSprite=function(t){this._sprite=t},e.getSprite=function(){return this._sprite},e._isChar=function(){return!0},e._getCSSStyle=function(){return this.style},__getset(0,e,"width",function(){return this._w},function(t){this._w=t}),__getset(0,e,"x",function(){return this._x},function(t){this._sprite&&(this._sprite.x=t),this._x=t}),__getset(0,e,"y",function(){return this._y},function(t){this._sprite&&(this._sprite.y=t),this._y=t}),__getset(0,e,"height",function(){return this._h},function(t){this._h=t}),t._isWordRegExp=new RegExp("[\\w.]",""),t}(),Log=function(){function t(){}return __class(t,"laya.utils.Log"),t.enable=function(){t._logdiv||(t._logdiv=Browser.window.document.createElement("div"),Browser.window.document.body.appendChild(t._logdiv),t._logdiv.style.cssText="pointer-events:none;border:white;overflow:hidden;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;")},t.toggle=function(){var e=t._logdiv.style;"1px"==e.width?e.width=e.height="50%":e.width=e.height="1px"},t.print=function(e){t._logdiv&&(t._count>=t.maxCount&&t.clear(),t._count++,t._logdiv.innerText+=e+"\n",t._logdiv.scrollTop=t._logdiv.scrollHeight)},t.clear=function(){t._logdiv.innerText="",t._count=0},t._logdiv=null,t._count=0,t.maxCount=20,t}(),Mouse=function(){function t(){}return __class(t,"laya.utils.Mouse"),__getset(1,t,"cursor",function(){return t._style.cursor},function(e){t._style.cursor=e}),t.hide=function(){"none"!=t.cursor&&(t._preCursor=t.cursor,t.cursor="none")},t.show=function(){"none"==t.cursor&&(t._preCursor?t.cursor=t._preCursor:t.cursor="auto")},t._preCursor=null,__static(t,["_style",function(){return this._style=Browser.document.body.style}]),t}(),Pool=function(){function t(){}return __class(t,"laya.utils.Pool"),t.getPoolBySign=function(e){return t._poolDic[e]||(t._poolDic[e]=[])},t.clearBySign=function(e){t._poolDic[e]&&(t._poolDic[e].length=0)},t.recover=function(e,i){i.__InPool||(i.__InPool=!0,t.getPoolBySign(e).push(i))},t.getItemByClass=function(e,i){var n=t.getPoolBySign(e),r=n.length?n.pop():new i;return r.__InPool=!1,r},t.getItemByCreateFun=function(e,i){var n=t.getPoolBySign(e),r=n.length?n.pop():i();return r.__InPool=!1,r},t.getItem=function(e){var i=t.getPoolBySign(e),n=i.length?i.pop():null;return n&&(n.__InPool=!1),n},t._poolDic={},t.InPoolSign="__InPool",t}(),PoolCache=function(){function t(){this.sign=null,this.maxCount=1e3}__class(t,"laya.utils.PoolCache");var e=t.prototype;return e.getCacheList=function(){return Pool.getPoolBySign(this.sign)},e.tryDispose=function(t){var e;e=Pool.getPoolBySign(this.sign),e.length>this.maxCount&&e.splice(this.maxCount,e.length-this.maxCount)},t.addPoolCacheManager=function(e,i){void 0===i&&(i=100);var n;n=new t,n.sign=e,n.maxCount=i,CacheManger.regCacheByFunction(Utils.bind(n.tryDispose,n),Utils.bind(n.getCacheList,n))},t}(),Stat=function(){function t(){}return __class(t,"laya.utils.Stat"),__getset(1,t,"onclick",null,function(e){t._canvas.source.onclick=e,t._canvas.source.style.pointerEvents=""}),t.show=function(e,i){if(void 0===e&&(e=0),void 0===i&&(i=0),Render.isConchApp)return void(conch.showFPS&&conch.showFPS(e,i));var n=Browser.pixelRatio;t._width=130*n,t._vx=75*n,t._view[0]={title:"FPS(Canvas)",value:"_fpsStr",color:"yellow",units:"int"},t._view[1]={title:"Sprite",value:"spriteCount",color:"white",units:"int"},t._view[2]={title:"DrawCall",value:"drawCall",color:"white",units:"int"},t._view[3]={title:"CurMem",value:"currentMemorySize",color:"yellow",units:"M"},Render.isWebGL?(t._view[4]={title:"Shader",value:"shaderCall",color:"white",units:"int"},Render.is3DMode?(t._view[0].title="FPS(3D)",t._view[5]={title:"TriFaces",value:"trianglesFaces",color:"white",units:"int"},t._view[6]={title:"treeNodeColl",value:"treeNodeCollision",color:"white",units:"int"},t._view[7]={title:"treeSpriteColl",value:"treeSpriteCollision",color:"white",units:"int"}):(t._view[0].title="FPS(WebGL)",t._view[5]={title:"Canvas",value:"_canvasStr",color:"white",units:"int"})):t._view[4]={title:"Canvas",value:"_canvasStr",color:"white",units:"int"},t._fontSize=12*n;for(var r=0;r<t._view.length;r++)t._view[r].x=4,t._view[r].y=r*t._fontSize+2*n;t._height=n*(12*t._view.length+3*n)+4,t._canvas||(t._canvas=new HTMLCanvas("2D"),
t._canvas.size(t._width,t._height),t._ctx=t._canvas.getContext("2d"),t._ctx.textBaseline="top",t._ctx.font=t._fontSize+"px Sans-serif",t._canvas.source.style.cssText="pointer-events:none;background:rgba(150,150,150,0.8);z-index:100000;position: absolute;left:"+e+"px;top:"+i+"px;width:"+t._width/n+"px;height:"+t._height/n+"px;"),t._first=!0,t.loop(),t._first=!1,Browser.container.appendChild(t._canvas.source),t.enable()},t.enable=function(){Laya.timer.frameLoop(1,t,t.loop)},t.hide=function(){t._canvas&&(Browser.removeElement(t._canvas.source),Laya.timer.clear(t,t.loop))},t.clear=function(){t.trianglesFaces=t.drawCall=t.shaderCall=t.spriteCount=t.treeNodeCollision=t.treeSpriteCollision=t.canvasNormal=t.canvasBitmap=t.canvasReCache=0},t.loop=function(){t._count++;var e=Browser.now();if(!(e-t._timer<1e3)){var i=t._count;if(t.FPS=Math.round(1e3*i/(e-t._timer)),t._canvas){t.trianglesFaces=Math.round(t.trianglesFaces/i),t.drawCall=Math.round(t.drawCall/i)-2,t.shaderCall=Math.round(t.shaderCall/i),t.spriteCount=Math.round(t.spriteCount/i)-1,t.canvasNormal=Math.round(t.canvasNormal/i),t.canvasBitmap=Math.round(t.canvasBitmap/i),t.canvasReCache=Math.ceil(t.canvasReCache/i),t.treeNodeCollision=Math.round(t.treeNodeCollision/i),t.treeSpriteCollision=Math.round(t.treeSpriteCollision/i);var n=t.FPS>0?Math.floor(1e3/t.FPS).toString():" ";t._fpsStr=t.FPS+(t.renderSlow?" slow":"")+" "+n,t._canvasStr=t.canvasReCache+"/"+t.canvasNormal+"/"+t.canvasBitmap,t.currentMemorySize=ResourceManager.systemResourceManager.memorySize;var r=t._ctx;r.clearRect(t._first?0:t._vx,0,t._width,t._height);for(var a=0;a<t._view.length;a++){var s=t._view[a];t._first&&(r.fillStyle="white",r.fillText(s.title,s.x,s.y,null,null,null)),r.fillStyle=s.color;var o=t[s.value];"M"==s.units&&(o=Math.floor(o/1048576*100)/100+" M"),r.fillText(o+"",s.x+t._vx,s.y,null,null,null)}t.clear()}t._count=0,t._timer=e}},t.FPS=0,t.loopCount=0,t.shaderCall=0,t.drawCall=0,t.trianglesFaces=0,t.spriteCount=0,t.treeNodeCollision=0,t.treeSpriteCollision=0,t.canvasNormal=0,t.canvasBitmap=0,t.canvasReCache=0,t.renderSlow=!1,t.currentMemorySize=0,t._fpsStr=null,t._canvasStr=null,t._canvas=null,t._ctx=null,t._timer=0,t._count=0,t._width=0,t._height=100,t._view=[],t._fontSize=12,t._first=!1,t._vx=NaN,t}(),StringKey=function(){function t(){this._strsToID={},this._idToStrs=[],this._length=0}__class(t,"laya.utils.StringKey");var e=t.prototype;return e.add=function(t){var e=this._strsToID[t];return null!=e?e:(this._idToStrs[this._length]=t,this._strsToID[t]=this._length++)},e.getID=function(t){var e=this._strsToID[t];return null==e?-1:e},e.getName=function(t){var e=this._idToStrs[t];return null==e?void 0:e},t}(),Timer=function(){function t(){this._delta=0,this.scale=1,this.currFrame=0,this._mid=1,this._map=[],this._laters=[],this._handlers=[],this._temp=[],this._count=0,this.currTimer=Browser.now(),this._lastTimer=Browser.now(),Laya.timer&&Laya.timer.frameLoop(1,this,this._update)}var e;__class(t,"laya.utils.Timer");var i=t.prototype;return i._update=function(){if(this.scale<=0)return void(this._lastTimer=Browser.now());var t=this.currFrame=this.currFrame+this.scale,e=Browser.now();this._delta=(e-this._lastTimer)*this.scale;var i=this.currTimer=this.currTimer+this._delta;this._lastTimer=e;var n=this._handlers;for(this._count=0,s=0,o=n.length;o>s;s++)if(h=n[s],null!==h.method){var r=h.userFrame?t:i;if(r>=h.exeTime)if(h.repeat)if(h.jumpFrame)for(;r>=h.exeTime;)h.exeTime+=h.delay,h.run(!1);else h.exeTime+=h.delay,h.run(!1),r>h.exeTime&&(h.exeTime+=Math.ceil((r-h.exeTime)/h.delay)*h.delay);else h.run(!0)}else this._count++;(this._count>30||t%200===0)&&this._clearHandlers();for(var a=this._laters,s=0,o=a.length-1;o>=s;s++){var h=a[s];null!==h.method&&(this._map[h.key]=null,h.run(!1)),this._recoverHandler(h),s===o&&(o=a.length-1)}a.length=0},i._clearHandlers=function(){for(var t=this._handlers,e=0,i=t.length;i>e;e++){var n=t[e];null!==n.method?this._temp.push(n):this._recoverHandler(n)}this._handlers=this._temp,this._temp=t,this._temp.length=0},i._recoverHandler=function(e){this._map[e.key]==e&&(this._map[e.key]=null),e.clear(),t._pool.push(e)},i._create=function(i,n,r,a,s,o,h){if(!r)return s.apply(a,o),null;if(h){var l=this._getHandler(a,s);if(l)return l.repeat=n,l.userFrame=i,l.delay=r,l.caller=a,l.method=s,l.args=o,l.exeTime=r+(i?this.currFrame:this.currTimer+Browser.now()-this._lastTimer),l}return l=t._pool.length>0?t._pool.pop():new e,l.repeat=n,l.userFrame=i,l.delay=r,l.caller=a,l.method=s,l.args=o,l.exeTime=r+(i?this.currFrame:this.currTimer+Browser.now()-this._lastTimer),this._indexHandler(l),this._handlers.push(l),l},i._indexHandler=function(t){var e=t.caller,i=t.method,n=e?e.$_GID||(e.$_GID=Utils.getGID()):0,r=i.$_TID||(i.$_TID=1e5*this._mid++);t.key=n+r,this._map[t.key]=t},i.once=function(t,e,i,n,r){void 0===r&&(r=!0),this._create(!1,!1,t,e,i,n,r)},i.loop=function(t,e,i,n,r,a){void 0===r&&(r=!0),void 0===a&&(a=!1);var s=this._create(!1,!0,t,e,i,n,r);s&&(s.jumpFrame=a)},i.frameOnce=function(t,e,i,n,r){void 0===r&&(r=!0),this._create(!0,!1,t,e,i,n,r)},i.frameLoop=function(t,e,i,n,r){void 0===r&&(r=!0),this._create(!0,!0,t,e,i,n,r)},i.toString=function(){return"callLater:"+this._laters.length+" handlers:"+this._handlers.length+" pool:"+t._pool.length},i.clear=function(t,e){var i=this._getHandler(t,e);i&&(this._map[i.key]=null,i.key=0,i.clear())},i.clearAll=function(t){if(t)for(var e=0,i=this._handlers.length;i>e;e++){var n=this._handlers[e];n.caller===t&&(this._map[n.key]=null,n.key=0,n.clear())}},i._getHandler=function(t,e){var i=t?t.$_GID||(t.$_GID=Utils.getGID()):0,n=e.$_TID||(e.$_TID=1e5*this._mid++);return this._map[i+n]},i.callLater=function(i,n,r){if(null==this._getHandler(i,n)){if(t._pool.length)var a=t._pool.pop();else a=new e;a.caller=i,a.method=n,a.args=r,this._indexHandler(a),this._laters.push(a)}},i.runCallLater=function(t,e){var i=this._getHandler(t,e);i&&null!=i.method&&(this._map[i.key]=null,i.run(!0))},i.runTimer=function(t,e){this.runCallLater(t,e)},__getset(0,i,"delta",function(){return this._delta}),t._pool=[],t.__init$=function(){e=function(){function t(){this.key=0,this.repeat=!1,this.delay=0,this.userFrame=!1,this.exeTime=0,this.caller=null,this.method=null,this.args=null,this.jumpFrame=!1}__class(t,"");var e=t.prototype;return e.clear=function(){this.caller=null,this.method=null,this.args=null},e.run=function(t){var e=this.caller;if(e&&e.destroyed)return this.clear();var i=this.method,n=this.args;t&&this.clear(),null!=i&&(n?i.apply(e,n):i.call(e))},t}()},t}(),Tween=function(){function t(){this.gid=0}__class(t,"laya.utils.Tween");var e=t.prototype;return e.to=function(t,e,i,n,r,a,s){return void 0===a&&(a=0),void 0===s&&(s=!1),this._create(t,e,i,n,r,a,s,!0,!1,!0)},e.from=function(t,e,i,n,r,a,s){return void 0===a&&(a=0),void 0===s&&(s=!1),this._create(t,e,i,n,r,a,s,!1,!1,!0)},e._create=function(e,i,n,r,a,s,o,h,l,u){if(!e)throw new Error("Tween:target is null");this._target=e,this._duration=n,this._ease=r||i.ease||t.easeNone,this._complete=a||i.complete,this._delay=s,this._props=[],this._usedTimer=0,this._startTimer=Browser.now(),this._usedPool=l,this.update=i.update;var c=e.$_GID||(e.$_GID=Utils.getGID());return t.tweenMap[c]?(o&&t.clearTween(e),t.tweenMap[c].push(this)):t.tweenMap[c]=[this],u?0>=s?this.firstStart(e,i,h):Laya.timer.once(s,this,this.firstStart,[e,i,h]):this._initProps(e,i,h),this},e.firstStart=function(t,e,i){return t.destroyed?void this.clear():(this._initProps(t,e,i),void this._beginLoop())},e._initProps=function(t,e,i){for(var n in e)if("number"==typeof t[n]){var r=i?t[n]:e[n],a=i?e[n]:t[n];this._props.push([n,r,a-r]),i||(t[n]=r)}},e._beginLoop=function(){Laya.timer.frameLoop(1,this,this._doEase)},e._doEase=function(){this._updateEase(Browser.now())},e._updateEase=function(e){var i=this._target;if(i){if(i.destroyed)return t.clearTween(i);var n=this._usedTimer=e-this._startTimer-this._delay;if(!(0>n)){if(n>=this._duration)return this.complete();for(var r=n>0?this._ease(n,0,1,this._duration):0,a=this._props,s=0,o=a.length;o>s;s++){var h=a[s];i[h[0]]=h[1]+r*h[2]}this.update&&this.update.run()}}},e.complete=function(){if(this._target){Laya.timer.runTimer(this,this.firstStart);for(var t=this._target,e=this._props,i=this._complete,n=0,r=e.length;r>n;n++){var a=e[n];t[a[0]]=a[1]+a[2]}this.update&&this.update.run(),this.clear(),i&&i.run()}},e.pause=function(){Laya.timer.clear(this,this._beginLoop),Laya.timer.clear(this,this._doEase)},e.setStartTime=function(t){this._startTimer=t},e.clear=function(){this._target&&(this._remove(),this._clear())},e._clear=function(){this.pause(),Laya.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._usedPool&&(this.update=null,Pool.recover("tween",this))},e.recover=function(){this._usedPool=!0,this._clear()},e._remove=function(){var e=t.tweenMap[this._target.$_GID];if(e)for(var i=0,n=e.length;n>i;i++)if(e[i]===this){e.splice(i,1);break}},e.restart=function(){this.pause(),this._usedTimer=0,this._startTimer=Browser.now();for(var t=this._props,e=0,i=t.length;i>e;e++){var n=t[e];this._target[n[0]]=n[1]}Laya.timer.once(this._delay,this,this._beginLoop)},e.resume=function(){this._usedTimer>=this._duration||(this._startTimer=Browser.now()-this._usedTimer-this._delay,this._beginLoop())},__getset(0,e,"progress",null,function(t){var e=t*this._duration;this._startTimer=Browser.now()-this._delay-e}),t.to=function(e,i,n,r,a,s,o,h){return void 0===s&&(s=0),void 0===o&&(o=!1),void 0===h&&(h=!0),Pool.getItemByClass("tween",t)._create(e,i,n,r,a,s,o,!0,h,!0)},t.from=function(e,i,n,r,a,s,o,h){return void 0===s&&(s=0),void 0===o&&(o=!1),void 0===h&&(h=!0),Pool.getItemByClass("tween",t)._create(e,i,n,r,a,s,o,!1,h,!0)},t.clearAll=function(e){if(e&&e.$_GID){var i=t.tweenMap[e.$_GID];if(i){for(var n=0,r=i.length;r>n;n++)i[n]._clear();i.length=0}}},t.clear=function(t){t.clear()},t.clearTween=function(e){t.clearAll(e)},t.easeNone=function(t,e,i,n){return i*t/n+e},t.tweenMap={},t}(),Utils=function(){function t(){}return __class(t,"laya.utils.Utils"),t.toRadian=function(e){return e*t._pi2},t.toAngle=function(e){return e*t._pi},t.toHexColor=function(t){if(0>t||isNaN(t))return null;for(var e=t.toString(16);e.length<6;)e="0"+e;return"#"+e},t.getGID=function(){return t._gid++},t.concatArray=function(t,e){if(!e)return t;if(!t)return e;var i=0,n=e.length;for(i=0;n>i;i++)t.push(e[i]);return t},t.clearArray=function(t){return t?(t.length=0,t):t},t.copyArray=function(t,e){if(t||(t=[]),!e)return t;t.length=e.length;var i=0,n=e.length;for(i=0;n>i;i++)t[i]=e[i];return t},t.getGlobalRecByPoints=function(t,e,i,n,r){var a;a=new Point(e,i),a=t.localToGlobal(a);var s;return s=new Point(n,r),s=t.localToGlobal(s),Rectangle._getWrapRec([a.x,a.y,s.x,s.y])},t.getGlobalPosAndScale=function(e){return t.getGlobalRecByPoints(e,0,0,1,1)},t.bind=function(t,e){var i=t;return i=t.bind(e)},t.measureText=function(t,e){return RunDriver.measureText(t,e)},t.updateOrder=function(t){if(!t||t.length<2)return!1;for(var e,i=1,n=0,r=t.length,a=NaN;r>i;){for(n=i,e=t[n],a=t[n]._zOrder;--n>-1&&t[n]._zOrder>a;)t[n+1]=t[n];t[n+1]=e,i++}var s=e.parent.conchModel;if(s)if(null!=s.updateZOrder)s.updateZOrder();else{for(i=0;r>i;i++)s.removeChild(t[i].conchModel);for(i=0;r>i;i++)s.addChildAt(t[i].conchModel,i)}return!0},t.transPointList=function(t,e,i){var n=0,r=t.length;for(n=0;r>n;n+=2)t[n]+=e,t[n+1]+=i},t.parseInt=function(t,e){void 0===e&&(e=0);var i=Browser.window.parseInt(t,e);return isNaN(i)?0:i},t.getFileExtension=function(e){t._extReg.lastIndex=e.lastIndexOf(".");var i=t._extReg.exec(e);return i&&i.length>1?i[1].toLowerCase():null},t.getTransformRelativeToWindow=function(t,e,i){var n=Laya.stage,r=laya.utils.Utils.getGlobalPosAndScale(t),a=n._canvasTransform.clone(),s=a.tx,o=a.ty;a.rotate(-Math.PI/180*Laya.stage.canvasDegree),a.scale(Laya.stage.clientScaleX,Laya.stage.clientScaleY);var h=Laya.stage.canvasDegree%180!=0,l=NaN,u=NaN;h?(l=i+r.y,u=e+r.x,l*=a.d,u*=a.a,90==Laya.stage.canvasDegree?(l=s-l,u+=o):(l+=s,u=o-u)):(l=e+r.x,u=i+r.y,l*=a.a,u*=a.d,l+=s,u+=o),u+=Laya.stage._safariOffsetY;var c=NaN,_=NaN;return h?(c=a.d*r.height,_=a.a*r.width):(c=a.a*r.width,_=a.d*r.height),{x:l,y:u,scaleX:c,scaleY:_}},t.fitDOMElementInArea=function(e,i,n,r,a,s){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,e.style.transformOrigin=e.style.webKittransformOrigin="left top",e.style.position="absolute");var o=t.getTransformRelativeToWindow(i,n,r);e.style.transform=e.style.webkitTransform="scale("+o.scaleX+","+o.scaleY+") rotate("+Laya.stage.canvasDegree+"deg)",e.style.width=a+"px",e.style.height=s+"px",e.style.left=o.x+"px",e.style.top=o.y+"px"},t._gid=1,t._pi=180/Math.PI,t._pi2=Math.PI/180,t._extReg=/\.(\w+)\??/g,t.parseXMLFromString=function(t){var e;if(t=t.replace(/>\s+</g,"><"),e=(new DOMParser).parseFromString(t,"text/xml"),e.firstChild.textContent.indexOf("This page contains the following errors")>-1)throw new Error(e.firstChild.firstChild.textContent);return e},t}(),VectorGraphManager=function(){function t(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],Render.isWebGL&&CacheManger.regCacheByFunction(Utils.bind(this.startDispose,this),Utils.bind(this.getCacheList,this))}__class(t,"laya.utils.VectorGraphManager");var e=t.prototype;return e.getId=function(){return this._id++},e.addShape=function(t,e){this.shapeDic[t]=e,this.useDic[t]||(this.useDic[t]=!0)},e.addLine=function(t,e){this.shapeLineDic[t]=e,this.shapeLineDic[t]||(this.shapeLineDic[t]=!0)},e.getShape=function(t){this._checkKey&&null!=this.useDic[t]&&(this.useDic[t]=!0)},e.deleteShape=function(t){this.shapeDic[t]&&(this.shapeDic[t]=null,delete this.shapeDic[t]),this.shapeLineDic[t]&&(this.shapeLineDic[t]=null,delete this.shapeLineDic[t]),null!=this.useDic[t]&&delete this.useDic[t]},e.getCacheList=function(){var t,e=[];for(t in this.shapeDic)e.push(this.shapeDic[t]);for(t in this.shapeLineDic)e.push(this.shapeLineDic[t]);return e},e.startDispose=function(t){var e;for(e in this.useDic)this.useDic[e]=!1;this._checkKey=!0},e.endDispose=function(){if(this._checkKey){var t;for(t in this.useDic)this.useDic[t]||this.deleteShape(t);this._checkKey=!1}},t.getInstance=function(){return t.instance=t.instance||new t},t.instance=null,t}(),WordText=function(){function t(){this.id=NaN,this.save=[],this.toUpperCase=null,this.changed=!1,this._text=null}__class(t,"laya.utils.WordText");var e=t.prototype;return e.setText=function(t){this.changed=!0,this._text=t},e.toString=function(){return this._text},e.charCodeAt=function(t){return this._text?this._text.charCodeAt(t):NaN},e.charAt=function(t){return this._text?this._text.charAt(t):null},__getset(0,e,"length",function(){return this._text?this._text.length:0}),t}(),Node=function(t){function e(){this._bits=0,this._displayedInStage=!1,this._parent=null,this.conchModel=null,this.name="",this.destroyed=!1,e.__super.call(this),this._childs=e.ARRAY_EMPTY,this._$P=e.PROP_EMPTY,this.timer=Laya.timer,this.conchModel=Render.isConchNode?this.createConchModel():null}__class(e,"laya.display.Node",t);var i=e.prototype;return i._setBit=function(t,e){if(1==t){var i=this._getBit(t);i!=e&&this._updateDisplayedInstage()}e?this._bits|=t:this._bits&=~t},i._getBit=function(t){return 0!=(this._bits&t)},i._setUpNoticeChain=function(){this._getBit(1)&&this._setUpNoticeType(1)},i._setUpNoticeType=function(t){var e=this;for(e._setBit(t,!0),e=e.parent;e;){if(e._getBit(t))return;e._setBit(t,!0),e=e.parent}},i.on=function(t,e,i,n){return("display"===t||"undisplay"===t)&&(this._getBit(1)||this._setUpNoticeType(1)),this._createListener(t,e,i,n,!1)},i.once=function(t,e,i,n){return("display"===t||"undisplay"===t)&&(this._getBit(1)||this._setUpNoticeType(1)),this._createListener(t,e,i,n,!0)},i.createConchModel=function(){return null},i.destroy=function(t){void 0===t&&(t=!0),this.destroyed=!0,this._parent&&this._parent.removeChild(this),this._childs&&(t?this.destroyChildren():this.removeChildren()),this._childs=null,this._$P=null,this.offAll(),this.timer.clearAll(this)},i.destroyChildren=function(){if(this._childs)for(var t=this._childs.length-1;t>-1;t--)this._childs[t].destroy(!0)},i.addChild=function(t){if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),t._parent===this){var i=this.getChildIndex(t);i!==this._childs.length-1&&(this._childs.splice(i,1),this._childs.push(t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,this._childs.length-1)),this._childChanged())}else t.parent&&t.parent.removeChild(t),this._childs===e.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,this._childs.length-1),t.parent=this,this._childChanged();return t},i.addChildren=function(t){for(var e=arguments,i=0,n=e.length;n>i;)this.addChild(e[i++])},i.addChildAt=function(t,i){if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),i>=0&&i<=this._childs.length){if(t._parent===this){var n=this.getChildIndex(t);this._childs.splice(n,1),this._childs.splice(i,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,i)),this._childChanged()}else t.parent&&t.parent.removeChild(t),this._childs===e.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(i,0,t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,i),t.parent=this;return t}throw new Error("appendChildAt:The index is out of bounds")},i.getChildIndex=function(t){return this._childs.indexOf(t)},i.getChildByName=function(t){var e=this._childs;if(e)for(var i=0,n=e.length;n>i;i++){var r=e[i];if(r.name===t)return r}return null},i._get$P=function(t){return this._$P[t]},i._set$P=function(t,i){return this.destroyed||(this._$P===e.PROP_EMPTY&&(this._$P={}),this._$P[t]=i),i},i.getChildAt=function(t){return this._childs[t]},i.setChildIndex=function(t,e){var i=this._childs;if(0>e||e>=i.length)throw new Error("setChildIndex:The index is out of bounds.");var n=this.getChildIndex(t);if(0>n)throw new Error("setChildIndex:node is must child of this object.");return i.splice(n,1),i.splice(e,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,e)),this._childChanged(),t},i._childChanged=function(t){},i.removeChild=function(t){if(!this._childs)return t;var e=this._childs.indexOf(t);return this.removeChildAt(e)},i.removeSelf=function(){return this._parent&&this._parent.removeChild(this),this},i.removeChildByName=function(t){var e=this.getChildByName(t);return e&&this.removeChild(e),e},i.removeChildAt=function(t){var e=this.getChildAt(t);return e&&(this._childs.splice(t,1),this.conchModel&&this.conchModel.removeChild(e.conchModel),e.parent=null),e},i.removeChildren=function(t,i){if(void 0===t&&(t=0),void 0===i&&(i=2147483647),this._childs&&this._childs.length>0){var n=this._childs;if(0===t&&i>=s){var r=n;this._childs=e.ARRAY_EMPTY}else r=n.splice(t,i-t);for(var a=0,s=r.length;s>a;a++)r[a].parent=null,this.conchModel&&this.conchModel.removeChild(r[a].conchModel)}return this},i.replaceChild=function(t,e){var i=this._childs.indexOf(e);return i>-1?(this._childs.splice(i,1,t),this.conchModel&&(this.conchModel.removeChild(e.conchModel),this.conchModel.addChildAt(t.conchModel,i)),e.parent=null,t.parent=this,t):null},i._updateDisplayedInstage=function(){var t;t=this;var e=Laya.stage;for(this._displayedInStage=!1;t;){if(t._getBit(1)){this._displayedInStage=t._displayedInStage;break}if(t==e||t._displayedInStage){this._displayedInStage=!0;break}t=t.parent}},i._setDisplay=function(t){this._displayedInStage!==t&&(this._displayedInStage=t,t?this.event("display"):this.event("undisplay"))},i._displayChild=function(t,e){var i=t._childs;if(i)for(var n=0,r=i.length;r>n;n++){var a=i[n];a._getBit(1)&&(a._childs.length>0?this._displayChild(a,e):a._setDisplay(e))}t._setDisplay(e)},i.contains=function(t){if(t===this)return!0;for(;t;){if(t.parent===this)return!0;t=t.parent}return!1},i.timerLoop=function(t,e,i,n,r,a){void 0===r&&(r=!0),void 0===a&&(a=!1),this.timer.loop(t,e,i,n,r,a)},i.timerOnce=function(t,e,i,n,r){void 0===r&&(r=!0),this.timer._create(!1,!1,t,e,i,n,r)},i.frameLoop=function(t,e,i,n,r){void 0===r&&(r=!0),this.timer._create(!0,!0,t,e,i,n,r)},i.frameOnce=function(t,e,i,n,r){void 0===r&&(r=!0),this.timer._create(!0,!1,t,e,i,n,r)},i.clearTimer=function(t,e){this.timer.clear(t,e)},__getset(0,i,"numChildren",function(){return this._childs.length}),__getset(0,i,"parent",function(){return this._parent},function(t){this._parent!==t&&(t?(this._parent=t,this.event("added"),this._getBit(1)&&(this._setUpNoticeChain(),t.displayedInStage&&this._displayChild(this,!0)),t._childChanged(this)):(this.event("removed"),this._parent._childChanged(),this._getBit(1)&&this._displayChild(this,!1),this._parent=t))}),__getset(0,i,"displayedInStage",function(){return this._getBit(1)?this._displayedInStage:(this._setUpNoticeType(1),this._displayedInStage)}),e.ARRAY_EMPTY=[],e.PROP_EMPTY={},e.NOTICE_DISPLAY=1,e.MOUSEENABLE=2,e}(EventDispatcher),CSSStyle=function(t){function e(t){this._bgground=null,this._border=null,this._rect=null,this.lineHeight=0,e.__super.call(this),this._padding=e._PADDING,this._spacing=e._SPACING,this._aligns=e._ALIGNS,this._font=Font.EMPTY,this._ower=t}__class(e,"laya.display.css.CSSStyle",t);var i=e.prototype;return i.destroy=function(){this._ower=null,this._font=null,this._rect=null},i.inherit=function(t){this._font=t._font,this._spacing=t._spacing===e._SPACING?e._SPACING:t._spacing.slice(),this.lineHeight=t.lineHeight},i._widthAuto=function(){return 0!==(262144&this._type)},i.widthed=function(t){return 0!=(8&this._type)},i._calculation=function(t,e){function i(t,e,i){return t*i[0]+e*i[1]+i[2]}function n(t){var e=a.width,n=r.width;s.width&&(r.width=i(e,n,s.width)),s.height&&(r.height=i(e,n,s.height)),s.left&&(r.x=i(e,n,s.left)),s.top&&(r.y=i(e,n,s.top))}if(e.indexOf("%")<0)return!1;var r=this._ower,a=r.parent,s=this._rect;null===s&&(a._getCSSStyle()._type|=524288,a.on("resize",this,n),this._rect=s={input:{}});var o=e.split(" ");return o[0]=parseFloat(o[0])/100,1==o.length?o[1]=o[2]=0:(o[1]=parseFloat(o[1])/100,o[2]=parseFloat(o[2])),s[t]=o,s.input[t]=e,n(t),!0},i.heighted=function(t){return 0!=(8192&this._type)},i.size=function(t,e){var i=this._ower,n=!1;-1!==t&&t!=this._ower.width&&(this._type|=8,this._ower.width=t,n=!0),-1!==e&&e!=this._ower.height&&(this._type|=8192,this._ower.height=e,n=!0),n&&(i._layoutLater(),524288&this._type&&i.event("resize",this))},i._getAlign=function(){return this._aligns[0]},i._getValign=function(){return this._aligns[1]},i._getCssFloat=function(){return 0!=(32768&this._type)?32768:0},i._createFont=function(){return 4096&this._type?this._font:(this._type|=4096,this._font=new Font(this._font))},i.render=function(t,e,i,n){var r=t.width,a=t.height;i-=t.pivotX,n-=t.pivotY,this._bgground&&null!=this._bgground.color&&e.ctx.fillRect(i,n,r,a,this._bgground.color),this._border&&this._border.color&&e.drawRect(i,n,r,a,this._border.color.strColor,this._border.size)},i.getCSSStyle=function(){return this},i.cssText=function(t){this.attrs(e.parseOneCSS(t,";"))},i.attrs=function(t){if(t)for(var e=0,i=t.length;i>e;e++){var n=t[e];this[n[0]]=n[1]}},i.setTransform=function(t){"none"===t?this._tf=Style._TF_EMPTY:this.attrs(e.parseOneCSS(t,","))},i.translate=function(t,e){this._tf===Style._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.translateX=t,this._tf.translateY=e},i.scale=function(t,e){this._tf===Style._TF_EMPTY&&(this._tf=new TransformInfo),this._tf.scaleX=t,this._tf.scaleY=e},i._enableLayout=function(){return 0===(2&this._type)&&0===(4&this._type)},__getset(0,i,"block",t.prototype._$get_block,function(t){t?this._type|=1:this._type&=-2}),__getset(0,i,"valign",function(){return e._valigndef[this._aligns[1]]},function(t){this._aligns===e._ALIGNS&&(this._aligns=[0,0,0]),this._aligns[1]=e._valigndef[t]}),__getset(0,i,"height",null,function(t){if(this._type|=8192,"string"==typeof t){if(this._calculation("height",t))return;t=parseInt(t)}this.size(-1,t)}),__getset(0,i,"width",null,function(t){if(this._type|=8,"string"==typeof t){var e=t.indexOf("auto");if(e>=0&&(this._type|=262144,t=t.substr(0,e)),this._calculation("width",t))return;t=parseInt(t)}this.size(t,-1)}),__getset(0,i,"fontWeight",function(){return this._font.weight},function(t){this._createFont().weight=t}),__getset(0,i,"left",null,function(t){var e=this._ower;if("string"==typeof t){if("center"===t?t="50% -50% 0":"right"===t&&(t="100% -100% 0"),this._calculation("left",t))return;t=parseInt(t)}e.x=t}),__getset(0,i,"_translate",null,function(t){this.translate(t[0],t[1])}),__getset(0,i,"absolute",function(){return 0!==(4&this._type)}),__getset(0,i,"top",null,function(t){var e=this._ower;if("string"==typeof t){if("middle"===t?t="50% -50% 0":"bottom"===t&&(t="100% -100% 0"),this._calculation("top",t))return;t=parseInt(t)}e.y=t}),__getset(0,i,"align",function(){return e._aligndef[this._aligns[0]]},function(t){this._aligns===e._ALIGNS&&(this._aligns=[0,0,0]),this._aligns[0]=e._aligndef[t]}),__getset(0,i,"bold",function(){return this._font.bold},function(t){this._createFont().bold=t}),__getset(0,i,"padding",function(){return this._padding},function(t){this._padding=t}),__getset(0,i,"leading",function(){return this._spacing[1]},function(t){"string"==typeof t&&(t=parseInt(t+"")),this._spacing===e._SPACING&&(this._spacing=[0,0]),this._spacing[1]=t}),__getset(0,i,"lineElement",function(){return 0!=(65536&this._type)},function(t){t?this._type|=65536:this._type&=-65537}),__getset(0,i,"cssFloat",function(){return 0!=(32768&this._type)?"right":"left"},function(t){this.lineElement=!1,"right"===t?this._type|=32768:this._type&=-32769}),__getset(0,i,"textDecoration",function(){return this._font.decoration},function(t){this._createFont().decoration=t}),__getset(0,i,"whiteSpace",function(){return 131072&this._type?"nowrap":""},function(t){"nowrap"===t&&(this._type|=131072),"none"===t&&(this._type&=-131073)}),__getset(0,i,"background",null,function(t){return t?(this._bgground||(this._bgground={}),this._bgground.color=t,this._ower.conchModel&&this._ower.conchModel.bgColor(t),this._type|=16384,void(this._ower._renderType|=256)):void(this._bgground=null)}),__getset(0,i,"wordWrap",function(){return 0===(131072&this._type)},function(t){t?this._type&=-131073:this._type|=131072}),__getset(0,i,"color",function(){return this._font.color},function(t){this._createFont().color=t}),__getset(0,i,"password",function(){return this._font.password},function(t){this._createFont().password=t}),__getset(0,i,"backgroundColor",function(){return this._bgground?this._bgground.color:null},function(t){"none"===t?this._bgground=null:(this._bgground||(this._bgground={}),this._bgground.color=t),this._ower.conchModel&&this._ower.conchModel.bgColor(t),this._ower._renderType|=256}),__getset(0,i,"font",function(){return this._font.toString()},function(t){this._createFont().set(t)}),__getset(0,i,"weight",null,function(t){this._createFont().weight=t}),__getset(0,i,"letterSpacing",function(){return this._spacing[0]},function(t){"string"==typeof t&&(t=parseInt(t+"")),this._spacing===e._SPACING&&(this._spacing=[0,0]),this._spacing[0]=t}),__getset(0,i,"fontSize",function(){return this._font.size},function(t){this._createFont().size=t}),__getset(0,i,"italic",function(){return this._font.italic},function(t){this._createFont().italic=t}),__getset(0,i,"fontFamily",function(){return this._font.family},function(t){this._createFont().family=t}),__getset(0,i,"stroke",function(){return this._font.stroke[0]},function(t){this._createFont().stroke===Font._STROKE&&(this._font.stroke=[0,"#000000"]),this._font.stroke[0]=t}),__getset(0,i,"strokeColor",function(){return this._font.stroke[1]},function(t){this._createFont().stroke===Font._STROKE&&(this._font.stroke=[0,"#000000"]),this._font.stroke[1]=t}),__getset(0,i,"border",function(){return this._border?this._border.value:""},function(t){if("none"==t)return void(this._border=null);this._border||(this._border={}),this._border.value=t;var e=t.split(" ");if(this._border.color=Color.create(e[e.length-1]),1==e.length)return this._border.size=1,void(this._border.type="solid");var i=0;e[0].indexOf("px")>0?(this._border.size=parseInt(e[0]),i++):this._border.size=1,this._border.type=e[i],this._ower._renderType|=256}),__getset(0,i,"borderColor",function(){return this._border&&this._border.color?this._border.color.strColor:null},function(t){return t?(this._border||(this._border={size:1,type:"solid"}),this._border.color=null==t?null:Color.create(t),this._ower.conchModel&&this._ower.conchModel.border(this._border.color.strColor),void(this._ower._renderType|=256)):void(this._border=null)}),__getset(0,i,"position",function(){return 4&this._type?"absolute":""},function(t){"absolute"==t?this._type|=4:this._type&=-5}),__getset(0,i,"display",null,function(t){switch(t){case"":this._type&=-3,this.visible=!0;break;case"none":this._type|=2,this.visible=!1,this._ower._layoutLater()}}),__getset(0,i,"paddingLeft",function(){return this.padding[3]}),__getset(0,i,"paddingTop",function(){return this.padding[0]}),__getset(0,i,"_scale",null,function(t){this._ower.scale(t[0],t[1])}),__getset(0,i,"_rotate",null,function(t){this._ower.rotation=t}),e.parseOneCSS=function(t,i){for(var n,r=[],a=t.split(i),s=0,o=a.length;o>s;s++){var h=a[s],l=h.indexOf(":"),u=h.substr(0,l).replace(/^\s+|\s+$/g,"");if(0!=u.length){var c=h.substr(l+1).replace(/^\s+|\s+$/g,""),_=[u,c];switch(u){case"italic":case"bold":_[1]="true"==c;break;case"line-height":_[0]="lineHeight",_[1]=parseInt(c);break;case"font-size":_[0]="fontSize",_[1]=parseInt(c);break;case"padding":n=c.split(" "),n.length>1||(n[1]=n[2]=n[3]=n[0]),_[1]=[parseInt(n[0]),parseInt(n[1]),parseInt(n[2]),parseInt(n[3])];break;case"rotate":_[0]="_rotate",_[1]=parseFloat(c);break;case"scale":n=c.split(" "),_[0]="_scale",_[1]=[parseFloat(n[0]),parseFloat(n[1])];break;case"translate":n=c.split(" "),_[0]="_translate",_[1]=[parseInt(n[0]),parseInt(n[1])];break;default:(_[0]=e._CSSTOVALUE[u])||(_[0]=u)}r.push(_)}}return r},e.parseCSS=function(t,i){for(var n;null!=(n=e._parseCSSRegExp.exec(t));)e.styleSheets[n[1]]=e.parseOneCSS(n[2],";")},e.EMPTY=new e(null),e._CSSTOVALUE={"letter-spacing":"letterSpacing","line-spacing":"lineSpacing","white-space":"whiteSpace","line-height":"lineHeight","scale-x":"scaleX","scale-y":"scaleY","translate-x":"translateX","translate-y":"translateY","font-family":"fontFamily","font-weight":"fontWeight","vertical-align":"valign","text-decoration":"textDecoration","background-color":"backgroundColor","border-color":"borderColor","float":"cssFloat"},e._parseCSSRegExp=new RegExp("([.#]\\w+)\\s*{([\\s\\S]*?)}","g"),e._aligndef={left:0,center:1,right:2,0:"left",1:"center",2:"right"},e._valigndef={top:0,middle:1,bottom:2,0:"top",1:"middle",2:"bottom"},e.styleSheets={},e.ALIGN_CENTER=1,e.ALIGN_RIGHT=2,e.VALIGN_MIDDLE=1,e.VALIGN_BOTTOM=2,e._CSS_BLOCK=1,e._DISPLAY_NONE=2,e._ABSOLUTE=4,e._WIDTH_SET=8,e._PADDING=[0,0,0,0],e._RECT=[-1,-1,-1,-1],e._SPACING=[0,0],e._ALIGNS=[0,0,0],e.ADDLAYOUTED=512,e._NEWFONT=4096,e._HEIGHT_SET=8192,e._BACKGROUND_SET=16384,e._FLOAT_RIGHT=32768,e._LINE_ELEMENT=65536,e._NOWARP=131072,e._WIDTHAUTO=262144,e._LISTERRESZIE=524288,e}(Style),AudioSound=function(t){function e(){this.url=null,this.audio=null,this.loaded=!1,e.__super.call(this)}__class(e,"laya.media.h5audio.AudioSound",t);var i=e.prototype;return i.dispose=function(){var t=e._audioCache[this.url];t&&(t.src="",delete e._audioCache[this.url])},i.load=function(t){function i(){r(),s.loaded=!0,s.event("complete")}function n(){a.load=null,r(),s.event("error")}function r(){a.removeEventListener("canplaythrough",i),a.removeEventListener("error",n)}t=URL.formatURL(t),this.url=t;var a;if(t==SoundManager._tMusic?(e._initMusicAudio(),a=e._musicAudio,a.src!=t&&(e._audioCache[a.src]=null,a=null)):a=e._audioCache[t],a&&a.readyState>=2)return void this.event("complete");a||(t==SoundManager._tMusic?(e._initMusicAudio(),a=e._musicAudio):a=Browser.createElement("audio"),
e._audioCache[t]=a,a.src=t),a.addEventListener("canplaythrough",i),a.addEventListener("error",n);var s=this;this.audio=a,a.load?a.load():n()},i.play=function(t,i){if(void 0===t&&(t=0),void 0===i&&(i=0),!this.url)return null;var n;if(n=this.url==SoundManager._tMusic?e._musicAudio:e._audioCache[this.url],!n)return null;var r;r=Pool.getItem("audio:"+this.url),Render.isConchApp?r||(r=Browser.createElement("audio"),r.src=n.src):this.url==SoundManager._tMusic?(e._initMusicAudio(),r=e._musicAudio,r.src=this.url):r=r?r:n.cloneNode(!0);var a=new AudioSoundChannel(r);return a.url=this.url,a.loops=i,a.startTime=t,a.play(),SoundManager.addChannel(a),a},__getset(0,i,"duration",function(){var t;return t=e._audioCache[this.url],t?t.duration:0}),e._initMusicAudio=function(){e._musicAudio||(e._musicAudio||(e._musicAudio=Browser.createElement("audio")),Browser.document.addEventListener("touchstart",e._makeMusicOK))},e._makeMusicOK=function(){Browser.document.removeEventListener("touchstart",e._makeMusicOK),e._musicAudio.src?e._musicAudio.play():(e._musicAudio.src="",e._musicAudio.load())},e._audioCache={},e._musicAudio=null,e}(EventDispatcher),SoundChannel=function(t){function e(){this.url=null,this.loops=0,this.startTime=NaN,this.isStopped=!1,this.completeHandler=null,e.__super.call(this)}__class(e,"laya.media.SoundChannel",t);var i=e.prototype;return i.play=function(){},i.stop=function(){},i.pause=function(){},i.resume=function(){},i.__runComplete=function(t){t&&t.run()},__getset(0,i,"volume",function(){return 1},function(t){}),__getset(0,i,"position",function(){return 0}),__getset(0,i,"duration",function(){return 0}),e}(EventDispatcher),Sound=function(t){function e(){e.__super.call(this)}__class(e,"laya.media.Sound",t);var i=e.prototype;return i.load=function(t){},i.play=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=0),null},i.dispose=function(){},__getset(0,i,"duration",function(){return 0}),e}(EventDispatcher),WebAudioSound=function(t){function e(){this.url=null,this.loaded=!1,this.data=null,this.audioBuffer=null,this.__toPlays=null,e.__super.call(this)}__class(e,"laya.media.webaudio.WebAudioSound",t);var i=e.prototype;return i.load=function(t){var i=this;if(t=URL.formatURL(t),this.url=t,this.audioBuffer=e._dataCache[t],this.audioBuffer)return void this._loaded(this.audioBuffer);if(e.e.on("loaded:"+t,this,this._loaded),e.e.on("err:"+t,this,this._err),!e.__loadingSound[t]){e.__loadingSound[t]=!0;var n=new Browser.window.XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){i.data=n.response,e.buffs.push({buffer:i.data,url:i.url}),e.decode()},n.onerror=function(t){i._err()},n.send()}},i._err=function(){this._removeLoadEvents(),e.__loadingSound[this.url]=!1,this.event("error")},i._loaded=function(t){this._removeLoadEvents(),this.audioBuffer=t,e._dataCache[this.url]=this.audioBuffer,this.loaded=!0,this.event("complete")},i._removeLoadEvents=function(){e.e.off("loaded:"+this.url,this,this._loaded),e.e.off("err:"+this.url,this,this._err)},i.__playAfterLoaded=function(){if(this.__toPlays){var t,e=0,i=0;t=this.__toPlays,i=t.length;var n;for(e=0;i>e;e++)n=t[e],n[2]&&!n[2].isStopped&&this.play(n[0],n[1],n[2]);this.__toPlays.length=0}},i.play=function(t,e,i){return void 0===t&&(t=0),void 0===e&&(e=0),i=i?i:new WebAudioSoundChannel,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([t,e,i]),this.once("complete",this,this.__playAfterLoaded),this.load(this.url)),i.url=this.url,i.loops=e,i.audioBuffer=this.audioBuffer,i.startTime=t,i.play(),SoundManager.addChannel(i),i},i.dispose=function(){delete e._dataCache[this.url],delete e.__loadingSound[this.url]},__getset(0,i,"duration",function(){return this.audioBuffer?this.audioBuffer.duration:0}),e.decode=function(){e.buffs.length<=0||e.isDecoding||(e.isDecoding=!0,e.tInfo=e.buffs.shift(),e.ctx.decodeAudioData(e.tInfo.buffer,e._done,e._fail))},e._done=function(t){e.e.event("loaded:"+e.tInfo.url,t),e.isDecoding=!1,e.decode()},e._fail=function(){e.e.event("err:"+e.tInfo.url,null),e.isDecoding=!1,e.decode()},e._playEmptySound=function(){if(null!=e.ctx){var t=e.ctx.createBufferSource();t.buffer=e._miniBuffer,t.connect(e.ctx.destination),t.start(0,0,0)}},e._unlock=function(){e._unlocked||(e._playEmptySound(),"running"==e.ctx.state&&(Browser.document.removeEventListener("mousedown",e._unlock,!0),Browser.document.removeEventListener("touchend",e._unlock,!0),e._unlocked=!0))},e.initWebAudio=function(){"running"!=e.ctx.state&&(e._unlock(),Browser.document.addEventListener("mousedown",e._unlock,!0),Browser.document.addEventListener("touchend",e._unlock,!0))},e._dataCache={},e.buffs=[],e.isDecoding=!1,e._unlocked=!1,e.tInfo=null,e.__loadingSound={},__static(e,["window",function(){return this.window=Browser.window},"webAudioEnabled",function(){return this.webAudioEnabled=e.window.AudioContext||e.window.webkitAudioContext||e.window.mozAudioContext},"ctx",function(){return this.ctx=e.webAudioEnabled?new(e.window.AudioContext||e.window.webkitAudioContext||e.window.mozAudioContext):void 0},"_miniBuffer",function(){return this._miniBuffer=e.ctx.createBuffer(1,1,22050)},"e",function(){return this.e=new EventDispatcher}]),e}(EventDispatcher),HttpRequest=function(t){function e(){this._responseType=null,this._data=null,e.__super.call(this),this._http=new Browser.window.XMLHttpRequest}__class(e,"laya.net.HttpRequest",t);var i=e.prototype;return i.send=function(t,e,i,n,r){void 0===i&&(i="get"),void 0===n&&(n="text"),this._responseType=n,this._data=null;var a=this,s=this._http;if(s.open(i,t,!0),r)for(var o=0;o<r.length;o++)s.setRequestHeader(r[o++],r[o]);else Render.isConchApp||(e&&"string"!=typeof e?s.setRequestHeader("Content-Type","application/json"):s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"));s.responseType="arraybuffer"!==n?"text":"arraybuffer",s.onerror=function(t){a._onError(t)},s.onabort=function(t){a._onAbort(t)},s.onprogress=function(t){a._onProgress(t)},s.onload=function(t){a._onLoad(t)},s.send(e)},i._onProgress=function(t){t&&t.lengthComputable&&this.event("progress",t.loaded/t.total)},i._onAbort=function(t){this.error("Request was aborted by user")},i._onError=function(t){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)},i._onLoad=function(t){var e=this._http,i=void 0!==e.status?e.status:200;200===i||204===i||0===i?this.complete():this.error("["+e.status+"]"+e.statusText+":"+e.responseURL)},i.error=function(t){this.clear(),this.event("error",t)},i.complete=function(){this.clear();var t=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=Utils.parseXMLFromString(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(e){t=!1,this.error(e.message)}t&&this.event("complete",this._data instanceof Array?[this._data]:this._data)},i.clear=function(){var t=this._http;t.onerror=t.onabort=t.onprogress=t.onload=null},__getset(0,i,"url",function(){return this._http.responseURL}),__getset(0,i,"http",function(){return this._http}),__getset(0,i,"data",function(){return this._data}),e}(EventDispatcher),Loader=function(t){function e(){this._data=null,this._url=null,this._type=null,this._cache=!1,this._http=null,this._customParse=!1,e.__super.call(this)}__class(e,"laya.net.Loader",t);var i=e.prototype;return i.load=function(t,i,n,r,a){if(void 0===n&&(n=!0),void 0===a&&(a=!1),this._url=t,0===t.indexOf("data:image")?this._type=i="image":(this._type=i||(i=this.getTypeFromUrl(t)),t=URL.formatURL(t)),this._cache=n,this._data=null,!a&&e.loadedMap[t])return this._data=e.loadedMap[t],this.event("progress",1),void this.event("complete",this._data);if(r&&e.setGroup(t,r),null!=e.parserMap[i])return this._customParse=!0,void(e.parserMap[i]instanceof laya.utils.Handler?e.parserMap[i].runWith(this):e.parserMap[i].call(null,this));if("image"===i||"htmlimage"===i||"nativeimage"===i)return this._loadImage(t);if("sound"===i)return this._loadSound(t);if("atlas"==i&&e.preLoadedAtlasConfigMap[t])return this.onLoaded(e.preLoadedAtlasConfigMap[t]),void delete e.preLoadedAtlasConfigMap[t];this._http||(this._http=new HttpRequest,this._http.on("progress",this,this.onProgress),this._http.on("error",this,this.onError),this._http.on("complete",this,this.onLoaded));var s;switch(i){case"atlas":s="json";break;case"font":s="xml";break;case"pkm":s="arraybuffer";break;default:s=i}this._http.send(t,null,"get",s)},i.getTypeFromUrl=function(t){var i=Utils.getFileExtension(t);return i?e.typeMap[i]:(console.warn("Not recognize the resources suffix",t),"text")},i._loadImage=function(t){function i(){n.onload=null,n.onerror=null,delete e.imgCache[t]}t=URL.formatURL(t);var n,r=this,a=function(){i(),r.onLoaded(n)},s=function(){i(),r.event("error","Load image failed")};"nativeimage"===this._type?(n=new Browser.window.Image,n.crossOrigin="",n.onload=a,n.onerror=s,n.src=t,e.imgCache[t]=n):new HTMLImage.create(t,{onload:a,onerror:s,onCreate:function(i){n=i,e.imgCache[t]=i}})},i._loadSound=function(t){function e(){n(),a.onLoaded(r)}function i(){n(),r.dispose(),a.event("error","Load sound failed")}function n(){r.offAll()}var r=new SoundManager._soundClass,a=this;r.on("complete",this,e),r.on("error",this,i),r.load(t)},i.onProgress=function(t){"atlas"===this._type?this.event("progress",.3*t):this.event("progress",t)},i.onError=function(t){this.event("error",t)},i.onLoaded=function(t){var i=this._type;if("image"===i){var n=new Texture(t);n.url=this._url,this.complete(n)}else if("sound"===i||"htmlimage"===i||"nativeimage"===i)this.complete(t);else if("atlas"===i){if(!t.src&&!t._setContext){if(!this._data){if(this._data=t,t.meta&&t.meta.image)for(var r=t.meta.image.split(","),a=this._url.indexOf("/")>=0?"/":"\\",s=this._url.lastIndexOf(a),o=s>=0?this._url.substr(0,s+1):"",h=0,l=r.length;l>h;h++)r[h]=o+r[h];else r=[this._url.replace(".json",".png")];r.reverse(),t.toLoads=r,t.pics=[]}return this.event("progress",.3+1/r.length*.6),this._loadImage(r.pop())}if(this._data.pics.push(t),this._data.toLoads.length>0)return this.event("progress",.3+1/this._data.toLoads.length*.6),this._loadImage(this._data.toLoads.pop());var u=this._data.frames,c=this._url.split("?")[0],_=this._data.meta&&this._data.meta.prefix?this._data.meta.prefix:c.substring(0,c.lastIndexOf("."))+"/",d=this._data.pics,f=URL.formatURL(this._url),p=e.atlasMap[f]||(e.atlasMap[f]=[]);p.dir=_;for(var m in u){var g=u[m],y=d[g.frame.idx?g.frame.idx:0],x=URL.formatURL(_+m);e.cacheRes(x,Texture.create(y,g.frame.x,g.frame.y,g.frame.w,g.frame.h,g.spriteSourceSize.x,g.spriteSourceSize.y,g.sourceSize.w,g.sourceSize.h)),e.loadedMap[x].url=x,p.push(x)}delete this._data.pics,this.complete(this._data)}else if("font"==i){if(!t.src)return this._data=t,this.event("progress",.5),this._loadImage(this._url.replace(".fnt",".png"));var v=new BitmapFont;v.parseFont(this._data,t);var S=this._url.split(".fnt")[0].split("/"),T=S[S.length-1];Text.registerBitmapFont(T,v),this._data=v,this.complete(this._data)}else if("pkm"==i){var E=HTMLImage.create(t,this._url),w=new Texture(E);w.url=this._url,this.complete(w)}else this.complete(t)},i.complete=function(t){this._data=t,this._customParse?this.event("loaded",t instanceof Array?[t]:t):(e._loaders.push(this),e._isWorking||e.checkNext())},i.endLoad=function(t){t&&(this._data=t),this._cache&&e.cacheRes(this._url,this._data),this._customParse=!1,this.event("progress",1),this.event("complete",this.data instanceof Array?[this.data]:this.data)},__getset(0,i,"url",function(){return this._url}),__getset(0,i,"data",function(){return this._data}),__getset(0,i,"cache",function(){return this._cache}),__getset(0,i,"type",function(){return this._type}),e.checkNext=function(){e._isWorking=!0;for(var t=Browser.now(),i=t;e._startIndex<e._loaders.length;)if(i=Browser.now(),e._loaders[e._startIndex].endLoad(),e._startIndex++,Browser.now()-t>e.maxTimeOut)return console.warn("loader callback cost a long time:"+(Browser.now()-t)+" url="+e._loaders[e._startIndex-1].url),void Laya.timer.frameOnce(1,null,e.checkNext);e._loaders.length=0,e._startIndex=0,e._isWorking=!1},e.clearRes=function(t,i){void 0===i&&(i=!1),t=URL.formatURL(t);var n=e.getAtlas(t);if(n){for(var r=0,a=n.length;a>r;r++){var s=n[r],o=e.getRes(s);o&&o.destroy(i),delete e.loadedMap[s]}n.length=0,delete e.atlasMap[t],delete e.loadedMap[t]}else{var h=e.loadedMap[t];h&&(h instanceof laya.resource.Texture&&h.bitmap&&h.destroy(i),delete e.loadedMap[t])}},e.setAtlasConfigs=function(t,i){e.preLoadedAtlasConfigMap[URL.formatURL(t)]=i},e.getRes=function(t){return e.loadedMap[URL.formatURL(t)]},e.getAtlas=function(t){return e.atlasMap[URL.formatURL(t)]},e.cacheRes=function(t,i){if(t=URL.formatURL(t),null==e.loadedMap[t]){e.loadedMap[t]=i;var n=t.indexOf("?");if(0>n)return;return e.loadedMap[t.substr(0,n)]=i}console.warn("Resources already exist,is repeated loading:",t)},e.setGroup=function(t,i){e.groupMap[i]||(e.groupMap[i]=[]),e.groupMap[i].push(t)},e.clearResByGroup=function(t){if(e.groupMap[t]){var i=e.groupMap[t],n=0,r=i.length;for(n=0;r>n;n++)e.clearRes(i[n]);i.length=0}},e.TEXT="text",e.JSON="json",e.XML="xml",e.BUFFER="arraybuffer",e.IMAGE="image",e.SOUND="sound",e.ATLAS="atlas",e.FONT="font",e.PKM="pkm",e.typeMap={png:"image",jpg:"image",jpeg:"image",txt:"text",json:"json",xml:"xml",als:"atlas",atlas:"atlas",mp3:"sound",ogg:"sound",wav:"sound",part:"json",fnt:"font",pkm:"pkm"},e.parserMap={},e.groupMap={},e.maxTimeOut=100,e.loadedMap={},e.preLoadedAtlasConfigMap={},e.atlasMap={},e._loaders=[],e._isWorking=!1,e._startIndex=0,e.imgCache={},e}(EventDispatcher),LoaderManager=function(t){function e(){this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loaders=[],this._loaderCount=0,this._resInfos=[],this._infoPool=[],this._maxPriority=5,this._failRes={},e.__super.call(this);for(var t=0;t<this._maxPriority;t++)this._resInfos[t]=[]}var i;__class(e,"laya.net.LoaderManager",t);var n=e.prototype;return n.create=function(t,e,i,n,r,a,s){function o(t,i){c++,t.progress=1,c===u&&e&&e.run()}function h(t,e){t.progress=e;for(var i=0,n=0;u>n;n++){var r=l[n];i+=r.progress}var a=i/u;_.runWith(a)}if(void 0===a&&(a=1),void 0===s&&(s=!0),t instanceof Array){var l=t,u=l.length,c=0;if(i)var _=Handler.create(i.caller,i.method,i.args,!1);for(var d=0;u>d;d++){var f=l[d];"string"==typeof f&&(f=l[d]={url:f}),f.progress=0;var p=i?Handler.create(null,h,[f],!1):null,m=i||e?Handler.create(null,o,[f]):null;this._create(f.url,m,p,f.clas||n,f.params||r,f.priority||a,s)}return!0}return this._create(t,e,i,n,r,a,s)},n._create=function(t,i,n,r,a,s,o){function h(e){l&&!l.disposed&&l.onAsynLoaded.call(l,t,e,a),i&&i.run(),Laya.loader.event(t)}void 0===s&&(s=1),void 0===o&&(o=!0),t=URL.formatURL(t);var l=this.getRes(t);if(l)!l.hasOwnProperty("loaded")||l.loaded?(n&&n.runWith(1),i&&i.run()):i&&Laya.loader._createListener(t,i.caller,i.method,i.args,!0,!1);else{var u=Utils.getFileExtension(t),c=e.createMap[u];r||(r=c[0]);var _=c[1];"atlas"==u?this.load(t,i,n,_,s,o):(r===Texture&&(_="htmlimage"),l=r?new r:null,l.hasOwnProperty("_loaded")&&(l._loaded=!1),this.load(t,Handler.create(null,h),n,_,s,!1,null,!0),o&&(this.cacheRes(t,l),l.url=t))}return l},n.load=function(t,n,r,a,s,o,h,l){if(void 0===s&&(s=1),void 0===o&&(o=!0),void 0===l&&(l=!1),t instanceof Array)return this._loadAssets(t,n,r,a,s,o,h);var u=Loader.getRes(t);if(null!=u)r&&r.runWith(1),n&&n.runWith(u),this._loaderCount||this.event("complete");else{var c=e._resMap[t];c?(n&&c._createListener("complete",n.caller,n.method,n.args,!1,!1),r&&c._createListener("progress",r.caller,r.method,r.args,!1,!1)):(c=this._infoPool.length?this._infoPool.pop():new i,c.url=t,c.type=a,c.cache=o,c.group=h,c.ignoreCache=l,n&&c.on("complete",n.caller,n.method,n.args),r&&c.on("progress",r.caller,r.method,r.args),e._resMap[t]=c,s=s<this._maxPriority?s:this._maxPriority-1,this._resInfos[s].push(c),this._next())}return this},n._next=function(){if(!(this._loaderCount>=this.maxLoader)){for(var t=0;t<this._maxPriority;t++){var e=this._resInfos[t];if(e.length>0){var i=e.shift();if(i)return this._doLoad(i)}}this._loaderCount||this.event("complete")}},n._doLoad=function(t){function e(e){i.offAll(),i._data=null,n._loaders.push(i),n._endLoad(t,e instanceof Array?[e]:e),n._loaderCount--,n._next()}this._loaderCount++;var i=this._loaders.length?this._loaders.pop():new Loader;i.on("complete",null,e),i.on("progress",null,function(e){t.event("progress",e)}),i.on("error",null,function(t){e(null)});var n=this;i.load(t.url,t.type,t.cache,t.group,t.ignoreCache)},n._endLoad=function(t,i){var n=t.url;if(null==i){var r=this._failRes[n]||0;if(r<this.retryNum)return console.warn("[warn]Retry to load:",n),this._failRes[n]=r+1,void Laya.timer.once(this.retryDelay,this,this._addReTry,[t],!1);console.warn("[error]Failed to load:",n),this.event("error",n)}this._failRes[n]&&(this._failRes[n]=0),delete e._resMap[n],t.event("complete",i),t.offAll(),this._infoPool.push(t)},n._addReTry=function(t){this._resInfos[this._maxPriority-1].push(t),this._next()},n.clearRes=function(t,e){void 0===e&&(e=!1),Loader.clearRes(t,e)},n.getRes=function(t){return Loader.getRes(t)},n.cacheRes=function(t,e){Loader.cacheRes(t,e)},n.setGroup=function(t,e){Loader.setGroup(t,e)},n.clearResByGroup=function(t){Loader.clearResByGroup(t)},n.clearUnLoaded=function(){for(var t=0;t<this._maxPriority;t++){for(var i=this._resInfos[t],n=i.length-1;n>-1;n--){var r=i[n];r&&(r.offAll(),this._infoPool.push(r))}i.length=0}this._loaderCount=0,e._resMap={}},n.cancelLoadByUrls=function(t){if(t)for(var e=0,i=t.length;i>e;e++)this.cancelLoadByUrl(t[e])},n.cancelLoadByUrl=function(t){for(var i=0;i<this._maxPriority;i++)for(var n=this._resInfos[i],r=n.length-1;r>-1;r--){var a=n[r];a&&a.url===t&&(n[r]=null,a.offAll(),this._infoPool.push(a))}e._resMap[t]&&delete e._resMap[t]},n._loadAssets=function(t,e,i,n,r,a,s){function o(t,i){u++,t.progress=1,i||(d=!1),u===l&&e&&e.runWith(d)}function h(t,e){if(null!=i){t.progress=e;for(var n=0,r=0;r<_.length;r++){var a=_[r];n+=a.size*a.progress}var s=n/c;i.runWith(s)}}void 0===r&&(r=1),void 0===a&&(a=!0);for(var l=t.length,u=0,c=0,_=[],d=!0,f=0;l>f;f++){var p=t[f];"string"==typeof p&&(p={url:p,type:n,size:1,priority:r}),p.size||(p.size=1),p.progress=0,c+=p.size,_.push(p);var m=i?Handler.create(null,h,[p],!1):null,g=e||i?Handler.create(null,o,[p]):null;this.load(p.url,g,m,p.type,p.priority||1,a,p.group||s)}return this},e.cacheRes=function(t,e){Loader.cacheRes(t,e)},e._resMap={},__static(e,["createMap",function(){return this.createMap={atlas:[null,"atlas"]}}]),e.__init$=function(){i=function(t){function e(){this.url=null,this.type=null,this.cache=!1,this.group=null,this.ignoreCache=!1,e.__super.call(this)}return __class(e,"",t),e}(EventDispatcher)},e}(EventDispatcher),ColorFilter=function(t){function e(t){e.__super.call(this),t||(t=[.3,.59,.11,0,0,.3,.59,.11,0,0,.3,.59,.11,0,0,0,0,0,1,0]),this._mat=new Float32Array(16),this._alpha=new Float32Array(4);for(var i=0,n=0,r=0;20>r;r++)r%5!=4?this._mat[i++]=t[r]:this._alpha[n++]=t[r];this._action=RunDriver.createFilterAction(32),this._action.data=this}__class(e,"laya.filters.ColorFilter",t);var i=e.prototype;return Laya.imps(i,{"laya.filters.IFilter":!0}),i.callNative=function(t){t._$P.cf=this;t.conchModel&&t.conchModel.setFilterMatrix&&t.conchModel.setFilterMatrix(this._mat,this._alpha)},__getset(0,i,"type",function(){return 32}),__getset(0,i,"action",function(){return this._action}),e}(Filter),Socket=function(t){function e(t,i,n){this._endian=null,this._stamp=NaN,this._socket=null,this._connected=!1,this._addInputPosition=0,this._input=null,this._output=null,this.timeout=0,this.objectEncoding=0,this.disableInput=!1,this._byteClass=null,this.protocols=[],void 0===i&&(i=0),e.__super.call(this),this._byteClass=n?n:Byte,this.endian="bigEndian",this.timeout=2e4,this._addInputPosition=0,t&&i>0&&65535>i&&this.connect(t,i)}__class(e,"laya.net.Socket",t);var i=e.prototype;return i.connect=function(t,e){var i="ws://"+t+":"+e;this.connectByUrl(i)},i.connectByUrl=function(t){var e=this;null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new Browser.window.WebSocket(t,this.protocols):this._socket=new Browser.window.WebSocket(t),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=function(t){e._onOpen(t)},this._socket.onmessage=function(t){e._onMessage(t)},this._socket.onclose=function(t){e._onClose(t)},this._socket.onerror=function(t){e._onError(t)}},i.cleanSocket=function(){try{this._socket.close()}catch(t){}this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null},i.close=function(){if(null!=this._socket)try{this._socket.close()}catch(t){}},i._onOpen=function(t){this._connected=!0,this.event("open",t)},i._onMessage=function(t){if(t&&t.data){var e=t.data;if(this.disableInput&&e)return void this.event("message",e);this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var i=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,e&&("string"==typeof e?this._input.writeUTFBytes(e):this._input.writeArrayBuffer(e),this._addInputPosition=this._input.pos,this._input.pos=i),this.event("message",e)}},i._onClose=function(t){this._connected=!1,this.event("close",t)},i._onError=function(t){this.event("error",t)},i.send=function(t){this._socket.send(t)},i.flush=function(){if(this._output&&this._output.length>0){var t;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(e){t=e}this._output.endian=this.endian,this._output.clear(),t&&this.event("error",t)}},__getset(0,i,"input",function(){return this._input}),__getset(0,i,"output",function(){return this._output}),__getset(0,i,"connected",function(){return this._connected}),__getset(0,i,"endian",function(){return this._endian},function(t){this._endian=t,null!=this._input&&(this._input.endian=t),null!=this._output&&(this._output.endian=t)}),e.LITTLE_ENDIAN="littleEndian",e.BIG_ENDIAN="bigEndian",e}(EventDispatcher),WorkerLoader=function(t){function e(){this.worker=null,e.__super.call(this);var t=this;this.worker=new Browser.window.Worker(e.workerPath),this.worker.onmessage=function(e){t.workerMessage(e.data)}}__class(e,"laya.net.WorkerLoader",t);var i=e.prototype;return i.workerMessage=function(t){if(t)switch(t.type){case"Image":this.imageLoaded(t);break;case"Msg":this.event("image_msg",t.msg)}},i.imageLoaded=function(t){if(t&&t.buffer&&t.buffer.length<10)return e._enable=!1,this._myTrace("buffer lost when postmessage ,disable workerloader"),this.event(t.url,null),void this.event("image_err",t.url+"\n"+t.msg);if(!t.dataType)return this.event(t.url,null),void this.event("image_err",t.url+"\n"+t.msg);var i,n,r;switch(t.dataType){case"buffer":i=new HTMLCanvas("2D"),n=i.source.getContext("2d"),r=n.createImageData(t.width,t.height),r.data.set(t.buffer),i.size(r.width,r.height),n.putImageData(r,0,0),i.memorySize=0;break;case"imagedata":i=new HTMLCanvas("2D"),n=i.source.getContext("2d"),r=t.imagedata,i.size(r.width,r.height),n.putImageData(r,0,0),r=t.imagedata,i.memorySize=0;break;case"imageBitmap":r=t.imageBitmap,Render.isWebGL||(i.size(r.width,r.height),n.drawImage(r,0,0)),i=r}Render.isWebGL&&(i=new laya.webgl.resource.WebGLImage(i,t.url)),this.event(t.url,i)},i._myTrace=function(t){var e=arguments,i=[],n=0,r=e.length;for(n=0;r>n;n++)i.push(e[n]);this.event("image_msg",i.join(" "))},i.loadImage=function(t){var e;e={},e.type="load",e.url=t,this.worker.postMessage(e)},i._loadImage=function(t){function i(){laya.net.WorkerLoader.I.off(t,n,r)}var n=this;if(!e._enable||t.toLowerCase().indexOf(".png")<0)return void e._preLoadFun.call(n,t);t=URL.formatURL(t);var r=function(r){i(),r?n.onLoaded(r):e._preLoadFun.call(n,t)};laya.net.WorkerLoader.I.on(t,n,r),laya.net.WorkerLoader.I.loadImage(t)},__getset(1,e,"enable",function(){return e._enable},function(t){(!e.disableJSDecode||Browser.window.createImageBitmap)&&(e._enable=t,e._enable&&null==e._preLoadFun&&(e._enable=e.__init__()))}),e.__init__=function(){return null!=e._preLoadFun?!1:Browser.window.Worker?(e._preLoadFun=Loader.prototype._loadImage,Loader.prototype._loadImage=e.prototype._loadImage,e.I||(e.I=new e),!0):!1},e.workerSupported=function(){return Browser.window.Worker?!0:!1},e.IMAGE_LOADED="image_loaded",e.IMAGE_ERR="image_err",e.IMAGE_MSG="image_msg",e.I=null,e._preLoadFun=null,e._enable=!1,e.workerPath="libs/worker.js",e.disableJSDecode=!0,e}(EventDispatcher),Resource=function(t){function e(){e.__super.call(this),this._$1__id=++e._uniqueIDCounter,this.__loaded=!0,this._disposed=!1,e._loadedResources.push(this),this._released=!0,this.lock=!1,this._memorySize=0,this._lastUseFrameCount=-1,ResourceManager.currentResourceManager&&ResourceManager.currentResourceManager.addResource(this)}__class(e,"laya.resource.Resource",t);var i=e.prototype;return Laya.imps(i,{"laya.resource.ICreateResource":!0,"laya.resource.IDispose":!0}),i._endLoaded=function(){this.__loaded=!0,this.event("loaded",this)},i.recreateResource=function(){this.completeCreate()},i.detoryResource=function(){},i.activeResource=function(t){void 0===t&&(t=!1),this._lastUseFrameCount=Stat.loopCount,this._disposed||!this._released&&!t||this.recreateResource()},i.releaseResource=function(t){return void 0===t&&(t=!1),!t&&this.lock?!1:!this._released||t?(this.detoryResource(),this._released=!0,this._lastUseFrameCount=-1,this.event("released",this),!0):!1},i.onAsynLoaded=function(t,e,i){throw new Error("Resource: must override this function!")},i.dispose=function(){if(!this._disposed){null!==this._resourceManager&&this._resourceManager.removeResource(this),this._disposed=!0,this.lock=!1,this.releaseResource();var t=e._loadedResources.indexOf(this);-1!==t&&e._loadedResources.splice(t,1),Loader.clearRes(this._url)}},i.completeCreate=function(){this._released=!1,this.event("recovered",this)},__getset(0,i,"memorySize",function(){return this._memorySize},function(t){var e=t-this._memorySize;this._memorySize=t,this.resourceManager&&this.resourceManager.addSize(e)}),__getset(0,i,"_loaded",null,function(t){this.__loaded=t}),__getset(0,i,"loaded",function(){return this.__loaded}),__getset(0,i,"id",function(){return this._$1__id}),__getset(0,i,"resourceManager",function(){return this._resourceManager}),__getset(0,i,"url",function(){return this._url},function(t){this._url=t}),__getset(0,i,"disposed",function(){return this._disposed}),__getset(0,i,"released",function(){return this._released}),e.getLoadedResourceByIndex=function(t){return e._loadedResources[t]},e.getLoadedResourcesCount=function(){return e._loadedResources.length},e._uniqueIDCounter=0,e._loadedResources=[],e}(EventDispatcher),Texture=function(t){function e(t,i){this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this._w=0,this._h=0,this._uvID=0,this._atlasID=-1,e.__super.call(this),t&&t.useNum++,this.setTo(t,i)}__class(e,"laya.resource.Texture",t);var i=e.prototype;return i.setTo=function(t,i){if(this.bitmap=t,this.uv=i||e.DEF_UV,t){this._w=t.width,this._h=t.height,this.sourceWidth=this.sourceWidth||this._w,this.sourceHeight=this.sourceHeight||this._h,this._loaded=this._w>0;var n=this;if(this._loaded)RunDriver.addToAtlas&&RunDriver.addToAtlas(n);else{var r=t;r instanceof laya.resource.HTMLImage&&r.image&&r.image.addEventListener("load",function(t){RunDriver.addToAtlas&&RunDriver.addToAtlas(n)},!1)}}},i.active=function(){this.bitmap&&this.bitmap.activeResource()},i.destroy=function(t){if(void 0===t&&(t=!1),this.bitmap&&this.bitmap.useNum>0){var e=this.bitmap;t?(this.bitmap=null,e.dispose(),e.useNum=0):(e.useNum--,0==e.useNum&&(this.bitmap=null,e.dispose())),this.url&&this===Laya.loader.getRes(this.url)&&Laya.loader.clearRes(this.url,t),this._loaded=!1}},i.load=function(t){var e=this;this._loaded=!1,t=URL.customFormat(t);var i=this.bitmap||(this.bitmap=HTMLImage.create(t));i&&i.useNum++;var n=this;i.onload=function(){i.onload=null,n._loaded=!0,e.sourceWidth=e._w=i.width,e.sourceHeight=e._h=i.height,n.event("loaded",this),RunDriver.addToAtlas&&RunDriver.addToAtlas(n)}},i.addTextureToAtlas=function(t){RunDriver.addTextureToAtlas(this)},i.getPixels=function(t,e,i,n){if(Render.isWebGL)return RunDriver.getTexturePixels(this,t,e,i,n);Browser.canvas.size(i,n),Browser.canvas.clear(),Browser.context.drawTexture(this,-t,-e,this.width,this.height,0,0);var r=Browser.context.getImageData(0,0,i,n);return r.data},i.onAsynLoaded=function(t,e){e&&e.useNum++,this.setTo(e,this.uv)},__getset(0,i,"source",function(){return this.bitmap?(this.bitmap.activeResource(),this.bitmap.source):null}),__getset(0,i,"loaded",function(){return this._loaded}),__getset(0,i,"released",function(){return this.bitmap?this.bitmap.released:!0}),__getset(0,i,"width",function(){return this._w?this._w:this.uv&&this.uv!==e.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width},function(t){this._w=t,this.sourceWidth||(this.sourceWidth=t)}),__getset(0,i,"repeat",function(){return Render.isWebGL&&this.bitmap?this.bitmap.repeat:!0},function(t){t&&Render.isWebGL&&this.bitmap&&(this.bitmap.repeat=t,t&&(this.bitmap.enableMerageInAtlas=!1))}),__getset(0,i,"height",function(){return this._h?this._h:this.uv&&this.uv!==e.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height},function(t){this._h=t,this.sourceHeight||(this.sourceHeight=t)}),__getset(0,i,"isLinearSampling",function(){return Render.isWebGL?9728!=this.bitmap.minFifter:!0},function(t){!t&&Render.isWebGL&&(t||-1!=this.bitmap.minFifter||-1!=this.bitmap.magFifter||(this.bitmap.minFifter=9728,this.bitmap.magFifter=9728,this.bitmap.enableMerageInAtlas=!1))}),e.moveUV=function(t,e,i){for(var n=0;8>n;n+=2)i[n]+=t,i[n+1]+=e;return i},e.create=function(t,i,n,r,a,s,o,h,l){void 0===s&&(s=0),void 0===o&&(o=0),void 0===h&&(h=0),void 0===l&&(l=0);var u=t instanceof laya.resource.Texture,c=u?t.uv:e.DEF_UV,_=u?t.bitmap:t,d=_ instanceof Laya.AtlasWebGLCanvas;if(d){var f=_._atlaser,p=t._atlasID;if(-1==p)throw new Error("create texture error");_=f._inAtlasTextureBitmapValue[p],c=f._inAtlasTextureOriUVValue[p]}var m=new e(_,null);_.width&&i+r>_.width&&(r=_.width-i),_.height&&n+a>_.height&&(a=_.height-n),m.width=r,m.height=a,m.offsetX=s,m.offsetY=o,m.sourceWidth=h||r,m.sourceHeight=l||a;var g=1/_.width,y=1/_.height;i*=g,n*=y,r*=g,a*=y;var x=m.uv[0],v=m.uv[1],S=m.uv[4],T=m.uv[5],E=S-x,w=T-v,b=e.moveUV(c[0],c[1],[i,n,i+r,n,i+r,n+a,i,n+a]);return m.uv=[x+b[0]*E,v+b[1]*w,S-(1-b[2])*E,v+b[3]*w,S-(1-b[4])*E,T-(1-b[5])*w,x+b[6]*E,T-(1-b[7])*w],d&&m.addTextureToAtlas(),m},e.createFromTexture=function(t,i,n,r,a){var s=Rectangle.TEMP.setTo(i-t.offsetX,n-t.offsetY,r,a),o=s.intersection(e._rect1.setTo(0,0,t.width,t.height),e._rect2);if(!o)return null;var h=e.create(t,o.x,o.y,o.width,o.height,o.x-s.x,o.y-s.y,r,a);return h.bitmap.useNum--,h},e.DEF_UV=[0,0,1,0,1,1,0,1],e.INV_UV=[0,1,1,1,1,0,0,0],e._rect1=new Rectangle,e._rect2=new Rectangle,e}(EventDispatcher),TimeLine=function(t){function e(){this._labelDic=null,this._tweenDic={},this._tweenDataList=[],this._endTweenDataList=null,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0,e.__super.call(this)}var i;__class(e,"laya.utils.TimeLine",t);var n=e.prototype;return n.to=function(t,e,i,n,r){return void 0===r&&(r=0),this._create(t,e,i,n,r,!0)},n.from=function(t,e,i,n,r){return void 0===r&&(r=0),this._create(t,e,i,n,r,!1)},n._create=function(t,e,n,r,a,s){var o=Pool.getItemByClass("tweenData",i);return o.isTo=s,o.type=0,o.target=t,o.duration=n,o.data=e,o.startTime=this._startTime+a,o.endTime=o.startTime+o.duration,o.ease=r,this._startTime=Math.max(o.endTime,this._startTime),
this._tweenDataList.push(o),this._startTimeSort=!0,this._endTimeSort=!0,this},n.addLabel=function(t,e){var n=Pool.getItemByClass("tweenData",i);return n.type=1,n.data=t,n.endTime=n.startTime=this._startTime+e,this._labelDic||(this._labelDic={}),this._labelDic[t]=n,this._tweenDataList.push(n),this},n.removeLabel=function(t){if(this._labelDic&&this._labelDic[t]){var e=this._labelDic[t];if(e){var i=this._tweenDataList.indexOf(e);i>-1&&this._tweenDataList.splice(i,1)}delete this._labelDic[t]}},n.gotoTime=function(t){function e(t,e){return t.endTime>e.endTime?1:t.endTime<e.endTime?-1:0}if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var i,n;for(var r in this._firstTweenDic)if(n=this._firstTweenDic[r])for(var a in n)n.diyTarget.hasOwnProperty(a)&&(n.diyTarget[a]=n[a]);for(r in this._tweenDic)i=this._tweenDic[r],i.clear(),delete this._tweenDic[r];this._index=0,this._gidIndex=0,this._currTime=t,this._lastTime=Browser.now();var s;null==this._endTweenDataList||this._endTimeSort?(this._endTimeSort=!1,this._endTweenDataList=s=this._tweenDataList.concat(),s.sort(e)):s=this._endTweenDataList;for(var o,h=0,l=s.length;l>h;h++)if(o=s[h],0==o.type){if(!(t>=o.endTime))break;this._index=Math.max(this._index,h+1);var u=o.data;if(o.isTo)for(var c in u)o.target[c]=u[c]}for(h=0,l=this._tweenDataList.length;l>h;h++)o=this._tweenDataList[h],0==o.type&&t>=o.startTime&&t<o.endTime&&(this._index=Math.max(this._index,h+1),this._gidIndex++,i=Pool.getItemByClass("tween",Tween),i._create(o.target,o.data,o.duration,o.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,!1,o.isTo,!0,!1),i.setStartTime(this._currTime-(t-o.startTime)),i._updateEase(this._currTime),i.gid=this._gidIndex,this._tweenDic[this._gidIndex]=i)}},n.gotoLabel=function(t){if(null!=this._labelDic){var e=this._labelDic[t];e&&this.gotoTime(e.startTime)}},n.pause=function(){Laya.timer.clear(this,this._update)},n.resume=function(){this.play(this._currTime,this._loopKey)},n.play=function(t,e){function i(t,e){return t.startTime>e.startTime?1:t.startTime<e.startTime?-1:0}if(void 0===t&&(t=0),void 0===e&&(e=!1),this._tweenDataList){if(this._startTimeSort){this._startTimeSort=!1,this._tweenDataList.sort(i);for(var n=0,r=this._tweenDataList.length;r>n;n++){var a=this._tweenDataList[n];if(null!=a&&0==a.type){var s=a.target,o=s.$_GID||(s.$_GID=Utils.getGID()),h=null;null==this._firstTweenDic[o]?(h={},h.diyTarget=s,this._firstTweenDic[o]=h):h=this._firstTweenDic[o];for(var l in a.data)null==h[l]&&(h[l]=s[l])}}}"string"==typeof t?this.gotoLabel(t):this.gotoTime(t),this._loopKey=e,this._lastTime=Browser.now(),Laya.timer.frameLoop(1,this,this._update)}},n._update=function(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var t in this._tweenDic)r=this._tweenDic[t],r.complete();return this._complete(),void this.pause()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var e=Browser.now(),i=e-this._lastTime,n=this._currTime+=i*this.scale;this._lastTime=e;for(t in this._tweenDic)r=this._tweenDic[t],r._updateEase(n);var r;if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var a=this._tweenDataList[this._index];n>=a.startTime&&(this._index++,0==a.type?(this._gidIndex++,r=Pool.getItemByClass("tween",Tween),r._create(a.target,a.data,a.duration,a.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,!1,a.isTo,!0,!1),r.setStartTime(n),r.gid=this._gidIndex,this._tweenDic[this._gidIndex]=r,r._updateEase(n)):this.event("label",a.data))}},n._animComplete=function(t){var e=this._tweenDic[t];e&&delete this._tweenDic[t]},n._complete=function(){this.event("complete")},n.reset=function(){var t;if(this._labelDic)for(t in this._labelDic)delete this._labelDic[t];var e;for(t in this._tweenDic)e=this._tweenDic[t],e.clear(),delete this._tweenDic[t];for(t in this._firstTweenDic)delete this._firstTweenDic[t];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length){var i=0,n=0;for(n=this._tweenDataList.length,i=0;n>i;i++)this._tweenDataList[i]&&this._tweenDataList[i].destroy()}this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,Laya.timer.clear(this,this._update)},n.destroy=function(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null},__getset(0,n,"index",function(){return this._frameIndex},function(t){this._frameIndex=t,this.gotoTime(this._frameIndex/this._frameRate*1e3)}),__getset(0,n,"total",function(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}),e.to=function(t,i,n,r,a){return void 0===a&&(a=0),(new e).to(t,i,n,r,a)},e.from=function(t,i,n,r,a){return void 0===a&&(a=0),(new e).from(t,i,n,r,a)},e.__init$=function(){i=function(){function t(){this.type=0,this.isTo=!0,this.startTime=NaN,this.endTime=NaN,this.target=null,this.duration=NaN,this.ease=null,this.data=null}__class(t,"");var e=t.prototype;return e.destroy=function(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,Pool.recover("tweenData",this)},t}()},e}(EventDispatcher),Sprite=function(t){function e(){this._transform=null,this._tfChanged=!1,this._x=0,this._y=0,this._width=0,this._height=0,this._repaint=1,this._mouseEnableState=0,this._zOrder=0,this._graphics=null,this._renderType=0,this._optimizeScrollRect=!1,this._texture=null,this.mouseThrough=!1,this.autoSize=!1,this.hitTestPrior=!1,this.viewport=null,e.__super.call(this),this._style=Style.EMPTY}__class(e,"laya.display.Sprite",t);var i=e.prototype;return Laya.imps(i,{"laya.display.ILayout":!0}),i.createConchModel=function(){return new ConchNode},i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._style&&this._style.destroy(),this._transform=null,this._style=null,this._graphics=null},i.updateZOrder=function(){Utils.updateOrder(this._childs)&&this.repaint()},i.reCache=function(){this._$P.cacheCanvas&&(this._$P.cacheCanvas.reCache=!0),this._repaint=1},i.setBounds=function(t){this._set$P("uBounds",t)},i.getBounds=function(){return this._$P.mBounds||this._set$P("mBounds",new Rectangle),Rectangle._getWrapRec(this._boundPointsToParent(),this._$P.mBounds)},i.getSelfBounds=function(){return this._$P.uBounds?this._$P.uBounds:(this._$P.mBounds||this._set$P("mBounds",new Rectangle),Rectangle._getWrapRec(this._getBoundPointsM(!1),this._$P.mBounds))},i._boundPointsToParent=function(t){void 0===t&&(t=!1);var e=0,i=0;this._style&&(e=this._style._tf.translateX,i=this._style._tf.translateY,t=t||0!==this._style._tf.rotate,this._style.scrollRect&&(e+=this._style.scrollRect.x,i+=this._style.scrollRect.y));var n=this._getBoundPointsM(t);if(!n||n.length<1)return n;if(8!=n.length&&(n=t?GrahamScan.scanPList(n):Rectangle._getWrapRec(n,Rectangle.TEMP)._getBoundPoints()),!this.transform)return Utils.transPointList(n,this._x-e,this._y-i),n;var r=Point.TEMP,a=0,s=n.length;for(a=0;s>a;a+=2)r.x=n[a],r.y=n[a+1],this.toParentPoint(r),n[a]=r.x,n[a+1]=r.y;return n},i.getGraphicBounds=function(t){return void 0===t&&(t=!1),this._graphics?this._graphics.getBounds(t):Rectangle.TEMP.setTo(0,0,0,0)},i._getBoundPointsM=function(t){if(void 0===t&&(t=!1),this._$P.uBounds)return this._$P.uBounds._getBoundPoints();if(this._$P.temBM||this._set$P("temBM",[]),this.scrollRect){var e=Utils.clearArray(this._$P.temBM),i=Rectangle.TEMP;return i.copyFrom(this.scrollRect),Utils.concatArray(e,i._getBoundPoints()),e}var n,r,a,s=this._graphics?this._graphics.getBoundPoints():Utils.clearArray(this._$P.temBM);a=this._childs;for(var o=0,h=a.length;h>o;o++)n=a[o],n instanceof laya.display.Sprite&&1==n.visible&&(r=n._boundPointsToParent(t),r&&(s=s?Utils.concatArray(s,r):r));return s},i.getStyle=function(){return this._style===Style.EMPTY&&(this._style=new Style),this._style},i.setStyle=function(t){this._style=t},i._adjustTransform=function(){"use strict";this._tfChanged=!1;var t,e=this._style,i=e._tf,n=i.scaleX,r=i.scaleY;if(i.rotate||1!==n||1!==r||i.skewX||i.skewY){t=this._transform||(this._transform=Matrix.create()),t.bTransform=!0;var a=.0174532922222222*(i.rotate-i.skewX),s=.0174532922222222*(i.rotate+i.skewY),o=Math.cos(s),h=Math.sin(s),l=Math.sin(a),u=Math.cos(a);return t.a=n*o,t.b=n*h,t.c=-r*l,t.d=r*u,t.tx=t.ty=0,t}return this._transform&&this._transform.destroy(),this._transform=null,this._renderType&=-5,t},i.pos=function(t,e,i){if(void 0===i&&(i=!1),this._x!==t||this._y!==e){if(this.destroyed)return this;if(i){this._x=t,this._y=e,this.conchModel&&this.conchModel.pos(this._x,this._y);var n=this._parent;n&&0===n._repaint&&(n._repaint=1,n.parentRepaint()),this._$P.maskParent&&0===this._$P.maskParent._repaint&&(this._$P.maskParent._repaint=1,this._$P.maskParent.parentRepaint())}else this.x=t,this.y=e}return this},i.pivot=function(t,e){return this.pivotX=t,this.pivotY=e,this},i.size=function(t,e){return this.width=t,this.height=e,this},i.scale=function(t,e,i){void 0===i&&(i=!1);var n=this.getStyle(),r=n._tf;if(r.scaleX!=t||r.scaleY!=e){if(this.destroyed)return this;if(i){n.setScale(t,e),this._tfChanged=!0,this.conchModel&&this.conchModel.scale(t,e),this._renderType|=4;var a=this._parent;a&&0===a._repaint&&(a._repaint=1,a.parentRepaint())}else this.scaleX=t,this.scaleY=e}return this},i.skew=function(t,e){return this.skewX=t,this.skewY=e,this},i.render=function(t,e,i){Stat.spriteCount++,RenderSprite.renders[this._renderType]._fun(this,t,e+this._x,i+this._y),this._repaint=0},i.drawToCanvas=function(t,e,i,n){if(Render.isConchNode){var r=HTMLCanvas.create("2D"),a=new RenderContext(t,e,r);return a.ctx.setCanvasType(1),this.conchModel.drawToCanvas(r.source,i,n),r}return RunDriver.drawToCanvas(this,this._renderType,t,e,i,n)},i.customRender=function(t,e,i){this._renderType|=1024},i._applyFilters=function(){if(!Render.isWebGL){var t;if(t=this._$P.filters,t&&!(t.length<1))for(var e=0,i=t.length;i>e;e++)t[e].action.apply(this._$P.cacheCanvas)}},i._isHaveGlowFilter=function(){var t=0,e=0;if(this.filters)for(t=0;t<this.filters.length;t++)if(8==this.filters[t].type)return!0;for(t=0,e=this._childs.length;e>t;t++)if(this._childs[t]._isHaveGlowFilter())return!0;return!1},i.localToGlobal=function(t,e){void 0===e&&(e=!1),e===!0&&(t=new Point(t.x,t.y));for(var i=this;i&&i!=Laya.stage;)t=i.toParentPoint(t),i=i.parent;return t},i.globalToLocal=function(t,e){void 0===e&&(e=!1),e&&(t=new Point(t.x,t.y));for(var i=this,n=[];i&&i!=Laya.stage;)n.push(i),i=i.parent;for(var r=n.length-1;r>=0;)i=n[r],t=i.fromParentPoint(t),r--;return t},i.toParentPoint=function(t){if(!t)return t;t.x-=this.pivotX,t.y-=this.pivotY,this.transform&&this._transform.transformPoint(t),t.x+=this._x,t.y+=this._y;var e=this._style.scrollRect;return e&&(t.x-=e.x,t.y-=e.y),t},i.fromParentPoint=function(t){if(!t)return t;t.x-=this._x,t.y-=this._y;var e=this._style.scrollRect;return e&&(t.x+=e.x,t.y+=e.y),this.transform&&this._transform.invertTransformPoint(t),t.x+=this.pivotX,t.y+=this.pivotY,t},i.on=function(e,i,n,r){return 1!==this._mouseEnableState&&this.isMouseEvent(e)?(this.mouseEnabled=!0,this._setBit(2,!0),this._parent&&this._$2__onDisplay(),this._createListener(e,i,n,r,!1)):t.prototype.on.call(this,e,i,n,r)},i.once=function(e,i,n,r){return 1!==this._mouseEnableState&&this.isMouseEvent(e)?(this.mouseEnabled=!0,this._setBit(2,!0),this._parent&&this._$2__onDisplay(),this._createListener(e,i,n,r,!0)):t.prototype.once.call(this,e,i,n,r)},i._$2__onDisplay=function(){if(1!==this._mouseEnableState){var t=this;for(t=t.parent;t&&1!==t._mouseEnableState&&!t._getBit(2);)t.mouseEnabled=!0,t._setBit(2,!0),t=t.parent}},i.loadImage=function(t,e,i,n,r,a){function s(t){o.destroyed||(o.size(e+(n||t.width),i+(r||t.height)),o.repaint(),a&&a.runWith(t))}var o=this;return void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),this.graphics.loadImage(t,e,i,n,r,s),this},i.repaint=function(){this.conchModel&&this.conchModel.repaint&&this.conchModel.repaint(),0===this._repaint&&(this._repaint=1,this.parentRepaint()),this._$P&&this._$P.maskParent&&this._$P.maskParent.repaint()},i._needRepaint=function(){return 0!==this._repaint&&this._$P.cacheCanvas&&this._$P.cacheCanvas.reCache},i._childChanged=function(t){this._childs.length?this._renderType|=2048:this._renderType&=-2049,t&&this._get$P("hasZorder")&&Laya.timer.callLater(this,this.updateZOrder),this.repaint()},i.parentRepaint=function(){var t=this._parent;t&&0===t._repaint&&(t._repaint=1,t.parentRepaint())},i.startDrag=function(t,e,i,n,r,a,s){void 0===e&&(e=!1),void 0===i&&(i=0),void 0===n&&(n=300),void 0===a&&(a=!1),void 0===s&&(s=.92),this._$P.dragging||this._set$P("dragging",new Dragging),this._$P.dragging.start(this,t,e,i,n,r,a,s)},i.stopDrag=function(){this._$P.dragging&&this._$P.dragging.stop()},i._setDisplay=function(e){if(!e){var i=this._$P.cacheCanvas;i&&i.ctx&&(Pool.recover("RenderContext",i.ctx),i.ctx.canvas.size(0,0),i.ctx=null);var n=this._$P._filterCache;n&&(n.destroy(),n.recycle(),this._set$P("_filterCache",null)),this._$P._isHaveGlowFilter&&this._set$P("_isHaveGlowFilter",!1)}t.prototype._setDisplay.call(this,e)},i.hitTestPoint=function(t,e){var i=this.globalToLocal(Point.TEMP.setTo(t,e)),n=this._$P.hitArea?this._$P.hitArea:this._width>0&&this._height>0?Rectangle.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds();return n.contains(i.x,i.y)},i.getMousePoint=function(){return this.globalToLocal(Point.TEMP.setTo(Laya.stage.mouseX,Laya.stage.mouseY))},i._getWords=function(){return null},i._addChildsToLayout=function(t){var e=this._getWords();if(null==e&&0==this._childs.length)return!1;if(e)for(var i=0,n=e.length;n>i;i++)t.push(e[i]);return this._childs.forEach(function(e,i,n){e._style._enableLayout()&&e._addToLayout(t)}),!0},i._addToLayout=function(t){this._style.absolute||(this._style.block?t.push(this):this._addChildsToLayout(t)&&(this.x=this.y=0))},i._isChar=function(){return!1},i._getCSSStyle=function(){return this._style.getCSSStyle()},i._setAttributes=function(t,e){switch(t){case"x":this.x=parseFloat(e);break;case"y":this.y=parseFloat(e);break;case"width":this.width=parseFloat(e);break;case"height":this.height=parseFloat(e);break;default:this[t]=e}},i._layoutLater=function(){this.parent&&this.parent._layoutLater()},__getset(0,i,"optimizeScrollRect",function(){return this._optimizeScrollRect},function(t){this._optimizeScrollRect!=t&&(this._optimizeScrollRect=t,this.conchModel&&this.conchModel.optimizeScrollRect(t))}),__getset(0,i,"customRenderEnable",null,function(t){if(t&&(this._renderType|=1024,Render.isConchNode)){e.CustomList.push(this);var i=new HTMLCanvas("2d");i._setContext(new CanvasRenderingContext2D),this.customContext=new RenderContext(0,0,i),i.context.setCanvasType&&i.context.setCanvasType(2),this.conchModel.custom(i.context)}}),__getset(0,i,"cacheAsBitmap",function(){return"none"!==this.cacheAs},function(t){this.cacheAs=t?this._$P.hasFilter?"none":"normal":"none"}),__getset(0,i,"cacheAs",function(){return null==this._$P.cacheCanvas?"none":this._$P.cacheCanvas.type},function(t){var e=this._$P.cacheCanvas;if(t!==(e?e.type:"none")){if("none"!==t)this._getBit(1)||this._setUpNoticeType(1),e||(e=this._set$P("cacheCanvas",Pool.getItemByClass("cacheCanvas",Object))),e.type=t,e.reCache=!0,this._renderType|=16,"bitmap"==t&&this.conchModel&&this.conchModel.cacheAs(1),this._set$P("cacheForFilters",!1);else if(this._$P.hasFilter)this._set$P("cacheForFilters",!0);else{if(e){var i=e;i&&i.ctx&&(Pool.recover("RenderContext",i.ctx),i.ctx.canvas.size(0,0),i.ctx=null),Pool.recover("cacheCanvas",e)}this._$P.cacheCanvas=null,this._renderType&=-17,this.conchModel&&this.conchModel.cacheAs(0)}this.repaint()}}),__getset(0,i,"zOrder",function(){return this._zOrder},function(t){this._zOrder!=t&&(this._zOrder=t,this.conchModel&&this.conchModel.setZOrder&&this.conchModel.setZOrder(t),this._parent&&(t&&this._parent._set$P("hasZorder",!0),Laya.timer.callLater(this._parent,this.updateZOrder)))}),__getset(0,i,"rotation",function(){return this._style._tf.rotate},function(t){var e=this.getStyle();if(e._tf.rotate!==t){e.setRotate(t),this._tfChanged=!0,this.conchModel&&this.conchModel.rotate(t),this._renderType|=4;var i=this._parent;i&&0===i._repaint&&(i._repaint=1,i.parentRepaint())}}),__getset(0,i,"width",function(){return this.autoSize?this.getSelfBounds().width:this._width},function(t){this._width!==t&&(this._width=t,this.conchModel&&this.conchModel.size(t,this._height),this.repaint())}),__getset(0,i,"x",function(){return this._x},function(t){if(this._x!==t){if(this.destroyed)return;this._x=t,this.conchModel&&this.conchModel.pos(t,this._y);var e=this._parent;e&&0===e._repaint&&(e._repaint=1,e.parentRepaint()),this._$P.maskParent&&0===this._$P.maskParent._repaint&&(this._$P.maskParent._repaint=1,this._$P.maskParent.parentRepaint())}}),__getset(0,i,"globalScaleY",function(){for(var t=1,e=this;e&&e!==Laya.stage;)t*=e.scaleY,e=e.parent;return t}),__getset(0,i,"hitArea",function(){return this._$P.hitArea},function(t){this._set$P("hitArea",t)}),__getset(0,i,"staticCache",function(){return this._$P.staticCache},function(t){this._set$P("staticCache",t),t||this.reCache()}),__getset(0,i,"texture",function(){return this._texture},function(t){this._texture!=t&&(this._texture=t,this.graphics.cleanByTexture(t,0,0))}),__getset(0,i,"y",function(){return this._y},function(t){if(this._y!==t){if(this.destroyed)return;this._y=t,this.conchModel&&this.conchModel.pos(this._x,t);var e=this._parent;e&&0===e._repaint&&(e._repaint=1,e.parentRepaint()),this._$P.maskParent&&0===this._$P.maskParent._repaint&&(this._$P.maskParent._repaint=1,this._$P.maskParent.parentRepaint())}}),__getset(0,i,"height",function(){return this.autoSize?this.getSelfBounds().height:this._height},function(t){this._height!==t&&(this._height=t,this.conchModel&&this.conchModel.size(this._width,t),this.repaint())}),__getset(0,i,"blendMode",function(){return this._style.blendMode},function(t){this.getStyle().blendMode=t,this.conchModel&&this.conchModel.blendMode(t),t&&"source-over"!=t?this._renderType|=8:this._renderType&=-9,this.parentRepaint()}),__getset(0,i,"scaleX",function(){return this._style._tf.scaleX},function(t){var e=this.getStyle();if(e._tf.scaleX!==t){e.setScaleX(t),this._tfChanged=!0,this.conchModel&&this.conchModel.scale(t,e._tf.scaleY),this._renderType|=4;var i=this._parent;i&&0===i._repaint&&(i._repaint=1,i.parentRepaint())}}),__getset(0,i,"scaleY",function(){return this._style._tf.scaleY},function(t){var e=this.getStyle();if(e._tf.scaleY!==t){e.setScaleY(t),this._tfChanged=!0,this.conchModel&&this.conchModel.scale(e._tf.scaleX,t),this._renderType|=4;var i=this._parent;i&&0===i._repaint&&(i._repaint=1,i.parentRepaint())}}),__getset(0,i,"stage",function(){return Laya.stage}),__getset(0,i,"skewX",function(){return this._style._tf.skewX},function(t){var e=this.getStyle();if(e._tf.skewX!==t){e.setSkewX(t),this._tfChanged=!0,this.conchModel&&this.conchModel.skew(t,e._tf.skewY),this._renderType|=4;var i=this._parent;i&&0===i._repaint&&(i._repaint=1,i.parentRepaint())}}),__getset(0,i,"scrollRect",function(){return this._style.scrollRect},function(t){this.getStyle().scrollRect=t,this.repaint(),t?(this._renderType|=128,this.conchModel&&this.conchModel.scrollRect(t.x,t.y,t.width,t.height)):(this._renderType&=-129,this.conchModel&&(e.RUNTIMEVERION<"0.9.1"?this.conchModel.removeType(64):this.conchModel.removeType(128)))}),__getset(0,i,"skewY",function(){return this._style._tf.skewY},function(t){var e=this.getStyle();if(e._tf.skewY!==t){e.setSkewY(t),this._tfChanged=!0,this.conchModel&&this.conchModel.skew(e._tf.skewX,t),this._renderType|=4;var i=this._parent;i&&0===i._repaint&&(i._repaint=1,i.parentRepaint())}}),__getset(0,i,"transform",function(){return this._tfChanged?this._adjustTransform():this._transform},function(t){this._tfChanged=!1,this._transform=t,t&&(this._x=t.tx,this._y=t.ty,t.tx=t.ty=0,this.conchModel&&this.conchModel.transform(t.a,t.b,t.c,t.d,this._x,this._y)),t?this._renderType|=4:(this._renderType&=-5,this.conchModel&&this.conchModel.removeType(4)),this.parentRepaint()}),__getset(0,i,"pivotX",function(){return this._style._tf.translateX},function(t){this.getStyle().setTranslateX(t),this.conchModel&&this.conchModel.pivot(t,this._style._tf.translateY),this.repaint()}),__getset(0,i,"pivotY",function(){return this._style._tf.translateY},function(t){this.getStyle().setTranslateY(t),this.conchModel&&this.conchModel.pivot(this._style._tf.translateX,t),this.repaint()}),__getset(0,i,"alpha",function(){return this._style.alpha},function(t){this._style&&this._style.alpha!==t&&(t=0>t?0:t>1?1:t,this.getStyle().alpha=t,this.conchModel&&this.conchModel.alpha(t),1!==t?this._renderType|=2:this._renderType&=-3,this.parentRepaint())}),__getset(0,i,"visible",function(){return this._style.visible},function(t){this._style&&this._style.visible!==t&&(this.getStyle().visible=t,this.conchModel&&this.conchModel.visible(t),this.parentRepaint())}),__getset(0,i,"graphics",function(){return this._graphics||(this.graphics=RunDriver.createGraphics())},function(t){this._graphics&&(this._graphics._sp=null),this._graphics=t,t?(this._renderType&=-2,this._renderType|=512,t._sp=this,this.conchModel&&this.conchModel.graphics(this._graphics)):(this._renderType&=-513,this._renderType&=-2,this.conchModel&&(e.RUNTIMEVERION<"0.9.1"?this.conchModel.removeType(256):this.conchModel.removeType(512))),this.repaint()}),__getset(0,i,"filters",function(){return this._$P.filters},function(t){t&&0===t.length&&(t=null),this._$P.filters!=t&&(this._set$P("filters",t?t.slice():null),Render.isConchApp&&(this.conchModel&&(e.RUNTIMEVERION<"0.9.1"?this.conchModel.removeType(16):this.conchModel.removeType(32)),this._$P.filters&&1==this._$P.filters.length&&this._$P.filters[0].callNative(this)),Render.isWebGL&&(t&&t.length?this._renderType|=32:this._renderType&=-33),t&&t.length>0?(this._getBit(1)||this._setUpNoticeType(1),Render.isWebGL&&1==t.length&&t[0]instanceof laya.filters.ColorFilter||("bitmap"!=this.cacheAs&&(Render.isConchNode||(this.cacheAs="bitmap"),this._set$P("cacheForFilters",!0)),this._set$P("hasFilter",!0))):(this._set$P("hasFilter",!1),this._$P.cacheForFilters&&"bitmap"==this.cacheAs&&(this.cacheAs="none")),this.repaint())}),__getset(0,i,"parent",t.prototype._$get_parent,function(e){t.prototype._$set_parent.call(this,e),e&&this._getBit(2)&&this._$2__onDisplay()}),__getset(0,i,"mask",function(){return this._$P._mask},function(t){t&&this.mask&&this.mask._$P.maskParent||(t?(this.cacheAs="bitmap",this._set$P("_mask",t),t._set$P("maskParent",this)):(this.cacheAs="none",this.mask&&this.mask._set$P("maskParent",null),this._set$P("_mask",t)),this.conchModel&&this.conchModel.mask(t?t.conchModel:null),this._renderType|=64,this.parentRepaint())}),__getset(0,i,"mouseEnabled",function(){return this._mouseEnableState>1},function(t){this._mouseEnableState=t?2:1}),__getset(0,i,"globalScaleX",function(){for(var t=1,e=this;e&&e!==Laya.stage;)t*=e.scaleX,e=e.parent;return t}),__getset(0,i,"mouseX",function(){return this.getMousePoint().x}),__getset(0,i,"mouseY",function(){return this.getMousePoint().y}),e.fromImage=function(t){return(new e).loadImage(t)},e.CustomList=[],__static(e,["RUNTIMEVERION",function(){return this.RUNTIMEVERION=window.conch?conchConfig.getRuntimeVersion().substr(conchConfig.getRuntimeVersion().lastIndexOf("-")+1):""}]),e}(Node),AudioSoundChannel=function(t){function e(t){this._audio=null,this._onEnd=null,this._resumePlay=null,e.__super.call(this),this._onEnd=Utils.bind(this.__onEnd,this),this._resumePlay=Utils.bind(this.__resumePlay,this),t.addEventListener("ended",this._onEnd),this._audio=t}__class(e,"laya.media.h5audio.AudioSoundChannel",t);var i=e.prototype;return i.__onEnd=function(){return 1==this.loops?(this.completeHandler&&(Laya.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event("complete")):(this.loops>0&&this.loops--,void this.play())},i.__resumePlay=function(){this._audio&&this._audio.removeEventListener("canplay",this._resumePlay);try{this._audio.currentTime=this.startTime,Browser.container.appendChild(this._audio),this._audio.play()}catch(t){this.event("error")}},i.play=function(){this.isStopped=!1;try{this._audio.playbackRate=SoundManager.playbackRate,this._audio.currentTime=this.startTime}catch(t){return void this._audio.addEventListener("canplay",this._resumePlay)}SoundManager.addChannel(this),Browser.container.appendChild(this._audio),"play"in this._audio&&this._audio.play()},i.stop=function(){this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&Render.isConchApp&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),Browser.onIE||this._audio!=AudioSound._musicAudio&&Pool.recover("audio:"+this.url,this._audio),Browser.removeElement(this._audio),this._audio=null)},i.pause=function(){this.isStopped=!0,SoundManager.removeChannel(this),"pause"in this._audio&&this._audio.pause()},i.resume=function(){this._audio&&(this.isStopped=!1,SoundManager.addChannel(this),"play"in this._audio&&this._audio.play())},__getset(0,i,"position",function(){return this._audio?this._audio.currentTime:0}),__getset(0,i,"duration",function(){return this._audio?this._audio.duration:0}),__getset(0,i,"volume",function(){return this._audio?this._audio.volume:1},function(t){this._audio&&(this._audio.volume=t)}),e}(SoundChannel),WebAudioSoundChannel=function(t){function e(){this.audioBuffer=null,this.gain=null,this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this._onPlayEnd=null,this.context=WebAudioSound.ctx,e.__super.call(this),this._onPlayEnd=Utils.bind(this.__onPlayEnd,this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}__class(e,"laya.media.webaudio.WebAudioSoundChannel",t);var i=e.prototype;return i.play=function(){if(SoundManager.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){var t=this.context,e=this.gain,i=t.createBufferSource();this.bufferSource=i,i.buffer=this.audioBuffer,i.connect(e),e&&e.disconnect(),e.connect(t.destination),i.onended=this._onPlayEnd,this.startTime>=this.duration&&(this.startTime=0),this._startTime=Browser.now(),this.gain.gain.value=this._volume,0==this.loops&&(i.loop=!0),i.playbackRate.value=SoundManager.playbackRate,i.start(0,this.startTime),this._currentTime=0}},i.__onPlayEnd=function(){return 1==this.loops?(this.completeHandler&&(Laya.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event("complete")):(this.loops>0&&this.loops--,void this.play())},i._clearBufferSource=function(){if(this.bufferSource){var t=this.bufferSource;t.stop?t.stop(0):t.noteOff(0),t.disconnect(0),t.onended=null,e._tryCleanFailed||this._tryClearBuffer(t),this.bufferSource=null}},i._tryClearBuffer=function(t){if(!Browser.onIOS)return void(e._tryCleanFailed=!0);try{t.buffer=WebAudioSound._miniBuffer}catch(i){e._tryCleanFailed=!0}},i.stop=function(){this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,SoundManager.autoReleaseSound&&Laya.timer.once(5e3,null,SoundManager.disposeSoundIfNotUsed,[this.url],!1)},i.pause=function(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),SoundManager.autoReleaseSound&&Laya.timer.once(5e3,null,SoundManager.disposeSoundIfNotUsed,[this.url],!1)},i.resume=function(){this.startTime=this._pauseTime,this.play()},__getset(0,i,"position",function(){return this.bufferSource?(Browser.now()-this._startTime)/1e3+this.startTime:0}),__getset(0,i,"duration",function(){return this.audioBuffer?this.audioBuffer.duration:0}),__getset(0,i,"volume",function(){return this._volume},function(t){this.isStopped||(this._volume=t,this.gain.gain.value=t)}),e._tryCleanFailed=!1,e}(SoundChannel),Bitmap=function(t){function e(){this.useNum=0,e.__super.call(this),this._w=0,this._h=0}__class(e,"laya.resource.Bitmap",t);var i=e.prototype;return __getset(0,i,"width",function(){return this._w}),__getset(0,i,"height",function(){return this._h}),__getset(0,i,"source",function(){return this._source}),e}(Resource),AnimationPlayerBase=function(t){function e(){this.loop=!1,this.wrapMode=0,this._index=0,this._count=0,this._isPlaying=!1,this._labels=null,this._isReverse=!1,this._frameRateChanged=!1,this._controlNode=null,this._actionName=null,e.__super.call(this),this._interval=Config.animationInterval,this._setUpNoticeType(1)}__class(e,"laya.display.AnimationPlayerBase",t);var i=e.prototype;return i.play=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=!0),void 0===i&&(i=""),this._isPlaying=!0,this.index="string"==typeof t?this._getFrameByLabel(t):t,this.loop=e,this._actionName=i,this._isReverse=1==this.wrapMode,this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)},i._getFrameByLabel=function(t){var e=0;for(e=0;e<this._count;e++)if(this._labels[e]&&this._labels[e].indexOf(t)>=0)return e;return 0},i._frameLoop=function(){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event("complete");2==this.wrapMode?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event("complete")}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event("complete");2==this.wrapMode?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event("complete")}this.index=this._index},i._setControlNode=function(t){this._controlNode&&(this._controlNode.off("display",this,this._checkResumePlaying),this._controlNode.off("undisplay",this,this._checkResumePlaying)),this._controlNode=t,t&&t!=this&&(t.on("display",this,this._checkResumePlaying),t.on("undisplay",this,this._checkResumePlaying))},i._setDisplay=function(e){t.prototype._setDisplay.call(this,e),this._checkResumePlaying()},i._checkResumePlaying=function(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))},i.stop=function(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)},i.addLabel=function(t,e){this._labels||(this._labels={}),this._labels[e]||(this._labels[e]=[]),this._labels[e].push(t)},i.removeLabel=function(t){if(t){if(this._labels)for(var e in this._labels)this._removeLabelFromLabelList(this._labels[e],t)}else this._labels=null},i._removeLabelFromLabelList=function(t,e){if(t)for(var i=t.length-1;i>=0;i--)t[i]==e&&t.splice(i,1)},i.gotoAndStop=function(t){this.index="string"==typeof t?this._getFrameByLabel(t):t,this.stop()},i._displayToIndex=function(t){},i.clear=function(){this.stop(),this._labels=null},__getset(0,i,"interval",function(){return this._interval},function(t){this._interval!=t&&(this._frameRateChanged=!0,this._interval=t,this._isPlaying&&t>0&&this.timerLoop(t,this,this._frameLoop,null,!0,!0))}),__getset(0,i,"isPlaying",function(){return this._isPlaying}),__getset(0,i,"index",function(){return this._index},function(t){if(this._index=t,this._displayToIndex(t),this._labels&&this._labels[t])for(var e=this._labels[t],i=0,n=e.length;n>i;i++)this.event("label",e[i])}),__getset(0,i,"count",function(){return this._count}),e.WRAP_POSITIVE=0,e.WRAP_REVERSE=1,e.WRAP_PINGPONG=2,e}(Sprite),Text=function(t){function e(){this._clipPoint=null,this._currBitmapFont=null,this._text=null,this._isChanged=!1,this._textWidth=0,this._textHeight=0,this._lines=[],this._lineWidths=[],this._startX=NaN,this._startY=NaN,this._lastVisibleLineIndex=-1,this._words=null,this._charSize={},this.underline=!1,this._underlineColor=null,e.__super.call(this),this.overflow=e.VISIBLE,this._style=new CSSStyle(this),this._style.wordWrap=!1}__class(e,"laya.display.Text",t);var i=e.prototype;return i.destroy=function(e){
void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._lines=null,this._words&&(this._words.length=0,this._words=null)},i._getBoundPointsM=function(t){void 0===t&&(t=!1);var e=Rectangle.TEMP;return e.setTo(0,0,this.width,this.height),e._getBoundPoints()},i.getGraphicBounds=function(t){void 0===t&&(t=!1);var e=Rectangle.TEMP;return e.setTo(0,0,this.width,this.height),e},i._getCSSStyle=function(){return this._style},i.lang=function(t,i,n,r,a,s,o,h,l,u,c){if(t=e.langPacks&&e.langPacks[t]?e.langPacks[t]:t,arguments.length<2)this._text=t;else{for(var _=0,d=arguments.length;d>_;_++)t=t.replace("{"+_+"}",arguments[_+1]);this._text=t}},i.renderText=function(t,e){var i=this.graphics;i.clear(!0);var n=(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+(Browser.onIPhone?laya.display.Text._fontFamilyMap[this.font]||this.font:this.font);Browser.context.font=n;var r=this.padding,a=r[3],s="left",o=this._lines,h=this.leading+this._charSize.height,l=this._currBitmapFont;l&&(h=this.leading+l.getMaxHeight());var u=r[0];if(!l&&this._width>0&&this._textWidth<=this._width&&("right"==this.align?(s="right",a=this._width-r[1]):"center"==this.align&&(s="center",a=.5*this._width+r[3]-r[1])),this._height>0){var c=this._textHeight>this._height?"top":this.valign;"middle"===c?u=.5*(this._height-e*h)+r[0]-r[2]:"bottom"===c&&(u=this._height-e*h-r[2])}var _=this._style;if(l&&l.autoScaleSize)var d=l.fontSize/this.fontSize;if(this._clipPoint)if(i.save(),l&&l.autoScaleSize){var f=0,p=0;f=this._width?this._width-r[3]-r[1]:this._textWidth,p=this._height?this._height-r[0]-r[2]:this._textHeight,f*=d,p*=d,i.clipRect(r[3],r[0],f,p)}else i.clipRect(r[3],r[0],this._width?this._width-r[3]-r[1]:this._textWidth,this._height?this._height-r[0]-r[2]:this._textHeight);var m=_.password;"prompt"in this&&this.prompt==this._text&&(m=!1);for(var g=0,y=0,x=Math.min(this._lines.length,e+t)||1,v=t;x>v;v++){var S,T=o[v];if(m){var E=T.length;T="";for(var w=E;w>0;w--)T+="●"}if(g=a-(this._clipPoint?this._clipPoint.x:0),y=u+h*v-(this._clipPoint?this._clipPoint.y:0),this.underline&&this.drawUnderline(s,g,y,v),l){var b=this.width;l.autoScaleSize&&(b=this.width*d),l.drawText(T,this,g,y,this.align,b)}else Render.isWebGL?(this._words||(this._words=[]),S=this._words.length>v-t?this._words[v-t]:new WordText,S.setText(T)):S=T,_.stroke?i.fillBorderText(S,g,y,n,this.color,_.strokeColor,_.stroke,s):i.fillText(S,g,y,n,this.color,s)}if(l&&l.autoScaleSize){var C=1/d;this.scale(C,C)}this._clipPoint&&i.restore(),this._startX=a,this._startY=u},i.drawUnderline=function(t,e,i,n){var r=this._lineWidths[n];switch(t){case"center":e-=r/2;break;case"right":e-=r;break;case"left":}i+=this._charSize.height,this._graphics.drawLine(e,i,e+r,i,this.underlineColor||this.color,1)},i.typeset=function(){if(this._isChanged=!1,!this._text)return this._clipPoint=null,this._textWidth=this._textHeight=0,void this.graphics.clear(!0);Browser.context.font=this._getCSSStyle().font,this._lines.length=0,this._lineWidths.length=0,this.parseLines(this._text),this.evalTextSize(),this.checkEnabledViewportOrNot()?this._clipPoint||(this._clipPoint=new Point(0,0)):this._clipPoint=null;var t=this._lines.length;if(this.overflow!=e.VISIBLE){var i=this.overflow==e.HIDDEN?Math.floor:Math.ceil;t=Math.min(t,i((this.height-this.padding[0]-this.padding[2])/(this.leading+this._charSize.height)))}var n=this.scrollY/(this._charSize.height+this.leading)|0;this.renderText(n,t),this.repaint()},i.evalTextSize=function(){var t=NaN,e=NaN;t=Math.max.apply(this,this._lineWidths),e=this._currBitmapFont?this._lines.length*(this._currBitmapFont.getMaxHeight()+this.leading)+this.padding[0]+this.padding[2]:this._lines.length*(this._charSize.height+this.leading)+this.padding[0]+this.padding[2],(t!=this._textWidth||e!=this._textHeight)&&(this._textWidth=t,this._textHeight=e,this._width&&this._height||this.conchModel&&this.conchModel.size(this._width||this._textWidth,this._height||this._textHeight))},i.checkEnabledViewportOrNot=function(){return this.overflow==e.SCROLL&&(this._width>0&&this._textWidth>this._width||this._height>0&&this._textHeight>this._height)},i.changeText=function(t){this._text!==t&&(this.lang(t+""),this._graphics&&this._graphics.replaceText(this._text)||this.typeset())},i.parseLines=function(t){var i=this.wordWrap||this.overflow==e.HIDDEN;if(i)var n=this.getWordWrapWidth();if(this._currBitmapFont)this._charSize.width=this._currBitmapFont.getMaxWidth(),this._charSize.height=this._currBitmapFont.getMaxHeight();else{var r=Browser.context.measureText(e._testWord);this._charSize.width=r.width,this._charSize.height=r.height||this.fontSize}for(var a=t.replace(/\r\n/g,"\n").split("\n"),s=0,o=a.length;o>s;s++){var h=a[s];i?this.parseLine(h,n):(this._lineWidths.push(this.getTextWidth(h)),this._lines.push(h))}},i.parseLine=function(t,i){var n,r=(Browser.context,this._lines),a=0,s=NaN,o=NaN,h=0;if(s=this.getTextWidth(t),i>=s)return r.push(t),void this._lineWidths.push(s);s=this._charSize.width,a=Math.floor(i/s),0==a&&(a=1),s=this.getTextWidth(t.substring(0,a)),o=s;for(var l=a,u=t.length;u>l;l++)if(s=this.getTextWidth(t.charAt(l)),o+=s,o>i)if(this.wordWrap){var c=t.substring(h,l);if(c.charCodeAt(c.length-1)<255&&(n=/(?:\w|-)+$/.exec(c),n&&(l=n.index+h,0==n.index?l+=c.length:c=t.substring(h,l))),r.push(c),this._lineWidths.push(o-s),h=l,!(u>l+a)){r.push(t.substring(h,u)),this._lineWidths.push(this.getTextWidth(r[r.length-1])),h=-1;break}l+=a,s=this.getTextWidth(t.substring(h,l)),o=s,l--}else if(this.overflow==e.HIDDEN)return r.push(t.substring(0,l)),void this._lineWidths.push(this.getTextWidth(r[r.length-1]));this.wordWrap&&-1!=h&&(r.push(t.substring(h,u)),this._lineWidths.push(this.getTextWidth(r[r.length-1])))},i.getTextWidth=function(t){return this._currBitmapFont?this._currBitmapFont.getTextWidth(t):Browser.context.measureText(t).width},i.getWordWrapWidth=function(){var t=this.padding,e=NaN;return e=this._currBitmapFont&&this._currBitmapFont.autoScaleSize?this._width*(this._currBitmapFont.fontSize/this.fontSize):this._width,0>=e&&(e=this.wordWrap?100:Browser.width),0>=e&&(e=100),e-t[3]-t[1]},i.getCharPoint=function(t,e){this._isChanged&&Laya.timer.runCallLater(this,this.typeset);for(var i=0,n=this._lines,r=0,a=0,s=n.length;s>a;a++){if(i+=n[a].length,i>t){var o=a;break}r=i}var h=(this.italic?"italic ":"")+(this.bold?"bold ":"")+this.fontSize+"px "+this.font;Browser.context.font=h;var l=this.getTextWidth(this._text.substring(r,t)),u=e||new Point;return u.setTo(this._startX+l-(this._clipPoint?this._clipPoint.x:0),this._startY+o*(this._charSize.height+this.leading)-(this._clipPoint?this._clipPoint.y:0))},__getset(0,i,"width",function(){return this._width?this._width:this.textWidth+this.padding[1]+this.padding[3]},function(e){e!=this._width&&(t.prototype._$set_width.call(this,e),this.isChanged=!0)}),__getset(0,i,"textWidth",function(){return this._isChanged&&Laya.timer.runCallLater(this,this.typeset),this._textWidth}),__getset(0,i,"height",function(){return this._height?this._height:this.textHeight+this.padding[0]+this.padding[2]},function(e){e!=this._height&&(t.prototype._$set_height.call(this,e),this.isChanged=!0)}),__getset(0,i,"textHeight",function(){return this._isChanged&&Laya.timer.runCallLater(this,this.typeset),this._textHeight}),__getset(0,i,"padding",function(){return this._getCSSStyle().padding},function(t){this._getCSSStyle().padding=t,this.isChanged=!0}),__getset(0,i,"bold",function(){return this._getCSSStyle().bold},function(t){this._getCSSStyle().bold=t,this.isChanged=!0}),__getset(0,i,"text",function(){return this._text||""},function(t){this._text!==t&&(this.lang(t+""),this.isChanged=!0,this.event("change"))}),__getset(0,i,"color",function(){return this._getCSSStyle().color},function(t){this._getCSSStyle().color!=t&&(this._getCSSStyle().color=t,!this._isChanged&&this._graphics?this._graphics.replaceTextColor(this.color):this.isChanged=!0)}),__getset(0,i,"font",function(){return this._getCSSStyle().fontFamily},function(t){this._currBitmapFont&&(this._currBitmapFont=null,this.scale(1,1)),e._bitmapFonts&&e._bitmapFonts[t]&&(this._currBitmapFont=e._bitmapFonts[t]),this._getCSSStyle().fontFamily=t,this.isChanged=!0}),__getset(0,i,"fontSize",function(){return this._getCSSStyle().fontSize},function(t){this._getCSSStyle().fontSize=t,this.isChanged=!0}),__getset(0,i,"italic",function(){return this._getCSSStyle().italic},function(t){this._getCSSStyle().italic=t,this.isChanged=!0}),__getset(0,i,"align",function(){return this._getCSSStyle().align},function(t){this._getCSSStyle().align=t,this.isChanged=!0}),__getset(0,i,"valign",function(){return this._getCSSStyle().valign},function(t){this._getCSSStyle().valign=t,this.isChanged=!0}),__getset(0,i,"wordWrap",function(){return this._getCSSStyle().wordWrap},function(t){this._getCSSStyle().wordWrap=t,this.isChanged=!0}),__getset(0,i,"leading",function(){return this._getCSSStyle().leading},function(t){this._getCSSStyle().leading=t,this.isChanged=!0}),__getset(0,i,"bgColor",function(){return this._getCSSStyle().backgroundColor},function(t){this._getCSSStyle().backgroundColor=t,this.isChanged=!0}),__getset(0,i,"borderColor",function(){return this._getCSSStyle().borderColor},function(t){this._getCSSStyle().borderColor=t,this.isChanged=!0}),__getset(0,i,"stroke",function(){return this._getCSSStyle().stroke},function(t){this._getCSSStyle().stroke=t,this.isChanged=!0}),__getset(0,i,"strokeColor",function(){return this._getCSSStyle().strokeColor},function(t){this._getCSSStyle().strokeColor=t,this.isChanged=!0}),__getset(0,i,"isChanged",null,function(t){this._isChanged!==t&&(this._isChanged=t,t&&Laya.timer.callLater(this,this.typeset))}),__getset(0,i,"scrollX",function(){return this._clipPoint?this._clipPoint.x:0},function(t){if(!(this.overflow!=e.SCROLL||this.textWidth<this._width)&&this._clipPoint){t=t<this.padding[3]?this.padding[3]:t;var i=this._textWidth-this._width;t=t>i?i:t;var n=this._height/(this._charSize.height+this.leading)|1;this._clipPoint.x=t,this.renderText(this._lastVisibleLineIndex,n)}}),__getset(0,i,"scrollY",function(){return this._clipPoint?this._clipPoint.y:0},function(t){if(!(this.overflow!=e.SCROLL||this.textHeight<this._height)&&this._clipPoint){t=t<this.padding[0]?this.padding[0]:t;var i=this._textHeight-this._height;t=t>i?i:t;var n=t/(this._charSize.height+this.leading)|0;this._lastVisibleLineIndex=n;var r=(this._height/(this._charSize.height+this.leading)|0)+1;this._clipPoint.y=t,this.renderText(n,r)}}),__getset(0,i,"maxScrollX",function(){return this.textWidth<this._width?0:this._textWidth-this._width}),__getset(0,i,"maxScrollY",function(){return this.textHeight<this._height?0:this._textHeight-this._height}),__getset(0,i,"lines",function(){return this._isChanged&&this.typeset(),this._lines}),__getset(0,i,"underlineColor",function(){return this._underlineColor},function(t){this._underlineColor=t,this._isChanged=!0,this.typeset()}),e.registerBitmapFont=function(t,i){e._bitmapFonts||(e._bitmapFonts={}),e._bitmapFonts[t]=i},e.unregisterBitmapFont=function(t,i){if(void 0===i&&(i=!0),e._bitmapFonts&&e._bitmapFonts[t]){var n=e._bitmapFonts[t];i&&n.destroy(),delete e._bitmapFonts[t]}},e.supportFont=function(t){Browser.context.font="10px sans-serif";var e=Browser.context.measureText("abcji").width;Browser.context.font="10px "+t;var i=Browser.context.measureText("abcji").width;return console.log(e,i),e==i?!1:!0},e._testWord="游",e.langPacks=null,e.VISIBLE="visible",e.SCROLL="scroll",e.HIDDEN="hidden",e.CharacterCache=!0,e._bitmapFonts=null,__static(e,["_fontFamilyMap",function(){return this._fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"}}]),e}(Sprite),Stage=function(t){function e(){function t(){"hidden"==Browser.document[a]?(i._isVisibility=!1,r._isInputting()&&(Input.inputElement.target.focus=!1)):i._isVisibility=!0,r.event("visibilitychange")}this.focus=null,this.frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="black",this._mouseMoveTime=0,this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=NaN,this._isFocused=!1,this._isVisibility=!1,this._scenes=null,this._wgColor=null,e.__super.call(this),this.offset=new Point,this._canvasTransform=new Matrix,this._previousOrientation=Browser.window.orientation;var i=this;this.transform=Matrix.create(),this._scenes=[],this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._displayedInStage=!0,this._isFocused=!0,this._isVisibility=!0;var n=Browser.window,r=this;n.addEventListener("focus",function(){i._isFocused=!0,r.event("focus"),r.event("focuschange")}),n.addEventListener("blur",function(){i._isFocused=!1,r.event("blur"),r.event("focuschange"),r._isInputting()&&(Input.inputElement.target.focus=!1)});var a="visibilityState",s="visibilitychange",o=n.document;"undefined"!=typeof o.hidden?(s="visibilitychange",a="visibilityState"):"undefined"!=typeof o.mozHidden?(s="mozvisibilitychange",a="mozVisibilityState"):"undefined"!=typeof o.msHidden?(s="msvisibilitychange",a="msVisibilityState"):"undefined"!=typeof o.webkitHidden&&(s="webkitvisibilitychange",a="webkitVisibilityState"),n.document.addEventListener(s,t),n.addEventListener("resize",function(){var t=Browser.window.orientation;null!=t&&t!=i._previousOrientation&&r._isInputting()&&(Input.inputElement.target.focus=!1),i._previousOrientation=t,r._isInputting()||(Browser.onSafari&&(r._safariOffsetY=(Browser.window.__innerHeight||Browser.document.body.clientHeight||Browser.document.documentElement.clientHeight)-Browser.window.innerHeight),r._resetCanvas())}),n.addEventListener("orientationchange",function(t){r._resetCanvas()}),this.on("mousemove",this,this._onmouseMove),Browser.onMobile&&this.on("mousedown",this,this._onmouseMove)}__class(e,"laya.display.Stage",t);var i=e.prototype;return i._isInputting=function(){return Browser.onMobile&&Input.isInputting},i._changeCanvasSize=function(){this.setScreenSize(Browser.clientWidth*Browser.pixelRatio,Browser.clientHeight*Browser.pixelRatio)},i._resetCanvas=function(){if(this.screenAdaptationEnabled){var t=Render._mainCanvas;t.source.style;t.size(1,1),Laya.timer.once(100,this,this._changeCanvasSize)}},i.setScreenSize=function(t,e){var i=!1;if("none"!==this._screenMode){var n=1>t/e?"vertical":"horizontal";if(i=n!==this._screenMode){var r=e;e=t,t=r}}this.canvasRotation=i;var a=Render._mainCanvas,s=a.source.style,o=this._canvasTransform.identity(),h=this._scaleMode,l=t/this.designWidth,u=e/this.designHeight,c=this.designWidth,_=this.designHeight,d=t,f=e,p=Browser.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,h){case"noscale":l=u=1,d=this.designWidth,f=this.designHeight;break;case"showall":l=u=Math.min(l,u),c=d=Math.round(this.designWidth*l),_=f=Math.round(this.designHeight*u);break;case"noborder":l=u=Math.max(l,u),d=Math.round(this.designWidth*l),f=Math.round(this.designHeight*u);break;case"full":l=u=1,this._width=c=t,this._height=_=e;break;case"fixedwidth":u=l,this._height=_=Math.round(e/l);break;case"fixedheight":l=u,this._width=c=Math.round(t/u);break;case"fixedauto":t/e<this.designWidth/this.designHeight?(u=l,this._height=_=Math.round(e/l)):(l=u,this._width=c=Math.round(t/u))}l*=this.scaleX,u*=this.scaleY,1===l&&1===u?this.transform.identity():(this.transform.a=this._formatData(l/(d/c)),this.transform.d=this._formatData(u/(f/_)),this.conchModel&&this.conchModel.scale(this.transform.a,this.transform.d)),a.size(c,_),RunDriver.changeWebGLSize(c,_),o.scale(d/c/p,f/_/p),"left"===this._alignH?this.offset.x=0:"right"===this._alignH?this.offset.x=t-d:this.offset.x=.5*(t-d)/p,"top"===this._alignV?this.offset.y=0:"bottom"===this._alignV?this.offset.y=e-f:this.offset.y=.5*(e-f)/p,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),o.translate(this.offset.x,this.offset.y),this._safariOffsetY&&o.translate(0,this._safariOffsetY),this.canvasDegree=0,i&&("horizontal"===this._screenMode?(o.rotate(Math.PI/2),o.translate(e/p,0),this.canvasDegree=90):(o.rotate(-Math.PI/2),o.translate(0,t/p),this.canvasDegree=-90)),o.a=this._formatData(o.a),o.d=this._formatData(o.d),o.tx=this._formatData(o.tx),o.ty=this._formatData(o.ty),s.transformOrigin=s.webkitTransformOrigin=s.msTransformOrigin=s.mozTransformOrigin=s.oTransformOrigin="0px 0px 0px",s.transform=s.webkitTransform=s.msTransform=s.mozTransform=s.oTransform="matrix("+o.toString()+")",this._safariOffsetY&&o.translate(0,-this._safariOffsetY),o.translate(parseInt(s.left)||0,parseInt(s.top)||0),this.visible=!0,this._repaint=1,this.event("resize")},i._formatData=function(t){return Math.abs(t)<1e-6?0:Math.abs(1-t)<.001?t>0?1:-1:t},i.getMousePoint=function(){return Point.TEMP.setTo(this.mouseX,this.mouseY)},i.repaint=function(){this._repaint=1},i.parentRepaint=function(){},i._loop=function(){return this.render(Render.context,0,0),!0},i._onmouseMove=function(t){this._mouseMoveTime=Browser.now()},i.getTimeFromFrameStart=function(){return Browser.now()-this._frameStartTime},i.render=function(e,i,n){if("sleep"===this.frameRate){var r=Browser.now();if(!(r-this._frameStartTime>=1e3))return;this._frameStartTime=r}if(this._renderCount++,Render.isFlash&&this.repaint(),!this._style.visible)return void(this._renderCount%5===0&&(Stat.loopCount++,MouseManager.instance.runEvent(),Laya.timer._update()));this._frameStartTime=Browser.now();var a="mouse"===this.frameRate?this._frameStartTime-this._mouseMoveTime<2e3?"fast":"slow":this.frameRate,s="slow"!==a,o=this._renderCount%2===0;if(Stat.renderSlow=!s,s||o){Stat.loopCount++,MouseManager.instance.runEvent(),Laya.timer._update();var h,l=0,u=0;if(Render.isConchNode)for(l=0,u=this._scenes.length;u>l;l++)h=this._scenes[l],h&&h._updateSceneConch();else for(l=0,u=this._scenes.length;u>l;l++)h=this._scenes[l],h&&h._updateScene();if(Render.isConchNode){var c=Sprite.CustomList;for(l=0,u=c.length;u>l;l++){var _=c[l];_.customRender(_.customContext,0,0)}return}Render.isWebGL&&this.renderingEnabled&&(e.clear(),t.prototype.render.call(this,e,i,n))}Render.isConchNode||!this.renderingEnabled||!s&&o||(Render.isWebGL?(RunDriver.clear(this._bgColor),RunDriver.beginFlush(),e.flush(),RunDriver.endFinish(),VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose()):(RunDriver.clear(this._bgColor),t.prototype.render.call(this,e,i,n)))},i._requestFullscreen=function(){var t=Browser.document.documentElement;t.requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.msRequestFullscreen&&t.msRequestFullscreen()},i._fullScreenChanged=function(){Laya.stage.event("fullscreenchange")},i.exitFullscreen=function(){var t=Browser.document;t.exitFullscreen?t.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitExitFullscreen&&t.webkitExitFullscreen()},__getset(0,i,"clientScaleY",function(){return this._transform?this._transform.getScaleY():1}),__getset(0,i,"width",t.prototype._$get_width,function(e){this.designWidth=e,t.prototype._$set_width.call(this,e),Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,i,"isFocused",function(){return this._isFocused}),__getset(0,i,"alignH",function(){return this._alignH},function(t){this._alignH=t,Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,i,"height",t.prototype._$get_height,function(e){this.designHeight=e,t.prototype._$set_height.call(this,e),Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,i,"transform",function(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||Matrix.create()},t.prototype._$set_transform),__getset(0,i,"isVisibility",function(){return this._isVisibility}),__getset(0,i,"desginWidth",function(){return console.debug("desginWidth已经弃用，请使用designWidth代替"),this.designWidth}),__getset(0,i,"clientScaleX",function(){return this._transform?this._transform.getScaleX():1}),__getset(0,i,"desginHeight",function(){return console.debug("desginHeight已经弃用，请使用designHeight代替"),this.designHeight}),__getset(0,i,"scaleMode",function(){return this._scaleMode},function(t){this._scaleMode=t,Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,i,"alignV",function(){return this._alignV},function(t){this._alignV=t,Laya.timer.callLater(this,this._changeCanvasSize)}),__getset(0,i,"bgColor",function(){return this._bgColor},function(t){this._bgColor=t,this.conchModel&&this.conchModel.bgColor(t),Render.isWebGL&&(t&&"black"!==t&&"#000000"!==t?this._wgColor=Color.create(t)._color:this._wgColor=null),t?Render.canvas.style.background=t:Render.canvas.style.background="none"}),__getset(0,i,"mouseX",function(){return Math.round(MouseManager.instance.mouseX/this.clientScaleX)}),__getset(0,i,"mouseY",function(){return Math.round(MouseManager.instance.mouseY/this.clientScaleY)}),__getset(0,i,"screenMode",function(){return this._screenMode},function(t){this._screenMode=t}),__getset(0,i,"visible",t.prototype._$get_visible,function(e){if(this.visible!==e){t.prototype._$set_visible.call(this,e);var i=Render._mainCanvas.source.style;i.visibility=e?"visible":"hidden"}}),__getset(0,i,"fullScreenEnabled",null,function(t){var e=Browser.document,i=Render.canvas;t?(i.addEventListener("mousedown",this._requestFullscreen),i.addEventListener("touchstart",this._requestFullscreen),e.addEventListener("fullscreenchange",this._fullScreenChanged),e.addEventListener("mozfullscreenchange",this._fullScreenChanged),e.addEventListener("webkitfullscreenchange",this._fullScreenChanged),e.addEventListener("msfullscreenchange",this._fullScreenChanged)):(i.removeEventListener("mousedown",this._requestFullscreen),i.removeEventListener("touchstart",this._requestFullscreen),e.removeEventListener("fullscreenchange",this._fullScreenChanged),e.removeEventListener("mozfullscreenchange",this._fullScreenChanged),e.removeEventListener("webkitfullscreenchange",this._fullScreenChanged),e.removeEventListener("msfullscreenchange",this._fullScreenChanged))}),e.SCALE_NOSCALE="noscale",e.SCALE_EXACTFIT="exactfit",e.SCALE_SHOWALL="showall",e.SCALE_NOBORDER="noborder",e.SCALE_FULL="full",e.SCALE_FIXED_WIDTH="fixedwidth",e.SCALE_FIXED_HEIGHT="fixedheight",e.SCALE_FIXED_AUTO="fixedauto",e.ALIGN_LEFT="left",e.ALIGN_RIGHT="right",e.ALIGN_CENTER="center",e.ALIGN_TOP="top",e.ALIGN_MIDDLE="middle",e.ALIGN_BOTTOM="bottom",e.SCREEN_NONE="none",e.SCREEN_HORIZONTAL="horizontal",e.SCREEN_VERTICAL="vertical",e.FRAME_FAST="fast",e.FRAME_SLOW="slow",e.FRAME_MOUSE="mouse",e.FRAME_SLEEP="sleep",e}(Sprite),SoundNode=function(t){function e(){this.url=null,this._channel=null,this._tar=null,this._playEvents=null,this._stopEvents=null,e.__super.call(this),this.visible=!1,this.on("added",this,this._onParentChange),this.on("removed",this,this._onParentChange)}__class(e,"laya.media.SoundNode",t);var i=e.prototype;return i._onParentChange=function(){this.target=this.parent},i.play=function(t,e){void 0===t&&(t=1),isNaN(t)&&(t=1),this.url&&(this.stop(),this._channel=SoundManager.playSound(this.url,t,e))},i.stop=function(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null},i._setPlayAction=function(t,e,i,n){void 0===n&&(n=!0),this[i]&&t&&(n?t.on(e,this,this[i]):t.off(e,this,this[i]))},i._setPlayActions=function(t,e,i,n){if(void 0===n&&(n=!0),t&&e){var r=e.split(","),a=0,s=0;for(s=r.length,a=0;s>a;a++)this._setPlayAction(t,r[a],i,n)}},__getset(0,i,"playEvent",null,function(t){this._playEvents=t,t&&this._tar&&this._setPlayActions(this._tar,t,"play")}),__getset(0,i,"target",null,function(t){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=t,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}),__getset(0,i,"stopEvent",null,function(t){this._stopEvents=t,t&&this._tar&&this._setPlayActions(this._tar,t,"stop")}),e}(Sprite),FileBitmap=function(t){function e(){this._src=null,this._onload=null,this._onerror=null,e.__super.call(this)}__class(e,"laya.resource.FileBitmap",t);var i=e.prototype;return __getset(0,i,"src",function(){return this._src},function(t){this._src=t}),__getset(0,i,"onload",null,function(t){}),__getset(0,i,"onerror",null,function(t){}),e}(Bitmap),HTMLCanvas=function(t){function e(t){this._is2D=!1,e.__super.call(this);var i=this;if(this._source=this,"2D"===t||"AUTO"===t&&!Render.isWebGL){this._is2D=!0,this._source=Browser.createElement("canvas");var n=this;n.getContext=function(t,e){if(i._ctx)return i._ctx;var r=i._ctx=i._source.getContext(t,e);return r&&(r._canvas=n,Render.isFlash||(r.size=function(t,e){})),r}}}__class(e,"laya.resource.HTMLCanvas",t);var i=e.prototype;return i.clear=function(){this._ctx&&this._ctx.clear()},i.destroy=function(){this._ctx&&this._ctx.destroy(),this._ctx=null,this.dispose()},i.release=function(){},i._setContext=function(t){this._ctx=t},i.getContext=function(t,i){return this._ctx?this._ctx:this._ctx=e._createContext(this)},i.getMemSize=function(){return 0},i.size=function(t,e){(this._w!=t||this._h!=e||this._source&&(this._source.width!=t||this._source.height!=e))&&(this._w=t,this._h=e,this.memorySize=this._w*this._h*4,this._ctx&&this._ctx.size(t,e),this._source&&(this._source.height=e,this._source.width=t))},i.getCanvas=function(){return this._source},__getset(0,i,"context",function(){return this._ctx}),__getset(0,i,"asBitmap",null,function(t){}),e.create=function(t){return new e(t)},e.TYPE2D="2D",e.TYPE3D="3D",e.TYPEAUTO="AUTO",e._createContext=null,e}(Bitmap),HTMLSubImage=function(t){function e(t,i,n,r,a,s,o,h){throw e.__super.call(this),new Error("不允许new！")}return __class(e,"laya.resource.HTMLSubImage",t),e.create=function(t,i,n,r,a,s,o,h){return void 0===h&&(h=!1),new e(t,i,n,r,a,s,o,h)},e}(Bitmap),Animation=function(t){function e(){this._frames=null,this._url=null,e.__super.call(this),this._setControlNode(this)}__class(e,"laya.display.Animation",t);var i=e.prototype;return i.destroy=function(t){void 0===t&&(t=!0),this.stop(),laya.display.Sprite.prototype.destroy.call(this,t),this._frames=null,this._labels=null},i.play=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=!0),void 0===i&&(i=""),i&&this._setFramesFromCache(i,!0),this._isPlaying=!0,this.index="string"==typeof t?this._getFrameByLabel(t):t,this.loop=e,this._actionName=i,this._isReverse=1==this.wrapMode,this._frames&&this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)},i._setFramesFromCache=function(t,i){if(void 0===i&&(i=!1),this._url&&(t=this._url+"#"+t),t&&e.framesMap[t]){var n;return n=e.framesMap[t],n instanceof Array?(this._frames=e.framesMap[t],this._count=this._frames.length):(n.nodeRoot&&(e.framesMap[t]=this._parseGraphicAnimationByData(n),n=e.framesMap[t]),this._frames=n.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=n.interval),this._labels=this._copyLabels(n.labels)),!0}return i&&console.log("ani not found:",t),!1},i._copyLabels=function(t){if(!t)return null;var e;e={};var i;for(i in t)e[i]=Utils.copyArray([],t[i]);return e},i._frameLoop=function(){this._style.visible&&this._style.alpha>.01&&t.prototype._frameLoop.call(this)},i._displayToIndex=function(t){this._frames&&(this.graphics=this._frames[t])},i.clear=function(){this.stop(),this.graphics=null,this._frames=null,this._labels=null},i.loadImages=function(t,i){return void 0===i&&(i=""),this._url="",this._setFramesFromCache(i)||(this.frames=e.framesMap[i]?e.framesMap[i]:e.createFrames(t,i)),this},i.loadAtlas=function(t,i,n){function r(r){t===r&&(a.frames=e.framesMap[n]?e.framesMap[n]:e.createFrames(t,n),i&&i.run())}void 0===n&&(n=""),this._url="";var a=this;return a._setFramesFromCache(n)||(Loader.getAtlas(t)?r(t):Laya.loader.load(t,Handler.create(null,r,[t]),null,"atlas")),this},i.loadAnimation=function(t,e,i){this._url=t;var n=this;return this._actionName||(this._actionName=""),n._setFramesFromCache("")?(n._setFramesFromCache(this._actionName,!0),e&&e.run()):!i||Loader.getAtlas(i)?this._loadAnimationData(t,e,i):Laya.loader.load(i,Handler.create(this,this._loadAnimationData,[t,e,i]),null,"atlas"),this},i._loadAnimationData=function(t,i,n){function r(n){if(Loader.getRes(n)&&t===n){var r;if(e.framesMap[t+"#"])s._setFramesFromCache(a._actionName,!0),a.index=0,a._checkResumePlaying();else{var o=s._parseGraphicAnimation(Loader.getRes(t));if(!o)return;var h,l=o.animationList,u=0,c=l.length;for(u=0;c>u;u++)r=l[u],e.framesMap[t+"#"+r.name]=r,h||(h=r);h&&(e.framesMap[t+"#"]=h,s._setFramesFromCache(a._actionName,!0),a.index=0),a._checkResumePlaying()}i&&i.run()}}var a=this;if(n&&!Loader.getAtlas(n))return void console.warn("atlas load fail:"+n);var s=this;Loader.getRes(t)?r(t):Laya.loader.load(t,Handler.create(null,r,[t]),null,"json"),Loader.clearRes(t)},i._parseGraphicAnimation=function(t){return GraphicAnimation.parseAnimationData(t)},i._parseGraphicAnimationByData=function(t){return GraphicAnimation.parseAnimationByData(t)},__getset(0,i,"frames",function(){return this._frames},function(t){this._frames=t,t&&(this._count=t.length,this._isPlaying?this.play(this._index,this.loop,this._actionName):this.index=this._index)}),__getset(0,i,"autoPlay",null,function(t){t?this.play():this.stop()}),__getset(0,i,"source",null,function(t){t.indexOf(".ani")>-1?this.loadAnimation(t):t.indexOf(".json")>-1||t.indexOf("als")>-1||t.indexOf("atlas")>-1?this.loadAtlas(t):this.loadImages(t.split(","))}),__getset(0,i,"autoAnimation",null,function(t){this.play(0,!0,t)}),e.createFrames=function(t,i){var n;if("string"==typeof t){var r=Loader.getAtlas(t);if(r&&r.length){n=[];for(var a=0,s=r.length;s>a;a++){var o=new Graphics;o.drawTexture(Loader.getRes(r[a]),0,0),n.push(o)}}}else if(t instanceof Array)for(n=[],a=0,s=t.length;s>a;a++)o=new Graphics,o.loadImage(t[a],0,0),n.push(o);return i&&(e.framesMap[i]=n),n},e.clearCache=function(t){var i,n=e.framesMap,r=t+"#";for(i in n)(i===t||0==i.indexOf(r))&&delete e.framesMap[i]},e.framesMap={},e}(AnimationPlayerBase),FrameAnimation=function(t){function e(){this._targetDic=null,this._animationData=null,this._animationNewFrames=null,e.__super.call(this),null==e._sortIndexFun&&(e._sortIndexFun=MathUtil.sortByKey("index",!1,!0))}__class(e,"laya.display.FrameAnimation",t);var i=e.prototype;return i._setUp=function(t,e){this._labels=null,this._animationNewFrames=null,this._targetDic=t,this._animationData=e,this.interval=1e3/e.frameRate,e.parsed?(this._count=e.count,this._labels=e.labels,this._animationNewFrames=e.animationNewFrames):(this._animationNewFrames=[],this._calculateDatas()),e.parsed=!0,e.labels=this._labels,e.count=this._count,e.animationNewFrames=this._animationNewFrames},i.clear=function(){t.prototype.clear.call(this),this._targetDic=null,this._animationData=null},i._displayToIndex=function(t){if(this._animationData){0>t&&(t=0),t>this._count&&(t=this._count);var e=this._animationData.nodes,i=0,n=e.length;for(i=0;n>i;i++)this._displayNodeToFrame(e[i],t)}},i._displayNodeToFrame=function(t,e,i){i||(i=this._targetDic);var n=i[t.target];if(n){var r,a,s,o=t.frames,h=t.keys,l=0,u=h.length;for(l=0;u>l;l++)r=h[l],a=o[r],s=a.length>e?a[e]:a[a.length-1],n[r]=s}},i._calculateDatas=function(){if(this._animationData){var t,e=this._animationData.nodes,i=0,n=e.length;for(this._count=0,i=0;n>i;i++)t=e[i],this._calculateNodeKeyFrames(t);this._count+=1}},i._calculateNodeKeyFrames=function(t){var i,n,r=t.keyframes,a=t.target;t.frames||(t.frames={}),t.keys?t.keys.length=0:t.keys=[],t.initValues||(t.initValues={});for(i in r)n=r[i],t.frames[i]||(t.frames[i]=[]),this._targetDic&&this._targetDic[a]&&(t.initValues[i]=this._targetDic[a][i]),n.sort(e._sortIndexFun),t.keys.push(i),this._calculateNodePropFrames(n,t.frames[i],i,a)},i.resetToInitState=function(){if(this._targetDic&&this._animationData){var t,e,i=this._animationData.nodes,n=0,r=i.length;
for(n=0;r>n;n++)if(t=i[n],e=t.initValues){var a=this._targetDic[t.target];if(a){var s;for(s in e)a[s]=e[s]}}}},i._calculateNodePropFrames=function(t,e,i,n){var r=0,a=t.length-1;for(e.length=t[a].index+1,r=0;a>r;r++)this._dealKeyFrame(t[r]),this._calculateFrameValues(t[r],t[r+1],e);0==a&&(e[0]=t[0].value,this._animationNewFrames&&(this._animationNewFrames[t[0].index]=!0)),this._dealKeyFrame(t[r])},i._dealKeyFrame=function(t){t.label&&""!=t.label&&this.addLabel(t.label,t.index)},i._calculateFrameValues=function(t,e,i){var n,r=0,a=t.index,s=e.index,o=t.value,h=e.value-t.value,l=s-a;if(s>this._count&&(this._count=s),t.tween)for(n=Ease[t.tweenMethod],null==n&&(n=Ease.linearNone),r=a;s>r;r++)i[r]=n(r-a,o,h,l),this._animationNewFrames&&(this._animationNewFrames[r]=!0);else for(r=a;s>r;r++)i[r]=o;this._animationNewFrames&&(this._animationNewFrames[t.index]=!0,this._animationNewFrames[e.index]=!0),i[e.index]=e.value},e._sortIndexFun=null,e}(AnimationPlayerBase),Input=function(t){function e(){this._focus=!1,this._multiline=!1,this._editable=!0,this._restrictPattern=null,this._type="text",this._prompt="",this._promptColor="#A9A9A9",this._originColor="#000000",this._content="",e.__super.call(this),this._maxChars=1e5,this._width=100,this._height=20,this.multiline=!1,this.overflow=Text.SCROLL,this.on("mousedown",this,this._onMouseDown),this.on("undisplay",this,this._onUnDisplay)}__class(e,"laya.display.Input",t);var i=e.prototype;return i.setSelection=function(t,e){laya.display.Input.inputElement.selectionStart=t,laya.display.Input.inputElement.selectionEnd=e},i._onUnDisplay=function(t){this.focus=!1},i._onMouseDown=function(t){this.focus=!0},i.render=function(t,e,i){laya.display.Sprite.prototype.render.call(this,t,e,i)},i._syncInputTransform=function(){var t=this.nativeInput,i=Utils.getTransformRelativeToWindow(this,this.padding[3],this.padding[0]),n=this._width-this.padding[1]-this.padding[3],r=this._height-this.padding[0]-this.padding[2];Render.isConchApp?(t.setScale(i.scaleX,i.scaleY),t.setSize(n,r),t.setPos(i.x,i.y)):(e.inputContainer.style.transform=e.inputContainer.style.webkitTransform="scale("+i.scaleX+","+i.scaleY+") rotate("+Laya.stage.canvasDegree+"deg)",t.style.width=n+"px",t.style.height=r+"px",e.inputContainer.style.left=i.x+"px",e.inputContainer.style.top=i.y+"px")},i.select=function(){this.nativeInput.select()},i._setInputMethod=function(){e.input.parentElement&&e.inputContainer.removeChild(e.input),e.area.parentElement&&e.inputContainer.removeChild(e.area),e.inputElement=this._multiline?e.area:e.input,e.inputContainer.appendChild(e.inputElement)},i._focusIn=function(){laya.display.Input.isInputting=!0;var t=this.nativeInput;this._focus=!0;var e=t.style;e.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),t.readOnly=!this._editable,Render.isConchApp&&t.setForbidEdit(!this._editable),t.maxLength=this._maxChars;this.padding;t.type=this._type,t.value=this._content,t.placeholder=this._prompt,Laya.stage.off("keydown",this,this._onKeyDown),Laya.stage.on("keydown",this,this._onKeyDown),Laya.stage.focus=this,this.event("focus"),Browser.onPC&&t.focus();this._text;this._text=null,this.typeset(),t.setColor(this._originColor),t.setFontSize(this.fontSize),t.setFontFace(Browser.onIPhone?Text._fontFamilyMap[this.font]||this.font:this.font),Render.isConchApp&&t.setMultiAble&&t.setMultiAble(this._multiline),e.lineHeight=this.leading+this.fontSize+"px",e.fontStyle=this.italic?"italic":"normal",e.fontWeight=this.bold?"bold":"normal",e.textAlign=this.align,e.padding="0 0",this._syncInputTransform(),!Render.isConchApp&&Browser.onPC&&Laya.timer.frameLoop(1,this,this._syncInputTransform)},i._setPromptColor=function(){e.promptStyleDOM=Browser.getElementById("promptStyle"),e.promptStyleDOM||(e.promptStyleDOM=Browser.createElement("style"),e.promptStyleDOM.setAttribute("id","promptStyle"),Browser.document.head.appendChild(e.promptStyleDOM)),e.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"},i._focusOut=function(){laya.display.Input.isInputting=!1,this._focus=!1,this._text=null,this._content=this.nativeInput.value,this._content?(t.prototype._$set_text.call(this,this._content),t.prototype._$set_color.call(this,this._originColor)):(t.prototype._$set_text.call(this,this._prompt),t.prototype._$set_color.call(this,this._promptColor)),Laya.stage.off("keydown",this,this._onKeyDown),Laya.stage.focus=null,this.event("blur"),Render.isConchApp&&this.nativeInput.blur(),Browser.onPC&&Laya.timer.clear(this,this._syncInputTransform)},i._onKeyDown=function(t){13===t.keyCode&&(Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event("enter"))},i.changeText=function(e){this._content=e,this._focus?(this.nativeInput.value=e||"",this.event("change")):t.prototype.changeText.call(this,e)},__getset(0,i,"color",t.prototype._$get_color,function(e){this._focus&&this.nativeInput.setColor(e),t.prototype._$set_color.call(this,this._content?e:this._promptColor),this._originColor=e}),__getset(0,i,"inputElementYAdjuster",function(){return console.warn("deprecated: 由于即使设置了该值，在各平台和浏览器之间也不一定一致，inputElementYAdjuster已弃用。"),0},function(t){console.warn("deprecated: 由于即使设置了该值，在各平台和浏览器之间也不一定一致，inputElementYAdjuster已弃用。")}),__getset(0,i,"multiline",function(){return this._multiline},function(t){this._multiline=t,this.valign=t?"top":"middle"}),__getset(0,i,"maxChars",function(){return this._maxChars},function(t){0>=t&&(t=1e5),this._maxChars=t}),__getset(0,i,"text",function(){return this._focus?this.nativeInput.value:this._content||""},function(e){t.prototype._$set_color.call(this,this._originColor),e+="",this._focus?(this.nativeInput.value=e||"",this.event("change")):(this._multiline||(e=e.replace(/\r?\n/g,"")),this._content=e,e?t.prototype._$set_text.call(this,e):(t.prototype._$set_text.call(this,this._prompt),t.prototype._$set_color.call(this,this.promptColor)))}),__getset(0,i,"nativeInput",function(){return this._multiline?e.area:e.input}),__getset(0,i,"prompt",function(){return this._prompt},function(e){!this._text&&e&&t.prototype._$set_color.call(this,this._promptColor),this.promptColor=this._promptColor,this._text?t.prototype._$set_text.call(this,this._text==this._prompt?e:this._text):t.prototype._$set_text.call(this,e),this._prompt=Text.langPacks&&Text.langPacks[e]?Text.langPacks[e]:e}),__getset(0,i,"focus",function(){return this._focus},function(t){var i=this.nativeInput;this._focus!==t&&(t?(i.target?i.target._focusOut():this._setInputMethod(),i.target=this,this._focusIn()):(i.target=null,this._focusOut(),i.blur(),Render.isConchApp?i.setPos(-1e4,-1e4):e.inputContainer.contains(i)&&e.inputContainer.removeChild(i)))}),__getset(0,i,"restrict",function(){return this._restrictPattern?this._restrictPattern.source:""},function(t){t?(t="[^"+t+"]",t.indexOf("^^")>-1&&(t=t.replace("^^","")),this._restrictPattern=new RegExp(t,"g")):this._restrictPattern=null}),__getset(0,i,"editable",function(){return this._editable},function(t){this._editable=t,Render.isConchApp&&e.input.setForbidEdit(!t)}),__getset(0,i,"promptColor",function(){return this._promptColor},function(e){this._promptColor=e,this._content||t.prototype._$set_color.call(this,e)}),__getset(0,i,"type",function(){return this._type},function(t){"password"==t?this._getCSSStyle().password=!0:this._getCSSStyle().password=!1,this._type=t}),__getset(0,i,"inputElementXAdjuster",function(){return console.warn("deprecated: 由于即使设置了该值，在各平台和浏览器之间也不一定一致，inputElementXAdjuster已弃用。"),0},function(t){console.warn("deprecated: 由于即使设置了该值，在各平台和浏览器之间也不一定一致，inputElementXAdjuster已弃用。")}),__getset(0,i,"asPassword",function(){return this._getCSSStyle().password},function(t){this._getCSSStyle().password=t,this._type="password",console.warn('deprecated: 使用type="password"替代设置asPassword, asPassword将在下次重大更新时删去'),this.isChanged=!0}),e.__init__=function(){e._createInputElement(),Browser.onMobile&&Render.canvas.addEventListener(e.IOS_IFRAME?"click":"touchend",e._popupInputMethod)},e._popupInputMethod=function(t){if(laya.display.Input.isInputting){var e=laya.display.Input.inputElement;e.focus()}},e._createInputElement=function(){e._initInput(e.area=Browser.createElement("textarea")),e._initInput(e.input=Browser.createElement("input")),e.inputContainer=Browser.createElement("div"),e.inputContainer.style.position="absolute",e.inputContainer.style.zIndex=1e5,Browser.container.appendChild(e.inputContainer),e.inputContainer.setPos=function(t,i){e.inputContainer.style.left=t+"px",e.inputContainer.style.top=i+"px"}},e._initInput=function(t){var i=t.style;i.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",i.resize="none",i.backgroundColor="transparent",i.border="none",i.outline="none",i.zIndex=1,t.addEventListener("input",e._processInputting),t.addEventListener("mousemove",e._stopEvent),t.addEventListener("mousedown",e._stopEvent),t.addEventListener("touchmove",e._stopEvent),t.setFontFace=function(e){t.style.fontFamily=e},Render.isConchApp||(t.setColor=function(e){t.style.color=e},t.setFontSize=function(e){t.style.fontSize=e+"px"})},e._processInputting=function(t){var e=laya.display.Input.inputElement.target;if(e){var i=laya.display.Input.inputElement.value;e._restrictPattern&&(i=i.replace(/\u2006|\x27/g,""),e._restrictPattern.test(i)&&(i=i.replace(e._restrictPattern,""),laya.display.Input.inputElement.value=i)),e._text=i,e.event("input")}},e._stopEvent=function(t){"touchmove"==t.type&&t.preventDefault(),t.stopPropagation&&t.stopPropagation()},e.TYPE_TEXT="text",e.TYPE_PASSWORD="password",e.TYPE_EMAIL="email",e.TYPE_URL="url",e.TYPE_NUMBER="number",e.TYPE_RANGE="range",e.TYPE_DATE="date",e.TYPE_MONTH="month",e.TYPE_WEEK="week",e.TYPE_TIME="time",e.TYPE_DATE_TIME="datetime",e.TYPE_DATE_TIME_LOCAL="datetime-local",e.TYPE_SEARCH="search",e.input=null,e.area=null,e.inputElement=null,e.inputContainer=null,e.confirmButton=null,e.promptStyleDOM=null,e.inputHeight=45,e.isInputting=!1,e.stageMatrix=null,__static(e,["IOS_IFRAME",function(){return this.IOS_IFRAME=Browser.onIOS&&Browser.window.top!=Browser.window.self}]),e}(Text),HTMLImage=function(t){function e(t,i){this._recreateLock=!1,this._needReleaseAgain=!1,e.__super.call(this),this._init_(t,i)}__class(e,"laya.resource.HTMLImage",t);var i=e.prototype;return i._init_=function(t,e){this._src=t,this._source=new Browser.window.Image,e&&(e.onload&&(this.onload=e.onload),e.onerror&&(this.onerror=e.onerror),e.onCreate&&e.onCreate(this)),0!=t.indexOf("data:image")&&(this._source.crossOrigin=""),t&&(this._source.src=t)},i.recreateResource=function(){var t=this;if(""===this._src)throw new Error("src no null！");if(this._needReleaseAgain=!1,this._source){if(this._recreateLock)return;this.memorySize=this._w*this._h*4,this._recreateLock=!1,this.completeCreate()}else{this._recreateLock=!0;var e=this;this._source=new Browser.window.Image,this._source.crossOrigin="",this._source.onload=function(){return e._needReleaseAgain?(e._needReleaseAgain=!1,e._source.onload=null,void(e._source=null)):(e._source.onload=null,e.memorySize=t._w*t._h*4,e._recreateLock=!1,void e.completeCreate())},this._source.src=this._src}},i.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(this._source=null,this.memorySize=0)},i.onresize=function(){this._w=this._source.width,this._h=this._source.height},__getset(0,i,"onload",null,function(t){var e=this;this._onload=t,this._source&&(this._source.onload=null!=this._onload?function(){e.onresize(),e._onload()}:null)}),__getset(0,i,"onerror",null,function(t){var e=this;this._onerror=t,this._source&&(this._source.onerror=null!=this._onerror?function(){e._onerror()}:null)}),e.create=function(t,i){return new e(t,i)},e}(FileBitmap),EffectAnimation=function(t){function e(){this._target=null,this._playEvents=null,this._initData={},this._aniKeys=null,this._effectClass=null,e.__super.call(this)}__class(e,"laya.display.EffectAnimation",t);var i=e.prototype;return i._onOtherBegin=function(t){t!=this&&this.stop()},i.addEvent=function(){this._target&&this._playEvents&&(this._setControlNode(this._target),this._target.on(this._playEvents,this,this._onPlayAction))},i._onPlayAction=function(){this._target&&(this._target.event("effectanimationbegin",[this]),this._recordInitData(),this.play(0,!1))},i._recordInitData=function(){if(this._aniKeys){var t=0,e=0;e=this._aniKeys.length;var i;for(t=0;e>t;t++)i=this._aniKeys[t],this._initData[i]=this._target[i]}},i._displayToIndex=function(t){if(this._animationData){0>t&&(t=0),t>this._count&&(t=this._count);var e=this._animationData.nodes,i=0,n=e.length;for(n=n>1?1:n,i=0;n>i;i++)this._displayNodeToFrame(e[i],t)}},i._displayNodeToFrame=function(t,e,i){if(this._target){var n;n=this._target;var r,a,s,o,h=t.frames,l=t.keys,u=0,c=l.length;o=t.secondFrames;var _,d,f,p,m=0;for(u=0;c>u;u++)r=l[u],a=h[r],m=o[r],-1==m?s=this._initData[r]:m>e?(d=t.keyframes[r],f=d[0],f.tween?(_=Ease[f.tweenMethod],null==_&&(_=Ease.linearNone),p=d[1],s=_(e,this._initData[r],p.value-this._initData[r],p.index)):s=this._initData[r]):s=a.length>e?a[e]:a[a.length-1],n[r]=s}},i._calculateNodeKeyFrames=function(e){t.prototype._calculateNodeKeyFrames.call(this,e);var i,n,r,a=e.keyframes;e.target;r={},e.secondFrames=r;for(i in a)n=a[i],n.length<=1?r[i]=-1:r[i]=n[1].index},__getset(0,i,"target",function(){return this._target},function(t){this._target&&this._target.off("effectanimationbegin",this,this._onOtherBegin),this._target=t,this._target&&this._target.on("effectanimationbegin",this,this._onOtherBegin),this.addEvent()}),__getset(0,i,"playEvent",null,function(t){this._playEvents=t,t&&this.addEvent()}),__getset(0,i,"effectData",null,function(t){if(t){var e;e=t.animations,e&&e[0]&&(this._setUp({},e[0]),e[0].nodes&&e[0].nodes[0]&&(this._aniKeys=e[0].nodes[0].keys))}}),__getset(0,i,"effectClass",null,function(t){if(this._effectClass=ClassUtils.getClass(t),this._effectClass){var e;if(e=this._effectClass.uiView){var i;i=e.animations,i&&i[0]&&(this._setUp({},i[0]),i[0].nodes&&i[0].nodes[0]&&(this._aniKeys=i[0].nodes[0].keys))}}}),e.EffectAnimationBegin="effectanimationbegin",e}(FrameAnimation),GraphicAnimation=function(t){function e(){this.animationList=null,this.animationDic=null,this._nodeList=null,this._nodeDefaultProps=null,this._gList=null,this._nodeIDAniDic={},this._rootNode=null,this._nodeGDic=null,e.__super.call(this)}var i;__class(e,"laya.utils.GraphicAnimation",t);var n=e.prototype;return n._parseNodeList=function(t){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[t.compId]=t.props,t.compId&&this._nodeList.push(t.compId);var e=t.child;if(e){var i=0,n=e.length;for(i=0;n>i;i++)this._parseNodeList(e[i])}},n._calGraphicData=function(t){this._setUp(null,t),this._createGraphicData()},n._createGraphicData=function(){var t=[],e=0,i=this.count,n=this._animationNewFrames;n||(n=[]);var r;for(e=0;i>e;e++)(n[e]||!r)&&(r=this._createFrameGraphic(e)),t.push(r);this._gList=t},n._createFrameGraphic=function(t){var i=new Graphics;return e._rootMatrix||(e._rootMatrix=new Matrix),this._updateNodeGraphic(this._rootNode,t,e._rootMatrix,i),i},n._updateNodeGraphic=function(t,e,i,n,r){void 0===r&&(r=1);var a;a=this._nodeGDic[t.compId]=this._getNodeGraphicData(t.compId,e,this._nodeGDic[t.compId]);var s=a.alpha*r;if(!(.01>s)){a.resultTransform||(a.resultTransform=Matrix.create());var o;o=a.resultTransform,Matrix.mul(a.transform,i,o);var h;a.skin&&(h=this._getTextureByUrl(a.skin),h&&(o._checkTransform()?(n.drawTexture(h,0,0,a.width,a.height,o,s),a.resultTransform=null):n.drawTexture(h,o.tx,o.ty,a.width,a.height,null,s)));var l;if(l=t.child){var u=0,c=0;for(c=l.length,u=0;c>u;u++)this._updateNodeGraphic(l[u],e,o,n,s)}}},n._updateNoChilds=function(t,e){if(t.skin){var i=this._getTextureByUrl(t.skin);if(i){var n=t.transform;n._checkTransform();var r=!1;r=!n.bTransform,r?e.drawTexture(i,n.tx,n.ty,t.width,t.height,null,t.alpha):e.drawTexture(i,0,0,t.width,t.height,n.clone(),t.alpha)}}},n._updateNodeGraphic2=function(t,e,i){var n;if(n=this._nodeGDic[t.compId]=this._getNodeGraphicData(t.compId,e,this._nodeGDic[t.compId]),!t.child)return void this._updateNoChilds(n,i);var r=n.transform;r._checkTransform();var a=!1;a=!r.bTransform;var s=!1;s=a&&(0!=r.tx||0!=r.ty);var o=!1;o=r.bTransform||1!=n.alpha,o&&i.save(),1!=n.alpha&&i.alpha(n.alpha),a?s&&i.translate(r.tx,r.ty):i.transform(r.clone());var h;h=t.child;var l;if(n.skin&&(l=this._getTextureByUrl(n.skin),l&&i.drawTexture(l,0,0,n.width,n.height)),h){var u=0,c=0;for(c=h.length,u=0;c>u;u++)this._updateNodeGraphic2(h[u],e,i)}o?i.restore():a?s&&i.translate(-r.tx,-r.ty):i.transform(r.clone().invert())},n._calculateNodeKeyFrames=function(e){t.prototype._calculateNodeKeyFrames.call(this,e),this._nodeIDAniDic[e.target]=e},n.getNodeDataByID=function(t){return this._nodeIDAniDic[t]},n._getParams=function(t,i,n,r){var a=e._temParam;a.length=i.length;var s=0,o=i.length;for(s=0;o>s;s++)a[s]=this._getObjVar(t,i[s][0],n,i[s][1],r);return a},n._getObjVar=function(t,e,i,n,r){if(t.hasOwnProperty(e)){var a=t[e];return i>=a.length&&(i=a.length-1),t[e][i]}return r.hasOwnProperty(e)?r[e]:n},n._getNodeGraphicData=function(t,n,r){r||(r=i.create()),r.transform?r.transform.identity():r.transform=Matrix.create();var a=this.getNodeDataByID(t);if(!a)return r;var s=a.frames,o=this._getParams(s,e._drawTextureCmd,n,this._nodeDefaultProps[t]),h=o[0],l=NaN,u=NaN,c=o[5],_=o[6],d=o[13],f=o[14],p=o[7],m=o[8],g=o[9],y=o[11],x=o[12];l=o[3],u=o[4],(0==l||0==u)&&(h=null),-1==l&&(l=0),-1==u&&(u=0);var v;r.skin=h,r.width=l,r.height=u,h&&(v=this._getTextureByUrl(h),v?(l||(l=v.sourceWidth),u||(u=v.sourceHeight)):console.warn("lost skin:",h,",you may load pics first")),r.alpha=o[10];var S;S=r.transform,0!=d&&(c=d*l),0!=f&&(_=f*u),(0!=c||0!=_)&&S.translate(-c,-_);var T=null;if(g||1!==p||1!==m||y||x){T=e._tempMt,T.identity(),T.bTransform=!0;var E=.0174532922222222*(g-y),w=.0174532922222222*(g+x),b=Math.cos(w),C=Math.sin(w),M=Math.sin(E),D=Math.cos(E);T.a=p*b,T.b=p*C,T.c=-m*M,T.d=m*D,T.tx=T.ty=0}return T&&(S=Matrix.mul(S,T,S)),S.translate(o[1],o[2]),r},n._getTextureByUrl=function(t){return Loader.getRes(t)},n.setAniData=function(t,i){if(t.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t);var n,r={},a=[],s=t.animations,o=0,h=s.length;for(o=0;h>o;o++)if(n=s[o],this._labels=null,(!i||i==n.name)&&n){try{this._calGraphicData(n)}catch(l){console.warn("parse animation fail:"+n.name+",empty animation created"),this._gList=[]}var u={};u.interval=1e3/n.frameRate,u.frames=this._gList,u.labels=this._labels,u.name=n.name,a.push(u),r[n.name]=u}this.animationList=a,this.animationDic=r}e._temParam.length=0},n.parseByData=function(t){var e,i;e=t.nodeRoot,i=t.aniO,delete t.nodeRoot,delete t.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e),this._labels=null;try{this._calGraphicData(i)}catch(n){console.warn("parse animation fail:"+i.name+",empty animation created"),this._gList=[]}var r=t;return r.interval=1e3/i.frameRate,r.frames=this._gList,r.labels=this._labels,r.name=i.name,r},n.setUpAniData=function(t){if(t.animations){var e,i={},n=[],r=t.animations,a=0,s=r.length;for(a=0;s>a;a++)if(e=r[a]){var o={};o.name=e.name,o.aniO=e,o.nodeRoot=t,n.push(o),i[e.name]=o}this.animationList=n,this.animationDic=i}},n._clear=function(){if(this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic){var t,e;for(t in this._nodeGDic)e=this._nodeGDic[t],e&&e.recover()}this._nodeGDic=null},e.parseAnimationByData=function(t){e._I||(e._I=new e);var i;return i=e._I.parseByData(t),e._I._clear(),i},e.parseAnimationData=function(t){e._I||(e._I=new e),e._I.setUpAniData(t);var i;return i={},i.animationList=e._I.animationList,i.animationDic=e._I.animationDic,e._I._clear(),i},e._temParam=[],e._I=null,e._rootMatrix=null,__static(e,["_drawTextureCmd",function(){return this._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]]},"_tempMt",function(){return this._tempMt=new Matrix}]),e.__init$=function(){i=function(){function t(){this.skin=null,this.transform=null,this.resultTransform=null,this.width=NaN,this.height=NaN,this.alpha=1}__class(t,"");var e=t.prototype;return e.recover=function(){this.skin=null,this.width=0,this.height=0,this.alpha=1,this.transform&&(this.transform.destroy(),this.transform=null),this.resultTransform&&(this.resultTransform.destroy(),this.resultTransform=null),Pool.recover("GraphicNode",this)},t.create=function(){return Pool.getItemByClass("GraphicNode",t)},t}()},e}(FrameAnimation);Laya.__init([EventDispatcher,LoaderManager,Render,Browser,Timer,LocalStorage,TimeLine,GraphicAnimation])}(window,document,Laya),function(t,e,i){var n=(i.un,i.uns,i["static"],i["class"]),r=(i.getset,i.__newvec,function(){function t(){}return n(t,"LayaMain"),t}());new r}(window,document,Laya)}).call(window)}).call(exports,function(){return this}())},function(t,e,i){(function(){!function(t,e,i){var n=(i.un,i.uns,i["static"]),r=i["class"],a=i.getset,s=i.__newvec,o=laya.maths.Arith,h=laya.maths.Bezier,l=laya.resource.Bitmap,u=laya.utils.Browser,c=laya.utils.Byte,_=laya.utils.Color,d=(laya.filters.ColorFilter,i.Config),f=laya.resource.Context,p=(laya.events.Event,laya.filters.Filter),m=laya.display.Graphics,g=laya.resource.HTMLCanvas,y=(laya.utils.HTMLChar,laya.resource.HTMLImage),x=laya.resource.HTMLSubImage,v=(laya.utils.Handler,laya.net.Loader,laya.maths.Matrix),S=laya.maths.Point,T=laya.maths.Rectangle,E=laya.renders.Render,w=(laya.renders.RenderContext,laya.renders.RenderSprite),b=laya.resource.Resource,C=laya.resource.ResourceManager,M=laya.utils.RunDriver,D=laya.display.Sprite,A=laya.utils.Stat,R=laya.utils.StringKey,I=(laya.display.css.Style,laya.system.System),P=laya.display.Text,L=laya.resource.Texture,N=(laya.display.css.TransformInfo,laya.net.URL,laya.utils.Utils),O=laya.utils.VectorGraphManager;laya.utils.WordText;i["interface"]("laya.webgl.shapes.IShape"),i["interface"]("laya.webgl.submit.ISubmit"),i["interface"]("laya.webgl.text.ICharSegment"),i["interface"]("laya.webgl.canvas.save.ISaveData"),i["interface"]("laya.webgl.resource.IMergeAtlasBitmap"),i["interface"]("laya.filters.IFilterActionGL","laya.filters.IFilterAction");var V=function(){function t(){}r(t,"laya.filters.webgl.FilterActionGL");var e=t.prototype;return i.imps(e,{"laya.filters.IFilterActionGL":!0}),e.setValue=function(t){},e.setValueMix=function(t){},e.apply3d=function(t,e,i,n,r){return null},e.apply=function(t){return null},a(0,e,"typeMix",function(){return 0}),t}(),F=function(){function t(){}return r(t,"laya.webgl.shader.ShaderValue"),t}(),B=function(){function t(t,e,n){this._atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._failSize=new i,void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this._cells=null,this._rowInfo=null,this._init(t,e),this._atlasID=n}var e,i;r(t,"laya.webgl.atlas.AtlasGrid");var n=t.prototype;return n.getAltasID=function(){return this._atlasID},n.setAltasID=function(t){t>=0&&(this._atlasID=t)},n.addTex=function(t,e,i){var n=this._get(e,i);return 0==n.ret?n:(this._fill(n.x,n.y,e,i,t),this._texCount++,n)},n._release=function(){null!=this._cells&&(this._cells.length=0,this._cells=null),this._rowInfo&&(this._rowInfo.length=0,this._rowInfo=null)},n._init=function(t,i){if(this._width=t,this._height=i,this._release(),0==this._width)return!1;this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=s(this._height);for(var n=0;n<this._height;n++)this._rowInfo[n]=new e;return this._clear(),!0},n._get=function(t,e){var i=new k;if(t>=this._failSize.width&&e>=this._failSize.height)return i;for(var n=-1,r=-1,a=this._width,s=this._height,o=this._cells,h=0;s>h;h++)if(!(this._rowInfo[h].spaceCount<t))for(var l=0;a>l;){var u=3*(h*a+l);if(0!=o[u]||o[u+1]<t||o[u+2]<e)l+=o[u+1];else{n=l,r=h;for(var c=0;t>c;c++)if(o[3*c+u+2]<e){n=-1;break}if(!(0>n))return i.ret=!0,i.x=n,i.y=r,i;l+=o[u+1]}}return i},n._fill=function(t,e,i,n,r){var a=this._width,s=this._height;this._check(a>=t+i&&s>=e+n);for(var o=e;n+e>o;++o){this._check(this._rowInfo[o].spaceCount>=i),this._rowInfo[o].spaceCount-=i;for(var h=0;i>h;h++){var l=3*(t+o*a+h);this._check(0==this._cells[l]),this._cells[l]=r,this._cells[l+1]=i,this._cells[l+2]=n}}if(t>0)for(o=0;n>o;++o){var u=0;for(h=t-1;h>=0&&0==this._cells[3*((e+o)*a+h)];--h,++u);for(h=u;h>0;--h)this._cells[3*((e+o)*a+t-h)+1]=h,this._check(h>0)}if(e>0)for(h=t;t+i>h;++h){for(u=0,o=e-1;o>=0&&0==this._cells[3*(h+o*a)];--o,u++);for(o=u;o>0;--o)this._cells[3*(h+(e-o)*a)+2]=o,this._check(o>0)}},n._check=function(t){0==t&&console.log("xtexMerger 错误啦")},n._clear=function(){this._texCount=0;for(var t=0;t<this._height;t++)this._rowInfo[t].spaceCount=this._width;for(var e=0;e<this._height;e++)for(var i=0;i<this._width;i++){var n=3*(e*this._width+i);this._cells[n]=0,this._cells[n+1]=this._width-i,this._cells[n+2]=this._width-e}this._failSize.width=this._width+1,this._failSize.height=this._height+1},t.__init$=function(){e=function(){function t(){this.spaceCount=0}return r(t,""),t}(),i=function(){function t(){this.width=0,this.height=0}return r(t,""),t}()},t}(),U=function(){function t(t,e,i,n){this._currentAtlasCount=0,this._maxAtlaserCount=0,this._width=0,this._height=0,this._gridSize=0,this._gridNumX=0,this._gridNumY=0,this._init=!1,this._curAtlasIndex=0,this._setAtlasParam=!1,this._atlaserArray=null,this._needGC=!1,this._setAtlasParam=!0,this._width=t,this._height=e,this._gridSize=i,this._maxAtlaserCount=n,this._gridNumX=t/i,this._gridNumY=e/i,this._curAtlasIndex=0,this._atlaserArray=[]}r(t,"laya.webgl.atlas.AtlasResourceManager");var e=t.prototype;return e.setAtlasParam=function(e,i,n,r){if(1==this._setAtlasParam)return t._sid_=0,this._width=e,this._height=i,this._gridSize=n,this._maxAtlaserCount=r,this._gridNumX=e/n,this._gridNumY=i/n,this._curAtlasIndex=0,this.freeAll(),!0;throw console.log("设置大图合集参数错误，只能在开始页面设置各种参数"),-1},e.pushData=function(e){var i=e.bitmap,n=-1,r=null,a=0,s=0,o=0;for(a=0,s=this._atlaserArray.length;s>a&&(o=(this._curAtlasIndex+a)%s,r=this._atlaserArray[o],n=r.findBitmapIsExist(i),-1==n);a++);if(-1!=n){var h=r.InAtlasWebGLImagesOffsetValue[n];return p=h[0],m=h[1],r.addToAtlas(e,p,m),!0}this._setAtlasParam=!1;for(var l=Math.ceil((e.bitmap.width+2)/this._gridSize),u=Math.ceil((e.bitmap.height+2)/this._gridSize),c=!1,_=0;2>_;_++){var d=this._maxAtlaserCount;for(a=0;d>a;a++){o=(this._curAtlasIndex+a)%d,this._atlaserArray.length-1>=o||this._atlaserArray.push(new Et(this._gridNumX,this._gridNumY,this._width,this._height,t._sid_++));var f=this._atlaserArray[o],p=0,m=0,g=f.addTex(1,l,u);if(g.ret){p=g.x*this._gridSize+1,m=g.y*this._gridSize+1,i.lock=!0,f.addToAtlasTexture(i,p,m),f.addToAtlas(e,p,m),c=!0,this._curAtlasIndex=o;break}}if(c)break;this._atlaserArray.push(new Et(this._gridNumX,this._gridNumY,this._width,this._height,t._sid_++)),this._needGC=!0,this.garbageCollection(),this._curAtlasIndex=this._atlaserArray.length-1}return c||console.log(">>>AtlasManager pushData error"),c},e.addToAtlas=function(t){laya.webgl.atlas.AtlasResourceManager.instance.pushData(t)},e.garbageCollection=function(){if(this._needGC===!0){for(var t=this._atlaserArray.length-this._maxAtlaserCount,e=0;t>e;e++)this._atlaserArray[e].dispose(),console.log("AtlasResourceManager:Dispose the inner Atlas。");console.log(">>>>altas garbageCollection ="+t),this._atlaserArray.splice(0,t),this._needGC=!1}return!0},e.freeAll=function(){for(var t=0,e=this._atlaserArray.length;e>t;t++)this._atlaserArray[t].dispose();this._atlaserArray.length=0,this._curAtlasIndex=0},e.getAtlaserCount=function(){return this._atlaserArray.length},e.getAtlaserByIndex=function(t){return this._atlaserArray[t]},a(1,t,"instance",function(){return t._Instance||(t._Instance=new t(laya.webgl.atlas.AtlasResourceManager.atlasTextureWidth,laya.webgl.atlas.AtlasResourceManager.atlasTextureHeight,16,laya.webgl.atlas.AtlasResourceManager.maxTextureCount)),t._Instance}),a(1,t,"enabled",function(){return t._enabled}),a(1,t,"atlasLimitWidth",function(){return t._atlasLimitWidth},function(e){t._atlasLimitWidth=e}),a(1,t,"atlasLimitHeight",function(){return t._atlasLimitHeight},function(e){t._atlasLimitHeight=e}),t._enable=function(){t._enabled=!0,d.atlasEnable=!0},t._disable=function(){t._enabled=!1,d.atlasEnable=!1},t.__init__=function(){t.atlasTextureWidth=2048,t.atlasTextureHeight=2048,t.maxTextureCount=6,t.atlasLimitWidth=512,t.atlasLimitHeight=512},t._enabled=!1,t._atlasLimitWidth=0,t._atlasLimitHeight=0,t.gridSize=16,t.atlasTextureWidth=0,t.atlasTextureHeight=0,t.maxTextureCount=0,t._atlasRestore=0,t.BOARDER_TYPE_NO=0,t.BOARDER_TYPE_RIGHT=1,t.BOARDER_TYPE_LEFT=2,t.BOARDER_TYPE_BOTTOM=4,t.BOARDER_TYPE_TOP=8,t.BOARDER_TYPE_ALL=15,t._sid_=0,t._Instance=null,t}(),k=function(){function t(){this.x=0,this.y=0,this.ret=!1,this.ret=!1,this.x=0,this.y=0}return r(t,"laya.webgl.atlas.MergeFillInfo"),t}(),H=function(){function t(){}return r(t,"laya.webgl.canvas.BlendMode"),t._init_=function(e){t.fns=[t.BlendNormal,t.BlendAdd,t.BlendMultiply,t.BlendScreen,t.BlendOverlay,t.BlendLight,t.BlendMask,t.BlendDestinationOut],t.targetFns=[t.BlendNormalTarget,t.BlendAddTarget,t.BlendMultiplyTarget,t.BlendScreenTarget,t.BlendOverlayTarget,t.BlendLightTarget,t.BlendMask,t.BlendDestinationOut]},t.BlendNormal=function(t){t.blendFunc(1,771)},t.BlendAdd=function(t){t.blendFunc(1,772)},t.BlendMultiply=function(t){t.blendFunc(774,771)},t.BlendScreen=function(t){t.blendFunc(1,1)},t.BlendOverlay=function(t){t.blendFunc(1,769)},t.BlendLight=function(t){t.blendFunc(1,1)},t.BlendNormalTarget=function(t){t.blendFunc(1,771)},t.BlendAddTarget=function(t){t.blendFunc(1,772)},t.BlendMultiplyTarget=function(t){t.blendFunc(774,771)},t.BlendScreenTarget=function(t){t.blendFunc(1,1)},t.BlendOverlayTarget=function(t){t.blendFunc(1,769)},t.BlendLightTarget=function(t){t.blendFunc(1,1)},t.BlendMask=function(t){t.blendFunc(0,770)},t.BlendDestinationOut=function(t){t.blendFunc(0,0)},t.activeBlendFunction=null,t.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out"],t.TOINT={normal:0,add:1,multiply:2,screen:3,lighter:1,overlay:4,light:5,mask:6,"destination-out":7},t.NORMAL="normal",t.ADD="add",t.MULTIPLY="multiply",t.SCREEN="screen",t.LIGHT="light",t.OVERLAY="overlay",t.DESTINATIONOUT="destination-out",t.fns=[],t.targetFns=[],t}(),z=function(){function t(t){this._color=_.create("black"),this.setValue(t)}r(t,"laya.webgl.canvas.DrawStyle");var e=t.prototype;return e.setValue=function(t){if(t){if("string"==typeof t)return void(this._color=_.create(t));if(t instanceof laya.utils.Color)return void(this._color=t)}},e.reset=function(){this._color=_.create("black")},e.equal=function(t){return"string"==typeof t?this._color.strColor===t:t instanceof laya.utils.Color?this._color.numColor===t.numColor:!1},e.toColorStr=function(){return this._color.strColor},t.create=function(e){if(e){var i;if("string"==typeof e?i=_.create(e):e instanceof laya.utils.Color&&(i=e),i)return i._drawStyle||(i._drawStyle=new t(e))}return null},n(t,["DEFAULT",function(){return this.DEFAULT=new t("#000000")}]),t}(),W=function(){function t(){this._x=0,this._y=0,this.dirty=!1,this.offset=0,this.count=0,this.geoStart=0,this.tempArray=[],this.closePath=!1,this.geomatrys=[];mt.mainContext;this.ib=Xt.create(35048),this.vb=qt.create(5)}r(t,"laya.webgl.canvas.Path");var e=t.prototype;return e.addPoint=function(t,e){this.tempArray.push(t,e)},e.getEndPointX=function(){return this.tempArray[this.tempArray.length-2]},e.getEndPointY=function(){
return this.tempArray[this.tempArray.length-1]},e.polygon=function(t,e,i,n,r,a){var s;return this.geomatrys.push(this._curGeomatry=s=new Mt(t,e,i,n,r,a)),n||(s.fill=!1),void 0==a&&(s.borderWidth=0),s},e.setGeomtry=function(t){this.geomatrys.push(this._curGeomatry=t)},e.drawLine=function(t,e,i,n,r){var a;return this.closePath?this.geomatrys.push(this._curGeomatry=a=new Ct(t,e,i,n,r)):this.geomatrys.push(this._curGeomatry=a=new bt(t,e,i,n,r)),a.fill=!1,a},e.update=function(){var t=this.ib.byteLength,e=this.geomatrys.length;this.offset=t;for(var i=this.geoStart;e>i;i++)this.geomatrys[i].getData(this.ib,this.vb,this.vb.byteLength/20);this.geoStart=e,this.count=(this.ib.byteLength-t)/_t.BYTES_PIDX},e.reset=function(){this.vb.clear(),this.ib.clear(),this.offset=this.count=this.geoStart=0,this.geomatrys.length=0},e.recover=function(){this._curGeomatry=null,this.vb.destory(),this.vb=null,this.ib.destory(),this.ib=null},t}(),G=function(){function t(){}r(t,"laya.webgl.canvas.save.SaveBase");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){this._dataObj[this._valueName]=this._value,t._cache[t._cache._length++]=this,this._newSubmit&&(e._curSubmit=it.RENDERBASE,e._renderKey=0)},t._createArray=function(){var t=[];return t._length=0,t},t._init=function(){var e=t._namemap={};return e[1]="ALPHA",e[2]="fillStyle",e[8]="font",e[256]="lineWidth",e[512]="strokeStyle",e[8192]="_mergeID",e[1024]=e[2048]=e[4096]=[],e[16384]="textBaseline",e[32768]="textAlign",e[65536]="_nBlendType",e[1048576]="shader",e[2097152]="filters",e},t.save=function(e,i,n,r){if((e._saveMark._saveuse&i)!==i){e._saveMark._saveuse|=i;var a=t._cache,s=a._length>0?a[--a._length]:new t;s._value=n[s._valueName=t._namemap[i]],s._dataObj=n,s._newSubmit=r;var o=e._save;o[o._length++]=s}},t._cache=laya.webgl.canvas.save.SaveBase._createArray(),t._namemap=t._init(),t}(),j=function(){function t(){this._clipRect=new T}r(t,"laya.webgl.canvas.save.SaveClipRect");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._clipRect=this._clipSaveRect,t._cache[t._cache._length++]=this,this._submitScissor.submitLength=e._submits._length-this._submitScissor.submitIndex,e._curSubmit=it.RENDERBASE,e._renderKey=0},t.save=function(e,i){if(131072!=(131072&e._saveMark._saveuse)){e._saveMark._saveuse|=131072;var n=t._cache,r=n._length>0?n[--n._length]:new t;r._clipSaveRect=e._clipRect,e._clipRect=r._clipRect.copyFrom(e._clipRect),r._submitScissor=i;var a=e._save;a[a._length++]=r}},t._cache=G._createArray(),t}(),Y=function(){function t(){this._clipRect=new T}r(t,"laya.webgl.canvas.save.SaveClipRectStencil");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._clipRect=this._clipSaveRect,t._cache[t._cache._length++]=this,e._curSubmit=it.RENDERBASE;var i=ot.create(3);e.addRenderObject(i),e._renderKey=0},t.save=function(e,i){if(262144!=(262144&e._saveMark._saveuse)){e._saveMark._saveuse|=262144;var n=t._cache,r=n._length>0?n[--n._length]:new t;r._clipSaveRect=e._clipRect,e._clipRect=r._clipRect.copyFrom(e._clipRect),r._submitStencil=i;var a=e._save;a[a._length++]=r}},t._cache=G._createArray(),t}(),X=function(){function t(){this._saveuse=0}r(t,"laya.webgl.canvas.save.SaveMark");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!0},e.restore=function(e){e._saveMark=this._preSaveMark,t._no[t._no._length++]=this},t.Create=function(e){var i=t._no,n=i._length>0?i[--i._length]:new t;return n._saveuse=0,n._preSaveMark=e._saveMark,e._saveMark=n,n},t._no=G._createArray(),t}(),q=function(){function t(){this._matrix=new v}r(t,"laya.webgl.canvas.save.SaveTransform");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._curMat=this._savematrix,t._no[t._no._length++]=this},t.save=function(e){var i=e._saveMark;if(2048!==(2048&i._saveuse)){i._saveuse|=2048;var n=t._no,r=n._length>0?n[--n._length]:new t;r._savematrix=e._curMat,e._curMat=e._curMat.copyTo(r._matrix);var a=e._save;a[a._length++]=r}},t._no=G._createArray(),t}(),K=function(){function t(){}r(t,"laya.webgl.canvas.save.SaveTranslate");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._curMat;e._x=this._x,e._y=this._y,t._no[t._no._length++]=this},t.save=function(e){var i=t._no,n=i._length>0?i[--i._length]:new t;n._x=e._x,n._y=e._y;var r=e._save;r[r._length++]=n},t._no=G._createArray(),t}(),Z=function(){function t(){this.target=null,this.repaint=!1,this._width=NaN,this._height=NaN,this._sp=null,this._clipRect=new T}r(t,"laya.webgl.resource.RenderTargetMAX");var e=t.prototype;return e.setSP=function(t){this._sp=t},e.size=function(t,e){var n=this;return this._width===t&&this._height===e?void this.target.size(t,e):(this.repaint=!0,this._width=t,this._height=e,this.target?this.target.size(t,e):this.target=It.create(t,e),void(this.target.hasListener("recovered")||this.target.on("recovered",this,function(t){i.timer.callLater(n._sp,n._sp.repaint)})))},e._flushToTarget=function(t,e){if(!e._destroy){var i=ft.worldScissorTest,n=ft.worldClipRect;ft.worldClipRect=this._clipRect,this._clipRect.x=this._clipRect.y=0,this._clipRect.width=this._width,this._clipRect.height=this._height,ft.worldScissorTest=!1,mt.mainContext.disable(3089);var r=ft.worldAlpha,a=ft.worldMatrix4,s=ft.worldMatrix,o=ft.worldFilters,h=ft.worldShaderDefines;if(ft.worldMatrix=v.EMPTY,ft.restoreTempArray(),ft.worldMatrix4=ft.TEMPMAT4_ARRAY,ft.worldAlpha=1,ft.worldFilters=null,ft.worldShaderDefines=null,Rt.activeShader=null,e.start(),d.showCanvasMark?e.clear(0,1,0,.3):e.clear(0,0,0,0),t.flush(),e.end(),Rt.activeShader=null,ft.worldAlpha=r,ft.worldMatrix4=a,ft.worldMatrix=s,ft.worldFilters=o,ft.worldShaderDefines=h,ft.worldScissorTest=i,i){var l=ft.height-n.y-n.height;mt.mainContext.scissor(n.x,l,n.width,n.height),mt.mainContext.enable(3089)}ft.worldClipRect=n}},e.flush=function(t){this.repaint&&(this._flushToTarget(t,this.target),this.repaint=!1)},e.drawTo=function(t,e,i,n,r){t.drawTexture(this.target.getTexture(),e,i,n,r,0,0)},e.destroy=function(){this.target&&(this.target.destroy(),this.target=null,this._sp=null)},t}(),$=function(){function t(){this.ALPHA=1,this.shaderType=0,this.defines=new wt}return r(t,"laya.webgl.shader.d2.Shader2D"),t.__init__=function(){Wt.addInclude("parts/ColorFilter_ps_uniform.glsl","uniform vec4 colorAlpha;\nuniform mat4 colorMat;"),Wt.addInclude("parts/ColorFilter_ps_logic.glsl","gl_FragColor = gl_FragColor * colorMat + colorAlpha/255.0;"),Wt.addInclude("parts/GlowFilter_ps_uniform.glsl","uniform vec4 u_color;\nuniform float u_strength;\nuniform float u_blurX;\nuniform float u_blurY;\nuniform float u_offsetX;\nuniform float u_offsetY;\nuniform float u_textW;\nuniform float u_textH;"),Wt.addInclude("parts/GlowFilter_ps_logic.glsl","const float c_IterationTime = 10.0;\nfloat floatIterationTotalTime = c_IterationTime * c_IterationTime;\nvec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\nvec2 vec2FilterDir = vec2(-(u_offsetX)/u_textW,-(u_offsetY)/u_textH);\nvec2 vec2FilterOff = vec2(u_blurX/u_textW/c_IterationTime * 2.0,u_blurY/u_textH/c_IterationTime * 2.0);\nfloat maxNum = u_blurX * u_blurY;\nvec2 vec2Off = vec2(0.0,0.0);\nfloat floatOff = c_IterationTime/2.0;\nfor(float i = 0.0;i<=c_IterationTime; ++i){\n	for(float j = 0.0;j<=c_IterationTime; ++j){\n		vec2Off = vec2(vec2FilterOff.x * (i - floatOff),vec2FilterOff.y * (j - floatOff));\n		vec4Color += texture2D(texture, v_texcoord + vec2FilterDir + vec2Off)/floatIterationTotalTime;\n	}\n}\ngl_FragColor = vec4(u_color.rgb,vec4Color.a * u_strength);\ngl_FragColor.rgb *= gl_FragColor.a;"),Wt.addInclude("parts/BlurFilter_ps_logic.glsl","gl_FragColor =   blur();\ngl_FragColor.w*=alpha;"),Wt.addInclude("parts/BlurFilter_ps_uniform.glsl","uniform vec4 strength_sig2_2sig2_gauss1;\nuniform vec2 blurInfo;\n\n#define PI 3.141593\n\n//float sigma=strength/3.0;//3σ以外影响很小。即当σ=1的时候，半径为3\n//float sig2 = sigma*sigma;\n//float _2sig2 = 2.0*sig2;\n//return 1.0/(2*PI*sig2)*exp(-(x*x+y*y)/_2sig2)\n//float gauss1 = 1.0/(2.0*PI*sig2);\n\nfloat getGaussian(float x, float y){\n    return strength_sig2_2sig2_gauss1.w*exp(-(x*x+y*y)/strength_sig2_2sig2_gauss1.z);\n}\n\nvec4 blur(){\n    const float blurw = 9.0;\n    vec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\n    vec2 halfsz=vec2(blurw,blurw)/2.0/blurInfo;    \n    vec2 startpos=v_texcoord-halfsz;\n    vec2 ctexcoord = startpos;\n    vec2 step = 1.0/blurInfo;  //每个像素      \n    \n    for(float y = 0.0;y<=blurw; ++y){\n        ctexcoord.x=startpos.x;\n        for(float x = 0.0;x<=blurw; ++x){\n            //TODO 纹理坐标的固定偏移应该在vs中处理\n            vec4Color += texture2D(texture, ctexcoord)*getGaussian(x-blurw/2.0,y-blurw/2.0);\n            ctexcoord.x+=step.x;\n        }\n        ctexcoord.y+=step.y;\n    }\n    return vec4Color;\n}"),Wt.addInclude("parts/ColorAdd_ps_uniform.glsl","uniform vec4 colorAdd;\n"),Wt.addInclude("parts/ColorAdd_ps_logic.glsl","gl_FragColor = vec4(colorAdd.rgb,colorAdd.a*gl_FragColor.a);\ngl_FragColor.xyz *= colorAdd.a;");var t,e;t="attribute vec4 position;\nattribute vec2 texcoord;\nuniform vec2 size;\n\n#ifdef WORLDMAT\nuniform mat4 mmat;\n#endif\nvarying vec2 v_texcoord;\nvoid main() {\n  #ifdef WORLDMAT\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  #else\n  gl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\n  #endif\n  \n  v_texcoord = texcoord;\n}",e='precision mediump float;\n//precision highp float;\nvarying vec2 v_texcoord;\nuniform sampler2D texture;\nuniform float alpha;\n#include?BLUR_FILTER  "parts/BlurFilter_ps_uniform.glsl";\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\n#include?GLOW_FILTER "parts/GlowFilter_ps_uniform.glsl";\n#include?COLOR_ADD "parts/ColorAdd_ps_uniform.glsl";\n\nvoid main() {\n   vec4 color= texture2D(texture, v_texcoord);\n   color.a*=alpha;\n   color.rgb*=alpha;\n   gl_FragColor=color;\n   #include?COLOR_ADD "parts/ColorAdd_ps_logic.glsl";   \n   #include?BLUR_FILTER  "parts/BlurFilter_ps_logic.glsl";\n   #include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n   #include?GLOW_FILTER "parts/GlowFilter_ps_logic.glsl";\n}',Wt.preCompile2D(0,1,t,e,null),t="attribute vec4 position;\nuniform vec2 size;\nuniform mat4 mmat;\nvoid main() {\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n}",e='precision mediump float;\nuniform vec4 color;\nuniform float alpha;\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\nvoid main() {\n	vec4 a = vec4(color.r, color.g, color.b, color.a);\n	a.w = alpha;\n	a.xyz *= alpha;\n	gl_FragColor = a;\n	#include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n}',Wt.preCompile2D(0,2,t,e,null),t="attribute vec4 position;\nattribute vec3 a_color;\nuniform mat4 mmat;\nuniform mat4 u_mmat2;\nuniform vec2 u_pos;\nuniform vec2 size;\nvarying vec3 color;\nvoid main(){\n  vec4 tPos = vec4(position.x + u_pos.x,position.y + u_pos.y,position.z,position.w);\n  vec4 pos=mmat*u_mmat2*tPos;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  color=a_color;\n}",e="precision mediump float;\n//precision mediump float;\nvarying vec3 color;\nuniform float alpha;\nvoid main(){\n	//vec4 a=vec4(color.r, color.g, color.b, 1);\n	//a.a*=alpha;\n    gl_FragColor=vec4(color.r, color.g, color.b, alpha);\n	gl_FragColor.rgb*=alpha;\n}",Wt.preCompile2D(0,4,t,e,null),t="attribute vec4 position;\nattribute vec2 texcoord;\nuniform vec2 size;\n\n#ifdef WORLDMAT\nuniform mat4 mmat;\n#endif\nvarying vec2 v_texcoord;\nvoid main() {\n  #ifdef WORLDMAT\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  #else\n  gl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\n  #endif\n  \n  v_texcoord = texcoord;\n}",e='#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n//precision highp float;\nvarying vec2 v_texcoord;\nuniform sampler2D texture;\nuniform float alpha;\nuniform vec4 u_TexRange;\nuniform vec2 u_offset;\n#include?BLUR_FILTER  "parts/BlurFilter_ps_uniform.glsl";\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\n#include?GLOW_FILTER "parts/GlowFilter_ps_uniform.glsl";\n#include?COLOR_ADD "parts/ColorAdd_ps_uniform.glsl";\n\nvoid main() {\n   vec2 newTexCoord;\n   newTexCoord.x = mod(u_offset.x + v_texcoord.x,u_TexRange.y) + u_TexRange.x;\n   newTexCoord.y = mod(u_offset.y + v_texcoord.y,u_TexRange.w) + u_TexRange.z;\n   vec4 color= texture2D(texture, newTexCoord);\n   color.a*=alpha;\n   gl_FragColor=color;\n   #include?COLOR_ADD "parts/ColorAdd_ps_logic.glsl";   \n   #include?BLUR_FILTER  "parts/BlurFilter_ps_logic.glsl";\n   #include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n   #include?GLOW_FILTER "parts/GlowFilter_ps_logic.glsl";\n}',Wt.preCompile2D(0,256,t,e,null),t="attribute vec2 position;\nattribute vec2 texcoord;\nattribute vec4 color;\nuniform vec2 size;\nuniform float offsetX;\nuniform float offsetY;\nuniform mat4 mmat;\nuniform mat4 u_mmat2;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nvoid main() {\n  vec4 pos=mmat*u_mmat2*vec4(offsetX+position.x,offsetY+position.y,0,1 );\n  gl_Position = vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  v_color = color;\n  v_texcoord = texcoord;  \n}",e="precision mediump float;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nuniform sampler2D texture;\nuniform float alpha;\nvoid main() {\n	vec4 t_color = texture2D(texture, v_texcoord);\n	gl_FragColor = t_color.rgba * v_color;\n	gl_FragColor.a = gl_FragColor.a * alpha;\n}",Wt.preCompile2D(0,512,t,e,null)},t}(),Q=function(){function t(t,e,i){this._value=0,this._name2int=t,this._int2name=e,this._int2nameMap=i}r(t,"laya.webgl.shader.ShaderDefines");var e=t.prototype;return e.add=function(t){return"string"==typeof t&&(t=this._name2int[t]),this._value|=t,this._value},e.addInt=function(t){return this._value|=t,this._value},e.remove=function(t){return"string"==typeof t&&(t=this._name2int[t]),this._value&=~t,this._value},e.isDefine=function(t){return(this._value&t)===t},e.getValue=function(){return this._value},e.setValue=function(t){this._value=t},e.toNameDic=function(){var e=this._int2nameMap[this._value];return e?e:t._toText(this._value,this._int2name,this._int2nameMap)},t._reg=function(t,e,i,n){i[t]=e,n[e]=t},t._toText=function(t,e,i){var n=i[t];if(n)return n;for(var r={},a=1,s=0;32>s&&(a=1<<s,!(a>t));s++)if(t&a){var o=e[a];o&&(r[o]="")}return i[t]=r,r},t._toInt=function(t,e){for(var i=t.split("."),n=0,r=0,a=i.length;a>r;r++){var s=e[i[r]];if(!s)throw new Error("Defines to int err:"+t+"/"+i[r]);n|=s}return n},t}(),J=function(){function t(){this.mVBBuffer=null,this.mIBBuffer=null,this.mVBData=null,this.mIBData=null,this.mEleNum=0,this.mTexture=null,this.transform=null,this._vs=null,this._ps=null,this._indexStart=-1,this._verticles=null,this._uvs=null,this._tempMatrix=new v}r(t,"laya.webgl.shader.d2.skinAnishader.SkinMesh");var e=t.prototype;return e.init=function(e,i,n){if(i)this._vs=i;else{this._vs=[];var r=e.width,a=e.height,s=1,o=1,h=1,l=1;this._vs.push(0,0,0,0,s,o,h,l),this._vs.push(r,0,1,0,s,o,h,l),this._vs.push(r,a,1,1,s,o,h,l),this._vs.push(0,a,0,1,s,o,h,l)}n?this._ps=n:(t._defaultPS||(t._defaultPS=[],t._defaultPS.push(0,1,3,3,1,2)),this._ps=t._defaultPS),this.mVBData=new Float32Array(this._vs),this.mIBData=new Uint16Array(this._ps.length),this.mIBData.start=-1,this.mEleNum=this._ps.length,this.mTexture=e},e.init2=function(t,e,i,n,r){this.transform&&(this.transform=null),i?this._ps=i:(this._ps=[],this._ps.push(0,1,3,3,1,2)),this._verticles=n,this._uvs=r,this.mEleNum=this._ps.length,this.mTexture=t,(E.isConchNode||E.isConchApp)&&(this._initMyData(),this.mVBData=new Float32Array(this._vs))},e._initMyData=function(){var e=0,i=0,n=this._verticles.length,r=4*n;this._vs=t._tempVS;var a=!1;if(E.isConchNode||E.isConchApp?(this._vs.length=r,a=!0):this._vs.length<r&&(this._vs.length=r,a=!0),t._tVSLen=r,a)for(;r>e;)this._vs[e]=this._verticles[i],this._vs[e+1]=this._verticles[i+1],this._vs[e+2]=this._uvs[i],this._vs[e+3]=this._uvs[i+1],this._vs[e+4]=1,this._vs[e+5]=1,this._vs[e+6]=1,this._vs[e+7]=1,e+=8,i+=2;else for(;r>e;)this._vs[e]=this._verticles[i],this._vs[e+1]=this._verticles[i+1],this._vs[e+2]=this._uvs[i],this._vs[e+3]=this._uvs[i+1],e+=8,i+=2},e.getData2=function(e,i,n){this.mVBBuffer=e,this.mIBBuffer=i,this._initMyData(),e.appendEx2(this._vs,Float32Array,t._tVSLen,4),this._indexStart=i.byteLength;var r;r=t._tempIB,r.length<this._ps.length&&(r.length=this._ps.length);for(var a=0,s=this._ps.length;s>a;a++)r[a]=this._ps[a]+n;i.appendEx2(r,Uint16Array,this._ps.length,2)},e.getData=function(t,e,i){if(this.mVBBuffer=t,this.mIBBuffer=e,t.append(this.mVBData),this._indexStart=e.byteLength,this.mIBData.start!=i){for(var n=0,r=this._ps.length;r>n;n++)this.mIBData[n]=this._ps[n]+i;this.mIBData.start=i}e.append(this.mIBData)},e.render=function(t,e,i){if(E.isWebGL&&this.mTexture){t._renderKey=0,t._shader2D.glTexture=null,tt.getInstance().addSkinMesh(this);var n=it.createShape(t,this.mIBBuffer,this.mVBBuffer,this.mEleNum,this._indexStart,vt.create(512,0));this.transform||(this.transform=v.EMPTY),this.transform.translate(e,i),v.mul(this.transform,t._curMat,this._tempMatrix),this.transform.translate(-e,-i);var r=n.shaderValue,a=r.u_mmat2||ft.getMatrArray();ft.mat2MatArray(this._tempMatrix,a),r.textureHost=this.mTexture,r.offsetX=0,r.offsetY=0,r.u_mmat2=a,r.ALPHA=t._shader2D.ALPHA,t._submits[t._submits._length++]=n}else E.isConchApp&&this.mTexture&&(this.transform||(this.transform=v.EMPTY),t.setSkinMesh&&t.setSkinMesh(e,i,this._ps,this.mVBData,this.mEleNum,0,this.mTexture,this.transform))},t._tempVS=[],t._tempIB=[],t._defaultPS=null,t._tVSLen=0,t}(),tt=function(){function t(){this.ib=null,this.vb=null;mt.mainContext;this.ib=Xt.create(35048),this.vb=qt.create(8)}r(t,"laya.webgl.shader.d2.skinAnishader.SkinMeshBuffer");var e=t.prototype;return e.addSkinMesh=function(t){t.getData2(this.vb,this.ib,this.vb.byteLength/32)},e.reset=function(){this.vb.clear(),this.ib.clear()},t.getInstance=function(){return t.instance=t.instance||new t},t.instance=null,t}(),et=function(){function t(t,e,i,n,r,a,s,o,h){this.r0=0,this.fill=!0,this.r1=Math.PI/2,void 0===h&&(h=0),this.x=t,this.y=e,this.width=i,this.height=n,this.edges=r,this.color=a,this.borderWidth=s,this.borderColor=o}r(t,"laya.webgl.shapes.BasePoly");var e=t.prototype;return i.imps(e,{"laya.webgl.shapes.IShape":!0}),e.getData=function(t,e,i){},e.rebuild=function(t){},e.setMatrix=function(t){},e.needUpdate=function(t){return!0},e.sector=function(t,e,i){var n=this.x,r=this.y,a=this.edges,s=(this.r1-this.r0)/a,o=this.width,h=this.height,l=this.color,u=(l>>16&255)/255,c=(l>>8&255)/255,_=(255&l)/255;t.push(n,r,u,c,_);for(var d=0;a+1>d;d++)t.push(n+Math.sin(s*d+this.r0)*o,r+Math.cos(s*d+this.r0)*h),t.push(u,c,_);for(d=0;a>d;d++)e.push(i,i+d+1,i+d+2)},e.createLine2=function(t,e,i,n,r,a){var s,o,h,l,u,c,_,d,f,p,m,g,y,x,v,S,T,E,w,b,C,M=t.concat(),D=r,A=this.borderColor,R=(A>>16&255)/255,I=(A>>8&255)/255,P=(255&A)/255,L=M.length/2,N=n,O=i/2;h=M[0],l=M[1],u=M[2],c=M[3],f=-(l-c),p=h-u,C=Math.sqrt(f*f+p*p),f=f/C*O,p=p/C*O,D.push(h-f+this.x,l-p+this.y,R,I,P,h+f+this.x,l+p+this.y,R,I,P);for(var V=1;L-1>V;V++)h=M[2*(V-1)],l=M[2*(V-1)+1],u=M[2*V],c=M[2*V+1],_=M[2*(V+1)],d=M[2*(V+1)+1],f=-(l-c),p=h-u,C=Math.sqrt(f*f+p*p),f=f/C*O,p=p/C*O,m=-(c-d),g=u-_,C=Math.sqrt(m*m+g*g),m=m/C*O,g=g/C*O,y=-p+l-(-p+c),x=-f+u-(-f+h),v=(-f+h)*(-p+c)-(-f+u)*(-p+l),S=-g+d-(-g+c),T=-m+u-(-m+_),E=(-m+_)*(-g+c)-(-m+u)*(-g+d),w=y*T-S*x,Math.abs(w)<.1?(w+=10.1,D.push(u-f+this.x,c-p+this.y,R,I,P,u+f+this.x,c+p+this.y,R,I,P)):(s=(x*E-T*v)/w,o=(S*v-y*E)/w,b=(s-u)*(s-u)+(o-c)+(o-c),D.push(s+this.x,o+this.y,R,I,P,u-(s-u)+this.x,c-(o-c)+this.y,R,I,P));h=M[M.length-4],l=M[M.length-3],u=M[M.length-2],c=M[M.length-1],f=-(l-c),p=h-u,C=Math.sqrt(f*f+p*p),f=f/C*O,p=p/C*O,D.push(u-f+this.x,c-p+this.y,R,I,P,u+f+this.x,c+p+this.y,R,I,P);var F=a;for(V=1;F>V;V++)e.push(N+2*(V-1),N+2*(V-1)+1,N+2*V+1,N+2*V+1,N+2*V,N+2*(V-1));return D},e.createLine=function(t,e,i,n){var r=t.concat(),a=t,s=this.borderColor,o=(s>>16&255)/255,h=(s>>8&255)/255,l=(255&s)/255;r.splice(0,5);var u,c,_,d,f,p,m,g,y,x,v,S,T,E,w,b,C,M,D,A,R,I=r.length/5,P=n,L=i/2;_=r[0],d=r[1],f=r[5],p=r[6],y=-(d-p),x=_-f,R=Math.sqrt(y*y+x*x),y=y/R*L,x=x/R*L,a.push(_-y,d-x,o,h,l,_+y,d+x,o,h,l);for(var N=1;I-1>N;N++)_=r[5*(N-1)],d=r[5*(N-1)+1],f=r[5*N],p=r[5*N+1],m=r[5*(N+1)],g=r[5*(N+1)+1],y=-(d-p),x=_-f,R=Math.sqrt(y*y+x*x),y=y/R*L,x=x/R*L,v=-(p-g),S=f-m,R=Math.sqrt(v*v+S*S),v=v/R*L,S=S/R*L,T=-x+d-(-x+p),E=-y+f-(-y+_),w=(-y+_)*(-x+p)-(-y+f)*(-x+d),b=-S+g-(-S+p),C=-v+f-(-v+m),M=(-v+m)*(-S+p)-(-v+f)*(-S+g),D=T*C-b*E,Math.abs(D)<.1?(D+=10.1,a.push(f-y,p-x,o,h,l,f+y,p+x,o,h,l)):(u=(E*M-C*w)/D,c=(b*w-T*M)/D,A=(u-f)*(u-f)+(c-p)+(c-p),a.push(u,c,o,h,l,f-(u-f),p-(c-p),o,h,l));_=r[r.length-10],d=r[r.length-9],f=r[r.length-5],p=r[r.length-4],y=-(d-p),x=_-f,R=Math.sqrt(y*y+x*x),y=y/R*L,x=x/R*L,a.push(f-y,p-x,o,h,l,f+y,p+x,o,h,l);var O=this.edges+1;for(N=1;O>N;N++)e.push(P+2*(N-1),P+2*(N-1)+1,P+2*N+1,P+2*N+1,P+2*N,P+2*(N-1));return a},e.createLoopLine=function(t,e,i,n,r,a){var s=t.concat(),o=r?r:t,h=this.borderColor,l=(h>>16&255)/255,u=(h>>8&255)/255,c=(255&h)/255;s.splice(0,5);var _=[s[0],s[1]],d=[s[s.length-5],s[s.length-4]],f=d[0]+.5*(_[0]-d[0]),p=d[1]+.5*(_[1]-d[1]);s.unshift(f,p,0,0,0),s.push(f,p,0,0,0);var m,g,y,x,v,S,T,E,w,b,C,M,D,A,R,I,P,L,N,O,V,F=s.length/5,B=n,U=i/2;y=s[0],x=s[1],v=s[5],S=s[6],w=-(x-S),b=y-v,V=Math.sqrt(w*w+b*b),w=w/V*U,b=b/V*U,o.push(y-w,x-b,l,u,c,y+w,x+b,l,u,c);for(var k=1;F-1>k;k++)y=s[5*(k-1)],x=s[5*(k-1)+1],v=s[5*k],S=s[5*k+1],T=s[5*(k+1)],E=s[5*(k+1)+1],w=-(x-S),b=y-v,V=Math.sqrt(w*w+b*b),w=w/V*U,b=b/V*U,C=-(S-E),M=v-T,V=Math.sqrt(C*C+M*M),C=C/V*U,M=M/V*U,D=-b+x-(-b+S),A=-w+v-(-w+y),R=(-w+y)*(-b+S)-(-w+v)*(-b+x),I=-M+E-(-M+S),P=-C+v-(-C+T),L=(-C+T)*(-M+S)-(-C+v)*(-M+E),N=D*P-I*A,Math.abs(N)<.1?(N+=10.1,o.push(v-w,S-b,l,u,c,v+w,S+b,l,u,c)):(m=(A*L-P*R)/N,g=(I*R-D*L)/N,O=(m-v)*(m-v)+(g-S)+(g-S),o.push(m,g,l,u,c,v-(m-v),S-(g-S),l,u,c));a&&(e=a);var H=this.edges+1;for(k=1;H>k;k++)e.push(B+2*(k-1),B+2*(k-1)+1,B+2*k+1,B+2*k+1,B+2*k,B+2*(k-1));return e.push(B+2*(k-1),B+2*(k-1)+1,B+1,B+1,B,B+2*(k-1)),o},t}(),it=(function(){function t(t,e,i,n,r,a,s){this.lineWidth=t,this.lineColor=e,this.lineAlpha=i,this.fillColor=n,this.fillAlpha=r,this.shape=s,this.fill=a}r(t,"laya.webgl.shapes.GeometryData");var e=t.prototype;return e.clone=function(){return new t(this.lineWidth,this.lineColor,this.lineAlpha,this.fillColor,this.fillAlpha,this.fill,this.shape)},e.getIndexData=function(){return null},e.getVertexData=function(){return null},e.destroy=function(){this.shape=null},t}(),function(){function t(t){if(t instanceof Float32Array)this.points=t;else if(t instanceof Array){t.length;this.points=new Float32Array(t)}}r(t,"laya.webgl.shapes.Vertex");var e=t.prototype;return i.imps(e,{"laya.webgl.shapes.IShape":!0}),e.getData=function(t,e,i){},e.needUpdate=function(t){return!1},e.rebuild=function(t){},e.setMatrix=function(t){},t}(),function(){function t(t){void 0===t&&(t=1e4),this._renderType=t}r(t,"laya.webgl.submit.Submit");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.releaseRender=function(){var e=t._cache;e[e._length++]=this,this.shaderValue.release(),this._vb=null},e.getRenderType=function(){return this._renderType},e.renderSubmit=function(){if(0===this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var e=t.source;if(!t.bitmap||!e)return 1;this.shaderValue.texture=e}this._vb.bind_upload(this._ib);var i=mt.mainContext;return this.shaderValue.upload(),H.activeBlendFunction!==this._blendFn&&(i.enable(3042),this._blendFn(i),H.activeBlendFunction=this._blendFn),A.drawCall++,A.trianglesFaces+=this._numEle/3,i.drawElements(4,this._numEle,5123,this._startIdx),1},t.__init__=function(){var e=t.RENDERBASE=new t(-1);e.shaderValue=new vt(0,0),e.shaderValue.ALPHA=-1234},t.create=function(e,i,n,r,a){var s=t._cache._length?t._cache[--t._cache._length]:new t;null==n&&(n=s._selfVb||(s._selfVb=qt.create(-1)),n.clear(),r=0),s._ib=i,s._vb=n,s._startIdx=r*_t.BYTES_PIDX,s._numEle=0;var o=e._nBlendType;s._blendFn=e._targets?H.targetFns[o]:H.fns[o],s.shaderValue=a,s.shaderValue.setValue(e._shader2D);var h=e._shader2D.filters;return h&&s.shaderValue.setFilters(h),s},t.createShape=function(e,i,n,r,a,s){var o=t._cache._length?t._cache[--t._cache._length]:new t;o._ib=i,o._vb=n,o._numEle=r,o._startIdx=a,o.shaderValue=s,o.shaderValue.setValue(e._shader2D);var h=e._nBlendType;return o._blendFn=e._targets?H.targetFns[h]:H.fns[h],o},t.TYPE_2D=1e4,t.TYPE_CANVAS=10003,t.TYPE_CMDSETRT=10004,t.TYPE_CUSTOM=10005,t.TYPE_BLURRT=10006,t.TYPE_CMDDESTORYPRERT=10007,t.TYPE_DISABLESTENCIL=10008,t.TYPE_OTHERIBVB=10009,t.TYPE_PRIMITIVE=10010,t.TYPE_RT=10011,t.TYPE_BLUR_RT=10012,t.TYPE_TARGET=10013,t.TYPE_CHANGE_VALUE=10014,t.TYPE_SHAPE=10015,t.TYPE_TEXTURE=10016,t.TYPE_FILLTEXTURE=10017,t.RENDERBASE=null,t._cache=(t._cache=[],t._cache._length=0,t._cache),t}()),nt=function(){function t(){this.fun=null,this.args=null}r(t,"laya.webgl.submit.SubmitCMD");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){return this.fun.apply(null,this.args),1},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},t.create=function(e,i){var n=t._cache._length?t._cache[--t._cache._length]:new t;return n.fun=i,n.args=e,n},t._cache=(t._cache=[],t._cache._length=0,t._cache),t}(),rt=function(){function t(){this.variables={}}r(t,"laya.webgl.submit.SubmitCMDScope");var e=t.prototype;return e.getValue=function(t){return this.variables[t]},e.addValue=function(t,e){return this.variables[t]=e},e.setValue=function(t,e){return this.variables.hasOwnProperty(t)?this.variables[t]=e:null},e.clear=function(){for(var t in this.variables)delete this.variables[t]},e.recycle=function(){this.clear(),t.POOL.push(this)},t.create=function(){var e=t.POOL.pop();return e||(e=new t),e},t.POOL=[],t}(),at=function(){function t(){this.offset=0,this.startIndex=0,this._mat=v.create()}r(t,"laya.webgl.submit.SubmitOtherIBVB");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.releaseRender=function(){var e=t._cache;e[e._length++]=this},e.getRenderType=function(){return 10009},e.renderSubmit=function(){var e=this._shaderValue.textureHost;if(e){var i=e.source;if(!e.bitmap||!i)return 1;this._shaderValue.texture=i}this._vb.bind_upload(this._ib);var n=ft.worldMatrix4,r=v.TEMP;v.mulPre(this._mat,n[0],n[1],n[4],n[5],n[12],n[13],r);var a=ft.worldMatrix4=t.tempMatrix4;a[0]=r.a,a[1]=r.b,a[4]=r.c,a[5]=r.d,a[12]=r.tx,a[13]=r.ty,this._shader._offset=this.offset,this._shaderValue.refresh(),this._shader.upload(this._shaderValue),this._shader._offset=0;var s=mt.mainContext;return H.activeBlendFunction!==this._blendFn&&(s.enable(3042),this._blendFn(s),H.activeBlendFunction=this._blendFn),A.drawCall++,A.trianglesFaces+=this._numEle/3,s.drawElements(4,this._numEle,5123,this.startIndex),ft.worldMatrix4=n,Rt.activeShader=null,1},t.create=function(e,i,n,r,a,s,o,h,l){void 0===l&&(l=0);var u=t._cache._length?t._cache[--t._cache._length]:new t;u._ib=n,u._vb=i,u._numEle=r,u._shader=a,u._shaderValue=s;var c=e._nBlendType;switch(u._blendFn=e._targets?H.targetFns[c]:H.fns[c],l){case 0:u.offset=0,u.startIndex=h/(_t.BYTES_PE*i.vertexStride)*1.5,u.startIndex*=_t.BYTES_PIDX;break;case 1:u.startIndex=o,u.offset=h}return u},t._cache=(t._cache=[],t._cache._length=0,t._cache),t.tempMatrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t}(),st=function(){function t(){this.submitIndex=0,this.submitLength=0,this.context=null,this.clipRect=new T,this.screenRect=new T}r(t,"laya.webgl.submit.SubmitScissor");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e._scissor=function(t,e,i,n){var r=ft.worldMatrix4,a=r[0],s=r[5],o=r[12],h=r[13];if(t=t*a+o,e=e*s+h,i*=a,n*=s,1>i||1>n)return!1;var l=t+i,u=e+n;0>t&&(t=0,i=l-t),0>e&&(e=0,n=u-e);var c=ft.worldClipRect;if(t=Math.max(t,c.x),e=Math.max(e,c.y),i=Math.min(l,c.right)-t,n=Math.min(u,c.bottom)-e,1>i||1>n)return!1;var _=ft.worldScissorTest;return this.screenRect.copyFrom(c),c.x=t,c.y=e,c.width=i,c.height=n,ft.worldScissorTest=!0,e=ft.height-e-n,mt.mainContext.scissor(t,e,i,n),mt.mainContext.enable(3089),this.context.submitElement(this.submitIndex,this.submitIndex+this.submitLength),_?(e=ft.height-this.screenRect.y-this.screenRect.height,mt.mainContext.scissor(this.screenRect.x,e,this.screenRect.width,this.screenRect.height),mt.mainContext.enable(3089)):(mt.mainContext.disable(3089),ft.worldScissorTest=!1),c.copyFrom(this.screenRect),!0},e._scissorWithTagart=function(t,e,i,n){if(1>i||1>n)return!1;var r=t+i,a=e+n;0>t&&(t=0,i=r-t),0>e&&(e=0,n=a-e);var s=ft.worldClipRect;if(t=Math.max(t,s.x),e=Math.max(e,s.y),i=Math.min(r,s.right)-t,n=Math.min(a,s.bottom)-e,1>i||1>n)return!1;var o=ft.worldScissorTest;return this.screenRect.copyFrom(s),ft.worldScissorTest=!0,s.x=t,s.y=e,s.width=i,s.height=n,e=ft.height-e-n,mt.mainContext.scissor(t,e,i,n),mt.mainContext.enable(3089),this.context.submitElement(this.submitIndex,this.submitIndex+this.submitLength),o?(e=ft.height-this.screenRect.y-this.screenRect.height,mt.mainContext.scissor(this.screenRect.x,e,this.screenRect.width,this.screenRect.height),mt.mainContext.enable(3089)):(mt.mainContext.disable(3089),ft.worldScissorTest=!1),s.copyFrom(this.screenRect),!0},e.renderSubmit=function(){return this.submitLength=Math.min(this.context._submits._length-1,this.submitLength),this.submitLength<1||this.clipRect.width<1||this.clipRect.height<1?this.submitLength+1:(this.context._targets?this._scissorWithTagart(this.clipRect.x,this.clipRect.y,this.clipRect.width,this.clipRect.height):this._scissor(this.clipRect.x,this.clipRect.y,this.clipRect.width,this.clipRect.height),this.submitLength+1)},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this,this.context=null},t.create=function(e){var i=t._cache._length?t._cache[--t._cache._length]:new t;return i.context=e,i},t._cache=(t._cache=[],t._cache._length=0,t._cache),t}(),ot=function(){function t(){this.step=0,this.blendMode=null,this.level=0}r(t,"laya.webgl.submit.SubmitStencil");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){switch(this.step){case 1:this.do1();break;case 2:this.do2();break;case 3:this.do3();break;case 4:this.do4();break;case 5:this.do5();break;case 6:this.do6()}return 1},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},e.do1=function(){var t=mt.mainContext;t.enable(2960),t.clear(1024),t.colorMask(!1,!1,!1,!1),t.stencilFunc(514,this.level,255),t.stencilOp(7680,7680,7682)},e.do2=function(){var t=mt.mainContext;t.stencilFunc(514,this.level+1,255),t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680)},e.do3=function(){var t=mt.mainContext;t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680),t.clear(1024),t.disable(2960)},e.do4=function(){var t=mt.mainContext;t.enable(2960),t.clear(1024),t.colorMask(!1,!1,!1,!1),t.stencilFunc(519,this.level,255),t.stencilOp(7680,7680,5386)},e.do5=function(){var t=mt.mainContext;t.stencilFunc(514,255,255),t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680)},e.do6=function(){var t=mt.mainContext;H.targetFns[H.TOINT[this.blendMode]](t)},t.create=function(e){var i=t._cache._length?t._cache[--t._cache._length]:new t;return i.step=e,i},t._cache=(t._cache=[],t._cache._length=0,t._cache),t}(),ht=function(){function t(){this._renderType=0,this._vb=null,this._ib=null,this._startIdx=0,this._numEle=0,this.shaderValue=null,this.blendType=0,this.proName=null,this.scope=null}r(t,"laya.webgl.submit.SubmitTarget");var e=t.prototype;
return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){this._vb.bind_upload(this._ib);var t=this.scope.getValue(this.proName);return t&&(this.shaderValue.texture=t.source,this.shaderValue.strength&&!this.shaderValue.blurInfo&&(this.shaderValue.blurInfo=[t.width,t.height]),this.shaderValue.upload(),this.blend(),A.drawCall++,A.trianglesFaces+=this._numEle/3,mt.mainContext.drawElements(4,this._numEle,5123,this._startIdx)),1},e.blend=function(){if(H.activeBlendFunction!==H.fns[this.blendType]){var t=mt.mainContext;t.enable(3042),H.fns[this.blendType](t),H.activeBlendFunction=H.fns[this.blendType]}},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},t.create=function(e,i,n,r,a,s){var o=t._cache._length?t._cache[--t._cache._length]:new t;return o._ib=i,o._vb=n,o.proName=s,o._startIdx=r*_t.BYTES_PIDX,o._numEle=0,o.blendType=e._nBlendType,o.shaderValue=a,o.shaderValue.setValue(e._shader2D),o},t._cache=(t._cache=[],t._cache._length=0,t._cache),t}(),lt=function(){function t(){this._sourceStr=null}r(t,"laya.webgl.text.CharSegment");var e=t.prototype;return i.imps(e,{"laya.webgl.text.ICharSegment":!0}),e.textToSpit=function(t){this._sourceStr=t},e.getChar=function(t){return this._sourceStr.charAt(t)},e.getCharCode=function(t){return this._sourceStr.charCodeAt(t)},e.length=function(){return this._sourceStr.length},t}(),ut=function(){function t(){}var e;return r(t,"laya.webgl.text.DrawText"),t.__init__=function(){t._charsTemp=new Array,t._drawValue=new e,t._charSeg=new lt},t.customCharSeg=function(e){t._charSeg=e},t.getChar=function(e,i,n){var r=kt.createOneChar(e,n);return-1!=i&&(t._charsCache[i]=r),r},t._drawSlow=function(e,i,n,r,a,s,o,h,l,u,c,_,d,f){var p,m,g=t._drawValue.value(s,h,l,u,d,f),y=0,x=0,v=t._charsTemp,S=0,T=NaN;if(r)for(v.length=r.length,y=0,x=r.length;x>y;y++)m=r[y],T=m.charNum+g.txtID,v[y]=p=t._charsCache[T]||t.getChar(m["char"],T,g),p.active();else{var E=n instanceof laya.utils.WordText?n.toString():n;if(P.CharacterCache){t._charSeg.textToSpit(E);var w=t._charSeg.length();for(v.length=w,y=0,x=w;x>y;y++)T=t._charSeg.getCharCode(y)+g.txtID,v[y]=p=t._charsCache[T]||t.getChar(t._charSeg.getChar(y),T,g),p.active(),S+=p.cw}else p=t.getChar(E,-1,g),p.active(),S+=p.cw,v[0]=p}var b=0;null!==o&&"left"!==o&&(b=-("center"==o?S/2:S));var C,M,D=NaN,A=0;if(r)for(y=0,x=v.length;x>y;y++)p=v[y],p.isSpace||(m=r[y],D=p.borderSize,C=p.texture,i._drawText(C,c+b+m.x*d-D,_+m.y*f-D,C.width,C.height,a,0,0,0,0));else{for(y=0,x=v.length;x>y;y++)p=v[y],p.isSpace||(D=p.borderSize,C=p.texture,i._drawText(C,c+b-D,_-D,C.width,C.height,a,0,0,0,0),e&&(M=e[A++],M||(M=e[A-1]=[]),M[0]=C,M[1]=b-D,M[2]=-D)),b+=p.cw;e&&(e.length=A)}},t._drawFast=function(t,e,i,n,r){for(var a,s,o=0,h=t.length;h>o;o++)s=t[o],a=s[0],a.active(),e._drawText(a,n+s[1],r+s[2],a.width,a.height,i,0,0,0,0)},t.drawText=function(e,n,r,a,s,o,h,l,u,c,_){if(!(n&&0===n.length||r&&0===r.length)){var f=a.a,p=a.d;(0!==a.b||0!==a.c)&&(f=p=1);var m=1!==f||1!==p;if(m&&i.stage.transform){var g=i.stage.transform;m=g.a===f&&g.d===p}else m=!1;if(m){a=a.copyTo(xt._tmpMatrix);var y=a.tx,x=a.ty;a.scale(1/f,1/p),a._checkTransform(),c*=f,_*=p,c+=y-a.tx,_+=x-a.ty}else f=p=1;if(r)t._drawSlow(null,e,n,r,a,s,o,h,l,u,c,_,f,p);else{if(null===n.toUpperCase){var v=f+1e5*p,S=n;return void(S.changed||S.id!==v?(S.id=v,S.changed=!1,t._drawSlow(S.save,e,n,r,a,s,o,h,l,u,c,_,f,p)):t._drawFast(S.save,e,a,c,_))}var T=n+s.toString()+h+l+u+f+p+o,E=t._textsCache[T];P.CharacterCache?E?t._drawFast(E,e,a,c,_):(t._textsCache.__length||(t._textsCache.__length=0),t._textsCache.__length>d.WebGLTextCacheCount&&(t._textsCache={},t._textsCache.__length=0,t._curPoolIndex=0),t._textCachesPool[t._curPoolIndex]?(E=t._textsCache[T]=t._textCachesPool[t._curPoolIndex],E.length=0):t._textCachesPool[t._curPoolIndex]=E=t._textsCache[T]=[],t._textsCache.__length++,t._curPoolIndex++,t._drawSlow(E,e,n,r,a,s,o,h,l,u,c,_,f,p)):t._drawSlow(E,e,n,r,a,s,o,h,l,u,c,_,f,p)}}},t._charsTemp=null,t._textCachesPool=[],t._curPoolIndex=0,t._charsCache={},t._textsCache={},t._drawValue=null,t.d=[],t._charSeg=null,t.__init$=function(){e=function(){function t(){}r(t,"");var e=t.prototype;return e.value=function(e,i,n,r,a,s){this.font=e,this.fillColor=i,this.borderColor=n,this.lineWidth=r,this.scaleX=a,this.scaleY=s;var o=e.toString()+a+s+r+i+n;return this.txtID=t._keymap[o],this.txtID||(this.txtID=1e-7*++t._keymapCount,t._keymap[o]=this.txtID),this},t.clear=function(){t._keymap={},t._keymapCount=1},t._keymap={},t._keymapCount=1,t}()},t}(),ct=function(){function t(e){this._index=0,this._size=14,this._italic=-2,t._cache2=t._cache2||[],this.setFont(e||"14px Arial")}r(t,"laya.webgl.text.FontInContext");var e=t.prototype;return e.setFont=function(e){var i=t._cache2[e];if(i)this._words=i[0],this._size=i[1];else{this._words=e.split(" ");for(var n=0,r=this._words.length;r>n;n++)if(this._words[n].indexOf("px")>0){this._index=n;break}this._size=parseInt(this._words[this._index]),t._cache2[e]=[this._words,this._size]}this._text=null,this._italic=-2},e.getItalic=function(){return-2===this._italic&&(this._italic=this.hasType("italic")),this._italic},e.hasType=function(t){for(var e=0,i=this._words.length;i>e;e++)if(this._words[e]===t)return e;return-1},e.removeType=function(t){for(var e=0,i=this._words.length;i>e;e++)if(this._words[e]===t){this._words.splice(e,1),this._index>e&&this._index--;break}this._text=null,this._italic=-2},e.copyTo=function(t){return t._text=this._text,t._size=this._size,t._index=this._index,t._words=this._words.slice(),t._italic=-2,t},e.toString=function(){return this._text?this._text:this._text=this._words.join(" ")},a(0,e,"size",function(){return this._size},function(t){this._size=t,this._words[this._index]=t+"px",this._text=null}),t.create=function(e){var i=t._cache[e];return i?i:i=t._cache[e]=new t(e)},t.EMPTY=new t,t._cache={},t._cache2=null,t}(),_t=function(){function t(){}return r(t,"laya.webgl.utils.CONST3D2D"),t.defaultMatrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t.defaultMinusYMatrix4=[1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1],t.uniformMatrix3=[1,0,0,0,0,1,0,0,0,0,1,0],t._TMPARRAY=[],t._OFFSETX=0,t._OFFSETY=0,n(t,["BYTES_PE",function(){return this.BYTES_PE=Float32Array.BYTES_PER_ELEMENT},"BYTES_PIDX",function(){return this.BYTES_PIDX=Uint16Array.BYTES_PER_ELEMENT}]),t}(),dt=function(){function t(){}return r(t,"laya.webgl.utils.GlUtils"),t.make2DProjection=function(t,e,i){return[2/t,0,0,0,0,-2/e,0,0,0,0,2/i,0,-1,1,0,1]},t.fillIBQuadrangle=function(t,e){if(e>65535/4)throw Error("IBQuadrangle count:"+e+" must<:"+Math.floor(65535/4));e=Math.floor(e),t._resizeBuffer(6*(e+1)*2,!1),t.byteLength=t.bufferLength;for(var i=t.getUint16Array(),n=0,r=0;e>r;r++)i[n++]=4*r,i[n++]=4*r+2,i[n++]=4*r+1,i[n++]=4*r,i[n++]=4*r+3,i[n++]=4*r+2;return t.setNeedUpload(),!0},t.expandIBQuadrangle=function(e,i){e.bufferLength>=6*i*2||t.fillIBQuadrangle(e,i)},t.mathCeilPowerOfTwo=function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,t++,t},t.fillQuadrangleImgVb=function(t,e,i,n,r,a,s,o){"use strict";var h=(t._byteLength>>2)+16;t.byteLength=h<<2;var l=t.getFloat32Array();h-=16,l[h+2]=r[0],l[h+3]=r[1],l[h+6]=r[2],l[h+7]=r[3],l[h+10]=r[4],l[h+11]=r[5],l[h+14]=r[6],l[h+15]=r[7];var u=a.a,c=a.b,_=a.c,d=a.d;if(1!==u||0!==c||0!==_||1!==d){a.bTransform=!0;var f=a.tx+s,p=a.ty+o;l[h]=(n[0]+e)*u+(n[1]+i)*_+f,l[h+1]=(n[0]+e)*c+(n[1]+i)*d+p,l[h+4]=(n[2]+e)*u+(n[3]+i)*_+f,l[h+5]=(n[2]+e)*c+(n[3]+i)*d+p,l[h+8]=(n[4]+e)*u+(n[5]+i)*_+f,l[h+9]=(n[4]+e)*c+(n[5]+i)*d+p,l[h+12]=(n[6]+e)*u+(n[7]+i)*_+f,l[h+13]=(n[6]+e)*c+(n[7]+i)*d+p}else a.bTransform=!1,e+=a.tx+s,i+=a.ty+o,l[h]=e+n[0],l[h+1]=i+n[1],l[h+4]=e+n[2],l[h+5]=i+n[3],l[h+8]=e+n[4],l[h+9]=i+n[5],l[h+12]=e+n[6],l[h+13]=i+n[7];return t._upload=!0,!0},t.fillTranglesVB=function(t,e,i,n,r,a,s){"use strict";var o=(t._byteLength>>2)+n.length;t.byteLength=o<<2;var h=t.getFloat32Array();o-=n.length;for(var l=n.length,u=r.a,c=r.b,_=r.c,d=r.d,f=0;l>f;f+=4)if(h[o+f+2]=n[f+2],h[o+f+3]=n[f+3],1!==u||0!==c||0!==_||1!==d){r.bTransform=!0;var p=r.tx+a,m=r.ty+s;h[o+f]=(n[f]+e)*u+(n[f+1]+i)*_+p,h[o+f+1]=(n[f]+e)*c+(n[f+1]+i)*d+m}else r.bTransform=!1,e+=r.tx+a,i+=r.ty+s,h[o+f]=e+n[f],h[o+f+1]=i+n[f+1];return t._upload=!0,!0},t.copyPreImgVb=function(t,e,i){var n=t._byteLength>>2;t.byteLength=n+16<<2;for(var r=t.getFloat32Array(),a=0,s=n-16;4>a;a++)r[n]=r[s]+e,++n,++s,r[n]=r[s]+i,++n,++s,r[n]=r[s],++n,++s,r[n]=r[s],++n,++s;t._upload=!0},t.fillRectImgVb=function(t,e,i,n,r,a,s,o,h,l,u,c,_){void 0===_&&(_=!1);var d,f,p,m,g,y,x,v,S,T,E,w,b,C,M,D,A=1,R=o.a,I=o.b,P=o.c,L=o.d,N=e&&e.width<99999999;if(1!==R||0!==I||0!==P||1!==L?(o.bTransform=!0,0===I&&0===P&&(A=23,S=r+i,T=a+n,E=o.tx+h,w=o.ty+l,d=R*i+E,p=R*S+E,f=L*n+w,m=L*T+w)):(A=23,o.bTransform=!1,d=i+o.tx+h,p=d+r,f=n+o.ty+l,m=f+a),N&&(g=e.x,y=e.y,x=e.width+g,v=e.height+y),1!==A&&(Math.min(d,p)>=x||Math.min(f,m)>=v||Math.max(p,d)<=g||Math.max(m,f)<=y))return!1;var O=t._byteLength>>2;t.byteLength=O+16<<2;var V=t.getFloat32Array();switch(V[O+2]=s[0],V[O+3]=s[1],V[O+6]=s[2],V[O+7]=s[3],V[O+10]=s[4],V[O+11]=s[5],V[O+14]=s[6],V[O+15]=s[7],A){case 1:E=o.tx+h,w=o.ty+l,S=r+i,T=a+n;var F=i,B=n,U=R*F,k=P*B,H=L*B,z=I*F,W=R*S,G=P*T,j=L*T,Y=I*S;_?(b=U+k+E,M=Math.round(b)-b,C=H+z+w,D=Math.round(C)-C,V[O]=b+M,V[O+1]=C+D,V[O+4]=W+k+E+M,V[O+5]=H+Y+w+D,V[O+8]=W+G+E+M,V[O+9]=j+Y+w+D,V[O+12]=U+G+E+M,V[O+13]=j+z+w+D):(V[O]=U+k+E,V[O+1]=H+z+w,V[O+4]=W+k+E,V[O+5]=H+Y+w,V[O+8]=W+G+E,V[O+9]=j+Y+w,V[O+12]=U+G+E,V[O+13]=j+z+w);break;case 23:_?(b=d+u,M=Math.round(b)-b,C=f,D=Math.round(C)-C,V[O]=b+M,V[O+1]=C+D,V[O+4]=p+u+M,V[O+5]=f+D,V[O+8]=p+M,V[O+9]=m+D,V[O+12]=d+M,V[O+13]=m+D):(V[O]=d+u,V[O+1]=f,V[O+4]=p+u,V[O+5]=f,V[O+8]=p,V[O+9]=m,V[O+12]=d,V[O+13]=m)}return t._upload=!0,!0},t.fillLineVb=function(e,i,n,r,a,s,o,h){"use strict";var l=.5*o,u=t._fillLineArray,c=-(r-s),_=n-a,d=Math.sqrt(c*c+_*_);c/=d,_/=d,c*=l,_*=l,u[0]=n-c,u[1]=r-_,u[4]=n+c,u[5]=r+_,u[8]=a+c,u[9]=s+_,u[12]=a-c,u[13]=s-_,h&&h.transformPointArray(u,u);var f=(e._byteLength>>2)+16;return e.byteLength=f<<2,e.insertData(u,f-16),!0},t._fillLineArray=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t}(),ft=(function(){function t(){}return r(t,"laya.webgl.utils.MatirxArray"),t.ArrayMul=function(e,i,n){if(!e)return void t.copyArray(i,n);if(!i)return void t.copyArray(e,n);for(var r=NaN,a=NaN,s=NaN,o=NaN,h=0;4>h;h++)r=e[h],a=e[h+4],s=e[h+8],o=e[h+12],n[h]=r*i[0]+a*i[1]+s*i[2]+o*i[3],n[h+4]=r*i[4]+a*i[5]+s*i[6]+o*i[7],n[h+8]=r*i[8]+a*i[9]+s*i[10]+o*i[11],n[h+12]=r*i[12]+a*i[13]+s*i[14]+o*i[15]},t.copyArray=function(t,e){if(t&&e)for(var i=0;i<t.length;i++)e[i]=t[i]},t}(),function(){function t(){}return r(t,"laya.webgl.utils.RenderState2D"),t.getMatrArray=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},t.mat2MatArray=function(e,i){var n=e,r=i;return r[0]=n.a,r[1]=n.b,r[2]=t.EMPTYMAT4_ARRAY[2],r[3]=t.EMPTYMAT4_ARRAY[3],r[4]=n.c,r[5]=n.d,r[6]=t.EMPTYMAT4_ARRAY[6],r[7]=t.EMPTYMAT4_ARRAY[7],r[8]=t.EMPTYMAT4_ARRAY[8],r[9]=t.EMPTYMAT4_ARRAY[9],r[10]=t.EMPTYMAT4_ARRAY[10],r[11]=t.EMPTYMAT4_ARRAY[11],r[12]=n.tx,r[13]=n.ty,r[14]=t.EMPTYMAT4_ARRAY[14],r[15]=t.EMPTYMAT4_ARRAY[15],i},t.restoreTempArray=function(){t.TEMPMAT4_ARRAY[0]=1,t.TEMPMAT4_ARRAY[1]=0,t.TEMPMAT4_ARRAY[4]=0,t.TEMPMAT4_ARRAY[5]=1,t.TEMPMAT4_ARRAY[12]=0,t.TEMPMAT4_ARRAY[13]=0},t.clear=function(){t.worldScissorTest=!1,t.worldShaderDefines=null,t.worldFilters=null,t.worldAlpha=1,t.worldClipRect.x=t.worldClipRect.y=0,t.worldClipRect.width=t.width,t.worldClipRect.height=t.height,t.curRenderTarget=null},t._MAXSIZE=99999999,t.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],t.worldMatrix4=t.TEMPMAT4_ARRAY,t.worldAlpha=1,t.worldScissorTest=!1,t.worldFilters=null,t.worldShaderDefines=null,t.curRenderTarget=null,t.width=0,t.height=0,n(t,["worldMatrix",function(){return this.worldMatrix=new v},"worldClipRect",function(){return this.worldClipRect=new T(0,0,99999999,99999999)}]),t}()),pt=function(){function t(t,i,n,r,a){function s(t){for(var e=t.split(" "),i=[],n=0;n<e.length;n++)e[n].length>0&&i.push(e[n]);return i}function o(t){var i,n,r=0,o=0,h=0,l=new e(0,null,null,null),u=l,c=t.split("\n");for(r=0,o=c.length;o>r;r++){var _=c[r];if(_.indexOf("#ifdef")>=0)i=s(_),u=new e(1,i[1],"",u);else if(_.indexOf("#else")>=0)n=u.condition,u=new e(2,null,"",u.parent),u.condition=n;else if(_.indexOf("#endif")>=0)u=u.parent;else if(_.indexOf("#include")>=0){i=s(_);var d=i[1],f=d.charAt(0);('"'===f||"'"===f)&&(d=d.substr(1,d.length-2),h=d.lastIndexOf(f),h>0&&(d=d.substr(0,h))),h=i[0].indexOf("?");var p=h>0?i[0].substr(h+1):i[0];new e(1,p,a[d],u)}else u.childs.length>0&&0===u.childs[u.childs.length-1].type?u.childs[u.childs.length-1].text+="\n"+_:new e(0,null,_,u)}return l}this._VSTXT=i,this._PSTXT=n,this._VS=o(i),this._PS=o(n),this._nameMap=r}var e;r(t,"laya.webgl.utils.ShaderCompile");var i=t.prototype;return i.createShader=function(t,e,i){var n={},r="";if(t)for(var a in t)r+="#define "+a+"\n",n[a]=!0;var s=this._VS.toscript(n,[]),o=this._PS.toscript(n,[]);return(i||Wt.create)(r+s.join("\n"),r+o.join("\n"),e,this._nameMap)},t.IFDEF_NO=0,t.IFDEF_YES=1,t.IFDEF_ELSE=2,t.__init$=function(){e=function(){function t(t,e,i,n){if(this.childs=new Array,this.type=t,this.text=i,this.parent=n,n&&n.childs.push(this),e){for(var r="",a=!1,s=!1,o=0,h=e.length;h>o;o++){var l=e.charAt(o);s="!&|() 	".indexOf(l)<0,a!=s&&(s&&(r+="this."),a=s),r+=l}this.condition=M.createShaderCondition(r)}}r(t,"");var e=t.prototype;return e.toscript=function(t,e){if(0===this.type&&this.text&&e.push(this.text),this.childs.length<1&&!this.text)return e;if(0!==this.type){var i=!!this.condition.call(t);if(2===this.type&&(i=!i),!i)return e;this.text&&e.push(this.text)}return this.childs.length>0&&this.childs.forEach(function(i,n,r){i.toscript(t,e)}),e},t}()},t}(),mt=function(){function t(){}return r(t,"laya.webgl.WebGL"),t._uint8ArraySlice=function(){for(var t=this,e=t.length,i=new Uint8Array(t.length),n=0;e>n;n++)i[n]=t[n];return i},t._float32ArraySlice=function(){for(var t=this,e=t.length,i=new Float32Array(t.length),n=0;e>n;n++)i[n]=t[n];return i},t._uint16ArraySlice=function(t){var e,i=arguments,n=this,r=0,a=0;if(0===i.length)for(r=n.length,e=new Uint16Array(r),a=0;r>a;a++)e[a]=n[a];else if(2===i.length){var s=i[0],o=i[1];if(o>s)for(r=o-s,e=new Uint16Array(r),a=s;o>a;a++)e[a-s]=n[a];else e=new Uint16Array(0)}return e},t.expandContext=function(){var t=f.prototype,e=CanvasRenderingContext2D.prototype;e.fillTrangles=t.fillTrangles,Gt.__int__(null),e.setIBVB=function(t,e,i,n,r,a,s,o,h,l){void 0===h&&(h=0),void 0===l&&(l=0),null===i&&(this._ib=this._ib||Xt.QuadrangleIB,i=this._ib,dt.expandIBQuadrangle(i,n.byteLength/64+8)),this._setIBVB(t,e,i,n,r,a,s,o,h,l)},e.fillTrangles=function(t,e,i,n,r){this._curMat=this._curMat||v.create(),this._vb=this._vb||qt.create(),this._ib||(this._ib=Xt.create(),dt.fillIBQuadrangle(this._ib,s/4));var a=this._vb,s=n.length>>4;dt.fillTranglesVB(a,e,i,n,r||this._curMat,0,0),dt.expandIBQuadrangle(this._ib,a.byteLength/64+8);var o=new vt(1,0);o.textureHost=t;var h=new Yt("attribute vec2 position; attribute vec2 texcoord; uniform vec2 size; uniform mat4 mmat; varying vec2 v_texcoord; void main() { vec4 p=vec4(position.xy,0.0,1.0);vec4 pos=mmat*p; gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0); v_texcoord = texcoord; }","precision mediump float; varying vec2 v_texcoord; uniform sampler2D texture; void main() {vec4 color= texture2D(texture, v_texcoord); color.a*=1.0; gl_FragColor= color;}");a._vertType=3,this._setIBVB(e,i,this._ib,a,6*s,r,h,o,0,0)}},t.enable=function(){if(u.__init__(),E.isConchApp&&!E.isConchWebGL)return M.skinAniSprite=function(){var t=new J;return t},t.expandContext(),!1;if(M.getWebGLContext=function(t){for(var e,i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],n=0;n<i.length;n++){try{e=t.getContext(i[n],{stencil:d.isStencil,alpha:d.isAlpha,antialias:d.isAntialias,premultipliedAlpha:d.premultipliedAlpha,preserveDrawingBuffer:d.preserveDrawingBuffer})}catch(r){}if(e)return e}return null},t.mainContext=M.getWebGLContext(E._mainCanvas),null==t.mainContext)return!1;if(E.isWebGL)return!0;y.create=function(t,e){return new Kt(t,e)},x.create=function(t,e,i,n,r,a,s){return new zt(t,e,i,n,r,a,s)},E.WebGL=t,E.isWebGL=!0,ut.__init__(),M.createRenderSprite=function(t,e){return new St(t,e)},M.createWebGLContext2D=function(t){return new xt(t)},M.changeWebGLSize=function(t,e){laya.webgl.WebGL.onStageResize(t,e)},M.createGraphics=function(){return new yt};var e=M.createFilterAction;return M.createFilterAction=e?e:function(t){return new Tt},M.clear=function(t){ft.worldScissorTest&&laya.webgl.WebGL.mainContext.disable(3089);var e=E.context.ctx,n=0==e._submits._length||d.preserveDrawingBuffer?_.create(t)._color:i.stage._wgColor;n&&e.clearBG(n[0],n[1],n[2],n[3]),ft.clear()},M.addToAtlas=function(t,e){void 0===e&&(e=!1);var n=t.bitmap;return E.optimizeTextureMemory(t.url,t)?void(i.__typeof(n,"laya.webgl.resource.IMergeAtlasBitmap")&&n.allowMerageInAtlas&&n.on("recovered",t,t.addTextureToAtlas)):void(n.enableMerageInAtlas=!1)},U._enable(),M.beginFlush=function(){for(var t=U.instance,e=t.getAtlaserCount(),i=0;e>i;i++){var n=t.getAtlaserByIndex(i).texture;n._flashCacheImageNeedFlush&&M.flashFlushImage(n)}},M.drawToCanvas=function(t,e,i,n,r,a){r-=t.x,a-=t.y;var s=new It(i,n,6408,5121,0,!1);s.start(),E.context.clear(),t.render(E.context,r,ft.height-n+a),E.context.flush(),s.end();var o=s.getData(0,0,s.width,s.height);s.dispose();var h=new Ut;h._canvas=u.createElement("canvas"),h.size(i,n);var l=h._canvas.getContext("2d");u.canvas.size(i,n);var c=u.context,_=c.createImageData(i,n);return _.data.set(new Uint8ClampedArray(o.buffer)),c.putImageData(_,0,0),l.save(),l.translate(0,n),l.scale(1,-1),l.drawImage(u.canvas.source,0,0),l.restore(),h},M.createFilterAction=function(t){var e;switch(t){case 32:e=new Tt}return e},M.addTextureToAtlas=function(t){t._uvID++,U._atlasRestore++,t.bitmap.enableMerageInAtlas&&U.instance.addToAtlas(t)},M.getTexturePixels=function(t,e,i,n,r){E.context.ctx.clear();var a=new D;a.graphics.drawTexture(t,-e,-i);var s=It.create(n,r);s.start(),s.clear(0,0,0,0),a.render(E.context,0,0),E.context.ctx.flush(),s.end();for(var o=s.getData(0,0,n,r),h=[],l=0,u=r-1;u>=0;u--)for(var c=0;n>c;c++)l=4*(u*n+c),h.push(o[l]),h.push(o[l+1]),h.push(o[l+2]),h.push(o[l+3]);return h},M.skinAniSprite=function(){var t=new J;return t},p._filterStart=function(t,e,i,n,r){var a=t.getValue("bounds"),s=It.create(a.width,a.height);if(s.start(),s.clear(0,0,0,0),t.addValue("src",s),t.addValue("ScissorTest",ft.worldScissorTest),ft.worldScissorTest){var o=new T;o.copyFrom(i.ctx._clipRect),t.addValue("clipRect",o),ft.worldScissorTest=!1,laya.webgl.WebGL.mainContext.disable(3089)}},p._filterEnd=function(t,e,i,n,r){var a=t.getValue("bounds"),s=t.getValue("src");s.end();var o=It.create(a.width,a.height);o.start(),o.clear(0,0,0,0),t.addValue("out",o),e._set$P("_filterCache",o),e._set$P("_isHaveGlowFilter",t.getValue("_isHaveGlowFilter"))},p._EndTarget=function(t,e){var i=t.getValue("src");i.recycle();var n=t.getValue("out");n.end();var r=t.getValue("ScissorTest");if(r){ft.worldScissorTest=!0,laya.webgl.WebGL.mainContext.enable(3089),e.ctx.save();var a=t.getValue("clipRect");e.ctx.clipRect(a.x,a.y,a.width,a.height)}},p._useSrc=function(t){var e=t.getValue("out");e.end(),e=t.getValue("src"),e.start(),e.clear(0,0,0,0)},p._endSrc=function(t){var e=t.getValue("src");e.end()},p._useOut=function(t){var e=t.getValue("src");e.end(),e=t.getValue("out"),e.start(),e.clear(0,0,0,0)},p._endOut=function(t){var e=t.getValue("out");e.end()},p._recycleScope=function(t){t.recycle()},p._filter=function(t,e,i,n){var r=this._next;if(r){var a=t.filters,s=a.length;if(1==s&&32==a[0].type)return e.ctx.save(),e.ctx.setFilters([a[0]]),r._fun.call(r,t,e,i,n),void e.ctx.restore();var o,h,l=rt.create(),u=S.TEMP,c=e.ctx._getTransformMatrix(),_=v.create();c.copyTo(_);var d=0,f=0,m=!1,g=t._$P._filterCache?t._$P._filterCache:null;if(!g||t._repaint){m=t._isHaveGlowFilter(),l.addValue("_isHaveGlowFilter",m),m&&(d=50,f=25),h=new T,h.copyFrom(t.getSelfBounds()),h.x+=t.x,h.y+=t.y,h.x-=t.pivotX+4,h.y-=t.pivotY+4;var y=h.x,x=h.y;if(h.width+=d+8,h.height+=d+8,u.x=h.x*_.a+h.y*_.c,u.y=h.y*_.d+h.x*_.b,h.x=u.x,h.y=u.y,u.x=h.width*_.a+h.height*_.c,u.y=h.height*_.d+h.width*_.b,h.width=u.x,h.height=u.y,h.width<=0||h.height<=0)return;g&&g.recycle(),l.addValue("bounds",h);var E=nt.create([l,t,e,0,0],p._filterStart);e.addRenderObject(E),e.ctx._renderKey=0,e.ctx._shader2D.glTexture=null;var w=t.x-y+f,b=t.y-x+f;r._fun.call(r,t,e,w,b),E=nt.create([l,t,e,0,0],p._filterEnd),e.addRenderObject(E);for(var C=0;s>C;C++){0!=C&&(E=nt.create([l],p._useSrc),e.addRenderObject(E),o=vt.create(1,0),v.TEMP.identity(),e.ctx.drawTarget(l,0,0,h.width,h.height,v.TEMP,"out",o,null,H.TOINT.overlay),E=nt.create([l],p._useOut),e.addRenderObject(E));var M=a[C];M.action.apply3d(l,t,e,0,0)}E=nt.create([l,e],p._EndTarget),e.addRenderObject(E)}else{if(m=t._$P._isHaveGlowFilter?t._$P._isHaveGlowFilter:!1,m&&(d=50,f=25),h=t.getBounds(),h.width<=0||h.height<=0)return;h.width+=d,h.height+=d,u.x=h.x*_.a+h.y*_.c,u.y=h.y*_.d+h.x*_.b,h.x=u.x,h.y=u.y,u.x=h.width*_.a+h.height*_.c,u.y=h.height*_.d+h.width*_.b,h.width=u.x,h.height=u.y,l.addValue("out",g)}i=i-f-t.x,n=n-f-t.y,u.setTo(i,n),_.transformPoint(u),i=u.x+h.x,n=u.y+h.y,o=vt.create(1,0),v.TEMP.identity(),e.ctx.drawTarget(l,i,n,h.width,h.height,v.TEMP,"out",o,null,H.TOINT.overlay),E=nt.create([l],p._recycleScope),e.addRenderObject(E),_.destroy()}},Float32Array.prototype.slice||(Float32Array.prototype.slice=t._float32ArraySlice),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=t._uint16ArraySlice),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=t._uint8ArraySlice),!0},t.onStageResize=function(e,i){null!=t.mainContext&&(t.mainContext.viewport(0,0,e,i),ft.width=e,ft.height=i)},t.onInvalidGLRes=function(){U.instance.freeAll(),C.releaseContentManagers(!0),t.doNodeRepaint(i.stage),t.mainContext.viewport(0,0,ft.width,ft.height),i.stage.event("devicelost")},t.doNodeRepaint=function(e){0==e.numChildren&&e.repaint();for(var i=0;i<e.numChildren;i++)t.doNodeRepaint(e.getChildAt(i))},t.init=function(e,i,n){t.mainCanvas=e,g._createContext=function(t){return new xt(t)};var r=laya.webgl.WebGL.mainContext;if(null!=r.getShaderPrecisionFormat){var a=r.getShaderPrecisionFormat(35632,36338);t.frameShaderHighPrecision=a.precision?!0:!1}else t.frameShaderHighPrecision=!1;if(t.compressAstc=r.getExtension("WEBGL_compressed_texture_astc"),t.compressAtc=r.getExtension("WEBGL_compressed_texture_atc"),t.compressEtc=r.getExtension("WEBGL_compressed_texture_etc"),t.compressEtc1=r.getExtension("WEBGL_compressed_texture_etc1"),t.compressPvrtc=r.getExtension("WEBGL_compressed_texture_pvrtc"),t.compressS3tc=r.getExtension("WEBGL_compressed_texture_s3tc"),t.compressS3tc_srgb=r.getExtension("WEBGL_compressed_texture_s3tc_srgb"),r.deleteTexture1=r.deleteTexture,r.deleteTexture=function(t){t==gt.curBindTexValue&&(gt.curBindTexValue=null),r.deleteTexture1(t)},t.onStageResize(i,n),null==t.mainContext)throw new Error("webGL getContext err!");I.__init__(),U.__init__(),wt.__init__(),it.__init__(),xt.__init__(),vt.__init__(),$.__init__(),Gt.__int__(r),H._init_(r),E.isConchApp&&conch.setOnInvalidGLRes(t.onInvalidGLRes)},t.compressAstc=null,t.compressAtc=null,t.compressEtc=null,t.compressEtc1=null,t.compressPvrtc=null,t.compressS3tc=null,t.compressS3tc_srgb=null,t.mainCanvas=null,t.mainContext=null,t.antialias=!0,t.frameShaderHighPrecision=!1,t._bg_null=[0,0,0,0],t}(),gt=function(){function t(){}return r(t,"laya.webgl.WebGLContext"),t.UseProgram=function(e){return t._useProgram===e?!1:(mt.mainContext.useProgram(e),t._useProgram=e,!0)},t.setDepthTest=function(e,i){i!==t._depthTest&&(t._depthTest=i,i?e.enable(2929):e.disable(2929))},t.setDepthMask=function(e,i){i!==t._depthMask&&(t._depthMask=i,e.depthMask(i))},t.setDepthFunc=function(e,i){i!==t._depthFunc&&(t._depthFunc=i,e.depthFunc(i))},t.setBlend=function(e,i){i!==t._blend&&(t._blend=i,i?e.enable(3042):e.disable(3042))},t.setBlendFunc=function(e,i,n){(i!==t._sFactor||n!==t._dFactor)&&(t._sFactor=i,t._dFactor=n,e.blendFunc(i,n))},t.setCullFace=function(e,i){i!==t._cullFace&&(t._cullFace=i,i?e.enable(2884):e.disable(2884))},t.setFrontFace=function(e,i){i!==t._frontFace&&(t._frontFace=i,e.frontFace(i))},t.bindTexture=function(e,i,n){e.bindTexture(i,n),t.curBindTexTarget=i,t.curBindTexValue=n},t.DEPTH_BUFFER_BIT=256,t.STENCIL_BUFFER_BIT=1024,t.COLOR_BUFFER_BIT=16384,t.POINTS=0,t.LINES=1,t.LINE_LOOP=2,t.LINE_STRIP=3,t.TRIANGLES=4,t.TRIANGLE_STRIP=5,t.TRIANGLE_FAN=6,t.ZERO=0,t.ONE=1,t.SRC_COLOR=768,t.ONE_MINUS_SRC_COLOR=769,t.SRC_ALPHA=770,t.ONE_MINUS_SRC_ALPHA=771,t.DST_ALPHA=772,t.ONE_MINUS_DST_ALPHA=773,t.DST_COLOR=774,t.ONE_MINUS_DST_COLOR=775,t.SRC_ALPHA_SATURATE=776,t.FUNC_ADD=32774,t.BLEND_EQUATION=32777,t.BLEND_EQUATION_RGB=32777,t.BLEND_EQUATION_ALPHA=34877,t.FUNC_SUBTRACT=32778,t.FUNC_REVERSE_SUBTRACT=32779,t.BLEND_DST_RGB=32968,t.BLEND_SRC_RGB=32969,t.BLEND_DST_ALPHA=32970,t.BLEND_SRC_ALPHA=32971,t.CONSTANT_COLOR=32769,t.ONE_MINUS_CONSTANT_COLOR=32770,t.CONSTANT_ALPHA=32771,t.ONE_MINUS_CONSTANT_ALPHA=32772,t.BLEND_COLOR=32773,t.ARRAY_BUFFER=34962,t.ELEMENT_ARRAY_BUFFER=34963,t.ARRAY_BUFFER_BINDING=34964,t.ELEMENT_ARRAY_BUFFER_BINDING=34965,t.STREAM_DRAW=35040,t.STATIC_DRAW=35044,t.DYNAMIC_DRAW=35048,t.BUFFER_SIZE=34660,t.BUFFER_USAGE=34661,t.CURRENT_VERTEX_ATTRIB=34342,t.FRONT=1028,t.BACK=1029,t.CULL_FACE=2884,t.FRONT_AND_BACK=1032,t.BLEND=3042,t.DITHER=3024,t.STENCIL_TEST=2960,t.DEPTH_TEST=2929,t.SCISSOR_TEST=3089,t.POLYGON_OFFSET_FILL=32823,t.SAMPLE_ALPHA_TO_COVERAGE=32926,t.SAMPLE_COVERAGE=32928,t.NO_ERROR=0,t.INVALID_ENUM=1280,t.INVALID_VALUE=1281,t.INVALID_OPERATION=1282,t.OUT_OF_MEMORY=1285,t.CW=2304,t.CCW=2305,t.LINE_WIDTH=2849,t.ALIASED_POINT_SIZE_RANGE=33901,t.ALIASED_LINE_WIDTH_RANGE=33902,t.CULL_FACE_MODE=2885,t.FRONT_FACE=2886,t.DEPTH_RANGE=2928,t.DEPTH_WRITEMASK=2930,t.DEPTH_CLEAR_VALUE=2931,t.DEPTH_FUNC=2932,t.STENCIL_CLEAR_VALUE=2961,t.STENCIL_FUNC=2962,t.STENCIL_FAIL=2964,t.STENCIL_PASS_DEPTH_FAIL=2965,t.STENCIL_PASS_DEPTH_PASS=2966,t.STENCIL_REF=2967,t.STENCIL_VALUE_MASK=2963,t.STENCIL_WRITEMASK=2968,t.STENCIL_BACK_FUNC=34816,t.STENCIL_BACK_FAIL=34817,t.STENCIL_BACK_PASS_DEPTH_FAIL=34818,t.STENCIL_BACK_PASS_DEPTH_PASS=34819,t.STENCIL_BACK_REF=36003,t.STENCIL_BACK_VALUE_MASK=36004,t.STENCIL_BACK_WRITEMASK=36005,t.VIEWPORT=2978,t.SCISSOR_BOX=3088,t.COLOR_CLEAR_VALUE=3106,t.COLOR_WRITEMASK=3107,t.UNPACK_ALIGNMENT=3317,t.PACK_ALIGNMENT=3333,t.MAX_TEXTURE_SIZE=3379,t.MAX_VIEWPORT_DIMS=3386,t.SUBPIXEL_BITS=3408,t.RED_BITS=3410,t.GREEN_BITS=3411,t.BLUE_BITS=3412,t.ALPHA_BITS=3413,t.DEPTH_BITS=3414,t.STENCIL_BITS=3415,t.POLYGON_OFFSET_UNITS=10752,t.POLYGON_OFFSET_FACTOR=32824,t.TEXTURE_BINDING_2D=32873,t.SAMPLE_BUFFERS=32936,t.SAMPLES=32937,t.SAMPLE_COVERAGE_VALUE=32938,t.SAMPLE_COVERAGE_INVERT=32939,t.NUM_COMPRESSED_TEXTURE_FORMATS=34466,t.COMPRESSED_TEXTURE_FORMATS=34467,t.DONT_CARE=4352,t.FASTEST=4353,t.NICEST=4354,t.GENERATE_MIPMAP_HINT=33170,t.BYTE=5120,t.UNSIGNED_BYTE=5121,t.SHORT=5122,t.UNSIGNED_SHORT=5123,t.INT=5124,t.UNSIGNED_INT=5125,t.FLOAT=5126,t.DEPTH_COMPONENT=6402,t.ALPHA=6406,t.RGB=6407,t.RGBA=6408,t.LUMINANCE=6409,t.LUMINANCE_ALPHA=6410,t.UNSIGNED_SHORT_4_4_4_4=32819,t.UNSIGNED_SHORT_5_5_5_1=32820,t.UNSIGNED_SHORT_5_6_5=33635,t.FRAGMENT_SHADER=35632,t.VERTEX_SHADER=35633,t.MAX_VERTEX_ATTRIBS=34921,t.MAX_VERTEX_UNIFORM_VECTORS=36347,t.MAX_VARYING_VECTORS=36348,t.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661,t.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660,t.MAX_TEXTURE_IMAGE_UNITS=34930,t.MAX_FRAGMENT_UNIFORM_VECTORS=36349,t.SHADER_TYPE=35663,t.DELETE_STATUS=35712,t.LINK_STATUS=35714,t.VALIDATE_STATUS=35715,t.ATTACHED_SHADERS=35717,t.ACTIVE_UNIFORMS=35718,t.ACTIVE_ATTRIBUTES=35721,t.SHADING_LANGUAGE_VERSION=35724,t.CURRENT_PROGRAM=35725,t.NEVER=512,t.LESS=513,t.EQUAL=514,t.LEQUAL=515,t.GREATER=516,t.NOTEQUAL=517,t.GEQUAL=518,t.ALWAYS=519,t.KEEP=7680,t.REPLACE=7681,t.INCR=7682,t.DECR=7683,t.INVERT=5386,t.INCR_WRAP=34055,t.DECR_WRAP=34056,t.VENDOR=7936,t.RENDERER=7937,t.VERSION=7938,t.NEAREST=9728,t.LINEAR=9729,t.NEAREST_MIPMAP_NEAREST=9984,t.LINEAR_MIPMAP_NEAREST=9985,t.NEAREST_MIPMAP_LINEAR=9986,t.LINEAR_MIPMAP_LINEAR=9987,t.TEXTURE_MAG_FILTER=10240,t.TEXTURE_MIN_FILTER=10241,t.TEXTURE_WRAP_S=10242,t.TEXTURE_WRAP_T=10243,t.TEXTURE_2D=3553,t.TEXTURE=5890,t.TEXTURE_CUBE_MAP=34067,t.TEXTURE_BINDING_CUBE_MAP=34068,t.TEXTURE_CUBE_MAP_POSITIVE_X=34069,t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070,t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071,t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072,t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073,t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074,t.MAX_CUBE_MAP_TEXTURE_SIZE=34076,t.TEXTURE0=33984,t.TEXTURE1=33985,t.TEXTURE2=33986,t.TEXTURE3=33987,t.TEXTURE4=33988,t.TEXTURE5=33989,t.TEXTURE6=33990,t.TEXTURE7=33991,t.TEXTURE8=33992,t.TEXTURE9=33993,t.TEXTURE10=33994,t.TEXTURE11=33995,t.TEXTURE12=33996,t.TEXTURE13=33997,t.TEXTURE14=33998,t.TEXTURE15=33999,t.TEXTURE16=34e3,t.TEXTURE17=34001,t.TEXTURE18=34002,t.TEXTURE19=34003,t.TEXTURE20=34004,t.TEXTURE21=34005,t.TEXTURE22=34006,t.TEXTURE23=34007,t.TEXTURE24=34008,t.TEXTURE25=34009,t.TEXTURE26=34010,t.TEXTURE27=34011,t.TEXTURE28=34012,t.TEXTURE29=34013,t.TEXTURE30=34014,t.TEXTURE31=34015,t.ACTIVE_TEXTURE=34016,t.REPEAT=10497,t.CLAMP_TO_EDGE=33071,t.MIRRORED_REPEAT=33648,t.FLOAT_VEC2=35664,t.FLOAT_VEC3=35665,t.FLOAT_VEC4=35666,t.INT_VEC2=35667,t.INT_VEC3=35668,t.INT_VEC4=35669,t.BOOL=35670,t.BOOL_VEC2=35671,t.BOOL_VEC3=35672,t.BOOL_VEC4=35673,t.FLOAT_MAT2=35674,t.FLOAT_MAT3=35675,t.FLOAT_MAT4=35676,t.SAMPLER_2D=35678,t.SAMPLER_CUBE=35680,t.VERTEX_ATTRIB_ARRAY_ENABLED=34338,t.VERTEX_ATTRIB_ARRAY_SIZE=34339,t.VERTEX_ATTRIB_ARRAY_STRIDE=34340,t.VERTEX_ATTRIB_ARRAY_TYPE=34341,t.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922,t.VERTEX_ATTRIB_ARRAY_POINTER=34373,t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975,t.COMPILE_STATUS=35713,t.LOW_FLOAT=36336,t.MEDIUM_FLOAT=36337,t.HIGH_FLOAT=36338,t.LOW_INT=36339,t.MEDIUM_INT=36340,t.HIGH_INT=36341,t.FRAMEBUFFER=36160,t.RENDERBUFFER=36161,t.RGBA4=32854,t.RGB5_A1=32855,t.RGB565=36194,t.DEPTH_COMPONENT16=33189,t.STENCIL_INDEX=6401,t.STENCIL_INDEX8=36168,t.DEPTH_STENCIL=34041,t.RENDERBUFFER_WIDTH=36162,t.RENDERBUFFER_HEIGHT=36163,t.RENDERBUFFER_INTERNAL_FORMAT=36164,t.RENDERBUFFER_RED_SIZE=36176,t.RENDERBUFFER_GREEN_SIZE=36177,t.RENDERBUFFER_BLUE_SIZE=36178,t.RENDERBUFFER_ALPHA_SIZE=36179,t.RENDERBUFFER_DEPTH_SIZE=36180,t.RENDERBUFFER_STENCIL_SIZE=36181,t.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048,t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049,t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050,t.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051,t.COLOR_ATTACHMENT0=36064,t.DEPTH_ATTACHMENT=36096,t.STENCIL_ATTACHMENT=36128,t.DEPTH_STENCIL_ATTACHMENT=33306,t.NONE=0,t.FRAMEBUFFER_COMPLETE=36053,t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054,t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055,t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057,t.FRAMEBUFFER_UNSUPPORTED=36061,t.FRAMEBUFFER_BINDING=36006,t.RENDERBUFFER_BINDING=36007,t.MAX_RENDERBUFFER_SIZE=34024,t.INVALID_FRAMEBUFFER_OPERATION=1286,t.UNPACK_FLIP_Y_WEBGL=37440,t.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441,t.CONTEXT_LOST_WEBGL=37442,t.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443,t.BROWSER_DEFAULT_WEBGL=37444,t._useProgram=null,t._depthTest=!0,t._depthMask=!0,t._blend=!1,t._cullFace=!1,t.curBindTexTarget=null,t.curBindTexValue=null,n(t,["_depthFunc",function(){return this._depthFunc=513},"_sFactor",function(){return this._sFactor=1},"_dFactor",function(){return this._dFactor=0},"_frontFace",function(){return this._frontFace=2305}]),t}(),yt=function(t){function e(){e.__super.call(this)}r(e,"laya.webgl.display.GraphicsGL",t);var i=e.prototype;return i.setShader=function(t){this._saveToCmd(E.context._setShader,[t])},i.setIBVB=function(t,e,i,n,r,a){this._saveToCmd(E.context._setIBVB,[t,e,i,n,r,a])},i.drawParticle=function(t,e,i){var n=M.createParticleTemplate2D(i);n.x=t,n.y=e,this._saveToCmd(E.context._drawParticle,[n])},e}(m),xt=function(t){function e(t){this._x=0,this._y=0,this._id=++e._COUNT,
this._path=null,this._drawCount=1,this._maxNumEle=0,this._clear=!1,this._isMain=!1,this._atlasResourceChange=0,this._submits=[],this._curSubmit=null,this._ib=null,this._vb=null,this._nBlendType=0,this._saveMark=null,this.mId=-1,this.mHaveKey=!1,this.mHaveLineKey=!1,this.mX=0,this.mY=0,e.__super.call(this),this._width=99999999,this._height=99999999,this._clipRect=e.MAXCLIPRECT,this._shader2D=new $,this.mOutPoint,this._canvas=t,this._curMat=v.create(),E.isFlash?(this._ib=Xt.create(35044),dt.fillIBQuadrangle(this._ib,16)):this._ib=Xt.QuadrangleIB,this._vb=qt.create(-1),this._other=s.DEFAULT,this._save=[X.Create(this)],this._save.length=10,this.clear()}var s;r(e,"laya.webgl.canvas.WebGLContext2D",t);var o=e.prototype;return o.setIsMainContext=function(){this._isMain=!0},o.clearBG=function(t,e,i,n){var r=mt.mainContext;r.clearColor(t,e,i,n),r.clear(16384)},o._getSubmits=function(){return this._submits},o.destroy=function(){this.sprite=null,this._curMat&&this._curMat.destroy(),this._targets&&this._targets.destroy(),this._targets=null;for(var t=0,e=this._submits._length;e>t;t++)this._submits[t].releaseRender();this._submits.length=0,this._submits._length=0,this._curSubmit=null,this._path&&this._path.recover(),this._path=null,this._vb&&(this._vb.releaseResource(),this._vb.dispose(),this._vb.destory(),this._vb=null),this._canvas=null,this._ib&&this._ib!=Xt.QuadrangleIB&&this._ib.releaseResource()},o.clear=function(){this._vb.clear(),this._targets&&(this._targets.repaint=!0),this._other=s.DEFAULT,this._clear=!0,this._repaint=!1,this._drawCount=1,this._renderKey=0,this._other.lineWidth=this._shader2D.ALPHA=1,this._nBlendType=0,this._clipRect=e.MAXCLIPRECT,this._curSubmit=it.RENDERBASE,this._shader2D.glTexture=null,this._shader2D.fillStyle=this._shader2D.strokeStyle=z.DEFAULT;for(var t=0,i=this._submits._length;i>t;t++)this._submits[t].releaseRender();this._submits._length=0,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1},o.size=function(t,e){if(this._width!=t||this._height!=e)if(0==t||0==e){0!=this._vb._byteLength&&(this._width=t,this._height=e,this._vb.clear(),this._vb.upload());for(var i=0,n=this._submits._length;n>i;i++)this._submits[i].releaseRender();this._submits.length=0,this._submits._length=0,this._curSubmit=null,this._path&&this._path.recover(),this._path=null,this.sprite=null,this._targets&&this._targets.destroy(),this._targets=null}else this._width=t,this._height=e,this._targets&&this._targets.size(t,e),this._canvas.memorySize-=this._canvas.memorySize},o._getTransformMatrix=function(){return this._curMat},o.translate=function(t,e){(0!==t||0!==e)&&(K.save(this),this._curMat.bTransform&&(q.save(this),this._curMat.transformPointN(S.TEMP.setTo(t,e)),t=S.TEMP.x,e=S.TEMP.y),this._x+=t,this._y+=e)},o.save=function(){this._save[this._save._length++]=X.Create(this)},o.restore=function(){var t=this._save._length;if(!(1>t))for(var e=t-1;e>=0;e--){var i=this._save[e];if(i.restore(this),i.isSaveMark())return void(this._save._length=e)}},o._fillText=function(t,e,i,n,r,a,s,o,h){var l=this._shader2D,u=this._curSubmit.shaderValue,c=r?ct.create(r):this._other.font;if(U.enabled)l.ALPHA!==u.ALPHA&&(l.glTexture=null),ut.drawText(this,t,e,this._curMat,c,h||this._other.textAlign,a,s,o,i,n);else{var d=(this._shader2D.defines.getValue(),a?_.create(a)._color:l.colorAdd);(l.ALPHA!==u.ALPHA||d!==l.colorAdd||u.colorAdd!==l.colorAdd)&&(l.glTexture=null,l.colorAdd=d),ut.drawText(this,t,e,this._curMat,c,h||this._other.textAlign,a,s,o,i,n)}},o.fillWords=function(t,e,i,n,r){this._fillText(null,t,e,i,n,r,null,-1,null)},o.fillText=function(t,e,i,n,r,a){this._fillText(t,null,e,i,n,r,null,-1,a)},o.strokeText=function(t,e,i,n,r,a,s){this._fillText(t,null,e,i,n,null,r,a||1,s)},o.fillBorderText=function(t,e,i,n,r,a,s,o){this._fillBorderText(t,null,e,i,n,r,a,s,o)},o._fillBorderText=function(t,i,n,r,a,s,o,h,l){if(!U.enabled)return this._fillText(t,i,n,r,a,null,o,h||1,l),void this._fillText(t,i,n,r,a,s,null,-1,l);var u=this._shader2D,c=this._curSubmit.shaderValue;u.ALPHA!==c.ALPHA&&(u.glTexture=null);var _=a?(e._fontTemp.setFont(a),e._fontTemp):this._other.font;ut.drawText(this,t,i,this._curMat,_,l||this._other.textAlign,s,o,h||1,n,r)},o.fillBorderWords=function(t,e,i,n,r,a,s){this._fillBorderText(null,t,e,i,n,r,a,s,null)},o.fillRect=function(t,e,i,n,r){var a=this._vb;if(dt.fillRectImgVb(a,this._clipRect,t,e,i,n,L.DEF_UV,this._curMat,this._x,this._y,0,0)){this._renderKey=0;var s=this._shader2D.fillStyle;r&&(this._shader2D.fillStyle=z.create(r));var o=this._shader2D,h=this._curSubmit.shaderValue;if(o.fillStyle!==h.fillStyle||o.ALPHA!==h.ALPHA){o.glTexture=null;var l=this._curSubmit=it.create(this,this._ib,a,(a._byteLength-64)/32*3,vt.create(2,0));l.shaderValue.color=o.fillStyle._color._color,l.shaderValue.ALPHA=o.ALPHA,this._submits[this._submits._length++]=l}this._curSubmit._numEle+=6,this._shader2D.fillStyle=s}},o.fillTexture=function(t,e,n,r,a,s,o,h){if(!(t.loaded&&t.bitmap&&t.source))return void(this.sprite&&i.timer.callLater(this,this._repaintSprite));var l=this._vb,u=t.bitmap.width,c=t.bitmap.height,_=t.uv,d=o.x%t.width,f=o.y%t.height;if(u!=h.w||c!=h.h){if(!h.w&&!h.h)switch(h.oy=h.ox=0,s){case"repeat":h.width=r,h.height=a;break;case"repeat-x":h.width=r,0>f?t.height+f>a?h.height=a:h.height=t.height+f:(h.oy=f,t.height+f>a?h.height=a-f:h.height=t.height);break;case"repeat-y":0>d?t.width+d>r?h.width=r:h.width=t.width+d:(h.ox=d,t.width+d>r?h.width=r-d:h.width=t.width),h.height=a;break;default:h.width=r,h.height=a}h.w=u,h.h=c,h.uv=[0,0,h.width/u,0,h.width/u,h.height/c,0,h.height/c]}if(e+=h.ox,n+=h.oy,d-=h.ox,f-=h.oy,dt.fillRectImgVb(l,this._clipRect,e,n,h.width,h.height,h.uv,this._curMat,this._x,this._y,0,0)){this._renderKey=0;var p=At.create(this,this._ib,l,(l._byteLength-64)/32*3,vt.create(256,0));this._submits[this._submits._length++]=p;var m=p.shaderValue;m.textureHost=t;var g=_[0]*u,y=_[1]*c,x=(_[2]-_[0])*u,v=(_[5]-_[3])*c,S=-d/u,T=-f/c;m.u_TexRange[0]=g/u,m.u_TexRange[1]=x/u,m.u_TexRange[2]=y/c,m.u_TexRange[3]=v/c,m.u_offset[0]=S,m.u_offset[1]=T,U.enabled&&!this._isMain&&p.addTexture(t,(l._byteLength>>2)-16),this._curSubmit=p,p._renderType=10017,p._numEle+=6}},o.setShader=function(t){G.save(this,1048576,this._shader2D,!0),this._shader2D.shader=t},o.setFilters=function(t){G.save(this,2097152,this._shader2D,!0),this._shader2D.filters=t,this._curSubmit=it.RENDERBASE,this._renderKey=0,this._drawCount++},o.drawTexture=function(t,e,i,n,r,a,s){this._drawTextureM(t,e,i,n,r,a,s,null,1)},o.addTextureVb=function(t,e,i){var n=this._curSubmit._vb||this._vb,r=n._byteLength>>2;n.byteLength=r+16<<2;for(var a=n.getFloat32Array(),s=0;16>s;s+=4)a[r++]=t[s]+e,a[r++]=t[s+1]+i,a[r++]=t[s+2],a[r++]=t[s+3];this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle),n._upload=!0},o.willDrawTexture=function(t,e){if(!(t.loaded&&t.bitmap&&t.source))return this.sprite&&i.timer.callLater(this,this._repaintSprite),0;var n=t.bitmap,r=n.id+this._shader2D.ALPHA*e+10016;if(r==this._renderKey)return r;var a=this._shader2D,s=a.ALPHA,o=this._curSubmit.shaderValue;a.ALPHA*=e,this._renderKey=r,this._drawCount++,a.glTexture=n;var h=this._vb,l=null,u=h._byteLength/32*3;return l=At.create(this,this._ib,h,u,vt.create(1,0)),this._submits[this._submits._length++]=l,l.shaderValue.textureHost=t,l._renderType=10016,l._preIsSameTextureShader=10016===this._curSubmit._renderType&&a.ALPHA===o.ALPHA,this._curSubmit=l,a.ALPHA=s,r},o.drawTextures=function(t,n,r,a){if(!(t.loaded&&t.bitmap&&t.source))return void(this.sprite&&i.timer.callLater(this,this._repaintSprite));var s=this._clipRect;if(this._clipRect=e.MAXCLIPRECT,!this._drawTextureM(t,n[0],n[1],t.width,t.height,r,a,null,1))return void alert("drawTextures err");if(this._clipRect=s,A.drawCall++,!(n.length<4)){for(var o=this._curSubmit._vb||this._vb,h=this._curMat.a,l=this._curMat.d,u=2,c=n.length;c>u;u+=2)dt.copyPreImgVb(o,(n[u]-n[u-2])*h,(n[u+1]-n[u-1])*l),this._curSubmit._numEle+=6;this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle)}},o._drawTextureM=function(t,e,n,r,a,s,o,h,l){if(!t.loaded||!t.source)return this.sprite&&i.timer.callLater(this,this._repaintSprite),!1;var u=this._curSubmit._vb||this._vb,c=t.bitmap;e+=s,n+=o,this._drawCount++;var _=c.id+this._shader2D.ALPHA*l+10016;if(_!=this._renderKey){this._renderKey=_;var d=this._curSubmit.shaderValue,f=this._shader2D,p=f.ALPHA;f.ALPHA*=l,f.glTexture=c;var m=this._vb,g=null,y=m._byteLength/32*3;g=At.create(this,this._ib,m,y,vt.create(1,0)),this._submits[this._submits._length++]=g,g.shaderValue.textureHost=t,g._renderType=10016,g._preIsSameTextureShader=10016===this._curSubmit._renderType&&f.ALPHA===d.ALPHA,this._curSubmit=g,u=this._curSubmit._vb||this._vb,f.ALPHA=p}return dt.fillRectImgVb(u,this._clipRect,e,n,r||t.width,a||t.height,t.uv,h||this._curMat,this._x,this._y,0,0)?(U.enabled&&!this._isMain&&this._curSubmit.addTexture(t,(u._byteLength>>2)-16),this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle),!0):!1},o._repaintSprite=function(){this.sprite.repaint()},o._drawText=function(t,e,i,n,r,a,s,o,h,l){var u=t.bitmap;this._drawCount++;var c=u.id+this._shader2D.ALPHA+10016;if(c!=this._renderKey){this._renderKey=c;var _=this._curSubmit.shaderValue,d=this._shader2D;d.glTexture=u;var f=this._vb,p=null,m=f._byteLength/32*3;p=U.enabled?At.create(this,this._ib,f,m,vt.create(1,0)):At.create(this,this._ib,f,m,jt.create()),p._preIsSameTextureShader=10016===this._curSubmit._renderType&&d.ALPHA===_.ALPHA,this._submits[this._submits._length++]=p,p.shaderValue.textureHost=t,p._renderType=10016,this._curSubmit=p}t.active();var g=this._curSubmit._vb||this._vb;dt.fillRectImgVb(g,this._clipRect,e+s,i+o,n||t.width,r||t.height,t.uv,a||this._curMat,this._x,this._y,h,l,!0)&&(U.enabled&&!this._isMain&&this._curSubmit.addTexture(t,(g._byteLength>>2)-16),this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle))},o.drawTextureWithTransform=function(t,i,n,r,a,s,o,h,l){if(!s)return void this._drawTextureM(t,i,n,r,a,o,h,null,l);var u=this._curMat,c=this._x,_=this._y;(0!==o||0!==h)&&(this._x=o*u.a+h*u.c,this._y=h*u.d+o*u.b),s&&u.bTransform?(v.mul(s,u,e._tmpMatrix),s=e._tmpMatrix,s._checkTransform()):(this._x+=u.tx,this._y+=u.ty),this._drawTextureM(t,i,n,r,a,0,0,s,l),this._x=c,this._y=_},o.fillQuadrangle=function(t,e,i,n,r){var a=this._curSubmit,s=this._vb,o=this._shader2D,h=a.shaderValue;if(this._renderKey=0,t.bitmap){var l=t.bitmap;(o.glTexture!=l||o.ALPHA!==h.ALPHA)&&(o.glTexture=l,a=this._curSubmit=it.create(this,this._ib,s,s._byteLength/32*3,vt.create(1,0)),a.shaderValue.glTexture=l,this._submits[this._submits._length++]=a),dt.fillQuadrangleImgVb(s,e,i,n,t.uv,r||this._curMat,this._x,this._y)}else a.shaderValue.fillStyle&&a.shaderValue.fillStyle.equal(t)&&o.ALPHA===h.ALPHA||(o.glTexture=null,a=this._curSubmit=it.create(this,this._ib,s,s._byteLength/32*3,vt.create(2,0)),a.shaderValue.defines.add(2),a.shaderValue.fillStyle=z.create(t),this._submits[this._submits._length++]=a),dt.fillQuadrangleImgVb(s,e,i,n,L.DEF_UV,r||this._curMat,this._x,this._y);a._numEle+=6},o.drawTexture2=function(t,i,n,r,a,s,o,h){if(0!=s){var l=this._curMat;if(this._x=t*l.a+i*l.c,this._y=i*l.d+t*l.b,a&&(l.bTransform||a.bTransform?(v.mul(a,l,e._tmpMatrix),a=e._tmpMatrix):(this._x+=a.tx+l.tx,this._y+=a.ty+l.ty,a=v.EMPTY)),1!==s||o){var u=this._shader2D.ALPHA,c=this._nBlendType;this._shader2D.ALPHA=s,o&&(this._nBlendType=H.TOINT(o)),this._drawTextureM(h[0],h[1]-n,h[2]-r,h[3],h[4],0,0,a,1),this._shader2D.ALPHA=u,this._nBlendType=c}else this._drawTextureM(h[0],h[1]-n,h[2]-r,h[3],h[4],0,0,a,1);this._x=this._y=0}},o.drawCanvas=function(t,e,i,n,r){var a=t.context;if(this._renderKey=0,a._targets)this._submits[this._submits._length++]=Dt.create(a,0,null),this._curSubmit=it.RENDERBASE,a._targets.drawTo(this,e,i,n,r);else{var s=this._submits[this._submits._length++]=Dt.create(a,this._shader2D.ALPHA,this._shader2D.filters),o=n/t.width,h=r/t.height,l=s._matrix;this._curMat.copyTo(l),1!=o&&1!=h&&l.scale(o,h);var u=l.tx,c=l.ty;l.tx=l.ty=0,l.transformPoint(S.TEMP.setTo(e,i)),l.translate(S.TEMP.x+u,S.TEMP.y+c),this._curSubmit=it.RENDERBASE}d.showCanvasMark&&(this.save(),this.lineWidth=4,this.strokeStyle=a._targets?"yellow":"green",this.strokeRect(e-1,i-1,n+2,r+2,1),this.strokeRect(e,i,n,r,1),this.restore())},o.drawTarget=function(t,e,i,n,r,a,s,o,h,l){void 0===l&&(l=-1);var u=this._vb;if(dt.fillRectImgVb(u,this._clipRect,e,i,n,r,h||L.DEF_UV,a||this._curMat,this._x,this._y,0,0)){this._renderKey=0;var c=this._shader2D;c.glTexture=null;var _=(this._curSubmit.shaderValue,this._curSubmit=ht.create(this,this._ib,u,(u._byteLength-64)/32*3,o,s));-1==l?_.blendType=this._nBlendType:_.blendType=l,_.scope=t,this._submits[this._submits._length++]=_,this._curSubmit._numEle+=6}},o.transform=function(t,e,i,n,r,a){q.save(this),v.mul(v.TEMP.setTo(t,e,i,n,r,a),this._curMat,this._curMat),this._curMat._checkTransform()},o.setTransformByMatrix=function(t){t.copyTo(this._curMat)},o.transformByMatrix=function(t){q.save(this),v.mul(t,this._curMat,this._curMat),this._curMat._checkTransform()},o.rotate=function(t){q.save(this),this._curMat.rotateEx(t)},o.scale=function(t,e){q.save(this),this._curMat.scaleEx(t,e)},o.clipRect=function(t,e,i,n){if(0!=this._curMat.b||0!=this._curMat.c){this._renderKey=0;var r=ot.create(4);this.addRenderObject(r);var a=this._vb,s=a._byteLength>>2;if(dt.fillRectImgVb(a,null,t,e,i,n,L.DEF_UV,this._curMat,this._x,this._y,0,0)){var o=this._shader2D;o.glTexture=null;var h=this._curSubmit=it.create(this,this._ib,a,(a._byteLength-64)/32*3,vt.create(2,0));h.shaderValue.ALPHA=1,this._submits[this._submits._length++]=h,this._curSubmit._numEle+=6}else alert("clipRect calc stencil rect error");var l=ot.create(5);this.addRenderObject(l);var u=a.getFloat32Array(),c=Math.min(Math.min(Math.min(u[s+0],u[s+4]),u[s+8]),u[s+12]),_=Math.max(Math.max(Math.max(u[s+0],u[s+4]),u[s+8]),u[s+12]),d=Math.min(Math.min(Math.min(u[s+1],u[s+5]),u[s+9]),u[s+13]),f=Math.max(Math.max(Math.max(u[s+1],u[s+5]),u[s+9]),u[s+13]);Y.save(this,l),this._clipRect.x=c,this._clipRect.y=d,this._clipRect.width=_-c,this._clipRect.height=f-d,this._curSubmit=it.RENDERBASE}else{i*=this._curMat.a,n*=this._curMat.d;var p=S.TEMP;this._curMat.transformPoint(p.setTo(t,e)),this._renderKey=0;var m=this._curSubmit=st.create(this);this._submits[this._submits._length++]=m,m.submitIndex=this._submits._length,m.submitLength=9999999,j.save(this,m);var g=this._clipRect,y=g.x,x=g.y,v=p.x+i,T=p.y+n;y<p.x&&(g.x=p.x),x<p.y&&(g.y=p.y),g.width=Math.min(v,y+g.width)-g.x,g.height=Math.min(T,x+g.height)-g.y,this._shader2D.glTexture=null,m.clipRect.copyFrom(g),this._curSubmit=it.RENDERBASE}},o.setIBVB=function(t,e,i,n,r,a,s,o,h,l,u){if(void 0===h&&(h=0),void 0===l&&(l=0),void 0===u&&(u=0),null===i){if(E.isFlash){var c=n;c._selfIB||(c._selfIB=Xt.create(35044)),c._selfIB.clear(),i=c._selfIB}else i=this._ib;dt.expandIBQuadrangle(i,n.byteLength/(4*n.vertexStride*4))}if(!o||!s)throw Error("setIBVB must input:shader shaderValues");var _=at.create(this,n,i,r,s,o,h,l,u);a||(a=v.EMPTY),a.translate(t,e),v.mul(a,this._curMat,_._mat),a.translate(-t,-e),this._submits[this._submits._length++]=_,this._curSubmit=it.RENDERBASE,this._renderKey=0},o.addRenderObject=function(t){this._submits[this._submits._length++]=t},o.fillTrangles=function(t,e,i,n,r){var a=this._curSubmit,s=this._vb,o=this._shader2D,h=a.shaderValue,l=n.length>>4,u=t.bitmap;this._renderKey=0,(o.glTexture!=u||o.ALPHA!==h.ALPHA)&&(a=this._curSubmit=it.create(this,this._ib,s,s._byteLength/32*3,vt.create(1,0)),a.shaderValue.textureHost=t,this._submits[this._submits._length++]=a),dt.fillTranglesVB(s,e,i,n,r||this._curMat,this._x,this._y),a._numEle+=6*l},o.submitElement=function(t,e){var i=this._submits;for(0>e&&(e=i._length);e>t;)t+=i[t].renderSubmit()},o.finish=function(){mt.mainContext.finish()},o.flush=function(){var t=Math.max(this._vb.byteLength/64,this._maxNumEle/6)+8;if(t>this._ib.bufferLength/12&&dt.expandIBQuadrangle(this._ib,t),!this._isMain&&U.enabled&&U._atlasRestore>this._atlasResourceChange){this._atlasResourceChange=U._atlasRestore;for(var e=this._submits,i=0,n=e._length;n>i;i++){var r=e[i];10016===r.getRenderType()&&r.checkTexture()}}return this.submitElement(0,this._submits._length),this._path&&this._path.reset(),tt.instance&&tt.getInstance().reset(),this._curSubmit=it.RENDERBASE,this._renderKey=0,this._submits._length},o.setPathId=function(t){if(this.mId=t,-1!=this.mId){this.mHaveKey=!1;var e=O.getInstance();e.shapeDic[this.mId]&&(this.mHaveKey=!0),this.mHaveLineKey=!1,e.shapeLineDic[this.mId]&&(this.mHaveLineKey=!0)}},o.movePath=function(t,e){var i=t,n=e;t=this._curMat.a*i+this._curMat.c*n+this._curMat.tx,e=this._curMat.b*i+this._curMat.d*n+this._curMat.ty,this.mX+=t,this.mY+=e},o.beginPath=function(){var t=this._getPath();t.tempArray.length=0,t.closePath=!1,this.mX=0,this.mY=0},o.closePath=function(){this._path.closePath=!0},o.fill=function(t){void 0===t&&(t=!1);var e=this._getPath();this.drawPoly(0,0,e.tempArray,this.fillStyle._color.numColor,0,0,t)},o.stroke=function(){var t=this._getPath();if(this.lineWidth>0){if(-1==this.mId)t.drawLine(0,0,t.tempArray,this.lineWidth,this.strokeStyle._color.numColor);else if(this.mHaveLineKey){var e=O.getInstance().shapeLineDic[this.mId];e.rebuild(t.tempArray),t.setGeomtry(e)}else O.getInstance().addLine(this.mId,t.drawLine(0,0,t.tempArray,this.lineWidth,this.strokeStyle._color.numColor));t.update();var i=[this.mX,this.mY],n=it.createShape(this,t.ib,t.vb,t.count,t.offset,vt.create(4,0));n.shaderValue.ALPHA=this._shader2D.ALPHA,n.shaderValue.u_pos=i,n.shaderValue.u_mmat2=ft.TEMPMAT4_ARRAY,this._submits[this._submits._length++]=n}},o.line=function(t,e,i,n,r,a){var s=this._curSubmit,o=this._vb;if(dt.fillLineVb(o,this._clipRect,t,e,i,n,r,a)){this._renderKey=0;var h=this._shader2D,l=s.shaderValue;(h.strokeStyle!==l.strokeStyle||h.ALPHA!==l.ALPHA)&&(h.glTexture=null,s=this._curSubmit=it.create(this,this._ib,o,(o._byteLength-64)/32*3,vt.create(2,0)),s.shaderValue.strokeStyle=h.strokeStyle,s.shaderValue.mainID=2,s.shaderValue.ALPHA=h.ALPHA,this._submits[this._submits._length++]=s),s._numEle+=6}},o.moveTo=function(t,e,i){void 0===i&&(i=!0);var n=this._getPath();if(i){var r=t,a=e;t=this._curMat.a*r+this._curMat.c*a+this._curMat.tx,e=this._curMat.b*r+this._curMat.d*a+this._curMat.ty}n.addPoint(t,e)},o.lineTo=function(t,e,i){void 0===i&&(i=!0);var n=this._getPath();if(i){var r=t,a=e;t=this._curMat.a*r+this._curMat.c*a+this._curMat.tx,e=this._curMat.b*r+this._curMat.d*a+this._curMat.ty}n.addPoint(t,e)},o.drawCurves=function(t,e,i){this.setPathId(-1),this.beginPath(),this.strokeStyle=i[3],this.lineWidth=i[4];var n=i[2];t+=i[0],e+=i[1],this.moveTo(t+n[0],e+n[1]);for(var r=2,a=n.length;a>r;)this.quadraticCurveTo(t+n[r++],e+n[r++],t+n[r++],e+n[r++]);this.stroke()},o.arcTo=function(t,e,i,n,r){if(-1==this.mId||!this.mHaveKey){var a=this._getPath(),s=a.getEndPointX(),o=a.getEndPointY(),h=NaN,l=NaN,u=NaN,c=NaN,_=NaN,d=NaN,f=NaN,p=NaN,m=NaN,g=NaN,y=!1,x=t,v=e;t=this._curMat.a*x+this._curMat.c*v+this._curMat.tx,e=this._curMat.b*x+this._curMat.d*v+this._curMat.ty,x=i,v=n,i=this._curMat.a*x+this._curMat.c*v+this._curMat.tx,n=this._curMat.b*x+this._curMat.d*v+this._curMat.ty,r=this._curMat.a*r+this._curMat.c*r,h=s-t,l=o-e,u=i-t,c=n-e,S.TEMP.setTo(h,l),S.TEMP.normalize(),h=S.TEMP.x,l=S.TEMP.y,S.TEMP.setTo(u,c),S.TEMP.normalize(),u=S.TEMP.x,c=S.TEMP.y,_=Math.acos(h*u+l*c);var T=Math.tan(_/2);if(d=r/T,d>1e4)return void this.lineTo(t,e);0>=h*c-u*l?(f=t+h*d+l*r,p=e+l*d-h*r,m=Math.atan2(h,-l),g=Math.atan2(-u,c),y=!1):(f=t+h*d-l*r,p=e+l*d+h*r,m=Math.atan2(-h,l),g=Math.atan2(u,-c),y=!0),this.arc(f,p,r,m,g,y,!1)}},o.arc=function(t,e,i,n,r,a,s){if(void 0===a&&(a=!1),void 0===s&&(s=!0),-1!=this.mId){var o=O.getInstance().shapeDic[this.mId];if(o&&this.mHaveKey&&!o.needUpdate(this._curMat))return;t=0,e=0}var h=0,l=0,u=0,c=0,_=0,d=0,f=0,p=0,m=0,g=0,y=0;if(l=r-n,a)if(Math.abs(l)>=2*Math.PI)l=2*-Math.PI;else for(;l>0;)l-=2*Math.PI;else if(Math.abs(l)>=2*Math.PI)l=2*Math.PI;else for(;0>l;)l+=2*Math.PI;g=101>i?Math.max(10,l*i/5):201>i?Math.max(10,l*i/20):Math.max(10,l*i/40),u=l/g/2,c=Math.abs(4/3*(1-Math.cos(u))/Math.sin(u)),a&&(c=-c),y=0;var x=this._getPath(),v=NaN,S=NaN;for(m=0;g>=m;m++)h=n+l*(m/g),_=Math.cos(h),d=Math.sin(h),f=t+_*i,p=e+d*i,s&&(v=f,S=p,f=this._curMat.a*v+this._curMat.c*S+this._curMat.tx,p=this._curMat.b*v+this._curMat.d*S+this._curMat.ty),(f!=this._path.getEndPointX()||p!=this._path.getEndPointY())&&x.addPoint(f,p);_=Math.cos(r),d=Math.sin(r),f=t+_*i,p=e+d*i,s&&(v=f,S=p,f=this._curMat.a*v+this._curMat.c*S+this._curMat.tx,p=this._curMat.b*v+this._curMat.d*S+this._curMat.ty),(f!=this._path.getEndPointX()||p!=this._path.getEndPointY())&&x.addPoint(f,p)},o.quadraticCurveTo=function(t,e,i,n){var r=h.I,a=i,s=n;i=this._curMat.a*a+this._curMat.c*s+this._curMat.tx,n=this._curMat.b*a+this._curMat.d*s+this._curMat.ty,a=t,s=e,t=this._curMat.a*a+this._curMat.c*s+this._curMat.tx,e=this._curMat.b*a+this._curMat.d*s+this._curMat.ty;for(var o=r.getBezierPoints([this._path.getEndPointX(),this._path.getEndPointY(),t,e,i,n],30,2),l=0,u=o.length/2;u>l;l++)this.lineTo(o[2*l],o[2*l+1],!1);this.lineTo(i,n,!1)},o.rect=function(t,e,i,n){this._other=this._other.make(),this._other.path||(this._other.path=new W),this._other.path.rect(t,e,i,n)},o.strokeRect=function(t,e,i,n,r){var a=.5*r;this.line(t-a,e,t+i+a,e,r,this._curMat),this.line(t+i,e,t+i,e+n,r,this._curMat),this.line(t,e,t,e+n,r,this._curMat),this.line(t-a,e+n,t+i+a,e+n,r,this._curMat)},o.clip=function(){},o.drawPoly=function(t,e,i,n,r,a,s){void 0===s&&(s=!1),this._renderKey=0,this._shader2D.glTexture=null;var o=this._getPath();if(-1==this.mId)o.polygon(t,e,i,n,r?r:1,a);else if(this.mHaveKey){var h=O.getInstance().shapeDic[this.mId];h.setMatrix(this._curMat),h.rebuild(o.tempArray),o.setGeomtry(h)}else{var l=o.polygon(t,e,i,n,r?r:1,a);O.getInstance().addShape(this.mId,l),l.setMatrix(this._curMat)}o.update();var u,c=[this.mX,this.mY];if(!s){var _=ot.create(4);this.addRenderObject(_),u=it.createShape(this,o.ib,o.vb,o.count,o.offset,vt.create(4,0)),u.shaderValue.ALPHA=this._shader2D.ALPHA,u.shaderValue.u_pos=c,u.shaderValue.u_mmat2=ft.EMPTYMAT4_ARRAY,this._submits[this._submits._length++]=u,_=ot.create(5),this.addRenderObject(_)}if(u=it.createShape(this,o.ib,o.vb,o.count,o.offset,vt.create(4,0)),u.shaderValue.ALPHA=this._shader2D.ALPHA,u.shaderValue.u_pos=c,u.shaderValue.u_mmat2=ft.EMPTYMAT4_ARRAY,this._submits[this._submits._length++]=u,s||(_=ot.create(3),this.addRenderObject(_)),r>0){if(this.mHaveLineKey){var d=O.getInstance().shapeLineDic[this.mId];d.rebuild(o.tempArray),o.setGeomtry(d)}else O.getInstance().addShape(this.mId,o.drawLine(t,e,i,r,a));o.update(),u=it.createShape(this,o.ib,o.vb,o.count,o.offset,vt.create(4,0)),u.shaderValue.ALPHA=this._shader2D.ALPHA,u.shaderValue.u_mmat2=ft.EMPTYMAT4_ARRAY,this._submits[this._submits._length++]=u}},o.drawParticle=function(t,e,i){i.x=t,i.y=e,this._submits[this._submits._length++]=i},o._getPath=function(){return this._path||(this._path=new W)},a(0,o,"globalCompositeOperation",function(){return H.NAMES[this._nBlendType]},function(t){var e=H.TOINT[t];null==e||this._nBlendType===e||(G.save(this,65536,this,!0),this._curSubmit=it.RENDERBASE,this._renderKey=0,this._nBlendType=e)}),a(0,o,"strokeStyle",function(){return this._shader2D.strokeStyle},function(t){this._shader2D.strokeStyle.equal(t)||(G.save(this,512,this._shader2D,!1),this._shader2D.strokeStyle=z.create(t))}),a(0,o,"globalAlpha",function(){return this._shader2D.ALPHA},function(t){t=Math.floor(1e3*t)/1e3,t!=this._shader2D.ALPHA&&(G.save(this,1,this._shader2D,!0),this._shader2D.ALPHA=t)}),a(0,o,"asBitmap",null,function(t){if(t){if(this._targets||(this._targets=new Z),this._targets.repaint=!0,!this._width||!this._height)throw Error("asBitmap no size!");this._targets.setSP(this.sprite),this._targets.size(this._width,this._height)}else this._targets=null}),a(0,o,"fillStyle",function(){return this._shader2D.fillStyle},function(t){this._shader2D.fillStyle.equal(t)||(G.save(this,2,this._shader2D,!1),this._shader2D.fillStyle=z.create(t))}),a(0,o,"textAlign",function(){return this._other.textAlign},function(t){this._other.textAlign===t||(this._other=this._other.make(),G.save(this,32768,this._other,!1),this._other.textAlign=t)}),a(0,o,"lineWidth",function(){return this._other.lineWidth},function(t){this._other.lineWidth===t||(this._other=this._other.make(),G.save(this,256,this._other,!1),this._other.lineWidth=t)}),a(0,o,"textBaseline",function(){return this._other.textBaseline},function(t){this._other.textBaseline===t||(this._other=this._other.make(),G.save(this,16384,this._other,!1),this._other.textBaseline=t)}),a(0,o,"font",null,function(t){t!=this._other.font.toString()&&(this._other=this._other.make(),G.save(this,8,this._other,!1),this._other.font===ct.EMPTY?this._other.font=new ct(t):this._other.font.setFont(t))}),e.__init__=function(){s.DEFAULT=new s},e._SUBMITVBSIZE=32e3,e._MAXSIZE=99999999,e._RECTVBSIZE=16,e.MAXCLIPRECT=new T(0,0,99999999,99999999),e._COUNT=0,e._tmpMatrix=new v,n(e,["_fontTemp",function(){return this._fontTemp=new ct},"_drawStyleTemp",function(){return this._drawStyleTemp=new z(null)}]),e.__init$=function(){s=function(){function t(){this.lineWidth=1,this.path=null,this.textAlign=null,this.textBaseline=null,this.font=ct.EMPTY}r(t,"");var e=t.prototype;return e.clear=function(){this.lineWidth=1,this.path&&this.path.clear(),this.textAlign=this.textBaseline=null,this.font=ct.EMPTY},e.make=function(){return this===t.DEFAULT?new t:this},t.DEFAULT=null,t}()},e}(f),vt=function(t){function e(t,i){this.size=[0,0],this.alpha=1,this.ALPHA=1,this.subID=0,this._cacheID=0,e.__super.call(this),this.defines=new wt,this.position=e._POSITION,this.mainID=t,this.subID=i,this.textureHost=null,this.texture=null,this.fillStyle=null,this.color=null,this.strokeStyle=null,this.colorAdd=null,this.glTexture=null,this.u_mmat2=null,this._cacheID=t|i,this._inClassCache=e._cache[this._cacheID],t>0&&!this._inClassCache&&(this._inClassCache=e._cache[this._cacheID]=[],this._inClassCache._length=0),this.clear()}r(e,"laya.webgl.shader.d2.value.Value2D",t);var i=e.prototype;return i.setValue=function(t){},i.refresh=function(){var t=this.size;return t[0]=ft.width,t[1]=ft.height,this.alpha=this.ALPHA*ft.worldAlpha,this.mmat=ft.worldMatrix4,this},i._ShaderWithCompile=function(){return Wt.withCompile2D(0,this.mainID,this.defines.toNameDic(),this.mainID|this.defines._value,Yt.create)},i._withWorldShaderDefines=function(){var t=ft.worldShaderDefines,e=Wt.sharders[this.mainID|this.defines._value|t.getValue()];if(!e){var i,n,r={};i=this.defines.toNameDic();for(n in i)r[n]="";i=t.toNameDic();for(n in i)r[n]="";e=Wt.withCompile2D(0,this.mainID,r,this.mainID|this.defines._value|t.getValue(),Yt.create)}var a=ft.worldFilters;if(!a)return e;for(var s,o=a.length,h=0;o>h;h++)(s=a[h])&&s.action.setValue(this);return e},i.upload=function(){var t=ft;this.alpha=this.ALPHA*t.worldAlpha,ft.worldMatrix4!==ft.TEMPMAT4_ARRAY&&this.defines.add(128),mt.frameShaderHighPrecision&&this.defines.add(1024);var e,i=t.worldShaderDefines?this._withWorldShaderDefines():Wt.sharders[this.mainID|this.defines._value]||this._ShaderWithCompile();this.size[0]=t.width,this.size[1]=t.height,this.mmat=t.worldMatrix4,Rt.activeShader!==i?(i._shaderValueWidth!==t.width||i._shaderValueHeight!==t.height?(i._shaderValueWidth=t.width,i._shaderValueHeight=t.height):e=i._params2dQuick2||i._make2dQuick2(),i.upload(this,e)):(i._shaderValueWidth!==t.width||i._shaderValueHeight!==t.height?(i._shaderValueWidth=t.width,i._shaderValueHeight=t.height):e=i._params2dQuick1||i._make2dQuick1(),i.upload(this,e))},i.setFilters=function(t){if(this.filters=t,t)for(var e,i=t.length,n=0;i>n;n++)e=t[n],e&&(this.defines.add(e.type),e.action.setValue(this))},i.clear=function(){this.defines.setValue(this.subID)},i.release=function(){this._inClassCache[this._inClassCache._length++]=this,this.fillStyle=null,this.strokeStyle=null,this.clear()},e._initone=function(t,i){e._typeClass[t]=i,e._cache[t]=[],e._cache[t]._length=0},e.__init__=function(){e._POSITION=[2,5126,!1,4*_t.BYTES_PE,0],e._TEXCOORD=[2,5126,!1,4*_t.BYTES_PE,2*_t.BYTES_PE],e._initone(2,Nt),e._initone(4,Ft),e._initone(256,Ot),e._initone(512,Lt),e._initone(1,Vt),e._initone(65,jt),e._initone(9,Vt)},e.create=function(t,i){var n=e._cache[t|i];return n._length?n[--n._length]:new e._typeClass[t|i](i)},e._POSITION=null,e._TEXCOORD=null,e._cache=[],e._typeClass=[],e.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],e}(F),St=function(t){function e(t,i){e.__super.call(this,t,i)}r(e,"laya.webgl.utils.RenderSprite3D",t);var i=e.prototype;return i.onCreate=function(t){switch(t){case 8:return void(this._fun=this._blend);case 4:return void(this._fun=this._transform)}},i._mask=function(t,i,n,r){var a,s,o=this._next,h=t.mask;if(h){i.ctx.save();var l=i.ctx.globalCompositeOperation,u=new T;if(u.copyFrom(h.getBounds()),u.width=Math.round(u.width),u.height=Math.round(u.height),u.x=Math.round(u.x),u.y=Math.round(u.y),u.width>0&&u.height>0){var c=t._style._tf,_=rt.create();_.addValue("bounds",u),a=nt.create([_,i],laya.webgl.utils.RenderSprite3D.tmpTarget),i.addRenderObject(a),h.render(i,-u.x-c.translateX,-u.y-c.translateY),a=nt.create([_],laya.webgl.utils.RenderSprite3D.endTmpTarget),i.addRenderObject(a),i.ctx.save(),i.clipRect(n-c.translateX+u.x,r-c.translateX+u.y,u.width,u.height),o._fun.call(o,t,i,n,r),i.ctx.restore(),s=ot.create(6),l=i.ctx.globalCompositeOperation,s.blendMode="mask",i.addRenderObject(s),v.TEMP.identity();var d=vt.create(1,0),f=L.INV_UV,p=u.width,m=u.height,g=32;(u.width<g||u.height<g)&&(f=e.tempUV,f[0]=0,f[1]=0,f[2]=u.width>=32?1:u.width/g,f[3]=0,f[4]=u.width>=32?1:u.width/g,f[5]=u.height>=32?1:u.height/g,f[6]=0,f[7]=u.height>=32?1:u.height/g,u.width=u.width>=32?u.width:g,u.height=u.height>=32?u.height:g,f[1]*=-1,f[3]*=-1,f[5]*=-1,f[7]*=-1,f[1]+=1,f[3]+=1,f[5]+=1,f[7]+=1),i.ctx.drawTarget(_,n+u.x,r+u.y,p,m,v.TEMP,"tmpTarget",d,f,6),a=nt.create([_],laya.webgl.utils.RenderSprite3D.recycleTarget),i.addRenderObject(a),s=ot.create(6),s.blendMode=l,i.addRenderObject(s)}i.ctx.restore()}else o._fun.call(o,t,i,n,r)},i._blend=function(t,e,i,n){var r=t._style,a=this._next;r.blendMode?(e.ctx.save(),e.ctx.globalCompositeOperation=r.blendMode,a._fun.call(a,t,e,i,n),e.ctx.restore()):a._fun.call(a,t,e,i,n)},i._transform=function(t,e,i,n){"use strict";var r=t.transform,a=this._next;if(r&&a!=w.NORENDER){var s=e.ctx;t._style;r.tx=i,r.ty=n;var o=s._getTransformMatrix(),h=o.clone();v.mul(r,o,o),o._checkTransform(),r.tx=r.ty=0,a._fun.call(a,t,e,0,0),h.copyTo(o),h.destroy()}else a._fun.call(a,t,e,i,n)},e.tmpTarget=function(t,e){var i=t.getValue("bounds"),n=It.create(i.width,i.height);n.start(),n.clear(0,0,0,0),t.addValue("tmpTarget",n)},e.endTmpTarget=function(t){var e=t.getValue("tmpTarget");e.end()},e.recycleTarget=function(t){var e=t.getValue("tmpTarget");e.recycle(),t.recycle()},n(e,["tempUV",function(){return this.tempUV=new Array(8)}]),e}(w),Tt=function(t){function e(){this.data=null,e.__super.call(this)}r(e,"laya.filters.webgl.ColorFilterActionGL",t);var n=e.prototype;return i.imps(n,{"laya.filters.IFilterActionGL":!0}),n.setValue=function(t){t.colorMat=this.data._mat,t.colorAlpha=this.data._alpha},n.apply3d=function(t,e,i,n,r){var a=t.getValue("bounds"),s=vt.create(1,0);s.setFilters([this.data]);var o=v.TEMP;o.identity(),i.ctx.drawTarget(t,0,0,a.width,a.height,o,"src",s)},e}(V),Et=function(t){function e(t,i,n,r,a){this._atlasCanvas=null,this._inAtlasTextureKey=null,this._inAtlasTextureBitmapValue=null,this._inAtlasTextureOriUVValue=null,this._InAtlasWebGLImagesKey=null,this._InAtlasWebGLImagesOffsetValue=null,e.__super.call(this,t,i,a),this._inAtlasTextureKey=[],this._inAtlasTextureBitmapValue=[],this._inAtlasTextureOriUVValue=[],this._InAtlasWebGLImagesKey={},this._InAtlasWebGLImagesOffsetValue=[],this._atlasCanvas=new Bt,this._atlasCanvas._atlaser=this,this._atlasCanvas.width=n,this._atlasCanvas.height=r,
this._atlasCanvas.activeResource(),this._atlasCanvas.lock=!0}r(e,"laya.webgl.atlas.Atlaser",t);var i=e.prototype;return i.computeUVinAtlasTexture=function(t,e,i,n){var r=U.atlasTextureWidth,a=U.atlasTextureHeight,s=i/r,o=n/a,h=(i+t.bitmap.width)/r,l=(n+t.bitmap.height)/a,u=t.bitmap.width/r,c=t.bitmap.height/a;t.uv=[s+e[0]*u,o+e[1]*c,h-(1-e[2])*u,o+e[3]*c,h-(1-e[4])*u,l-(1-e[5])*c,s+e[6]*u,l-(1-e[7])*c]},i.findBitmapIsExist=function(t){if(t instanceof laya.webgl.resource.WebGLImage){var e=t,i=e.url,n=this._InAtlasWebGLImagesKey[i?i:e.id];if(n)return n.offsetInfoID}return-1},i.addToAtlasTexture=function(t,e,i){if(t instanceof laya.webgl.resource.WebGLImage){var n=t,r=n.url;this._InAtlasWebGLImagesKey[r?r:n.id]={bitmap:t,offsetInfoID:this._InAtlasWebGLImagesOffsetValue.length},this._InAtlasWebGLImagesOffsetValue.push([e,i])}this._atlasCanvas.texSubImage2D(e,i,t.atlasSource),t.clearAtlasSource()},i.addToAtlas=function(t,e,i){t._atlasID=this._inAtlasTextureKey.length;var n=t.uv.slice(),r=t.bitmap;this._inAtlasTextureKey.push(t),this._inAtlasTextureOriUVValue.push(n),this._inAtlasTextureBitmapValue.push(r),this.computeUVinAtlasTexture(t,n,e,i),t.bitmap=this._atlasCanvas},i.clear=function(){for(var t=0,e=this._inAtlasTextureKey.length;e>t;t++)this._inAtlasTextureKey[t].bitmap=this._inAtlasTextureBitmapValue[t],this._inAtlasTextureKey[t].uv=this._inAtlasTextureOriUVValue[t],this._inAtlasTextureKey[t]._atlasID=-1,this._inAtlasTextureKey[t].bitmap.lock=!1,this._inAtlasTextureKey[t].bitmap.releaseResource();this._inAtlasTextureKey.length=0,this._inAtlasTextureBitmapValue.length=0,this._inAtlasTextureOriUVValue.length=0,this._InAtlasWebGLImagesKey=null,this._InAtlasWebGLImagesOffsetValue.length=0},i.dispose=function(){this.clear(),this._atlasCanvas.dispose()},a(0,i,"InAtlasWebGLImagesOffsetValue",function(){return this._InAtlasWebGLImagesOffsetValue}),a(0,i,"texture",function(){return this._atlasCanvas}),a(0,i,"inAtlasWebGLImagesKey",function(){return this._InAtlasWebGLImagesKey}),e}(B),wt=function(t){function e(){e.__super.call(this,e.__name2int,e.__int2name,e.__int2nameMap)}return r(e,"laya.webgl.shader.d2.ShaderDefines2D",t),e.__init__=function(){e.reg("TEXTURE2D",1),e.reg("COLOR2D",2),e.reg("PRIMITIVE",4),e.reg("GLOW_FILTER",8),e.reg("BLUR_FILTER",16),e.reg("COLOR_FILTER",32),e.reg("COLOR_ADD",64),e.reg("WORLDMAT",128),e.reg("FILLTEXTURE",256),e.reg("FSHIGHPRECISION",1024)},e.reg=function(t,i){Q._reg(t,i,e.__name2int,e.__int2name)},e.toText=function(t,e,i){return Q._toText(t,e,i)},e.toInt=function(t){return Q._toInt(t,e.__name2int)},e.TEXTURE2D=1,e.COLOR2D=2,e.PRIMITIVE=4,e.FILTERGLOW=8,e.FILTERBLUR=16,e.FILTERCOLOR=32,e.COLORADD=64,e.WORLDMAT=128,e.FILLTEXTURE=256,e.SKINMESH=512,e.SHADERDEFINE_FSHIGHPRECISION=1024,e.__name2int={},e.__int2name=[],e.__int2nameMap=[],e}(Q),bt=(function(t){function e(t,i,n,r,a,s,o){e.__super.call(this,t,i,n,r,40,a,s,o)}return r(e,"laya.webgl.shapes.Ellipse",t),e}(et),function(t){function e(t,i,n,r,a){this._points=[],this.rebuild(n),e.__super.call(this,t,i,0,0,0,a,r,a,0)}r(e,"laya.webgl.shapes.Line",t);var i=e.prototype;return i.rebuild=function(t){var e=t.length,i=this._points.length;e!=i&&(this.mUint16Array=new Uint16Array(6*(e/2-1)),this.mFloat32Array=new Float32Array(5*e)),this._points.length=0;for(var n=NaN,r=NaN,a=-1,s=-1,o=t.length/2,h=0;o>h;h++)n=t[2*h],r=t[2*h+1],(Math.abs(a-n)>.01||Math.abs(s-r)>.01)&&this._points.push(n,r),a=n,s=r},i.getData=function(t,e,i){var n=[],r=[];this.borderWidth>0&&this.createLine2(this._points,n,this.borderWidth,i,r,this._points.length/2),this.mUint16Array.set(n,0),this.mFloat32Array.set(r,0),t.append(this.mUint16Array),e.append(this.mFloat32Array)},e}(et)),Ct=function(t){function e(t,i,n,r,a){this._points=[];for(var s=NaN,o=NaN,h=-1,l=-1,u=n.length/2-1,c=0;u>c;c++)s=n[2*c],o=n[2*c+1],(Math.abs(h-s)>.01||Math.abs(l-o)>.01)&&this._points.push(s,o),h=s,l=o;s=n[2*u],o=n[2*u+1],h=this._points[0],l=this._points[1],(Math.abs(h-s)>.01||Math.abs(l-o)>.01)&&this._points.push(s,o),e.__super.call(this,t,i,0,0,this._points.length/2,0,r,a)}r(e,"laya.webgl.shapes.LoopLine",t);var i=e.prototype;return i.getData=function(t,e,i){if(this.borderWidth>0){for(var n=this.color,r=(n>>16&255)/255,a=(n>>8&255)/255,s=(255&n)/255,o=[],h=0,l=0,u=[],c=Math.floor(this._points.length/2),_=0;c>_;_++)h=this._points[2*_],l=this._points[2*_+1],o.push(this.x+h,this.y+l,r,a,s);this.createLoopLine(o,u,this.borderWidth,i+o.length/5),t.append(new Uint16Array(u)),e.append(new Float32Array(o))}},i.createLoopLine=function(t,e,i,n,r,a){var s=(t.length/5,t.concat()),o=r?r:t,h=this.borderColor,l=(h>>16&255)/255,u=(h>>8&255)/255,c=(255&h)/255,_=[s[0],s[1]],d=[s[s.length-5],s[s.length-4]],f=d[0]+.5*(_[0]-d[0]),p=d[1]+.5*(_[1]-d[1]);s.unshift(f,p,0,0,0),s.push(f,p,0,0,0);var m,g,y,x,v,S,T,E,w,b,C,M,D,A,R,I,P,L,N,O,V,F=s.length/5,B=n,U=i/2;y=s[0],x=s[1],v=s[5],S=s[6],w=-(x-S),b=y-v,V=Math.sqrt(w*w+b*b),w=w/V*U,b=b/V*U,o.push(y-w,x-b,l,u,c,y+w,x+b,l,u,c);for(var k=1;F-1>k;k++)y=s[5*(k-1)],x=s[5*(k-1)+1],v=s[5*k],S=s[5*k+1],T=s[5*(k+1)],E=s[5*(k+1)+1],w=-(x-S),b=y-v,V=Math.sqrt(w*w+b*b),w=w/V*U,b=b/V*U,C=-(S-E),M=v-T,V=Math.sqrt(C*C+M*M),C=C/V*U,M=M/V*U,D=-b+x-(-b+S),A=-w+v-(-w+y),R=(-w+y)*(-b+S)-(-w+v)*(-b+x),I=-M+E-(-M+S),P=-C+v-(-C+T),L=(-C+T)*(-M+S)-(-C+v)*(-M+E),N=D*P-I*A,Math.abs(N)<.1?(N+=10.1,o.push(v-w,S-b,l,u,c,v+w,S+b,l,u,c)):(m=(A*L-P*R)/N,g=(I*R-D*L)/N,O=(m-v)*(m-v)+(g-S)+(g-S),o.push(m,g,l,u,c,v-(m-v),S-(g-S),l,u,c));a&&(e=a);var H=this.edges+1;for(k=1;H>k;k++)e.push(B+2*(k-1),B+2*(k-1)+1,B+2*k+1,B+2*k+1,B+2*k,B+2*(k-1));return e.push(B+2*(k-1),B+2*(k-1)+1,B+1,B+1,B,B+2*(k-1)),o},e}(et),Mt=function(t){function e(t,i,n,r,a,s){this._points=null,this._start=-1,this._repaint=!1,this._mat=v.create(),this._points=n.slice(0,n.length),e.__super.call(this,t,i,0,0,this._points.length/2,r,a,s)}r(e,"laya.webgl.shapes.Polygon",t);var i=e.prototype;return i.rebuild=function(t){this._repaint||(this._points.length=0,this._points=this._points.concat(t))},i.setMatrix=function(t){t.copyTo(this._mat)},i.needUpdate=function(t){return this._repaint=this._mat.a==t.a&&this._mat.b==t.b&&this._mat.c==t.c&&this._mat.d==t.d&&this._mat.tx==t.tx&&this._mat.ty==t.ty,!this._repaint},i.getData=function(t,e,i){var n,r=0,a=this._points,s=0;if(this.mUint16Array&&this.mFloat32Array&&this._repaint){if(this._start!=i){for(this._start=i,n=[],s=Math.floor(a.length/2),r=2;s>r;r++)n.push(i,i+r-1,i+r);this.mUint16Array=new Uint16Array(n)}}else{this._start=i,n=[];var o=[],h=this.color,l=(h>>16&255)/255,u=(h>>8&255)/255,c=(255&h)/255;for(s=Math.floor(a.length/2),r=0;s>r;r++)o.push(this.x+a[2*r],this.y+a[2*r+1],l,u,c);for(r=2;s>r;r++)n.push(i,i+r-1,i+r);this.mUint16Array=new Uint16Array(n),this.mFloat32Array=new Float32Array(o)}t.append(this.mUint16Array),e.append(this.mFloat32Array)},e}(et),Dt=function(t){function e(){this._matrix=new v,this._matrix4=_t.defaultMatrix4.concat(),e.__super.call(this,1e4),this.shaderValue=new vt(0,0)}r(e,"laya.webgl.submit.SubmitCanvas",t);var i=e.prototype;return i.renderSubmit=function(){if(this._ctx_src._targets)return this._ctx_src._targets.flush(this._ctx_src),1;var t=ft.worldAlpha,e=ft.worldMatrix4,i=ft.worldMatrix,n=ft.worldFilters,r=ft.worldShaderDefines,a=this.shaderValue,s=this._matrix,o=this._matrix4,h=v.TEMP;return v.mul(s,i,h),o[0]=h.a,o[1]=h.b,o[4]=h.c,o[5]=h.d,o[12]=h.tx,o[13]=h.ty,ft.worldMatrix=h.clone(),ft.worldMatrix4=o,ft.worldAlpha=ft.worldAlpha*a.alpha,a.filters&&a.filters.length&&(ft.worldFilters=a.filters,ft.worldShaderDefines=a.defines),this._ctx_src.flush(),ft.worldAlpha=t,ft.worldMatrix4=e,ft.worldMatrix.destroy(),ft.worldMatrix=i,ft.worldFilters=n,ft.worldShaderDefines=r,1},i.releaseRender=function(){var t=e._cache;this._ctx_src=null,t[t._length++]=this},i.getRenderType=function(){return 10003},e.create=function(t,i,n){var r=e._cache._length?e._cache[--e._cache._length]:new e;r._ctx_src=t;var a=r.shaderValue;return a.alpha=i,a.defines.setValue(0),n&&n.length&&a.setFilters(n),r},e._cache=(e._cache=[],e._cache._length=0,e._cache),e}(it),At=function(t){function e(t){this._preIsSameTextureShader=!1,this._isSameTexture=!0,this._texs=new Array,this._texsID=new Array,this._vbPos=new Array,void 0===t&&(t=1e4),e.__super.call(this,t)}r(e,"laya.webgl.submit.SubmitTexture",t);var i=e.prototype;return i.releaseRender=function(){var t=e._cache;t[t._length++]=this,this.shaderValue.release(),this._preIsSameTextureShader=!1,this._vb=null,this._texs.length=0,this._vbPos.length=0,this._isSameTexture=!0},i.addTexture=function(t,e){this._texsID[this._texs.length]=t._uvID,this._texs.push(t),this._vbPos.push(e)},i.checkTexture=function(){if(this._texs.length<1)return void(this._isSameTexture=!0);var t=this.shaderValue.textureHost,e=t.bitmap;if(null!==e)for(var i=this._vb.getFloat32Array(),n=0,r=this._texs.length;r>n;n++){var a=this._texs[n];a.active();var s=a.uv;if(this._texsID[n]!==a._uvID){this._texsID[n]=a._uvID;var o=this._vbPos[n];i[o+2]=s[0],i[o+3]=s[1],i[o+6]=s[2],i[o+7]=s[3],i[o+10]=s[4],i[o+11]=s[5],i[o+14]=s[6],i[o+15]=s[7],this._vb.setNeedUpload()}a.bitmap!==e&&(this._isSameTexture=!1)}},i.renderSubmit=function(){if(0===this._numEle)return e._shaderSet=!1,1;var t=this.shaderValue.textureHost;if(t){var i=t.source;if(!t.bitmap||!i)return e._shaderSet=!1,1;this.shaderValue.texture=i}this._vb.bind_upload(this._ib);var n=mt.mainContext;if(H.activeBlendFunction!==this._blendFn&&(n.enable(3042),this._blendFn(n),H.activeBlendFunction=this._blendFn),A.drawCall++,A.trianglesFaces+=this._numEle/3,this._preIsSameTextureShader&&Rt.activeShader&&e._shaderSet?Rt.activeShader.uploadTexture2D(this.shaderValue.texture):this.shaderValue.upload(),e._shaderSet=!0,this._texs.length>1&&!this._isSameTexture)for(var r=t.bitmap,a=0,s=Rt.activeShader,o=0,h=this._texs.length;h>o;o++){var l=this._texs[o];(l.bitmap!==r||o+1===h)&&(s.uploadTexture2D(l.source),n.drawElements(4,6*(o-a+1),5123,this._startIdx+6*a*_t.BYTES_PIDX),r=l.bitmap,a=o)}else n.drawElements(4,this._numEle,5123,this._startIdx);return 1},e.create=function(t,i,n,r,a){var s=e._cache._length?e._cache[--e._cache._length]:new e;null==n&&(n=s._selfVb||(s._selfVb=qt.create(-1)),n.clear(),r=0),s._ib=i,s._vb=n,s._startIdx=r*_t.BYTES_PIDX,s._numEle=0;var o=t._nBlendType;s._blendFn=t._targets?H.targetFns[o]:H.fns[o],s.shaderValue=a,s.shaderValue.setValue(t._shader2D);var h=t._shader2D.filters;return h&&s.shaderValue.setFilters(h),s},e._cache=(e._cache=[],e._cache._length=0,e._cache),e._shaderSet=!0,e}(it),Rt=function(t){function e(){e.__super.call(this)}return r(e,"laya.webgl.shader.BaseShader",t),e.activeShader=null,e.bindShader=null,e}(b),It=function(t){function e(t,i,n,r,a,s,o,h,l){this._type=0,this._svWidth=NaN,this._svHeight=NaN,this._preRenderTarget=null,this._alreadyResolved=!1,this._looked=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._mipMap=!1,this._repeat=!1,this._minFifter=0,this._magFifter=0,this._destroy=!1,void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===h&&(h=-1),void 0===l&&(l=-1),this._type=1,this._w=t,this._h=i,this._surfaceFormat=n,this._surfaceType=r,this._depthStencilFormat=a,this._mipMap=s,this._repeat=o,this._minFifter=h,this._magFifter=l,this._createWebGLRenderTarget(),this.bitmap.lock=!0,e.__super.call(this,this.bitmap,L.INV_UV)}r(e,"laya.webgl.resource.RenderTarget2D",t);var n=e.prototype;return i.imps(n,{"laya.resource.IDispose":!0}),n.getType=function(){return this._type},n.getTexture=function(){return this},n.size=function(t,e){(this._w!=t||this._h!=e)&&(this._w=t,this._h=e,this.release(),0!=this._w&&0!=this._h&&this._createWebGLRenderTarget())},n.release=function(){this.destroy()},n.recycle=function(){e.POOL.push(this)},n.start=function(){var t=mt.mainContext;return this._preRenderTarget=ft.curRenderTarget,ft.curRenderTarget=this,t.bindFramebuffer(36160,this.bitmap.frameBuffer),this._alreadyResolved=!1,1==this._type&&(t.viewport(0,0,this._w,this._h),this._svWidth=ft.width,this._svHeight=ft.height,ft.width=this._w,ft.height=this._h,Rt.activeShader=null),this},n.clear=function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1);var r=mt.mainContext;r.clearColor(t,e,i,n);var a=16384;switch(this._depthStencilFormat){case 33189:a|=256;break;case 36168:a|=1024;break;case 34041:a|=256,a|=1024}r.clear(a)},n.end=function(){var t=mt.mainContext;t.bindFramebuffer(36160,this._preRenderTarget?this._preRenderTarget.bitmap.frameBuffer:null),this._alreadyResolved=!0,ft.curRenderTarget=this._preRenderTarget,1==this._type?(t.viewport(0,0,this._svWidth,this._svHeight),ft.width=this._svWidth,ft.height=this._svHeight,Rt.activeShader=null):t.viewport(0,0,i.stage.width,i.stage.height)},n.getData=function(t,e,i,n){var r=mt.mainContext;r.bindFramebuffer(36160,this.bitmap.frameBuffer);var a=36053===r.checkFramebufferStatus(36160);if(!a)return r.bindFramebuffer(36160,null),null;var s=new Uint8Array(this._w*this._h*4);return r.readPixels(t,e,i,n,this._surfaceFormat,this._surfaceType,s),r.bindFramebuffer(36160,null),s},n.destroy=function(e){void 0===e&&(e=!1),this._destroy||(this._loaded=!1,this.bitmap.offAll(),this.bitmap.detoryResource(),this.bitmap.dispose(),this.offAll(),this.bitmap=null,this._alreadyResolved=!1,this._destroy=!0,t.prototype.destroy.call(this))},n.dispose=function(){},n._createWebGLRenderTarget=function(){this.bitmap=new Ht(this.width,this.height,this._surfaceFormat,this._surfaceType,this._depthStencilFormat,this._mipMap,this._repeat,this._minFifter,this._magFifter),this.bitmap.activeResource(),this._alreadyResolved=!0,this._destroy=!1,this._loaded=!0,this.bitmap.on("recovered",this,function(t){this.event("recovered")})},a(0,n,"surfaceFormat",function(){return this._surfaceFormat}),a(0,n,"magFifter",function(){return this._magFifter}),a(0,n,"surfaceType",function(){return this._surfaceType}),a(0,n,"mipMap",function(){return this._mipMap}),a(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,n,"minFifter",function(){return this._minFifter}),a(0,n,"source",function(){return this._alreadyResolved?t.prototype._$get_source.call(this):null}),e.create=function(t,i,n,r,a,s,o,h,l){void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===h&&(h=-1),void 0===l&&(l=-1);var u=e.POOL.pop();return u||(u=new e(t,i)),u.bitmap&&u._w==t&&u._h==i&&u._surfaceFormat==n&&u._surfaceType==r&&u._depthStencilFormat==a&&u._mipMap==s&&u._repeat==o&&u._minFifter==h&&u._magFifter==l||(u._w=t,u._h=i,u._surfaceFormat=n,u._surfaceType=r,u._depthStencilFormat=a,u._mipMap=s,u._repeat=o,u._minFifter=h,u._magFifter=l,u.release(),u._createWebGLRenderTarget()),u},e.TYPE2D=1,e.TYPE3D=2,e.POOL=[],e}(L),Pt=function(t){function e(){this._glBuffer=null,this._buffer=null,this._bufferType=0,this._bufferUsage=0,this._byteLength=0,e.__super.call(this),e._gl=mt.mainContext}r(e,"laya.webgl.utils.Buffer",t);var i=e.prototype;return i._bind=function(){this.activeResource(),e._bindActive[this._bufferType]===this._glBuffer||(e._gl.bindBuffer(this._bufferType,e._bindActive[this._bufferType]=this._glBuffer),Rt.activeShader=null)},i.recreateResource=function(){this._glBuffer||(this._glBuffer=e._gl.createBuffer()),this.completeCreate()},i.detoryResource=function(){this._glBuffer&&(mt.mainContext.deleteBuffer(this._glBuffer),this._glBuffer=null),this.memorySize=0},a(0,i,"byteLength",function(){return this._byteLength}),a(0,i,"bufferType",function(){return this._bufferType}),a(0,i,"bufferUsage",function(){return this._bufferUsage}),e._gl=null,e._bindActive={},e}(b),Lt=function(t){function e(t){this.texcoord=null,this.offsetX=300,this.offsetY=0,e.__super.call(this,512,0);var i=8*_t.BYTES_PE;this.position=[2,5126,!1,i,0],this.texcoord=[2,5126,!1,i,2*_t.BYTES_PE],this.color=[4,5126,!1,i,4*_t.BYTES_PE]}return r(e,"laya.webgl.shader.d2.skinAnishader.SkinSV",t),e}(vt),Nt=function(t){function e(t){e.__super.call(this,2,0),this.color=[]}r(e,"laya.webgl.shader.d2.value.Color2dSV",t);var i=e.prototype;return i.setValue=function(t){t.fillStyle&&(this.color=t.fillStyle._color._color),t.strokeStyle&&(this.color=t.strokeStyle._color._color)},e}(vt),Ot=function(t){function e(t){this.u_colorMatrix=null,this.strength=0,this.colorMat=null,this.colorAlpha=null,this.u_TexRange=[0,1,0,1],this.u_offset=[0,0],this.texcoord=vt._TEXCOORD,e.__super.call(this,256,0)}r(e,"laya.webgl.shader.d2.value.FillTextureSV",t);var i=e.prototype;return i.setValue=function(t){this.ALPHA=t.ALPHA,t.filters&&this.setFilters(t.filters)},i.clear=function(){this.texture=null,this.shader=null,this.defines.setValue(0)},e}(vt),Vt=function(t){function e(t){this.u_colorMatrix=null,this.strength=0,this.blurInfo=null,this.colorMat=null,this.colorAlpha=null,this.texcoord=vt._TEXCOORD,void 0===t&&(t=0),e.__super.call(this,1,t)}r(e,"laya.webgl.shader.d2.value.TextureSV",t);var i=e.prototype;return i.setValue=function(t){this.ALPHA=t.ALPHA,t.filters&&this.setFilters(t.filters)},i.clear=function(){this.texture=null,this.shader=null,this.defines.setValue(0)},e}(vt),Ft=function(t){function e(t){this.a_color=null,this.u_pos=[0,0],e.__super.call(this,4,0),this.position=[2,5126,!1,5*_t.BYTES_PE,0],this.a_color=[3,5126,!1,5*_t.BYTES_PE,2*_t.BYTES_PE]}return r(e,"laya.webgl.shader.d2.value.PrimitiveSV",t),e}(vt),Bt=function(t){function e(){this._atlaser=null,this._flashCacheImage=null,this._flashCacheImageNeedFlush=!1,e.__super.call(this)}r(e,"laya.webgl.atlas.AtlasWebGLCanvas",t);var i=e.prototype;return i.recreateResource=function(){var t=mt.mainContext,e=this._source=t.createTexture(),i=gt.curBindTexTarget,n=gt.curBindTexValue;gt.bindTexture(t,3553,e),t.texImage2D(3553,0,6408,this._w,this._h,0,6408,5121,null),t.texParameteri(3553,10241,9729),t.texParameteri(3553,10240,9729),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),i&&n&&gt.bindTexture(t,i,n),this.memorySize=this._w*this._h*4,this.completeCreate()},i.detoryResource=function(){this._source&&(mt.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},i.texSubImage2D=function(t,e,i){if(E.isFlash){this._flashCacheImage||(this._flashCacheImage=y.create(""),this._flashCacheImage._image.createCanvas(this._w,this._h));var n=i.bitmapdata;this._flashCacheImage._image.copyPixels(n,0,0,n.width,n.height,t,e),this._flashCacheImageNeedFlush||(this._flashCacheImageNeedFlush=!0)}else{var r=mt.mainContext,a=gt.curBindTexTarget,s=gt.curBindTexValue;gt.bindTexture(r,3553,this._source),r.pixelStorei(37441,!0),t-1>=0&&r.texSubImage2D(3553,0,t-1,e,6408,5121,i),t+1<=this._w&&r.texSubImage2D(3553,0,t+1,e,6408,5121,i),e-1>=0&&r.texSubImage2D(3553,0,t,e-1,6408,5121,i),e+1<=this._h&&r.texSubImage2D(3553,0,t,e+1,6408,5121,i),r.texSubImage2D(3553,0,t,e,6408,5121,i),r.pixelStorei(37441,!1),a&&s&&gt.bindTexture(r,a,s)}},i.texSubImage2DPixel=function(t,e,i,n,r){var a=mt.mainContext,s=gt.curBindTexTarget,o=gt.curBindTexValue;gt.bindTexture(a,3553,this._source);var h=new Uint8Array(r.data);a.pixelStorei(37441,!0),a.texSubImage2D(3553,0,t,e,i,n,6408,5121,h),a.pixelStorei(37441,!1),s&&o&&gt.bindTexture(a,s,o)},a(0,i,"width",t.prototype._$get_width,function(t){this._w=t}),a(0,i,"height",t.prototype._$get_height,function(t){this._h=t}),e}(l),Ut=function(t){function e(){e.__super.call(this)}r(e,"laya.webgl.resource.WebGLCanvas",t);var i=e.prototype;return i.getCanvas=function(){return this._canvas},i.clear=function(){this._ctx&&this._ctx.clear()},i.destroy=function(){this._ctx&&this._ctx.destroy(),this._ctx=null},i._setContext=function(t){this._ctx=t},i.getContext=function(t,i){return this._ctx?this._ctx:this._ctx=e._createContext(this)},i.size=function(t,e){(this._w!=t||this._h!=e)&&(this._w=t,this._h=e,this._ctx&&this._ctx.size(t,e),this._canvas&&(this._canvas.height=e,this._canvas.width=t))},i.recreateResource=function(){this.createWebGlTexture(),this.completeCreate()},i.detoryResource=function(){this._source&&!this.iscpuSource&&(mt.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},i.createWebGlTexture=function(){var t=mt.mainContext;if(!this._canvas)throw"create GLTextur err:no data:"+this._canvas;var e=this._source=t.createTexture();this.iscpuSource=!1;var i=gt.curBindTexTarget,n=gt.curBindTexValue;gt.bindTexture(t,3553,e),t.pixelStorei(37441,!0),t.texImage2D(3553,0,6408,6408,5121,this._canvas),t.pixelStorei(37441,!1),t.texParameteri(3553,10240,9729),t.texParameteri(3553,10241,9729),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),this.memorySize=this._w*this._h*4,i&&n&&gt.bindTexture(t,i,n)},i.texSubImage2D=function(t,e,i){var n=mt.mainContext,r=gt.curBindTexTarget,a=gt.curBindTexValue;gt.bindTexture(n,3553,this._source),n.pixelStorei(37441,!0),n.texSubImage2D(3553,0,e,i,6408,5121,t._source),n.pixelStorei(37441,!1),r&&a&&gt.bindTexture(n,r,a)},a(0,i,"context",function(){return this._ctx}),a(0,i,"asBitmap",null,function(t){this._ctx&&(this._ctx.asBitmap=t)}),e._createContext=null,e}(l),kt=function(t){function e(t,i){this.CborderSize=12,e.__super.call(this),this["char"]=t,this.isSpace=" "===t,this.xs=i.scaleX,this.ys=i.scaleY,this.font=i.font.toString(),this.fontSize=i.font.size,this.fillColor=i.fillColor,this.borderColor=i.borderColor,this.lineWidth=i.lineWidth;var n,r=E.isConchApp;r?(n=ConchTextCanvas,n._source=ConchTextCanvas,n._source.canvas=ConchTextCanvas):n=u.canvas.source,this.canvas=n,this._enableMerageInAtlas=!0,r?this._ctx=n:this._ctx=this.canvas.getContext("2d",void 0);var a=N.measureText(this["char"],this.font);this.cw=a.width*this.xs,this.ch=(a.height||this.fontSize)*this.ys,this.onresize(this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this.texture=new L(this)}r(e,"laya.webgl.resource.WebGLCharImage",t);var n=e.prototype;return i.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n.active=function(){this.texture.active()},n.recreateResource=function(){var t=E.isConchApp;if(this.onresize(this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this.canvas&&(this.canvas.height=this._h,this.canvas.width=this._w),t){var e=this.fontSize;(1!=this.xs||1!=this.ys)&&(e=parseInt(e*(this.xs>this.ys?this.xs:this.ys)+""));var i="normal 100 "+e+"px Arial";this.borderColor&&(i+=" 1 "+this.borderColor),this._ctx.font=i,this._ctx.textBaseline="top",this._ctx.fillStyle=this.fillColor,this._ctx.fillText(this["char"],this.CborderSize,this.CborderSize,null,null,null)}else this._ctx.save(),this._ctx.clearRect(0,0,this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this._ctx.font=this.font,this._ctx.textBaseline="top",this._ctx.translate(this.CborderSize,this.CborderSize),(1!=this.xs||1!=this.ys)&&this._ctx.scale(this.xs,this.ys),this.fillColor&&this.borderColor?(this._ctx.strokeStyle=this.borderColor,this._ctx.lineWidth=this.lineWidth,this._ctx.strokeText(this["char"],0,0,null,null,0,null),this._ctx.fillStyle=this.fillColor,this._ctx.fillText(this["char"],0,0,null,null,null)):-1===this.lineWidth?(this._ctx.fillStyle=this.fillColor?this.fillColor:"white",this._ctx.fillText(this["char"],0,0,null,null,null)):(this._ctx.strokeStyle=this.borderColor?this.borderColor:"white",this._ctx.lineWidth=this.lineWidth,this._ctx.strokeText(this["char"],0,0,null,null,0,null)),this._ctx.restore();this.borderSize=this.CborderSize,this.completeCreate()},n.onresize=function(t,e){if(this._w=t,this._h=e,!(this._w<U.atlasLimitWidth&&this._h<U.atlasLimitHeight))throw this._allowMerageInAtlas=!1,new Error("文字尺寸超出大图合集限制！");this._allowMerageInAtlas=!0},n.clearAtlasSource=function(){},a(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),a(0,n,"atlasSource",function(){return this.canvas}),a(0,n,"enableMerageInAtlas",function(){return this._enableMerageInAtlas},function(t){this._enableMerageInAtlas=t}),e.createOneChar=function(t,i){var n=new e(t,i);return n},e}(l),Ht=function(t){function e(t,i,n,r,a,s,o,h,l){void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===h&&(h=-1),void 0===l&&(l=1),e.__super.call(this),this._w=t,this._h=i,this._surfaceFormat=n,this._surfaceType=r,this._depthStencilFormat=a,this._mipMap=s,this._repeat=o,this._minFifter=h,this._magFifter=l}r(e,"laya.webgl.resource.WebGLRenderTarget",t);var i=e.prototype;return i.recreateResource=function(){var t=mt.mainContext;this._frameBuffer||(this._frameBuffer=t.createFramebuffer()),this._source||(this._source=t.createTexture());var e=gt.curBindTexTarget,i=gt.curBindTexValue;gt.bindTexture(t,3553,this._source),t.texImage2D(3553,0,6408,this._w,this._h,0,this._surfaceFormat,this._surfaceType,null);var n=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071,s=o.isPOT(this._w,this._h);if(s?(this._mipMap?-1!==n||(n=9987):-1!==n||(n=9729),-1!==r||(r=9729),t.texParameteri(3553,10241,n),t.texParameteri(3553,10240,r),t.texParameteri(3553,10242,a),t.texParameteri(3553,10243,a),this._mipMap&&t.generateMipmap(3553)):(-1!==n||(n=9729),-1!==r||(r=9729),t.texParameteri(3553,10241,n),t.texParameteri(3553,10240,r),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),t.bindFramebuffer(36160,this._frameBuffer),t.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer||(this._depthStencilBuffer=t.createRenderbuffer()),t.bindRenderbuffer(36161,this._depthStencilBuffer),t.renderbufferStorage(36161,this._depthStencilFormat,this._w,this._h),this._depthStencilFormat){case 33189:t.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:t.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:t.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}t.bindFramebuffer(36160,null),e&&i&&gt.bindTexture(t,e,i),t.bindRenderbuffer(36161,null),this.memorySize=this._w*this._h*4,this.completeCreate()},i.detoryResource=function(){this._frameBuffer&&(mt.mainContext.deleteTexture(this._source),mt.mainContext.deleteFramebuffer(this._frameBuffer),mt.mainContext.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0)},a(0,i,"depthStencilBuffer",function(){return this._depthStencilBuffer}),a(0,i,"frameBuffer",function(){return this._frameBuffer}),e}(l),zt=function(t){function e(t,i,n,r,a,s,o){this.offsetX=0,this.offsetY=0,e.__super.call(this),this.repeat=!0,this.mipmap=!1,this.minFifter=-1,this.magFifter=-1,this.atlasImage=s,this.canvas=t,this._ctx=t.getContext("2d",void 0),this._w=r,this._h=a,this.offsetX=i,this.offsetY=n,this.src=o,this._enableMerageInAtlas=!0,U.enabled&&this._w<U.atlasLimitWidth&&this._h<U.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1}r(e,"laya.webgl.resource.WebGLSubImage",t);var n=e.prototype;return i.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n.size=function(t,e){this._w=t,this._h=e,this._ctx&&this._ctx.size(t,e),this.canvas&&(this.canvas.height=e,this.canvas.width=t)},n.recreateResource=function(){this.size(this._w,this._h),this._ctx.drawImage(this.atlasImage,this.offsetX,this.offsetY,this._w,this._h,0,0,this._w,this._h),this._allowMerageInAtlas&&this._enableMerageInAtlas?this.memorySize=0:this.createWebGlTexture(),this.completeCreate()},n.createWebGlTexture=function(){var t=mt.mainContext;if(!this.canvas)throw"create GLTextur err:no data:"+this.canvas;var e=this._source=t.createTexture(),i=gt.curBindTexTarget,n=gt.curBindTexValue;gt.bindTexture(t,3553,e),t.pixelStorei(37441,!0),t.texImage2D(3553,0,6408,6408,5121,this.canvas),t.pixelStorei(37441,!1);var r=this.minFifter,a=this.magFifter,s=this.repeat?10497:33071,h=o.isPOT(this.width,this.height);h?(this.mipmap?-1!==r||(r=9987):-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10240,a),t.texParameteri(3553,10241,r),t.texParameteri(3553,10242,s),t.texParameteri(3553,10243,s),this.mipmap&&t.generateMipmap(3553)):(-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),i&&n&&gt.bindTexture(t,i,n),this.canvas=null,this.memorySize=this._w*this._h*4},n.detoryResource=function(){U.enabled&&this._allowMerageInAtlas||!this._source||(mt.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n.clearAtlasSource=function(){},a(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),a(0,n,"atlasSource",function(){return this.canvas}),a(0,n,"enableMerageInAtlas",function(){return this._allowMerageInAtlas},function(t){this._allowMerageInAtlas=t}),e}(l),Wt=function(t){function e(t,i,n,r){if(this.customCompile=!1,this._curActTexIndex=0,this.tag={},this._program=null,this._params=null,this._paramsMap={},this._offset=0,e.__super.call(this),!t||!i)throw"Shader Error";(E.isConchApp||E.isFlash)&&(this.customCompile=!0),this._id=++e._count,this._vs=t,this._ps=i,this._nameMap=r?r:{},null!=n&&(e.sharders[n]=this)}r(e,"laya.webgl.shader.Shader",t);var i=e.prototype;return i.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},i.detoryResource=function(){mt.mainContext.deleteShader(this._vshader),mt.mainContext.deleteShader(this._pshader),mt.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._params=null,this._paramsMap={},this.memorySize=0,this._curActTexIndex=0},i._compile=function(){if(this._vs&&this._ps&&!this._params){this._reCompile=!0,this._params=[];var t,i=[this._vs,this._ps];this.customCompile&&(t=this._preGetParams(this._vs,this._ps));var n=mt.mainContext;if(this._program=n.createProgram(),this._vshader=e._createShader(n,i[0],35633),this._pshader=e._createShader(n,i[1],35632),n.attachShader(this._program,this._vshader),n.attachShader(this._program,this._pshader),n.linkProgram(this._program),!this.customCompile&&!n.getProgramParameter(this._program,35714))throw n.getProgramInfoLog(this._program);var r,a,s=0,o=0,h=this.customCompile?t.attributes.length:n.getProgramParameter(this._program,35721);for(s=0;h>s;s++){var l=this.customCompile?t.attributes[s]:n.getActiveAttrib(this._program,s);a=n.getAttribLocation(this._program,l.name),r={vartype:"attribute",ivartype:0,attrib:l,location:a,name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._params.push(r)}var u=this.customCompile?t.uniforms.length:n.getProgramParameter(this._program,35718);for(s=0;u>s;s++){var c=this.customCompile?t.uniforms[s]:n.getActiveUniform(this._program,s);a=n.getUniformLocation(this._program,c.name),r={vartype:"uniform",ivartype:1,attrib:l,location:a,name:c.name,type:c.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},r.name.indexOf("[0]")>0&&(r.name=r.name.substr(0,r.name.length-3),r.isArray=!0,r.location=n.getUniformLocation(this._program,r.name)),this._params.push(r)}for(s=0,o=this._params.length;o>s;s++)if(r=this._params[s],r.indexOfParams=s,r.index=1,r.value=[r.location,null],r.codename=r.name,r.name=this._nameMap[r.codename]?this._nameMap[r.codename]:r.codename,this._paramsMap[r.name]=r,r._this=this,r.uploadedValue=[],"attribute"!==r.vartype)switch(r.type){case 5124:r.fun=r.isArray?this._uniform1iv:this._uniform1i;break;case 5126:r.fun=r.isArray?this._uniform1fv:this._uniform1f;break;case 35664:r.fun=r.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:r.fun=r.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:r.fun=r.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:r.fun=this._uniform_sampler2D;break;case 35680:r.fun=this._uniform_samplerCube;break;case 35676:r.fun=this._uniformMatrix4fv;break;case 35670:r.fun=this._uniform1i;break;case 35674:case 35675:throw new Error("compile shader err!");default:throw new Error("compile shader err!")}else r.fun=this._attribute}},i.getUniform=function(t){return this._paramsMap[t]},i._attribute=function(t,e){var i=mt.mainContext;return i.enableVertexAttribArray(t.location),i.vertexAttribPointer(t.location,e[0],e[1],e[2],e[3],e[4]+this._offset),2},i._uniform1f=function(t,e){var i=t.uploadedValue;return i[0]!==e?(mt.mainContext.uniform1f(t.location,i[0]=e),
1):0},i._uniform1fv=function(t,e){if(e.length<4){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(mt.mainContext.uniform1fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return mt.mainContext.uniform1fv(t.location,e),1},i._uniform_vec2=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(mt.mainContext.uniform2f(t.location,i[0]=e[0],i[1]=e[1]),1):0},i._uniform_vec2v=function(t,e){if(e.length<2){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(mt.mainContext.uniform2fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return mt.mainContext.uniform2fv(t.location,e),1},i._uniform_vec3=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(mt.mainContext.uniform3f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0},i._uniform_vec3v=function(t,e){return mt.mainContext.uniform3fv(t.location,e),1},i._uniform_vec4=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(mt.mainContext.uniform4f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0},i._uniform_vec4v=function(t,e){return mt.mainContext.uniform4fv(t.location,e),1},i._uniformMatrix2fv=function(t,e){return mt.mainContext.uniformMatrix2fv(t.location,!1,e),1},i._uniformMatrix3fv=function(t,e){return mt.mainContext.uniformMatrix3fv(t.location,!1,e),1},i._uniformMatrix4fv=function(t,e){return mt.mainContext.uniformMatrix4fv(t.location,!1,e),1},i._uniform1i=function(t,e){var i=t.uploadedValue;return i[0]!==e?(mt.mainContext.uniform1i(t.location,i[0]=e),1):0},i._uniform1iv=function(t,e){return mt.mainContext.uniform1iv(t.location,e),1},i._uniform_ivec2=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(mt.mainContext.uniform2i(t.location,i[0]=e[0],i[1]=e[1]),1):0},i._uniform_ivec2v=function(t,e){return mt.mainContext.uniform2iv(t.location,e),1},i._uniform_vec3i=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(mt.mainContext.uniform3i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0},i._uniform_vec3vi=function(t,e){return mt.mainContext.uniform3iv(t.location,e),1},i._uniform_vec4i=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(mt.mainContext.uniform4i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0},i._uniform_vec4vi=function(t,e){return mt.mainContext.uniform4iv(t.location,e),1},i._uniform_sampler2D=function(t,i){var n=mt.mainContext,r=t.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,n.uniform1i(t.location,this._curActTexIndex),n.activeTexture(e._TEXTURES[this._curActTexIndex]),gt.bindTexture(n,3553,i),this._curActTexIndex++,1):(n.activeTexture(e._TEXTURES[r[0]]),gt.bindTexture(n,3553,i),0)},i._uniform_samplerCube=function(t,i){var n=mt.mainContext,r=t.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,n.uniform1i(t.location,this._curActTexIndex),n.activeTexture(e._TEXTURES[this._curActTexIndex]),gt.bindTexture(n,34067,i),this._curActTexIndex++,1):(n.activeTexture(e._TEXTURES[r[0]]),gt.bindTexture(n,34067,i),0)},i._noSetValue=function(t){console.log("no....:"+t.name)},i.uploadOne=function(t,e){this.activeResource(),gt.UseProgram(this._program);var i=this._paramsMap[t];i.fun.call(this,i,e)},i.uploadTexture2D=function(t){A.shaderCall++;var e=mt.mainContext;e.activeTexture(33984),gt.bindTexture(e,3553,t)},i.upload=function(t,e){Rt.activeShader=this,Rt.bindShader=this,this.activeResource(),gt.UseProgram(this._program),this._reCompile?(e=this._params,this._reCompile=!1):e=e||this._params;for(var i,n,r=e.length,a=0,s=0;r>s;s++)i=e[s],null!==(n=t[i.name])&&(a+=i.fun.call(this,i,n));A.shaderCall+=a},i.uploadArray=function(t,e,i){Rt.activeShader=this,Rt.bindShader=this,this.activeResource(),gt.UseProgram(this._program);for(var n,r,a=(this._params,0),s=e-2;s>=0;s-=2)r=this._paramsMap[t[s]],r&&(n=t[s+1],null!=n&&(i&&i[r.name]&&i[r.name].bind(),a+=r.fun.call(this,r,n)));A.shaderCall+=a},i.getParams=function(){return this._params},i._preGetParams=function(t,e){var i=[t,e],n={},r=[],a=[],s={},o=[];n.attributes=r,n.uniforms=a,n.defines=s;for(var h=new RegExp("(/\\*([^*]|[\\r\\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/)|(//.*)","g"),l=new RegExp("(\".*\")|('.*')|([#\\w\\*-\\.+/()=<>{}\\\\]+)|([,;:\\\\])","g"),u=0,c=0,_=0;2>_;_++){i[_]=i[_].replace(h,"");var d,f=i[_].match(l);for(u=0,c=f.length;c>u;u++){var p=f[u];if("attribute"==p||"uniform"==p)u=this.parseOne(r,a,f,u,p,!0);else{if("#define"==p){p=f[++u],o[p]=1;continue}if("#ifdef"==p){d=f[++u];s[d]=s[d]||[];for(u++;c>u;u++)if(p=f[u],"attribute"==p||"uniform"==p)u=this.parseOne(r,a,f,u,p,o[d]);else if("#else"==p)for(u++;c>u;u++)if(p=f[u],"attribute"==p||"uniform"==p)u=this.parseOne(r,a,f,u,p,!o[d]);else if("#endif"==p)break}}}}return n},i.parseOne=function(t,i,n,r,a,s){var o={type:e.shaderParamsMap[n[r+1]],name:n[r+2],size:isNaN(parseInt(n[r+3]))?1:parseInt(n[r+3])};return s&&("attribute"==a?t.push(o):i.push(o)),":"==n[r+3]&&(o.type=n[r+4],r+=2),r+=2},e.getShader=function(t){return e.sharders[t]},e.create=function(t,i,n,r){return new e(t,i,n,r)},e.withCompile=function(t,i,n,r){if(n&&e.sharders[n])return e.sharders[n];var a=e._preCompileShader[2e-4*t];if(!a)throw new Error("withCompile shader err!"+t);return a.createShader(i,n,r)},e.withCompile2D=function(t,i,n,r,a){if(r&&e.sharders[r])return e.sharders[r];var s=e._preCompileShader[2e-4*t+i];if(!s)throw new Error("withCompile shader err!"+t+" "+i);return s.createShader(n,r,a)},e.addInclude=function(t,i){if(!i||0===i.length)throw new Error("add shader include file err:"+t);if(e._includeFiles[t])throw new Error("add shader include file err, has add:"+t);e._includeFiles[t]=i},e.preCompile=function(t,i,n,r){var a=2e-4*t;e._preCompileShader[a]=new pt(a,i,n,r,e._includeFiles)},e.preCompile2D=function(t,i,n,r,a){var s=2e-4*t+i;e._preCompileShader[s]=new pt(s,n,r,a,e._includeFiles)},e._createShader=function(t,e,i){var n=t.createShader(i);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,35713))throw t.getShaderInfoLog(n);return n},e._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,,33991,33992],e._includeFiles={},e._count=0,e._preCompileShader={},e.SHADERNAME2ID=2e-4,e.sharders=(e.sharders=[],e.sharders.length=32,e.sharders),n(e,["shaderParamsMap",function(){return this.shaderParamsMap={"float":5126,"int":5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new R}]),e}(Rt),Gt=function(t){function e(){this._maxsize=0,this._upload=!0,this._uploadSize=0,e.__super.call(this),this.lock=!0}r(e,"laya.webgl.utils.Buffer2D",t);var i=e.prototype;return i._bufferData=function(){this._maxsize=Math.max(this._maxsize,this._byteLength),A.loopCount%30==0&&(this._buffer.byteLength>this._maxsize+64&&(this.memorySize=this._buffer.byteLength,this._buffer=this._buffer.slice(0,this._maxsize+64),this._checkArrayUse()),this._maxsize=this._byteLength),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,Pt._gl.bufferData(this._bufferType,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),Pt._gl.bufferSubData(this._bufferType,0,this._buffer)},i._bufferSubData=function(t,e,i){if(void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this._maxsize=Math.max(this._maxsize,this._byteLength),A.loopCount%30==0&&(this._buffer.byteLength>this._maxsize+64&&(this.memorySize=this._buffer.byteLength,this._buffer=this._buffer.slice(0,this._maxsize+64),this._checkArrayUse()),this._maxsize=this._byteLength),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,Pt._gl.bufferData(this._bufferType,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),e||i){var n=this._buffer.slice(e,i);Pt._gl.bufferSubData(this._bufferType,t,n)}else Pt._gl.bufferSubData(this._bufferType,t,this._buffer)},i._checkArrayUse=function(){},i._bind_upload=function(){return this._upload?(this._upload=!1,this._bind(),this._bufferData(),!0):!1},i._bind_subUpload=function(t,e,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this._upload?(this._upload=!1,this._bind(),this._bufferSubData(t,e,i),!0):!1},i._resizeBuffer=function(t,e){if(t<this._buffer.byteLength)return this;if(this.memorySize=t,e&&this._buffer&&this._buffer.byteLength>0){var i=new ArrayBuffer(t),n=new Uint8Array(i);n.set(new Uint8Array(this._buffer),0),this._buffer=i}else this._buffer=new ArrayBuffer(t);return this._checkArrayUse(),this._upload=!0,this},i.append=function(t){this._upload=!0;var e,i=0;i=t.byteLength,t instanceof Uint8Array?(this._resizeBuffer(this._byteLength+i,!0),e=new Uint8Array(this._buffer,this._byteLength)):t instanceof Uint16Array?(this._resizeBuffer(this._byteLength+i,!0),e=new Uint16Array(this._buffer,this._byteLength)):t instanceof Float32Array&&(this._resizeBuffer(this._byteLength+i,!0),e=new Float32Array(this._buffer,this._byteLength)),e.set(t,0),this._byteLength+=i,this._checkArrayUse()},i.appendEx=function(t,e){this._upload=!0;var i,n=0;n=t.byteLength,this._resizeBuffer(this._byteLength+n,!0),i=new e(this._buffer,this._byteLength),i.set(t,0),this._byteLength+=n,this._checkArrayUse()},i.appendEx2=function(t,e,i,n){void 0===n&&(n=1),this._upload=!0;var r,a=0;a=i*n,this._resizeBuffer(this._byteLength+a,!0),r=new e(this._buffer,this._byteLength);var s=0;for(s=0;i>s;s++)r[s]=t[s];this._byteLength+=a,this._checkArrayUse()},i.getBuffer=function(){return this._buffer},i.setNeedUpload=function(){this._upload=!0},i.getNeedUpload=function(){return this._upload},i.upload=function(){var t=this._bind_upload();return Pt._gl.bindBuffer(this._bufferType,null),Pt._bindActive[this._bufferType]=null,Rt.activeShader=null,t},i.subUpload=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var n=this._bind_subUpload();return Pt._gl.bindBuffer(this._bufferType,null),Pt._bindActive[this._bufferType]=null,Rt.activeShader=null,n},i.detoryResource=function(){t.prototype.detoryResource.call(this),this._upload=!0,this._uploadSize=0},i.clear=function(){this._byteLength=0,this._upload=!0},a(0,i,"bufferLength",function(){return this._buffer.byteLength}),a(0,i,"byteLength",t.prototype._$get_byteLength,function(t){this._byteLength!==t&&(t<=this._buffer.byteLength||this._resizeBuffer(2*t+256,!0),this._byteLength=t)}),e.__int__=function(t){Xt.QuadrangleIB=Xt.create(35044),dt.fillIBQuadrangle(Xt.QuadrangleIB,16)},e.FLOAT32=4,e.SHORT=2,e}(Pt),jt=(function(t){function e(t){this.u_blurX=!1,this.u_color=null,this.u_offset=null,this.u_strength=NaN,this.u_texW=0,this.u_texH=0,e.__super.call(this,9)}r(e,"laya.webgl.shader.d2.value.GlowSV",t);var i=e.prototype;return i.setValue=function(e){t.prototype.setValue.call(this,e)},i.clear=function(){t.prototype.clear.call(this)},e}(Vt),function(t){function e(t){e.__super.call(this,64),this.defines.add(64)}r(e,"laya.webgl.shader.d2.value.TextSV",t);var i=e.prototype;return i.release=function(){e.pool[e._length++]=this,this.clear()},i.clear=function(){t.prototype.clear.call(this)},e.create=function(){return e._length?e.pool[--e._length]:new e(null)},e.pool=[],e._length=0,e}(Vt)),Yt=function(t){function e(t,i,n,r){this._params2dQuick1=null,this._params2dQuick2=null,this._shaderValueWidth=NaN,this._shaderValueHeight=NaN,e.__super.call(this,t,i,n,r)}r(e,"laya.webgl.shader.d2.Shader2X",t);var i=e.prototype;return i.upload2dQuick1=function(t){this.upload(t,this._params2dQuick1||this._make2dQuick1())},i._make2dQuick1=function(){if(!this._params2dQuick1){this.activeResource(),this._params2dQuick1=[];for(var t,e=this._params,i=0,n=e.length;n>i;i++)t=e[i],(E.isFlash||"size"!==t.name&&"position"!==t.name&&"texcoord"!==t.name)&&this._params2dQuick1.push(t)}return this._params2dQuick1},i.detoryResource=function(){t.prototype.detoryResource.call(this),this._params2dQuick1=null,this._params2dQuick2=null},i.upload2dQuick2=function(t){this.upload(t,this._params2dQuick2||this._make2dQuick2())},i._make2dQuick2=function(){if(!this._params2dQuick2){this.activeResource(),this._params2dQuick2=[];for(var t,e=this._params,i=0,n=e.length;n>i;i++)t=e[i],(E.isFlash||"size"!==t.name)&&this._params2dQuick2.push(t)}return this._params2dQuick2},e.create=function(t,i,n,r){return new e(t,i,n,r)},e}(Wt),Xt=function(t){function e(t){this._uint8Array=null,this._uint16Array=null,void 0===t&&(t=35044),e.__super.call(this),this._bufferUsage=t,this._bufferType=34963,E.isFlash||(this._buffer=new ArrayBuffer(8))}r(e,"laya.webgl.utils.IndexBuffer2D",t);var i=e.prototype;return i._checkArrayUse=function(){this._uint8Array&&(this._uint8Array=new Uint8Array(this._buffer)),this._uint16Array&&(this._uint16Array=new Uint16Array(this._buffer))},i.getUint8Array=function(){return this._uint8Array||(this._uint8Array=new Uint8Array(this._buffer))},i.getUint16Array=function(){return this._uint16Array||(this._uint16Array=new Uint16Array(this._buffer))},i.destory=function(){this._uint16Array=null,this._uint8Array=null,this._buffer=null},e.QuadrangleIB=null,e.create=function(t){return void 0===t&&(t=35044),new e(t)},e}(Gt),qt=function(t){function e(t,i){this._floatArray32=null,this._vertexStride=0,e.__super.call(this),this._vertexStride=t,this._bufferUsage=i,this._bufferType=34962,E.isFlash||(this._buffer=new ArrayBuffer(8)),this.getFloat32Array()}r(e,"laya.webgl.utils.VertexBuffer2D",t);var i=e.prototype;return i.getFloat32Array=function(){return this._floatArray32||(this._floatArray32=new Float32Array(this._buffer))},i.bind=function(t){t&&t._bind(),this._bind()},i.insertData=function(t,e){var i=this.getFloat32Array();i.set(t,e),this._upload=!0},i.bind_upload=function(t){t._bind_upload()||t._bind(),this._bind_upload()||this._bind()},i._checkArrayUse=function(){this._floatArray32&&(this._floatArray32=new Float32Array(this._buffer))},i.detoryResource=function(){t.prototype.detoryResource.call(this);for(var e=0;10>e;e++)mt.mainContext.disableVertexAttribArray(e)},i.destory=function(){this._byteLength=0,this._upload=!0,this._buffer=null,this._floatArray32=null},a(0,i,"vertexStride",function(){return this._vertexStride}),e.create=function(t,i){return void 0===i&&(i=35048),new e(t,i)},e}(Gt),Kt=function(t){function e(t,i,n,r){if(this._format=0,this._mipmap=!1,this._allowMerageInAtlas=!1,this._enableMerageInAtlas=!1,this.repeat=!1,this._image=null,this.minFifter=0,this.magFifter=0,void 0===n&&(n=6408),void 0===r&&(r=!0),e.__super.call(this,t,i),this._format=n,this._mipmap=r,this.repeat=!1,this.minFifter=-1,this.magFifter=-1,"string"==typeof t)this.url=t,this._src=t,this._image=new u.window.Image,i&&(i.onload&&(this.onload=i.onload),i.onerror&&(this.onerror=i.onerror),i.onCreate&&i.onCreate(this)),this._image.crossOrigin=t&&0==t.indexOf("data:")?null:"",t&&(this._image.src=t);else if(t instanceof ArrayBuffer){this._src=i,this.url=this._src;var a=new c(t);a.readUTFBytes(4),a.readUTFBytes(2),a.getInt16();a.endian="bigEndian",this._w=a.getInt16(),this._h=a.getInt16();a.getInt16(),a.getInt16();this._image=new Uint8Array(t,a.pos),this._format=mt.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL,U.enabled&&this._w<U.atlasLimitWidth&&this._h<U.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1}else this._src=i,this.url=this._src,this._image=t.source||t,this.onresize();this._enableMerageInAtlas=!0}r(e,"laya.webgl.resource.WebGLImage",t);var n=e.prototype;return i.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n._init_=function(t,e){},n._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var t=mt.mainContext,e=this._source=t.createTexture(),i=gt.curBindTexTarget,n=gt.curBindTexValue;switch(gt.bindTexture(t,3553,e),t.pixelStorei(37441,!0),this._format){case 6408:t.texImage2D(3553,0,this._format,6408,5121,this._image);break;case mt.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:t.compressedTexImage2D(3553,0,this._format,this._w,this._h,0,this._image)}t.pixelStorei(37441,!1);var r=this.minFifter,a=this.magFifter,s=this.repeat?10497:33071,h=o.isPOT(this._w,this._h);h?(this.mipmap?-1!==r||(r=9987):-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,s),t.texParameteri(3553,10243,s),this.mipmap&&t.generateMipmap(3553)):(-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),i&&n&&gt.bindTexture(t,i,n),this._image.onload=null,this._image=null,h?this.memorySize=this._w*this._h*4*(1+1/3):this.memorySize=this._w*this._h*4,this._recreateLock=!1},n.recreateResource=function(){var t=this;if(null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._image){if(this._recreateLock)return;this._allowMerageInAtlas&&this._enableMerageInAtlas?(this.memorySize=0,this._recreateLock=!1):this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0;var e=this;this._image=new u.window.Image,this._image.crossOrigin=0==this._src.indexOf("data:")?null:"",this._image.onload=function(){return e._needReleaseAgain?(e._needReleaseAgain=!1,e._image.onload=null,void(e._image=null)):(e._allowMerageInAtlas&&e._enableMerageInAtlas?(t.memorySize=0,t._recreateLock=!1):e._createWebGlTexture(),void e.completeCreate())},this._image.src=this._src}},n.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(mt.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},n.onresize=function(){this._w=this._image.width,this._h=this._image.height,U.enabled&&this._w<U.atlasLimitWidth&&this._h<U.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1},n.clearAtlasSource=function(){this._image=null},a(0,n,"format",function(){return this._format}),a(0,n,"enableMerageInAtlas",function(){return this._enableMerageInAtlas},function(t){this._enableMerageInAtlas=t}),a(0,n,"mipmap",function(){return this._mipmap}),a(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),a(0,n,"atlasSource",function(){return this._image}),a(0,n,"onload",null,function(t){var e=this;this._onload=t,this._image&&(this._image.onload=null!=this._onload?function(){e.onresize(),e._onload()}:null)}),a(0,n,"onerror",null,function(t){var e=this;this._onerror=t,this._image&&(this._image.onerror=null!=this._onerror?function(){e._onerror()}:null)}),e}(y);i.__init([ut,B,xt,pt])}(window,document,Laya)}).call(window)},function(module,exports,__webpack_require__){(function(){!function(window,document,Laya){var __un=Laya.un,__uns=Laya.uns,__static=Laya["static"],__class=Laya["class"],__getset=Laya.getset,__newvec=Laya.__newvec,Browser=laya.utils.Browser,CSSStyle=laya.display.css.CSSStyle,ClassUtils=laya.utils.ClassUtils,Event=laya.events.Event,HTMLChar=laya.utils.HTMLChar,Loader=laya.net.Loader,Node=laya.display.Node,Rectangle=laya.maths.Rectangle,Render=laya.renders.Render,RenderContext=laya.renders.RenderContext,RenderSprite=laya.renders.RenderSprite,Sprite=laya.display.Sprite,Stat=laya.utils.Stat,Texture=laya.resource.Texture,URL=laya.net.URL,Utils=laya.utils.Utils,HTMLParse=function(){function t(){}return __class(t,"laya.html.utils.HTMLParse"),t.parse=function(e,i,n){i=i.replace(/<br>/g,"<br/>"),i="<root>"+i+"</root>",i=i.replace(t.spacePattern,t.char255);var r=Utils.parseXMLFromString(i);t._parseXML(e,r.childNodes[0].childNodes,n)},t._parseXML=function(e,i,n,r){var a=0,s=0;if(i.join||i.item)for(a=0,s=i.length;s>a;++a)t._parseXML(e,i[a],n,r);else{var o,h;if(3==i.nodeType){var l;return void(e instanceof laya.html.dom.HTMLDivElement?(null==i.nodeName&&(i.nodeName="#text"),h=i.nodeName.toLowerCase(),l=i.textContent.replace(/^\s+|\s+$/g,""),l.length>0&&(o=ClassUtils.getInstance(h),o&&(e.addChild(o),o.innerTEXT=l.replace(t.char255AndOneSpacePattern," ")))):(l=i.textContent.replace(/^\s+|\s+$/g,""),l.length>0&&(e.innerTEXT=l.replace(t.char255AndOneSpacePattern," "))))}if(h=i.nodeName.toLowerCase(),"#comment"==h)return;if(o=ClassUtils.getInstance(h)){o=e.addChild(o),o.URI=n,o.href=r;var u=i.attributes;if(u&&u.length>0)for(a=0,s=u.length;s>a;++a){var c=u[a],_=c.nodeName,d=c.value;o._setAttributes(_,d)}t._parseXML(o,i.childNodes,n,o.href)}else t._parseXML(e,i.childNodes,n,r)}},t.char255=String.fromCharCode(255),t.spacePattern=/&nbsp;|&#160;/g,t.char255AndOneSpacePattern=new RegExp(String.fromCharCode(255)+"|(\\s+)","g"),t}(),Layout=function(){function t(){}return __class(t,"laya.html.utils.Layout"),t.later=function(e){null==t._will&&(t._will=[],Laya.stage.frameLoop(1,null,function(){if(!(t._will.length<1)){for(var e=0;e<t._will.length;e++)laya.html.utils.Layout.layout(t._will[e]);t._will.length=0}})),t._will.push(e)},t.layout=function(e){if(!e||!e._style)return null;if(0===(512&e._style._type))return null;e.getStyle()._type&=-513;var i=t._multiLineLayout(e);return Render.isConchApp&&e.layaoutCallNative&&e.layaoutCallNative(),i},t._multiLineLayout=function(e){function i(){M.y=E,E+=M.h+d,M.mWidth=R,R=0,M=new LayoutLine,C.push(M),M.h=0,T=0,I=!0,D=!1}var n=new Array;e._addChildsToLayout(n);var r,a,s,o,h,l=0,u=n.length,c=e._getCSSStyle(),_=c.letterSpacing,d=c.leading,f=c.lineHeight,p=c._widthAuto()||!c.wordWrap,m=p?999999:e.width,g=(e.height,0),y=c.italic?c.fontSize/3:0,x=c._getAlign(),v=c._getValign(),S=0!==v||0!==x||0!=f,T=0,E=0,w=0,b=0,C=new Array,M=C[0]=new LayoutLine,D=!1,A=!1;M.h=0,c.italic&&(m-=c.fontSize/3);var R=0,I=!0;for(l=0;u>l;l++)if(r=n[l],null!=r)if(I=!1,r instanceof laya.html.dom.HTMLBrElement)i(),M.y=E,M.h=f;else{if(r._isChar()){if(o=r,o.isWord)D=A||"\n"===o["char"],M.wordStartIndex=M.elements.length;else{if(C.length>0&&T+w>m&&M.wordStartIndex>0){var P=0;P=M.elements.length-M.wordStartIndex+1,M.elements.length=M.wordStartIndex,l-=P,i();continue}D=!1,R+=o.width}w=o.width+_,b=o.height,A=!1,D=D||T+w>m,D&&i(),M.minTextHeight=Math.min(M.minTextHeight,r.height)}else a=r._getCSSStyle(),h=r,s=a.padding,0===a._getCssFloat()||(S=!0),D=A||a.lineElement,w=h.width*h._style._tf.scaleX+s[1]+s[3]+_,b=h.height*h._style._tf.scaleY+s[0]+s[2],A=a.lineElement,D=D||T+w>m&&a.wordWrap,D&&i();M.elements.push(r),M.h=Math.max(M.h,b),r.x=T,r.y=E,T+=w,M.w=T-_,M.y=E,g=Math.max(T+y,g)}else I||(T+=t.DIV_ELEMENT_PADDING),M.wordStartIndex=M.elements.length;if(E=M.y+M.h,S){var L=0,N=m;for(p&&e.width>0&&(N=e.width),l=0,u=C.length;u>l;l++)C[l].updatePos(0,N,l,L,x,v,f),L+=Math.max(f,C[l].h+d);E=L}return p&&(e.width=g),E>e.height&&(e.height=E),[g,E]},t._will=null,t.DIV_ELEMENT_PADDING=0,t}(),LayoutLine=function(){function t(){this.x=0,this.y=0,this.w=0,this.h=0,this.wordStartIndex=0,this.minTextHeight=99999,this.mWidth=0,this.elements=new Array}__class(t,"laya.html.utils.LayoutLine");var e=t.prototype;return e.updatePos=function(t,e,i,n,r,a,s){var o,h=0;this.elements.length>0&&(o=this.elements[this.elements.length-1],h=o.x+o.width-this.elements[0].x);var l=0,u=NaN;1===r&&(l=(e-h)/2),2===r&&(l=e-h),0===s||0!=a||(a=1);for(var c=0,_=this.elements.length;_>c;c++){o=this.elements[c];var d=o._getCSSStyle();switch(0!==l&&(o.x+=l),d._getValign()){case 0:o.y=n;break;case 1:var f=0;99999!=this.minTextHeight&&(f=this.minTextHeight);var p=(f+s)/2;p=Math.max(p,this.h),u=o instanceof laya.html.dom.HTMLImageElement?n+p-o.height:n+p-o.height,o.y=u;break;case 2:o.y=n+(s-o.height)}}},t}(),HTMLElement=function(_super){function HTMLElement(){this.URI=null,this._href=null,HTMLElement.__super.call(this),this._text=HTMLElement._EMPTYTEXT,this.setStyle(new CSSStyle(this)),this._getCSSStyle().valign="middle",this.mouseEnabled=!0}__class(HTMLElement,"laya.html.dom.HTMLElement",_super);var __proto=HTMLElement.prototype;return __proto.layaoutCallNative=function(){var t=0;if(this._childs&&(t=this._childs.length)>0)for(var e=0;t>e;e++)this._childs[e].layaoutCallNative&&this._childs[e].layaoutCallNative();var i=this._getWords();i&&HTMLElement.fillWords(this,i,0,0,this.style.font,this.style.color)},__proto.appendChild=function(t){return this.addChild(t)},__proto._getWords=function(){var t=this._text.text;if(!t||0===t.length)return null;var e=this._text.words;if(e&&e.length===t.length)return e;null===e&&(this._text.words=e=[]),e.length=t.length;for(var i,n=this.style,r=n.font,a=0,s=t.length;s>a;a++){i=Utils.measureText(t.charAt(a),r);var o=e[a]=new HTMLChar(t.charAt(a),i.width,i.height||n.fontSize,n);if(this.href){var h=new Sprite;this.addChild(h),o.setSprite(h)}}return e},__proto.showLinkSprite=function(){var t=this._text.words;if(t)for(var e,i,n=[],r=0;r<t.length;r++)i=t[r],e=new Sprite,e.graphics.drawRect(0,0,i.width,i.height,"#ff0000"),e.width=i.width,e.height=i.height,this.addChild(e),n.push(e)},__proto._layoutLater=function(){var t=this.style;512&t._type||(t.widthed(this)&&(this._childs.length>0||null!=this._getWords())&&t.block?(Layout.later(this),t._type|=512):this.parent&&this.parent._layoutLater())},__proto._setAttributes=function(t,e){switch(t){case"style":return void this.style.cssText(e);case"class":return void(this.className=e)}_super.prototype._setAttributes.call(this,t,e)},__proto.updateHref=function(){if(null!=this._href){var t=this._getWords();if(t)for(var e,i,n=0;n<t.length;n++)if(e=t[n],i=e.getSprite()){var r=e.height-1,a=.5*e.style.letterSpacing;a||(a=0),i.graphics.drawLine(0-a,r,e.width+a,r,e._getCSSStyle().color),i.size(e.width,e.height),i.on("click",this,this.onLinkHandler)}}},__proto.onLinkHandler=function(t){switch(t.type){case"click":for(var e=this;e;)e.event("link",[this.href]),e=e.parent}},__proto.formatURL=function(t){return this.URI?URL.formatURL(t,this.URI?this.URI.path:null):t},__getset(0,__proto,"href",function(){return this._href},function(t){this._href=t,null!=t&&this.updateHref()}),__getset(0,__proto,"color",null,function(t){this.style.color=t}),__getset(0,__proto,"onClick",null,function(value){var fn;eval("fn=function(event){"+value+";}"),this.on("click",this,fn)}),__getset(0,__proto,"id",null,function(t){HTMLDocument.document.setElementById(t,this)}),__getset(0,__proto,"innerTEXT",function(){return this._text.text},function(t){this.text=t}),__getset(0,__proto,"style",function(){return this._style}),__getset(0,__proto,"text",function(){return this._text.text},function(t){this._text==HTMLElement._EMPTYTEXT?this._text={text:t,words:null}:(this._text.text=t,this._text.words&&(this._text.words.length=0)),this._renderType|=2048,this.repaint(),this.updateHref()}),__getset(0,__proto,"parent",_super.prototype._$get_parent,function(t){if(t instanceof laya.html.dom.HTMLElement){var e=t;this.URI||(this.URI=e.URI),this.style.inherit(e.style)}_super.prototype._$set_parent.call(this,t)}),__getset(0,__proto,"className",null,function(t){this.style.attrs(HTMLDocument.document.styleSheets["."+t])}),HTMLElement.fillWords=function(t,e,i,n,r,a){t.graphics.clear();for(var s=0,o=e.length;o>s;s++){var h=e[s];t.graphics.fillText(h["char"],h.x+i,h.y+n,r,a,"left")}},HTMLElement._EMPTYTEXT={text:null,words:null},HTMLElement}(Sprite),HTMLBrElement=function(t){function e(){e.__super.call(this),this.style.lineElement=!0,this.style.block=!0}return __class(e,"laya.html.dom.HTMLBrElement",t),e}(HTMLElement),HTMLDivElement=function(t){function e(){this.contextHeight=NaN,this.contextWidth=NaN,e.__super.call(this),this.style.block=!0,this.style.lineElement=!0,this.style.width=200,this.style.height=200}__class(e,"laya.html.dom.HTMLDivElement",t);var i=e.prototype;return i.appendHTML=function(t){HTMLParse.parse(this,t,this.URI),this.layout()},i._addChildsToLayout=function(t){var e=this._getWords();if(null==e&&0==this._childs.length)return!1;e&&e.forEach(function(e){t.push(e)});for(var i=!0,n=0,r=this._childs.length;r>n;n++){var a=this._childs[n];i?i=!1:t.push(null),a._addToLayout(t)}return!0},i._addToLayout=function(t){this.layout()},i.layout=function(){this.style._type|=512;var t=Layout.layout(this);if(t){this._$P.mHtmlBounds||this._set$P("mHtmlBounds",new Rectangle);var e=this._$P.mHtmlBounds;e.x=e.y=0,e.width=this.contextWidth=t[0],e.height=this.contextHeight=t[1],this.setBounds(e)}},__getset(0,i,"height",function(){return this._height?this._height:this.contextHeight},t.prototype._$set_height),__getset(0,i,"innerHTML",null,function(t){this.destroyChildren(),this.appendHTML(t)}),__getset(0,i,"width",function(){return this._width?this._width:this.contextWidth},function(e){var i=!1;i=0===e?e!=this._width:e!=this.width,t.prototype._$set_width.call(this,e),i&&this.layout()}),e}(HTMLElement),HTMLDocument=function(t){function e(){this.all=new Array,this.styleSheets=CSSStyle.styleSheets,e.__super.call(this)}__class(e,"laya.html.dom.HTMLDocument",t);var i=e.prototype;return i.getElementById=function(t){return this.all[t]},i.setElementById=function(t,e){this.all[t]=e},__static(e,["document",function(){return this.document=new e}]),e}(HTMLElement),HTMLImageElement=function(t){function e(){this._tex=null,this._url=null,this._renderArgs=[],e.__super.call(this),this.style.block=!0}__class(e,"laya.html.dom.HTMLImageElement",t);var i=e.prototype;return i._addToLayout=function(t){!this._style.absolute&&t.push(this)},i.render=function(t,e,i){!this._tex||!this._tex.loaded||!this._tex.loaded||this._width<1||this._height<1||(Stat.spriteCount++,this._renderArgs[0]=this._tex,this._renderArgs[1]=this.x,this._renderArgs[2]=this.y,this._renderArgs[3]=this.width||this._tex.width,this._renderArgs[4]=this.height||this._tex.height,t.ctx.drawTexture2(e,i,this.style.translateX,this.style.translateY,this.transform,this.style.alpha,this.style.blendMode,this._renderArgs))},__getset(0,i,"src",null,function(t){function e(){var t=i._style;t.widthed(i)?-1:i._tex.width,t.heighted(i)?-1:i._tex.height;t.widthed(i)||i._width==i._tex.width||(i.width=i._tex.width,i.parent&&i.parent._layoutLater()),t.heighted(i)||i._height==i._tex.height||(i.height=i._tex.height,i.parent&&i.parent._layoutLater()),Render.isConchApp&&(i._renderArgs[0]=i._tex,i._renderArgs[1]=i.x,i._renderArgs[2]=i.y,i._renderArgs[3]=i.width||i._tex.width,i._renderArgs[4]=i.height||i._tex.height,i.graphics.drawTexture(i._tex,0,0,i._renderArgs[3],i._renderArgs[4])),i.repaint(),i.parentRepaint()}var i=this;if(t=this.formatURL(t),this._url!=t){this._url=t;var n=this._tex=Loader.getRes(t);n||(this._tex=n=new Texture,n.load(t),Loader.cacheRes(t,n)),n.loaded?e():n.on("loaded",null,e)}}),e}(HTMLElement),HTMLLinkElement=function(t){function e(){this.type=null,e.__super.call(this),this.visible=!1}__class(e,"laya.html.dom.HTMLLinkElement",t);var i=e.prototype;return i._onload=function(t){switch(this.type){case"text/css":CSSStyle.parseCSS(t,this.URI)}},__getset(0,i,"href",t.prototype._$get_href,function(t){var e=this;t=this.formatURL(t),this.URI=new URL(t);var i=new Loader;i.once("complete",null,function(t){e._onload(t)}),i.load(t,"text")}),e._cuttingStyle=new RegExp("((@keyframes[\\s\\t]+|)(.+))[\\t\\n\\r\\s]*{","g"),e}(HTMLElement),HTMLStyleElement=function(t){function e(){e.__super.call(this),this.visible=!1}__class(e,"laya.html.dom.HTMLStyleElement",t);var i=e.prototype;return __getset(0,i,"text",t.prototype._$get_text,function(t){CSSStyle.parseCSS(t,null)}),e}(HTMLElement),HTMLIframeElement=function(t){function e(){e.__super.call(this),this._getCSSStyle().valign="middle"}__class(e,"laya.html.dom.HTMLIframeElement",t);var i=e.prototype;return __getset(0,i,"href",t.prototype._$get_href,function(t){var e=this;t=this.formatURL(t);var i=new Loader;i.once("complete",null,function(i){var n=e.URI;e.URI=new URL(t),e.innerHTML=i,!n||(e.URI=n)}),i.load(t,"text")}),e}(HTMLDivElement)}(window,document,Laya)}).call(window)},function(t,e,i){(function(){!function(t,e,i){var n=(i.un,i.uns,i["static"]),r=i["class"],a=i.getset,s=i.__newvec,o=laya.maths.Bezier,h=laya.utils.Browser,l=laya.utils.Byte,u=(laya.events.Event,laya.events.EventDispatcher),c=laya.display.Graphics,_=laya.resource.HTMLCanvas,d=laya.utils.Handler,f=laya.net.Loader,p=laya.maths.MathUtil,m=laya.maths.Matrix,g=(laya.display.Node,laya.maths.Point,laya.maths.Rectangle),y=laya.renders.Render,x=(laya.renders.RenderContext,laya.resource.Resource),v=laya.utils.RunDriver,S=laya.display.Sprite,T=laya.utils.Stat,E=laya.resource.Texture,w=laya.net.URL,b=laya.utils.Utils,C=function(){
function t(){this.nodes=null,this.name=null,this.playTime=NaN,this.bone3DMap=null,this.totalKeyframeDatasLength=0}return r(t,"laya.ani.AnimationContent"),t}(),M=function(){function t(){this.name=null,this.parentIndex=0,this.parent=null,this.keyframeWidth=0,this.lerpType=0,this.interpolationMethod=null,this.childs=null,this.keyFrame=null,this.playTime=NaN,this.extenData=null,this.dataOffset=0}return r(t,"laya.ani.AnimationNodeContent"),t}(),D=function(){function t(){}return r(t,"laya.ani.AnimationParser01"),t.parse=function(t,e){var i=e.__getBuffer(),n=0,r=0,a=0,s=0,o=0,h=0,u=0,c=e.readUTFString();t._aniClassName=c;var _,d=e.readUTFString().split("\n"),f=e.getUint8(),p=e.getUint32(),m=e.getUint32();p>0&&(_=i.slice(p,m));var g=new l(_);for(m>0&&(t._publicExtData=i.slice(m,i.byteLength)),t._useParent=!!e.getUint8(),t._anis.length=f,n=0;f>n;n++){var y=t._anis[n]=new C;y.nodes=new Array;var x=y.name=d[e.getUint16()];t._aniMap[x]=n,y.bone3DMap={},y.playTime=e.getFloat32();var v=y.nodes.length=e.getUint8();for(y.totalKeyframeDatasLength=0,r=0;v>r;r++){var S=y.nodes[r]=new M;S.childs=[];var T=e.getInt16();T>=0&&(S.name=d[T],y.bone3DMap[S.name]=r),S.keyFrame=new Array,S.parentIndex=e.getInt16(),-1==S.parentIndex?S.parent=null:S.parent=y.nodes[S.parentIndex],S.lerpType=e.getUint8();var E=e.getUint32();g.pos=E;var w=S.keyframeWidth=g.getUint16();if(y.totalKeyframeDatasLength+=w,0===S.lerpType||1===S.lerpType)for(S.interpolationMethod=[],S.interpolationMethod.length=w,a=0;w>a;a++)S.interpolationMethod[a]=it.interpolation[g.getUint8()];null!=S.parent&&S.parent.childs.push(S);var b=e.getUint16();b>0&&(S.extenData=i.slice(e.pos,e.pos+b),e.pos+=b);var D=e.getUint16();S.keyFrame.length=D;var A,R=0;for(a=0,s=D;s>a;a++){if(A=S.keyFrame[a]=new $,A.duration=e.getFloat32(),A.startTime=R,2===S.lerpType){A.interpolationData=[];var I=e.getUint8(),P=0;switch(P=e.getFloat32()){case 254:for(A.interpolationData.length=w,u=0;w>u;u++)A.interpolationData[u]=0;break;case 255:for(A.interpolationData.length=w,u=0;w>u;u++)A.interpolationData[u]=5;break;default:for(A.interpolationData.push(P),h=1;I>h;h++)A.interpolationData.push(e.getFloat32())}}for(A.data=new Float32Array(w),A.dData=new Float32Array(w),A.nextData=new Float32Array(w),o=0;w>o;o++)A.data[o]=e.getFloat32(),A.data[o]>-1e-8&&A.data[o]<1e-8&&(A.data[o]=0);R+=A.duration}A.startTime=y.playTime,S.playTime=y.playTime,t._calculateKeyFrame(S,D,w)}}},t}(),A=function(){function t(){}return r(t,"laya.ani.AnimationParser02"),t.READ_DATA=function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._reader.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;e>r;r++)i.push(t._reader.getUint32()),n.push(t._reader.getUint32())},t.READ_STRINGS=function(){var e=t._reader.getUint32(),i=t._reader.getUint16(),n=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;i>r;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=n},t.parse=function(e,i){t._templet=e,t._reader=i;i.__getBuffer();t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var n=0,r=t._BLOCK.count;r>n;n++){var a=i.getUint16(),s=t._strings[a],o=t["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call()}},t.READ_ANIMATIONS=function(){var e=t._reader,i=e.__getBuffer(),n=0,r=0,a=0,s=0,o=e.getUint16(),h=[];for(h.length=o,n=0;o>n;n++)h[n]=it.interpolation[e.getByte()];var l=e.getUint8();for(t._templet._anis.length=l,n=0;l>n;n++){var u=t._templet._anis[n]={};u.nodes=new Array;var c=u.name=t._strings[e.getUint16()];t._templet._aniMap[c]=n,u.bone3DMap={},u.playTime=e.getFloat32();var _=u.nodes.length=e.getInt16();for(u.totalKeyframeDatasLength=0,r=0;_>r;r++){var d=u.nodes[r]={};d.keyframeWidth=o,d.childs=[];var f=e.getUint16();f>=0&&(d.name=t._strings[f],u.bone3DMap[d.name]=r),d.keyFrame=new Array,d.parentIndex=e.getInt16(),-1==d.parentIndex?d.parent=null:d.parent=u.nodes[d.parentIndex],u.totalKeyframeDatasLength+=o,d.interpolationMethod=h,null!=d.parent&&d.parent.childs.push(d);var p=e.getUint16();d.keyFrame.length=p;var m=null,g=null;for(a=0,s=p;s>a;a++){m=d.keyFrame[a]={},m.startTime=e.getFloat32(),g&&(g.duration=m.startTime-g.startTime),m.dData=new Float32Array(o),m.nextData=new Float32Array(o);var y=t._DATA.offset,x=e.getUint32(),v=4*o,S=i.slice(y+x,y+x+v);m.data=new Float32Array(S),g=m}m.duration=0,d.playTime=u.playTime,t._templet._calculateKeyFrame(d,p,o)}}},t._templet=null,t._reader=null,t._strings=[],n(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),R=(function(){function t(){}return r(t,"laya.ani.AnimationState"),t.stopped=0,t.paused=1,t.playing=2,t}(),function(){function t(){this.name=null,this.root=null,this.parentBone=null,this.length=10,this.transform=null,this.inheritScale=!0,this.inheritRotation=!0,this.rotation=NaN,this.resultRotation=NaN,this.d=-1,this._tempMatrix=null,this._sprite=null,this.resultTransform=new K,this.resultMatrix=new m,this._children=[]}r(t,"laya.ani.bone.Bone");var e=t.prototype;return e.setTempMatrix=function(t){this._tempMatrix=t;var e,i=0,n=0;for(i=0,n=this._children.length;n>i;i++)e=this._children[i],e.setTempMatrix(this._tempMatrix)},e.update=function(t){this.rotation=this.transform.skX;var e;if(t)e=this.resultTransform.getMatrix(),m.mul(e,t,this.resultMatrix),this.resultRotation=this.rotation;else if(this.resultRotation=this.rotation+this.parentBone.resultRotation,this.parentBone)if(this.inheritRotation&&this.inheritScale)e=this.resultTransform.getMatrix(),m.mul(e,this.parentBone.resultMatrix,this.resultMatrix);else{var i=this.parentBone,n=NaN,r=NaN,a=NaN,s=this.parentBone.resultMatrix;e=this.resultTransform.getMatrix();var o=s.a*e.tx+s.c*e.ty+s.tx,h=s.b*e.tx+s.d*e.ty+s.ty,l=new m;this.inheritRotation?(n=Math.atan2(i.resultMatrix.b,i.resultMatrix.a),r=Math.cos(n),a=Math.sin(n),l.setTo(r,a,-a,r,0,0),m.mul(this._tempMatrix,l,m.TEMP),m.TEMP.copyTo(l),e=this.resultTransform.getMatrix(),m.mul(e,l,this.resultMatrix),this.resultTransform.scX*this.resultTransform.scY<0&&this.resultMatrix.rotate(.5*Math.PI),this.resultMatrix.tx=o,this.resultMatrix.ty=h):this.inheritScale?(e=this.resultTransform.getMatrix(),m.TEMP.identity(),m.TEMP.d=this.d,m.mul(e,m.TEMP,this.resultMatrix),this.resultMatrix.tx=o,this.resultMatrix.ty=h):(e=this.resultTransform.getMatrix(),m.TEMP.identity(),m.TEMP.d=this.d,m.mul(e,m.TEMP,this.resultMatrix),this.resultMatrix.tx=o,this.resultMatrix.ty=h)}else e=this.resultTransform.getMatrix(),e.copyTo(this.resultMatrix);var u,c=0,_=0;for(c=0,_=this._children.length;_>c;c++)u=this._children[c],u.update()},e.updateChild=function(){var t,e=0,i=0;for(e=0,i=this._children.length;i>e;e++)t=this._children[e],t.update()},e.setRotation=function(t){this._sprite&&(this._sprite.rotation=180*t/Math.PI)},e.updateDraw=function(e,n){(!t.ShowBones||t.ShowBones[this.name])&&(this._sprite?(this._sprite.x=e+this.resultMatrix.tx,this._sprite.y=n+this.resultMatrix.ty):(this._sprite=new S,this._sprite.graphics.drawCircle(0,0,5,"#ff0000"),this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00"),this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center"),i.stage.addChild(this._sprite),this._sprite.x=e+this.resultMatrix.tx,this._sprite.y=n+this.resultMatrix.ty));var r,a=0,s=0;for(a=0,s=this._children.length;s>a;a++)r=this._children[a],r.updateDraw(e,n)},e.addChild=function(t){this._children.push(t),t.parentBone=this},e.findBone=function(t){if(this.name==t)return this;var e,i,n=0,r=0;for(n=0,r=this._children.length;r>n;n++)if(e=this._children[n],i=e.findBone(t))return i;return null},e.localToWorld=function(t){var e=t[0],i=t[1];t[0]=e*this.resultMatrix.a+i*this.resultMatrix.c+this.resultMatrix.tx,t[1]=e*this.resultMatrix.b+i*this.resultMatrix.d+this.resultMatrix.ty},t.ShowBones={},t}()),I=function(){function t(){this.name=null,this.parent=null,this.attachmentName=null,this.srcDisplayIndex=-1,this.type="src",this.templet=null,this.currSlotData=null,this.currTexture=null,this.currDisplayData=null,this.displayIndex=-1,this._diyTexture=null,this._parentMatrix=null,this._resultMatrix=null,this._replaceDic={},this._curDiyUV=null,this._curDiyVS=null,this._skinSprite=null,this.deformData=null,this._mVerticleArr=null}r(t,"laya.ani.bone.BoneSlot");var e=t.prototype;return e.showSlotData=function(t,e){void 0===e&&(e=!0),this.currSlotData=t,e&&(this.displayIndex=this.srcDisplayIndex),this.currDisplayData=null,this.currTexture=null},e.showDisplayByName=function(t){this.currSlotData&&this.showDisplayByIndex(this.currSlotData.getDisplayByName(t))},e.replaceDisplayByName=function(t,e){if(this.currSlotData){var i=0;i=this.currSlotData.getDisplayByName(t);var n=0;n=this.currSlotData.getDisplayByName(e),this.replaceDisplayByIndex(i,n)}},e.replaceDisplayByIndex=function(t,e){this.currSlotData&&(this._replaceDic[t]=e,this.displayIndex==t&&this.showDisplayByIndex(t))},e.showDisplayByIndex=function(t){if(this._replaceDic[t]&&(t=this._replaceDic[t]),this.currSlotData&&t>-1&&t<this.currSlotData.displayArr.length){if(this.displayIndex=t,this.currDisplayData=this.currSlotData.displayArr[t],this.currDisplayData){var e=this.currDisplayData.name;this.currTexture=this.templet.getTexture(e),this.currTexture&&y.isWebGL&&0==this.currDisplayData.type&&this.currDisplayData.uvs&&(this.currTexture=this.currDisplayData.createTexture(this.currTexture))}}else this.displayIndex=-1,this.currDisplayData=null,this.currTexture=null},e.replaceSkin=function(t){this._diyTexture=t,this._curDiyUV&&(this._curDiyUV.length=0),this.currDisplayData&&this._diyTexture==this.currDisplayData.texture&&(this._diyTexture=null)},e.setParentMatrix=function(t){this._parentMatrix=t},e.draw=function(e,i,n,r){if(void 0===n&&(n=!1),void 0===r&&(r=1),(null!=this._diyTexture||null!=this.currTexture)&&null!=this.currDisplayData||this.currDisplayData&&3==this.currDisplayData.type){var a=this.currTexture;this._diyTexture&&(a=this._diyTexture);var s;switch(this.currDisplayData.type){case 0:if(e){var o=this.getDisplayMatrix();if(this._parentMatrix){var h=!1;if(o){m.mul(o,this._parentMatrix,m.TEMP);var l;if(n?(null==this._resultMatrix&&(this._resultMatrix=new m),l=this._resultMatrix):l=new m,!y.isWebGL&&this.currDisplayData.uvs||y.isWebGL&&this._diyTexture&&this.currDisplayData.uvs){var u=t._tempMatrix;u.identity(),this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(u.d=-1),this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(h=!0,u.rotate(-Math.PI/2)),m.mul(u,m.TEMP,l)}else m.TEMP.copyTo(l);h?e.drawTexture(a,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,l):e.drawTexture(a,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,l)}}}break;case 1:if(n?(null==this._skinSprite&&(this._skinSprite=t.createSkinMesh()),s=this._skinSprite):s=t.createSkinMesh(),null==s)return;var c;if(null==this.currDisplayData.bones){var _=this.currDisplayData.weights;this.deformData&&(_=this.deformData);var d;this._diyTexture?(this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=Z.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=Z.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),d=this._curDiyUV):d=this.currDisplayData.uvs,this._mVerticleArr=_;this.currDisplayData.triangles.length/3;c=this.currDisplayData.triangles,s.init2(a,null,c,this._mVerticleArr,d);var f=this.getDisplayMatrix();if(this._parentMatrix&&f){m.mul(f,this._parentMatrix,m.TEMP);var p;n?(null==this._resultMatrix&&(this._resultMatrix=new m),p=this._resultMatrix):p=new m,m.TEMP.copyTo(p),s.transform=p}}else this.skinMesh(i,s,r);e.drawSkin(s);break;case 2:if(n?(null==this._skinSprite&&(this._skinSprite=t.createSkinMesh()),s=this._skinSprite):s=t.createSkinMesh(),null==s)return;this.skinMesh(i,s,r),e.drawSkin(s);break;case 3:}}},e.skinMesh=function(t,e,i){var n,r=this.currTexture,a=this.currDisplayData.bones;this._diyTexture?(r=this._diyTexture,this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=Z.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=Z.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),n=this._curDiyUV):n=this.currDisplayData.uvs;var s,o,h=this.currDisplayData.weights,l=this.currDisplayData.triangles,u=0,c=0,_=0,d=NaN,f=NaN,p=0,m=0,g=[],y=0,x=0;if(this.deformData&&this.deformData.length>0){var v=0;for(y=0,x=a.length;x>y;){for(_=a[y++]+y,u=0,c=0;_>y;y++)o=t[a[y]],d=h[p]+this.deformData[v++],f=h[p+1]+this.deformData[v++],m=h[p+2],u+=(d*o.a+f*o.c+o.tx)*m,c+=(d*o.b+f*o.d+o.ty)*m,p+=3;g.push(u,c)}}else for(y=0,x=a.length;x>y;){for(_=a[y++]+y,u=0,c=0;_>y;y++)o=t[a[y]],d=h[p],f=h[p+1],m=h[p+2],u+=(d*o.a+f*o.c+o.tx)*m,c+=(d*o.b+f*o.d+o.ty)*m,p+=3;g.push(u,c)}this._mVerticleArr=g,s=l,e.init2(r,null,s,this._mVerticleArr,n)},e.drawBonePoint=function(t){t&&this._parentMatrix&&t.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000")},e.getDisplayMatrix=function(){return this.currDisplayData?this.currDisplayData.transform.getMatrix():null},e.getMatrix=function(){return this._resultMatrix},e.copy=function(){var e=new t;return e.type="copy",e.name=this.name,e.attachmentName=this.attachmentName,e.srcDisplayIndex=this.srcDisplayIndex,e.parent=this.parent,e.displayIndex=this.displayIndex,e.templet=this.templet,e.currSlotData=this.currSlotData,e.currTexture=this.currTexture,e.currDisplayData=this.currDisplayData,e},t.createSkinMesh=function(){return y.isWebGL||y.isConchApp?v.skinAniSprite():y.isWebGL?null:rt.useSimpleMeshInCanvas?new nt:new et},n(t,["_tempMatrix",function(){return this._tempMatrix=new m}]),t}(),P=function(){function t(){this.mesh=null,this.transform=null,this.context=null,this.mode=0}r(t,"laya.ani.bone.canvasmesh.CanvasMeshRender");var e=t.prototype;return e.renderToContext=function(t){this.context=t.ctx||t,this.mesh&&(0==this.mode?this._renderWithIndexes(this.mesh):this._renderNoIndexes(this.mesh))},e._renderNoIndexes=function(t){var e=0,i=t.vertices.length/2,n=0;for(e=0;i-2>e;e++)n=2*e,this._renderDrawTriangle(t,n,n+2,n+4)},e._renderWithIndexes=function(t){var e=t.indexes,i=0,n=e.length;for(i=0;n>i;i+=3){var r=2*e[i],a=2*e[i+1],s=2*e[i+2];this._renderDrawTriangle(t,r,a,s)}},e._renderDrawTriangle=function(t,e,i,n){var r=this.context,a=t.uvs,s=t.vertices,o=t.texture,h=o.bitmap,l=h.source,u=o.width,c=o.height,_=h.width,d=h.height,f=NaN,p=NaN,m=NaN,g=NaN,y=NaN,x=NaN;if(t.useUvTransform){var v=t.uvTransform;f=(a[e]*v.a+a[e+1]*v.c+v.tx)*_,p=(a[i]*v.a+a[i+1]*v.c+v.tx)*_,m=(a[n]*v.a+a[n+1]*v.c+v.tx)*_,g=(a[e]*v.b+a[e+1]*v.d+v.ty)*d,y=(a[i]*v.b+a[i+1]*v.d+v.ty)*d,x=(a[n]*v.b+a[n+1]*v.d+v.ty)*d}else f=a[e]*_,p=a[i]*_,m=a[n]*_,g=a[e+1]*d,y=a[i+1]*d,x=a[n+1]*d;var S=s[e],T=s[i],E=s[n],w=s[e+1],b=s[i+1],C=s[n+1];if(t.canvasPadding>0){var M=t.canvasPadding,D=t.canvasPadding,A=(S+T+E)/3,R=(w+b+C)/3,I=S-A,P=w-R,L=Math.sqrt(I*I+P*P);S=A+I/L*(L+M),w=R+P/L*(L+D),I=T-A,P=b-R,L=Math.sqrt(I*I+P*P),T=A+I/L*(L+M),b=R+P/L*(L+D),I=E-A,P=C-R,L=Math.sqrt(I*I+P*P),E=A+I/L*(L+M),C=R+P/L*(L+D)}if(r.save(),this.transform){var N=this.transform;r.transform(N.a,N.b,N.c,N.d,N.tx,N.ty)}r.beginPath(),r.moveTo(S,w),r.lineTo(T,b),r.lineTo(E,C),r.closePath(),r.clip();var O=f*y+g*m+p*x-y*m-g*p-f*x,V=1/O,F=S*y+g*E+T*x-y*E-g*T-S*x,B=f*T+S*m+p*E-T*m-S*p-f*E,U=f*y*E+g*T*m+S*p*x-S*y*m-g*p*E-f*T*x,k=w*y+g*C+b*x-y*C-g*b-w*x,H=f*b+w*m+p*C-b*m-w*p-f*C,z=f*y*C+g*b*m+w*p*x-w*y*m-g*p*C-f*b*x;r.transform(F*V,k*V,B*V,H*V,U*V,z*V),r.drawImage(l,o.uv[0]*_,o.uv[1]*d,u,c,o.uv[0]*_,o.uv[1]*d,u,c),r.restore()},t}(),L=function(){function t(){this.texture=null,this.uvs=[0,0,1,0,1,1,0,1],this.vertices=[0,0,100,0,100,100,0,100],this.indexes=[0,1,3,3,1,2],this.uvTransform=null,this.useUvTransform=!1,this.canvasPadding=1}r(t,"laya.ani.bone.canvasmesh.MeshData");var e=t.prototype;return e.getBounds=function(){return g._getWrapRec(this.vertices)},t}(),N=function(){function t(){this.skinName=null,this.deformSlotDataList=[]}return r(t,"laya.ani.bone.DeformAniData"),t}(),O=function(){function t(){this.deformSlotDisplayList=[]}return r(t,"laya.ani.bone.DeformSlotData"),t}(),V=function(){function t(){this.boneSlot=null,this.slotIndex=-1,this.attachment=null,this.deformData=null,this.frameIndex=0,this.timeList=[],this.vectices=[],this.tweenKeyList=[]}r(t,"laya.ani.bone.DeformSlotDisplayData");var e=t.prototype;return e.binarySearch1=function(t,e){var i=0,n=t.length-2;if(0==n)return 1;for(var r=n>>>1;;){if(t[Math.floor(r+1)]<=e?i=r+1:n=r,i==n)return i+1;r=i+n>>>1}return 0},e.apply=function(t,e,i){if(void 0===i&&(i=1),t+=.05,!(this.timeList.length<=0)){var n=0,r=this.timeList[0];if(!(r>t)){var a=this.vectices[0].length,s=[],o=this.binarySearch1(this.timeList,t);if(this.frameIndex=o,t>=this.timeList[this.timeList.length-1]){var h=this.vectices[this.vectices.length-1];if(1>i)for(n=0;a>n;n++)s[n]+=(h[n]-s[n])*i;else for(n=0;a>n;n++)s[n]=h[n];return void(this.deformData=s)}var l=(this.tweenKeyList[this.frameIndex],this.vectices[this.frameIndex-1]),u=this.vectices[this.frameIndex],c=this.timeList[this.frameIndex-1],_=this.timeList[this.frameIndex];i=this.tweenKeyList[o-1]?(t-c)/(_-c):0;var d=NaN;for(n=0;a>n;n++)d=l[n],s[n]=d+(u[n]-d)*i;this.deformData=s}}},t}(),F=function(){function t(){this.time=NaN,this.drawOrder=[]}return r(t,"laya.ani.bone.DrawOrderData"),t}(),B=function(){function t(){this.name=null,this.intValue=0,this.floatValue=NaN,this.stringValue=null,this.time=NaN}return r(t,"laya.ani.bone.EventData"),t}(),U=function(){function t(t,e){this._targetBone=null,this._bones=null,this._data=null,this.name=null,this.mix=NaN,this.bendDirection=NaN,this.isSpine=!0,this._sp=null,this.isDebug=!1,this._data=t,this._targetBone=e[t.targetBoneIndex],this.isSpine=t.isSpine,null==this._bones&&(this._bones=[]),this._bones.length=0;for(var i=0,n=t.boneIndexs.length;n>i;i++)this._bones.push(e[t.boneIndexs[i]]);this.name=t.name,this.mix=t.mix,this.bendDirection=t.bendDirection}r(t,"laya.ani.bone.IkConstraint");var e=t.prototype;return e.apply=function(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:this.isSpine?this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix):this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix)}},e._applyIk1=function(e,i,n,r){var a=e.parentBone,s=1/(a.resultMatrix.a*a.resultMatrix.d-a.resultMatrix.b*a.resultMatrix.c),o=i-a.resultMatrix.tx,h=n-a.resultMatrix.ty,l=(o*a.resultMatrix.d-h*a.resultMatrix.c)*s-e.transform.x,u=(h*a.resultMatrix.a-o*a.resultMatrix.b)*s-e.transform.y,c=Math.atan2(u,l)*t.radDeg-0-e.transform.skX;e.transform.scX<0&&(c+=180),c>180?c-=360:-180>c&&(c+=360),e.transform.skX=e.transform.skY=e.transform.skX+c*r,e.update()},e.updatePos=function(t,e){this._sp&&this._sp.pos(t,e)},e._applyIk2=function(e,n,r,a,s,o){if(0!=o){var h=e.resultTransform.x,l=e.resultTransform.y,u=e.transform.scX,c=e.transform.scY,_=n.transform.scX,d=0,f=0,p=0;0>u?(u=-u,d=180,p=-1):(d=0,p=1),0>c&&(c=-c,p=-p),0>_?(_=-_,f=180):f=0;var m=n.resultTransform.x,g=NaN,y=NaN,x=NaN,v=e.resultMatrix.a,T=e.resultMatrix.c,E=e.resultMatrix.b,w=e.resultMatrix.d,b=Math.abs(u-c)<=1e-4;b?(g=n.resultTransform.y,y=v*m+T*g+e.resultMatrix.tx,x=E*m+w*g+e.resultMatrix.ty):(g=0,y=v*m+e.resultMatrix.tx,x=E*m+e.resultMatrix.ty),this.isDebug&&(this._sp||(this._sp=new S,i.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(r,a,15,"#ffff00"),this._sp.graphics.drawCircle(y,x,15,"#ff00ff")),e.setRotation(Math.atan2(x-e.resultMatrix.ty,y-e.resultMatrix.tx));var C=e.parentBone;v=C.resultMatrix.a,T=C.resultMatrix.c,E=C.resultMatrix.b,w=C.resultMatrix.d;var M=1/(v*w-T*E),D=r-C.resultMatrix.tx,A=a-C.resultMatrix.ty,R=(D*w-A*T)*M-h,I=(A*v-D*E)*M-l;D=y-C.resultMatrix.tx,A=x-C.resultMatrix.ty;var P=(D*w-A*T)*M-h,L=(A*v-D*E)*M-l,N=Math.sqrt(P*P+L*L),O=n.length*_,V=NaN,F=NaN;if(b){O*=u;var B=(R*R+I*I-N*N-O*O)/(2*N*O);-1>B?B=-1:B>1&&(B=1),F=Math.acos(B)*s,v=N+O*B,T=O*Math.sin(F),V=Math.atan2(I*v-R*T,R*v+I*T)}else{v=u*O,T=c*O;var U=v*v,k=T*T,H=R*R+I*I,z=Math.atan2(I,R);E=k*N*N+U*H-U*k;var W=-2*k*N,G=k-U;if(w=W*W-4*G*E,w>0){var j=Math.sqrt(w);0>W&&(j=-j),j=-(W+j)/2;var Y=j/G,X=E/j,q=Math.abs(Y)<Math.abs(X)?Y:X;H>=q*q&&(A=Math.sqrt(H-q*q)*s,V=z-Math.atan2(A,q),F=Math.atan2(A/c,(q-N)/u))}var K=0,Z=Number.MAX_VALUE,$=0,Q=0,J=0,tt=0,et=0,it=0;D=N+v,w=D*D,w>tt&&(J=0,tt=w,et=D),D=N-v,w=D*D,Z>w&&(K=Math.PI,Z=w,$=D);var nt=Math.acos(-v*N/(U-k));D=v*Math.cos(nt)+N,A=T*Math.sin(nt),w=D*D+A*A,Z>w&&(K=nt,Z=w,$=D,Q=A),w>tt&&(J=nt,tt=w,et=D,it=A),(Z+tt)/2>=H?(V=z-Math.atan2(Q*s,$),F=K*s):(V=z-Math.atan2(it*s,et),F=J*s)}var rt=Math.atan2(g,m)*p,at=e.resultTransform.skX;V=(V-rt)*t.radDeg+d-at,V>180?V-=360:-180>V&&(V+=360),e.resultTransform.x=h,e.resultTransform.y=l,e.resultTransform.skX=e.resultTransform.skY=at+V*o,at=n.resultTransform.skX,at%=360,F=((F+rt)*t.radDeg-0)*p+f-at,F>180?F-=360:-180>F&&(F+=360),n.resultTransform.x=m,n.resultTransform.y=g,n.resultTransform.skX=n.resultTransform.skY=n.resultTransform.skY+F*o,e.update()}},e._applyIk3=function(e,n,r,a,s,o){if(0!=o){var h=NaN,l=NaN,u=n.resultMatrix.a*n.length,c=n.resultMatrix.b*n.length,_=u*u+c*c,d=Math.sqrt(_),f=e.resultMatrix.tx,p=e.resultMatrix.ty,m=n.resultMatrix.tx,g=n.resultMatrix.ty,y=m-f,x=g-p,v=y*y+x*x,T=Math.sqrt(v);y=r-e.resultMatrix.tx,x=a-e.resultMatrix.ty;var E=y*y+x*x,w=Math.sqrt(E);if(w>=d+T||T>=w+d||d>=w+T){var b=NaN;b=w>=d+T?1:-1,m=f+b*(r-f)*T/w,g=p+b*(a-p)*T/w}else{var C=(v-_+E)/(2*E),M=Math.sqrt(v-C*C*E)/w,D=f+y*C,A=p+x*C,R=-x*M,I=y*M;s>0?(m=D-R,g=A-I):(m=D+R,g=A+I)}h=m,l=g,this.isDebug&&(this._sp||(this._sp=new S,i.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(f,p,15,"#ff00ff"),this._sp.graphics.drawCircle(r,a,15,"#ffff00"),this._sp.graphics.drawCircle(h,l,15,"#ff00ff"));var P=NaN;P=Math.atan2(l-e.resultMatrix.ty,h-e.resultMatrix.tx),e.setRotation(P);var L;L=t._tempMatrix,L.identity(),L.rotate(P),L.scale(e.resultMatrix.getScaleX(),e.resultMatrix.getScaleY()),L.translate(e.resultMatrix.tx,e.resultMatrix.ty),L.copyTo(e.resultMatrix),e.updateChild();var N=NaN;N=Math.atan2(a-l,r-h),n.setRotation(N);var O;O=t._tempMatrix,O.identity(),O.rotate(N),O.scale(n.resultMatrix.getScaleX(),n.resultMatrix.getScaleY()),O.translate(h,l),L.copyTo(n.resultMatrix),n.updateChild()}},n(t,["radDeg",function(){return this.radDeg=180/Math.PI},"degRad",function(){return this.degRad=Math.PI/180},"_tempMatrix",function(){return this._tempMatrix=new m}]),t}(),k=function(){function t(){this.name=null,this.targetBoneName=null,this.bendDirection=1,this.mix=1,this.isSpine=!0,this.targetBoneIndex=-1,this.boneNames=[],this.boneIndexs=[]}return r(t,"laya.ani.bone.IkConstraintData"),t}(),H=function(){function t(){}return r(t,"laya.ani.bone.MeshTools"),t.findEdge=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!0);var n=0,r=0,a=0;for(r=t.length,a=-1,n=0;r>n;n+=2)(0>a||i==t[a+e]<t[n+e])&&(a=n);return a},t.findBestTriangle=function(e){var i=0;i=t.findEdge(e,1,!0);var n=0;n=t.findEdge(e,1,!1);var r=0;r=t.findEdge(e,0,!0);var a=0;a=t.findEdge(e,0,!1);var s;return s=t._bestTriangle,s.length=0,s.push(r,a),s.indexOf(i)<0&&s.push(i),s.indexOf(n)<0&&s.push(n),s},t.solveMesh=function(e,i){i=i||[],i.length=0;var n;n=e.uvs;var r;r=e.vertices;var a,s;s=t.findBestTriangle(n);var o=0,h=0,l=0;o=s[0],h=s[1],l=s[2],t._absArr.length=0,a=t.solvePoints(e.texture.uv,n[o],n[o+1],n[h]-n[o],n[h+1]-n[o+1],n[l]-n[o],n[l+1]-n[o+1],t._absArr);var u;return u=t.transPoints(a,r[o],r[o+1],r[h]-r[o],r[h+1]-r[o+1],r[l]-r[o],r[l+1]-r[o+1],i)},t.solvePoints=function(e,i,n,r,a,s,o,h){h=h||[];var l=0,u=0;u=e.length;var c;for(l=0;u>l;l+=2)c=t.solve2(e[l],e[l+1],i,n,r,a,s,o),h.push(c[0],c[1]);return h},t.transPoints=function(e,i,n,r,a,s,o,h){h=h||[];var l=0,u=0;u=e.length;var c;for(l=0;u>l;l+=2)c=t.transPoint(e[l],e[l+1],i,n,r,a,s,o,h);return h},t.transPoint=function(t,e,i,n,r,a,s,o,h){h=h||[];var l=NaN,u=NaN;return l=i+r*t+s*e,u=n+a*t+o*e,h.push(l,u),h},t.solve2=function(e,i,n,r,a,s,o,h,l,u){void 0===l&&(l=!1),u=u||[];var c=NaN,_=NaN;if(0==a)return t.solve2(e,i,n,r,o,h,a,s,!0,u);var d=NaN,f=NaN;return d=e-n,f=i-r,_=(f-d*s/a)/(h-o*s/a),c=(d-_*o)/a,l?u.push(_,c):u.push(c,_),u},t.solve=function(e,i,n,r){return t.solve2(e.x,e.y,i.x,i.y,n.x,n.y,r.x,r.y)},t._bestTriangle=[],t._absArr=[],t}(),z=function(){function t(t,e){this.target=null,this.data=null,this.bones=null,this.position=NaN,this.spacing=NaN,this.rotateMix=NaN,this.translateMix=NaN,this._debugKey=!1,this._spaces=null,this._segments=[],this._curves=[],this.data=t,this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.bones=[];for(var i=this.data.bones,n=0,r=i.length;r>n;n++)this.bones.push(e[i[n]])}r(t,"laya.ani.bone.PathConstraint");var e=t.prototype;return e.apply=function(t,e){if(this.target){var i=this.translateMix,n=this.translateMix,r=n>0,a=this.data.spacingMode,s="length"==a,o=this.data.rotateMode,h="tangent"==o,l="chainScale"==o,u=[],c=this.bones.length,_=h?c:c+1,d=[];this._spaces=d,d[0]=this.position;var f=this.spacing;if(l||s)for(var p=0,m=_-1;m>p;){var g=this.bones[p],y=g.length,x=y*g.resultMatrix.a,v=y*g.resultMatrix.b;y=Math.sqrt(x*x+v*v),l&&(u[p]=y),d[++p]=s?Math.max(0,y+f):f}else for(p=1;_>p;p++)d[p]=f;var S=this.computeWorldPositions(this.target,t,e,_,h,"percent"==this.data.positionMode,"percent"==a);if(this._debugKey){for(p=0;p<S.length;p++)e.drawCircle(S[p++],S[p++],5,"#00ff00");var T=[];for(p=0;p<S.length;p++)T.push(S[p++],S[p++]);e.drawLines(0,0,T,"#ff0000")}var E=S[0],w=S[1],b=this.data.offsetRotation,C="chain"==o&&0==b,M=NaN;for(p=0,M=3;c>p;p++,M+=3){g=this.bones[p],g.resultMatrix.tx+=(E-g.resultMatrix.tx)*i,g.resultMatrix.ty+=(w-g.resultMatrix.ty)*i,x=S[M],v=S[M+1];var D=x-E,A=v-w;if(l&&(y=u[p],0!=y)){var R=(Math.sqrt(D*D+A*A)/y-1)*n+1;g.resultMatrix.a*=R,g.resultMatrix.c*=R}if(E=x,w=v,r){var I=g.resultMatrix.a,P=g.resultMatrix.c,L=g.resultMatrix.b,N=g.resultMatrix.d,O=NaN,V=NaN,F=NaN;O=h?S[M-1]:0==d[p+1]?S[M+2]:Math.atan2(A,D),O-=Math.atan2(L,I)-b/180*Math.PI,C&&(V=Math.cos(O),F=Math.sin(O),y=g.length,E+=(y*(V*I-F*L)-D)*n,w+=(y*(F*I+V*L)-A)*n),O>Math.PI?O-=2*Math.PI:O<-Math.PI&&(O+=2*Math.PI),O*=n,V=Math.cos(O),F=Math.sin(O),g.resultMatrix.a=V*I-F*L,g.resultMatrix.c=V*P-F*N,g.resultMatrix.b=F*I+V*L,g.resultMatrix.d=F*P+V*N}}}},e.computeWorldVertices2=function(e,i,n,r,a,s){var o,h,l=e.currDisplayData.bones,u=e.currDisplayData.weights,c=e.currDisplayData.triangles,_=0,d=0,f=0,p=0,m=0,g=0,y=0,x=0,v=0,S=0,T=0;if(null!=l){for(_=0;n>_;_+=2)p=l[d],d+=p+1,f+=p;var E=i;for(m=s,g=3*f;r>m;m+=2){for(y=0,x=0,p=l[d++],p+=d;p>d;d++,g+=3){o=E[l[d]].resultMatrix,v=u[g],S=u[g+1];var w=u[g+2];y+=(v*o.a+S*o.c+o.tx)*w,x+=(v*o.b+S*o.d+o.ty)*w}a[m]=y,a[m+1]=x}}else{c||(c=u),e.deformData&&(c=e.deformData);var b;if(b=e.parent,i)for(T=i.length,_=0;T>_;_++)if(i[_].name==b){h=i[_];break}var C;h&&(C=h.resultMatrix),C||(C=t._tempMt);var M=C.tx,D=C.ty,A=C.a,R=C.b,I=C.c,P=C.d;for(h&&(P*=h.d),d=n,m=s;r>m;d+=2,m+=2)v=c[d],S=c[d+1],a[m]=v*A+S*R+M,a[m+1]=-(v*I+S*P+D)}},e.computeWorldPositions=function(t,e,i,n,r,a,s){var o=(t.currDisplayData.bones,t.currDisplayData.weights,t.currDisplayData.triangles,[]),h=0,l=t.currDisplayData.verLen,u=this.position,c=this._spaces,_=[],d=[],f=!1,p=l/6,m=-1,g=NaN,y=0,x=0,v=NaN,S=NaN,T=NaN,E=NaN;if(f)l+=2,_[l-2]=_[0],_[l-1]=_[1];else{if(p--,l-=4,this.computeWorldVertices2(t,e,2,l,o,0),this._debugKey)for(h=0;h<o.length;)i.drawCircle(o[h++],o[h++],10,"#ff0000");_=o}this._curves.length=p;var w=this._curves;g=0;var b=_[0],C=_[1],M=0,D=0,A=0,R=0,I=0,P=0,L=NaN,N=NaN,O=NaN,V=NaN,F=NaN,B=NaN,U=NaN,k=NaN,H=0;for(h=0,H=2;p>h;h++,H+=6)M=_[H],D=_[H+1],A=_[H+2],R=_[H+3],I=_[H+4],P=_[H+5],L=.1875*(b-2*M+A),N=.1875*(C-2*D+R),O=.09375*(3*(M-A)-b+I),V=.09375*(3*(D-R)-C+P),F=2*L+O,B=2*N+V,U=.75*(M-b)+L+.16666667*O,k=.75*(D-C)+N+.16666667*V,g+=Math.sqrt(U*U+k*k),U+=F,k+=B,F+=O,B+=V,g+=Math.sqrt(U*U+k*k),U+=F,k+=B,g+=Math.sqrt(U*U+k*k),U+=F+O,k+=B+V,g+=Math.sqrt(U*U+k*k),w[h]=g,b=I,C=P;if(a&&(u*=g),s)for(h=0;n>h;h++)c[h]*=g;var z=this._segments,W=0,G=0;for(h=0,y=0,x=0,G=0;n>h;h++,y+=3){if(S=c[h],u+=S,v=u,f)v%=g,0>v&&(v+=g),x=0;else{if(0>v){this.addBeforePosition(v,_,0,d,y);continue}if(v>g){this.addAfterPosition(v-g,_,l-4,d,y);continue}}for(;;x++)if(E=w[x],!(v>E)){0==x?v/=E:(T=w[x-1],v=(v-T)/(E-T));break}if(x!=m){m=x;var j=6*x;for(b=_[j],C=_[j+1],M=_[j+2],D=_[j+3],A=_[j+4],R=_[j+5],I=_[j+6],P=_[j+7],L=.03*(b-2*M+A),N=.03*(C-2*D+R),O=.006*(3*(M-A)-b+I),V=.006*(3*(D-R)-C+P),F=2*L+O,B=2*N+V,U=.3*(M-b)+L+.16666667*O,k=.3*(D-C)+N+.16666667*V,W=Math.sqrt(U*U+k*k),z[0]=W,j=1;8>j;j++)U+=F,k+=B,F+=O,B+=V,W+=Math.sqrt(U*U+k*k),z[j]=W;U+=F,k+=B,W+=Math.sqrt(U*U+k*k),z[8]=W,U+=F+O,k+=B+V,W+=Math.sqrt(U*U+k*k),z[9]=W,G=0}for(v*=W;;G++)if(E=z[G],!(v>E)){0==G?v/=E:(T=z[G-1],v=G+(v-T)/(E-T));break}this.addCurvePosition(.1*v,b,C,M,D,A,R,I,P,d,y,r||h>0&&0==S)}return d},e.addBeforePosition=function(t,e,i,n,r){var a=e[i],s=e[i+1],o=e[i+2]-a,h=e[i+3]-s,l=Math.atan2(h,o);n[r]=a+t*Math.cos(l),n[r+1]=s+t*Math.sin(l),n[r+2]=l},e.addAfterPosition=function(t,e,i,n,r){var a=e[i+2],s=e[i+3],o=a-e[i],h=s-e[i+1],l=Math.atan2(h,o);n[r]=a+t*Math.cos(l),n[r+1]=s+t*Math.sin(l),n[r+2]=l},e.addCurvePosition=function(t,e,i,n,r,a,s,o,h,l,u,c){0==t&&(t=1e-4);var _=t*t,d=_*t,f=1-t,p=f*f,m=p*f,g=f*t,y=3*g,x=f*y,v=y*t,S=e*m+n*x+a*v+o*d,T=i*m+r*x+s*v+h*d;l[u]=S,l[u+1]=T,c?l[u+2]=Math.atan2(T-(i*p+r*g*2+s*_),S-(e*p+n*g*2+a*_)):l[u+2]=0},t.NONE=-1,t.BEFORE=-2,t.AFTER=-3,n(t,["_tempMt",function(){return this._tempMt=new m}]),t}(),W=function(){function t(){this.name=null,this.target=null,this.positionMode=null,this.spacingMode=null,this.rotateMode=null,this.offsetRotation=NaN,this.position=NaN,this.spacing=NaN,this.rotateMix=NaN,this.translateMix=NaN,this.bones=[]}return r(t,"laya.ani.bone.PathConstraintData"),t}(),G=function(){function t(){this.name=null,this.slotArr=[]}return r(t,"laya.ani.bone.SkinData"),t}(),j=function(){function t(){this.name=null,this.attachmentName=null,this.type=0,this.transform=null,this.width=NaN,this.height=NaN,this.texture=null,this.bones=null,this.uvs=null,this.weights=null,this.triangles=null,this.vertices=null,this.lengths=null,this.verLen=0}r(t,"laya.ani.bone.SkinSlotDisplayData");var e=t.prototype;return e.createTexture=function(t){return this.texture?this.texture:(this.texture=new E(t.bitmap,this.uvs),this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]?(this.texture.width=t.height,this.texture.height=t.width,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceHeight,this.texture.sourceHeight=t.sourceWidth):(this.texture.width=t.width,this.texture.height=t.height,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceWidth,this.texture.sourceHeight=t.sourceHeight),this.texture)},e.destory=function(){this.texture&&this.texture.destroy()},t}(),Y=function(){function t(){this.name=null,this.displayArr=[]}r(t,"laya.ani.bone.SlotData");var e=t.prototype;return e.getDisplayByName=function(t){for(var e,i=0,n=this.displayArr.length;n>i;i++)if(e=this.displayArr[i],e.attachmentName==t)return i;return-1},t}(),X=function(){function t(t,e){this._data=null,this._bones=null,this.target=null,this.rotateMix=NaN,this.translateMix=NaN,this.scaleMix=NaN,this.shearMix=NaN,this._temp=s(2,0),this._data=t,null==this._bones&&(this._bones=[]),this.target=e[t.targetIndex];var i=0,n=0;for(i=0,n=t.boneIndexs.length;n>i;i++)this._bones.push(e[t.boneIndexs[i]]);this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.scaleMix=t.scaleMix,this.shearMix=t.shearMix}r(t,"laya.ani.bone.TfConstraint");var e=t.prototype;return e.apply=function(){for(var t,e=this.target.resultMatrix.a,i=this.target.resultMatrix.b,n=this.target.resultMatrix.c,r=this.target.resultMatrix.d,a=0,s=this._bones.length;s>a;a++){
if(t=this._bones[a],this.rotateMix>0){var o=t.resultMatrix.a,h=t.resultMatrix.b,l=t.resultMatrix.c,u=t.resultMatrix.d,c=Math.atan2(n,e)-Math.atan2(l,o)+this._data.offsetRotation*Math.PI/180;c>Math.PI?c-=2*Math.PI:c<-Math.PI&&(c+=2*Math.PI),c*=this.rotateMix;var _=Math.cos(c),d=Math.sin(c);t.resultMatrix.a=_*o-d*l,t.resultMatrix.b=_*h-d*u,t.resultMatrix.c=d*o+_*l,t.resultMatrix.d=d*h+_*u}if(this.translateMix&&(this._temp[0]=this._data.offsetX,this._temp[1]=this._data.offsetY,this.target.localToWorld(this._temp),t.resultMatrix.tx+=(this._temp[0]-t.resultMatrix.tx)*this.translateMix,t.resultMatrix.ty+=(this._temp[1]-t.resultMatrix.ty)*this.translateMix,t.updateChild()),this.scaleMix>0){var f=Math.sqrt(t.resultMatrix.a*t.resultMatrix.a+t.resultMatrix.c*t.resultMatrix.c),p=Math.sqrt(e*e+n*n),m=f>1e-5?(f+(p-f+this._data.offsetScaleX)*this.scaleMix)/f:0;t.resultMatrix.a*=m,t.resultMatrix.c*=m,f=Math.sqrt(t.resultMatrix.b*t.resultMatrix.b+t.resultMatrix.d*t.resultMatrix.d),p=Math.sqrt(i*i+r*r),m=f>1e-5?(f+(p-f+this._data.offsetScaleY)*this.scaleMix)/f:0,t.resultMatrix.b*=m,t.resultMatrix.d*=m}if(this.shearMix>0){h=t.resultMatrix.b,u=t.resultMatrix.d;var g=Math.atan2(u,h);c=Math.atan2(r,i)-Math.atan2(n,e)-(g-Math.atan2(t.resultMatrix.c,t.resultMatrix.a)),c>Math.PI?c-=2*Math.PI:c<-Math.PI&&(c+=2*Math.PI),c=g+(c+this._data.offsetShearY*Math.PI/180)*this.shearMix,m=Math.sqrt(h*h+u*u),t.resultMatrix.b=Math.cos(c)*m,t.resultMatrix.d=Math.sin(c)*m}}},t}(),q=function(){function t(){this.name=null,this.targetIndex=0,this.rotateMix=NaN,this.translateMix=NaN,this.scaleMix=NaN,this.shearMix=NaN,this.offsetRotation=NaN,this.offsetX=NaN,this.offsetY=NaN,this.offsetScaleX=NaN,this.offsetScaleY=NaN,this.offsetShearY=NaN,this.boneIndexs=[]}return r(t,"laya.ani.bone.TfConstraintData"),t}(),K=function(){function t(){this.skX=0,this.skY=0,this.scX=1,this.scY=1,this.x=0,this.y=0,this.skewX=0,this.skewY=0,this.mMatrix=null}r(t,"laya.ani.bone.Transform");var e=t.prototype;return e.initData=function(t){void 0!=t.x&&(this.x=t.x),void 0!=t.y&&(this.y=t.y),void 0!=t.skX&&(this.skX=t.skX),void 0!=t.skY&&(this.skY=t.skY),void 0!=t.scX&&(this.scX=t.scX),void 0!=t.scY&&(this.scY=t.scY)},e.getMatrix=function(){var t;return t=this.mMatrix?this.mMatrix:this.mMatrix=new m,t.identity(),t.scale(this.scX,this.scY),(this.skewX||this.skewY)&&this.skew(t,this.skewX*Math.PI/180,this.skewY*Math.PI/180),t.rotate(this.skX*Math.PI/180),t.translate(this.x,this.y),t},e.skew=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),a=Math.sin(e),s=Math.cos(e);return t.setTo(t.a*s-t.b*n,t.a*a+t.b*r,t.c*s-t.d*n,t.c*a+t.d*r,t.tx*s-t.ty*n,t.tx*a+t.ty*r),t},t}(),Z=function(){function t(){}return r(t,"laya.ani.bone.UVTools"),t.getRelativeUV=function(t,e,i){var n=t[0],r=t[2]-t[0],a=t[1],s=t[5]-t[1];i||(i=[]),i.length=e.length;var o=0,h=0;h=i.length;var l=1/r,u=1/s;for(o=0;h>o;o+=2)i[o]=(e[o]-n)*l,i[o+1]=(e[o+1]-a)*u;return i},t.getAbsoluteUV=function(t,e,i){if(0==t[0]&&0==t[1]&&1==t[4]&&1==t[5])return i?(b.copyArray(i,e),i):e;var n=t[0],r=t[2]-t[0],a=t[1],s=t[5]-t[1];i||(i=[]),i.length=e.length;var o=0,h=0;for(h=i.length,o=0;h>o;o+=2)i[o]=e[o]*r+n,i[o+1]=e[o+1]*s+a;return i},t}(),$=function(){function t(){this.startTime=NaN,this.duration=NaN,this.interpolationData=null,this.data=null,this.dData=null,this.nextData=null}return r(t,"laya.ani.KeyFramesContent"),t}(),Q=function(){function t(){}return r(t,"laya.ani.math.BezierLerp"),t.getBezierRate=function(e,i,n,r,a){var s=t._getBezierParamKey(i,n,r,a),o=100*s+e;if(t._bezierResultCache[o])return t._bezierResultCache[o];var h=t._getBezierPoints(i,n,r,a,s),l=0,u=0;for(u=h.length,l=0;u>l;l+=2)if(e<=h[l])return t._bezierResultCache[o]=h[l+1],h[l+1];return t._bezierResultCache[o]=1,1},t._getBezierParamKey=function(t,e,i,n){return 100*(100*(100*(100*t+e)+i)+n)},t._getBezierPoints=function(e,i,n,r,a){if(t._bezierPointsCache[a])return t._bezierPointsCache[a];var s;s=[0,0,e,i,n,r,1,1];var h;h=new o;var l;return l=h.getBezierPoints(s,100,3),t._bezierPointsCache[a]=l,l},t._bezierResultCache={},t._bezierPointsCache={},t}(),J=function(t){function e(){this._destroyed=!1,this._templet=null,this._currentTime=NaN,this._currentFrameTime=NaN,this._playStart=NaN,this._playEnd=NaN,this._playDuration=NaN,this._overallDuration=NaN,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=NaN,this._startUpdateLoopCount=NaN,this._currentAnimationClipIndex=0,this._currentKeyframeIndex=0,this._paused=!1,this._cacheFrameRate=0,this._cacheFrameRateInterval=NaN,this._cachePlayRate=NaN,this._fullFrames=null,this.isCache=!0,this.playbackRate=1,this.returnToZeroStopped=!1,e.__super.call(this),this._destroyed=!1,this._currentAnimationClipIndex=-1,this._currentKeyframeIndex=-1,this._currentTime=0,this._overallDuration=Number.MAX_VALUE,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this._cachePlayRate=1,this.cacheFrameRate=60,this.returnToZeroStopped=!1}r(e,"laya.ani.AnimationPlayer",t);var n=e.prototype;return i.imps(n,{"laya.resource.IDestroy":!0}),n._onTempletLoadedComputeFullKeyframeIndices=function(t,e,i){this._templet===i&&this._cachePlayRate===t&&this._cacheFrameRate===e&&this._computeFullKeyframeIndices()},n._computeFullKeyframeIndices=function(){for(var t=this._fullFrames=[],e=this._templet,i=this._cacheFrameRateInterval*this._cachePlayRate,n=0,r=e.getAnimationCount();r>n;n++){for(var a=[],s=0,o=e.getAnimation(n).nodes.length;o>s;s++){for(var h=e.getAnimation(n).nodes[s],l=Math.floor(h.playTime/i+.01),u=new Uint16Array(l+1),c=-1,_=0,d=h.keyFrame.length;d>_;_++){var f=h.keyFrame[_],p=f.startTime,m=p+f.duration+i;do{for(var g=Math.floor(p/i+.5),y=c+1;g>y;y++)u[y]=_;c=g,u[g]=_,p+=i}while(m>=p)}a.push(u)}t.push(a)}},n._onAnimationTempletLoaded=function(){this.destroyed||this._calculatePlayDuration()},n._calculatePlayDuration=function(){if(0!==this.state){var t=this._templet.getAniDuration(this._currentAnimationClipIndex);0===this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart}},n._setPlayParams=function(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e},n._setPlayParamsWhenStop=function(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.floor(t/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e,this._currentAnimationClipIndex=-1},n._update=function(t){if(-1!==this._currentAnimationClipIndex&&!this._paused&&this._templet&&this._templet.loaded){var e=this._cacheFrameRateInterval*this._cachePlayRate,i=0;this._startUpdateLoopCount!==T.loopCount&&(i=t*this.playbackRate,this._elapsedPlaybackTime+=i);var n=this.playDuration;if(0!==this._overallDuration&&this._elapsedPlaybackTime>=this._overallDuration||0===this._overallDuration&&this._elapsedPlaybackTime>=n)return this._setPlayParamsWhenStop(n,e),void this.event("stopped");if(i+=this._currentTime,n>0)if(i>=n){do{if(i-=n,this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(n,e),this._stopWhenCircleFinish=!1,void this.event("stopped");n>i&&(this._setPlayParams(i,e),this.event("complete"))}while(i>=n)}else this._setPlayParams(i,e);else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(n,e),this._stopWhenCircleFinish=!1,void this.event("stopped");this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this.event("complete")}}},n._destroy=function(){this.offAll(),this._templet=null,this._fullFrames=null,this._destroyed=!0},n.play=function(t,e,i,n,r){if(void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=2147483647),void 0===n&&(n=0),void 0===r&&(r=0),!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(0>i||0>n||0>r)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(0!==r&&n>r)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=e,this._overallDuration=i,this._playStart=n,this._playEnd=r,this._paused=!1,this._currentAnimationClipIndex=t,this._currentKeyframeIndex=0,this._startUpdateLoopCount=T.loopCount,this.event("played"),this._templet.loaded?this._calculatePlayDuration():this._templet.once("loaded",this,this._onAnimationTempletLoaded),this._update(0)},n.playByFrame=function(t,e,i,n,r,a){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=2147483647),void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=30);var s=1e3/a;this.play(t,e,i,n*s,r*s)},n.stop=function(t){void 0===t&&(t=!0),t?(this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this._currentAnimationClipIndex=-1,this.event("stopped")):this._stopWhenCircleFinish=!0},a(0,n,"playEnd",function(){return this._playEnd}),a(0,n,"templet",function(){return this._templet},function(t){0===!this.state&&this.stop(!0),this._templet!==t&&(this._templet=t,t.loaded?this._computeFullKeyframeIndices():t.once("loaded",this,this._onTempletLoadedComputeFullKeyframeIndices,[this._cachePlayRate,this._cacheFrameRate]))}),a(0,n,"playStart",function(){return this._playStart}),a(0,n,"playDuration",function(){return this._playDuration}),a(0,n,"state",function(){return-1===this._currentAnimationClipIndex?0:this._paused?1:2}),a(0,n,"currentKeyframeIndex",function(){return this._currentKeyframeIndex}),a(0,n,"overallDuration",function(){return this._overallDuration}),a(0,n,"currentFrameTime",function(){return this._currentFrameTime}),a(0,n,"currentAnimationClipIndex",function(){return this._currentAnimationClipIndex}),a(0,n,"currentPlayTime",function(){return this._currentTime+this._playStart}),a(0,n,"cachePlayRate",function(){return this._cachePlayRate},function(t){this._cachePlayRate!==t&&(this._cachePlayRate=t,this._templet&&(this._templet.loaded?this._computeFullKeyframeIndices():this._templet.once("loaded",this,this._onTempletLoadedComputeFullKeyframeIndices,[t,this._cacheFrameRate])))}),a(0,n,"cacheFrameRate",function(){return this._cacheFrameRate},function(t){this._cacheFrameRate!==t&&(this._cacheFrameRate=t,this._cacheFrameRateInterval=1e3/this._cacheFrameRate,this._templet&&(this._templet.loaded?this._computeFullKeyframeIndices():this._templet.once("loaded",this,this._onTempletLoadedComputeFullKeyframeIndices,[this._cachePlayRate,t])))}),a(0,n,"currentTime",null,function(t){if(-1!==this._currentAnimationClipIndex&&this._templet&&this._templet.loaded){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=T.loopCount;var e=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e),this._currentFrameTime=this._currentKeyframeIndex*e}}),a(0,n,"paused",function(){return this._paused},function(t){this._paused=t,t&&this.event("paused")}),a(0,n,"cacheFrameRateInterval",function(){return this._cacheFrameRateInterval}),a(0,n,"destroyed",function(){return this._destroyed}),e}(u),tt=function(t){function e(){e.__super.call(this),y.isConchNode&&(this.drawSkin=function(t){t.transform||(t.transform=m.EMPTY),this.setSkinMesh&&this.setSkinMesh(t._ps,t.mVBData,t.mEleNum,0,t.mTexture,t.transform)})}r(e,"laya.ani.GraphicsAni",t);var i=e.prototype;return i.drawSkin=function(t){var e=[t];this._saveToCmd(y._context._drawSkin,e)},e}(c),et=function(t){function e(){e.__super.call(this),this.mesh=new L}r(e,"laya.ani.bone.canvasmesh.SkinMeshCanvas",t);var i=e.prototype;return i.init2=function(t,e,i,n,r){this.transform&&(this.transform=null);var a;i?a=i:(a=[],a.push(0,1,3,3,1,2)),this.mesh.texture=t,this.mesh.indexes=a,this.mesh.vertices=n,this.mesh.uvs=r},i.render=function(t,i,n){this.mesh.texture&&(this.transform?(this.transform.translate(i,n),this.renderToContext(t),this.transform.translate(-i,-n)):(this.transform=e._tempMatrix,this.transform.identity(),this.transform.translate(i,n),this.renderToContext(t),this.transform.translate(-i,-n),this.transform=null))},n(e,["_tempMatrix",function(){return this._tempMatrix=new m}]),e}(P),it=function(t){function e(){this._aniMap={},this.unfixedLastAniIndex=-1,e.__super.call(this),this._anis=new Array}r(e,"laya.ani.AnimationTemplet",t);var n=e.prototype;return n.parse=function(t){var e=new l(t);this._aniVersion=e.readUTFString(),D.parse(this,e)},n._calculateKeyFrame=function(t,e,i){var n=t.keyFrame;n[e]=n[0];for(var r=0;e>r;r++)for(var a=n[r],s=0;i>s;s++)a.dData[s]=0===a.duration?0:(n[r+1].data[s]-a.data[s])/a.duration,a.nextData[s]=n[r+1].data[s];n.length--},n.onAsynLoaded=function(t,e,i){var n=new l(e);switch(this._aniVersion=n.readUTFString(),this._aniVersion){case"LAYAANIMATION:02":A.parse(this,n);break;default:D.parse(this,n)}this._endLoaded()},n.getAnimationCount=function(){return this._anis.length},n.getAnimation=function(t){return this._anis[t]},n.getAniDuration=function(t){return this._anis[t].playTime},n.getNodes=function(t){return this._anis[t].nodes},n.getNodeIndexWithName=function(t,e){return this._anis[t].bone3DMap[e]},n.getNodeCount=function(t){return this._anis[t].nodes.length},n.getTotalkeyframesLength=function(t){return this._anis[t].totalKeyframeDatasLength},n.getPublicExtData=function(){return this._publicExtData},n.getAnimationDataWithCache=function(t,e,i,n){var r=e[i];if(r){var a=r[t];return a?a[n]:null}return null},n.setAnimationDataWithCache=function(t,e,i,n,r){var a=e[i]||(e[i]={}),s=a[t]||(a[t]=[]);s[n]=r},n.getOriginalData=function(t,i,n,r,a){for(var s=this._anis[t],o=s.nodes,h=0,l=0,u=o.length,c=0;u>l;l++){var _,d=o[l];_=d.keyFrame[n[l][r]],d.dataOffset=c;var f=a-_.startTime,p=d.lerpType;if(p)switch(p){case 0:case 1:for(h=0;h<d.keyframeWidth;)h+=d.interpolationMethod[h](d,h,i,c+h,_.data,f,_.dData,_.duration,_.nextData);break;case 2:var m=_.interpolationData,g=m.length,y=0;for(h=0;g>h;){var x=m[h];switch(x){case 6:h+=e.interpolation[x](d,y,i,c+y,_.data,f,_.dData,_.duration,_.nextData,m,h+1);break;case 7:h+=e.interpolation[x](d,y,i,c+y,_.data,f,_.dData,_.duration,_.nextData,m,h+1);break;default:h+=e.interpolation[x](d,y,i,c+y,_.data,f,_.dData,_.duration,_.nextData)}y++}}else for(h=0;h<d.keyframeWidth;)h+=d.interpolationMethod[h](d,h,i,c+h,_.data,f,_.dData,_.duration,_.nextData);c+=d.keyframeWidth}},n.getNodesCurrentFrameIndex=function(t,e){var i=this._anis[t],n=i.nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(n.length),this.unfixedCurrentTimes=new Float32Array(n.length),this.unfixedLastAniIndex=t);for(var r=0,a=n.length;a>r;r++){var s=n[r];for(e<this.unfixedCurrentTimes[r]&&(this.unfixedCurrentFrameIndexes[r]=0),this.unfixedCurrentTimes[r]=e;this.unfixedCurrentFrameIndexes[r]<s.keyFrame.length&&!(s.keyFrame[this.unfixedCurrentFrameIndexes[r]].startTime>this.unfixedCurrentTimes[r]);)this.unfixedCurrentFrameIndexes[r]++;this.unfixedCurrentFrameIndexes[r]--}return this.unfixedCurrentFrameIndexes},n.getOriginalDataUnfixedRate=function(t,i,n){var r=this._anis[t],a=r.nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(a.length),this.unfixedCurrentTimes=new Float32Array(a.length),this.unfixedKeyframes=s(a.length),this.unfixedLastAniIndex=t);for(var o=0,h=0,l=a.length,u=0;l>h;h++){var c=a[h];for(n<this.unfixedCurrentTimes[h]&&(this.unfixedCurrentFrameIndexes[h]=0),this.unfixedCurrentTimes[h]=n;this.unfixedCurrentFrameIndexes[h]<c.keyFrame.length&&!(c.keyFrame[this.unfixedCurrentFrameIndexes[h]].startTime>this.unfixedCurrentTimes[h]);)this.unfixedKeyframes[h]=c.keyFrame[this.unfixedCurrentFrameIndexes[h]],this.unfixedCurrentFrameIndexes[h]++;var _=this.unfixedKeyframes[h];c.dataOffset=u;var d=n-_.startTime,f=c.lerpType;if(f)switch(c.lerpType){case 0:case 1:for(o=0;o<c.keyframeWidth;)o+=c.interpolationMethod[o](c,o,i,u+o,_.data,d,_.dData,_.duration,_.nextData);break;case 2:var p=_.interpolationData,m=p.length,g=0;for(o=0;m>o;){var y=p[o];switch(y){case 6:o+=e.interpolation[y](c,g,i,u+g,_.data,d,_.dData,_.duration,_.nextData,p,o+1);break;case 7:o+=e.interpolation[y](c,g,i,u+g,_.data,d,_.dData,_.duration,_.nextData,p,o+1);break;default:o+=e.interpolation[y](c,g,i,u+g,_.data,d,_.dData,_.duration,_.nextData)}g++}}else for(o=0;o<c.keyframeWidth;)o+=c.interpolationMethod[o](c,o,i,u+o,_.data,d,_.dData,_.duration,_.nextData);u+=c.keyframeWidth}},e._LinearInterpolation_0=function(t,e,i,n,r,a,s,o,h,l){return i[n]=r[e]+a*s[e],1},e._QuaternionInterpolation_1=function(t,e,i,n,r,a,s,o,h,l){var u=0===o?0:a/o;return p.slerpQuaternionArray(r,e,h,e,u,i,n),4},e._AngleInterpolation_2=function(t,e,i,n,r,a,s,o,h,l){return 0},e._RadiansInterpolation_3=function(t,e,i,n,r,a,s,o,h,l){return 0},e._Matrix4x4Interpolation_4=function(t,e,i,n,r,a,s,o,h,l){for(var u=0;16>u;u++,e++)i[n+u]=r[e]+a*s[e];return 16},e._NoInterpolation_5=function(t,e,i,n,r,a,s,o,h,l){return i[n]=r[e],1},e._BezierInterpolation_6=function(t,e,i,n,r,a,s,o,h,l,u){return void 0===u&&(u=0),i[n]=r[e]+(h[e]-r[e])*Q.getBezierRate(a/o,l[u],l[u+1],l[u+2],l[u+3]),5},e._BezierInterpolation_7=function(t,e,i,n,r,a,s,o,h,l,u){return void 0===u&&(u=0),i[n]=l[u+4]+l[u+5]*Q.getBezierRate((.001*a+l[u+6])/l[u+7],l[u],l[u+1],l[u+2],l[u+3]),9},e.load=function(t){return i.loader.create(t,null,null,e)},e.interpolation=[e._LinearInterpolation_0,e._QuaternionInterpolation_1,e._AngleInterpolation_2,e._RadiansInterpolation_3,e._Matrix4x4Interpolation_4,e._NoInterpolation_5,e._BezierInterpolation_6,e._BezierInterpolation_7],e}(x),nt=(function(t){function e(){this.isCached=!1,this.canvas=null,this.tex=null,this.rec=null,e.__super.call(this)}r(e,"laya.ani.bone.canvasmesh.CacheAbleSkinMesh",t);var i=e.prototype;return i.getCanvasPic=function(){var t=new _("2D"),i=t.getContext("2d");this.rec=this.mesh.getBounds(),t.size(this.rec.width,this.rec.height);var n;return n=this.transform,this.transform=e.tempMt,this.transform.identity(),this.transform.translate(-this.rec.x,-this.rec.y),this.renderToContext(i),this.transform.translate(+this.rec.x,+this.rec.y),this.transform=n,new E(t)},i.render=function(t,e,i){this.mesh.texture&&(this.isCached||(this.isCached=!0,this.tex=this.getCanvasPic()),this.transform?(this.transform.translate(e,i),this._renderTextureToContext(t),this.transform.translate(-e,-i)):(this.transform=et._tempMatrix,this.transform.identity(),this.transform.translate(e,i),this._renderTextureToContext(t),this.transform.translate(-e,-i),this.transform=null))},i._renderTextureToContext=function(t){this.context=t.ctx||t,t.save();var e;if(e=this.tex,this.transform){var i=this.transform;t.transform(i.a,i.b,i.c,i.d,i.tx,i.ty)}this.rec=this.mesh.getBounds(),t.translate(this.rec.x,this.rec.y),t.drawTexture(e,0,0,e.width,e.height,0,0),t.restore()},n(e,["tempMt",function(){return this.tempMt=new m}]),e}(et),function(t){function e(){this.cacheOK=!1,this.cacheCmdOK=!1,this.transformCmds=[],this.drawCmds=[],e.__super.call(this),this.tempMesh=new L}r(e,"laya.ani.bone.canvasmesh.SimpleSkinMeshCanvas",t);var i=e.prototype;return i.init2=function(e,i,n,r,a){t.prototype.init2.call(this,e,i,n,r,a),this.cacheOK=!1,this.cacheCmdOK=!1,this.transformCmds.length=6,this.drawCmds.length=9},i.renderToContext=function(t){if(this.context=t.ctx||t,this.mesh){if(this.mesh.uvs.length<=8)return void(0==this.mode?this._renderWithIndexes(this.mesh):this._renderNoIndexes(this.mesh));this.cacheOK||(this.tempMesh.texture=this.mesh.texture,this.tempMesh.uvs=this.mesh.texture.uv,this.tempMesh.vertices=H.solveMesh(this.mesh,this.tempMesh.vertices),this.cacheOK=!0),0==this.mode?this._renderWithIndexes(this.tempMesh):this._renderNoIndexes(this.tempMesh)}},i._renderWithIndexes=function(t){if(this.cacheCmdOK)return void this.renderByCache(t);var e=t.indexes,i=0,n=e.length;for(n>1&&(n=1),i=0;n>i;i+=3){var r=2*e[i],a=2*e[i+1],s=2*e[i+2];this._renderDrawTriangle(t,r,a,s)}this.cacheCmdOK=!0},i._renderDrawTriangle=function(t,e,i,n){var r=this.context,a=t.uvs,s=t.vertices,o=t.texture,h=o.bitmap,l=h.source,u=o.width,c=o.height,_=h.width,d=h.height,f=NaN,p=NaN,m=NaN,g=NaN,y=NaN,x=NaN;if(t.useUvTransform){var v=t.uvTransform;f=(a[e]*v.a+a[e+1]*v.c+v.tx)*_,p=(a[i]*v.a+a[i+1]*v.c+v.tx)*_,m=(a[n]*v.a+a[n+1]*v.c+v.tx)*_,g=(a[e]*v.b+a[e+1]*v.d+v.ty)*d,y=(a[i]*v.b+a[i+1]*v.d+v.ty)*d,x=(a[n]*v.b+a[n+1]*v.d+v.ty)*d}else f=a[e]*_,p=a[i]*_,m=a[n]*_,g=a[e+1]*d,y=a[i+1]*d,x=a[n+1]*d;var S=s[e],T=s[i],E=s[n],w=s[e+1],b=s[i+1],C=s[n+1],M=f*y+g*m+p*x-y*m-g*p-f*x,D=1/M,A=S*y+g*E+T*x-y*E-g*T-S*x,R=f*T+S*m+p*E-T*m-S*p-f*E,I=f*y*E+g*T*m+S*p*x-S*y*m-g*p*E-f*T*x,P=w*y+g*C+b*x-y*C-g*b-w*x,L=f*b+w*m+p*C-b*m-w*p-f*C,N=f*y*C+g*b*m+w*p*x-w*y*m-g*p*C-f*b*x;if(this.transformCmds[0]=A*D,this.transformCmds[1]=P*D,this.transformCmds[2]=R*D,this.transformCmds[3]=L*D,this.transformCmds[4]=I*D,this.transformCmds[5]=N*D,this.drawCmds[0]=l,this.drawCmds[1]=o.uv[0]*_,this.drawCmds[2]=o.uv[1]*d,this.drawCmds[3]=u,this.drawCmds[4]=c,this.drawCmds[5]=o.uv[0]*_,this.drawCmds[6]=o.uv[1]*d,this.drawCmds[7]=u,this.drawCmds[8]=c,r.save(),this.transform){var O=this.transform;r.transform(O.a,O.b,O.c,O.d,O.tx,O.ty)}r.transform.apply(r,this.transformCmds),r.drawImage.apply(r,this.drawCmds),r.restore()},i.renderByCache=function(t){var e=this.context;if(e.save(),this.transform){var i=this.transform;e.transform(i.a,i.b,i.c,i.d,i.tx,i.ty)}e.transform.apply(e,this.transformCmds),e.drawImage.apply(e,this.drawCmds),e.restore()},e}(et)),rt=function(t){function e(t,i){this._templet=null,this._player=null,this._curOriginalData=null,this._boneMatrixArray=[],this._lastTime=0,this._currAniName=null,this._currAniIndex=-1,this._pause=!0,this._aniClipIndex=-1,this._clipIndex=-1,this._skinIndex=0,this._skinName="default",this._aniMode=0,this._graphicsCache=null,this._boneSlotDic=null,this._bindBoneBoneSlotDic=null,this._boneSlotArray=null,this._index=-1,this._total=-1,this._indexControl=!1,this._aniPath=null,this._texturePath=null,this._complete=null,this._loadAniMode=0,this._yReverseMatrix=null,this._ikArr=null,this._tfArr=null,this._pathDic=null,this._rootBone=null,this._boneList=null,this._aniSectionDic=null,this._eventIndex=0,this._drawOrderIndex=0,this._drawOrder=null,this._lastAniClipIndex=-1,this._lastUpdateAniClipIndex=-1,e.__super.call(this),void 0===i&&(i=0),t&&this.init(t,i)}r(e,"laya.ani.bone.Skeleton",t);var n=e.prototype;return n.init=function(t,e){void 0===e&&(e=0);var i=0,n=0;if(1==e)for(this._graphicsCache=[],i=0,n=t.getAnimationCount();n>i;i++)this._graphicsCache.push([]);if(this._yReverseMatrix=t.yReverseMatrix,this._aniMode=e,this._templet=t,this._player=new J,this._player.cacheFrameRate=t.rate,this._player.templet=t,this._player.play(),this._parseSrcBoneMatrix(),this._boneList=t.mBoneArr,this._rootBone=t.mRootBone,this._aniSectionDic=t.aniSectionDic,t.ikArr.length>0)for(this._ikArr=[],i=0,n=t.ikArr.length;n>i;i++)this._ikArr.push(new U(t.ikArr[i],this._boneList));if(t.pathArr.length>0){var r,a;null==this._pathDic&&(this._pathDic={});var s;for(i=0,n=t.pathArr.length;n>i;i++)r=t.pathArr[i],a=new z(r,this._boneList),s=this._boneSlotDic[r.name],s&&(a=new z(r,this._boneList),a.target=s),this._pathDic[r.name]=a}if(t.tfArr.length>0)for(this._tfArr=[],i=0,n=t.tfArr.length;n>i;i++)this._tfArr.push(new X(t.tfArr[i],this._boneList));if(t.skinDataArray.length>0){var o=this._templet.skinDataArray[this._skinIndex];this._skinName=o.name}this._player.on("played",this,this._onPlay),this._player.on("stopped",this,this._onStop),this._player.on("paused",this,this._onPause)},n.load=function(t,e,n){void 0===n&&(n=0),this._aniPath=t,this._complete=e,this._loadAniMode=n,i.loader.load([{url:t,type:"arraybuffer"}],d.create(this,this._onLoaded))},n._onLoaded=function(){var t=f.getRes(this._aniPath);if(null!=t){null==at.TEMPLET_DICTIONARY&&(at.TEMPLET_DICTIONARY={});var e;e=at.TEMPLET_DICTIONARY[this._aniPath],e?e.isParseFail?this._parseFail():e.isParserComplete?this._parseComplete():(e.on("complete",this,this._parseComplete),e.on("error",this,this._parseFail)):(e=new at,e.url=this._aniPath,at.TEMPLET_DICTIONARY[this._aniPath]=e,e.on("complete",this,this._parseComplete),e.on("error",this,this._parseFail),e.isParserComplete=!1,e.parseData(null,t))}},n._parseComplete=function(){var t=at.TEMPLET_DICTIONARY[this._aniPath];t&&(this.init(t,this._loadAniMode),this.play(0,!0)),this._complete&&this._complete.runWith(this)},n._parseFail=function(){console.log("[Error]:"+this._aniPath+"解析失败")},n._onPlay=function(){this.event("played")},n._onStop=function(){var t,e=this._templet.eventAniArr,i=e[this._aniClipIndex];if(i&&this._eventIndex<i.length)for(;this._eventIndex<i.length;this._eventIndex++)t=i[this._eventIndex],t.time>=this._player.playStart&&t.time<=this._player.playEnd&&this.event("label",t);this._eventIndex=0,this._drawOrder=null,this.event("stopped")},n._onPause=function(){this.event("paused")},n._parseSrcBoneMatrix=function(){var t=0,e=0;for(e=this._templet.srcBoneMatrixArr.length,t=0;e>t;t++)this._boneMatrixArray.push(new m);if(0==this._aniMode)this._boneSlotDic=this._templet.boneSlotDic,this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic,this._boneSlotArray=this._templet.boneSlotArray;else{null==this._boneSlotDic&&(this._boneSlotDic={}),null==this._bindBoneBoneSlotDic&&(this._bindBoneBoneSlotDic={}),null==this._boneSlotArray&&(this._boneSlotArray=[]);var i,n,r=this._templet.boneSlotArray;for(t=0,e=r.length;e>t;t++)i=r[t],n=this._bindBoneBoneSlotDic[i.parent],null==n&&(this._bindBoneBoneSlotDic[i.parent]=n=[]),this._boneSlotDic[i.name]=i=i.copy(),n.push(i),this._boneSlotArray.push(i)}},n._emitMissedEvents=function(t,e,i){void 0===i&&(i=0);var n=this._templet.eventAniArr,r=n[this._player.currentAnimationClipIndex];if(r){var a,s=0,o=0;for(o=r.length,s=i;o>s;s++)a=r[s],a.time>=this._player.playStart&&a.time<=this._player.playEnd&&this.event("label",a)}},n._update=function(t){if(void 0===t&&(t=!0),!(this._pause||t&&this._indexControl)){var e=i.timer.currTimer,n=this._player.currentKeyframeIndex,r=e-this._lastTime;if(t?this._player._update(r):n=-1,this._lastTime=e,this._player&&(this._index=this._clipIndex=this._player.currentKeyframeIndex,!(this._index<0||r>0&&this._clipIndex==n&&this._lastUpdateAniClipIndex==this._aniClipIndex))){this._lastUpdateAniClipIndex=this._aniClipIndex,n>this._clipIndex&&0!=this._eventIndex&&(this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex),this._eventIndex=0);var a,s=this._templet.eventAniArr,o=s[this._aniClipIndex];o&&this._eventIndex<o.length&&(a=o[this._eventIndex],a.time>=this._player.playStart&&a.time<=this._player.playEnd?this._player.currentPlayTime>=a.time&&(this.event("label",a),this._eventIndex++):this._eventIndex++);var h;if(0==this._aniMode){if(h=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex))return void(this.graphics!=h&&(this.graphics=h));var l=0,u=0;for(u=this._clipIndex;!this._templet.getGrahicsDataWithCache(this._aniClipIndex,u-1)&&u>0;)u--;if(u<this._clipIndex)for(l=u;l<this._clipIndex;l++)this._createGraphics(l)}else if(1==this._aniMode){if(h=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex))return void(this.graphics!=h&&(this.graphics=h));for(u=this._clipIndex;!this._getGrahicsDataWithCache(this._aniClipIndex,u-1)&&u>0;)u--;if(u<this._clipIndex)for(l=u;l<this._clipIndex;l++)this._createGraphics(l)}this._createGraphics()}}},n._createGraphics=function(t){void 0===t&&(t=-1),-1==t&&(t=this._clipIndex);var e,i=t*this._player.cacheFrameRateInterval,n=this._templet.drawOrderAniArr,r=n[this._aniClipIndex];if(r&&r.length>0)for(this._drawOrderIndex=0,e=r[this._drawOrderIndex];i>=e.time&&(this._drawOrder=e.drawOrder,this._drawOrderIndex++,!(this._drawOrderIndex>=r.length));)e=r[this._drawOrderIndex];var a;0==this._aniMode||1==this._aniMode?this.graphics=new tt:this.graphics instanceof laya.ani.GraphicsAni?this.graphics.clear():this.graphics=new tt,a=this.graphics;var s=this._templet.getNodes(this._aniClipIndex);this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,this._player._fullFrames[this._aniClipIndex],t,i);var o,h,u,c,_=this._aniSectionDic[this._aniClipIndex],d=0,f=0,p=0,g=0,y=0,x=this._templet.srcBoneMatrixArr.length;for(f=0,y=_[0];x>f;f++)c=this._boneList[f],u=this._templet.srcBoneMatrixArr[f],c.resultTransform.scX=u.scX*this._curOriginalData[d++],c.resultTransform.skX=u.skX+this._curOriginalData[d++],c.resultTransform.skY=u.skY+this._curOriginalData[d++],c.resultTransform.scY=u.scY*this._curOriginalData[d++],c.resultTransform.x=u.x+this._curOriginalData[d++],c.resultTransform.y=u.y+this._curOriginalData[d++],8===this._templet.tMatrixDataLen&&(c.resultTransform.skewX=u.skewX+this._curOriginalData[d++],c.resultTransform.skewY=u.skewY+this._curOriginalData[d++]);var v,S={},T={};for(y+=_[1];y>f;f++)v=s[f],S[v.name]=this._curOriginalData[d++],T[v.name]=this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++];var E={},w={};for(y+=_[2];y>f;f++)v=s[f],E[v.name]=this._curOriginalData[d++],w[v.name]=this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++];if(this._pathDic){var b;for(y+=_[3];y>f;f++)if(v=s[f],b=this._pathDic[v.name]){var C=new l(v.extenData);switch(C.getByte()){case 1:b.position=this._curOriginalData[d++];break;case 2:b.spacing=this._curOriginalData[d++];break;case 3:b.rotateMix=this._curOriginalData[d++],b.translateMix=this._curOriginalData[d++]}}}if(this._yReverseMatrix?this._rootBone.update(this._yReverseMatrix):this._rootBone.update(m.TEMP.identity()),this._ikArr){var M;for(f=0,y=this._ikArr.length;y>f;f++)M=this._ikArr[f],E.hasOwnProperty(M.name)&&(M.bendDirection=E[M.name]),w.hasOwnProperty(M.name)&&(M.mix=w[M.name]),M.apply()}if(this._pathDic)for(var D in this._pathDic)b=this._pathDic[D],b.apply(this._boneList,a);if(this._tfArr){var A;for(f=0,g=this._tfArr.length;g>f;f++)A=this._tfArr[f],A.apply()}for(f=0,g=this._boneList.length;g>f;f++)if(c=this._boneList[f],h=this._bindBoneBoneSlotDic[c.name],c.resultMatrix.copyTo(this._boneMatrixArray[f]),h)for(p=0,y=h.length;y>p;p++)o=h[p],o&&o.setParentMatrix(c.resultMatrix);var R,I={},P=this._templet.deformAniArr;if(P&&P.length>0){if(this._lastAniClipIndex!=this._aniClipIndex)for(this._lastAniClipIndex=this._aniClipIndex,f=0,y=this._boneSlotArray.length;y>f;f++)o=this._boneSlotArray[f],o.deformData=null;var L=P[this._aniClipIndex];R=L["default"],this._setDeform(R,I,this._boneSlotArray,i);var N;for(N in L)"default"!=N&&N!=this._skinName&&(R=L[N],this._setDeform(R,I,this._boneSlotArray,i));R=L[this._skinName],this._setDeform(R,I,this._boneSlotArray,i)}var O,V,F;if(this._drawOrder)for(f=0,y=this._drawOrder.length;y>f;f++)o=this._boneSlotArray[this._drawOrder[f]],O=S[o.name],V=T[o.name],isNaN(V)||(a.save(),a.alpha(V)),isNaN(O)||-2==O||(this._templet.attachmentNames?o.showDisplayByName(this._templet.attachmentNames[O]):o.showDisplayByIndex(O)),I[this._drawOrder[f]]?(F=I[this._drawOrder[f]],o.currDisplayData&&F[o.currDisplayData.attachmentName]?o.deformData=F[o.currDisplayData.attachmentName]:o.deformData=null):o.deformData=null,isNaN(V)?o.draw(a,this._boneMatrixArray,2==this._aniMode):o.draw(a,this._boneMatrixArray,2==this._aniMode,V),isNaN(V)||a.restore();else for(f=0,y=this._boneSlotArray.length;y>f;f++)o=this._boneSlotArray[f],O=S[o.name],V=T[o.name],isNaN(V)||(a.save(),a.alpha(V)),isNaN(O)||-2==O||(this._templet.attachmentNames?o.showDisplayByName(this._templet.attachmentNames[O]):o.showDisplayByIndex(O)),I[f]?(F=I[f],o.currDisplayData&&F[o.currDisplayData.attachmentName]?o.deformData=F[o.currDisplayData.attachmentName]:o.deformData=null):o.deformData=null,isNaN(V)?o.draw(a,this._boneMatrixArray,2==this._aniMode):o.draw(a,this._boneMatrixArray,2==this._aniMode,V),isNaN(V)||a.restore();0==this._aniMode?this._templet.setGrahicsDataWithCache(this._aniClipIndex,t,a):1==this._aniMode&&this._setGrahicsDataWithCache(this._aniClipIndex,t,a)},n._setDeform=function(t,e,i,n){if(t){var r,a,s,o=0,h=0,l=0;if(t)for(o=0,h=t.deformSlotDataList.length;h>o;o++)for(r=t.deformSlotDataList[o],l=0;l<r.deformSlotDisplayList.length;l++)a=r.deformSlotDisplayList[l],
s=i[a.slotIndex],a.apply(n,s),e[a.slotIndex]||(e[a.slotIndex]={}),e[a.slotIndex][a.attachment]=a.deformData}},n.getAnimNum=function(){return this._templet.getAnimationCount()},n.getAniNameByIndex=function(t){return this._templet.getAniNameByIndex(t)},n.getSlotByName=function(t){return this._boneSlotDic[t]},n.showSkinByName=function(t,e){void 0===e&&(e=!0),this.showSkinByIndex(this._templet.getSkinIndexByName(t),e)},n.showSkinByIndex=function(t,e){void 0===e&&(e=!0);for(var i=0;i<this._boneSlotArray.length;i++)this._boneSlotArray[i].showSlotData(null,e);if(this._templet.showSkinByIndex(this._boneSlotDic,t,e)){var n=this._templet.skinDataArray[t];this._skinIndex=t,this._skinName=n.name}this._clearCache()},n.showSlotSkinByIndex=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByIndex(e),this._clearCache()}},n.showSlotSkinByName=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByName(e),this._clearCache()}},n.replaceSlotSkinName=function(t,e,i){if(0!=this._aniMode){var n=this.getSlotByName(t);n&&n.replaceDisplayByName(e,i),this._clearCache()}},n.replaceSlotSkinByIndex=function(t,e,i){if(0!=this._aniMode){var n=this.getSlotByName(t);n&&n.replaceDisplayByIndex(e,i),this._clearCache()}},n.setSlotSkin=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.replaceSkin(e),this._clearCache()}},n._clearCache=function(){if(1==this._aniMode)for(var t=0,e=this._graphicsCache.length;e>t;t++)this._graphicsCache[t].length=0},n.play=function(t,e,n,r,a,s){void 0===n&&(n=!0),void 0===r&&(r=0),void 0===a&&(a=0),void 0===s&&(s=!0),this._indexControl=!1;var o=-1,l=NaN;if(l=e?2147483647:0,"string"==typeof t)for(var u=0,c=this._templet.getAnimationCount();c>u;u++){var _=this._templet.getAnimation(u);if(_&&t==_.name){o=u;break}}else o=t;o>-1&&o<this.getAnimNum()&&(this._aniClipIndex=o,(n||this._pause||this._currAniIndex!=o)&&(this._currAniIndex=o,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(o)),this._drawOrder=null,this._eventIndex=0,this._player.play(o,this._player.playbackRate,l,r,a),s&&this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex),this._pause&&(this._pause=!1,this._lastTime=h.now(),i.stage.frameLoop(1,this,this._update,null,!0)),this._update()))},n.stop=function(){this._pause||(this._pause=!0,this._player&&this._player.stop(!0),i.timer.clear(this,this._update))},n.playbackRate=function(t){this._player&&(this._player.playbackRate=t)},n.paused=function(){this._pause||(this._pause=!0,this._player&&(this._player.paused=!0),i.timer.clear(this,this._update))},n.resume=function(){this._indexControl=!1,this._pause&&(this._pause=!1,this._player&&(this._player.paused=!1),this._lastTime=h.now(),i.stage.frameLoop(1,this,this._update,null,!0))},n._getGrahicsDataWithCache=function(t,e){return this._graphicsCache[t][e]},n._setGrahicsDataWithCache=function(t,e,i){this._graphicsCache[t][e]=i},n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._templet=null,this._player&&this._player.offAll(),this._player=null,this._curOriginalData=null,this._boneMatrixArray.length=0,this._lastTime=0,i.timer.clear(this,this._update)},a(0,n,"url",function(){return this._aniPath},function(t){this.load(t)}),a(0,n,"index",function(){return this._index},function(t){this.player&&(this._index=t,this._player.currentTime=1e3*this._index/this._player.cacheFrameRate,this._indexControl=!0,this._update(!1))}),a(0,n,"total",function(){return this._templet&&this._player?this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1e3*this._player.cacheFrameRate):this._total=-1,this._total}),a(0,n,"player",function(){return this._player}),e.useSimpleMeshInCanvas=!1,e}(S),at=(function(t){function e(t){this._start=0,this._Pos=0,this._data=null,this._curIndex=0,this._preIndex=0,this._playIndex=0,this._playing=!1,this._ended=!0,this._count=0,this._ids=null,this._loadedImage={},this._idOfSprite=null,this._parentMovieClip=null,this._movieClipList=null,this._labels=null,this.basePath=null,this._atlasPath=null,this._url=null,this._isRoot=!1,this._completeHandler=null,this._endFrame=-1,this.interval=30,this.loop=!1,e.__super.call(this),this._ids={},this._idOfSprite=[],this._reset(),this._playing=!1,this._parentMovieClip=t,t?(this._isRoot=!1,this._movieClipList=t._movieClipList,this._movieClipList.push(this)):(this._movieClipList=[this],this._isRoot=!0,this._setUpNoticeType(1))}r(e,"laya.ani.swf.MovieClip",t);var n=e.prototype;return n.destroy=function(e){void 0===e&&(e=!0),this._clear(),t.prototype.destroy.call(this,e)},n._setDisplay=function(e){t.prototype._setDisplay.call(this,e),this._isRoot&&this._$3__onDisplay(e)},n._$3__onDisplay=function(t){t?i.timer.loop(this.interval,this,this.updates,null,!0):i.timer.clear(this,this.updates)},n.updates=function(){if(!this._parentMovieClip){var t=0,e=0;for(e=this._movieClipList.length,t=0;e>t;t++)this._movieClipList[t]&&this._movieClipList[t]._update()}},n.addLabel=function(t,e){this._labels||(this._labels={}),this._labels[e]=t},n.removeLabel=function(t){if(t){if(!this._labels)for(var e in this._labels)if(this._labels[e]===t){delete this._labels[e];break}}else this._labels=null},n._update=function(){if(this._data&&this._playing){if(this._playIndex++,this._playIndex>=this._count){if(!this.loop)return this._playIndex--,void this.stop();this._playIndex=0}if(this._parse(this._playIndex),this._labels&&this._labels[this._playIndex]&&this.event("label",this._labels[this._playIndex]),-1!=this._endFrame&&this._endFrame==this._playIndex){if(this._endFrame=-1,null!=this._completeHandler){var t=this._completeHandler;this._completeHandler=null,t.run()}this.stop()}}},n.stop=function(){this._playing=!1},n.gotoAndStop=function(t){this.index=t,this.stop()},n._clear=function(){if(this.stop(),this._idOfSprite.length=0,!this._parentMovieClip){i.timer.clear(this,this.updates);var t=0,e=0;for(e=this._movieClipList.length,t=0;e>t;t++)this._movieClipList[t]!=this&&this._movieClipList[t]._clear();this._movieClipList.length=0}this._atlasPath&&f.clearRes(this._atlasPath);var n;for(n in this._loadedImage)this._loadedImage[n]&&(f.clearRes(n),this._loadedImage[n]=!1);this.removeChildren(),this.graphics=null,this._parentMovieClip=null},n.play=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0),this.loop=e,this._playing=!0,this._data&&this._displayFrame(t)},n._displayFrame=function(t){void 0===t&&(t=-1),-1!=t&&(this._curIndex>t&&this._reset(),this._parse(t))},n._reset=function(t){void 0===t&&(t=!0),t&&1!=this._curIndex&&this.removeChildren(),this._preIndex=this._curIndex=-1,this._Pos=this._start},n._parse=function(t){var i,n,r,a=0,s=0,o=0,h=0,l=!1,u=this._idOfSprite,c=this._data;for(this._ended&&this._reset(),c.pos=this._Pos,this._ended=!1,this._playIndex=t,this._curIndex>t&&t<this._preIndex&&(this._reset(!0),c.pos=this._Pos);this._curIndex<=t&&!this._ended;)switch(s=c.getUint16()){case 12:if(a=c.getUint16(),o=this._ids[c.getUint16()],this._Pos=c.pos,c.pos=o,0==(h=c.getUint8())){var _=c.getUint16();if(n=u[a],!n){n=u[a]=new S;var d=new S;d.loadImage(this.basePath+_+".png"),this._loadedImage[this.basePath+_+".png"]=!0,n.addChild(d),d.size(c.getFloat32(),c.getFloat32());var f=c._getMatrix();d.transform=f}n.alpha=1}else 1==h&&(i=u[a],i||(u[a]=i=new e(this),i.interval=this.interval,i._ids=this._ids,i.basePath=this.basePath,i._setData(c,o),i._initState(),i.play(0)),i.alpha=1);c.pos=this._Pos;break;case 3:var p=u[c.getUint16()];p&&(this.addChild(p),p.zOrder=c.getUint16(),l=!0);break;case 4:p=u[c.getUint16()],p&&p.removeSelf();break;case 5:u[c.getUint16()][e._ValueList[c.getUint16()]]=c.getFloat32();break;case 6:u[c.getUint16()].visible=c.getUint8()>0;break;case 7:n=u[c.getUint16()];var g=n.transform||m.create();g.setTo(c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32(),c.getFloat32()),n.transform=g;break;case 8:u[c.getUint16()].setPos(c.getFloat32(),c.getFloat32());break;case 9:u[c.getUint16()].setSize(c.getFloat32(),c.getFloat32());break;case 10:u[c.getUint16()].alpha=c.getFloat32();break;case 11:u[c.getUint16()].setScale(c.getFloat32(),c.getFloat32());break;case 98:r=c.getString(),this.event(r),"stop"==r&&this.stop();break;case 99:this._curIndex=c.getUint16(),l&&this.updateZOrder();break;case 100:this._count=this._curIndex+1,this._ended=!0,this._playing&&(this.event("enterframe"),this.event("end"),this.event("complete")),this._reset(!1)}this._playing&&!this._ended&&this.event("enterframe"),this._Pos=c.pos},n._setData=function(t,e){this._data=t,this._start=e+3},n.load=function(t,e,n){void 0===e&&(e=!1),this._url=t=w.formatURL(t),e&&(this._atlasPath=n?n:t.split(".swf")[0]+".json"),this.stop(),this._clear(),this._movieClipList=[this];var r;r=[{url:t,type:"arraybuffer"}],this._atlasPath&&r.push({url:this._atlasPath,type:"atlas"}),i.loader.load(r,d.create(this,this._onLoaded))},n._onLoaded=function(){var t;return(t=f.getRes(this._url))?(this.basePath=this._atlasPath?f.getAtlas(this._atlasPath).dir:this._url.split(".swf")[0]+"/image/",void this._initData(t)):void this.event("error","file not find")},n._initState=function(){this._reset(),this._ended=!1;var t=this._playing;for(this._playing=!1,this._curIndex=0;!this._ended;)this._parse(++this._curIndex);this._playing=t},n._initData=function(t){this._data=new l(t);var e=0,n=this._data.getUint16();for(e=0;n>e;e++)this._ids[this._data.getInt16()]=this._data.getInt32();this.interval=1e3/this._data.getUint16(),this._setData(this._data,this._ids[32767]),this._initState(),this.play(0),this.event("loaded"),this._parentMovieClip||i.timer.loop(this.interval,this,this.updates,null,!0)},n.playTo=function(t,e,i){this._completeHandler=i,this._endFrame=e,this.play(t,!1)},a(0,n,"index",function(){return this._playIndex},function(t){this._playIndex=t,this._data&&this._displayFrame(this._playIndex),this._labels&&this._labels[t]&&this.event("label",this._labels[t])}),a(0,n,"count",function(){return this._count}),a(0,n,"playing",function(){return this._playing}),a(0,n,"url",null,function(t){this.load(t)}),e._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"],e}(S),function(t){function e(){this._mainTexture=null,this._textureJson=null,this._graphicsCache=[],this.srcBoneMatrixArr=[],this.ikArr=[],this.tfArr=[],this.pathArr=[],this.boneSlotDic={},this.bindBoneBoneSlotDic={},this.boneSlotArray=[],this.skinDataArray=[],this.skinDic={},this.subTextureDic={},this.isParseFail=!1,this.yReverseMatrix=null,this.drawOrderAniArr=[],this.eventAniArr=[],this.attachmentNames=null,this.deformAniArr=[],this._isDestroyed=!1,this._rate=30,this.isParserComplete=!1,this.aniSectionDic={},this._skBufferUrl=null,this._textureDic={},this._loadList=null,this._path=null,this.tMatrixDataLen=0,this.mRootBone=null,e.__super.call(this),this.skinSlotDisplayDataArr=[],this.mBoneArr=[]}r(e,"laya.ani.bone.Templet",t);var n=e.prototype;return n.loadAni=function(t){this._skBufferUrl=t,i.loader.load(t,d.create(this,this.onComplete),null,"arraybuffer")},n.onComplete=function(t){if(this._isDestroyed)return void this.destroy();var e=f.getRes(this._skBufferUrl);return e?(this._path=this._skBufferUrl.slice(0,this._skBufferUrl.lastIndexOf("/"))+"/",void this.parseData(null,e)):void this.event("error","load failed:"+this._skBufferUrl)},n.parseData=function(t,e,i){void 0===i&&(i=30),!this._path&&this.url&&(this._path=this.url.slice(0,this.url.lastIndexOf("/"))+"/"),this._mainTexture=t,this._mainTexture&&y.isWebGL&&t.bitmap&&(t.bitmap.enableMerageInAtlas=!1),this._rate=i,this.parse(e)},n.buildArmature=function(t){return void 0===t&&(t=0),new rt(this,t)},n.parse=function(i){t.prototype.parse.call(this,i),this._endLoaded(),this._aniVersion!=e.LAYA_ANIMATION_VISION&&(console.log("[Error] 版本不一致，请使用IDE版本配套的重新导出"+this._aniVersion+"->"+e.LAYA_ANIMATION_VISION),this._loaded=!1),this.loaded?this._mainTexture?this._parsePublicExtData():this._parseTexturePath():(this.event("error",this),this.isParseFail=!0)},n._parseTexturePath=function(){if(this._isDestroyed)return void this.destroy();var t=0;this._loadList=[];var e,n=new l(this.getPublicExtData()),r=0,a=0,s=0,o=0,h=0,u=0,c=0,_=0,f=0,p=n.getInt32(),m=n.readUTFString(),g=m.split("\n");for(t=0;p>t;t++)e=this._path+g[2*t],m=g[2*t+1],r=n.getFloat32(),a=n.getFloat32(),s=n.getFloat32(),o=n.getFloat32(),f=n.getFloat32(),h=isNaN(f)?0:f,f=n.getFloat32(),u=isNaN(f)?0:f,f=n.getFloat32(),c=isNaN(f)?s:f,f=n.getFloat32(),_=isNaN(f)?o:f,-1==this._loadList.indexOf(e)&&this._loadList.push(e);i.loader.load(this._loadList,d.create(this,this._textureComplete))},n._textureComplete=function(){for(var t,e,i=0,n=this._loadList.length;n>i;i++)e=this._loadList[i],t=this._textureDic[e]=f.getRes(e),y.isWebGL&&t&&t.bitmap&&(t.bitmap.enableMerageInAtlas=!1);this._parsePublicExtData()},n._parsePublicExtData=function(){var t=0,e=0,i=0,n=0,r=0;for(t=0,r=this.getAnimationCount();r>t;t++)this._graphicsCache.push([]);var a=!1;a="Dragon"!=this._aniClassName;var s,o,h=new l(this.getPublicExtData()),u=0,c=0,_=0,d=0,f=0,p=0,g=0,y=0,x=0,v=h.getInt32(),S=h.readUTFString(),T=S.split("\n");for(t=0;v>t;t++){if(s=this._mainTexture,o=this._path+T[2*t],S=T[2*t+1],null==this._mainTexture&&(s=this._textureDic[o]),!s)return this.event("error",this),void(this.isParseFail=!0);u=h.getFloat32(),c=h.getFloat32(),_=h.getFloat32(),d=h.getFloat32(),x=h.getFloat32(),f=isNaN(x)?0:x,x=h.getFloat32(),p=isNaN(x)?0:x,x=h.getFloat32(),g=isNaN(x)?_:x,x=h.getFloat32(),y=isNaN(x)?d:x,this.subTextureDic[S]=E.create(s,u,c,_,d,-f,-p,g,y)}this._mainTexture=s;var w,b=h.getUint16();for(t=0;b>t;t++)w=[],w.push(h.getUint16()),w.push(h.getUint16()),w.push(h.getUint16()),w.push(h.getUint16()),this.aniSectionDic[t]=w;var C,M,D,A,P,L=h.getInt16(),U={};for(t=0;L>t;t++)C=new R,0==t?P=C:C.root=P,C.d=a?-1:1,D=h.readUTFString(),A=h.readUTFString(),C.length=h.getFloat32(),1==h.getByte()&&(C.inheritRotation=!1),1==h.getByte()&&(C.inheritScale=!1),C.name=D,A&&(M=U[A],M?M.addChild(C):this.mRootBone=C),U[D]=C,this.mBoneArr.push(C);this.tMatrixDataLen=h.getUint16();var H,z=h.getUint16(),X=Math.floor(z/this.tMatrixDataLen),Z=this.srcBoneMatrixArr;for(t=0;X>t;t++)H=new K,H.scX=h.getFloat32(),H.skX=h.getFloat32(),H.skY=h.getFloat32(),H.scY=h.getFloat32(),H.x=h.getFloat32(),H.y=h.getFloat32(),8===this.tMatrixDataLen&&(H.skewX=h.getFloat32(),H.skewY=h.getFloat32()),Z.push(H),C=this.mBoneArr[t],C.transform=H;var $,Q=h.getUint16(),J=0;for(t=0;Q>t;t++){for($=new k,J=h.getUint16(),e=0;J>e;e++)$.boneNames.push(h.readUTFString()),$.boneIndexs.push(h.getInt16());$.name=h.readUTFString(),$.targetBoneName=h.readUTFString(),$.targetBoneIndex=h.getInt16(),$.bendDirection=h.getFloat32(),$.mix=h.getFloat32(),$.isSpine=a,this.ikArr.push($)}var tt,et=h.getUint16(),it=0;for(t=0;et>t;t++){for(tt=new q,it=h.getUint16(),e=0;it>e;e++)tt.boneIndexs.push(h.getInt16());tt.name=h.getUTFString(),tt.targetIndex=h.getInt16(),tt.rotateMix=h.getFloat32(),tt.translateMix=h.getFloat32(),tt.scaleMix=h.getFloat32(),tt.shearMix=h.getFloat32(),tt.offsetRotation=h.getFloat32(),tt.offsetX=h.getFloat32(),tt.offsetY=h.getFloat32(),tt.offsetScaleX=h.getFloat32(),tt.offsetScaleY=h.getFloat32(),tt.offsetShearY=h.getFloat32(),this.tfArr.push(tt)}var nt,rt=h.getUint16(),at=0;for(t=0;rt>t;t++){for(nt=new W,nt.name=h.readUTFString(),at=h.getUint16(),e=0;at>e;e++)nt.bones.push(h.getInt16());nt.target=h.readUTFString(),nt.positionMode=h.readUTFString(),nt.spacingMode=h.readUTFString(),nt.rotateMode=h.readUTFString(),nt.offsetRotation=h.getFloat32(),nt.position=h.getFloat32(),nt.spacing=h.getFloat32(),nt.rotateMix=h.getFloat32(),nt.translateMix=h.getFloat32(),this.pathArr.push(nt)}var st,ot,ht,lt,ut,ct=0,_t=0,dt=0,ft=0,pt=NaN,mt=0,gt=h.getInt16();for(t=0;gt>t;t++){var yt=h.getUint8(),xt={};this.deformAniArr.push(xt);for(var vt=0;yt>vt;vt++)for(ot=new N,ot.skinName=h.getUTFString(),xt[ot.skinName]=ot,ct=h.getInt16(),e=0;ct>e;e++)for(ht=new O,ot.deformSlotDataList.push(ht),_t=h.getInt16(),i=0;_t>i;i++)for(lt=new V,ht.deformSlotDisplayList.push(lt),lt.slotIndex=dt=h.getInt16(),lt.attachment=st=h.getUTFString(),ft=h.getInt16(),n=0;ft>n;n++)for(1==h.getByte()?lt.tweenKeyList.push(!0):lt.tweenKeyList.push(!1),pt=h.getFloat32(),lt.timeList.push(pt),ut=[],lt.vectices.push(ut),mt=h.getInt16(),r=0;mt>r;r++)ut.push(h.getFloat32())}var St,Tt,Et=h.getInt16(),wt=0,bt=0;for(t=0;Et>t;t++){for(wt=h.getInt16(),St=[],e=0;wt>e;e++){for(Tt=new F,Tt.time=h.getFloat32(),bt=h.getInt16(),i=0;bt>i;i++)Tt.drawOrder.push(h.getInt16());St.push(Tt)}this.drawOrderAniArr.push(St)}var Ct,Mt,Dt=h.getInt16(),At=0;for(t=0;Dt>t;t++){for(At=h.getInt16(),Ct=[],e=0;At>e;e++)Mt=new B,Mt.name=h.getUTFString(),Mt.intValue=h.getInt32(),Mt.floatValue=h.getFloat32(),Mt.stringValue=h.getUTFString(),Mt.time=h.getFloat32(),Ct.push(Mt);this.eventAniArr.push(Ct)}var Rt=h.getInt16();if(Rt>0)for(this.attachmentNames=[],t=0;Rt>t;t++)this.attachmentNames.push(h.getUTFString());var It,Pt,Lt=h.getInt16();for(t=0;Lt>t;t++)It=new I,It.name=h.readUTFString(),It.parent=h.readUTFString(),It.attachmentName=h.readUTFString(),It.srcDisplayIndex=It.displayIndex=h.getInt16(),It.templet=this,this.boneSlotDic[It.name]=It,Pt=this.bindBoneBoneSlotDic[It.parent],null==Pt&&(this.bindBoneBoneSlotDic[It.parent]=Pt=[]),Pt.push(It),this.boneSlotArray.push(It);var Nt,Ot,Vt,Ft=h.readUTFString(),Bt=Ft.split("\n"),Ut=0,kt=h.getUint8(),Ht=0,zt=0,Wt=0,Gt=0,jt=0,Yt=0,Xt=0;for(t=0;kt>t;t++){for(Nt=new G,Nt.name=Bt[Ut++],Ht=h.getUint8(),e=0;Ht>e;e++){for(Ot=new Y,Ot.name=Bt[Ut++],It=this.boneSlotDic[Ot.name],zt=h.getUint8(),i=0;zt>i;i++){if(Vt=new j,this.skinSlotDisplayDataArr.push(Vt),Vt.name=Bt[Ut++],Vt.attachmentName=Bt[Ut++],Vt.transform=new K,Vt.transform.scX=h.getFloat32(),Vt.transform.skX=h.getFloat32(),Vt.transform.skY=h.getFloat32(),Vt.transform.scY=h.getFloat32(),Vt.transform.x=h.getFloat32(),Vt.transform.y=h.getFloat32(),Ot.displayArr.push(Vt),Vt.width=h.getFloat32(),Vt.height=h.getFloat32(),Vt.type=h.getUint8(),Vt.verLen=h.getUint16(),L=h.getUint16(),L>0)for(Vt.bones=[],n=0;L>n;n++){var qt=h.getUint16();Vt.bones.push(qt)}if(Wt=h.getUint16(),Wt>0)for(Vt.uvs=[],n=0;Wt>n;n++)Vt.uvs.push(h.getFloat32());if(Gt=h.getUint16(),Gt>0)for(Vt.weights=[],n=0;Gt>n;n++)Vt.weights.push(h.getFloat32());if(jt=h.getUint16(),jt>0)for(Vt.triangles=[],n=0;jt>n;n++)Vt.triangles.push(h.getUint16());if(Yt=h.getUint16(),Yt>0)for(Vt.vertices=[],n=0;Yt>n;n++)Vt.vertices.push(h.getFloat32());if(Xt=h.getUint16(),Xt>0)for(Vt.lengths=[],n=0;Xt>n;n++)Vt.lengths.push(h.getFloat32())}Nt.slotArr.push(Ot)}this.skinDic[Nt.name]=Nt,this.skinDataArray.push(Nt)}var Kt=h.getUint8();1==Kt?(this.yReverseMatrix=new m(1,0,0,-1,0,0),P&&P.setTempMatrix(this.yReverseMatrix)):P&&P.setTempMatrix(new m),this.showSkinByIndex(this.boneSlotDic,0),this.isParserComplete=!0,this.event("complete",this)},n.getTexture=function(t){var e=this.subTextureDic[t];return null==e?this._mainTexture:e},n.showSkinByIndex=function(t,e,i){if(void 0===i&&(i=!0),0>e&&e>=this.skinDataArray.length)return!1;var n,r,a=0,s=0,o=this.skinDataArray[e];if(o){for(a=0,s=o.slotArr.length;s>a;a++)r=o.slotArr[a],r&&(n=t[r.name],n&&(n.showSlotData(r,i),i&&"undefined"!=n.attachmentName&&"null"!=n.attachmentName?n.showDisplayByName(n.attachmentName):n.showDisplayByIndex(n.displayIndex)));return!0}return!1},n.getSkinIndexByName=function(t){for(var e,i=0,n=this.skinDataArray.length;n>i;i++)if(e=this.skinDataArray[i],e.name==t)return i;return-1},n.getGrahicsDataWithCache=function(t,e){return this._graphicsCache[t][e]},n.setGrahicsDataWithCache=function(t,e,i){this._graphicsCache[t][e]=i},n.destroy=function(){this._isDestroyed=!0;var t;for(var i in this.subTextureDic)t=this.subTextureDic[i],t&&t.destroy();var i;for(i in this._textureDic)t=this._textureDic[i],t&&t.destroy();for(var n,r=0,a=this.skinSlotDisplayDataArr.length;a>r;r++)n=this.skinSlotDisplayDataArr[r],n.destory();this.skinSlotDisplayDataArr.length=0,this.url&&delete e.TEMPLET_DICTIONARY[this.url],this.dispose()},n.getAniNameByIndex=function(t){var e=this.getAnimation(t);return e?e.name:null},a(0,n,"rate",function(){return this._rate},function(t){this._rate=t}),e.LAYA_ANIMATION_VISION="LAYAANIMATION:1.6.0",e.TEMPLET_DICTIONARY=null,e}(it))}(window,document,Laya)}).call(window)},function(t,e,i){(function(){!function(t,e,i){var n=(i.un,i.uns,i["static"]),r=i["class"],a=i.getset,s=(i.__newvec,laya.webgl.canvas.BlendMode),o=(laya.events.Event,laya.resource.HTMLCanvas),h=laya.utils.Handler,l=laya.webgl.utils.IndexBuffer2D,u=(laya.net.Loader,laya.maths.MathUtil),c=laya.maths.Matrix,_=laya.renders.Render,d=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.shader.Shader),f=laya.display.Sprite,p=laya.utils.Stat,m=laya.resource.Texture,g=laya.utils.Utils,y=laya.webgl.shader.d2.value.Value2D,x=laya.webgl.utils.VertexBuffer2D,v=laya.webgl.WebGL,S=(laya.webgl.WebGLContext,function(){function t(){this._frameTime=0,this._emissionRate=60,this._emissionTime=0,this.minEmissionTime=1/60,this._particleTemplate=null}r(t,"laya.particle.emitter.EmitterBase");var e=t.prototype;return e.start=function(t){void 0===t&&(t=Number.MAX_VALUE),0!=this._emissionRate&&(this._emissionTime=t)},e.stop=function(){this._emissionTime=0},e.clear=function(){this._emissionTime=0},e.emit=function(){},e.advanceTime=function(t){if(void 0===t&&(t=1),this._emissionTime-=t,!(this._emissionTime<0||(this._frameTime+=t,this._frameTime<this.minEmissionTime)))for(;this._frameTime>this.minEmissionTime;)this._frameTime-=this.minEmissionTime,this.emit()},a(0,e,"particleTemplate",null,function(t){this._particleTemplate=t}),a(0,e,"emissionRate",function(){return this._emissionRate},function(t){0>=t||(this._emissionRate=t,t>0&&(this.minEmissionTime=1/t))}),t}()),T=function(){function t(){this.position=null,this.velocity=null,this.startColor=null,this.endColor=null,this.sizeRotation=null,this.radius=null,this.radian=null,this.durationAddScale=NaN,this.time=NaN}return r(t,"laya.particle.ParticleData"),t.Create=function(e,i,n,r){var a=new t;a.position=i,u.scaleVector3(n,e.emitterVelocitySensitivity,t._tempVelocity);var s=u.lerp(e.minHorizontalVelocity,e.maxHorizontalVelocity,Math.random()),o=Math.random()*Math.PI*2;t._tempVelocity[0]+=s*Math.cos(o),t._tempVelocity[2]+=s*Math.sin(o),t._tempVelocity[1]+=u.lerp(e.minVerticalVelocity,e.maxVerticalVelocity,Math.random()),a.velocity=t._tempVelocity,a.startColor=t._tempStartColor,a.endColor=t._tempEndColor;var h=0;if(e.disableColor)for(h=0;4>h;h++)a.startColor[h]=1,a.endColor[h]=1;else if(e.colorComponentInter)for(h=0;4>h;h++)a.startColor[h]=u.lerp(e.minStartColor[h],e.maxStartColor[h],Math.random()),a.endColor[h]=u.lerp(e.minEndColor[h],e.maxEndColor[h],Math.random());else u.lerpVector4(e.minStartColor,e.maxStartColor,Math.random(),a.startColor),u.lerpVector4(e.minEndColor,e.maxEndColor,Math.random(),a.endColor);a.sizeRotation=t._tempSizeRotation;var l=Math.random();a.sizeRotation[0]=u.lerp(e.minStartSize,e.maxStartSize,l),a.sizeRotation[1]=u.lerp(e.minEndSize,e.maxEndSize,l),a.sizeRotation[2]=u.lerp(e.minRotateSpeed,e.maxRotateSpeed,Math.random()),a.radius=t._tempRadius;var c=Math.random();a.radius[0]=u.lerp(e.minStartRadius,e.maxStartRadius,c),a.radius[1]=u.lerp(e.minEndRadius,e.maxEndRadius,c),a.radian=t._tempRadian,a.radian[0]=u.lerp(e.minHorizontalStartRadian,e.maxHorizontalStartRadian,Math.random()),a.radian[1]=u.lerp(e.minVerticalStartRadian,e.maxVerticalStartRadian,Math.random());var _=e.useEndRadian;return a.radian[2]=_?u.lerp(e.minHorizontalEndRadian,e.maxHorizontalEndRadian,Math.random()):a.radian[0],a.radian[3]=_?u.lerp(e.minVerticalEndRadian,e.maxVerticalEndRadian,Math.random()):a.radian[1],a.durationAddScale=e.ageAddScale*Math.random(),a.time=r,a},n(t,["_tempVelocity",function(){return this._tempVelocity=new Float32Array(3)},"_tempStartColor",function(){return this._tempStartColor=new Float32Array(4)},"_tempEndColor",function(){return this._tempEndColor=new Float32Array(4)},"_tempSizeRotation",function(){return this._tempSizeRotation=new Float32Array(3)},"_tempRadius",function(){return this._tempRadius=new Float32Array(2)},"_tempRadian",function(){return this._tempRadian=new Float32Array(4)}]),t}(),E=(function(){function t(t,e,i){this._templet=null,this._timeBetweenParticles=NaN,this._previousPosition=null,this._timeLeftOver=0,this._tempVelocity=new Float32Array([0,0,0]),this._tempPosition=new Float32Array([0,0,0]),this._templet=t,this._timeBetweenParticles=1/e,this._previousPosition=i}r(t,"laya.particle.ParticleEmitter");var e=t.prototype;return e.update=function(t,e){if(t/=1e3,t>0){u.subtractVector3(e,this._previousPosition,this._tempVelocity),u.scaleVector3(this._tempVelocity,1/t,this._tempVelocity);for(var i=this._timeLeftOver+t,n=-this._timeLeftOver;i>this._timeBetweenParticles;)n+=this._timeBetweenParticles,i-=this._timeBetweenParticles,u.lerpVector3(this._previousPosition,e,n/t,this._tempPosition),this._templet.addParticleArray(this._tempPosition,this._tempVelocity);this._timeLeftOver=i}this._previousPosition[0]=e[0],this._previousPosition[1]=e[1],this._previousPosition[2]=e[2]},t}(),function(){function t(){this.textureName=null,this.textureCount=1,this.maxPartices=100,this.duration=1,this.ageAddScale=0,this.emitterVelocitySensitivity=1,this.minStartSize=100,this.maxStartSize=100,this.minEndSize=100,this.maxEndSize=100,this.minHorizontalVelocity=0,this.maxHorizontalVelocity=0,this.minVerticalVelocity=0,this.maxVerticalVelocity=0,this.endVelocity=1,this.minRotateSpeed=0,this.maxRotateSpeed=0,this.minStartRadius=0,this.maxStartRadius=0,this.minEndRadius=0,this.maxEndRadius=0,this.minHorizontalStartRadian=0,this.maxHorizontalStartRadian=0,this.minVerticalStartRadian=0,this.maxVerticalStartRadian=0,this.useEndRadian=!0,this.minHorizontalEndRadian=0,this.maxHorizontalEndRadian=0,this.minVerticalEndRadian=0,this.maxVerticalEndRadian=0,this.colorComponentInter=!1,this.disableColor=!1,this.blendState=0,this.emitterType="null",this.emissionRate=0,this.sphereEmitterRadius=1,this.sphereEmitterVelocity=0,this.sphereEmitterVelocityAddVariance=0,this.ringEmitterRadius=30,this.ringEmitterVelocity=0,this.ringEmitterVelocityAddVariance=0,this.ringEmitterUp=2,this.gravity=new Float32Array([0,0,0]),this.minStartColor=new Float32Array([1,1,1,1]),this.maxStartColor=new Float32Array([1,1,1,1]),this.minEndColor=new Float32Array([1,1,1,1]),this.maxEndColor=new Float32Array([1,1,1,1]),this.pointEmitterPosition=new Float32Array([0,0,0]),this.pointEmitterPositionVariance=new Float32Array([0,0,0]),this.pointEmitterVelocity=new Float32Array([0,0,0]),this.pointEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.boxEmitterCenterPosition=new Float32Array([0,0,0]),this.boxEmitterSize=new Float32Array([0,0,0]),this.boxEmitterVelocity=new Float32Array([0,0,0]),this.boxEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.sphereEmitterCenterPosition=new Float32Array([0,0,0]),this.ringEmitterCenterPosition=new Float32Array([0,0,0]),this.positionVariance=new Float32Array([0,0,0])}return r(t,"laya.particle.ParticleSetting"),t.checkSetting=function(e){var i;for(i in t._defaultSetting)e.hasOwnProperty(i)||(e[i]=t._defaultSetting[i])},n(t,["_defaultSetting",function(){return this._defaultSetting=new t}]),t}()),w=function(){function t(){this.settings=null,this.texture=null}r(t,"laya.particle.ParticleTemplateBase");var e=t.prototype;return e.addParticleArray=function(t,e){},t}(),b=function(){function t(){this.u_Duration=NaN,this.u_EndVelocity=NaN,this.u_Gravity=null,this.a_Position=null,this.a_Velocity=null,this.a_StartColor=null,this.a_EndColor=null,this.a_SizeRotation=null,this.a_Radius=null,this.a_Radian=null,this.a_AgeAddScale=NaN,this.gl_Position=null,this.v_Color=null,this.oSize=NaN,this._color=new Float32Array(4),this._position=new Float32Array(3)}r(t,"laya.particle.particleUtils.CanvasShader");var e=t.prototype;return e.getLen=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},e.ComputeParticlePosition=function(t,e,i,n){this._position[0]=t[0],this._position[1]=t[1],this._position[2]=t[2];var r=this.getLen(e),a=r*this.u_EndVelocity,s=r*n+(a-r)*n*n/2,o=NaN;o=this.getLen(e);var h=0,l=0;for(l=3,h=0;l>h;h++)this._position[h]=this._position[h]+e[h]/o*s*this.u_Duration,this._position[h]+=this.u_Gravity[h]*i*n;var c=u.lerp(this.a_Radius[0],this.a_Radius[1],n),_=u.lerp(this.a_Radian[0],this.a_Radian[2],n),d=u.lerp(this.a_Radian[1],this.a_Radian[3],n),f=Math.cos(d)*c;return this._position[1]+=Math.sin(d)*c,this._position[0]+=Math.cos(_)*f,this._position[2]+=Math.sin(_)*f,new Float32Array([this._position[0],this._position[1],0,1])},e.ComputeParticleSize=function(t,e,i){var n=u.lerp(t,e,i);return n},e.ComputeParticleRotation=function(t,e){return t*e},e.ComputeParticleColor=function(t,e,i){var n=this._color;return u.lerpVector4(t,e,i,n),n[3]=n[3]*i*(1-i)*(1-i)*6.7,n},e.clamp=function(t,e,i){return e>t?e:t>i?i:t},e.getData=function(t){t*=1+this.a_AgeAddScale;var e=this.clamp(t/this.u_Duration,0,1);this.gl_Position=this.ComputeParticlePosition(this.a_Position,this.a_Velocity,t,e);var i=this.ComputeParticleSize(this.a_SizeRotation[0],this.a_SizeRotation[1],e),n=this.ComputeParticleRotation(this.a_SizeRotation[2],t);this.v_Color=this.ComputeParticleColor(this.a_StartColor,this.a_EndColor,e);var r=new c,a=NaN;a=i/this.oSize*2,r.scale(a,a),r.rotate(n),r.setTranslate(this.gl_Position[0],-this.gl_Position[1]);var s=NaN;return s=this.v_Color[3],[this.v_Color,s,r,this.v_Color[0]*s,this.v_Color[1]*s,this.v_Color[2]*s]},t}(),C=function(){function t(){this.maxIndex=0,this.cmds=null,this.id=0}r(t,"laya.particle.particleUtils.CMDParticle");var e=t.prototype;return e.setCmds=function(t){this.cmds=t,this.maxIndex=t.length-1},t}(),M=function(){function t(){}return r(t,"laya.particle.particleUtils.PicTool"),t.getCanvasPic=function(t,e){t=t.bitmap;var i=new o("2D"),n=i.getContext("2d");i.size(t.width,t.height);var r=e>>16&255,a=e>>8&255,s=255&e;if(_.isConchApp&&n.setFilter(r/255,a/255,s/255,0),n.drawImage(t.source,0,0),!_.isConchApp){for(var h=n.getImageData(0,0,i.width,i.height),l=h.data,u=0,c=l.length;c>u;u+=4)0!=l[u+3]&&(l[u]*=r/255,l[u+1]*=a/255,l[u+2]*=s/255);n.putImageData(h,0,0)}return i},t.getRGBPic=function(e){var i;return i=[new m(t.getCanvasPic(e,16711680)),new m(t.getCanvasPic(e,65280)),new m(t.getCanvasPic(e,255))]},t}(),D=function(t){function e(t){this.setting=null,this._posRange=null,this._canvasTemplate=null,this._emitFun=null,e.__super.call(this),this.template=t}r(e,"laya.particle.emitter.Emitter2D",t);var i=e.prototype;return i.emit=function(){t.prototype.emit.call(this),null!=this._emitFun&&this._emitFun()},i.getRandom=function(t){return(2*Math.random()-1)*t},i.webGLEmit=function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var e=new Float32Array(3);e[0]=0,e[1]=0,e[2]=0,this._particleTemplate.addParticleArray(t,e)},i.canvasEmit=function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var e=new Float32Array(3);e[0]=0,e[1]=0,e[2]=0,this._particleTemplate.addParticleArray(t,e)},a(0,i,"template",function(){return this._particleTemplate},function(t){this._particleTemplate=t,t||(this._emitFun=null,this.setting=null,this._posRange=null),this.setting=t.settings,this._posRange=this.setting.positionVariance,this._particleTemplate instanceof laya.particle.ParticleTemplate2D?this._emitFun=this.webGLEmit:this._particleTemplate instanceof laya.particle.ParticleTemplateCanvas&&(this._canvasTemplate=t,this._emitFun=this.canvasEmit)}),e}(S),A=function(t){function e(t){this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._floatCountPerVertex=29,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,e.__super.call(this),this.settings=t}r(e,"laya.particle.ParticleTemplateWebGL",t);var i=e.prototype;return i.initialize=function(){this._vertices=new Float32Array(this.settings.maxPartices*this._floatCountPerVertex*4);
for(var t=0,e=0;e<this.settings.maxPartices;e++){var i=Math.random(),n=this.settings.textureCount?1/this.settings.textureCount:1,r=NaN;for(r=0;r<this.settings.textureCount&&!(r+n>i);r+=n);t=e*this._floatCountPerVertex*4,this._vertices[t+0*this._floatCountPerVertex+0]=-1,this._vertices[t+0*this._floatCountPerVertex+1]=-1,this._vertices[t+0*this._floatCountPerVertex+2]=0,this._vertices[t+0*this._floatCountPerVertex+3]=r,this._vertices[t+1*this._floatCountPerVertex+0]=1,this._vertices[t+1*this._floatCountPerVertex+1]=-1,this._vertices[t+1*this._floatCountPerVertex+2]=1,this._vertices[t+1*this._floatCountPerVertex+3]=r,this._vertices[t+2*this._floatCountPerVertex+0]=1,this._vertices[t+2*this._floatCountPerVertex+1]=1,this._vertices[t+2*this._floatCountPerVertex+2]=1,this._vertices[t+2*this._floatCountPerVertex+3]=r+n,this._vertices[t+3*this._floatCountPerVertex+0]=-1,this._vertices[t+3*this._floatCountPerVertex+1]=1,this._vertices[t+3*this._floatCountPerVertex+2]=0,this._vertices[t+3*this._floatCountPerVertex+3]=r+n}},i.loadContent=function(){},i.update=function(t){this._currentTime+=t/1e3,this.retireActiveParticles(),this.freeRetiredParticles(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0)},i.retireActiveParticles=function(){for(var t=1e-4,e=this.settings.duration;this._firstActiveElement!=this._firstNewElement;){var i=this._firstActiveElement*this._floatCountPerVertex*4,n=i+28,r=this._currentTime-this._vertices[n];if(r*=1+this._vertices[i+27],e>r+t)break;this._vertices[n]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.settings.maxPartices&&(this._firstActiveElement=0)}},i.freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var t=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*4+28];if(3>t)break;this._firstRetiredElement++,this._firstRetiredElement>=this.settings.maxPartices&&(this._firstRetiredElement=0)}},i.addNewParticlesToVertexBuffer=function(){},i.addParticleArray=function(t,e){var i=this._firstFreeElement+1;if(i>=this.settings.maxPartices&&(i=0),i!==this._firstRetiredElement){for(var n=T.Create(this.settings,t,e,this._currentTime),r=this._firstFreeElement*this._floatCountPerVertex*4,a=0;4>a;a++){var s=0,o=0;for(s=0,o=4;3>s;s++)this._vertices[r+a*this._floatCountPerVertex+o+s]=n.position[s];for(s=0,o=7;3>s;s++)this._vertices[r+a*this._floatCountPerVertex+o+s]=n.velocity[s];for(s=0,o=10;4>s;s++)this._vertices[r+a*this._floatCountPerVertex+o+s]=n.startColor[s];for(s=0,o=14;4>s;s++)this._vertices[r+a*this._floatCountPerVertex+o+s]=n.endColor[s];for(s=0,o=18;3>s;s++)this._vertices[r+a*this._floatCountPerVertex+o+s]=n.sizeRotation[s];for(s=0,o=21;2>s;s++)this._vertices[r+a*this._floatCountPerVertex+o+s]=n.radius[s];for(s=0,o=23;4>s;s++)this._vertices[r+a*this._floatCountPerVertex+o+s]=n.radian[s];this._vertices[r+a*this._floatCountPerVertex+27]=n.durationAddScale,this._vertices[r+a*this._floatCountPerVertex+28]=n.time}this._firstFreeElement=i}},e}(w),R=function(t){function e(t){this._ready=!1,this.textureList=[],this.particleList=[],this.pX=0,this.pY=0,this.activeParticles=[],this.deadParticles=[],this.iList=[],this._maxNumParticles=0,this.textureWidth=NaN,this.dTextureWidth=NaN,this.colorChange=!0,this.step=1/60,this.canvasShader=new b,e.__super.call(this),this.settings=t,this._maxNumParticles=t.maxPartices,this.texture=new m,this.texture.on("loaded",this,this._textureLoaded),this.texture.load(t.textureName)}r(e,"laya.particle.ParticleTemplateCanvas",t);var i=e.prototype;return i._textureLoaded=function(t){this.setTexture(this.texture),this._ready=!0},i.clear=function(t){void 0===t&&(t=!0),this.deadParticles.length=0,this.activeParticles.length=0,this.textureList.length=0},i.setTexture=function(t){this.texture=t,this.textureWidth=t.width,this.dTextureWidth=1/this.textureWidth,this.pX=.5*-t.width,this.pY=.5*-t.height,this.textureList=e.changeTexture(t,this.textureList),this.particleList.length=0,this.deadParticles.length=0,this.activeParticles.length=0},i._createAParticleData=function(t,e){this.canvasShader.u_EndVelocity=this.settings.endVelocity,this.canvasShader.u_Gravity=this.settings.gravity,this.canvasShader.u_Duration=this.settings.duration;var i;i=T.Create(this.settings,t,e,0),this.canvasShader.a_Position=i.position,this.canvasShader.a_Velocity=i.velocity,this.canvasShader.a_StartColor=i.startColor,this.canvasShader.a_EndColor=i.endColor,this.canvasShader.a_SizeRotation=i.sizeRotation,this.canvasShader.a_Radius=i.radius,this.canvasShader.a_Radian=i.radian,this.canvasShader.a_AgeAddScale=i.durationAddScale,this.canvasShader.oSize=this.textureWidth;var n=new C,r=0,a=this.settings.duration/(1+i.durationAddScale),s=[];for(r=0;a>r;r+=this.step)s.push(this.canvasShader.getData(r));return n.id=this.particleList.length,this.particleList.push(n),n.setCmds(s),n},i.addParticleArray=function(t,e){if(this._ready){var i;this.particleList.length<this._maxNumParticles?(i=this._createAParticleData(t,e),this.iList[i.id]=0,this.activeParticles.push(i)):this.deadParticles.length>0&&(i=this.deadParticles.pop(),this.iList[i.id]=0,this.activeParticles.push(i))}},i.advanceTime=function(t){if(void 0===t&&(t=1),this._ready){var e,i=this.activeParticles,n=this.deadParticles,r=0,a=i.length,s=0,o=this.iList;for(r=a-1;r>-1;r--)e=i[r],s=o[e.id],s>=e.maxIndex?(s=0,i.splice(r,1),n.push(e)):s+=1,o[e.id]=s}},i.render=function(t,e,i){this._ready&&(this.activeParticles.length<1||this.textureList.length<2||(this.settings.disableColor?this.noColorRender(t,e,i):this.canvasRender(t,e,i)))},i.noColorRender=function(t,e,i){var n,r,a=this.activeParticles,s=0,o=a.length,h=NaN,l=this.pX,u=this.pY,c=2*-l,_=2*-u,d=0,f=(this.textureList,this.iList),p=NaN;for(t.translate(e,i),p=t.ctx.globalAlpha,s=0;o>s;s++)n=a[s],d=f[n.id],r=n.cmds[d],r&&((h=r[1])<=.01||(t.setAlpha(p*h),t.drawTextureWithTransform(this.texture,l,u,c,_,r[2],1)));t.setAlpha(p),t.translate(-e,-i)},i.canvasRender=function(t,e,i){var n,r,a,s=this.activeParticles,o=0,h=s.length,l=NaN,u=this.pX,c=this.pY,_=2*-u,d=2*-c,f=0,p=this.textureList,m=this.iList,g=NaN;for(t.translate(e,i),g=t.ctx.globalAlpha,a=t.ctx.globalCompositeOperation,t.blendMode("lighter"),o=0;h>o;o++)n=s[o],f=m[n.id],r=n.cmds[f],r&&((l=r[1])<=.01||(t.save(),t.transformByMatrix(r[2]),r[3]>.01&&(t.setAlpha(g*r[3]),t.drawTexture(p[0],u,c,_,d)),r[4]>.01&&(t.setAlpha(g*r[4]),t.drawTexture(p[1],u,c,_,d)),r[5]>.01&&(t.setAlpha(g*r[5]),t.drawTexture(p[2],u,c,_,d)),t.restore()));t.setAlpha(g),t.translate(-e,-i),t.blendMode(a)},e.changeTexture=function(t,e,i){return e||(e=[]),e.length=0,i&&i.disableColor?e.push(t,t,t):g.copyArray(e,M.getRGBPic(t)),e},e}(w),I=function(t){function e(t){this._vertexBuffer2D=null,this._indexBuffer2D=null,this.x=0,this.y=0,this._blendFn=null,this._startTime=0,this.sv=new P,e.__super.call(this,t);var n=this;i.loader.load(this.settings.textureName,h.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,n.texture=t})),this.sv.u_Duration=this.settings.duration,this.sv.u_Gravity=this.settings.gravity,this.sv.u_EndVelocity=this.settings.endVelocity,this._blendFn=s.fns[t.blendState],this.initialize(),this._vertexBuffer=this._vertexBuffer2D=x.create(-1,35048),this._indexBuffer=this._indexBuffer2D=l.create(35044),this.loadContent()}r(e,"laya.particle.ParticleTemplate2D",t);var n=e.prototype;return i.imps(n,{"laya.webgl.submit.ISubmit":!0}),n.getRenderType=function(){return-111},n.releaseRender=function(){},n.addParticleArray=function(e,i){e[0]+=this.x,e[1]+=this.y,t.prototype.addParticleArray.call(this,e,i)},n.loadContent=function(){for(var t=new Uint16Array(6*this.settings.maxPartices),e=0;e<this.settings.maxPartices;e++)t[6*e+0]=4*e+0,t[6*e+1]=4*e+1,t[6*e+2]=4*e+2,t[6*e+3]=4*e+0,t[6*e+4]=4*e+2,t[6*e+5]=4*e+3;this._indexBuffer2D.clear(),this._indexBuffer2D.append(t),this._indexBuffer2D.upload()},n.addNewParticlesToVertexBuffer=function(){this._vertexBuffer2D.clear(),this._vertexBuffer2D.append(this._vertices);var t=0;this._firstNewElement<this._firstFreeElement?(t=4*this._firstNewElement*this._floatCountPerVertex*4,this._vertexBuffer2D.subUpload(t,t,t+4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex*4)):(t=4*this._firstNewElement*this._floatCountPerVertex*4,this._vertexBuffer2D.subUpload(t,t,t+4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex*4),this._firstFreeElement>0&&(this._vertexBuffer2D.setNeedUpload(),this._vertexBuffer2D.subUpload(0,0,4*this._firstFreeElement*this._floatCountPerVertex*4))),this._firstNewElement=this._firstFreeElement},n.renderSubmit=function(){if(this.texture&&this.texture.loaded){if(this.update(i.timer.delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this.blend(),this._firstActiveElement!=this._firstFreeElement){v.mainContext;this._vertexBuffer2D.bind(this._indexBuffer2D),this.sv.u_texture=this.texture.source,this.sv.upload(),this._firstActiveElement<this._firstFreeElement?v.mainContext.drawElements(4,6*(this._firstFreeElement-this._firstActiveElement),5123,6*this._firstActiveElement*2):(v.mainContext.drawElements(4,6*(this.settings.maxPartices-this._firstActiveElement),5123,6*this._firstActiveElement*2),this._firstFreeElement>0&&v.mainContext.drawElements(4,6*this._firstFreeElement,5123,0)),p.drawCall++}this._drawCounter++}return 1},n.blend=function(){if(s.activeBlendFunction!==this._blendFn){var t=v.mainContext;t.enable(3042),this._blendFn(t),s.activeBlendFunction=this._blendFn}},n.dispose=function(){this._indexBuffer2D.dispose()},e.activeBlendType=-1,e}(A),P=function(t){function e(){this.a_CornerTextureCoordinate=[4,5126,!1,116,0],this.a_Position=[3,5126,!1,116,16],this.a_Velocity=[3,5126,!1,116,28],this.a_StartColor=[4,5126,!1,116,40],this.a_EndColor=[4,5126,!1,116,56],this.a_SizeRotation=[3,5126,!1,116,72],this.a_Radius=[2,5126,!1,116,84],this.a_Radian=[4,5126,!1,116,92],this.a_AgeAddScale=[1,5126,!1,116,108],this.a_Time=[1,5126,!1,116,112],this.u_CurrentTime=NaN,this.u_Duration=NaN,this.u_Gravity=null,this.u_EndVelocity=NaN,this.u_texture=null,e.__super.call(this,0,0)}r(e,"laya.particle.shader.value.ParticleShaderValue",t);var i=e.prototype;return i.upload=function(){this.refresh(),e.pShader.upload(this)},n(e,["pShader",function(){return this.pShader=new L}]),e}(y),L=(function(e){function n(t){this._matrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this._particleTemplate=null,this._canvasTemplate=null,this._emitter=null,this.autoPlay=!0,n.__super.call(this),t&&this.setParticleSetting(t)}r(n,"laya.particle.Particle2D",e);var s=n.prototype;return s.load=function(t){i.loader.load(t,h.create(this,this.setParticleSetting),null,"json")},s.setParticleSetting=function(e){var n=this;if(!e)return this.stop();if(E.checkSetting(e),(!t.ConchParticleTemplate2D||_.isWebGL)&&(this.customRenderEnable=!0),_.isWebGL)this._particleTemplate=new I(e),this.graphics._saveToCmd(_.context._drawParticle,[this._particleTemplate]);else{if(_.isConchApp&&t.ConchParticleTemplate2D){this._particleTemplate=new ConchParticleTemplate2D;var r=this;return i.loader.load(e.textureName,h.create(null,function(t){r._particleTemplate.texture=t,r._particleTemplate.settings=e,_.isConchNode?r.graphics.drawParticle(r._particleTemplate):r.graphics._saveToCmd(_.context._drawParticle,[n._particleTemplate])})),this._emitter={start:function(){}},this.play=this._particleTemplate.play.bind(this._particleTemplate),this.stop=this._particleTemplate.stop.bind(this._particleTemplate),void(this.autoPlay&&this.play())}this._particleTemplate=this._canvasTemplate=new R(e)}this._emitter?this._emitter.template=this._particleTemplate:this._emitter=new D(this._particleTemplate),this.autoPlay&&(this.emitter.start(),this.play())},s.play=function(){i.timer.frameLoop(1,this,this._loop)},s.stop=function(){i.timer.clear(this,this._loop)},s._loop=function(){this.advanceTime(1/60)},s.advanceTime=function(t){void 0===t&&(t=1),this._canvasTemplate&&this._canvasTemplate.advanceTime(t),this._emitter&&this._emitter.advanceTime(t)},s.customRender=function(t,e,i){if(_.isWebGL){this._matrix4[0]=t.ctx._curMat.a,this._matrix4[1]=t.ctx._curMat.b,this._matrix4[4]=t.ctx._curMat.c,this._matrix4[5]=t.ctx._curMat.d,this._matrix4[12]=t.ctx._curMat.tx,this._matrix4[13]=t.ctx._curMat.ty;var n=this._particleTemplate.sv;n.u_mmat=this._matrix4}this._canvasTemplate&&this._canvasTemplate.render(t,e,i)},s.destroy=function(t){void 0===t&&(t=!0),this._particleTemplate instanceof laya.particle.ParticleTemplate2D&&this._particleTemplate.dispose(),e.prototype.destroy.call(this,t)},a(0,s,"url",null,function(t){this.load(t)}),a(0,s,"emitter",function(){return this._emitter}),n}(f),function(t){function e(){e.__super.call(this,e.vs,e.ps,"ParticleShader")}return r(e,"laya.particle.shader.ParticleShader",t),n(e,["vs",function(){return this.vs="attribute vec4 a_CornerTextureCoordinate;\nattribute vec3 a_Position;\nattribute vec3 a_Velocity;\nattribute vec4 a_StartColor;\nattribute vec4 a_EndColor;\nattribute vec3 a_SizeRotation;\nattribute vec2 a_Radius;\nattribute vec4 a_Radian;\nattribute float a_AgeAddScale;\nattribute float a_Time;\n\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\n\nuniform float u_CurrentTime;\nuniform float u_Duration;\nuniform float u_EndVelocity;\nuniform vec3 u_Gravity;\n\n#ifdef PARTICLE3D\n uniform mat4 u_WorldMat;\n uniform mat4 u_View;\n uniform mat4 u_Projection;\n uniform vec2 u_ViewportScale;\n#else\n uniform vec2 size;\n uniform mat4 mmat;\n uniform mat4 u_mmat;\n#endif\n\nvec4 ComputeParticlePosition(in vec3 position, in vec3 velocity,in float age,in float normalizedAge)\n{\n\n   float startVelocity = length(velocity);//起始标量速度\n   float endVelocity = startVelocity * u_EndVelocity;//结束标量速度\n\n   float velocityIntegral = startVelocity * normalizedAge +(endVelocity - startVelocity) * normalizedAge *normalizedAge/2.0;//计算当前速度的标量（单位空间），vt=v0*t+(1/2)*a*(t^2)\n   \n   vec3 addPosition = normalize(velocity) * velocityIntegral * u_Duration;//计算受自身速度影响的位置，转换标量到矢量    \n   addPosition += u_Gravity * age * normalizedAge;//计算受重力影响的位置\n   \n   float radius=mix(a_Radius.x, a_Radius.y, normalizedAge); //计算粒子受半径和角度影响（无需计算角度和半径时，可用宏定义优化屏蔽此计算）\n   float radianHorizontal =mix(a_Radian.x,a_Radian.z,normalizedAge);\n   float radianVertical =mix(a_Radian.y,a_Radian.w,normalizedAge);\n   \n   float r =cos(radianVertical)* radius;\n   addPosition.y += sin(radianVertical) * radius;\n	\n   addPosition.x += cos(radianHorizontal) *r;\n   addPosition.z += sin(radianHorizontal) *r;\n  \n   #ifdef PARTICLE3D\n   position+=addPosition;\n    return  u_Projection*u_View*u_WorldMat*(vec4(position, 1.0));\n   #else\n   addPosition.y=-addPosition.y;//2D粒子位置更新需要取负，2D粒子坐标系Y轴正向朝上\n   position+=addPosition;\n    return  vec4(position,1.0);\n   #endif\n}\n\nfloat ComputeParticleSize(in float startSize,in float endSize, in float normalizedAge)\n{    \n    float size = mix(startSize, endSize, normalizedAge);\n    \n	#ifdef PARTICLE3D\n    //Project the size into screen coordinates.\n     return size * u_Projection[1][1];\n	#else\n	 return size;\n	#endif\n}\n\nmat2 ComputeParticleRotation(in float rot,in float age)\n{    \n    float rotation =rot * age;\n    //计算2x2旋转矩阵.\n    float c = cos(rotation);\n    float s = sin(rotation);\n    return mat2(c, -s, s, c);\n}\n\nvec4 ComputeParticleColor(in vec4 startColor,in vec4 endColor,in float normalizedAge)\n{\n	vec4 color=mix(startColor,endColor,normalizedAge);\n    //硬编码设置，使粒子淡入很快，淡出很慢,6.7的缩放因子把置归一在0到1之间，可以谷歌x*(1-x)*(1-x)*6.7的制图表\n    color.a *= normalizedAge * (1.0-normalizedAge) * (1.0-normalizedAge) * 6.7;\n   \n    return color;\n}\n\nvoid main()\n{\n   float age = u_CurrentTime - a_Time;\n   age *= 1.0 + a_AgeAddScale;\n   float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   gl_Position = ComputeParticlePosition(a_Position, a_Velocity, age, normalizedAge);//计算粒子位置\n   float pSize = ComputeParticleSize(a_SizeRotation.x,a_SizeRotation.y, normalizedAge);\n   mat2 rotation = ComputeParticleRotation(a_SizeRotation.z, age);\n	\n   #ifdef PARTICLE3D\n	gl_Position.xy += (rotation*a_CornerTextureCoordinate.xy) * pSize * u_ViewportScale;\n   #else\n    mat4 mat=u_mmat*mmat;\n    gl_Position=vec4((mat*gl_Position).xy,0.0,1.0);\n	gl_Position.xy += (rotation*a_CornerTextureCoordinate.xy) * pSize*vec2(mat[0][0],mat[1][1]);\n    gl_Position=vec4((gl_Position.x/size.x-0.5)*2.0,(0.5-gl_Position.y/size.y)*2.0,0.0,1.0);\n   #endif\n   \n   v_Color = ComputeParticleColor(a_StartColor,a_EndColor, normalizedAge);\n   v_TextureCoordinate =a_CornerTextureCoordinate.zw;\n}\n\n"},"ps",function(){return this.ps="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\n\nvoid main()\n{	\n	gl_FragColor=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n	gl_FragColor.xyz *= v_Color.w;\n}"}]),e}(d))}(window,document,Laya)}).call(window)},function(t,e,i){(function(){!function(t,e,i){var n=(i.un,i.uns,i["static"]),r=i["class"],a=i.getset,s=i.__newvec,o=(laya.ani.AnimationContent,laya.ani.AnimationPlayer),h=(laya.ani.AnimationState,laya.ani.AnimationTemplet),l=laya.maths.Arith,u=laya.webgl.atlas.AtlasResourceManager,c=laya.webgl.shader.BaseShader,_=laya.utils.Browser,d=laya.webgl.utils.Buffer,f=(laya.webgl.utils.Buffer2D,laya.utils.Byte),p=laya.utils.ClassUtils,m=i.Config,g=(laya.events.Event,laya.events.EventDispatcher),y=laya.utils.Handler,x=laya.net.Loader,v=laya.net.LoaderManager,S=laya.maths.MathUtil,T=laya.display.Node,E=laya.renders.Render,w=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),b=laya.resource.Resource,C=laya.utils.RunDriver,M=(laya.webgl.shader.Shader,laya.webgl.utils.ShaderCompile,laya.display.Sprite),D=laya.utils.Stat,A=laya.utils.StringKey,R=laya.net.URL,I=laya.utils.Utils,P=laya.webgl.WebGL,L=laya.webgl.WebGLContext;laya.webgl.canvas.WebGLContext2D,laya.webgl.resource.WebGLImage;i["interface"]("laya.d3.core.IClone"),i["interface"]("laya.d3.graphics.IVertex"),i["interface"]("laya.d3.core.render.IUpdate"),i["interface"]("laya.d3.core.scene.ITreeNode"),i["interface"]("laya.d3.core.render.IRenderable");var N=function(){function t(){}return r(t,"laya.d3.animation.AnimationClipParser01"),t.READ_DATA=function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._reader.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;e>r;r++)i.push(t._reader.getUint32()),n.push(t._reader.getUint32())},t.READ_STRINGS=function(){var e=t._reader.getUint32(),i=t._reader.getUint16(),n=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;i>r;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=n},t.parse=function(e,i){t._animationClip=e,t._reader=i;i.__getBuffer();t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var n=0,r=t._BLOCK.count;r>n;n++){var a=i.getUint16(),s=t._strings[a],o=t["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call()}},t.READ_ANIMATIONS=function(){var e,i=0,n=0,r=t._reader,a=r.__getBuffer(),s=[],o=r.getUint8();for(s.length=o,i=0;o>i;i++)s[i]=r.getUint16();var h=[],l=r.getUint16();for(h.length=l,i=0;l>i;i++)h[i]=r.getFloat32();var u=t._animationClip;u.name=t._strings[r.getUint16()];var c=u._duration=r.getFloat32();u.islooping=!!r.getByte(),u._frameRate=r.getInt16();var _=r.getInt16(),d=u._nodes=new Array;d.length=_;var f=0,p=0;for(i=0;_>i;i++){e=d[i]=new F;var m=r.getUint16(),g=e.path=[];for(g.length=m,n=0;m>n;n++)g[n]=t._strings[r.getUint16()];var y=r.getInt16();-1!==y&&(e.componentType=t._strings[y]);var x=O._propertyIndexDic[t._strings[r.getUint16()]];if(null==x)throw new Error("AnimationClipParser01:unknown property name.");var v=4>x,S=!v||v&&""===g[0];e._cacheProperty=S,S?f++:p++,e.propertyNameID=x;var T=s[r.getUint8()];e.keyFrameWidth=T/4;var E=e.keyFrames=[],w=E.length=r.getUint16(),b=null,C=NaN;for(n=0;w>n;n++){var M=E[n]=new V;C=M.startTime=h[r.getUint16()];var D=r.pos;M.inTangent=new Float32Array(a.slice(D,D+T)),r.pos+=T,D=r.pos,M.outTangent=new Float32Array(a.slice(D,D+T)),r.pos+=T,D=r.pos,M.data=new Float32Array(a.slice(D,D+T)),r.pos+=T,b&&(b.next=M,b.duration=C-b.startTime),b=M}M.next=null,M.duration=c-C}var A=u._nodeToCachePropertyMap=new Int32Array(_),R=u._cachePropertyToNodeMap=new Int32Array(f),I=u._unCachePropertyToNodeMap=new Int32Array(p);for(f=p=0,i=0;_>i;i++)e=d[i],e._cacheProperty?(A[i]=f,R[f++]=i):I[p++]=i},t._animationClip=null,t._reader=null,t._strings=[],n(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),O=function(){function t(){this._childs=[],this._attchSprite3Ds=[],this._transform=new Re}r(t,"laya.d3.animation.AnimationNode");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.transform=function(){return this._transform},e.addChild=function(t){t._parent=this,t._transform.parent=this._transform,this._childs.push(t)},e.removeChild=function(t){var e=this._childs.indexOf(t);-1!==e&&this._childs.splice(e,1)},e.getChildByName=function(t){for(var e=0,i=this._childs.length;i>e;e++){var n=this._childs[e];if(n.name===t)return n}return null},e.getChildByIndex=function(t){return this._childs[t]},e.getChildCount=function(){return this._childs.length},e.cloneTo=function(t){var e=t;e.name=this.name;var i=e._transform,n=i.localPosition;this._transform.localPosition.cloneTo(n),i.localPosition=n;var r=i.localRotation;this._transform.localRotation.cloneTo(r),i.localRotation=r;var a=i.localScale;this._transform.localScale.cloneTo(a),i.localScale=a;for(var s=0,o=this._childs.length;o>s;s++){var h=this._childs[s].clone();e.addChild(h)}},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"attchSprite3Ds",function(){return this._attchSprite3Ds}),t.__init__=function(){t.registerAnimationNodeProperty("localPosition",t._getLocalPosition,t._setLocalPosition),t.registerAnimationNodeProperty("localRotation",t._getLocalRotation,t._setLocalRotation),t.registerAnimationNodeProperty("localScale",t._getLocalScale,t._setLocalScale),t.registerAnimationNodeProperty("localRotationEuler",t._getLocalRotationEuler,t._setLocalRotationEuler),t.registerAnimationNodeProperty("particleRender.sharedMaterial.tintColor",t._getParticleRenderSharedMaterialTintColor,t._setParticleRenderSharedMaterialTintColor),t.registerAnimationNodeProperty("meshRender.sharedMaterial.tilingOffset",t._getMeshRenderSharedMaterialTilingOffset,t._setMeshRenderSharedMaterialTilingOffset),t.registerAnimationNodeProperty("meshRender.sharedMaterial.albedo",t._getMeshRenderSharedMaterialAlbedo,t._setMeshRenderSharedMaterialAlbedo),t.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.tilingOffset",t._getSkinnedMeshRenderSharedMaterialTilingOffset,t._setSkinnedMeshRenderSharedMaterialTilingOffset),t.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedo",t._getSkinnedMeshRenderSharedMaterialAlbedo,t._setSkinnedMeshRenderSharedMaterialAlbedo)},t.registerAnimationNodeProperty=function(e,i,n){if(t._propertyIndexDic[e])throw new Error("AnimationNode: this propertyName has registered.");t._propertyIndexDic[e]=t._propertyIDCounter,t._propertyGetFuncs[t._propertyIDCounter]=i,t._propertySetFuncs[t._propertyIDCounter]=n,t._propertyIDCounter++},t._getLocalPosition=function(t){return t._transform.localPosition.elements},t._setLocalPosition=function(t,e){var i=t._transform,n=i._localPosition;n.elements=e,i._setLocalPosition(n)},t._getLocalRotation=function(t){return t._transform.localRotation.elements},t._setLocalRotation=function(t,e){var i=t._transform,n=i._localRotation;n.elements=e,i._setLocalRotation(n)},t._getLocalScale=function(t){return t._transform.localScale.elements},t._setLocalScale=function(t,e){var i=t._transform,n=i._localScale;n.elements=e,i._setLocalScale(n)},t._getLocalRotationEuler=function(t){return t._transform.localRotationEuler.elements},t._setLocalRotationEuler=function(t,e){var i=t._transform,n=i._localRotationEuler;n.elements=e,i._setLocalRotationEuler(n)},t._getMeshRenderSharedMaterialTilingOffset=function(t){var e=t._transform._entity;if(e){var i=e.owner.meshRender.sharedMaterial;return i?i.tilingOffset.elements:null}return null},t._setMeshRenderSharedMaterialTilingOffset=function(t,e){var i=t._transform._entity;if(i){var n=i.owner.meshRender.material,r=n.tilingOffset;r.elements=e,n.tilingOffset=r}},t._getMeshRenderSharedMaterialAlbedo=function(t){var e=t._transform._entity;if(e){var i=e.owner.meshRender.sharedMaterial;return i.albedo.elements}return null},t._setMeshRenderSharedMaterialAlbedo=function(t,e){var i=t._transform._entity;if(i){var n=i.owner.meshRender.material,r=n.albedo;r.elements=e,n.albedo=r}},t._getSkinnedMeshRenderSharedMaterialTilingOffset=function(t){var e=t._transform._entity;if(e){var i=e.owner.skinnedMeshRender.sharedMaterial;return i.tilingOffset.elements}return null},t._setSkinnedMeshRenderSharedMaterialTilingOffset=function(t,e){var i=t._transform._entity;if(i){var n=i.owner.skinnedMeshRender.material,r=n.tilingOffset;r.elements=e,n.tilingOffset=r}},t._getSkinnedMeshRenderSharedMaterialAlbedo=function(t){var e=t._transform._entity;if(e){var i=e.owner.skinnedMeshRender.sharedMaterial;return i.albedo.elements}return null},t._setSkinnedMeshRenderSharedMaterialAlbedo=function(t,e){var i=t._transform._entity;if(i){var n=i.owner.skinnedMeshRender.material,r=n.albedo;r.elements=e,n.albedo=r}},t._getParticleRenderSharedMaterialTintColor=function(t){var e=t._transform._entity;if(e){var i=e.owner.particleRender.sharedMaterial;return i.tintColor.elements}return null},t._setParticleRenderSharedMaterialTintColor=function(t,e){var i=t._transform._entity;if(i){var n=i.owner.particleRender.material,r=n.tintColor;r.elements=e,n.tintColor=r}},t._propertyIDCounter=0,t._propertyIndexDic={},t._propertySetFuncs=[],t._propertyGetFuncs=[],t}(),V=function(){function t(){this.startTime=NaN,this.inTangent=null,this.outTangent=null,this.data=null,this.duration=NaN,this.next=null}return r(t,"laya.d3.animation.Keyframe"),t}(),F=function(){function t(){this._cacheProperty=!1,this.path=null,this.componentType=null,this.propertyNameID=0,this.keyFrameWidth=0,this.keyFrames=null}return r(t,"laya.d3.animation.KeyframeNode"),t}(),B=function(){function t(){this._tempVector30=new _e,this._tempVector31=new _e,this._tempVector32=new _e,this._a=new _e,this._b=new _e,this._c=new _e,this._d=new _e}r(t,"laya.d3.core.glitter.SplineCurvePositionVelocity");var e=t.prototype;return e.Init=function(t,e,i,n){t.cloneTo(this._d),e.cloneTo(this._c),_e.scale(t,2,this._a),_e.scale(i,2,this._tempVector30),_e.subtract(this._a,this._tempVector30,this._a),_e.add(this._a,e,this._a),_e.add(this._a,n,this._a),_e.scale(i,3,this._b),_e.scale(t,3,this._tempVector30),_e.subtract(this._b,this._tempVector30,this._b),_e.subtract(this._b,n,this._b),_e.scale(e,2,this._tempVector30),_e.subtract(this._b,this._tempVector30,this._b)},e.Slerp=function(t,e){_e.scale(this._a,t*t*t,this._tempVector30),_e.scale(this._b,t*t,this._tempVector31),_e.scale(this._c,t,this._tempVector32),_e.add(this._tempVector30,this._tempVector31,e),_e.add(e,this._tempVector32,e),_e.add(e,this._d,e)},t}(),U=function(){function t(t,e,i,n){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=t,this._h=e,this._minHeight=i,this._maxHeight=n}r(t,"laya.d3.core.HeightMap");var e=t.prototype;return e._inBounds=function(t,e){return t>=0&&t<this._h&&e>=0&&e<this._w},e.getHeight=function(t,e){return this._inBounds(t,e)?this._datas[t][e]:NaN},a(0,e,"width",function(){return this._w}),a(0,e,"height",function(){return this._h}),a(0,e,"maxHeight",function(){return this._maxHeight}),a(0,e,"minHeight",function(){return this._minHeight}),t.creatFromMesh=function(e,i,n,r){for(var a=[],s=[],o=e.getSubMeshCount(),h=0;o>h;h++){for(var l=e.getSubMesh(h),u=l._getVertexBuffer(),c=u.getData(),_=[],d=0;d<c.length;d+=u.vertexDeclaration.vertexStride/4){var f=new _e(c[d+0],c[d+1],c[d+2]);_.push(f)}a.push(_);var p=l._getIndexBuffer();s.push(p.getData())}var m=e.boundingBox,g=m.min.x,y=m.min.z,x=m.max.x,v=m.max.z,S=m.min.y,T=m.max.y,E=x-g,w=v-y,b=r.elements[0]=E/(i-1),C=r.elements[1]=w/(n-1),M=new t(i,n,S,T),D=t._tempRay,A=D.direction.elements;A[0]=0,A[1]=-1,A[2]=0;var R=.1,I=T+R;D.origin.elements[1]=I;for(var P=0;n>P;P++){var L=y+P*C;M._datas[P]=[];for(var N=0;i>N;N++){var O=g+N*b,V=D.origin.elements;V[0]=O,V[2]=L;var F=t._getPosition(D,a,s);M._datas[P][N]=F===Number.MAX_VALUE?NaN:I-F}}return M},t.createFromImage=function(e,i,n){for(var r=e.width,a=e.height,s=new t(r,a,i,n),o=(n-i)/254,h=e.getPixels(),l=0,u=0;a>u;u++)for(var c=s._datas[u]=[],_=0;r>_;_++){var d=h[l++],f=h[l++],p=h[l++],m=h[l++];255==d&&255==f&&255==p&&255==m?c[_]=NaN:c[_]=(d+f+p)/3*o+i}return s},t._getPosition=function(t,e,i){for(var n=Number.MAX_VALUE,r=0;r<e.length;r++)for(var a=e[r],s=i[r],o=0;o<s.length;o+=3){var h=a[s[o+0]],l=a[s[o+1]],u=a[s[o+2]],c=be.rayIntersectsTriangle(t,h,l,u);!isNaN(c)&&n>c&&(n=c)}return n},n(t,["_tempRay",function(){return this._tempRay=new ue(new _e,new _e)}]),t}(),k=function(){function t(){if(this._id=0,this._number=0,this._mask=0,this._active=!0,this._visible=!0,this._colliders=null,this.name=null,t._uniqueIDCounter>31)throw new Error("不允许创建Layer，请参考函数getLayerByNumber、getLayerByMask、getLayerByName！");this._id=t._uniqueIDCounter,t._uniqueIDCounter++,this._colliders=[]}r(t,"laya.d3.core.Layer");var e=t.prototype;return a(0,e,"number",function(){return this._number}),a(0,e,"visible",function(){return this._visible},function(e){29!==this._number&&30!=this._number&&(this._visible=e,e?t._visibleLayers=t._visibleLayers|this.mask:t._visibleLayers=t._visibleLayers&~this.mask)}),a(0,e,"mask",function(){return this._mask}),a(0,e,"active",function(){return this._active},function(e){29!==this._number&&30!=this._number&&(this._active=e,e?t._activeLayers=t._activeLayers|this.mask:t._activeLayers=t._activeLayers&~this.mask)}),a(1,t,"activeLayers",function(){return t._activeLayers},function(e){t._activeLayers=e|t.getLayerByNumber(29).mask|t.getLayerByNumber(30).mask;for(var i=0,n=t._layerList.length;n>i;i++){var r=t._layerList[i];r._active=0!==(r._mask&t._activeLayers)}}),a(1,t,"visibleLayers",function(){return t._visibleLayers},function(e){t._visibleLayers=e|t.getLayerByNumber(29).mask|t.getLayerByNumber(30).mask;for(var i=0,n=t._layerList.length;n>i;i++){var r=t._layerList[i];r._visible=0!==(r._mask&t._visibleLayers)}}),t.__init__=function(){t._layerList.length=31;for(var e=0;31>e;e++){var i=new t;t._layerList[e]=i,0===e?i.name="Default Layer":29===e?i.name="Reserved Layer0":30===e?i.name="Reserved Layer1":i.name="Layer-"+e,i._number=e,i._mask=Math.pow(2,e)}t._activeLayers=2147483647,t._visibleLayers=2147483647,t._currentCameraCullingMask=2147483647,t.currentCreationLayer=t._layerList[0]},t.getLayerByNumber=function(e){if(0>e||e>30)throw new Error("无法返回指定Layer，该number超出范围！");return t._layerList[e]},t.getLayerByMask=function(e){for(var i=0;31>i;i++)if(t._layerList[i].mask===e)return t._layerList[i];throw new Error("无法返回指定Layer,该mask不存在")},t.getLayerByName=function(e){for(var i=0;31>i;i++)if(t._layerList[i].name===e)return t._layerList[i];throw new Error("无法返回指定Layer,该name不存在")},t.isActive=function(e){return 0!=(e&t._activeLayers)},t.isVisible=function(e){return 0!=(e&t._currentCameraCullingMask&t._visibleLayers)},t._uniqueIDCounter=1,t._layerCount=31,t._layerList=[],t._activeLayers=0,t._visibleLayers=0,t._currentCameraCullingMask=0,t.currentCreationLayer=null,t}(),H=function(){function t(t,e,i){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=t,this._minCount=e,this._maxCount=i}r(t,"laya.d3.core.particleShuriKen.module.Burst");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._time=this._time,e._minCount=this._minCount,e._maxCount=this._maxCount;
},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"time",function(){return this._time}),a(0,e,"minCount",function(){return this._minCount}),a(0,e,"maxCount",function(){return this._maxCount}),t}(),z=function(){function t(t){this._color=null,this.enbale=!1,this._color=t}r(t,"laya.d3.core.particleShuriKen.module.ColorOverLifetime");var e=t.prototype;return e.cloneTo=function(t){var e=t;this._color.cloneTo(e._color),e.enbale=this.enbale},e.clone=function(){var t;switch(this._color.type){case 0:t=Y.createByConstant(this._color.constant.clone());break;case 1:t=Y.createByGradient(this._color.gradient.clone());break;case 2:t=Y.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:t=Y.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},a(0,e,"color",function(){return this._color}),t}(),W=function(){function t(){this._destroyed=!1,this._emissionRate=0,this._minEmissionTime=NaN,this._particleSystem=null,this._shape=null,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}r(t,"laya.d3.core.particleShuriKen.module.Emission");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0,"laya.resource.IDestroy":!0}),e._destroy=function(){this._bursts=null,this._particleSystem=null,this._destroyed=!0},e.getBurstsCount=function(){return this._bursts.length},e.getBurstByIndex=function(t){return this._bursts[t]},e.addBurst=function(t){var e=this._bursts.length;if(e>0)for(var i=0;e>i;i++)this._bursts[i].time>t.time&&this._bursts.splice(i,0,t);this._bursts.push(t)},e.removeBurst=function(t){var e=this._bursts.indexOf(t);-1!==e&&this._bursts.splice(e,1)},e.removeBurstByIndex=function(t){this._bursts.splice(t,1)},e.clearBurst=function(){this._bursts.length=0},e.cloneTo=function(t){var e=t,i=e._bursts;i.length=this._bursts.length;for(var n=0,r=this._bursts.length;r>n;n++){var a=i[n];a?this._bursts[n].cloneTo(a):i[n]=this._bursts[n].clone()}e._minEmissionTime=this._minEmissionTime,e._emissionRate=this._emissionRate,e.enbale=this.enbale},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"destroyed",function(){return this._destroyed}),a(0,e,"emissionRate",function(){return this._emissionRate},function(t){if(0>t)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=t,0===t?this._minEmissionTime=2147483647:this._minEmissionTime=1/t}),t}(),G=function(){function t(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}r(t,"laya.d3.core.particleShuriKen.module.FrameOverTime");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._constant=this._constant,this._overTime.cloneTo(e._overTime),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._overTimeMin.cloneTo(e._overTimeMin),this._overTimeMax.cloneTo(e._overTimeMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"frameOverTimeData",function(){return this._overTime}),a(0,e,"constant",function(){return this._constant}),a(0,e,"type",function(){return this._type}),a(0,e,"frameOverTimeDataMin",function(){return this._overTimeMin}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"frameOverTimeDataMax",function(){return this._overTimeMax}),a(0,e,"constantMax",function(){return this._constantMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._constant=e,i},t.createByOverTime=function(e){var i=new t;return i._type=1,i._overTime=e,i},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=2,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoOverTime=function(e,i){var n=new t;return n._type=3,n._overTimeMin=e,n._overTimeMax=i,n},t}(),j=function(){function t(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}r(t,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._separateAxes=this._separateAxes,e._constant=this._constant,this._constantSeparate.cloneTo(e._constantSeparate),this._gradient.cloneTo(e._gradient),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(e._constantMinSeparate),this._constantMaxSeparate.cloneTo(e._constantMaxSeparate),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientZ",function(){return this._gradientZ}),a(0,e,"constant",function(){return this._constant}),a(0,e,"gradient",function(){return this._gradient}),a(0,e,"separateAxes",function(){return this._separateAxes}),a(0,e,"type",function(){return this._type}),a(0,e,"constantSeparate",function(){return this._constantSeparate}),a(0,e,"gradientX",function(){return this._gradientX}),a(0,e,"gradientY",function(){return this._gradientY}),a(0,e,"gradientW",function(){return this._gradientW}),a(0,e,"gradientMin",function(){return this._gradientMin}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"gradientMax",function(){return this._gradientMax}),a(0,e,"constantMax",function(){return this._constantMax}),a(0,e,"gradientWMin",function(){return this._gradientWMin}),a(0,e,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,e,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,e,"gradientXMin",function(){return this._gradientXMin}),a(0,e,"gradientXMax",function(){return this._gradientXMax}),a(0,e,"gradientWMax",function(){return this._gradientWMax}),a(0,e,"gradientYMin",function(){return this._gradientYMin}),a(0,e,"gradientYMax",function(){return this._gradientYMax}),a(0,e,"gradientZMin",function(){return this._gradientZMin}),a(0,e,"gradientZMax",function(){return this._gradientZMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._separateAxes=!1,i._constant=e,i},t.createByConstantSeparate=function(e){var i=new t;return i._type=0,i._separateAxes=!0,i._constantSeparate=e,i},t.createByGradient=function(e){var i=new t;return i._type=1,i._separateAxes=!1,i._gradient=e,i},t.createByGradientSeparate=function(e,i,n,r){var a=new t;return a._type=1,a._separateAxes=!0,a._gradientX=e,a._gradientY=i,a._gradientZ=n,a._gradientW=r,a},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=2,n._separateAxes=!1,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoConstantSeparate=function(e,i){var n=new t;return n._type=2,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=i,n},t.createByRandomTwoGradient=function(e,i){var n=new t;return n._type=3,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=i,n},t.createByRandomTwoGradientSeparate=function(e,i,n,r,a,s,o,h){var l=new t;return l._type=3,l._separateAxes=!0,l._gradientXMin=e,l._gradientXMax=i,l._gradientYMin=n,l._gradientYMax=r,l._gradientZMin=a,l._gradientZMax=s,l._gradientWMin=o,l._gradientWMax=h,l},t}(),Y=function(){function t(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}r(t,"laya.d3.core.particleShuriKen.module.GradientColor");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,this._constant.cloneTo(e._constant),this._constantMin.cloneTo(e._constantMin),this._constantMax.cloneTo(e._constantMax),this._gradient.cloneTo(e._gradient),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradient",function(){return this._gradient}),a(0,e,"constant",function(){return this._constant}),a(0,e,"type",function(){return this._type}),a(0,e,"gradientMin",function(){return this._gradientMin}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"gradientMax",function(){return this._gradientMax}),a(0,e,"constantMax",function(){return this._constantMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._constant=e,i},t.createByGradient=function(e){var i=new t;return i._type=1,i._gradient=e,i},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=2,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoGradient=function(e,i){var n=new t;return n._type=3,n._gradientMin=e,n._gradientMax=i,n},t}(),X=function(){function t(){this._alphaCurrentLength=0,this._rgbCurrentLength=0,this._alphaElements=null,this._rgbElements=null,this._alphaElements=new Float32Array(8),this._rgbElements=new Float32Array(16)}r(t,"laya.d3.core.particleShuriKen.module.GradientDataColor");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.addAlpha=function(t,e){this._alphaCurrentLength<8?(6===this._alphaCurrentLength&&1!==t&&(t=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._alphaElements[this._alphaCurrentLength++]=t,this._alphaElements[this._alphaCurrentLength++]=e):console.log("GradientDataColor warning:data count must lessEqual than 4")},e.addRGB=function(t,e){this._rgbCurrentLength<16?(12===this._rgbCurrentLength&&1!==t&&(t=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._rgbElements[this._rgbCurrentLength++]=t,this._rgbElements[this._rgbCurrentLength++]=e.x,this._rgbElements[this._rgbCurrentLength++]=e.y,this._rgbElements[this._rgbCurrentLength++]=e.z):console.log("GradientDataColor warning:data count must lessEqual than 4")},e.cloneTo=function(t){var e=t,i=0,n=0;e._alphaCurrentLength=this._alphaCurrentLength;var r=e._alphaElements;for(r.length=this._alphaElements.length,i=0,n=this._alphaElements.length;n>i;i++)r[i]=this._alphaElements[i];e._rgbCurrentLength=this._rgbCurrentLength;var a=e._rgbElements;for(a.length=this._rgbElements.length,i=0,n=this._rgbElements.length;n>i;i++)a[i]=this._rgbElements[i]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"alphaGradientCount",function(){return this._alphaCurrentLength/2}),a(0,e,"rgbGradientCount",function(){return this._rgbCurrentLength/4}),t}(),q=function(){function t(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(t,"laya.d3.core.particleShuriKen.module.GradientDataInt");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.add=function(t,e){this._currentLength<8?(6===this._currentLength&&1!==t&&(t=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=t,this._elements[this._currentLength++]=e):console.log("Warning:data count must lessEqual than 4")},e.cloneTo=function(t){var e=t;e._currentLength=this._currentLength;var i=e._elements;i.length=this._elements.length;for(var n=0,r=this._elements.length;r>n;n++)i[n]=this._elements[n]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientCount",function(){return this._currentLength/2}),t}(),K=function(){function t(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(t,"laya.d3.core.particleShuriKen.module.GradientDataNumber");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.add=function(t,e){this._currentLength<8?(6===this._currentLength&&1!==t&&(t=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=t,this._elements[this._currentLength++]=e):console.log("GradientDataNumber warning:data count must lessEqual than 4")},e.getKeyByIndex=function(t){return this._elements[2*t]},e.getValueByIndex=function(t){return this._elements[2*t+1]},e.getAverageValue=function(){for(var t=0,e=0,i=this._currentLength-2;i>e;e+=2){var n=this._elements[e+1];n+=this._elements[e+3],n*=this._elements[e+2]-this._elements[e]}return t/2},e.cloneTo=function(t){var e=t;e._currentLength=this._currentLength;var i=e._elements;i.length=this._elements.length;for(var n=0,r=this._elements.length;r>n;n++)i[n]=this._elements[n]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientCount",function(){return this._currentLength/2}),t}(),Z=(function(){function t(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12)}r(t,"laya.d3.core.particleShuriKen.module.GradientDataVector2");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.add=function(t,e){this._currentLength<8?(6===this._currentLength&&1!==t&&(t=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=t,this._elements[this._currentLength++]=e.x,this._elements[this._currentLength++]=e.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")},e.cloneTo=function(t){var e=t;e._currentLength=this._currentLength;var i=e._elements;i.length=this._elements.length;for(var n=0,r=this._elements.length;r>n;n++)i[n]=this._elements[n]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientCount",function(){return this._currentLength/3}),t}(),function(){function t(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(t,"laya.d3.core.particleShuriKen.module.GradientSize");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.getMaxSizeInGradient=function(){var t=0,e=0,i=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(t=0,e=this._gradientX.gradientCount;e>t;t++)i=Math.max(i,this._gradientX.getValueByIndex(t));for(t=0,e=this._gradientY.gradientCount;e>t;t++)i=Math.max(i,this._gradientY.getValueByIndex(t))}else for(t=0,e=this._gradient.gradientCount;e>t;t++)i=Math.max(i,this._gradient.getValueByIndex(t));break;case 1:this._separateAxes?(i=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),i=Math.max(i,this._constantMinSeparate.y),i=Math.max(i,this._constantMaxSeparate.y)):i=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(t=0,e=this._gradientXMin.gradientCount;e>t;t++)i=Math.max(i,this._gradientXMin.getValueByIndex(t));for(t=0,e=this._gradientXMax.gradientCount;e>t;t++)i=Math.max(i,this._gradientXMax.getValueByIndex(t));for(t=0,e=this._gradientYMin.gradientCount;e>t;t++)i=Math.max(i,this._gradientYMin.getValueByIndex(t));for(t=0,e=this._gradientZMax.gradientCount;e>t;t++)i=Math.max(i,this._gradientZMax.getValueByIndex(t))}else{for(t=0,e=this._gradientMin.gradientCount;e>t;t++)i=Math.max(i,this._gradientMin.getValueByIndex(t));for(t=0,e=this._gradientMax.gradientCount;e>t;t++)i=Math.max(i,this._gradientMax.getValueByIndex(t))}}return i},e.cloneTo=function(t){var e=t;e._type=this._type,e._separateAxes=this._separateAxes,this._gradient.cloneTo(e._gradient),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(e._constantMinSeparate),this._constantMaxSeparate.cloneTo(e._constantMaxSeparate),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientZ",function(){return this._gradientZ}),a(0,e,"gradient",function(){return this._gradient}),a(0,e,"separateAxes",function(){return this._separateAxes}),a(0,e,"type",function(){return this._type}),a(0,e,"gradientMin",function(){return this._gradientMin}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"gradientX",function(){return this._gradientX}),a(0,e,"gradientY",function(){return this._gradientY}),a(0,e,"gradientMax",function(){return this._gradientMax}),a(0,e,"constantMax",function(){return this._constantMax}),a(0,e,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,e,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,e,"gradientXMin",function(){return this._gradientXMin}),a(0,e,"gradientXMax",function(){return this._gradientXMax}),a(0,e,"gradientYMin",function(){return this._gradientYMin}),a(0,e,"gradientYMax",function(){return this._gradientYMax}),a(0,e,"gradientZMin",function(){return this._gradientZMin}),a(0,e,"gradientZMax",function(){return this._gradientZMax}),t.createByGradient=function(e){var i=new t;return i._type=0,i._separateAxes=!1,i._gradient=e,i},t.createByGradientSeparate=function(e,i,n){var r=new t;return r._type=0,r._separateAxes=!0,r._gradientX=e,r._gradientY=i,r._gradientZ=n,r},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=1,n._separateAxes=!1,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoConstantSeparate=function(e,i){var n=new t;return n._type=1,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=i,n},t.createByRandomTwoGradient=function(e,i){var n=new t;return n._type=2,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=i,n},t.createByRandomTwoGradientSeparate=function(e,i,n,r,a,s){var o=new t;return o._type=2,o._separateAxes=!0,o._gradientXMin=e,o._gradientXMax=i,o._gradientYMin=n,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},t}()),$=function(){function t(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(t,"laya.d3.core.particleShuriKen.module.GradientVelocity");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,this._constant.cloneTo(e._constant),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),this._constantMin.cloneTo(e._constantMin),this._constantMax.cloneTo(e._constantMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientZ",function(){return this._gradientZ}),a(0,e,"constant",function(){return this._constant}),a(0,e,"type",function(){return this._type}),a(0,e,"gradientXMax",function(){return this._gradientXMax}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"gradientX",function(){return this._gradientX}),a(0,e,"gradientY",function(){return this._gradientY}),a(0,e,"gradientXMin",function(){return this._gradientXMin}),a(0,e,"constantMax",function(){return this._constantMax}),a(0,e,"gradientYMin",function(){return this._gradientYMin}),a(0,e,"gradientYMax",function(){return this._gradientYMax}),a(0,e,"gradientZMin",function(){return this._gradientZMin}),a(0,e,"gradientZMax",function(){return this._gradientZMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._constant=e,i},t.createByGradient=function(e,i,n){var r=new t;return r._type=1,r._gradientX=e,r._gradientY=i,r._gradientZ=n,r},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=2,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoGradient=function(e,i,n,r,a,s){var o=new t;return o._type=3,o._gradientXMin=e,o._gradientXMax=i,o._gradientYMin=n,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},t}(),Q=function(){function t(t){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=t}r(t,"laya.d3.core.particleShuriKen.module.RotationOverLifetime");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._angularVelocity.cloneTo(e._angularVelocity),e.enbale=this.enbale},e.clone=function(){var t;switch(this._angularVelocity.type){case 0:t=this._angularVelocity.separateAxes?j.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):j.createByConstant(this._angularVelocity.constant);break;case 1:t=this._angularVelocity.separateAxes?j.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone(),this._angularVelocity.gradientW.clone()):j.createByGradient(this._angularVelocity.gradient.clone());break;case 2:t=this._angularVelocity.separateAxes?j.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):j.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:t=this._angularVelocity.separateAxes?j.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):j.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},a(0,e,"angularVelocity",function(){return this._angularVelocity}),t}(),J=function(){function t(){this.enable=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.BaseShape");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e._getShapeBoundBox=function(t){throw new Error("BaseShape: must override it.")},e._getSpeedBoundBox=function(t){throw new Error("BaseShape: must override it.")},e.generatePositionAndDirection=function(t,e,i,n){throw new Error("BaseShape: must override it.")},e._calculateProceduralBounds=function(t,e,i){this._getShapeBoundBox(t);var n=t.min,r=t.max;_e.multiply(n,e,n),_e.multiply(r,e,r);var a=new Jt(new _e,new _e);this.randomDirection?(a.min=new _e(-1,-1,-1),a.max=new _e(1,1,1)):this._getSpeedBoundBox(a);var s=new Jt(new _e,new _e),o=s.min,h=s.max;_e.scale(a.min,i.y,o),_e.scale(a.max,i.y,h),_e.add(t.min,o,o),_e.add(t.max,h,h),_e.min(t.min,o,t.min),_e.max(t.max,o,t.max);var l=new Jt(new _e,new _e),u=l.min,c=l.max;_e.scale(a.min,i.x,u),_e.scale(a.max,i.x,c),_e.min(l.min,c,o),_e.max(l.min,c,h),_e.min(t.min,o,t.min),_e.max(t.max,o,t.max)},e.cloneTo=function(t){var e=t;e.enable=this.enable},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},t}(),tt=function(){function t(){}return r(t,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),t._randomPointUnitArcCircle=function(t,e,i){var n=e.elements,r=NaN;r=i?i.getFloat()*t:Math.random()*t,n[0]=Math.cos(r),n[1]=Math.sin(r)},t._randomPointInsideUnitArcCircle=function(e,i,n){var r=i.elements;t._randomPointUnitArcCircle(e,i,n);var a=NaN;a=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),r[0]=r[0]*a,r[1]=r[1]*a},t._randomPointUnitCircle=function(t,e){var i=t.elements,n=NaN;n=e?e.getFloat()*Math.PI*2:Math.random()*Math.PI*2,i[0]=Math.cos(n),i[1]=Math.sin(n)},t._randomPointInsideUnitCircle=function(e,i){var n=e.elements;t._randomPointUnitCircle(e);var r=NaN;r=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),n[0]=n[0]*r,n[1]=n[1]*r},t._randomPointUnitSphere=function(t,e){var i=t.elements,n=NaN,r=NaN;e?(n=i[2]=2*e.getFloat()-1,r=e.getFloat()*Math.PI*2):(n=i[2]=2*Math.random()-1,r=Math.random()*Math.PI*2);var a=Math.sqrt(1-n*n);i[0]=a*Math.cos(r),i[1]=a*Math.sin(r)},t._randomPointInsideUnitSphere=function(e,i){var n=e.elements;t._randomPointUnitSphere(e);var r=NaN;r=i?Math.pow(i.getFloat(),1/3):Math.pow(Math.random(),1/3),n[0]=n[0]*r,n[1]=n[1]*r,n[2]=n[2]*r},t._randomPointInsideHalfUnitBox=function(t,e){var i=t.elements;e?(i[0]=e.getFloat()-.5,i[1]=e.getFloat()-.5,i[2]=e.getFloat()-.5):(i[0]=Math.random()-.5,i[1]=Math.random()-.5,i[2]=Math.random()-.5)},t}(),et=function(){function t(t){this._size=null,this.enbale=!1,this._size=t}r(t,"laya.d3.core.particleShuriKen.module.SizeOverLifetime");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._size.cloneTo(e._size),e.enbale=this.enbale},e.clone=function(){var t;switch(this._size.type){case 0:t=this._size.separateAxes?Z.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):Z.createByGradient(this._size.gradient.clone());break;case 1:t=this._size.separateAxes?Z.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):Z.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:t=this._size.separateAxes?Z.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):Z.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},a(0,e,"size",function(){return this._size}),t}(),it=function(){function t(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN}r(t,"laya.d3.core.particleShuriKen.module.StartFrame");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._constant=this._constant,e._constantMin=this._constantMin,e._constantMax=this._constantMax},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"constant",function(){return this._constant}),a(0,e,"type",function(){return this._type}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"constantMax",function(){return this._constantMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._constant=e,i},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=1,n._constantMin=e,n._constantMax=i,n},t}(),nt=function(){function t(t,e){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new ce(1,1),this.type=0,this.randomRow=!0,this.cycles=1,this.enableUVChannels=1,this._frame=t,this._startFrame=e}r(t,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this.tiles.cloneTo(e.tiles),e.type=this.type,e.randomRow=this.randomRow,this._frame.cloneTo(e._frame),this._startFrame.cloneTo(e._startFrame),e.cycles=this.cycles,e.enableUVChannels=this.enableUVChannels,e.enable=this.enable},e.clone=function(){var t;switch(this._frame.type){case 0:t=G.createByConstant(this._frame.constant);break;case 1:t=G.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:t=G.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:t=G.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}var e;switch(this._startFrame.type){case 0:e=it.createByConstant(this._startFrame.constant);break;case 1:e=it.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var i=new this.constructor(t,e);return this.tiles.cloneTo(i.tiles),i.type=this.type,i.randomRow=this.randomRow,i.cycles=this.cycles,i.enableUVChannels=this.enableUVChannels,i.enable=this.enable,i},a(0,e,"frame",function(){return this._frame}),a(0,e,"startFrame",function(){return this._startFrame}),t}(),rt=function(){function t(t){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=t}r(t,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._velocity.cloneTo(e._velocity),e.enbale=this.enbale,e.space=this.space},e.clone=function(){var t;switch(this._velocity.type){case 0:t=$.createByConstant(this._velocity.constant.clone());break;case 1:t=$.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:t=$.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:t=$.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e.space=this.space,e},a(0,e,"velocity",function(){return this._velocity}),t}(),at=function(){function t(){}return r(t,"laya.d3.core.particleShuriKen.ShurikenParticleData"),t._getStartLifetimeFromGradient=function(t,e){for(var i=1,n=t.gradientCount;n>i;i++){var r=t.getKeyByIndex(i);if(r>=e){var a=t.getKeyByIndex(i-1),s=(e-a)/(r-a);return S.lerp(t.getValueByIndex(i-1),t.getValueByIndex(i),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},t._randomInvertRoationArray=function(t,e,i,n,r){var a=NaN;n?(n.seed=r[6],a=n.getFloat(),r[6]=n.seed):a=Math.random(),i>a?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])},t._randomInvertRoation=function(t,e,i,n){var r=NaN;return i?(i.seed=n[6],r=i.getFloat(),n[6]=i.seed):r=Math.random(),e>r&&(t=-t),t},t.create=function(e,i,n){var r=e.autoRandomSeed,a=e._rand,s=e._randomSeeds;switch(e.startColorType){case 0:var o=e.startColorConstant.elements;t.startColor[0]=o[0],t.startColor[1]=o[1],t.startColor[2]=o[2],t.startColor[3]=o[3];break;case 2:r?S.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,Math.random(),t.startColor):(a.seed=s[3],S.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,a.getFloat(),t.startColor),s[3]=a.seed)}var h=e.colorOverLifetime;if(h&&h.enbale){var l=h.color;switch(l.type){case 0:t.startColor[0]=t.startColor[0]*l.constant.x,t.startColor[1]=t.startColor[1]*l.constant.y,t.startColor[2]=t.startColor[2]*l.constant.z,t.startColor[3]=t.startColor[3]*l.constant.w;break;case 2:var u=NaN;r?u=Math.random():(a.seed=s[10],u=a.getFloat(),s[10]=a.seed);var c=l.constantMin,_=l.constantMax;t.startColor[0]=t.startColor[0]*S.lerp(c.x,_.x,u),t.startColor[1]=t.startColor[1]*S.lerp(c.y,_.y,u),t.startColor[2]=t.startColor[2]*S.lerp(c.z,_.z,u),t.startColor[3]=t.startColor[3]*S.lerp(c.w,_.w,u)}}var d=t.startSize;switch(e.startSizeType){case 0:if(e.threeDStartSize){var f=e.startSizeConstantSeparate;d[0]=f.x,d[1]=f.y,d[2]=f.z}else d[0]=d[1]=d[2]=e.startSizeConstant;break;
case 2:if(e.threeDStartSize){var p=e.startSizeConstantMinSeparate,m=e.startSizeConstantMaxSeparate;r?(d[0]=S.lerp(p.x,m.x,Math.random()),d[1]=S.lerp(p.y,m.y,Math.random()),d[2]=S.lerp(p.z,m.z,Math.random())):(a.seed=s[4],d[0]=S.lerp(p.x,m.x,a.getFloat()),d[1]=S.lerp(p.y,m.y,a.getFloat()),d[2]=S.lerp(p.z,m.z,a.getFloat()),s[4]=a.seed)}else r?d[0]=d[1]=d[2]=S.lerp(e.startSizeConstantMin,e.startSizeConstantMax,Math.random()):(a.seed=s[4],d[0]=d[1]=d[2]=S.lerp(e.startSizeConstantMin,e.startSizeConstantMax,a.getFloat()),s[4]=a.seed)}var g=e.sizeOverLifetime;if(g&&g.enbale&&1===g.size.type){var y=g.size;if(y.separateAxes)r?(d[0]=d[0]*S.lerp(y.constantMinSeparate.x,y.constantMaxSeparate.x,Math.random()),d[1]=d[1]*S.lerp(y.constantMinSeparate.y,y.constantMaxSeparate.y,Math.random()),d[2]=d[2]*S.lerp(y.constantMinSeparate.z,y.constantMaxSeparate.z,Math.random())):(a.seed=s[11],d[0]=d[0]*S.lerp(y.constantMinSeparate.x,y.constantMaxSeparate.x,a.getFloat()),d[1]=d[1]*S.lerp(y.constantMinSeparate.y,y.constantMaxSeparate.y,a.getFloat()),d[2]=d[2]*S.lerp(y.constantMinSeparate.z,y.constantMaxSeparate.z,a.getFloat()),s[11]=a.seed);else{var x=NaN;r?x=S.lerp(y.constantMin,y.constantMax,Math.random()):(a.seed=s[11],x=S.lerp(y.constantMin,y.constantMax,a.getFloat()),s[11]=a.seed),d[0]=d[0]*x,d[1]=d[1]*x,d[2]=d[2]*x}}var v=i.renderMode;if(1!==v)switch(e.startRotationType){case 0:if(e.threeDStartRotation){var T=e.startRotationConstantSeparate,E=t._tempVector30.elements;t._randomInvertRoationArray(T.elements,E,e.randomizeRotationDirection,r?null:a,s),t.startRotation[0]=E[0],t.startRotation[1]=E[1],4!==v?t.startRotation[2]=-E[2]:t.startRotation[2]=E[2]}else t.startRotation[0]=t._randomInvertRoation(e.startRotationConstant,e.randomizeRotationDirection,r?null:a,s);break;case 2:if(e.threeDStartRotation){var w=e.startRotationConstantMinSeparate,b=e.startRotationConstantMaxSeparate,C=t._tempVector30.elements;r?(C[0]=S.lerp(w.x,b.x,Math.random()),C[1]=S.lerp(w.y,b.y,Math.random()),C[2]=S.lerp(w.z,b.z,Math.random())):(a.seed=s[5],C[0]=S.lerp(w.x,b.x,a.getFloat()),C[1]=S.lerp(w.y,b.y,a.getFloat()),C[2]=S.lerp(w.z,b.z,a.getFloat()),s[5]=a.seed),t._randomInvertRoationArray(C,C,e.randomizeRotationDirection,r?null:a,s),t.startRotation[0]=C[0],t.startRotation[1]=C[1],4!==v?t.startRotation[2]=-C[2]:t.startRotation[2]=C[2]}else r?t.startRotation[0]=t._randomInvertRoation(S.lerp(e.startRotationConstantMin,e.startRotationConstantMax,Math.random()),e.randomizeRotationDirection,r?null:a,s):(a.seed=s[5],t.startRotation[0]=t._randomInvertRoation(S.lerp(e.startRotationConstantMin,e.startRotationConstantMax,a.getFloat()),e.randomizeRotationDirection,r?null:a,s),s[5]=a.seed)}switch(e.startLifetimeType){case 0:t.startLifeTime=e.startLifetimeConstant;break;case 1:t.startLifeTime=t._getStartLifetimeFromGradient(e.startLifeTimeGradient,e.emissionTime);break;case 2:r?t.startLifeTime=S.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,Math.random()):(a.seed=s[7],t.startLifeTime=S.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,a.getFloat()),s[7]=a.seed);break;case 3:var M=e.emissionTime;r?t.startLifeTime=S.lerp(t._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,M),t._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,M),Math.random()):(a.seed=s[7],t.startLifeTime=S.lerp(t._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,M),t._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,M),a.getFloat()),s[7]=a.seed)}switch(e.startSpeedType){case 0:t.startSpeed=e.startSpeedConstant;break;case 2:r?t.startSpeed=S.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,Math.random()):(a.seed=s[8],t.startSpeed=S.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,a.getFloat()),s[8]=a.seed)}var D=e.textureSheetAnimation,A=D&&D.enable;if(A){var R=D.tiles,I=R.x,P=R.y,L=1/I,N=1/P,O=0,V=0,F=D.randomRow;switch(D.type){case 0:O=I*P;break;case 1:O=I,F?r?V=Math.round(Math.random()*P):(a.seed=s[13],V=Math.round(a.getFloat()*P),s[13]=a.seed):V=0}var B=0,U=D.startFrame;switch(U.type){case 0:B=U.constant;break;case 1:r?B=Math.round(S.lerp(U.constantMin,U.constantMax,Math.random())):(a.seed=s[14],B=Math.round(S.lerp(U.constantMin,U.constantMax,a.getFloat())),s[14]=a.seed)}var k=D.frame;switch(k.type){case 0:B+=k.constant;break;case 2:r?B+=Math.round(S.lerp(k.constantMin,k.constantMax,Math.random())):(a.seed=s[15],B+=Math.round(S.lerp(k.constantMin,k.constantMax,a.getFloat())),s[15]=a.seed)}F||(V=Math.floor(B/I));var H=B%I;t.startUVInfo=t.startUVInfo,t.startUVInfo[0]=L,t.startUVInfo[1]=N,t.startUVInfo[2]=H*L,t.startUVInfo[3]=V*N}else t.startUVInfo=t.startUVInfo,t.startUVInfo[0]=1,t.startUVInfo[1]=1,t.startUVInfo[2]=0,t.startUVInfo[3]=0;switch(e.simulationSpace){case 0:var z=n.position.elements;t.simulationWorldPostion[0]=z[0],t.simulationWorldPostion[1]=z[1],t.simulationWorldPostion[2]=z[2];var W=n.rotation.elements;t.simulationWorldRotation[0]=W[0],t.simulationWorldRotation[1]=W[1],t.simulationWorldRotation[2]=W[2],t.simulationWorldRotation[3]=W[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}},t.startLifeTime=NaN,t.startSpeed=NaN,n(t,["_tempVector30",function(){return this._tempVector30=new _e},"_tempQuaternion",function(){return this._tempQuaternion=new he},"startColor",function(){return this.startColor=new Float32Array(4)},"startSize",function(){return this.startSize=new Float32Array(3)},"startRotation",function(){return this.startRotation=new Float32Array(3)},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4)},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3)},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4)}]),t}(),st=function(){function t(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._camera=null,this._sharderNameID=0,this._shader=null,this._shaderCompile=null,this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._spriteShaderValue=new ye,this._vb=Si.create(t._vertexDeclaration,this._defaultBufferSize/this._floatSizePerVer,35048),this._ib=vi.create("ushort",this._defaultBufferSize,35048),this._sharderNameID=di.nameKey.getID("LINE"),this._shaderCompile=me._preCompileShader[this._sharderNameID]}r(t,"laya.d3.core.PhasorSpriter3D");var e=t.prototype;return e.line=function(t,e,i,n){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t.x,t.y,t.z,e.x,e.y,e.z,e.w),this.addVertex(i.x,i.y,i.z,n.x,n.y,n.z,n.w),this.addIndexes(this._tempUint0,this._tempUint0+1),this},e.circle=function(t,e,i,n,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*e,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/e,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*t,Math.cos(this._tempNumver0)*t,0,i,n,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},e.plane=function(t,e,i,n,r,a,s,o,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=n/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i,a,s,o,h),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i,a,s,o,h),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i,a,s,o,h),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i,a,s,o,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},e.box=function(t,e,i,n,r,a,s,o,h,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=n/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i+this._tempNumver2,s,o,h,l),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i+this._tempNumver2,s,o,h,l),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i+this._tempNumver2,s,o,h,l),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i+this._tempNumver2,s,o,h,l),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i-this._tempNumver2,s,o,h,l),this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i-this._tempNumver2,s,o,h,l),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i-this._tempNumver2,s,o,h,l),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i-this._tempNumver2,s,o,h,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},e.cone=function(t,e,i,n,r,a,s){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*i+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*i>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/i,this.addVertexIndex(0,e,0,n,r,a,s,this._tempUint0),this.addVertexIndex(0,0,0,n,r,a,s,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<i;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(t*this._tempNumver2,0,t*this._tempNumver3,n,r,a,s,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==i-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(t*this._tempNumver2,0,t*this._tempNumver3,n,r,a,s,this._tempUint0+(this._tempInt0+i)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==i-1?this.addIndexes(this._tempUint1+i+2):this.addIndexes(this._tempUint1+this._tempInt0+i+1),this.addIndexes(this._tempUint1+this._tempInt0+i),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},e.boundingBoxLine=function(t,e,i,n,r,a,s,o,h,l){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t,r,a,s,o,h,l),this.addVertex(n,r,a,s,o,h,l),this.addVertex(t,e,a,s,o,h,l),this.addVertex(n,e,a,s,o,h,l),this.addVertex(n,r,i,s,o,h,l),this.addVertex(t,r,i,s,o,h,l),this.addVertex(n,e,i,s,o,h,l),this.addVertex(t,e,i,s,o,h,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},e.addVertex=function(t,e,i,n,r,a,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=t,this._vbData[this._posInVBData+1]=e,this._vbData[this._posInVBData+2]=i,this._vbData[this._posInVBData+3]=n,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=s,this._posInVBData+=this._floatSizePerVer,this},e.addVertexIndex=function(t,e,i,n,r,a,s,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[o]=t,this._vbData[o+1]=e,this._vbData[o+2]=i,this._vbData[o+3]=n,this._vbData[o+4]=r,this._vbData[o+5]=a,this._vbData[o+6]=s,o+=this._floatSizePerVer,o>this._posInVBData&&(this._posInVBData=o),this},e.addIndexes=function(t){var e=arguments;this._hasBegun||this.addVertexIndexException();for(var i=0;i<e.length;i++)this._ibData[this._posInIBData]=e[i],this._posInIBData++;return this},e.begin=function(t,e){return this._hasBegun&&this.beginException0(),1!==t&&4!==t&&this.beginException1(),this._primitiveType=t,this._camera=e,this._hasBegun=!0,this},e.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},e.flush=function(){0!==this._posInVBData&&(this._ib.setData(this._ibData),this._vb.setData(this._vbData),this._vb._bind(),this._ib._bind(),this._shader=this._shaderCompile.withCompile(0,0,0),this._shader.bind(),this._shader.uploadAttributes(t._vertexDeclaration.shaderValues.data,null),this._spriteShaderValue.setValue(1,this._camera.projectionViewMatrix.elements),this._shader.uploadSpriteUniforms(this._spriteShaderValue.data),D.drawCall++,P.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0)},e.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},e.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},e.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},e.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},e.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},e.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(28,[new gt(0,"vector3",0),new gt(12,"vector4",1)])}]),t}(),ot=function(){function t(){this._id=0,this._type=0,this._mainSortID=0,this._render=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._tempBatchIndexStart=0,this._tempBatchIndexEnd=0,this._canDynamicBatch=!1,this._shaderValue=null,this._onPreRenderFunction=null,this._conchSubmesh=null,this._id=++t._uniqueIDCounter,this._canDynamicBatch=!0,this._shaderValue=new ye,E.isConchNode&&(this._conchSubmesh=new ConchSubmesh)}r(t,"laya.d3.core.render.RenderElement");var e=t.prototype;return e.getDynamicBatchBakedVertexs=function(t){for(var e=4,i=this._renderObj._getVertexBuffer(t),n=i.getData().slice(),r=i.vertexDeclaration,a=r.getVertexElementByUsage(0).offset/e,s=r.getVertexElementByUsage(3).offset/e,o=this._sprite3D.transform,h=o.worldMatrix,l=o.rotation,u=r.vertexStride/e,c=0,_=n.length;_>c;c+=u){var d=c+a,f=c+s;De.transformVector3ArrayToVector3ArrayCoordinate(n,d,h,n,d),De.transformVector3ArrayByQuat(n,f,l,n,f)}return n},e.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},e._destroy=function(){this._staticBatch&&this._staticBatch._manager._garbageCollection(this)},a(0,e,"id",function(){return this._id}),a(0,e,"renderObj",function(){return this._renderObj},function(t){this._renderObj!==t&&(this._renderObj=t)}),t._uniqueIDCounter=0,t}(),ht=function(){function t(e){this._id=0,this._needSort=!1,this._renderElements=null,this._renderableRenderObjects=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++t._uniqueIDCounter,this._needSort=!1,this._scene=e,this._renderElements=[],this._renderableRenderObjects=[],this._dynamicBatchCombineRenderElements=[]}r(t,"laya.d3.core.render.RenderQueue");var e=t.prototype;return e._sortOpaqueFunc=function(t,e){return t._render&&e._render?t._render._distanceForSort-e._render._distanceForSort:0},e._sortAlphaFunc=function(t,e){return t._render&&e._render?e._render._distanceForSort-t._render._distanceForSort:0},e._begainRenderElement=function(t,e,i){return e._beforeRender(t)?!0:!1},e._preRenderUpdateComponents=function(t,e){for(var i=0;i<t.componentsCount;i++){var n=t.getComponentByIndex(i);!n.started&&(n._start(e),n.started=!0),n.enable&&n._preRenderUpdate(e)}},e._postRenderUpdateComponents=function(t,e){for(var i=0;i<t.componentsCount;i++){var n=t.getComponentByIndex(i);!n.started&&(n._start(e),n.started=!0),n.enable&&n._postRenderUpdate(e)}},e._sortAlpha=function(e){t._cameraPosition=e,this._finalElements.sort(this._sortAlphaFunc)},e._sortOpaque=function(e){t._cameraPosition=e,this._finalElements.sort(this._sortOpaqueFunc)},e._preRender=function(t){this._finalElements=this._renderElements.concat(this._dynamicBatchCombineRenderElements)},e._render=function(t,e){for(var i,n,r,a,s,o=D.loopCount,h=this._scene,l=t.camera,u=(l.id,!1),c=0,_=this._finalElements.length;_>c;c++){var d,f,p,m=this._finalElements[c];if(null!=m._onPreRenderFunction&&m._onPreRenderFunction.call(m._sprite3D,t),0===m._type)t.owner=p=m._sprite3D,t.renderElement=m,this._preRenderUpdateComponents(p,t),d=m.renderObj,f=m._material,this._begainRenderElement(t,d,f)&&(i=d._getVertexBuffer(0),n=i.vertexDeclaration,r=t._shader=f._getShader(h._shaderDefineValue,n.shaderDefineValue,p._shaderDefineValue),u=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==i||u)&&(r.uploadAttributes(n.shaderValues.data,null),r._uploadVertexBuffer=i),(r._uploadScene!==h||u)&&(r.uploadSceneUniforms(h._shaderValues.data),r._uploadScene=h),(l!==r._uploadCamera||r._uploadSprite3D!==p||u)&&(r.uploadSpriteUniforms(p._shaderValues.data),r._uploadSprite3D=p),(l!==r._uploadCamera||u)&&(r.uploadCameraUniforms(l._shaderValues.data),r._uploadCamera=l),(r._uploadMaterial!==f||u)&&(f._upload(),r._uploadMaterial=f),a!==f?(f._setRenderStateBlendDepth(),f._setRenderStateFrontFace(e,p.transform),a=f,s=p):s!==p&&(f._setRenderStateFrontFace(e,p.transform),s=p),d._render(t),r._uploadLoopCount=o),this._postRenderUpdateComponents(p,t);else if(2===m._type){m.renderObj;t.owner=p=m._sprite3D,t.renderElement=m,t._batchIndexStart=m._tempBatchIndexStart,t._batchIndexEnd=m._tempBatchIndexEnd,d=m.renderObj,f=m._material,this._begainRenderElement(t,d,f)&&(i=d._getVertexBuffer(0),n=i.vertexDeclaration,r=t._shader=f._getShader(h._shaderDefineValue,n.shaderDefineValue,p._shaderDefineValue),u=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==i||u)&&(r.uploadAttributes(n.shaderValues.data,null),r._uploadVertexBuffer=i),(r._uploadScene!==h||u)&&(r.uploadSceneUniforms(h._shaderValues.data),r._uploadScene=h),(l!==r._uploadCamera||r._uploadSprite3D!==p||u)&&(r.uploadSpriteUniforms(p._shaderValues.data),r._uploadSprite3D=p),(l!==r._uploadCamera||u)&&(r.uploadCameraUniforms(l._shaderValues.data),r._uploadCamera=l),(r._uploadMaterial!==f||u)&&(f._upload(),r._uploadMaterial=f),a!==f?(f._setRenderStateBlendDepth(),f._setRenderStateFrontFace(e,p.transform),a=f,s=p):s!==p&&(f._setRenderStateFrontFace(e,p.transform),s=p),d._render(t),r._uploadLoopCount=o)}}},e._renderShadow=function(t,e){for(var i,n,r,a,s,o=D.loopCount,h=this._scene,l=t.camera,u=!1,c=0,_=this._finalElements.length;_>c;c++){var d,f,p,m=this._finalElements[c];0===m._type&&(t.owner=p=m._sprite3D,e||p._projectionViewWorldUpdateCamera===l&&p._projectionViewWorldUpdateLoopCount===D.loopCount||(p._render._renderUpdate(t._projectionViewMatrix),p._projectionViewWorldUpdateLoopCount=D.loopCount,p._projectionViewWorldUpdateCamera=l),t.renderElement=m,this._preRenderUpdateComponents(p,t),d=m.renderObj,f=m._material,this._begainRenderElement(t,d,null)&&(i=d._getVertexBuffer(0),n=i.vertexDeclaration,r=t._shader=f._getShader(h._shaderDefineValue,n.shaderDefineValue,p._shaderDefineValue),u=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==i||u)&&(r.uploadAttributes(n.shaderValues.data,null),r._uploadVertexBuffer=i),(l!==r._uploadCamera||r._uploadSprite3D!==p||u)&&(r.uploadSpriteUniforms(p._shaderValues.data),r._uploadSprite3D=p),(l!==r._uploadCamera||u)&&(r.uploadCameraUniforms(l._shaderValues.data),r._uploadCamera=l),(r._uploadMaterial!==f||u)&&(f._upload(),r._uploadMaterial=f),r._uploadRenderElement!==m||u,a!==f?(f._setRenderStateFrontFace(!1,p.transform),a=f,s=p):s!==p&&(f._setRenderStateFrontFace(!1,p.transform),s=p),d._render(t),r._uploadLoopCount=o),this._postRenderUpdateComponents(p,t))}},e._clearRenderElements=function(){this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},e._addRenderElement=function(t){this._renderElements.push(t),this._needSort=!0},e._addDynamicBatchElement=function(t){this._dynamicBatchCombineRenderElements.push(t)},a(0,e,"id",function(){return this._id}),t._uniqueIDCounter=0,t.OPAQUE=1,t.TRANSPARENT=2,t._cameraPosition=null,t}(),lt=function(){function t(){this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this._viewMatrix=null,this._projectionMatrix=null,this._projectionViewMatrix=null,this._viewport=null,this._boundFrustum=null,this._shader=null,this.elapsedTime=NaN,this.scene=null,this.owner=null,this.renderElement=null,this.camera=null,this.cameraBoundingFrustum=null}return r(t,"laya.d3.core.render.RenderState"),t.clientWidth=0,t.clientHeight=0,t}(),ut=function(){function t(t,e){this._exactBox=null,this._relaxBox=null,this._corners=[new _e,new _e,new _e,new _e,new _e,new _e,new _e,new _e],this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new ee(new _e,0),this._boundingBoxCenter=new _e,this._children=s(8),this._objects=[],this._tempBoundBoxCorners=[],this._scene=t,this._currentDepth=e}r(t,"laya.d3.core.scene.OctreeNode");var e=t.prototype;return i.imps(e,{"laya.d3.core.scene.ITreeNode":!0}),e.init=function(t,e){var i=new _e,n=new _e;_e.scale(e,-.5,i),_e.scale(e,.5,n),_e.add(i,t,i),_e.add(n,t,n),this.exactBox=new Jt(i,n),this.relaxBox=new Jt(i,n)},e.addTreeNode=function(t){1===ie.boxContainsBox(this._relaxBox,t.boundingBox)?this.addNodeDown(t,0):this.addObject(t)},e.addChild=function(e){var i=this._children[e];if(null==i){i=new t(this._scene,this._currentDepth+1),this._children[e]=i,i._parent=this,_e.subtract(this._exactBox.max,this._exactBox.min,t.tempSize),_e.multiply(t.tempSize,t._octreeSplit[e],t.tempCenter),_e.add(this._exactBox.min,t.tempCenter,t.tempCenter),_e.scale(t.tempSize,.25,t.tempSize);var n=new _e,r=new _e;_e.subtract(t.tempCenter,t.tempSize,n),_e.add(t.tempCenter,t.tempSize,r),i.exactBox=new Jt(n,r),_e.scale(t.tempSize,t.relax,t.tempSize);var a=new _e,s=new _e;_e.subtract(t.tempCenter,t.tempSize,a),_e.add(t.tempCenter,t.tempSize,s),i.relaxBox=new Jt(a,s)}return i},e.addObject=function(t){t._treeNode=this,this._objects.push(t)},e.removeObject=function(t){if(t._treeNode!=this)return console.log("OctreeNode::removeObject error"),!1;var e=this._objects.indexOf(t);return-1!==e?(this._objects.splice(e,1),!0):!1},e.clearObject=function(){this._objects.length=0},e.addNodeUp=function(t,e){this._parent&&1!==ie.boxContainsBox(this._exactBox,t.boundingBox)?this._parent.addNodeUp(t,e-1):this.addNodeDown(t,e)},e.addNodeDown=function(t,e){if(e<this._scene.treeLevel){var i=this.inChildIndex(t.boundingBoxCenter),n=this.addChild(i);1===ie.boxContainsBox(n._relaxBox,t.boundingBox)?n.addNodeDown(t,++e):this.addObject(t)}else this.addObject(t)},e.inChildIndex=function(t){var e=t.z<this._boundingBoxCenter.z?0:1,i=t.y<this._boundingBoxCenter.y?0:1,n=t.x<this._boundingBoxCenter.x?0:1;return 4*e+2*i+n},e.updateObject=function(t){1===ie.boxContainsBox(this._relaxBox,t.boundingBox)?(this.removeObject(t),t._treeNode=null,this.addNodeDown(t,this._currentDepth)):this._parent&&(this.removeObject(t),t._treeNode=null,this._parent.addNodeUp(t,this._currentDepth-1))},e.cullingObjects=function(t,e,i,n,r){var a=0,s=0,o=0,h=0,l=this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;o>a;a++){var u=this._objects[a];if(k.isVisible(u._owner.layer.mask)&&u.enable){if(e&&(D.treeSpriteCollision+=1,0===t.containsBoundSphere(u.boundingSphere)))continue;u._renderUpdate(r),u._distanceForSort=_e.distance(u.boundingSphere.center,n)+u.sortingFudge;var c=u._renderElements;for(s=0,h=c.length;h>s;s++){var _=c[s],d=_._staticBatch;if(d&&d._material===_._material)d._addBatchRenderElement(_);else{var f=_.renderObj;f.triangleCount<20&&1===f._vertexBufferCount&&f._getIndexBuffer()&&_._material.renderQueue<2&&_._canDynamicBatch&&!u._owner.isStatic?l._addPrepareRenderElement(_):this._scene.getRenderQueue(_._material.renderQueue)._addRenderElement(_)}}}}for(a=0;8>a;a++){var p=this._children[a];if(null!=p){var m=e;if(e){var g=t.containsBoundBox(p._relaxBox);if(D.treeNodeCollision+=1,0===g)continue;m=2===g}p.cullingObjects(t,m,i,n,r)}}},e.cullingShadowObjects=function(t,e,i,n,r){var a=0,s=0,o=0,h=0;this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;o>a;a++){var l=this._objects[a];if(l.castShadow&&k.isVisible(l._owner.layer.mask)&&l.enable){if(i&&0===t[0].containsBoundSphere(l.boundingSphere))continue;for(var u=1,c=t.length;c>u;u++){var _=e[u-1];if(0!==t[u].containsBoundSphere(l.boundingSphere)){var d=l._renderElements;for(s=0,h=d.length;h>s;s++)_._addRenderElement(d[s])}}}}for(a=0;8>a;a++){var f=this._children[a];if(null!=f){var p=i;if(i){var m=t[0].containsBoundBox(f._relaxBox);if(0===m)continue;p=2===m}f.cullingShadowObjects(t,e,p,n,r)}}},e.cullingShadowObjectsOnePSSM=function(t,e,i,n,r,a){var s=e[0],o=0,h=0,l=0,u=0;for(o=0,l=this._objects.length;l>o;o++){var c=this._objects[o];if(c.castShadow&&k.isVisible(c._owner.layer.mask)&&c.enable){if(n&&0===t.containsBoundSphere(c.boundingSphere))continue;c._renderUpdate(i);var _=c._renderElements;for(h=0,u=_.length;u>h;h++)s._addRenderElement(_[h])}}for(o=0;8>o;o++){var d=this._children[o];if(null!=d){var f=n;if(n){var p=t.containsBoundBox(d._relaxBox);if(0===p)continue;f=2===p}d.cullingShadowObjectsOnePSSM(t,e,i,f,r,a)}}},e.renderBoudingBox=function(t){this._renderBoudingBox(t);for(var e=0;8>e;++e){var i=this._children[e];i&&i.renderBoudingBox(t)}},e.buildAllChild=function(t){if(t<this._scene.treeLevel)for(var e=0;8>e;e++){var i=this.addChild(e);i.buildAllChild(t+1)}},e._renderBoudingBox=function(t){},a(0,e,"exactBox",function(){return this._exactBox},function(t){this._exactBox=t,_e.add(t.min,t.max,this._boundingBoxCenter),_e.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),a(0,e,"relaxBox",function(){return this._relaxBox},function(t){this._relaxBox=t,t.getCorners(this._corners),ee.createfromPoints(this._corners,this._boundingSphere)}),t.debugMode=!1,t.relax=1.15,t.CHILDNUM=8,n(t,["tempVector0",function(){return this.tempVector0=new _e},"tempSize",function(){return this.tempSize=new _e},"tempCenter",function(){return this.tempCenter=new _e},"_octreeSplit",function(){return this._octreeSplit=[new _e(.25,.25,.25),new _e(.75,.25,.25),new _e(.25,.75,.25),new _e(.75,.75,.25),new _e(.25,.25,.75),new _e(.75,.25,.75),new _e(.25,.75,.75),new _e(.75,.75,.75)]}]),t}(),ct=(function(){function t(){}return r(t,"laya.d3.core.scene.SceneManager"),t}(),function(){function t(t){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=t}r(t,"laya.d3.graphics.DynamicBatch");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRenderable":!0}),e._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},e._getIndexBuffer=function(){return this._indexBuffer},e._getCombineRenderElementFromPool=function(t,e,i){var n=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return n||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=n=new ot,n._sprite3D=new Vi),n._sprite3D._render._renderUpdate(i),n},e._getRenderElement=function(e,i,n){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*t.maxVertexCount),this._indexDatas=new Uint16Array(t.maxIndexCount),this._vertexBuffer=Si.create(this._vertexDeclaration,t.maxVertexCount,35048),this._indexBuffer=vi.create("ushort",t.maxIndexCount,35048)),this._merageElements.length=0;for(var r=0,a=0,s=0,o=this._combineRenderElements.length;o>s;s++){var h=this._combineRenderElements[s],l=h.getDynamicBatchBakedVertexs(0),u=h.getBakedIndices(),c=h._sprite3D.transform._isFrontFaceInvert,_=r/(this._vertexDeclaration.vertexStride/4),d=a,f=d+u.length;h._tempBatchIndexStart=d,h._tempBatchIndexEnd=f,this._indexDatas.set(u,a);var p=0;if(c)for(p=d;f>p;p+=3){this._indexDatas[p]=_+this._indexDatas[p];var m=this._indexDatas[p+1],g=this._indexDatas[p+2];this._indexDatas[p+1]=_+g,this._indexDatas[p+2]=_+m}else for(p=d;f>p;p+=3)this._indexDatas[p]=_+this._indexDatas[p],this._indexDatas[p+1]=_+this._indexDatas[p+1],this._indexDatas[p+2]=_+this._indexDatas[p+2];a+=u.length,this._vertexDatas.set(l,r),r+=l.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),this._combineRenderElementPoolIndex=0,s=0,o=this._materials.length;o>s;s++){var y=this._getCombineRenderElementFromPool(e,i,n);y._type=2,y._staticBatch=null,y.renderObj=this;var x=this._combineRenderElements[this._materialToRenderElementsOffsets[s]]._tempBatchIndexStart,v=s+1===this._materialToRenderElementsOffsets.length?a:this._combineRenderElements[this._materialToRenderElementsOffsets[s+1]]._tempBatchIndexStart;y._tempBatchIndexStart=x,y._tempBatchIndexEnd=v,y._material=this._materials[s],this._merageElements.push(y)}},e._addCombineRenderObjTest=function(e){var i=e.renderObj,n=this._currentCombineIndexCount+i._getIndexBuffer().indexCount,r=this._currentCombineVertexCount+i._getVertexBuffer().vertexCount;return r>t.maxVertexCount||n>t.maxIndexCount?!1:!0;
},e._addCombineRenderObj=function(t){var e=t.renderObj;this._combineRenderElements.push(t),this._currentCombineIndexCount=this._currentCombineIndexCount+e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+e._getVertexBuffer().vertexCount},e._addCombineMaterial=function(t){this._materials.push(t)},e._addMaterialToRenderElementOffset=function(t){this._materialToRenderElementsOffsets.push(t)},e._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},e._addToRenderQueue=function(t,e,i,n){this._getRenderElement(e,i,n);for(var r=0,a=this._materials.length;a>r;r++)t.getRenderQueue(this._materials[r].renderQueue)._addDynamicBatchElement(this._merageElements[r])},e._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},e._render=function(t){var e=t._batchIndexEnd-t._batchIndexStart;P.mainContext.drawElements(4,e,5123,2*t._batchIndexStart),D.drawCall++,D.trianglesFaces+=e/3},e._renderRuntime=function(t,e,i){},a(0,e,"_vertexBufferCount",function(){return 1}),a(0,e,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,e,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),t.maxVertexCount=2e4,t.maxIndexCount=4e4,t.maxCombineTriangleCount=20,t}()),_t=function(){function t(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}r(t,"laya.d3.graphics.DynamicBatchManager");var e=t.prototype;return e.getDynamicBatch=function(t,e){var i,n=t.id.toString()+e;return this._dynamicBatches[n]?i=this._dynamicBatches[n]:this._dynamicBatches[n]=i=new ct(t),i},e._garbageCollection=function(){for(var t in this._dynamicBatches)0===this._dynamicBatches[t].combineRenderElementsCount&&delete this._dynamicBatches[t]},e._addPrepareRenderElement=function(t){this._prepareDynamicBatchCombineElements.push(t)},e._finishCombineDynamicBatch=function(e){this._prepareDynamicBatchCombineElements.sort(t._sortPrepareDynamicBatch);for(var i,n,r,a,s,o,h,l,u=-1,c=!0,_=0,d=-1,f=0,p=this._prepareDynamicBatchCombineElements.length;p>f;f++){s=this._prepareDynamicBatchCombineElements[f];var m=s.renderObj._getVertexBuffer(0).vertexDeclaration,g=n!==m;g&&(_=0,n=m);var y=_!==u;if(y&&(u=_),(g||y)&&(o=this.getDynamicBatch(m,_),i=null),c)if(o._addCombineRenderObjTest(s)){if(a=s._material,i!==a)h&&(e.getRenderQueue(l._material.renderQueue)._addRenderElement(l),h=null,l=null,d=-1),h=a,d=o.combineRenderElementsCount,l=s,i=a;else if(h){var x=l.renderObj,v=s.renderObj;x._getVertexBuffer().vertexCount+v._getVertexBuffer().vertexCount>ct.maxVertexCount||x._getIndexBuffer().indexCount+v._getIndexBuffer().indexCount>ct.maxIndexCount?(e.getRenderQueue(l._material.renderQueue)._addRenderElement(l),h=a,d=o.combineRenderElementsCount,l=s):(o._addCombineMaterial(h),o._addMaterialToRenderElementOffset(d),o._addCombineRenderObj(l),h=null,l=null,d=-1,o._addCombineRenderObj(s))}else o._addCombineRenderObj(s);c=!0}else h&&(e.getRenderQueue(l._material.renderQueue)._addRenderElement(l),h=null,l=null,d=-1),_++,c=!1;else r=this._prepareDynamicBatchCombineElements[f-1],o._addMaterialToRenderElementOffset(o.combineRenderElementsCount),i=r._material,o._addCombineMaterial(i),o._addCombineRenderObj(r),c=!0,a=s._material,i!==a?(h=a,d=o.combineRenderElementsCount,l=s):o._addCombineRenderObj(s),i=a}h&&(e.getRenderQueue(l._material.renderQueue)._addRenderElement(l),h=null,l=null,d=-1),this._prepareDynamicBatchCombineElements.length=0},e._clearRenderElements=function(){for(var t in this._dynamicBatches)this._dynamicBatches[t]._clearRenderElements()},e._addToRenderQueue=function(t,e,i,n){for(var r in this._dynamicBatches){var a=this._dynamicBatches[r];a.combineRenderElementsCount>0&&a._addToRenderQueue(t,e,i,n)}},e.dispose=function(){this._dynamicBatches=null},t._sortPrepareDynamicBatch=function(t,e){return t._mainSortID-e._mainSortID},t}(),dt=function(){function t(){}return r(t,"laya.d3.graphics.FrustumCulling"),t.renderShadowObjectCulling=function(t,e,i,n,r){var a=0,s=0,o=0,h=0;for(a=0,o=i.length;o>a;a++){var l=i[a];l&&l._clearRenderElements()}var u,c,_,d=t._cullingRenders;if(r>1){for(a=0,o=t._cullingRendersLength;o>a;a++)if(u=d[a],u.castShadow&&k.isVisible(u._owner.layer.mask)&&u.enable)for(var f=1,p=e.length;p>f;f++)if(c=i[f-1],0!==e[f].containsBoundSphere(u.boundingSphere))for(_=u._renderElements,s=0,h=_.length;h>s;s++)c._addRenderElement(_[s])}else for(a=0,o=t._cullingRendersLength;o>a;a++)if(u=d[a],u.castShadow&&k.isVisible(u._owner.layer.mask)&&u.enable&&0!==e[0].containsBoundSphere(u.boundingSphere))for(u._renderUpdate(n),c=i[0],_=u._renderElements,s=0,h=_.length;h>s;s++)c._addRenderElement(_[s])},t.renderShadowObjectCullingOctree=function(t,e,i,n,r){for(var a=0,s=i.length;s>a;a++){var o=i[a];o&&o._clearRenderElements()}r>1?t.treeRoot.cullingShadowObjects(e,i,!0,0,t):t.treeRoot.cullingShadowObjectsOnePSSM(e[0],i,n,!0,0,t)},t.renderObjectCulling=function(t,e,i,n,r,a){var s=0,o=0,h=0,l=0,u=e._quenes,c=e._dynamicBatchManager,_=e._cullingRenders;for(s=0,o=u.length;o>s;s++){var d=u[s];d&&d._clearRenderElements()}var f=ft._staticBatchManagers;for(s=0,o=f.length;o>s;s++)f[s]._clearRenderElements();c._clearRenderElements();var p=i.transform.position;for(s=0,o=e._cullingRendersLength;o>s;s++){var m=_[s];if(k.isVisible(m._owner.layer.mask)&&m.enable&&0!==t.containsBoundSphere(m.boundingSphere)){m._renderUpdate(a),m._distanceForSort=_e.distance(m.boundingSphere.center,p)+m.sortingFudge;var g=m._renderElements;for(h=0,l=g.length;l>h;h++){var y=g[h],x=y._staticBatch;if(x&&x._material===y._material)x._addBatchRenderElement(y);else{var v=y.renderObj;v.triangleCount<20&&1===v._vertexBufferCount&&v._getIndexBuffer()&&y._material.renderQueue<2&&y._canDynamicBatch&&!m._owner.isStatic?c._addPrepareRenderElement(y):e.getRenderQueue(y._material.renderQueue)._addRenderElement(y)}}}}for(s=0,o=f.length;o>s;s++)f[s]._addToRenderQueue(e,n,r,a);c._finishCombineDynamicBatch(e),c._addToRenderQueue(e,n,r,a)},t.renderObjectCullingOctree=function(t,e,i,n,r,a){var s=0,o=0,h=e._quenes,l=e._dynamicBatchManager;for(s=0,o=h.length;o>s;s++){var u=h[s];u&&u._clearRenderElements()}var c=ft._staticBatchManagers;for(s=0,o=c.length;o>s;s++)c[s]._clearRenderElements();for(l._clearRenderElements(),e._cullingRenders.length=0,e.treeRoot.cullingObjects(t,!0,0,i.transform.position,a),s=0,o=c.length;o>s;s++)c[s]._addToRenderQueue(e,n,r,a);l._finishCombineDynamicBatch(e),l._addToRenderQueue(e,n,r,a)},t.renderObjectCullingNoBoundFrustum=function(t,e,i,n,r){var a=0,s=0,o=0,h=0,l=t._quenes,u=t._dynamicBatchManager,c=t._cullingRenders;for(a=0,s=l.length;s>a;a++){var _=l[a];_&&_._clearRenderElements()}var d=ft._staticBatchManagers;for(a=0,s=d.length;s>a;a++)d[a]._clearRenderElements();u._clearRenderElements();var f=e.transform.position;for(a=0,s=t._cullingRendersLength;s>a;a++){var p=c[a];if(k.isVisible(p._owner.layer.mask)&&p.enable){p._renderUpdate(r),p._distanceForSort=_e.distance(p.boundingSphere.center,f)+p.sortingFudge;var m=p._renderElements;for(o=0,h=m.length;h>o;o++){var g=m[o],y=g._staticBatch;if(y&&y._material===g._material)y._addBatchRenderElement(g);else{var x=g.renderObj;x.triangleCount<20&&1===x._vertexBufferCount&&x._getIndexBuffer()&&g._material.renderQueue<2&&g._canDynamicBatch&&!p._owner.isStatic?u._addPrepareRenderElement(g):t.getRenderQueue(g._material.renderQueue)._addRenderElement(g)}}}}for(a=0,s=d.length;s>a;a++)d[a]._addToRenderQueue(t,i,n,r);u._finishCombineDynamicBatch(t),u._addToRenderQueue(t,i,n,r)},t}(),ft=function(){function t(){this._initBatchRenderElements=null,this._staticBatches=null,this._initBatchRenderElements=[],this._staticBatches={}}r(t,"laya.d3.graphics.StaticBatchManager");var e=t.prototype;return e._finshInit=function(){for(var t in this._staticBatches)this._staticBatches[t]._finshInit();this._initBatchRenderElements.length=0},e._initStaticBatchs=function(t){throw new Error("StaticBatchManager:must override this function.")},e._addInitBatchSprite=function(t){for(var e=t._render._renderElements,i=0,n=e.length;n>i;i++)this._initBatchRenderElements.push(e[i])},e._clearRenderElements=function(){for(var t in this._staticBatches)this._staticBatches[t]._clearRenderElements()},e._garbageCollection=function(t){var e=t._staticBatch,i=e._initBatchRenderElements,n=i.indexOf(t);i.splice(n,1),0===i.length&&(e.dispose(),delete this._staticBatches[e._key])},e._addToRenderQueue=function(t,e,i,n){for(var r in this._staticBatches){var a=this._staticBatches[r];a._batchRenderElements.length>0&&a._updateToRenderQueue(t,n)}},e.dispose=function(){this._staticBatches=null},t._addToRenderQueueStaticBatch=function(e){e instanceof laya.d3.core.RenderableSprite3D&&e._addToInitStaticBatchManager();for(var i=0,n=e.numChildren;n>i;i++)t._addToRenderQueueStaticBatch(e._childs[i])},t.combine=function(e,i){var n,r=0,a=0;if(i)for(r=0,a=i.length;a>r;r++){var s=i[r];s._addToInitStaticBatchManager()}else e&&t._addToRenderQueueStaticBatch(e);for(r=0,a=t._staticBatchManagers.length;a>r;r++)n=t._staticBatchManagers[r],n._initStaticBatchs(e),n._finshInit()},t._staticBatchManagers=[],t}(),pt=function(){function t(t,e,i){this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=null,this._initBatchRenderElements=null,this._batchRenderElements=null,this._material=null,this._rootOwner=null,this._key=null,this._manager=null,this._key=t,this._manager=e,this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=[],this._initBatchRenderElements=[],this._batchRenderElements=[],this._rootOwner=i}r(t,"laya.d3.graphics.StaticBatch");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),e._binarySearch=function(t){for(var e=0,i=this._batchRenderElements.length-1,n=0;i>=e;)n=parseInt((e+i)/2),this._compareBatchRenderElement(this._batchRenderElements[n],t)?i=n-1:e=n+1;return e},e._compareBatchRenderElement=function(t,e){throw new Error("StaticBatch:must override this function.")},e._getVertexDecLightMap=function(t){return t===kt.vertexDeclaration?Ft.vertexDeclaration:t===Ut.vertexDeclaration?Vt.vertexDeclaration:t===Pt.vertexDeclaration?At.vertexDeclaration:t===zt.vertexDeclaration?null:t===bt.vertexDeclaration?Ct.vertexDeclaration:t===Ht.vertexDeclaration?Bt.vertexDeclaration:t===Nt.vertexDeclaration?Ot.vertexDeclaration:t},e._getCombineRenderElementFromPool=function(){throw new Error("StaticBatch:must override this function.")},e._addBatchRenderElement=function(t){this._batchRenderElements.splice(this._binarySearch(t),0,t)},e._updateToRenderQueue=function(t,e){this._combineRenderElementPoolIndex=0,this._getRenderElement(t.getRenderQueue(this._material.renderQueue)._renderElements,t,e)},e._getRenderElement=function(t,e,i){throw new Error("StaticBatch:must override this function.")},e._finshInit=function(){throw new Error("StaticBatch:must override this function.")},e._clearRenderElements=function(){this._batchRenderElements.length=0},e.dispose=function(){},e._getVertexBuffer=function(t){return void 0===t&&(t=0),null},e._getIndexBuffer=function(){return null},e._beforeRender=function(t){return!0},e._render=function(t){},e._renderRuntime=function(t,e,i){},a(0,e,"_vertexBufferCount",function(){return 1}),a(0,e,"triangleCount",function(){return 0}),t.combine=function(t){console.log("StaticBatch: discard property,please use StaticBatchManager.combine() function instead."),ft.combine(t)},t.maxBatchVertexCount=65535,t}(),mt=function(){function t(e,i){if(this._id=0,this._shaderValues=null,this._shaderDefineValue=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._conchVertexDeclaration=null,this._id=++t._uniqueIDCounter,this._id>t.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",t.maxVertexDeclaration);this._shaderValues=new ye,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=i,E.isConchNode&&(this._conchVertexDeclaration=new ConchVertexDeclare);for(var n=0;n<i.length;n++){var r=i[n],a=r.elementUsage;this._vertexElementsDic[a]=r;var s=[t._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];switch(this._shaderValues.setValue(a,s),a){case 1:this._addShaderDefine(me.SHADERDEFINE_COLOR);break;case 2:this._addShaderDefine(me.SHADERDEFINE_UV0);break;case 15:this._addShaderDefine(me.SHADERDEFINE_UV1)}}if(E.isConchNode){for(var o=[],h=0,l=i.length;l>h;h++){var u=i[h];switch(u.elementFormat){case"vector2":o.push({offset:u.offset,elementFormat:35664,elementUsage:u.elementUsage});break;case"vector3":o.push({offset:u.offset,elementFormat:35665,elementUsage:u.elementUsage});break;case"vector4":o.push({offset:u.offset,elementFormat:35666,elementUsage:u.elementUsage})}}this._conchVertexDeclaration.setDelcare(o)}}r(t,"laya.d3.graphics.VertexDeclaration");var e=t.prototype;return e._addShaderDefine=function(t){this._shaderDefineValue|=t,this._conchVertexDeclaration&&this._conchVertexDeclaration.addShaderDefine(t)},e._removeShaderDefine=function(t){this._shaderDefineValue&=~t,this._conchVertexDeclaration&&this._conchVertexDeclaration.removeShaderDefine(t)},e.getVertexElements=function(){return this._vertexElements.slice()},e.getVertexElementByUsage=function(t){return this._vertexElementsDic[t]},e.unBinding=function(){},a(0,e,"shaderDefineValue",function(){return this._shaderDefineValue}),a(0,e,"id",function(){return this._id}),a(0,e,"vertexStride",function(){return this._vertexStride}),a(0,e,"shaderValues",function(){return this._shaderValues}),t._getTypeSize=function(t){switch(t){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"color":return 4;case"byte4":return 4;case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},t.getVertexStride=function(e){for(var i=0,n=0;n<e.Length;n++){var r=e[n],a=r.offset+t._getTypeSize(r.elementFormat);a>i&&(i=a)}return i},t._maxVertexDeclarationBit=1e3,t._uniqueIDCounter=1,n(t,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),t}(),gt=function(){function t(t,e,i){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=t,this.elementFormat=e,this.elementUsage=i}return r(t,"laya.d3.graphics.VertexElement"),t}(),yt=(function(){function t(){}return r(t,"laya.d3.graphics.VertexElementFormat"),t.Single="single",t.Vector2="vector2",t.Vector3="vector3",t.Vector4="vector4",t.Color="color",t.Byte4="byte4",t.Short2="short2",t.Short4="short4",t.NormalizedShort2="normalizedshort2",t.NormalizedShort4="normalizedshort4",t.HalfVector2="halfvector2",t.HalfVector4="halfvector4",t}(),function(){function t(){}return r(t,"laya.d3.graphics.VertexElementUsage"),t.POSITION0=0,t.COLOR0=1,t.TEXTURECOORDINATE0=2,t.NORMAL0=3,t.BINORMAL0=4,t.TANGENT0=5,t.BLENDINDICES0=6,t.BLENDWEIGHT0=7,t.DEPTH0=8,t.FOG0=9,t.POINTSIZE0=10,t.SAMPLE0=11,t.TESSELLATEFACTOR0=12,t.COLOR1=13,t.NEXTTEXTURECOORDINATE0=14,t.TEXTURECOORDINATE1=15,t.NEXTTEXTURECOORDINATE1=16,t.CORNERTEXTURECOORDINATE0=17,t.VELOCITY0=18,t.STARTCOLOR0=19,t.STARTSIZE=20,t.AGEADDSCALE0=21,t.STARTROTATION=22,t.ENDCOLOR0=23,t.STARTLIFETIME=24,t.TIME0=33,t.SHAPEPOSITIONSTARTLIFETIME=30,t.DIRECTIONTIME=32,t.SIZEROTATION0=27,t.RADIUS0=28,t.RADIAN0=29,t.STARTSPEED=31,t.RANDOM0=34,t.RANDOM1=35,t.SIMULATIONWORLDPOSTION=36,t.SIMULATIONWORLDROTATION=37,t}(),function(){function t(t,e,i){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=t,this._textureCoordinate0=e,this._time=i}r(t,"laya.d3.graphics.VertexGlitter");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate0}),a(0,e,"position",function(){return this._position}),a(0,e,"time",function(){return this._time}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(24,[new gt(0,"vector3",0),new gt(12,"vector2",2),new gt(20,"single",33)])}]),t}()),xt=(function(){function t(t,e,i,n,r,a,s,o,h,l){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=t,this._position=e,this._velocity=i,this._startColor=n,this._endColor=r,this._sizeRotation=a,this._radius=s,this._radian=o,this._ageAddScale=h,this._time=l}r(t,"laya.d3.graphics.VertexParticle");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"endColor",function(){return this._endColor}),a(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,e,"sizeRotation",function(){return this._sizeRotation}),a(0,e,"velocity",function(){return this._velocity}),a(0,e,"position",function(){return this._position}),a(0,e,"startColor",function(){return this._startColor}),a(0,e,"radius",function(){return this._radius}),a(0,e,"radian",function(){return this._radian}),a(0,e,"ageAddScale",function(){return this._ageAddScale}),a(0,e,"time",function(){return this._time}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(116,[new gt(0,"vector4",17),new gt(16,"vector3",0),new gt(28,"vector3",18),new gt(40,"vector4",19),new gt(56,"vector4",23),new gt(72,"vector3",27),new gt(84,"vector2",28),new gt(92,"vector4",29),new gt(108,"single",24),new gt(112,"single",33)])}]),t}(),function(){function t(t){this._position=null,this._position=t}r(t,"laya.d3.graphics.VertexPosition");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(12,[new gt(0,"vector3",0)])}]),t}()),vt=function(){function t(t,e){this._position=null,this._normal=null,this._position=t,this._normal=e}r(t,"laya.d3.graphics.VertexPositionNormal");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(24,[new gt(0,"vector3",0),new gt(12,"vector3",3)])}]),t}(),St=function(){function t(t,e,i){this._position=null,this._normal=null,this._color=null,this._position=t,this._normal=e,this._color=i}r(t,"laya.d3.graphics.VertexPositionNormalColor");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(40,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1)])}]),t}(),Tt=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._blendIndex=n,this._blendWeight=r}r(t,"laya.d3.graphics.VertexPositionNormalColorSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(72,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector4",7),new gt(56,"vector4",6)])}]),t}(),Et=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(84,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector4",7),new gt(56,"vector4",6),new gt(72,"vector3",5)])}]),t}(),wt=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._tangent=n}r(t,"laya.d3.graphics.VertexPositionNormalColorTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(52,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector3",5)])}]),t}(),bt=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(48,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector2",2)])}]),t}(),Ct=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(56,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector2",2),new gt(48,"vector2",15)])}]),t}(),Mt=function(){function t(t,e,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=s}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(88,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector2",2),new gt(48,"vector2",15),new gt(56,"vector4",7),new gt(72,"vector4",6)])}]),t}(),Dt=function(){function t(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalColorTexture0SkinTangent=function(t,e,i,n,r,a,s,o){this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o},a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(100,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector2",2),new gt(48,"vector2",15),new gt(56,"vector4",7),new gt(72,"vector4",6),new gt(88,"vector3",5)])}]),t}(),At=function(){function t(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalColorTexture0Tangent=function(t,e,i,n,r,a){this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a},a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(68,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector2",2),new gt(48,"vector2",15),new gt(56,"vector3",5)])}]),t}(),Rt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(80,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector2",2),new gt(48,"vector4",7),new gt(64,"vector4",6)])}]),t}(),It=function(){function t(t,e,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(92,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector2",2),new gt(48,"vector4",7),new gt(64,"vector4",6),new gt(80,"vector3",5)])}]),t}(),Pt=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._tangent=r}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(60,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector4",1),new gt(40,"vector2",2),new gt(48,"vector3",5)])}]),t}(),Lt=function(){function t(t,e,i){this._position=null,this._normal=null,this._tangent=null,this._position=t,this._normal=e,this._tangent=i}r(t,"laya.d3.graphics.VertexPositionNormalTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){
return this._vertexDeclaration=new mt(36,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector3",5)])}]),t}(),Nt=function(){function t(t,e,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=i}r(t,"laya.d3.graphics.VertexPositionNormalTexture");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(32,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2)])}]),t}(),Ot=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(40,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2),new gt(32,"vector2",15)])}]),t}(),Vt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(72,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2),new gt(32,"vector2",15),new gt(40,"vector4",7),new gt(56,"vector4",6)])}]),t}(),Ft=function(){function t(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalTexture0SkinTangent=function(t,e,i,n,r,a,s){this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s},a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(84,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2),new gt(32,"vector2",15),new gt(40,"vector4",7),new gt(56,"vector4",6),new gt(72,"vector3",5)])}]),t}(),Bt=function(){function t(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalTexture0Tangent=function(t,e,i,n,r){this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r},a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(52,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2),new gt(32,"vector2",15),new gt(40,"vector3",5)])}]),t}(),Ut=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._blendIndex=n,this._blendWeight=r}r(t,"laya.d3.graphics.VertexPositionNormalTextureSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(64,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2),new gt(32,"vector4",7),new gt(48,"vector4",6)])}]),t}(),kt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(76,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2),new gt(32,"vector4",7),new gt(48,"vector4",6),new gt(64,"vector3",5)])}]),t}(),Ht=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._tangent=n}r(t,"laya.d3.graphics.VertexPositionNormalTextureTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(44,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2),new gt(32,"vector3",5)])}]),t}(),zt=function(){function t(t,e,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=i}r(t,"laya.d3.graphics.VertexPositionNTBTexture");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(56,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector3",5),new gt(36,"vector3",4),new gt(48,"vector2",2)])}]),t}(),Wt=function(){function t(t,e,i,n,r,a,s,o){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this.binormal=null,this._position=t,this._normal=e,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a,i=i,this._blendIndex=s,this._blendWeight=o}r(t,"laya.d3.graphics.VertexPositionNTBTexture0Texture1Skin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(96,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector3",5),new gt(36,"vector3",4),new gt(48,"vector2",2),new gt(56,"vector2",15),new gt(64,"vector4",7),new gt(80,"vector4",6)])}]),t}(),Gt=function(){function t(t,e,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=i}r(t,"laya.d3.graphics.VertexPositionNTBTextureSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(88,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector3",5),new gt(36,"vector3",4),new gt(48,"vector2",2),new gt(56,"vector4",7),new gt(72,"vector4",6)])}]),t}(),jt=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=t,this._normal=e,this._textureCoord0=i,this._textureCoord1=n}r(t,"laya.d3.graphics.VertexPositionTerrain");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoord0",function(){return this._textureCoord0}),a(0,e,"textureCoord1",function(){return this._textureCoord1}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(40,[new gt(0,"vector3",0),new gt(12,"vector3",3),new gt(24,"vector2",2),new gt(32,"vector2",15)])}]),t}(),Yt=function(){function t(t,e){this._position=null,this._textureCoordinate0=null,this._position=t,this._textureCoordinate0=e}r(t,"laya.d3.graphics.VertexPositionTexture0");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(20,[new gt(0,"vector3",0),new gt(12,"vector2",2)])}]),t}(),Xt=function(){function t(t,e,i,n,r,a,s,o,h,l,u,c,_,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=t,this._positionStartLifeTime=e,this._velocity=i,this._startColor=n,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=h,this._time=l,this._startSpeed=u,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}r(t,"laya.d3.graphics.VertexShurikenParticleBillboard");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,e,"random1",function(){return this._randoms1}),a(0,e,"startRotation2",function(){return this._startRotation2}),a(0,e,"positionStartLifeTime",function(){return this._positionStartLifeTime}),a(0,e,"velocity",function(){return this._velocity}),a(0,e,"random0",function(){return this._randoms0}),a(0,e,"startSize",function(){return this._startSize}),a(0,e,"startColor",function(){return this._startColor}),a(0,e,"startRotation0",function(){return this._startRotation0}),a(0,e,"startRotation1",function(){return this._startRotation1}),a(0,e,"startLifeTime",function(){return this._startLifeTime}),a(0,e,"time",function(){return this._time}),a(0,e,"startSpeed",function(){return this._startSpeed}),a(0,e,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(152,[new gt(0,"vector4",17),new gt(16,"vector4",30),new gt(32,"vector4",32),new gt(48,"vector4",19),new gt(64,"vector3",20),new gt(76,"vector3",22),new gt(88,"single",31),new gt(92,"vector4",34),new gt(108,"vector4",35),new gt(124,"vector3",36),new gt(136,"vector4",37)])}]),t}(),qt=function(){function t(t,e,i,n,r,a,s,o,h,l,u,c,_,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=t,this._positionStartLifeTime=e,this._velocity=i,this._startColor=n,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=h,this._time=l,this._startSpeed=u,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}r(t,"laya.d3.graphics.VertexShurikenParticleMesh");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,e,"velocity",function(){return this._velocity}),a(0,e,"position",function(){return this._positionStartLifeTime}),a(0,e,"random0",function(){return this._randoms0}),a(0,e,"startSize",function(){return this._startSize}),a(0,e,"startColor",function(){return this._startColor}),a(0,e,"startRotation0",function(){return this._startRotation0}),a(0,e,"startRotation1",function(){return this._startRotation1}),a(0,e,"random1",function(){return this._randoms1}),a(0,e,"startRotation2",function(){return this._startRotation2}),a(0,e,"startLifeTime",function(){return this._startLifeTime}),a(0,e,"time",function(){return this._time}),a(0,e,"startSpeed",function(){return this._startSpeed}),a(0,e,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new mt(156,[new gt(0,"vector3",0),new gt(12,"vector2",2),new gt(20,"vector4",30),new gt(36,"vector4",32),new gt(52,"vector4",19),new gt(68,"vector3",20),new gt(80,"vector3",22),new gt(92,"single",31),new gt(96,"vector4",34),new gt(112,"vector4",35),new gt(128,"vector3",36),new gt(140,"vector4",37)])}]),t}(),Kt=function(){function t(t,e,i,n,r,a){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._subMeshes=null,this._materialMap=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=i,this._materials=n,this._subMeshes=r,this._materialMap=a,this._version=e,this._onLoaded(t)}r(t,"laya.d3.loaders.LoadModelV01");var e=t.prototype;return e._onLoaded=function(t){this._readData=t,this.READ_BLOCK();for(var e=0;e<this._BLOCK.count;e++){var i=this._readData.getUint16(),n=this._strings[i],r=this["READ_"+n];if(null==r)throw new Error("model file err,no this function:"+i+" "+n);if(!r.call(this))break}return this._mesh},e.onError=function(){},e._readString=function(){return this._strings[this._readData.getUint16()]},e.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},e.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},e.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var t=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var e=0;e<this._STRINGS.size;e++)this._strings[e]=this._readData.readUTFString();return this._readData.pos=t,!0},e.READ_MATERIAL=function(){var t=this._readData.getUint16(),e=(this._readString(),this._readString());return"null"!==e?this._materials[t]=x.getRes(this._materialMap[e]):this._materials[t]=new Ye,!0},e.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":case"LAYAMODEL:02":var t=this._readData.__getBuffer(),e=0,i=0,n=this._readData.getUint32(),r=this._readData.getUint32(),a=new Float32Array(t.slice(n+this._DATA.offset,n+this._DATA.offset+r));for(this.mesh._bindPoses=[],e=0,i=a.length;i>e;e+=16){var s=new ae(a[e+0],a[e+1],a[e+2],a[e+3],a[e+4],a[e+5],a[e+6],a[e+7],a[e+8],a[e+9],a[e+10],a[e+11],a[e+12],a[e+13],a[e+14],a[e+15]);this.mesh._bindPoses.push(s)}var o=this._readData.getUint32(),h=this._readData.getUint32(),l=new Float32Array(t.slice(o+this._DATA.offset,o+this._DATA.offset+h));for(this.mesh._inverseBindPoses=[],e=0,i=l.length;i>e;e+=16){var u=new ae(l[e+0],l[e+1],l[e+2],l[e+3],l[e+4],l[e+5],l[e+6],l[e+7],l[e+8],l[e+9],l[e+10],l[e+11],l[e+12],l[e+13],l[e+14],l[e+15]);this.mesh._inverseBindPoses.push(u)}break;default:throw new Error("LoadModel:unknown version.")}return!0},e.READ_SUBMESH=function(){var e=(this._readString(),this._readData.getUint8(),this._readString());this._shaderAttributes=e.match(t._attrReg);var i=this._readData.getUint32(),n=this._readData.getUint32(),r=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),h=this._readData.__getBuffer(),l=new pe(this._mesh),u=this._getVertexDeclaration(),c=Si.create(u,a/u.vertexStride,35044,!0),_=r+this._DATA.offset,d=h.slice(_,_+a);c.setData(new Float32Array(d)),l._vertexBuffer=c;for(var f=c.vertexDeclaration.getVertexElements(),p=0;p<f.length;p++)l._bufferUsage[f[p].elementUsage]=c;var m=vi.create("ushort",n/2,35044,!0),g=i+this._DATA.offset,y=h.slice(g,g+n);m.setData(new Uint16Array(y)),l._indexBuffer=m;var x=h.slice(s+this._DATA.offset,s+this._DATA.offset+o);return l._boneIndicesList[0]=new Uint8Array(x),this._subMeshes.push(l),!0},e.READ_DATAAREA=function(){return!1},e._getVertexDeclaration=function(){for(var t=!1,e=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=!1,h=!1,l=0;l<this._shaderAttributes.length;l+=8)switch(this._shaderAttributes[l]){case"POSITION":t=!0;break;case"NORMAL":e=!0;break;case"COLOR":i=!0;break;case"UV":n=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0;break;case"TANGENT":a=!0;break;case"BINORMAL":h=!0}var u;return t&&e&&i&&n&&r&&s&&o&&a?u=Dt.vertexDeclaration:t&&e&&i&&n&&r&&s&&o?u=Mt.vertexDeclaration:t&&e&&n&&r&&s&&o&&a?u=Ft.vertexDeclaration:t&&e&&n&&r&&s&&o?u=Vt.vertexDeclaration:t&&e&&i&&n&&s&&o&&a?u=It.vertexDeclaration:t&&e&&i&&n&&s&&o?u=Rt.vertexDeclaration:t&&e&&a&&h&&n&&s&&o?u=Gt.vertexDeclaration:t&&e&&n&&s&&o&&a?u=kt.vertexDeclaration:t&&e&&n&&s&&o?u=Ut.vertexDeclaration:t&&e&&i&&s&&o&&a?u=Et.vertexDeclaration:t&&e&&i&&s&&o?u=Tt.vertexDeclaration:t&&e&&i&&n&&r&&a?u=At.vertexDeclaration:t&&e&&i&&n&&r?u=Ct.vertexDeclaration:t&&e&&n&&r&&a?u=Bt.vertexDeclaration:t&&e&&n&&r?u=Ot.vertexDeclaration:t&&e&&i&&n&&a?u=Pt.vertexDeclaration:t&&e&&n&&a&&h?u=zt.vertexDeclaration:t&&e&&i&&n?u=bt.vertexDeclaration:t&&e&&n&&a?u=Ht.vertexDeclaration:t&&e&&n?u=Nt.vertexDeclaration:t&&e&&i&&a?u=wt.vertexDeclaration:t&&e&&i&&(u=St.vertexDeclaration),u},a(0,e,"mesh",function(){return this._mesh}),t._attrReg=new RegExp("(\\w+)|([:,;])","g"),t}(),Zt=function(){function t(){}return r(t,"laya.d3.loaders.LoadModelV02"),t.parse=function(e,i,n,r,a,s){t._mesh=n,t._materials=r,t._subMeshes=a,t._materialMap=s,t._version=i,t._readData=e,t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var o=0,h=t._BLOCK.count;h>o;o++){t._readData.pos=t._BLOCK.blockStarts[o];var l=t._readData.getUint16(),u=t._strings[l],c=t["READ_"+u];if(null==c)throw new Error("model file err,no this function:"+l+" "+u);c.call()}t._strings.length=0,t._readData=null,t._version=null,t._mesh=null,t._materials=null,t._subMeshes=null,t._materialMap=null},t._readString=function(){return t._strings[t._readData.getUint16()]},t.READ_DATA=function(){t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._readData.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;e>r;r++)i.push(t._readData.getUint32()),n.push(t._readData.getUint32())},t.READ_STRINGS=function(){var e=t._readData.getUint32(),i=t._readData.getUint16(),n=t._readData.pos;t._readData.pos=e+t._DATA.offset;for(var r=0;i>r;r++)t._strings[r]=t._readData.readUTFString();t._readData.pos=n},t.READ_MATERIAL=function(){var e=(t._readString(),t._readString(),t._readString());return""!==e&&t._materials.push(x.getRes(t._materialMap[e])),!0},t.READ_MESH=function(){var e=(t._readString(),t._readData.__getBuffer()),i=0,n=0,r=t._readData.getInt16(),a=t._DATA.offset;for(i=0;r>i;i++){var s=a+t._readData.getUint32(),o=t._readData.getUint32(),h=new Float32Array(e.slice(s,s+o)),l=t._readString(),u=l.match(t._attrReg),c=t._getVertexDeclaration(u),_=Si.create(c,4*h.length/c.vertexStride,35044,!0);_.setData(h),t._mesh._vertexBuffers.push(_)}var d=a+t._readData.getUint32(),f=t._readData.getUint32(),p=new Uint16Array(e.slice(d,d+f)),m=vi.create("ushort",f/2,35044,!0);m.setData(p),t._mesh._indexBuffer=m;var g=t._mesh._boneNames=[],y=t._readData.getUint16();for(g.length=y,i=0;y>i;i++)g[i]=t._strings[t._readData.getUint16()];var x=t._readData.getUint32(),v=t._readData.getUint32(),S=new Float32Array(e.slice(a+x,a+x+v));for(t._mesh._bindPoses=[],i=0,n=S.length;n>i;i+=16){var T=new ae(S[i+0],S[i+1],S[i+2],S[i+3],S[i+4],S[i+5],S[i+6],S[i+7],S[i+8],S[i+9],S[i+10],S[i+11],S[i+12],S[i+13],S[i+14],S[i+15]);t._mesh._bindPoses.push(T)}var E=t._readData.getUint32(),w=t._readData.getUint32(),b=new Float32Array(e.slice(a+E,a+E+w));for(t._mesh._inverseBindPoses=[],i=0,n=b.length;n>i;i+=16){var C=new ae(b[i+0],b[i+1],b[i+2],b[i+3],b[i+4],b[i+5],b[i+6],b[i+7],b[i+8],b[i+9],b[i+10],b[i+11],b[i+12],b[i+13],b[i+14],b[i+15]);t._mesh._inverseBindPoses.push(C)}return!0},t.READ_SUBMESH=function(){var e=t._readData.__getBuffer(),i=new pe(t._mesh),n=t._readData.getInt16(),r=t._readData.getUint32(),a=t._readData.getUint32();i._vertexBuffer=t._mesh._vertexBuffers[n],i._vertexStart=r,i._vertexCount=a;var s=t._readData.getUint32(),o=t._readData.getUint32(),h=t._mesh._indexBuffer;i._indexBuffer=h,i._indexStart=s,i._indexCount=o,i._indices=new Uint16Array(h.getData().buffer,2*s,o);var l=t._DATA.offset,u=i._subIndexBufferStart,c=i._subIndexBufferCount,_=i._boneIndicesList,d=t._readData.getUint16();u.length=d,c.length=d,_.length=d;for(var f=0;d>f;f++){u[f]=t._readData.getUint32(),c[f]=t._readData.getUint32();var p=t._readData.getUint32(),m=t._readData.getUint32();i._boneIndicesList[f]=new Uint8Array(e.slice(l+p,l+p+m))}return t._subMeshes.push(i),!0},t._getVertexDeclaration=function(t){for(var e=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=!1,h=!1,l=!1,u=0;u<t.length;u++)switch(t[u]){case"POSITION":e=!0;break;case"NORMAL":i=!0;break;case"COLOR":n=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":o=!0;break;case"BLENDINDICES":h=!0;break;case"TANGENT":s=!0;break;case"BINORMAL":l=!0}var c;return e&&i&&n&&r&&a&&o&&h&&s?c=Dt.vertexDeclaration:e&&i&&n&&r&&a&&o&&h?c=Mt.vertexDeclaration:e&&i&&r&&a&&o&&h&&s?c=Ft.vertexDeclaration:e&&i&&r&&a&&o&&h?c=Vt.vertexDeclaration:e&&i&&n&&r&&o&&h&&s?c=It.vertexDeclaration:e&&i&&n&&r&&o&&h?c=Rt.vertexDeclaration:e&&i&&r&&o&&h&&s?c=kt.vertexDeclaration:e&&i&&r&&o&&h?c=Ut.vertexDeclaration:e&&i&&n&&o&&h&&s?c=Et.vertexDeclaration:e&&i&&n&&o&&h?c=Tt.vertexDeclaration:e&&i&&n&&r&&a&&s?c=At.vertexDeclaration:e&&i&&n&&r&&a?c=Ct.vertexDeclaration:e&&i&&r&&a&&s?c=Bt.vertexDeclaration:e&&i&&r&&a?c=Ot.vertexDeclaration:e&&i&&n&&r&&s?c=Pt.vertexDeclaration:e&&i&&r&&s&&l?c=zt.vertexDeclaration:e&&i&&n&&r?c=bt.vertexDeclaration:e&&i&&r&&s?c=Ht.vertexDeclaration:e&&i&&r?c=Nt.vertexDeclaration:e&&i&&n&&s?c=wt.vertexDeclaration:e&&i&&n&&(c=St.vertexDeclaration),c},t._attrReg=new RegExp("(\\w+)|([:,;])","g"),t._strings=[],t._readData=null,t._version=null,t._mesh=null,t._materials=null,t._subMeshes=null,t._materialMap=null,n(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),$t=function(){function t(){}return r(t,"laya.d3.loaders.LoadModelV03"),t.parse=function(e,i,n,r,a){t._mesh=n,t._subMeshes=r,t._materialMap=a,t._version=i,t._readData=e,t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var s=0,o=t._BLOCK.count;o>s;s++){t._readData.pos=t._BLOCK.blockStarts[s];var h=t._readData.getUint16(),l=t._strings[h],u=t["READ_"+l];if(null==u)throw new Error("model file err,no this function:"+h+" "+l);u.call()}t._strings.length=0,t._readData=null,t._version=null,t._mesh=null,t._subMeshes=null,t._materialMap=null},t._readString=function(){return t._strings[t._readData.getUint16()]},t.READ_DATA=function(){t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._readData.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;e>r;r++)i.push(t._readData.getUint32()),n.push(t._readData.getUint32())},t.READ_STRINGS=function(){var e=t._readData.getUint32(),i=t._readData.getUint16(),n=t._readData.pos;t._readData.pos=e+t._DATA.offset;for(var r=0;i>r;r++)t._strings[r]=t._readData.readUTFString();t._readData.pos=n},t.READ_MESH=function(){var e=(t._readString(),t._readData.__getBuffer()),i=0,n=0,r=t._readData.getInt16(),a=t._DATA.offset;for(i=0;r>i;i++){var s=a+t._readData.getUint32(),o=t._readData.getUint32(),h=new Float32Array(e.slice(s,s+o)),l=t._readString(),u=l.match(t._attrReg),c=t._getVertexDeclaration(u),_=Si.create(c,4*h.length/c.vertexStride,35044,!0);_.setData(h),t._mesh._vertexBuffers.push(_)}var d=a+t._readData.getUint32(),f=t._readData.getUint32(),p=new Uint16Array(e.slice(d,d+f)),m=vi.create("ushort",f/2,35044,!0);m.setData(p),t._mesh._indexBuffer=m;var g=t._mesh._boneNames=[],y=t._readData.getUint16();for(g.length=y,i=0;y>i;i++)g[i]=t._strings[t._readData.getUint16()];var x=t._readData.getUint32(),v=t._readData.getUint32(),S=new Float32Array(e.slice(a+x,a+x+v));for(t._mesh._bindPoses=[],i=0,n=S.length;n>i;i+=16){var T=new ae(S[i+0],S[i+1],S[i+2],S[i+3],S[i+4],S[i+5],S[i+6],S[i+7],S[i+8],S[i+9],S[i+10],S[i+11],S[i+12],S[i+13],S[i+14],S[i+15]);t._mesh._bindPoses.push(T)}var E=t._readData.getUint32(),w=t._readData.getUint32(),b=new Float32Array(e.slice(a+E,a+E+w));for(t._mesh._inverseBindPoses=[],i=0,n=b.length;n>i;i+=16){var C=new ae(b[i+0],b[i+1],b[i+2],b[i+3],b[i+4],b[i+5],b[i+6],b[i+7],b[i+8],b[i+9],b[i+10],b[i+11],b[i+12],b[i+13],b[i+14],b[i+15]);t._mesh._inverseBindPoses.push(C)}return!0},t.READ_SUBMESH=function(){var e=t._readData.__getBuffer(),i=new pe(t._mesh),n=t._readData.getInt16(),r=t._readData.getUint32(),a=t._readData.getUint32();i._vertexBuffer=t._mesh._vertexBuffers[n],i._vertexStart=r,i._vertexCount=a;var s=t._readData.getUint32(),o=t._readData.getUint32(),h=t._mesh._indexBuffer;i._indexBuffer=h,i._indexStart=s,i._indexCount=o,i._indices=new Uint16Array(h.getData().buffer,2*s,o);var l=t._DATA.offset,u=i._subIndexBufferStart,c=i._subIndexBufferCount,_=i._boneIndicesList,d=t._readData.getUint16();u.length=d,c.length=d,_.length=d;for(var f=0;d>f;f++){u[f]=t._readData.getUint32(),c[f]=t._readData.getUint32();var p=t._readData.getUint32(),m=t._readData.getUint32();i._boneIndicesList[f]=new Uint8Array(e.slice(l+p,l+p+m))}return t._subMeshes.push(i),!0},t._getVertexDeclaration=function(t){for(var e=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=!1,h=!1,l=!1,u=0;u<t.length;u++)switch(t[u]){case"POSITION":e=!0;break;case"NORMAL":i=!0;break;case"COLOR":n=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":o=!0;break;case"BLENDINDICES":h=!0;break;case"TANGENT":s=!0;break;case"BINORMAL":l=!0}var c;return c=e&&i&&n&&r&&a&&o&&h&&s?Dt.vertexDeclaration:e&&i&&n&&r&&a&&o&&h?Mt.vertexDeclaration:e&&i&&s&&l&&r&&a&&o&&h?Wt.vertexDeclaration:e&&i&&r&&a&&o&&h&&s?Ft.vertexDeclaration:e&&i&&r&&a&&o&&h?Vt.vertexDeclaration:e&&i&&n&&r&&o&&h&&s?It.vertexDeclaration:e&&i&&n&&r&&o&&h?Rt.vertexDeclaration:e&&i&&r&&o&&h&&s?kt.vertexDeclaration:e&&i&&r&&o&&h?Ut.vertexDeclaration:e&&i&&n&&o&&h&&s?Et.vertexDeclaration:e&&i&&n&&o&&h?Tt.vertexDeclaration:e&&i&&n&&r&&a&&s?At.vertexDeclaration:e&&i&&n&&r&&a?Ct.vertexDeclaration:e&&i&&r&&a&&s?Bt.vertexDeclaration:e&&i&&r&&a?Ot.vertexDeclaration:e&&i&&n&&r&&s?Pt.vertexDeclaration:e&&i&&r&&s&&l?zt.vertexDeclaration:e&&i&&n&&r?bt.vertexDeclaration:e&&i&&r&&s?Ht.vertexDeclaration:e&&i&&r?Nt.vertexDeclaration:e&&i&&n&&s?wt.vertexDeclaration:e&&i&&n?St.vertexDeclaration:e&&i&&s?Lt.vertexDeclaration:e&&i?vt.vertexDeclaration:xt.vertexDeclaration},t._attrReg=new RegExp("(\\w+)|([:,;])","g"),t._strings=[],t._readData=null,t._version=null,t._mesh=null,t._subMeshes=null,t._materialMap=null,n(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),Qt=function(){function t(){}return r(t,"laya.d3.loaders.MeshReader"),t.read=function(e,i,n,r,a){var s=new f(e);s.pos=0;var o=s.readUTFString();switch(o){case"LAYAMODEL:01":case"LAYASKINANI:01":t._readVersion01(s,o,i,n,r,a);break;case"LAYAMODEL:02":Zt.parse(s,o,i,n,r,a);break;case"LAYAMODEL:03":$t.parse(s,o,i,r,a);break;default:throw new Error("MeshReader: unknown mesh version.");
}i._setSubMeshes(r)},t._readVersion01=function(t,e,i,n,r,a){new Kt(t,e,i,n,r,a)},t}(),Jt=function(){function t(t,e){this.min=null,this.max=null,this.min=t,this.max=e}r(t,"laya.d3.math.BoundBox");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.getCorners=function(t){t.length=8;var e=this.min.elements,i=this.max.elements,n=e[0],r=e[1],a=e[2],s=i[0],o=i[1],h=i[2];t[0]=new _e(n,o,h),t[1]=new _e(s,o,h),t[2]=new _e(s,r,h),t[3]=new _e(n,r,h),t[4]=new _e(n,o,a),t[5]=new _e(s,o,a),t[6]=new _e(s,r,a),t[7]=new _e(n,r,a)},e.toDefault=function(){this.min.toDefault(),this.max.toDefault()},e.cloneTo=function(t){var e=t;this.min.cloneTo(e.min),this.max.cloneTo(e.max)},e.clone=function(){var t=new this.constructor(new _e,new _e);return this.cloneTo(t),t},t.createfromPoints=function(t,e){if(null==t)throw new Error("points");var i=e.min,n=e.max,r=i.elements;r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE;var a=n.elements;a[0]=-Number.MAX_VALUE,a[1]=-Number.MAX_VALUE,a[2]=-Number.MAX_VALUE;for(var s=0,o=t.length;o>s;++s)_e.min(i,t[s],i),_e.max(n,t[s],n)},t.merge=function(t,e,i){_e.min(t.min,e.min,i.min),_e.max(t.max,e.max,i.max)},t}(),te=function(){function t(e){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=e,this._near=new oe(new _e),this._far=new oe(new _e),this._left=new oe(new _e),this._right=new oe(new _e),this._top=new oe(new _e),this._bottom=new oe(new _e),t._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}r(t,"laya.d3.math.BoundFrustum");var e=t.prototype;return e.equalsBoundFrustum=function(t){return this._matrix.equalsOtherMatrix(t.matrix)},e.equalsObj=function(t){if(t instanceof laya.d3.math.BoundFrustum){var e=t;return this.equalsBoundFrustum(e)}return!1},e.getPlane=function(t){switch(t){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},e.getCorners=function(e){t._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(e[0]),t._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(e[1]),t._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(e[2]),t._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(e[3]),t._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(e[4]),t._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(e[5]),t._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(e[6]),t._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(e[7])},e.containsPoint=function(t){for(var e=oe.PlaneIntersectionType_Front,i=oe.PlaneIntersectionType_Front,n=0;6>n;n++){switch(n){case 0:i=ie.intersectsPlaneAndPoint(this._near,t);break;case 1:i=ie.intersectsPlaneAndPoint(this._far,t);break;case 2:i=ie.intersectsPlaneAndPoint(this._left,t);break;case 3:i=ie.intersectsPlaneAndPoint(this._right,t);break;case 4:i=ie.intersectsPlaneAndPoint(this._top,t);break;case 5:i=ie.intersectsPlaneAndPoint(this._bottom,t)}switch(i){case oe.PlaneIntersectionType_Back:return 0;case oe.PlaneIntersectionType_Intersecting:e=oe.PlaneIntersectionType_Intersecting}}switch(e){case oe.PlaneIntersectionType_Intersecting:return 2;default:return 1}},e.containsBoundBox=function(e){for(var i,n=t._tempV30,r=t._tempV31,a=1,s=0;6>s;s++){if(i=this.getPlane(s),this._getBoxToPlanePVertexNVertex(e,i.normal,n,r),ie.intersectsPlaneAndPoint(i,n)===oe.PlaneIntersectionType_Back)return 0;ie.intersectsPlaneAndPoint(i,r)===oe.PlaneIntersectionType_Back&&(a=2)}return a},e.containsBoundSphere=function(t){for(var e=oe.PlaneIntersectionType_Front,i=oe.PlaneIntersectionType_Front,n=0;6>n;n++){switch(n){case 0:i=ie.intersectsPlaneAndSphere(this._near,t);break;case 1:i=ie.intersectsPlaneAndSphere(this._far,t);break;case 2:i=ie.intersectsPlaneAndSphere(this._left,t);break;case 3:i=ie.intersectsPlaneAndSphere(this._right,t);break;case 4:i=ie.intersectsPlaneAndSphere(this._top,t);break;case 5:i=ie.intersectsPlaneAndSphere(this._bottom,t)}switch(i){case oe.PlaneIntersectionType_Back:return 0;case oe.PlaneIntersectionType_Intersecting:e=oe.PlaneIntersectionType_Intersecting}}switch(e){case oe.PlaneIntersectionType_Intersecting:return 2;default:return 1}},e._getBoxToPlanePVertexNVertex=function(t,e,i,n){var r=t.min,a=r.elements,s=t.max,o=s.elements,h=e.elements,l=h[0],u=h[1],c=h[2];r.cloneTo(i);var _=i.elements;l>=0&&(_[0]=o[0]),u>=0&&(_[1]=o[1]),c>=0&&(_[2]=o[2]),s.cloneTo(n);var d=n.elements;l>=0&&(d[0]=a[0]),u>=0&&(d[1]=a[1]),c>=0&&(d[2]=a[2])},a(0,e,"top",function(){return this._top}),a(0,e,"matrix",function(){return this._matrix},function(e){this._matrix=e,t._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),a(0,e,"near",function(){return this._near}),a(0,e,"far",function(){return this._far}),a(0,e,"left",function(){return this._left}),a(0,e,"right",function(){return this._right}),a(0,e,"bottom",function(){return this._bottom}),t._getPlanesFromMatrix=function(t,e,i,n,r,a,s){var o=t.elements,h=o[0],l=o[1],u=o[2],c=o[3],_=o[4],d=o[5],f=o[6],p=o[7],m=o[8],g=o[9],y=o[10],x=o[11],v=o[12],S=o[13],T=o[14],E=o[15],w=e.normal.elements;w[0]=u,w[1]=f,w[2]=y,e.distance=T,e.normalize();var b=i.normal.elements;b[0]=c-u,b[1]=p-f,b[2]=x-y,i.distance=E-T,i.normalize();var C=n.normal.elements;C[0]=c+h,C[1]=p+_,C[2]=x+m,n.distance=E+v,n.normalize();var M=r.normal.elements;M[0]=c-h,M[1]=p-_,M[2]=x-m,r.distance=E-v,r.normalize();var D=a.normal.elements;D[0]=c-l,D[1]=p-d,D[2]=x-g,a.distance=E-S,a.normalize();var A=s.normal.elements;A[0]=c+l,A[1]=p+d,A[2]=x+g,s.distance=E+S,s.normalize()},t._get3PlaneInterPoint=function(e,i,n){var r=e.normal,a=i.normal,s=n.normal;_e.cross(a,s,t._tempV30),_e.cross(s,r,t._tempV31),_e.cross(r,a,t._tempV32);var o=_e.dot(r,t._tempV30),h=_e.dot(a,t._tempV31),l=_e.dot(s,t._tempV32);_e.scale(t._tempV30,-e.distance/o,t._tempV33),_e.scale(t._tempV31,-i.distance/h,t._tempV34),_e.scale(t._tempV32,-n.distance/l,t._tempV35),_e.add(t._tempV33,t._tempV34,t._tempV36),_e.add(t._tempV35,t._tempV36,t._tempV37);var u=t._tempV37;return u},n(t,["_tempV30",function(){return this._tempV30=new _e},"_tempV31",function(){return this._tempV31=new _e},"_tempV32",function(){return this._tempV32=new _e},"_tempV33",function(){return this._tempV33=new _e},"_tempV34",function(){return this._tempV34=new _e},"_tempV35",function(){return this._tempV35=new _e},"_tempV36",function(){return this._tempV36=new _e},"_tempV37",function(){return this._tempV37=new _e}]),t}(),ee=function(){function t(t,e){this.center=null,this.radius=NaN,this.center=t,this.radius=e}r(t,"laya.d3.math.BoundSphere");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.toDefault=function(){this.center.toDefault(),this.radius=0},e.intersectsRayDistance=function(t){return ie.intersectsRayAndSphereRD(t,this)},e.intersectsRayPoint=function(t,e){return ie.intersectsRayAndSphereRP(t,this,e)},e.cloneTo=function(t){var e=t;this.center.cloneTo(e.center),e.radius=this.radius},e.clone=function(){var t=new this.constructor(new _e,new _e);return this.cloneTo(t),t},t.createFromSubPoints=function(e,i,n,r){if(null==e)throw new Error("points");if(0>i||i>=e.length)throw new Error("start"+i+"Must be in the range [0, "+(e.length-1)+"]");if(0>n||i+n>e.length)throw new Error("count"+n+"Must be in the range <= "+e.length+"}");var a=i+n,s=t._tempVector3;s.elements[0]=0,s.elements[1]=0,s.elements[2]=0;for(var o=i;a>o;++o)_e.add(e[o],s,s);var h=r.center;_e.scale(s,1/n,h);var l=0;for(o=i;a>o;++o){var u=_e.distanceSquared(h,e[o]);u>l&&(l=u)}r.radius=Math.sqrt(l)},t.createfromPoints=function(e,i){if(null==e)throw new Error("points");t.createFromSubPoints(e,0,e.length,i)},n(t,["_tempVector3",function(){return this._tempVector3=new _e}]),t}(),ie=function(){function t(){}return r(t,"laya.d3.math.Collision"),t.distancePlaneToPoint=function(t,e){var i=_e.dot(t.normal,e);return i-t.distance},t.distanceBoxToPoint=function(t,e){var i=t.min.elements,n=i[0],r=i[1],a=i[2],s=t.max.elements,o=s[0],h=s[1],l=s[2],u=e.elements,c=u[0],_=u[1],d=u[2],f=0;return n>c&&(f+=(n-c)*(n-c)),c>o&&(f+=(o-c)*(o-c)),r>_&&(f+=(r-_)*(r-_)),_>h&&(f+=(h-_)*(h-_)),a>d&&(f+=(a-d)*(a-d)),d>l&&(f+=(l-d)*(l-d)),Math.sqrt(f)},t.distanceBoxToBox=function(t,e){var i=t.min.elements,n=i[0],r=i[1],a=i[2],s=t.max.elements,o=s[0],h=s[1],l=s[2],u=e.min.elements,c=u[0],_=u[1],d=u[2],f=e.max.elements,p=f[0],m=f[1],g=f[2],y=0,x=NaN;return n>p?(x=n-p,y+=x*x):c>o&&(x=c-o,y+=x*x),r>m?(x=r-m,y+=x*x):_>h&&(x=_-h,y+=x*x),a>g?(x=a-g,y+=x*x):d>l&&(x=d-l,y+=x*x),Math.sqrt(y)},t.distanceSphereToPoint=function(t,e){var i=Math.sqrt(_e.distanceSquared(t.center,e));return i-=t.radius,Math.max(i,0)},t.distanceSphereToSphere=function(t,e){var i=Math.sqrt(_e.distanceSquared(t.center,e.center));return i-=t.radius+e.radius,Math.max(i,0)},t.intersectsRayAndTriangleRD=function(e,i,n,r,a){var s=e.origin,o=s.elements,h=o[0],l=o[1],u=o[2],c=e.direction,_=c.elements,d=_[0],f=_[1],p=_[2],m=i.elements,g=m[0],y=m[1],x=m[2],v=n.elements,S=v[0],T=v[1],E=v[2],w=r.elements,b=w[0],C=w[1],M=w[2],D=t._tempV30.elements,A=D[0],R=D[1],I=D[2];A=S-g,R=T-y,I=E-x;var P=t._tempV31.elements,L=P[0],N=P[1],O=P[2];L=b-g,N=C-y,O=M-x;var V=t._tempV32.elements,F=V[0],B=V[1],U=V[2];F=f*O-p*N,B=p*L-d*O,U=d*N-f*L;var k=A*F+R*B+I*U;if(ne.isZero(k))return a=0,!1;var H=1/k,z=t._tempV33.elements,W=z[0],G=z[1],j=z[2];W=h-g,G=l-y,j=u-x;var Y=W*F+G*B+j*U;if(Y*=H,0>Y||Y>1)return a=0,!1;var X=t._tempV34.elements,q=X[0],K=X[1],Z=X[2];q=G*I-j*R,K=j*A-W*I,Z=W*R-G*A;var $=d*q+f*K+p*Z;if($*=H,0>$||Y+$>1)return a=0,!1;var Q=L*q+N*K+O*Z;return Q*=H,0>Q?(a=0,!1):(a=Q,!0)},t.intersectsRayAndTriangleRP=function(e,i,n,r,a){var s=NaN;return t.intersectsRayAndTriangleRD(e,i,n,r,s)?(_e.scale(e.direction,s,t._tempV30),_e.add(e.origin,t._tempV30,a),!0):(a=_e.ZERO,!1)},t.intersectsRayAndPoint=function(e,i){_e.subtract(e.origin,i,t._tempV30);var n=_e.dot(t._tempV30,e.direction),r=_e.dot(t._tempV30,t._tempV30)-ne.zeroTolerance;if(r>0&&n>0)return!1;var a=n*n-r;return 0>a?!1:!0},t.intersectsRayAndRay=function(e,i,n){var r=e.origin,a=r.elements,s=a[0],o=a[1],h=a[2],l=e.direction,u=l.elements,c=u[0],_=u[1],d=u[2],f=i.origin,p=f.elements,m=p[0],g=p[1],y=p[2],x=i.direction,v=x.elements,S=v[0],T=v[1],E=v[2];_e.cross(l,x,t._tempV30);var w=t._tempV30.elements,b=_e.scalarLength(t._tempV30);if(ne.isZero(b)&&ne.nearEqual(m,s)&&ne.nearEqual(g,o)&&ne.nearEqual(y,h))return n=_e.ZERO,!0;b*=b;var C=m-s,M=g-o,D=y-h,A=S,R=T,I=E,P=w[0],L=w[1],N=w[2],O=C*R*N+M*I*P+D*A*L-C*I*L-M*A*N-D*R*P;A=c,R=_,I=d;var V=O/b;_e.scale(l,V,t._tempV30),_e.scale(x,V,t._tempV31),_e.add(r,t._tempV30,t._tempV32),_e.add(f,t._tempV31,t._tempV33);var F=t._tempV32.elements,B=t._tempV33.elements;return ne.nearEqual(B[0],F[0])&&ne.nearEqual(B[1],F[1])&&ne.nearEqual(B[2],F[2])?(n=t._tempV32,!0):(n=_e.ZERO,!1)},t.intersectsPlaneAndTriangle=function(e,i,n,r){var a=t.intersectsPlaneAndPoint(e,i),s=t.intersectsPlaneAndPoint(e,n),o=t.intersectsPlaneAndPoint(e,r);return a==oe.PlaneIntersectionType_Front&&s==oe.PlaneIntersectionType_Front&&o==oe.PlaneIntersectionType_Front?oe.PlaneIntersectionType_Front:a==oe.PlaneIntersectionType_Back&&s==oe.PlaneIntersectionType_Back&&o==oe.PlaneIntersectionType_Back?oe.PlaneIntersectionType_Back:oe.PlaneIntersectionType_Intersecting},t.intersectsRayAndPlaneRD=function(t,e,i){var n=e.normal,r=_e.dot(n,t.direction);if(ne.isZero(r))return i=0,!1;var a=_e.dot(n,t.origin);return i=(-e.distance-a)/r,0>i?(i=0,!1):!0},t.intersectsRayAndPlaneRP=function(e,i,n){var r=NaN;return t.intersectsRayAndPlaneRD(e,i,r)?(_e.scale(e.direction,r,t._tempV30),_e.add(e.origin,t._tempV30,t._tempV31),n=t._tempV31,!0):(n=_e.ZERO,!1)},t.intersectsRayAndBoxRD=function(t,e){var i=t.origin.elements,n=i[0],r=i[1],a=i[2],s=t.direction.elements,o=s[0],h=s[1],l=s[2],u=e.min.elements,c=u[0],_=u[1],d=u[2],f=e.max.elements,p=f[0],m=f[1],g=f[2],y=0,x=ne.MaxValue;if(ne.isZero(o)){if(c>n||n>p)return-1}else{var v=1/o,S=(c-n)*v,T=(p-n)*v;if(S>T){var E=S;S=T,T=E}if(y=Math.max(S,y),x=Math.min(T,x),y>x)return-1}if(ne.isZero(h)){if(_>r||r>m)return-1}else{var w=1/h,b=(_-r)*w,C=(m-r)*w;if(b>C){var M=b;b=C,C=M}if(y=Math.max(b,y),x=Math.min(C,x),y>x)return-1}if(ne.isZero(l)){if(d>a||a>g)return-1}else{var D=1/l,A=(d-a)*D,R=(g-a)*D;if(A>R){var I=A;A=R,R=I}if(y=Math.max(A,y),x=Math.min(R,x),y>x)return-1}return y},t.intersectsRayAndBoxRP=function(e,i,n){var r=t.intersectsRayAndBoxRD(e,i);return-1===r?(_e.ZERO.cloneTo(n),r):(_e.scale(e.direction,r,t._tempV30),_e.add(e.origin,t._tempV30,t._tempV31),t._tempV31.cloneTo(n),r)},t.intersectsRayAndSphereRD=function(e,i){var n=i.radius;_e.subtract(e.origin,i.center,t._tempV30);var r=_e.dot(t._tempV30,e.direction),a=_e.dot(t._tempV30,t._tempV30)-n*n;if(a>0&&r>0)return-1;var s=r*r-a;if(0>s)return-1;var o=-r-Math.sqrt(s);return 0>o&&(o=0),o},t.intersectsRayAndSphereRP=function(e,i,n){var r=t.intersectsRayAndSphereRD(e,i);return-1===r?(_e.ZERO.cloneTo(n),r):(_e.scale(e.direction,r,t._tempV30),_e.add(e.origin,t._tempV30,t._tempV31),t._tempV31.cloneTo(n),r)},t.intersectsSphereAndTriangle=function(e,i,n,r){var a=e.center,s=e.radius;t.closestPointPointTriangle(a,i,n,r,t._tempV30),_e.subtract(t._tempV30,a,t._tempV31);var o=_e.dot(t._tempV31,t._tempV31);return s*s>=o},t.intersectsPlaneAndPoint=function(t,e){var i=_e.dot(t.normal,e)+t.distance;return i>0?oe.PlaneIntersectionType_Front:0>i?oe.PlaneIntersectionType_Back:oe.PlaneIntersectionType_Intersecting},t.intersectsPlaneAndPlane=function(e,i){_e.cross(e.normal,i.normal,t._tempV30);var n=_e.dot(t._tempV30,t._tempV30);return ne.isZero(n)?!1:!0},t.intersectsPlaneAndPlaneRL=function(e,i,n){var r=e.normal,a=i.normal;_e.cross(r,a,t._tempV34);var s=_e.dot(t._tempV34,t._tempV34);return ne.isZero(s)?!1:(_e.scale(a,e.distance,t._tempV30),_e.scale(r,i.distance,t._tempV31),_e.subtract(t._tempV30,t._tempV31,t._tempV32),_e.cross(t._tempV32,t._tempV34,t._tempV33),_e.normalize(t._tempV34,t._tempV34),n=new ue(t._tempV33,t._tempV34),!0)},t.intersectsPlaneAndBox=function(e,i){var n=e.distance,r=e.normal,a=r.elements,s=a[0],o=a[1],h=a[2],l=i.min.elements,u=l[0],c=l[1],_=l[2],d=i.max.elements,f=d[0],p=d[1],m=d[2];t._tempV30.elements[0]=s>0?u:f,t._tempV30.elements[1]=o>0?c:p,t._tempV30.elements[2]=h>0?_:m,t._tempV31.elements[0]=s>0?f:u,t._tempV31.elements[1]=o>0?p:c,t._tempV31.elements[2]=h>0?m:_;var g=_e.dot(r,t._tempV30);return g+n>0?oe.PlaneIntersectionType_Front:(g=_e.dot(r,t._tempV31),0>g+n?oe.PlaneIntersectionType_Back:oe.PlaneIntersectionType_Intersecting)},t.intersectsPlaneAndSphere=function(t,e){var i=e.radius,n=_e.dot(t.normal,e.center)+t.distance;return n>i?oe.PlaneIntersectionType_Front:-i>n?oe.PlaneIntersectionType_Back:oe.PlaneIntersectionType_Intersecting},t.intersectsBoxAndBox=function(t,e){var i=t.min.elements,n=t.max.elements,r=e.min.elements,a=e.max.elements;return i[0]>a[0]||r[0]>n[0]?!1:i[1]>a[1]||r[1]>n[1]?!1:i[2]>a[2]||r[2]>n[2]?!1:!0},t.intersectsBoxAndSphere=function(e,i){var n=i.center,r=i.radius;_e.Clamp(n,e.min,e.max,t._tempV30);var a=_e.distanceSquared(n,t._tempV30);return r*r>=a},t.intersectsSphereAndSphere=function(t,e){var i=t.radius+e.radius;return _e.distanceSquared(t.center,e.center)<=i*i},t.boxContainsPoint=function(t,e){var i=t.min.elements,n=t.max.elements,r=e.elements;return i[0]<=r[0]&&n[0]>=r[0]&&i[1]<=r[1]&&n[1]>=r[1]&&i[2]<=r[2]&&n[2]>=r[2]?1:0},t.boxContainsBox=function(t,e){var i=t.min.elements,n=i[0],r=i[1],a=i[2],s=t.max.elements,o=s[0],h=s[1],l=s[2],u=e.min.elements,c=u[0],_=u[1],d=u[2],f=e.max.elements,p=f[0],m=f[1],g=f[2];return c>o||n>p?0:_>h||r>m?0:d>l||a>g?0:c>=n&&p>=p&&_>=r&&h>=m&&d>=a&&l>=g?1:2},t.boxContainsSphere=function(e,i){var n=e.min,r=n.elements,a=r[0],s=r[1],o=r[2],h=e.max,l=h.elements,u=l[0],c=l[1],_=l[2],d=i.center,f=d.elements,p=f[0],m=f[1],g=f[2],y=i.radius;_e.Clamp(d,n,h,t._tempV30);var x=_e.distanceSquared(d,t._tempV30);return x>y*y?0:p>=a+y&&u-y>=p&&u-a>y&&m>=s+y&&c-y>=m&&c-s>y&&g>=o+y&&_-y>=g&&_-o>y?1:2},t.sphereContainsPoint=function(t,e){return _e.distanceSquared(e,t.center)<=t.radius*t.radius?1:0},t.sphereContainsTriangle=function(e,i,n,r){var a=t.sphereContainsPoint(e,i),s=t.sphereContainsPoint(e,n),o=t.sphereContainsPoint(e,r);return 1==a&&1==s&&1==o?1:t.intersectsSphereAndTriangle(e,i,n,r)?2:0},t.sphereContainsBox=function(e,i){var n=e.center,r=n.elements,a=r[0],s=r[1],o=r[2],h=e.radius,l=i.min,u=l.elements,c=u[0],_=u[1],d=u[2],f=i.max,p=f.elements,m=p[0],g=p[1],y=p[2],x=t._tempV30.elements,v=x[0],S=x[1],T=x[2];if(!t.intersectsBoxAndSphere(i,e))return 0;var E=h*h;return v=a-c,S=s-g,T=o-y,_e.scalarLengthSquared(t._tempV30)>E?2:(v=a-m,S=s-g,T=o-y,_e.scalarLengthSquared(t._tempV30)>E?2:(v=a-m,S=s-_,T=o-y,_e.scalarLengthSquared(t._tempV30)>E?2:(v=a-c,S=s-_,T=o-y,_e.scalarLengthSquared(t._tempV30)>E?2:(v=a-c,S=s-g,T=o-d,_e.scalarLengthSquared(t._tempV30)>E?2:(v=a-m,S=s-g,T=o-d,_e.scalarLengthSquared(t._tempV30)>E?2:(v=a-m,S=s-_,T=o-d,_e.scalarLengthSquared(t._tempV30)>E?2:(v=a-c,S=s-_,T=o-d,_e.scalarLengthSquared(t._tempV30)>E?2:1)))))))},t.sphereContainsSphere=function(t,e){var i=t.radius,n=e.radius,r=_e.distance(t.center,e.center);return r>i+n?0:r>i-n?2:1},t.closestPointPointTriangle=function(e,i,n,r,a){_e.subtract(n,i,t._tempV30),_e.subtract(r,i,t._tempV31),_e.subtract(e,i,t._tempV32),_e.subtract(e,n,t._tempV33),_e.subtract(e,r,t._tempV34);var s=_e.dot(t._tempV30,t._tempV32),o=_e.dot(t._tempV31,t._tempV32),h=_e.dot(t._tempV30,t._tempV33),l=_e.dot(t._tempV31,t._tempV33),u=_e.dot(t._tempV30,t._tempV34),c=_e.dot(t._tempV31,t._tempV34);if(0>=s&&0>=o)return void i.cloneTo(a);if(h>=0&&h>=l)return void n.cloneTo(a);var _=s*l-h*o;if(0>=_&&s>=0&&0>=h){var d=s/(s-h);return _e.scale(t._tempV30,d,a),void _e.add(i,a,a)}if(c>=0&&c>=u)return void r.cloneTo(a);var f=u*o-s*c;if(0>=f&&o>=0&&0>=c){var p=o/(o-c);return _e.scale(t._tempV31,p,a),void _e.add(i,a,a)}var m=h*c-u*l;if(0>=m&&l-h>=0&&u-c>=0){var g=(l-h)/(l-h+(u-c));return _e.subtract(r,n,a),_e.scale(a,g,a),void _e.add(n,a,a)}var y=1/(m+f+_),x=f*y,v=_*y;_e.scale(t._tempV30,x,t._tempV35),_e.scale(t._tempV31,v,t._tempV36),_e.add(t._tempV35,t._tempV36,a),_e.add(i,a,a)},t.closestPointPlanePoint=function(e,i,n){var r=e.normal,a=_e.dot(r,i)-e.distance;_e.scale(r,a,t._tempV30),_e.subtract(i,t._tempV30,n)},t.closestPointBoxPoint=function(e,i,n){_e.max(i,e.min,t._tempV30),_e.min(t._tempV30,e.max,n)},t.closestPointSpherePoint=function(t,e,i){var n=t.center;_e.subtract(e,n,i),_e.normalize(i,i),_e.scale(i,t.radius,i),_e.add(i,n,i)},t.closestPointSphereSphere=function(t,e,i){var n=t.center;_e.subtract(e.center,n,i),_e.normalize(i,i),_e.scale(i,t.radius,i),_e.add(i,n,i)},n(t,["_tempV30",function(){return this._tempV30=new _e},"_tempV31",function(){return this._tempV31=new _e},"_tempV32",function(){return this._tempV32=new _e},"_tempV33",function(){return this._tempV33=new _e},"_tempV34",function(){return this._tempV34=new _e},"_tempV35",function(){return this._tempV35=new _e},"_tempV36",function(){return this._tempV36=new _e}]),t}(),ne=(function(){function t(){}return r(t,"laya.d3.math.ContainmentType"),t.Disjoint=0,t.Contains=1,t.Intersects=2,t}(),function(){function t(){}return r(t,"laya.d3.math.MathUtils3D"),t.isZero=function(e){return Math.abs(e)<t.zeroTolerance},t.nearEqual=function(e,i){return t.isZero(e-i)?!0:!1},t.fastInvSqrt=function(e){return t.isZero(e)?e:1/Math.sqrt(e)},n(t,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),t}()),re=function(){function t(){var t=this.elements=new Float32Array(9);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1}r(t,"laya.d3.math.Matrix3x3");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.determinant=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],a=t[4],s=t[5],o=t[6],h=t[7],l=t[8];return e*(l*a-s*h)+i*(-l*r+s*o)+n*(h*r-a*o)},e.translate=function(t,e){var i=e.elements,n=this.elements,r=t.elements,a=n[0],s=n[1],o=n[2],h=n[3],l=n[4],u=n[5],c=n[6],_=n[7],d=n[8],f=r[0],p=r[1];i[0]=a,i[1]=s,i[2]=o,i[3]=h,i[4]=l,i[5]=u,i[6]=f*a+p*h+c,i[7]=f*s+p*l+_,i[8]=f*o+p*u+d},e.rotate=function(t,e){var i=e.elements,n=this.elements,r=n[0],a=n[1],s=n[2],o=n[3],h=n[4],l=n[5],u=n[6],c=n[7],_=n[8],d=Math.sin(t),f=Math.cos(t);i[0]=f*r+d*o,i[1]=f*a+d*h,i[2]=f*s+d*l,i[3]=f*o-d*r,i[4]=f*h-d*a,i[5]=f*l-d*s,i[6]=u,i[7]=c,i[8]=_},e.scale=function(t,e){var i=e.elements,n=this.elements,r=t.elements,a=r[0],s=r[1];i[0]=a*n[0],i[1]=a*n[1],i[2]=a*n[2],i[3]=s*n[3],i[4]=s*n[4],i[5]=s*n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8]},e.invert=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],h=i[5],l=i[6],u=i[7],c=i[8],_=c*o-h*u,d=-c*s+h*l,f=u*s-o*l,p=n*_+r*d+a*f;p||(t=null),p=1/p,e[0]=_*p,e[1]=(-c*r+a*u)*p,e[2]=(h*r-a*o)*p,e[3]=d*p,e[4]=(c*n-a*l)*p,e[5]=(-h*n+a*s)*p,e[6]=f*p,e[7]=(-u*n+r*l)*p,e[8]=(o*n-r*s)*p},e.transpose=function(t){var e=t.elements,i=this.elements;if(t===this){var n=i[1],r=i[2],a=i[5];e[1]=i[3],e[2]=i[6],e[3]=n,e[5]=i[7],e[6]=r,e[7]=a}else e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8]},e.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;9>e;++e)n[e]=i[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},t.createFromTranslation=function(t,e){var i=(e.elements,t.elements);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=i[0],e[7]=i[1],e[8]=1},t.createFromRotation=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[0]=r,i[1]=n,i[2]=0,i[3]=-n,i[4]=r,i[5]=0,i[6]=0,i[7]=0,i[8]=1},t.createFromScaling=function(t,e){var i=e.elements,n=t.elements;i[0]=n[0],i[1]=0,i[2]=0,i[3]=0,i[4]=n[1],i[5]=0,i[6]=0,i[7]=0,i[8]=1},t.createFromMatrix4x4=function(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]},t.multiply=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements,s=r[0],o=r[1],h=r[2],l=r[3],u=r[4],c=r[5],_=r[6],d=r[7],f=r[8],p=a[0],m=a[1],g=a[2],y=a[3],x=a[4],v=a[5],S=a[6],T=a[7],E=a[8];n[0]=p*s+m*l+g*_,n[1]=p*o+m*u+g*d,n[2]=p*h+m*c+g*f,n[3]=y*s+x*l+v*_,n[4]=y*o+x*u+v*d,n[5]=y*h+x*c+v*f,n[6]=S*s+T*l+E*_,n[7]=S*o+T*u+E*d,n[8]=S*h+T*c+E*f},t.lookAt=function(e,i,n,r){_e.subtract(e,i,t._tempV30),_e.normalize(t._tempV30,t._tempV30),_e.cross(n,t._tempV30,t._tempV31),_e.normalize(t._tempV31,t._tempV31),_e.cross(t._tempV30,t._tempV31,t._tempV32);var a=t._tempV30.elements,s=t._tempV31.elements,o=t._tempV32.elements,h=r.elements;h[0]=s[0],h[3]=s[1],h[6]=s[2],h[1]=o[0],h[4]=o[1],h[7]=o[2],h[2]=a[0],h[5]=a[1],h[8]=a[2]},t.DEFAULT=new t,n(t,["_tempV30",function(){return this._tempV30=new _e},"_tempV31",function(){return this._tempV31=new _e},"_tempV32",function(){return this._tempV32=new _e}]),t}(),ae=function(){function t(t,e,i,n,r,a,s,o,h,l,u,c,_,d,f,p){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===o&&(o=0),void 0===h&&(h=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===c&&(c=0),void 0===_&&(_=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===p&&(p=1);var m=this.elements=new Float32Array(16);m[0]=t,m[1]=e,m[2]=i,m[3]=n,m[4]=r,m[5]=a,m[6]=s,m[7]=o,m[8]=h,m[9]=l,m[10]=u,m[11]=c,m[12]=_,m[13]=d,m[14]=f,m[15]=p}r(t,"laya.d3.math.Matrix4x4");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.getElementByRowColumn=function(t,e){if(0>t||t>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(0>e||e>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*t+e]},e.setElementByRowColumn=function(t,e,i){if(0>t||t>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(0>e||e>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*t+e]=i},e.equalsOtherMatrix=function(t){var e=this.elements,i=t.elements;return ne.nearEqual(e[0],i[0])&&ne.nearEqual(e[1],i[1])&&ne.nearEqual(e[2],i[2])&&ne.nearEqual(e[3],i[3])&&ne.nearEqual(e[4],i[4])&&ne.nearEqual(e[5],i[5])&&ne.nearEqual(e[6],i[6])&&ne.nearEqual(e[7],i[7])&&ne.nearEqual(e[8],i[8])&&ne.nearEqual(e[9],i[9])&&ne.nearEqual(e[10],i[10])&&ne.nearEqual(e[11],i[11])&&ne.nearEqual(e[12],i[12])&&ne.nearEqual(e[13],i[13])&&ne.nearEqual(e[14],i[14])&&ne.nearEqual(e[15],i[15])},e.decomposeTransRotScale=function(e,i,n){var r=t._tempMatrix4x4;return this.decomposeTransRotMatScale(e,r,n)?(he.createFromMatrix4x4(r,i),!0):(i.identity(),!1)},e.decomposeTransRotMatScale=function(e,i,n){var r=this.elements,a=e.elements,s=i.elements,o=n.elements;a[0]=r[12],a[1]=r[13],a[2]=r[14];var h=r[0],l=r[1],u=r[2],c=r[4],_=r[5],d=r[6],f=r[8],p=r[9],m=r[10],g=o[0]=Math.sqrt(h*h+l*l+u*u),y=o[1]=Math.sqrt(c*c+_*_+d*d),x=o[2]=Math.sqrt(f*f+p*p+m*m);if(ne.isZero(g)||ne.isZero(y)||ne.isZero(x))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var v=t._tempVector0,S=v.elements;S[0]=f/x,S[1]=p/x,S[2]=m/x;var T=t._tempVector1,E=T.elements;E[0]=h/g,E[1]=l/g,E[2]=u/g;var w=t._tempVector2;_e.cross(v,T,w);var b=t._tempVector1;return _e.cross(w,v,b),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=b.x,s[1]=b.y,s[2]=b.z,s[4]=w.x,s[5]=w.y,s[6]=w.z,s[8]=v.x,s[9]=v.y,s[10]=v.z,s[0]*h+s[1]*l+s[2]*u<0&&(o[0]=-g),s[4]*c+s[5]*_+s[6]*d<0&&(o[1]=-y),s[8]*f+s[9]*p+s[10]*m<0&&(o[2]=-x),!0},e.decomposeYawPitchRoll=function(t){var e=t.elements,i=Math.asin(-this.elements[9]);e[1]=i;var n=Math.cos(i);n>ne.zeroTolerance?(e[2]=Math.atan2(this.elements[1],this.elements[5]),e[0]=Math.atan2(this.elements[8],this.elements[10])):(e[2]=Math.atan2(-this.elements[4],this.elements[0]),e[0]=0)},e.normalize=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=Math.sqrt(e*e+i*i+n*n);return r?void(1!=r&&(r=1/r,t[0]=e*r,t[1]=i*r,t[2]=n*r)):(t[0]=0,t[1]=0,void(t[2]=0))},e.transpose=function(){var t,e;return t=this.elements,e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},e.invert=function(t){var e=this.elements,i=t.elements,n=e[0],r=e[1],a=e[2],s=e[3],o=e[4],h=e[5],l=e[6],u=e[7],c=e[8],_=e[9],d=e[10],f=e[11],p=e[12],m=e[13],g=e[14],y=e[15],x=n*h-r*o,v=n*l-a*o,S=n*u-s*o,T=r*l-a*h,E=r*u-s*h,w=a*u-s*l,b=c*m-_*p,C=c*g-d*p,M=c*y-f*p,D=_*g-d*m,A=_*y-f*m,R=d*y-f*g,I=x*R-v*A+S*D+T*M-E*C+w*b;0!==Math.abs(I)&&(I=1/I,i[0]=(h*R-l*A+u*D)*I,i[1]=(a*A-r*R-s*D)*I,i[2]=(m*w-g*E+y*T)*I,i[3]=(d*E-_*w-f*T)*I,i[4]=(l*M-o*R-u*C)*I,i[5]=(n*R-a*M+s*C)*I,i[6]=(g*S-p*w-y*v)*I,i[7]=(c*w-d*S+f*v)*I,i[8]=(o*A-h*M+u*b)*I,i[9]=(r*M-n*A-s*b)*I,i[10]=(p*E-m*S+y*x)*I,i[11]=(_*S-c*E-f*x)*I,i[12]=(h*C-o*D-l*b)*I,i[13]=(n*D-r*C+a*b)*I,i[14]=(m*v-p*T-g*x)*I,i[15]=(c*T-_*v+d*x)*I)},e.identity=function(){var t=this.elements;t[1]=t[2]=t[3]=t[4]=t[6]=t[7]=t[8]=t[9]=t[11]=t[12]=t[13]=t[14]=0,t[0]=t[5]=t[10]=t[15]=1},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;16>e;++e)n[e]=i[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.getTranslationVector=function(t){var e=this.elements,i=t.elements;i[0]=e[12],i[1]=e[13],i[2]=e[14]},e.setTranslationVector=function(t){var e=this.elements,i=t.elements;e[12]=i[0],e[13]=i[1],e[14]=i[2]},e.getForward=function(t){var e=this.elements,i=t.elements;i[0]=-e[8],i[1]=-e[9],i[2]=-e[10]},e.setForward=function(t){var e=this.elements,i=t.elements;e[8]=-i[0],e[9]=-i[1],e[10]=-i[2]},t.createRotationX=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[1]=i[2]=i[3]=i[4]=i[7]=i[8]=i[11]=i[12]=i[13]=i[14]=0,i[0]=i[15]=1,i[5]=i[10]=r,i[6]=n,i[9]=-n},t.createRotationY=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[1]=i[3]=i[4]=i[6]=i[7]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[5]=i[15]=1,i[0]=i[10]=r,i[2]=-n,i[8]=n},t.createRotationZ=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[2]=i[3]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[10]=i[15]=1,i[0]=i[5]=r,i[1]=n,i[4]=-n},t.createRotationYawPitchRoll=function(e,i,n,r){he.createFromYawPitchRoll(e,i,n,t._tempQuaternion),t.createRotationQuaternion(t._tempQuaternion,r)},t.createRotationAxis=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=Math.cos(e),h=Math.sin(e),l=r*r,u=a*a,c=s*s,_=r*a,d=r*s,f=a*s,p=i.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=l+o*(1-l),p[1]=_-o*_+h*s,p[2]=d-o*d-h*a,p[4]=_-o*_-h*s,p[5]=u+o*(1-u),p[6]=f-o*f+h*r,p[8]=d-o*d+h*a,p[9]=f-o*f-h*r,p[10]=c+o*(1-c)},t.createRotationQuaternion=function(t,e){var i=t.elements,n=e.elements,r=i[0],a=i[1],s=i[2],o=i[3],h=r*r,l=a*a,u=s*s,c=r*a,_=s*o,d=s*r,f=a*o,p=a*s,m=r*o;n[3]=n[7]=n[11]=n[12]=n[13]=n[14]=0,n[15]=1,n[0]=1-2*(l+u),n[1]=2*(c+_),n[2]=2*(d-f),n[4]=2*(c-_),n[5]=1-2*(u+h),n[6]=2*(p+m),n[8]=2*(d+f),n[9]=2*(p-m),n[10]=1-2*(l+h)},t.createTranslate=function(t,e){var i=t.elements,n=e.elements;n[4]=n[8]=n[1]=n[9]=n[2]=n[6]=n[3]=n[7]=n[11]=0,n[0]=n[5]=n[10]=n[15]=1,n[12]=i[0],n[13]=i[1],n[14]=i[2]},t.createScaling=function(t,e){var i=t.elements,n=e.elements;n[0]=i[0],n[5]=i[1],n[10]=i[2],n[1]=n[4]=n[8]=n[12]=n[9]=n[13]=n[2]=n[6]=n[14]=n[3]=n[7]=n[11]=0,n[15]=1},t.multiply=function(t,e,i){var n,r,a,s,o,h,l,u;if(r=i.elements,a=t.elements,s=e.elements,r===s)for(s=new Float32Array(16),n=0;16>n;++n)s[n]=r[n];for(n=0;4>n;n++)o=a[n],h=a[n+4],l=a[n+8],u=a[n+12],r[n]=o*s[0]+h*s[1]+l*s[2]+u*s[3],r[n+4]=o*s[4]+h*s[5]+l*s[6]+u*s[7],r[n+8]=o*s[8]+h*s[9]+l*s[10]+u*s[11],r[n+12]=o*s[12]+h*s[13]+l*s[14]+u*s[15]},t.createFromQuaternion=function(t,e){var i=e.elements,n=t.elements,r=n[0],a=n[1],s=n[2],o=n[3],h=r+r,l=a+a,u=s+s,c=r*h,_=a*h,d=a*l,f=s*h,p=s*l,m=s*u,g=o*h,y=o*l,x=o*u;i[0]=1-d-m,i[1]=_+x,i[2]=f-y,i[3]=0,i[4]=_-x,i[5]=1-c-m,i[6]=p+g,i[7]=0,i[8]=f+y,i[9]=p-g,i[10]=1-c-d,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1},t.createAffineTransformation=function(t,e,i,n){var r=t.elements,a=e.elements,s=i.elements,o=n.elements,h=a[0],l=a[1],u=a[2],c=a[3],_=h+h,d=l+l,f=u+u,p=h*_,m=h*d,g=h*f,y=l*d,x=l*f,v=u*f,S=c*_,T=c*d,E=c*f,w=s[0],b=s[1],C=s[2];o[0]=(1-(y+v))*w,o[1]=(m+E)*w,o[2]=(g-T)*w,o[3]=0,o[4]=(m-E)*b,o[5]=(1-(p+v))*b,o[6]=(x+S)*b,o[7]=0,o[8]=(g+T)*C,o[9]=(x-S)*C,o[10]=(1-(p+y))*C,o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1},t.createLookAt=function(e,i,n,r){var a=r.elements,s=t._tempVector0,o=t._tempVector1,h=t._tempVector2;_e.subtract(e,i,h),_e.normalize(h,h),_e.cross(n,h,s),_e.normalize(s,s),_e.cross(h,s,o),r.identity(),a[0]=s.x,a[4]=s.y,a[8]=s.z,a[1]=o.x,a[5]=o.y,a[9]=o.z,a[2]=h.x,a[6]=h.y,a[10]=h.z,a[12]=-_e.dot(s,e),a[13]=-_e.dot(o,e),a[14]=-_e.dot(h,e)},t.createPerspective=function(t,e,i,n,r){var a=r.elements,s=1/Math.tan(.5*t),o=n/(i-n);a[0]=s/e,a[5]=s,a[10]=o,a[11]=-1,a[14]=o*i,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},t.createOrthogonal=function(t,e,i,n,r,a,s){var o=s.elements,h=1/(t-e),l=1/(i-n),u=1/(r-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1,o[0]=-2*h,o[5]=-2*l,o[10]=2*u,o[12]=(t+e)*h,o[13]=(n+i)*l,o[14]=(a+r)*u},t.translation=function(t,e){var i=t.elements,n=e.elements;n[0]=n[5]=n[10]=n[15]=1,n[12]=i[0],n[13]=i[1],n[14]=i[2]},n(t,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new t},"_tempVector0",function(){return this._tempVector0=new _e},"_tempVector1",function(){return this._tempVector1=new _e},"_tempVector2",function(){return this._tempVector2=new _e},"_tempQuaternion",function(){return this._tempQuaternion=new he},"DEFAULT",function(){return this.DEFAULT=new t}]),t}(),se=function(){function t(t,e){this.extents=null,this.transformation=null,this.extents=t,this.transformation=e}r(t,"laya.d3.math.OrientedBoundBox");var e=t.prototype;return e.getCorners=function(e){var i=this.extents.elements;e.length=8;var n=t._tempV30.elements,r=t._tempV31.elements,a=t._tempV32.elements;n[0]=i[0],n[1]=n[2]=0,r[1]=i[1],r[0]=r[2]=0,a[2]=i[2],a[0]=a[1]=0,_e.TransformNormal(t._tempV30,this.transformation,t._tempV30),_e.TransformNormal(t._tempV31,this.transformation,t._tempV31),
_e.TransformNormal(t._tempV32,this.transformation,t._tempV32);var s=t._tempV33;this.transformation.getTranslationVector(s),_e.add(s,t._tempV30,t._tempV34),_e.add(t._tempV34,t._tempV31,t._tempV34),_e.add(t._tempV34,t._tempV32,e[0]),_e.add(s,t._tempV30,t._tempV34),_e.add(t._tempV34,t._tempV31,t._tempV34),_e.subtract(t._tempV34,t._tempV32,e[1]),_e.subtract(s,t._tempV30,t._tempV34),_e.add(t._tempV34,t._tempV31,t._tempV34),_e.subtract(t._tempV34,t._tempV32,e[2]),_e.subtract(s,t._tempV30,t._tempV34),_e.add(t._tempV34,t._tempV31,t._tempV34),_e.add(t._tempV34,t._tempV32,e[3]),_e.add(s,t._tempV30,t._tempV34),_e.subtract(t._tempV34,t._tempV31,t._tempV34),_e.add(t._tempV34,t._tempV32,e[4]),_e.add(s,t._tempV30,t._tempV34),_e.subtract(t._tempV34,t._tempV31,t._tempV34),_e.subtract(t._tempV34,t._tempV32,e[5]),_e.subtract(s,t._tempV30,t._tempV34),_e.subtract(t._tempV34,t._tempV31,t._tempV34),_e.subtract(t._tempV34,t._tempV32,e[6]),_e.subtract(s,t._tempV30,t._tempV34),_e.subtract(t._tempV34,t._tempV31,t._tempV34),_e.add(t._tempV34,t._tempV32,e[7])},e.transform=function(t){ae.multiply(this.transformation,t,this.transformation)},e.scale=function(t){_e.multiply(this.extents,t,this.extents)},e.translate=function(e){this.transformation.getTranslationVector(t._tempV30),_e.add(t._tempV30,e,t._tempV31),this.transformation.setTranslationVector(t._tempV31)},e.Size=function(t){_e.scale(this.extents,2,t)},e.getSize=function(e){var i=this.extents.elements;t._tempV30.x=i[0],t._tempV31.y=i[1],t._tempV32.z=i[2],_e.TransformNormal(t._tempV30,this.transformation,t._tempV30),_e.TransformNormal(t._tempV31,this.transformation,t._tempV31),_e.TransformNormal(t._tempV31,this.transformation,t._tempV32);var n=e.elements;n[0]=_e.scalarLength(t._tempV30),n[1]=_e.scalarLength(t._tempV31),n[2]=_e.scalarLength(t._tempV32)},e.getSizeSquared=function(e){var i=this.extents.elements;t._tempV30.x=i[0],t._tempV31.y=i[1],t._tempV32.z=i[2],_e.TransformNormal(t._tempV30,this.transformation,t._tempV30),_e.TransformNormal(t._tempV31,this.transformation,t._tempV31),_e.TransformNormal(t._tempV31,this.transformation,t._tempV32);var n=e.elements;n[0]=_e.scalarLengthSquared(t._tempV30),n[1]=_e.scalarLengthSquared(t._tempV31),n[2]=_e.scalarLengthSquared(t._tempV32)},e.getCenter=function(t){this.transformation.getTranslationVector(t)},e.containsPoint=function(e){var i=this.extents.elements,n=i[0],r=i[1],a=i[2];this.transformation.invert(t._tempM0),_e.transformCoordinate(e,t._tempM0,t._tempV30);var s=t._tempV30.elements,o=Math.abs(s[0]),h=Math.abs(s[1]),l=Math.abs(s[2]);return ne.nearEqual(o,n)&&ne.nearEqual(h,r)&&ne.nearEqual(l,a)?2:n>o&&r>h&&a>l?1:0},e.containsPoints=function(e){var i=this.extents.elements,n=i[0],r=i[1],a=i[2];this.transformation.invert(t._tempM0);for(var s=!0,o=!1,h=0;h<e.length;h++){_e.transformCoordinate(e[h],t._tempM0,t._tempV30);var l=t._tempV30.elements,u=Math.abs(l[0]),c=Math.abs(l[1]),_=Math.abs(l[2]);ne.nearEqual(u,n)&&ne.nearEqual(c,r)&&ne.nearEqual(_,a)&&(o=!0),n>u&&r>c&&_>a?o=!0:s=!1}return s?1:o?2:0},e.containsSphere=function(e,i){void 0===i&&(i=!1);var n=this.extents.elements,r=n[0],a=n[1],s=n[2],o=e.radius;this.transformation.invert(t._tempM0),_e.transformCoordinate(e.center,t._tempM0,t._tempV30);var h=NaN;i?h=o:(_e.scale(_e.UnitX,o,t._tempV31),_e.TransformNormal(t._tempV31,t._tempM0,t._tempV31),h=_e.scalarLength(t._tempV31)),_e.scale(this.extents,-1,t._tempV32),_e.Clamp(t._tempV30,t._tempV32,this.extents,t._tempV33);var l=_e.distanceSquared(t._tempV30,t._tempV33);if(l>h*h)return 0;var u=t._tempV30.elements,c=u[0],_=u[1],d=u[2],f=t._tempV32.elements,p=f[0],m=f[1],g=f[2];return c>=p+h&&r-h>=c&&r-p>h&&_>=m+h&&a-h>=_&&a-m>h&&d>=g+h&&s-h>=d&&s-g>h?1:2},e.containsOrientedBoundBox=function(e){var i=0,n=0;e.getCorners(t._corners);var r=this.containsPoints(t._corners);if(0!=r)return r;var a=this.extents.elements;e.extents.cloneTo(t._tempV35);var s=t._tempV35.elements;t._getRows(this.transformation,t._rows1),t._getRows(e.transformation,t._rows2);var o=NaN,h=NaN,l=NaN,u=NaN;for(i=0;3>i;i++)for(n=0;3>n;n++)u=_e.dot(t._rows1[i],t._rows2[n]),t._tempM0.setElementByRowColumn(i,n,u),t._tempM1.setElementByRowColumn(i,n,Math.abs(u));e.getCenter(t._tempV34),this.getCenter(t._tempV36),_e.subtract(t._tempV34,t._tempV36,t._tempV30);var c=t._tempV31.elements;c[0]=_e.dot(t._tempV30,t._rows1[0]),c[1]=_e.dot(t._tempV30,t._rows1[1]),c[2]=_e.dot(t._tempV30,t._rows1[2]);var _=t._tempV32.elements,d=t._tempV33.elements;for(i=0;3>i;i++)if(_[0]=t._tempM1.getElementByRowColumn(i,0),_[1]=t._tempM1.getElementByRowColumn(i,1),_[2]=t._tempM1.getElementByRowColumn(i,2),o=a[i],h=_e.dot(t._tempV35,t._tempV32),l=Math.abs(c[i]),l>o+h)return 0;for(n=0;3>n;n++)if(_[0]=t._tempM1.getElementByRowColumn(0,n),_[1]=t._tempM1.getElementByRowColumn(1,n),_[2]=t._tempM1.getElementByRowColumn(2,n),d[0]=t._tempM0.getElementByRowColumn(0,n),d[1]=t._tempM0.getElementByRowColumn(1,n),d[2]=t._tempM0.getElementByRowColumn(2,n),o=_e.dot(this.extents,t._tempV32),h=s[n],l=Math.abs(_e.dot(t._tempV31,t._tempV33)),l>o+h)return 0;for(i=0;3>i;i++)for(n=0;3>n;n++){var f=(i+1)%3,p=(i+2)%3,m=(n+1)%3,g=(n+2)%3;if(o=a[f]*t._tempM1.getElementByRowColumn(p,n)+s[p]*t._tempM1.getElementByRowColumn(p,n),h=a[m]*t._tempM1.getElementByRowColumn(i,g)+s[g]*t._tempM1.getElementByRowColumn(i,m),l=Math.abs(c[p]*t._tempM0.getElementByRowColumn(f,n)-c[f]*t._tempM0.getElementByRowColumn(p,n)),l>o+h)return 0}return 2},e.containsLine=function(e,i){t._corners[0]=e,t._corners[1]=i;var n=this.containsPoints(t._corners);if(0!=n)return n;var r=this.extents.elements,a=r[0],s=r[1],o=r[2];this.transformation.invert(t._tempM0),_e.transformCoordinate(e,t._tempM0,t._tempV30),_e.transformCoordinate(i,t._tempM0,t._tempV31),_e.add(t._tempV30,t._tempV31,t._tempV32),_e.scale(t._tempV32,.5,t._tempV32),_e.subtract(t._tempV30,t._tempV32,t._tempV33);var h=t._tempV33.elements,l=h[0],u=h[1],c=h[2],_=t._tempV34.elements,d=_[0]=Math.abs(h[0]),f=_[1]=Math.abs(h[1]),p=_[2]=Math.abs(h[2]),m=t._tempV32.elements,g=m[0],y=m[1],x=m[2];return Math.abs(g)>a+d?0:Math.abs(y)>s+f?0:Math.abs(x)>o+p?0:Math.abs(y*c-x*u)>s*p+o*f?0:Math.abs(g*c-x*l)>a*p+o*d?0:Math.abs(g*u-y*l)>a*f+s*d?0:2},e.containsBoundBox=function(e){var i=0,n=0,r=e.min,a=e.max;e.getCorners(t._corners);var s=this.containsPoints(t._corners);if(0!=s)return s;_e.subtract(a,r,t._tempV30),_e.scale(t._tempV30,.5,t._tempV30),_e.add(r,t._tempV30,t._tempV30),_e.subtract(a,t._tempV30,t._tempV31);var o=this.extents.elements,h=t._tempV31.elements;t._getRows(this.transformation,t._rows1),this.transformation.invert(t._tempM0);var l=NaN,u=NaN,c=NaN;for(i=0;3>i;i++)for(n=0;3>n;n++)t._tempM1.setElementByRowColumn(i,n,Math.abs(t._tempM0.getElementByRowColumn(i,n)));this.getCenter(t._tempV35),_e.subtract(t._tempV30,t._tempV35,t._tempV32);var _=t._tempV31.elements;_[0]=_e.dot(t._tempV32,t._rows1[0]),_[1]=_e.dot(t._tempV32,t._rows1[1]),_[2]=_e.dot(t._tempV32,t._rows1[2]);var d=t._tempV33.elements,f=t._tempV34.elements;for(i=0;3>i;i++)if(d[0]=t._tempM1.getElementByRowColumn(i,0),d[1]=t._tempM1.getElementByRowColumn(i,1),d[2]=t._tempM1.getElementByRowColumn(i,2),l=o[i],u=_e.dot(t._tempV31,t._tempV33),c=Math.abs(_[i]),c>l+u)return 0;for(n=0;3>n;n++)if(d[0]=t._tempM1.getElementByRowColumn(0,n),d[1]=t._tempM1.getElementByRowColumn(1,n),d[2]=t._tempM1.getElementByRowColumn(2,n),f[0]=t._tempM0.getElementByRowColumn(0,n),f[1]=t._tempM0.getElementByRowColumn(1,n),f[2]=t._tempM0.getElementByRowColumn(2,n),l=_e.dot(this.extents,t._tempV33),u=h[n],c=Math.abs(_e.dot(t._tempV31,t._tempV34)),c>l+u)return 0;for(i=0;3>i;i++)for(n=0;3>n;n++){var p=(i+1)%3,m=(i+2)%3,g=(n+1)%3,y=(n+2)%3;if(l=o[p]*t._tempM1.getElementByRowColumn(m,n)+o[m]*t._tempM1.getElementByRowColumn(p,n),u=h[g]*t._tempM1.getElementByRowColumn(i,y)+h[y]*t._tempM1.getElementByRowColumn(i,g),c=Math.abs(_[m]*t._tempM0.getElementByRowColumn(p,n)-_[p]*t._tempM0.getElementByRowColumn(m,n)),c>l+u)return 0}return 2},e.intersectsRay=function(e,i){_e.scale(this.extents,-1,t._tempV30),this.transformation.invert(t._tempM0),_e.TransformNormal(e.direction,t._tempM0,t._ray.direction),_e.transformCoordinate(e.origin,t._tempM0,t._ray.origin),t._boxBound1.min=t._tempV30,t._boxBound1.max=this.extents;var n=ie.intersectsRayAndBoxRP(t._ray,t._boxBound1,i);return-1!==n&&_e.transformCoordinate(i,this.transformation,i),n},e._getLocalCorners=function(e){e.length=8;var i=this.extents.elements;t._tempV30.x=i[0],t._tempV31.y=i[1],t._tempV32.z=i[2],_e.add(t._tempV30,t._tempV31,t._tempV33),_e.add(t._tempV33,t._tempV32,e[0]),_e.add(t._tempV30,t._tempV31,t._tempV33),_e.subtract(t._tempV33,t._tempV32,e[1]),_e.subtract(t._tempV31,t._tempV30,t._tempV33),_e.subtract(t._tempV33,t._tempV30,e[2]),_e.subtract(t._tempV31,t._tempV30,t._tempV33),_e.add(t._tempV33,t._tempV32,e[3]),_e.subtract(t._tempV30,t._tempV31,t._tempV33),_e.add(t._tempV33,t._tempV32,e[4]),_e.subtract(t._tempV30,t._tempV31,t._tempV33),_e.subtract(t._tempV33,t._tempV32,e[5]),_e.scale(e[0],-1,e[6]),_e.subtract(t._tempV32,t._tempV30,t._tempV33),_e.subtract(t._tempV33,t._tempV31,e[7])},e.equals=function(t){return this.extents==t.extents&&this.transformation==t.transformation},e.cloneTo=function(t){var e=t;this.extents.cloneTo(e.extents),this.transformation.cloneTo(e.transformation)},t.createByBoundBox=function(e,i){var n=e.min,r=e.max;_e.subtract(r,n,t._tempV30),_e.scale(t._tempV30,.5,t._tempV30),_e.add(n,t._tempV30,t._tempV31),_e.subtract(r,t._tempV31,t._tempV32),ae.translation(t._tempV31,t._tempM0);var a=t._tempV32.clone(),s=t._tempM0.clone();i.extents=a,i.transformation=s},t.createByMinAndMaxVertex=function(e,i){_e.subtract(i,e,t._tempV30),_e.scale(t._tempV30,.5,t._tempV30),_e.add(e,t._tempV30,t._tempV31),_e.subtract(i,t._tempV31,t._tempV32),ae.translation(t._tempV31,t._tempM0);var n=new t(t._tempV32,t._tempM0);return n},t._getRows=function(t,e){e.length=3;var i=t.elements,n=e[0].elements;n[0]=i[0],n[1]=i[1],n[2]=i[2];var r=e[1].elements;r[0]=i[4],r[1]=i[5],r[2]=i[6];var a=e[2].elements;a[0]=i[8],a[1]=i[9],a[2]=i[10]},t.getObbtoObbMatrix4x4=function(e,i,n,r){var a=e.transformation,s=i.transformation;if(n){t._getRows(a,t._rows1),t._getRows(s,t._rows2);for(var o=0;3>o;o++)for(var h=0;3>h;h++)r.setElementByRowColumn(o,h,_e.dot(t._rows2[o],t._rows1[h]));i.getCenter(t._tempV30),e.getCenter(t._tempV31),_e.subtract(t._tempV30,t._tempV31,t._tempV32);var l=r.elements;l[12]=_e.dot(t._tempV32,t._rows1[0]),l[13]=_e.dot(t._tempV32,t._rows1[1]),l[14]=_e.dot(t._tempV32,t._rows1[2]),l[15]=1}else a.invert(t._tempM0),ae.multiply(s,t._tempM0,r)},t.merge=function(e,i,n){var r=e.extents,a=e.transformation;t.getObbtoObbMatrix4x4(e,i,n,t._tempM0),i._getLocalCorners(t._corners),_e.transformCoordinate(t._corners[0],t._tempM0,t._corners[0]),_e.transformCoordinate(t._corners[1],t._tempM0,t._corners[1]),_e.transformCoordinate(t._corners[2],t._tempM0,t._corners[2]),_e.transformCoordinate(t._corners[3],t._tempM0,t._corners[3]),_e.transformCoordinate(t._corners[4],t._tempM0,t._corners[4]),_e.transformCoordinate(t._corners[5],t._tempM0,t._corners[5]),_e.transformCoordinate(t._corners[6],t._tempM0,t._corners[6]),_e.transformCoordinate(t._corners[7],t._tempM0,t._corners[7]),_e.scale(r,-1,t._boxBound1.min),r.cloneTo(t._boxBound1.max),Jt.createfromPoints(t._corners,t._boxBound2),Jt.merge(t._boxBound2,t._boxBound1,t._boxBound3);var s=t._boxBound3.min,o=t._boxBound3.max;_e.subtract(o,s,t._tempV30),_e.scale(t._tempV30,.5,t._tempV30),_e.add(s,t._tempV30,t._tempV32),_e.subtract(o,t._tempV32,r),_e.transformCoordinate(t._tempV32,a,t._tempV33)},t._corners=[],t._rows1=[],t._rows2=[],n(t,["_tempV30",function(){return this._tempV30=new _e},"_tempV31",function(){return this._tempV31=new _e},"_tempV32",function(){return this._tempV32=new _e},"_tempV33",function(){return this._tempV33=new _e},"_tempV34",function(){return this._tempV34=new _e},"_tempV35",function(){return this._tempV35=new _e},"_tempV36",function(){return this._tempV36=new _e},"_tempM0",function(){return this._tempM0=new ae},"_tempM1",function(){return this._tempM1=new ae},"_ray",function(){return this._ray=new ue(new _e,new _e)},"_boxBound1",function(){return this._boxBound1=new Jt(new _e,new _e)},"_boxBound2",function(){return this._boxBound2=new Jt(new _e,new _e)},"_boxBound3",function(){return this._boxBound3=new Jt(new _e,new _e)}]),t}(),oe=function(){function t(t,e){this.normal=null,this.distance=NaN,void 0===e&&(e=0),this.normal=t,this.distance=e}r(t,"laya.d3.math.Plane");var e=t.prototype;return e.normalize=function(){var t=this.normal.elements,e=t[0],i=t[1],n=t[2],r=1/Math.sqrt(e*e+i*i+n*n);t[0]=e*r,t[1]=i*r,t[2]=n*r,this.distance*=r},t.createPlaneBy3P=function(e,i,n){var r=e.elements,a=i.elements,s=n.elements,o=a[0]-r[0],h=a[1]-r[1],l=a[2]-r[2],u=s[0]-r[0],c=s[1]-r[1],_=s[2]-r[2],d=h*_-l*c,f=l*u-o*_,p=o*c-h*u,m=1/Math.sqrt(d*d+f*f+p*p),g=d*m,y=f*m,x=p*m,v=t._TEMPVec3.elements;v[0]=g,v[1]=y,v[2]=x;var S=-(g*r[0]+y*r[1]+x*r[2]),T=new t(t._TEMPVec3,S);return T},t.PlaneIntersectionType_Back=0,t.PlaneIntersectionType_Front=1,t.PlaneIntersectionType_Intersecting=2,n(t,["_TEMPVec3",function(){return this._TEMPVec3=new _e}]),t}(),he=function(){function t(t,e,i,n){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),this.elements[0]=t,this.elements[1]=e,this.elements[2]=i,this.elements[3]=n}r(t,"laya.d3.math.Quaternion");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.scaling=function(t,e){var i=e.elements,n=this.elements;i[0]=n[0]*t,i[1]=n[1]*t,i[2]=n[2]*t,i[3]=n[3]*t},e.normalize=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=n*n+r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),e[0]=n*o,e[1]=r*o,e[2]=a*o,e[3]=s*o)},e.length=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3];return Math.sqrt(e*e+i*i+n*n+r*r)},e.rotateX=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],h=Math.sin(t),l=Math.cos(t);i[0]=r*l+o*h,i[1]=a*l+s*h,i[2]=s*l-a*h,i[3]=o*l-r*h},e.rotateY=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],h=Math.sin(t),l=Math.cos(t);i[0]=r*l-s*h,i[1]=a*l+o*h,i[2]=s*l+r*h,i[3]=o*l-a*h},e.rotateZ=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],h=Math.sin(t),l=Math.cos(t);i[0]=r*l+a*h,i[1]=a*l-r*h,i[2]=s*l+o*h,i[3]=o*l-s*h},e.getYawPitchRoll=function(e){_e.transformQuat(_e.ForwardRH,this,t.TEMPVector31),_e.transformQuat(_e.Up,this,t.TEMPVector32);var i=t.TEMPVector32.elements;t.angleTo(_e.ZERO,t.TEMPVector31,t.TEMPVector33);var n=t.TEMPVector33.elements;n[0]==Math.PI/2?(n[1]=t.arcTanAngle(i[2],i[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=t.arcTanAngle(-i[2],-i[0]),n[2]=0):(ae.createRotationY(-n[1],t.TEMPMatrix0),ae.createRotationX(-n[0],t.TEMPMatrix1),_e.transformCoordinate(t.TEMPVector32,t.TEMPMatrix0,t.TEMPVector32),_e.transformCoordinate(t.TEMPVector32,t.TEMPMatrix1,t.TEMPVector32),n[2]=t.arcTanAngle(i[1],-i[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]);var r=e.elements;r[0]=n[1],r[1]=n[0],r[2]=n[2]},e.invert=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=n*n+r*r+a*a+s*s,h=o?1/o:0;e[0]=-n*h,e[1]=-r*h,e[2]=-a*h,e[3]=s*h},e.identity=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=1},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;4>e;++e)n[e]=i[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.equals=function(t){var e=this.elements,i=t.elements;return ne.nearEqual(e[0],i[0])&&ne.nearEqual(e[1],i[1])&&ne.nearEqual(e[2],i[2])&&ne.nearEqual(e[3],i[3])},e.lengthSquared=function(){var t=this.elements[0],e=this.elements[1],i=this.elements[2],n=this.elements[3];return t*t+e*e+i*i+n*n},a(0,e,"x",function(){return this.elements[0]}),a(0,e,"y",function(){return this.elements[1]}),a(0,e,"z",function(){return this.elements[2]}),a(0,e,"w",function(){return this.elements[3]}),t.createFromYawPitchRoll=function(t,e,i,n){var r=.5*i,a=.5*e,s=.5*t,o=Math.sin(r),h=Math.cos(r),l=Math.sin(a),u=Math.cos(a),c=Math.sin(s),_=Math.cos(s),d=n.elements;d[0]=_*l*h+c*u*o,d[1]=c*u*h-_*l*o,d[2]=_*u*o-c*l*h,d[3]=_*u*h+c*l*o},t.multiply=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements,s=n[0],o=n[1],h=n[2],l=n[3],u=r[0],c=r[1],_=r[2],d=r[3],f=o*_-h*c,p=h*u-s*_,m=s*c-o*u,g=s*u+o*c+h*_;a[0]=s*d+u*l+f,a[1]=o*d+c*l+p,a[2]=h*d+_*l+m,a[3]=l*d-g},t.arcTanAngle=function(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):0>t?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0},t.angleTo=function(e,i,n){_e.subtract(i,e,t.TEMPVector30),_e.normalize(t.TEMPVector30,t.TEMPVector30),n.elements[0]=Math.asin(t.TEMPVector30.y),n.elements[1]=t.arcTanAngle(-t.TEMPVector30.z,-t.TEMPVector30.x)},t.createFromAxisAngle=function(t,e,i){var n=i.elements,r=t.elements;e=.5*e;var a=Math.sin(e);n[0]=a*r[0],n[1]=a*r[1],n[2]=a*r[2],n[3]=Math.cos(e)},t.createFromMatrix3x3=function(t,e){var i,n=e.elements,r=t.elements,a=r[0]+r[4]+r[8];if(a>0)i=Math.sqrt(a+1),n[3]=.5*i,i=.5/i,n[0]=(r[5]-r[7])*i,n[1]=(r[6]-r[2])*i,n[2]=(r[1]-r[3])*i;else{var s=0;r[4]>r[0]&&(s=1),r[8]>r[3*s+s]&&(s=2);var o=(s+1)%3,h=(s+2)%3;i=Math.sqrt(r[3*s+s]-r[3*o+o]-r[3*h+h]+1),n[s]=.5*i,i=.5/i,n[3]=(r[3*o+h]-r[3*h+o])*i,n[o]=(r[3*o+s]+r[3*s+o])*i,n[h]=(r[3*h+s]+r[3*s+h])*i}},t.createFromMatrix4x4=function(t,e){var i,n,r=t.elements,a=e.elements,s=r[0]+r[5]+r[10];s>0?(i=Math.sqrt(s+1),a[3]=.5*i,i=.5/i,a[0]=(r[6]-r[9])*i,a[1]=(r[8]-r[2])*i,a[2]=(r[1]-r[4])*i):r[0]>=r[5]&&r[0]>=r[10]?(i=Math.sqrt(1+r[0]-r[5]-r[10]),n=.5/i,a[0]=.5*i,a[1]=(r[1]+r[4])*n,a[2]=(r[2]+r[8])*n,a[3]=(r[6]-r[9])*n):r[5]>r[10]?(i=Math.sqrt(1+r[5]-r[0]-r[10]),n=.5/i,a[0]=(r[4]+r[1])*n,a[1]=.5*i,a[2]=(r[9]+r[6])*n,a[3]=(r[8]-r[2])*n):(i=Math.sqrt(1+r[10]-r[0]-r[5]),n=.5/i,a[0]=(r[8]+r[2])*n,a[1]=(r[9]+r[6])*n,a[2]=.5*i,a[3]=(r[1]-r[4])*n)},t.slerp=function(t,e,i,n){var r,a,s,o,h,l=t.elements,u=e.elements,c=n.elements,_=l[0],d=l[1],f=l[2],p=l[3],m=u[0],g=u[1],y=u[2],x=u[3];return a=_*m+d*g+f*y+p*x,0>a&&(a=-a,m=-m,g=-g,y=-y,x=-x),1-a>1e-6?(r=Math.acos(a),s=Math.sin(r),o=Math.sin((1-i)*r)/s,h=Math.sin(i*r)/s):(o=1-i,h=i),c[0]=o*_+h*m,c[1]=o*d+h*g,c[2]=o*f+h*y,c[3]=o*p+h*x,c},t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],h=a[1],l=a[2],u=a[3];r[0]=o+i*(s[0]-o),r[1]=h+i*(s[1]-h),r[2]=l+i*(s[2]-l),r[3]=u+i*(s[3]-u)},t.add=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2],n[3]=r[3]+a[3]},t.dot=function(t,e){var i=t.elements,n=e.elements;return i[0]*n[0]+i[1]*n[1]+i[2]*n[2]+i[3]*n[3]},t.rotationLookAt=function(e,i,n){t.lookAt(_e.ZERO,e,i,n)},t.lookAt=function(e,i,n,r){re.lookAt(e,i,n,t._tempMatrix3x3),t.rotationMatrix(t._tempMatrix3x3,r)},t.invert=function(t,e){var i=t.elements,n=e.elements,r=t.lengthSquared();ne.isZero(r)||(r=1/r,n[0]=-i[0]*r,n[1]=-i[1]*r,n[2]=-i[2]*r,n[3]=i[3]*r)},t.rotationMatrix=function(t,e){var i=t.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],h=i[5],l=i[6],u=i[7],c=i[8],_=e.elements,d=NaN,f=NaN,p=n+o+c;p>0?(d=Math.sqrt(p+1),_[3]=.5*d,d=.5/d,_[0]=(h-u)*d,_[1]=(l-a)*d,_[2]=(r-s)*d):n>=o&&n>=c?(d=Math.sqrt(1+n-o-c),f=.5/d,_[0]=.5*d,_[1]=(r+s)*f,_[2]=(a+l)*f,_[3]=(h-u)*f):o>c?(d=Math.sqrt(1+o-n-c),f=.5/d,_[0]=(s+r)*f,_[1]=.5*d,_[2]=(u+h)*f,_[3]=(l-a)*f):(d=Math.sqrt(1+c-n-o),f=.5/d,_[0]=(l+a)*f,_[1]=(u+h)*f,_[2]=.5*d,_[3]=(r-s)*f)},t.DEFAULT=new t,n(t,["TEMPVector30",function(){return this.TEMPVector30=new _e},"TEMPVector31",function(){return this.TEMPVector31=new _e},"TEMPVector32",function(){return this.TEMPVector32=new _e},"TEMPVector33",function(){return this.TEMPVector33=new _e},"TEMPMatrix0",function(){return this.TEMPMatrix0=new ae},"TEMPMatrix1",function(){return this.TEMPMatrix1=new ae},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new re}]),t}(),le=function(){function t(t){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=t,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}r(t,"laya.d3.math.Rand");var e=t.prototype;return e.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^(this._temp[0]^this._temp[0]>>>8),this.seeds[3]},e.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},e.getSignedFloat=function(){return 2*this.getFloat()-1},a(0,e,"seed",function(){return this.seeds[0]},function(t){this.seeds[0]=t,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),t.getFloatFromInt=function(t){return(8388607&t)*(1/8388607)},t.getByteFromInt=function(t){return(8388607&t)>>>15},t}(),ue=(function(){function t(t){if(this._state0U=NaN,this._state0L=NaN,this._state1U=NaN,this._state1L=NaN,!(t instanceof Array)||4!==t.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|t[0],this._state0L=0|t[1],this._state1U=0|t[2],this._state1L=0|t[3]}r(t,"laya.d3.math.RandX");var e=t.prototype;return e.randomint=function(){var t=this._state0U,e=this._state0L,i=this._state1U,n=this._state1L,r=(n>>>0)+(e>>>0),a=i+t+(r/2>>>31)>>>0,s=r>>>0;this._state0U=i,this._state0L=n;var o=0,h=0,l=0,u=0,c=23,_=4294967295<<32-c;o=t<<c|(e&_)>>>32-c,h=e<<c,t^=o,e^=h,o=t^i,h=e^n;var d=18,f=4294967295>>>32-d;l=t>>>d,u=e>>>d|(t&f)<<32-d,o^=l,h^=u;var p=5,m=4294967295>>>32-p;return l=i>>>p,u=n>>>p|(i&m)<<32-p,o^=l,h^=u,this._state1U=o,this._state1L=h,[a,s]},e.random=function(){var e=this.randomint(),i=e[0],n=e[1],r=1023<<20,a=0,s=12,o=4294967295>>>32-s,h=i>>>s,l=n>>>s|(i&o)<<32-s,u=r|h,c=a|l;t._CONVERTION_BUFFER.setUint32(0,u,!1),t._CONVERTION_BUFFER.setUint32(4,c,!1);var _=le._CONVERTION_BUFFER.getFloat64(0,!1);return _-1},n(t,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8))},"defaultRand",function(){return this.defaultRand=new le([0,Date.now()/65536,0,Date.now()%65536])}]),t}(),function(){function t(t,e){this.origin=null,this.direction=null,this.origin=t,this.direction=e}return r(t,"laya.d3.math.Ray"),t}()),ce=function(){function t(t,e){this.elements=new Float32Array(2),void 0===t&&(t=0),void 0===e&&(e=0);var i=this.elements;i[0]=t,i[1]=e}r(t,"laya.d3.math.Vector2");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t,i=e.elements,n=this.elements;i[0]=n[0],i[1]=n[1]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),a(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),t.scale=function(t,e,i){var n=i.elements,r=t.elements;n[0]=r[0]*e,n[1]=r[1]*e},n(t,["ZERO",function(){return this.ZERO=new t(0,0)},"ONE",function(){return this.ONE=new t(1,1)}]),t}(),_e=function(){function t(t,e,i){this.elements=new Float32Array(3),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var n=this.elements;n[0]=t,n[1]=e,n[2]=i}r(t,"laya.d3.math.Vector3");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t,i=e.elements,n=this.elements;i[0]=n[0],i[1]=n[1],i[2]=n[2]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},a(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),a(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),a(0,e,"z",function(){return this.elements[2]},function(t){this.elements[2]=t}),t.distanceSquared=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2];return r*r+a*a+s*s},t.distance=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2];return Math.sqrt(r*r+a*a+s*s)},t.min=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.min(r[0],a[0]),n[1]=Math.min(r[1],a[1]),n[2]=Math.min(r[2],a[2])},t.max=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.max(r[0],a[0]),n[1]=Math.max(r[1],a[1]),n[2]=Math.max(r[2],a[2])},t.transformQuat=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements,s=r[0],o=r[1],h=r[2],l=a[0],u=a[1],c=a[2],_=a[3],d=_*s+u*h-c*o,f=_*o+c*s-l*h,p=_*h+l*o-u*s,m=-l*s-u*o-c*h;n[0]=d*_+m*-l+f*-c-p*-u,n[1]=f*_+m*-u+p*-l-d*-c,n[2]=p*_+m*-c+d*-u-f*-l},t.scalarLength=function(t){var e=t.elements,i=e[0],n=e[1],r=e[2];return Math.sqrt(i*i+n*n+r*r)},t.scalarLengthSquared=function(t){var e=t.elements,i=e[0],n=e[1],r=e[2];return i*i+n*n+r*r},t.normalize=function(t,e){var i=t.elements,n=e.elements,r=i[0],a=i[1],s=i[2],o=r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),n[0]=i[0]*o,n[1]=i[1]*o,n[2]=i[2]*o)},t.multiply=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]*a[0],n[1]=r[1]*a[1],n[2]=r[2]*a[2]},t.scale=function(t,e,i){var n=i.elements,r=t.elements;n[0]=r[0]*e,n[1]=r[1]*e,n[2]=r[2]*e},t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],h=a[1],l=a[2];r[0]=o+i*(s[0]-o),r[1]=h+i*(s[1]-h),r[2]=l+i*(s[2]-l)},t.transformV3ToV3=function(e,i,n){var r=t._tempVector4;t.transformV3ToV4(e,i,r);var a=r.elements,s=n.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]},t.transformV3ToV4=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=e.elements,h=i.elements;h[0]=r*o[0]+a*o[4]+s*o[8]+o[12],h[1]=r*o[1]+a*o[5]+s*o[9]+o[13],h[2]=r*o[2]+a*o[6]+s*o[10]+o[14],h[3]=r*o[3]+a*o[7]+s*o[11]+o[15]},t.TransformNormal=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=e.elements,h=i.elements;h[0]=r*o[0]+a*o[4]+s*o[8],h[1]=r*o[1]+a*o[5]+s*o[9],h[2]=r*o[2]+a*o[6]+s*o[10]},t.transformCoordinate=function(e,i,n){var r=t.TEMPVec4.elements,a=e.elements,s=a[0],o=a[1],h=a[2],l=i.elements;r[0]=s*l[0]+o*l[4]+h*l[8]+l[12],r[1]=s*l[1]+o*l[5]+h*l[9]+l[13],r[2]=s*l[2]+o*l[6]+h*l[10]+l[14],r[3]=1/(s*l[3]+o*l[7]+h*l[11]+l[15]);var u=n.elements;u[0]=r[0]*r[3],u[1]=r[1]*r[3],u[2]=r[2]*r[3]},t.Clamp=function(t,e,i,n){var r=t.elements,a=r[0],s=r[1],o=r[2],h=e.elements,l=h[0],u=h[1],c=h[2],_=i.elements,d=_[0],f=_[1],p=_[2],m=n.elements;a=a>d?d:a,a=l>a?l:a,s=s>f?f:s,s=u>s?u:s,o=o>p?p:o,o=c>o?c:o,m[0]=a,m[1]=s,m[2]=o},t.add=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2]},t.subtract=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]-a[0],n[1]=r[1]-a[1],n[2]=r[2]-a[2]},t.cross=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements,s=n[0],o=n[1],h=n[2],l=r[0],u=r[1],c=r[2];a[0]=o*c-h*u,a[1]=h*l-s*c,a[2]=s*u-o*l},t.dot=function(t,e){var i=t.elements,n=e.elements,r=i[0]*n[0]+i[1]*n[1]+i[2]*n[2];return r},t.equals=function(t,e){var i=t.elements,n=e.elements;return ne.nearEqual(Math.abs(i[0]),Math.abs(n[0]))&&ne.nearEqual(Math.abs(i[1]),Math.abs(n[1]))&&ne.nearEqual(Math.abs(i[2]),Math.abs(n[2]))},n(t,["_tempVector4",function(){return this._tempVector4=new de},"ZERO",function(){return this.ZERO=new t(0,0,0)},"ONE",function(){return this.ONE=new t(1,1,1)},"NegativeUnitX",function(){return this.NegativeUnitX=new t(-1,0,0)},"UnitX",function(){return this.UnitX=new t(1,0,0)},"UnitY",function(){return this.UnitY=new t(0,1,0)},"UnitZ",function(){return this.UnitZ=new t(0,0,1)},"ForwardRH",function(){return this.ForwardRH=new t(0,0,-1)},"ForwardLH",function(){return this.ForwardLH=new t(0,0,1)},"Up",function(){return this.Up=new t(0,1,0)},"TEMPVec4",function(){return this.TEMPVec4=new de}]),t}(),de=function(){function t(t,e,i,n){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0);var r=this.elements;r[0]=t,r[1]=e,r[2]=i,r[3]=n}r(t,"laya.d3.math.Vector4");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t,i=e.elements,n=this.elements;i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},e.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},a(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),a(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),a(0,e,"z",function(){return this.elements[2]},function(t){this.elements[2]=t}),a(0,e,"w",function(){return this.elements[3]},function(t){this.elements[3]=t}),t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],h=a[1],l=a[2],u=a[3];r[0]=o+i*(s[0]-o),r[1]=h+i*(s[1]-h),r[2]=l+i*(s[2]-l),r[3]=u+i*(s[3]-u)},t.transformByM4x4=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=n[3],h=e.elements,l=i.elements;l[0]=r*h[0]+a*h[4]+s*h[8]+o*h[12],l[1]=r*h[1]+a*h[5]+s*h[9]+o*h[13],l[2]=r*h[2]+a*h[6]+s*h[10]+o*h[14],l[3]=r*h[3]+a*h[7]+s*h[11]+o*h[15]},t.equals=function(t,e){var i=t.elements,n=e.elements;return ne.nearEqual(Math.abs(i[0]),Math.abs(n[0]))&&ne.nearEqual(Math.abs(i[1]),Math.abs(n[1]))&&ne.nearEqual(Math.abs(i[2]),Math.abs(n[2]))&&ne.nearEqual(Math.abs(i[3]),Math.abs(n[3]))},t.normalize=function(t,e){var i=t.elements,n=e.elements,r=t.length();r>0&&(n[0]=i[0]*r,n[1]=i[1]*r,n[2]=i[2]*r,n[3]=i[3]*r)},t.add=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2],n[3]=r[3]+a[3]},t.subtract=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]-a[0],n[1]=r[1]-a[1],n[2]=r[2]-a[2],n[3]=r[3]-a[3]},t.multiply=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]*a[0],n[1]=r[1]*a[1],n[2]=r[2]*a[2],n[3]=r[3]*a[3]},t.scale=function(t,e,i){var n=i.elements,r=t.elements;n[0]=r[0]*e,n[1]=r[1]*e,n[2]=r[2]*e,n[3]=r[3]*e},t.Clamp=function(t,e,i,n){var r=t.elements,a=r[0],s=r[1],o=r[2],h=r[3],l=e.elements,u=l[0],c=l[1],_=l[2],d=l[3],f=i.elements,p=f[0],m=f[1],g=f[2],y=f[3],x=n.elements;a=a>p?p:a,a=u>a?u:a,s=s>m?m:s,s=c>s?c:s,o=o>g?g:o,o=_>o?_:o,h=h>y?y:h,h=d>h?d:h,x[0]=a,x[1]=s,x[2]=o,x[3]=h},t.distanceSquared=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2],o=i[3]-n[3];return r*r+a*a+s*s+o*o},t.distance=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2],o=i[3]-n[3];return Math.sqrt(r*r+a*a+s*s+o*o)},t.dot=function(t,e){var i=t.elements,n=e.elements,r=i[0]*n[0]+i[1]*n[1]+i[2]*n[2]+i[3]*n[3];return r},t.min=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.min(r[0],a[0]),n[1]=Math.min(r[1],a[1]),n[2]=Math.min(r[2],a[2]),n[3]=Math.min(r[3],a[3])},t.max=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.max(r[0],a[0]),n[1]=Math.max(r[1],a[1]),n[2]=Math.max(r[2],a[2]),n[3]=Math.max(r[3],a[3])},n(t,["ZERO",function(){return this.ZERO=new t},"ONE",function(){return this.ONE=new t(1,1,1,1)},"UnitX",function(){return this.UnitX=new t(1,0,0,0)},"UnitY",function(){return this.UnitY=new t(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new t(0,0,1,0)},"UnitW",function(){return this.UnitW=new t(0,0,0,1)}]),t}(),fe=function(){function t(t,e,i,n){this.minDepth=0,this.maxDepth=1,this.x=t,this.y=e,this.width=i,this.height=n}r(t,"laya.d3.math.Viewport");var e=t.prototype;return e.project=function(t,e,i){_e.transformV3ToV3(t,e,i);var n=t.elements,r=e.elements,a=i.elements,s=n[0]*r[3]+n[1]*r[7]+n[2]*r[11]+r[15];1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(-a[1]+1)*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},e.unprojectFromMat=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements;a[0]=(n[0]-this.x)/this.width*2-1,a[1]=-((n[1]-this.y)/this.height*2-1);var s=(this.maxDepth-this.minDepth)/2;a[2]=(n[2]-this.minDepth-s)/s;var o=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];_e.transformV3ToV3(i,e,i),1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o)},e.unprojectFromWVP=function(e,i,n,r,a){ae.multiply(i,n,t._tempMatrix4x4),r&&ae.multiply(t._tempMatrix4x4,r,t._tempMatrix4x4),t._tempMatrix4x4.invert(t._tempMatrix4x4),this.unprojectFromMat(e,t._tempMatrix4x4,a)},n(t,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new ae;
}]),t}(),pe=function(){function t(t){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._indexInMesh=0,this._vertexBuffer=null,this._vertexStart=0,this._vertexCount=0,this._indexBuffer=null,this._indexStart=0,this._indexCount=0,this._indices=null,this._bufferUsage={},this._mesh=t,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}r(t,"laya.d3.resource.models.SubMesh");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),e._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},e._getIndexBuffer=function(){return this._indexBuffer},e._getStaticBatchBakedVertexs=function(e,i){var n,r,a=4,s=this._vertexBuffer,o=s.vertexDeclaration,h=o.getVertexElementByUsage(0).offset/a,l=o.getVertexElementByUsage(3).offset/a,u=i.meshRender.lightmapScaleOffset,c=0,_=0,d=0,f=0,p=0,m=0;if(u)if(r=o.getVertexElementByUsage(15))d=o.vertexStride/a,n=this._vertexCount>0?s.getData().slice(this._vertexStart*d,(this._vertexStart+this._vertexCount)*d):s.getData().slice(),f=r.offset/a;else{m=o.vertexStride/a,d=m+2,n=this._vertexCount?new Float32Array(this._vertexCount*(s.vertexDeclaration.vertexStride/a+2)):new Float32Array(s.vertexCount*(s.vertexDeclaration.vertexStride/a+2)),p=o.getVertexElementByUsage(2).offset/a,f=p+2;var g=s.getData();for(c=0,_=g.length/m;_>c;c++){var y=0;y=this._vertexCount>0?(this._vertexStart+c)*m:c*m;var x=c*d,v=0;for(v=0;f>v;v++)n[x+v]=g[y+v];for(v=f;m>v;v++)n[x+v+2]=g[y+v]}}else d=o.vertexStride/a,n=this._vertexCount?s.getData().slice(this._vertexStart*d,(this._vertexStart+this._vertexCount)*d):s.getData().slice();if(e){var S=e.worldMatrix,T=t._tempMatrix4x40;S.invert(T);var E=t._tempMatrix4x41,w=i.transform.worldMatrix;ae.multiply(T,w,E)}else E=i.transform.worldMatrix;var b=t._tempQuaternion0;for(E.decomposeTransRotScale(t._tempVector30,b,t._tempVector31),c=0,_=n.length/d;_>c;c++){var C=c*d+h,M=c*d+l;if(De.transformVector3ArrayToVector3ArrayCoordinate(n,C,E,n,C),De.transformVector3ArrayByQuat(n,M,b,n,M),u){var D=c*d+f;if(r)De.transformLightingMapTexcoordByUV1Array(n,D,u,n,D);else{var A=c*m+p;De.transformLightingMapTexcoordByUV0Array(g,A,u,n,D)}}}return n},e._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},e._render=function(t){var e,i=0,n=t.renderElement;if(this._indexCount>1){var r=this._boneIndicesList.length;if(r>1){for(var a=0;r>a;a++)e=n._skinAnimationDatas||this._skinAnimationDatas,e&&(n._shaderValue.setValue(0,e[a]),t._shader.uploadRenderElementUniforms(n._shaderValue.data)),P.mainContext.drawElements(4,this._subIndexBufferCount[a],5123,2*this._subIndexBufferStart[a]);D.drawCall+=r}else e=n._skinAnimationDatas||this._skinAnimationDatas,e&&(n._shaderValue.setValue(0,e[0]),t._shader.uploadRenderElementUniforms(n._shaderValue.data)),P.mainContext.drawElements(4,this._indexCount,5123,2*this._indexStart),D.drawCall++;i=this._indexCount}else i=this._indexBuffer.indexCount,e=n._skinAnimationDatas||this._skinAnimationDatas,e&&(n._shaderValue.setValue(0,e[0]),t._shader.uploadRenderElementUniforms(n._shaderValue.data)),P.mainContext.drawElements(4,i,5123,0),D.drawCall++;D.trianglesFaces+=i/3},e.getIndices=function(){return this._indexCount>0?this._indices:this._indexBuffer.getData()},e.dispose=function(){this._indexBuffer.dispose(),this._vertexBuffer.dispose(),this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._vertexBuffer=null,this._indexBuffer=null},e._renderRuntime=function(t,e,i){e._material,e._sprite3D;t.drawSubmesh(e._conchSubmesh,0,4,0,this._indexBuffer.indexCount)},a(0,e,"_vertexBufferCount",function(){return 1}),a(0,e,"triangleCount",function(){return this._indexBuffer.indexCount/3}),n(t,["_tempVector30",function(){return this._tempVector30=new _e},"_tempVector31",function(){return this._tempVector31=new _e},"_tempQuaternion0",function(){return this._tempQuaternion0=new he},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new ae},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new ae}]),t}(),me=function(){function t(i,n,r,a,s,o){function h(t){for(var e=t.split(" "),i=[],n=0;n<e.length;n++)e[n].length>0&&i.push(e[n]);return i}function l(i){var n=i;i=i.replace(t.DEFINEREG,"");var r,a,s=0,l=0,u=0,c=new e(0,null,null,null),_=c,d=i.split("\n");for(s=0,l=d.length;l>s;s++){var f=d[s];if(f.indexOf("#ifdef")>=0)r=h(f),_=new e(1,r[1],"",_);else if(f.indexOf("#if")>=0)r=h(f),_=new e(1,r[1],"",_);else if(f.indexOf("#else")>=0)a=_.condition,_=new e(2,null,"",_.parent),_.condition=a;else if(f.indexOf("#endif")>=0)_=_.parent;else if(f.indexOf("#include")>=0){r=h(f);var p=r[1],m=p.charAt(0);('"'===m||"'"===m)&&(p=p.substr(1,p.length-2),u=p.lastIndexOf(m),u>0&&(p=p.substr(0,u))),u=r[0].indexOf("?");var g=u>0?r[0].substr(u+1):null;if(new e(1,g,o[p],_),E.isConchNode){var y=g.match(t.INCLUDE),x=y.length;if(1==x)g=g.replace(y[0],"defined("+y[0]+")");else if(x>1)for(var v={},S=0;x>S;S++){var T=y[S];v[T]||(g=g.replace(T,"defined("+T+")"),v[T]=!0)}var w="#if "+g;w+="\n"+o[p]+"\n",w+="#endif",n=n.replace(f,w)}}else _.childs.length>0&&0===_.childs[_.childs.length-1].type?_.childs[_.childs.length-1].text+="\n"+f:new e(0,null,f,_)}return E.isConchNode&&(c.sd=n),c}this._curMaterialDefinePower=1,this._curSpriteDefinePower=3,this._materialInt2name=[],this._materialName2Int={},this._spriteInt2name=[],this._name=i,this._renderElementUniformMap={},this._materialUniformMap={},this._spriteUniformMap={},this._cameraUniformMap={},this._sceneUniformMap={},this.sharders=[],this._VSTXT=n,this._PSTXT=r,this._spriteInt2name[1]="RECEIVESHADOW",this._spriteInt2name[2]="SCALEOFFSETLIGHTINGMAPUV",this._spriteInt2name[4]="LIGHTMAP",this._spriteInt2name[Bi.SHADERDEFINE_BONE]="BONE",this._materialInt2name[1]="ALPHATEST",this._VS=l(n),this._PS=l(r),this._attributeMap=a;var u;for(u in s){var c=s[u];switch(c[1]){case 0:this._renderElementUniformMap[u]=c[0];break;case 1:this._materialUniformMap[u]=c[0];break;case 2:this._spriteUniformMap[u]=c[0];break;case 3:this._cameraUniformMap[u]=c[0];break;case 4:this._sceneUniformMap[u]=c[0];break;default:throw new Error("ShaderCompile3D: period is unkonw.")}}if(E.isConchNode){this._conchShader=new ConchShader,this._conchShader.setSrc(this._VS.sd,this._PS.sd),delete this._VS.sd,delete this._PS.sd;var _=[];for(u in this._attributeMap)_.push({name:u,elementUsage:this._attributeMap[u]});this._conchShader.setAttrDeclare(_);var d=[];for(u in s){var f=s[u];d.push({name:u,elementUsage:f[0],periodType:f[1]})}this._conchShader.setUniformDeclare(d)}}var e;r(t,"laya.d3.shader.ShaderCompile3D");var i=t.prototype;return i._definesToNameDic=function(t,e){for(var i={},n=1,r=0;32>r&&(n=1<<r,!(n>t));r++)if(t&n){var a=e[n];a&&(i[a]="")}return i},i.withCompile=function(e,i,n){var r,a,s;if(a=this.sharders[e])if(s=a[i]){if(r=s[n])return r}else s=a[i]=[];else a=this.sharders[e]=[],s=a[i]=[];var o=this._definesToNameDic(e,t._globalInt2name),h=this._definesToNameDic(i,this._spriteInt2name),l=this._definesToNameDic(n,this._materialInt2name);if(laya.d3.shader.ShaderCompile3D.debugMode){var u,c="";for(u in o)c+=u+" ";var _="";for(u in h)_+=u+" ";var d="";for(u in l)d+=u+" ";console.log("ShaderCompile3DDebugMode---(Name:"+di.nameKey.getName(this._name)+" PublicDefine:"+e+" SpriteDefine:"+i+" MaterialDefine:"+n+" PublicDefineGroup:"+c+" SpriteDefineGroup:"+_+"MaterialDefineGroup: "+d+")---ShaderCompile3DDebugMode")}return r=this.createShader(o,h,l),s[n]=r,r},i.createShader=function(t,e,i){var n,r={},a="";if(t)for(n in t)a+="#define "+n+"\n",r[n]=!0;if(e)for(n in e)a+="#define "+n+"\n",r[n]=!0;if(i)for(n in i)a+="#define "+n+"\n",r[n]=!0;var s=this._VS.toscript(r,[]),o=this._PS.toscript(r,[]);return di.create(a+s.join("\n"),a+o.join("\n"),this._attributeMap,this._sceneUniformMap,this._cameraUniformMap,this._spriteUniformMap,this._materialUniformMap,this._renderElementUniformMap)},i.precompileShaderWithShaderDefine=function(t,e,i){this.withCompile(t,e,i)},i.registerMaterialDefine=function(t){var e=Math.pow(2,this._curMaterialDefinePower++);return this._materialInt2name[e]=t,this._materialName2Int[t]=e,E.isConchNode&&conch.regShaderDefine&&conch.regShaderDefine(t,e),e},i.registerSpriteDefine=function(t){var e=Math.pow(2,this._curSpriteDefinePower++);return this._spriteInt2name[e]=t,E.isConchNode&&conch.regShaderDefine&&conch.regShaderDefine(t,e),e},i.getMaterialDefineByName=function(t){return this._materialName2Int[t]},t.__init__=function(){t._globalRegDefine("FSHIGHPRECISION",t.SHADERDEFINE_FSHIGHPRECISION),t._globalRegDefine("VR",t.SHADERDEFINE_VR),t._globalRegDefine("FOG",t.SHADERDEFINE_FOG),t._globalRegDefine("DIRECTIONLIGHT",t.SHADERDEFINE_DIRECTIONLIGHT),t._globalRegDefine("POINTLIGHT",t.SHADERDEFINE_POINTLIGHT),t._globalRegDefine("SPOTLIGHT",t.SHADERDEFINE_SPOTLIGHT),t._globalRegDefine("UV",t.SHADERDEFINE_UV0),t._globalRegDefine("COLOR",t.SHADERDEFINE_COLOR),t._globalRegDefine("UV1",t.SHADERDEFINE_UV1),t._globalRegDefine("CASTSHADOW",xe.SHADERDEFINE_CAST_SHADOW),t._globalRegDefine("SHADOWMAP_PSSM1",xe.SHADERDEFINE_SHADOW_PSSM1),t._globalRegDefine("SHADOWMAP_PSSM2",xe.SHADERDEFINE_SHADOW_PSSM2),t._globalRegDefine("SHADOWMAP_PSSM3",xe.SHADERDEFINE_SHADOW_PSSM3),t._globalRegDefine("SHADOWMAP_PCF_NO",xe.SHADERDEFINE_SHADOW_PCF_NO),t._globalRegDefine("SHADOWMAP_PCF1",xe.SHADERDEFINE_SHADOW_PCF1),t._globalRegDefine("SHADOWMAP_PCF2",xe.SHADERDEFINE_SHADOW_PCF2),t._globalRegDefine("SHADOWMAP_PCF3",xe.SHADERDEFINE_SHADOW_PCF3),t._globalRegDefine("DEPTHFOG",t.SAHDERDEFINE_DEPTHFOG)},t._globalRegDefine=function(e,i){t._globalInt2name[i]=e},t.add=function(e,i,n,r,a){return laya.d3.shader.ShaderCompile3D._preCompileShader[e]=new t(e,i,n,r,a,di._includeFiles)},t.get=function(t){return laya.d3.shader.ShaderCompile3D._preCompileShader[di.nameKey.getID(t)]},t.debugMode=!1,t.SHADERDEFINE_FSHIGHPRECISION=1,t.SHADERDEFINE_VR=2,t.SHADERDEFINE_FOG=4,t.SHADERDEFINE_DIRECTIONLIGHT=8,t.SHADERDEFINE_POINTLIGHT=16,t.SHADERDEFINE_SPOTLIGHT=32,t.SHADERDEFINE_UV0=64,t.SHADERDEFINE_COLOR=128,t.SHADERDEFINE_UV1=256,t.SAHDERDEFINE_DEPTHFOG=131072,t._globalInt2name=[],t._preCompileShader={},t.IFDEF_NO=0,t.IFDEF_YES=1,t.IFDEF_ELSE=2,n(t,["DEFINEREG",function(){return this.DEFINEREG=new RegExp("defined(?=\\((.*?)\\))","g")},"INCLUDE",function(){return this.INCLUDE=new RegExp("\\w+","g")}]),t.__init$=function(){e=function(){function t(t,e,i,n){if(this.childs=new Array,this.type=t,this.text=i,this.parent=n,n&&n.childs.push(this),!e)return void(1==this.type&&(this.type=0));for(var r="",a=!1,s=!1,o=0,h=e.length;h>o;o++){var l=e.charAt(o);s="!&|() 	".indexOf(l)<0,a!=s&&(s&&(r+="this."),a=s),r+=l}this.condition=C.createShaderCondition(r)}r(t,"");var e=t.prototype;return e.toscript=function(t,e){if(0===this.type&&this.text&&e.push(this.text),this.childs.length<1&&!this.text)return e;if(0!==this.type){var i=!!this.condition.call(t);if(2===this.type&&(i=!i),!i)return e;this.text&&e.push(this.text)}return this.childs.length>0&&this.childs.forEach(function(i,n,r){i.toscript(t,e)}),e},t}()},t}(),ge=function(){function t(){}return r(t,"laya.d3.shader.ShaderInit3D"),t.__init__=function(){di.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec=-normalize(dirLight.Direction);\n	\n	amb=matAmb;\n	\n	float  diffuseFactor=dot(lightVec, normal);\n	\n	if(diffuseFactor>0.0)\n	{\n	   vec3 v = reflect(-lightVec, normal);\n	   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n	   \n	   dif = diffuseFactor * matDif * dirLight.Diffuse;\n	   spec = specFactor * matSpe.rgb;\n	}\n	\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec = poiLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > poiLight.Range )\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if( diffuseFactor > 0.0 )\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * poiLight.Diffuse;\n		spec = specFactor * matSpe.rgb;\n	}\n\n	float attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	amb = vec3(0.0);\n	dif =vec3(0.0);\n	spec= vec3(0.0);\n	vec3 lightVec = spoLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > spoLight.Range)\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if(diffuseFactor > 0.0)\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * spoLight.Diffuse;\n		spec = specFactor * matSpe.rgb;\n	}\n	\n	float spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n	float attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n	amb *= spot;\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n	vec3 normalT = 2.0*normalMapSample - 1.0;\n\n	// Build orthonormal basis.\n	vec3 N = normalize(unitNormal);\n	vec3 T = normalize(tangent- dot(tangent, N)*N);\n	vec3 B = cross(T, N);\n\n	mat3 TBN = mat3(T, B, N);\n\n	// Transform from tangent space to world space.\n	vec3 bumpedNormal = TBN*normalT;\n\n	return bumpedNormal;\n}\n"),di.addInclude("VRHelper.glsl","\nvec4 DistortFishEye(vec4 p)\n{\n    vec2 v = p.xy / p.w;\n    float radius = length(v);// Convert to polar coords\n    if (radius > 0.0)\n    {\n      float theta = atan(v.y,v.x);\n      \n      radius = pow(radius, 0.93);// Distort:\n\n      v.x = radius * cos(theta);// Convert back to Cartesian\n      v.y = radius * sin(theta);\n      p.xy = v.xy * p.w;\n    }\n    return p;\n}"),di.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2	  u_shadowPCFoffset;\nuniform vec4     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n	const vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n	const vec4 bitMask	= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n	vec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n	res -= res.xxyz * bitMask;\n	return res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n	const vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n	float depth = dot(rgbaDepth, bitShift);\n	return depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n	vec2 texelpos =texcoord / invsize;\n	vec2 lerps = fract( texelpos );\n	float sourcevals[4];\n	sourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n	sourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n	sourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n	sourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n	return mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n	float value = 1.0;\n	int nPSNum = int(posViewZ>pssmDistance.x);\n	nPSNum += int(posViewZ>pssmDistance.y);\n	nPSNum += int(posViewZ>pssmDistance.z);\n	//真SB,webgl不支持在PS中直接访问数组\n	mat4 lightVP;\n	if( nPSNum == 0 )\n	{\n		lightVP = lightShadowVP[1];\n	}\n	else if( nPSNum == 1 )\n	{\n		lightVP = lightShadowVP[2];\n	}\n	else if( nPSNum == 2 )\n	{\n		lightVP = lightShadowVP[3];\n	}\n	vec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n	//为了效率，在CPU计算/2.0 + 0.5\n	//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n	vec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n	float fMyZ = vText.z - zBias;\n	/*\n	bvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n	bool bInFrustum = all( bInFrustumVec );\n	bvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n	bool bFrustumTest = all( bFrustumTestVec );\n	if ( bFrustumTest ) \n	*/\n	if( fMyZ <= 1.0 )\n	{\n		float zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n		if ( nPSNum == 0 )\n		{\n			value =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,	fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,	fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,	fMyZ );\n			value = value/4.0;\n		} \n		else if( nPSNum == 1 )\n		{\n			value = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 2 )\n		{\n			vec4 color = texture2D( shadowMap3,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n#endif\n#ifdef SHADOWMAP_PCF2\n		if ( nPSNum == 0 )\n		{\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 1 )\n		{\n			value = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 2 )\n		{\n			vec4 color = texture2D( shadowMap3,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n		if ( nPSNum == 0 )\n		{\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 1 )\n		{\n			vec4 color = texture2D( shadowMap2,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n		else if( nPSNum == 2 )\n		{\n			vec4 color = texture2D( shadowMap3,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n		vec4 color;\n		if ( nPSNum == 0 )\n		{\n			color = texture2D( shadowMap1,vText.xy );\n		}\n		else if( nPSNum == 1 )\n		{\n			color = texture2D( shadowMap2,vText.xy );\n		}\n		else if( nPSNum == 2 )\n		{\n			color = texture2D( shadowMap3,vText.xy );\n		}\n		zdepth = unpackDepth(color);\n		value = float(fMyZ < zdepth);\n#endif\n	}\n	return value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n	float value = 1.0;\n	int nPSNum = int(posViewZ>pssmDistance.x);\n	nPSNum += int(posViewZ>pssmDistance.y);\n	//真SB,webgl不支持在PS中直接访问数组\n	mat4 lightVP;\n	if( nPSNum == 0 )\n	{\n		lightVP = lightShadowVP[1];\n	}\n	else if( nPSNum == 1 )\n	{\n		lightVP = lightShadowVP[2];\n	}\n	vec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n	//为了效率，在CPU计算/2.0 + 0.5\n	//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n	vec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n	float fMyZ = vText.z - zBias;\n	/*\n	bvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n	bool bInFrustum = all( bInFrustumVec );\n	bvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n	bool bFrustumTest = all( bFrustumTestVec );\n	if ( bFrustumTest ) \n	*/\n	if( fMyZ <= 1.0 )\n	{\n		float zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n		if ( nPSNum == 0 )\n		{\n			value =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,	fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,	fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,	fMyZ );\n			value = value/4.0;\n		}\n		else if( nPSNum == 1 )\n		{\n			value = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n		}\n#endif\n#ifdef SHADOWMAP_PCF2\n		if ( nPSNum == 0 )\n		{\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 1 )\n		{\n			value = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n		}\n#endif\n#ifdef SHADOWMAP_PCF1\n		if ( nPSNum == 0 )\n		{\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n		}\n		else if( nPSNum == 1 )\n		{\n			vec4 color = texture2D( shadowMap2,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n		}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n		vec4 color;\n		if ( nPSNum == 0 )\n		{\n			color = texture2D( shadowMap1,vText.xy );\n		}\n		else if( nPSNum == 1 )\n		{\n			color = texture2D( shadowMap2,vText.xy );\n		}\n		zdepth = unpackDepth(color);\n		value = float(fMyZ < zdepth);\n#endif\n	}\n	return value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec4 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n	float value = 1.0;\n	if( posViewZ < pssmDistance.x )\n	{\n		vec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n		float fMyZ = vText.z - zBias;\n		/*\n		bvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n		bool bInFrustum = all( bInFrustumVec );\n		bvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n		bool bFrustumTest = all( bFrustumTestVec );\n		*/\n		if ( fMyZ <= 1.0 ) \n		{\n			float zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n			value =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n			value += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n			value = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2		\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n			value = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF_NO		\n			vec4 color = texture2D( shadowMap1,vText.xy );\n			zdepth = unpackDepth(color);\n			value = float(fMyZ < zdepth);\n#endif\n		}\n	}\n	return value;\n}"),di.addInclude("WaveFunction.glsl","\nuniform vec2 u_WaveInfoD[20];\nuniform vec4 u_WaveInfo[20];\n\nuniform float TEXWAVE_UV_SCALE ;//= 20.0; //每texwidth像素代表的实际距离\n/**\n	这里的计算都是\n*/\n\n/**\n* 计算一个波形\n*  开始计算的时候都按照z向上，最后输出的时候，颠倒一下。\n* @param tm {float} 毫秒\n*/\nvoid calcGerstnerWave(float curtm, vec3 pos, float deep, vec2 uvpos, out vec3 opos, out vec3 B, out vec3 T, out vec3 N, out float foamS){\n	float tm = curtm/1000.;\n	opos = pos;\n	vec3 wpos=vec3(0.);		//累加的位置\n	N=vec3(0.,0.,0.);	//输出的法线初始化一下\n	T=vec3(0.,0.,0.);\n	B=vec3(0.,0.,0.);\n	vec2 cD ;//= D;\n	//float deepAtt = max(0.,min(deep,1.0));\n	//A*=deepAtt; //TODO\n	\n	for( int i=0; i<4; i++){\n		cD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n		float Q = u_WaveInfo[i].x;//wi.QorK;\n		float A = u_WaveInfo[i].y;//wi.A;\n		float W = u_WaveInfo[i].z;//wi.omega;\n		float P = u_WaveInfo[i].w;//wi.phi;\n		float dop = dot(cD,uvpos);\n		float c = cos(dop*W - tm*P);//TODO 优化\n		float s = sin(dop*W - tm*P);\n		float AWs = A*W*s;\n		float AWc = A*W*c;\n		float _QxyAWs = -Q*cD.x*cD.y*AWs;\n		\n		wpos += vec3(Q*A*cD.x*c,\n					Q*A*cD.y*c,\n					A*s);\n		N += vec3(-cD.x*AWc,\n				-cD.y*AWc,\n				Q*AWs);//记得最后1-\n		T += vec3(_QxyAWs,\n				Q*cD.y*cD.y*AWs,//记得1-\n				cD.y*AWc\n			);\n		B += vec3(Q*cD.x*cD.x*AWs,//记得1-\n				_QxyAWs,\n				cD.x*AWc\n			);\n		//float v1 = exp(-tan((dop*W - tm*P)/2.+1.07));//除2，+pi/2 这样正好能对齐\n#ifdef USE_FOAM		\n		float v1 = 0.5-sin((dop*W - tm*P)/1.+2.0)/2.;\n		foamS += pow(v1,9.)/4.;\n#endif\n	}\n	T.y=1.-T.y; B.x=1.-B.x;N.z=1.-N.z;\n	opos += vec3(wpos.x,wpos.z*min(deep/10.,1.),wpos.y);\n	//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n	T.xyz=T.xzy;\n	B.xyz=B.xzy;\n	N.xyz=N.xzy;\n}\n\n\nvoid calcWave(float curtm, vec2 uv, out vec3 B, out vec3 T, out vec3 N){\n	float tm = curtm/1000.;\n	N=vec3(0.,0.,0.);	//输出的法线初始化一下\n	vec2 uvpos = uv*TEXWAVE_UV_SCALE; //TODO 这个范围是什么 就是1？\n	uvpos.y*=-1.;\n	vec2 cD;// = D;\n	const int NumWaves = 4;\n	float scale = 1./float(NumWaves);\n	for( int i=0; i<NumWaves; i++){\n		cD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n		float k = 1.5;//u_WaveInfo[i].x;//wi.QorK; TODO  不知道为什么，这个取u_WaveInfo[i].x，在mi3w上就会闪。测试发现实际值也传过来了，就是1.5\n		float A = u_WaveInfo[i].y;//wi.A;\n		float W = u_WaveInfo[i].z;//wi.omega;\n		float P = u_WaveInfo[i].w;//wi.phi;\n		\n		float dop = dot(cD,uvpos);\n		float c = cos(dop*W - tm*P);//TODO 优化\n		float s = sin(dop*W - tm*P);\n		/*\n		float AWs = A*W*s;\n		float AWc = A*W*c;\n		float _QxyAWs = -Q*cD.x*cD.y*AWs;\n		\n		N += vec3(-cD.x*AWc,\n				-cD.y*AWc,\n				Q*AWs);//记得最后1-\n		*/\n		float kWAc = scale*c;//k*W*A*c;  为了提高精度，这里只保留sin，cos部分，实际使用的时候再乘回来。\n		//float kWAc = k*W*A*c;  \n		N += vec3(\n			-kWAc*cD.x*pow((s+1.)/2.,k-1.),\n			-kWAc*cD.y*pow((s+1.)/2.,k-1.),\n			1.\n		);\n	}\n	//N.z=1.-N.z;\n	//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n	N.xyz=N.xzy;\n}\n");var t,e,i={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_TexcoordNext0:14,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},n={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_AmbientTexture:[5,1],u_ReflectTexture:[6,1],u_AlphaTestValue:[0,1],u_Albedo:[7,1],u_UVMatrix:[13,1],u_UVAge:[14,1],u_UVAniAge:[8,1],u_MaterialDiffuse:[10,1],u_MaterialAmbient:[9,1],u_MaterialSpecular:[11,1],u_MaterialReflect:[12,1],u_TilingOffset:[15,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},r=di.nameKey.add("SIMPLE");t='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef defined(AMBIENTMAP)||(defined(LIGHTMAP)&&defined(UV1))\nattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_LightMapUV;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n	uniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n#ifdef BONE\n	mat4 skinTransform=mat4(0.0);\n	skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n	skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n	skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n	skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n	vec4 position=skinTransform*a_Position;\n	#ifdef VR\n		gl_Position = DistortFishEye(u_MvpMatrix * position);\n	#else\n		gl_Position = u_MvpMatrix * position;\n	#endif\n#else\n	#ifdef VR\n		gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n	#else\n		gl_Position = u_MvpMatrix * a_Position;\n	#endif\n#endif\n \n//TODO没考虑UV动画呢\n#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n	v_Texcoord0=a_Texcoord0;\n#endif\n	v_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n#ifdef BONE\n	mat4 skinTransform=mat4(0.0);\n	skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n	skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n	skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n	skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n	vec4 position=skinTransform*a_Position;\n	#ifdef VR\n		gl_Position = DistortFishEye(u_MvpMatrix * position);\n	#else\n		gl_Position = u_MvpMatrix * position;\n	#endif\n#else\n	#ifdef VR\n		gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n	#else\n		gl_Position = u_MvpMatrix * a_Position;\n	#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n	mat3 worldMat;\n	#ifdef BONE\n		worldMat=mat3(u_WorldMat*skinTransform);\n	#else\n		worldMat=mat3(u_WorldMat);\n	#endif  \n	v_Normal=worldMat*a_Normal;\n	#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n		v_Tangent0=worldMat*a_Tangent0;\n	#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n	#ifdef BONE\n		v_PositionWorld=(u_WorldMat*position).xyz;\n	#else\n		v_PositionWorld=(u_WorldMat*a_Position).xyz;\n	#endif\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\n	#ifdef MIXUV\n		v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n	#else\n		v_Texcoord0=a_Texcoord0;\n	#endif\n	#ifdef TILINGOFFSET\n		v_Texcoord0=(v_Texcoord0*u_TilingOffset.xy)+u_TilingOffset.zw;\n	#endif\n	#ifdef UVTRANSFORM\n		v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n	#endif\n#endif\n\n#ifdef defined(AMBIENTMAP)||defined(LIGHTMAP)\n	#ifdef SCALEOFFSETLIGHTINGMAPUV\n		#ifdef UV1\n			v_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n		#else\n			v_LightMapUV=vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n		#endif \n	#else\n		#ifdef UV1\n			v_LightMapUV=a_Texcoord1;\n		#else\n			v_LightMapUV=a_Texcoord0;\n		#endif \n	#endif \n#endif\n\n#ifdef COLOR\n	v_Color=a_Color;\n#endif\n\n#ifdef RECEIVESHADOW\n	v_posViewZ = gl_Position.w;\n	#ifdef SHADOWMAP_PSSM1 \n		v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n	#endif\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\n	main_castShadow();\n#else\n	main_normal();\n#endif\n}',
e='#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#if   defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef defined(AMBIENTMAP)||defined(LIGHTMAP)\nvarying vec2 v_LightMapUV;\n#endif\n#ifdef AMBIENTMAP\nuniform sampler2D u_AmbientTexture;\n#endif\n#ifdef LIGHTMAP\nuniform sampler2D u_LightMap;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP) \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#if defined(FOG)||defined(DEPTHFOG)\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||(defined(RECEIVESHADOW)&&(defined(SHADOWMAP_PSM2)||defined(SHADOWMAP_PSM3)))\nuniform vec3 u_CameraPos;\n#endif\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)\nvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n	uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n	varying vec4 v_lightMVPPos;\n	#endif\n#endif\nvarying float v_posViewZ;\n\n\n\nvoid main_castShadow()\n{\n	//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n	gl_FragColor=packDepth(v_posViewZ);\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		float alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n		if( alpha < u_AlphaTestValue )\n		{\n			discard;\n		}\n	#endif\n}\nvoid main_normal()\n{\n#if defined(DIFFUSEMAP)&&!defined(COLOR)\n	gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n#endif \n  \n#if defined(COLOR)&&!defined(DIFFUSEMAP)\n	gl_FragColor=v_Color;\n#endif \n  \n#if defined(DIFFUSEMAP)&&defined(COLOR)\n	vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n	gl_FragColor=texColor*v_Color;\n#endif\n  \n#if !defined(DIFFUSEMAP)&&!defined(COLOR)\n	gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n#endif \n    \n#ifdef ALPHATEST\n	if(gl_FragColor.a-u_AlphaTestValue<0.0)\n		discard;\n#endif\n  \n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n	vec3 normal;\n    #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n		vec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n		normal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n	#else\n		normal = normalize(v_Normal);\n    #endif\n#endif\n	\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	vec3 diffuse = vec3(0.0);\n	vec3 ambient = vec3(0.0);\n	vec3 specular= vec3(0.0);\n	vec3 dif, amb, spe;\n#endif\n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n	vec3 toEye;\n	#ifdef FOG\n		toEye=u_CameraPos-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n	#else\n		toEye=normalize(u_CameraPos-v_PositionWorld);\n	#endif\n#endif\n	\n#ifdef DIRECTIONLIGHT\n	computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n	computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n	ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n	float shadowValue = 1.0;\n	#ifdef SHADOWMAP_PSSM3\n		shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif\n	#ifdef SHADOWMAP_PSSM2\n		shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif \n	#ifdef SHADOWMAP_PSSM1\n		shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n	#endif\n#endif\n\n#ifdef AMBIENTMAP\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n	#else\n		#if defined(RECEIVESHADOW)\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb * shadowValue);\n		#else\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n		#endif\n	#endif\n#endif\n\n#ifdef LIGHTMAP\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n	#else\n		#if defined(RECEIVESHADOW)\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n		#else\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n		#endif\n	#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_Albedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	#if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n		specular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n	#ifdef RECEIVESHADOW\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular*shadowValue,gl_FragColor.a);\n	#else\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n	#endif\n#endif\n  \n#ifdef REFLECTMAP\n	vec3 incident = -toEye;\n	vec3 reflectionVector = reflect(incident,normal);\n	vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n	gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n#endif\n  \n#ifdef FOG\n	float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n	gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n#ifdef DEPTHFOG\n	float lerpFact = (-v_PositionWorld.y-u_FogStart)/u_FogRange;\n	gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW		\n	main_castShadow();\n#else\n  main_normal();\n#endif  \n}\n\n';var a=me.add(r,t,e,i,n);gi.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),gi.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),gi.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),gi.SHADERDEFINE_EMISSIVEMAP=a.registerMaterialDefine("EMISSIVEMAP"),gi.SHADERDEFINE_AMBIENTMAP=a.registerMaterialDefine("AMBIENTMAP"),gi.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),gi.SHADERDEFINE_UVTRANSFORM=a.registerMaterialDefine("UVTRANSFORM"),gi.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),i={a_Position:0,a_Color:1},n={u_MvpMatrix:[1,2]};var s=di.nameKey.add("LINE");t='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}',e="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n  gl_FragColor=v_Color; \n}\n\n",me.add(s,t,e,i,n),i={a_position:0,a_normal:3,tangent:5,binormal:4,uv:2,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},n={u_Bones:[0,0],u_lodRect:[9,3],irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],u_aoObjPos:[14,1],texBaseColor:[1,1],texNormal:[2,1],texPbrInfo:[3,1],texPrefilterdEnv:[8,3],texHSNoise:[15,1],texPrefilterDiff:[7,3],u_AlphaTestValue:[0,1],texBRDFLUT:[4,1],u_UVAniAge:[5,1],u_roughness:[6,1],u_metaless:[7,1],u_UVMatrix:[8,1],u_UVAge:[9,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var o=di.nameKey.add("PBR");t="\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n#ifdef HAS_TANGENT\nattribute vec3 tangent;\nattribute vec3 binormal;\n#endif\nattribute vec2 uv;\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\n\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\nvoid main() {\n#ifdef BONE\n	mat4 skinTransform=mat4(0.0);\n	skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n	skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n	skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n	skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n	gl_Position = mvp*skinTransform*vec4(a_position,1.);\n	mat4 modelMat = modelMatrix*skinTransform;\n#else\n	gl_Position = mvp*vec4(a_position,1.);\n	mat4 modelMat = modelMatrix;\n#endif	\n	vWorldPos = modelMat*vec4(a_position,1.);\n\n#ifdef CASTSHADOW \n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		vUv = uv;\n	#endif	\n#else\n    vUv = uv;\n	vWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n	#ifdef HAS_TANGENT\n	vWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n	vWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n	#endif\n    \n    vViewDir = (vWorldPos.xyz-cameraPosition);//这个不能normalize。否则无法线性差值了\n#ifdef RECEIVESHADOW\n	v_posViewZ = gl_Position.z;\n	#ifdef SHADOWMAP_PSSM1 \n		v_lightMVPPos = u_lightShadowVP[0] * vWorldPos;\n	#endif\n#endif	\n#endif\n}\n",e='//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\nvarying vec3 vViewDir;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n//预计算的贴图\nuniform sampler2D texPrefilterdEnv;\nuniform sampler2D texBRDFLUT;\nuniform sampler2D texPrefilterDiff;\n#ifdef HAS_PBRINFO\nuniform sampler2D texPbrInfo;   //Ao, Roughness, Metallic\n#endif\nuniform float u_hdrexposure;\nuniform float u_AlphaTestValue;\n\nuniform float u_roughness;\nuniform float u_metaless;\nconst float maxlv = 7.;	//现在只支持512分辨率的环境贴图\nconst int nmaxlv = 9;//\n							\nuniform mat4 irrad_mat_red;\nuniform mat4 irrad_mat_green;\nuniform mat4 irrad_mat_blue;							\n\nvec3 speccontrib = vec3(0.);\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\nvec4 tex2dLod(sampler2D tex, float u, float v, float lod){\n	vec2 uv = vec2(u,v);\n	uv+=mod(gl_FragCoord.xy-vec2(0.5),2.0)*vec2(128.,0.);\n	return texture2D(tex,uv,lod-16.);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n	float envu = atan(dir.z,dir.x)/_2PI+0.5; 	\n	float envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n	return texture2D(tex,vec2(envu,envv));\n}\n\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n	float envu = atan(dir.z,dir.x)/_2PI+0.5; 	\n	float envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n	return tex2dLod(tex,envu,envv,lod);\n}\n\n/*\n    计算sh光照。\n    使用level=2，所以需要9个系数。\n    https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\n*/\nfloat environment_exposure = 1.0;\nvec3 diff_sh9(vec3 dir){\n	vec4 shDir = vec4(dir.x,-dir.z,dir.y,1.0);\n  return max(vec3(0.0), vec3(\n	dot(shDir, irrad_mat_red * shDir),\n	dot(shDir, irrad_mat_green * shDir),\n	dot(shDir, irrad_mat_blue * shDir)\n	)) * environment_exposure;	\n}\n\n#ifdef HAS_TANGENT\nvec3 applyNormalTex( vec3 norm, vec3 surf_norm ) {\n    vec3 mapN = norm * 2.0 - 1.0;\n    //mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( vWorldTangent, vWorldBinormal, surf_norm );\n    return normalize( tsn * mapN );\n}\n#endif\n\nvec4 pbrlight(vec3 normal, float rough, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n	basecolor.rgb = pow(basecolor.rgb,vec3(2.2));\n	float metaless = 1.0; 	\n	const float ismetalinfov = (128./255.);\n	if(basecolor.a>=ismetalinfov){//这时候表示金属度\n		metaless = (basecolor.a-ismetalinfov)*2.;\n		basecolor.a = 1.0;\n	}else{\n		metaless = 0.;\n		basecolor.a = basecolor.a*2.0;\n	}\n	#ifdef FIX_METALESS\n	metaless = u_metaless;\n	#endif\n	#ifdef HAS_PBRINFO	\n	vec4 pbrinfo = texture2D(texPbrInfo, vUv);\n	metaless = pbrinfo.b;\n	rough = pbrinfo.g;\n	#endif\n    const vec3 nonmetalF0 =vec3(0.02);\n    vec3 F0 =  mix(nonmetalF0, basecolor.rgb, metaless);\n	\n    vec4 PrefilteredColor = texPanoramaLod(texPrefilterdEnv, R, rough*maxlv);\n    PrefilteredColor.rgb = _RGBEToRGB(PrefilteredColor);\n    vec4 EnvBRDF = texture2D(texBRDFLUT,vec2(rough , NoV));//TODO lod\n    vec2 rg = _RGBAToU16(EnvBRDF);    \n    speccontrib = (F0* rg.x + saturate( 50.0 * PrefilteredColor.g ) * rg.y);\n	vec3 color_spec = PrefilteredColor.rgb*speccontrib;\n	\n	vec3 color_diff=diff_sh9(normal);\n	vec3 outc =  color_diff*mix(basecolor.rgb,vec3(0.),metaless)*(vec3(1.0)-speccontrib)+color_spec;\n	#ifdef HAS_PBRINFO\n	outc*=pbrinfo.r;\n	#endif\n	return vec4(outc, basecolor.a);\n}\n\nvec3 oldlight(vec4 normal, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n	const vec3 lightdir=normalize(vec3(1.,1.,0.));\n	const vec3 spcecol = vec3(1.,0.8,0.8);\n	const vec3 amb = vec3(0.5);\n	vec3 diffv =  (vec3(saturate(dot(lightdir,normal.xyz)))+amb);\n	//vec3 spec = spcecol* pow(saturate(dot(R,lightdir)),(1.-pbrinfo.g)*5.);\n	return diffv*basecolor.rgb;//+spec;\n}\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n	uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n	varying vec4 v_lightMVPPos;\n	#endif\n#endif\n\nvoid main() {\n#ifdef CASTSHADOW\n	gl_FragColor=packDepth(gl_FragCoord.w);\n	#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n		float alpha = texture2D(texBaseColor,vUv).w;\n		if( alpha < u_AlphaTestValue ){\n			discard;\n		}\n	#endif\n#else\n\n	#ifdef RECEIVESHADOW\n		float shadowValue = 1.0;\n		#ifdef SHADOWMAP_PSSM3\n			shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n		#endif\n		#ifdef SHADOWMAP_PSSM2\n			shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n		#endif \n		#ifdef SHADOWMAP_PSSM1\n			shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.0001);\n		#endif\n	#endif	\n	\n    vec3 normal =  normalize(vWorldNorm);\n	vec4 normtex = texture2D( texNormal, vUv );\n	#ifdef HAS_TANGENT	\n	normal = applyNormalTex(normtex.xyz, normal);\n	#endif\n    vec3 view   = -normalize(vViewDir);\n    float NoV = saturate(dot( view, normal ));\n    vec3 R = 2. * NoV * normal - view;\n	float roughness = normtex.a;\n	#ifdef FIX_ROUGHNESS\n	roughness = u_roughness;\n	#endif\n	\n	vec4 pbrl = pbrlight(normal,roughness,NoV,R)*u_hdrexposure;\n    gl_FragColor.rgb =  pow(pbrl.rgb,vec3(0.45455));\n	//gl_FragColor.rgb = oldlight(normtex,NoV,R);\n	#ifdef RECEIVESHADOW\n	gl_FragColor.rgb *= max(shadowValue,0.7);\n	#endif\n	\n    gl_FragColor.a = pbrl.a;\n\n#endif\n}\n',a=me.add(o,t,e,i,n),mi.SHADERDEFINE_FIX_METALESS=a.registerMaterialDefine("FIX_METALESS"),mi.SHADERDEFINE_FIX_ROUGHNESS=a.registerMaterialDefine("FIX_ROUGHNESS"),mi.SHADERDEFINE_HAS_TANGENT=a.registerMaterialDefine("HAS_TANGENT"),mi.SHADERDEFINE_HAS_PBRINFO=a.registerMaterialDefine("HAS_PBRINFO"),mi.SHADERDEFINE_USE_GROUNDTRUTH=a.registerMaterialDefine("USE_GROUNDTRUTH"),mi.SHADERDEFINE_TEST_CLIPZ=a.registerMaterialDefine("CLIPZ"),i={a_position:0,a_normal:3,uv:2},n={irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],texBaseColor:[1,1],texNormal:[2,1],texSky:[11,1],texUnderWater:[3,1],texPrefilterdEnv:[8,3],texPrefilterDiff:[7,3],texWaterDisp:[4,1],texWaveDetail:[9,1],texDeepColor:[10,1],texWaterInfo:[16,1],texFoam:[17,1],GEOWAVE_UV_SCALE:[18,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_curTm:[8,1],u_scrsize:[15,1],u_WaveInfoD:[13,1],u_WaveInfo:[12,1],u_WaveMainDir:[14,1],u_DeepScale:[20,1],u_SeaColor:[19,1],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4]};var h=di.nameKey.add("Water");t='\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\nuniform float u_curTm;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n//uniform sampler2D texWaterDisp;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nuniform sampler2D texWaterInfo;\nvarying vec4 vWaterInfo;\nuniform float u_DeepScale;//texWaterInfo.r*vDeepScale\n#endif\nuniform float u_WaveMainDir;	//主波方向\nuniform float GEOWAVE_UV_SCALE ;//= 100.0;\n\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\nvarying vec3 vDisp;\nvarying float fDeep;\nvarying mat2 matUVTrans;\nvarying float fFoam;\n\nconst float PI = 3.14159265358979323846264;\n\n#include "WaveFunction.glsl"\n\nvec2 getPosFromUV(vec2 uv){\n	return uv*50.;\n}\n\nvoid main() {\n	vec3 pos = a_position;\n    vUv = uv;\n	\n	//vDisp = texture2D(texWaterDisp,uv).rgb;\n	//vec3 disp = vDisp;\n	\n	//TODO 这里有个潜规则。\n	float tt = pos.y; pos.y=pos.z; pos.z=-tt;\n	\n	#ifdef USE_VERTEX_DEEPINFO\n	fDeep = -pos.y;\n	pos.y=0.0;\n	#else\n	vWaterInfo = texture2D(texWaterInfo,uv);\n	fDeep = vWaterInfo.r*u_DeepScale;\n	#endif\n	\n	\n	//计算波形\n	mat4 modelMat = modelMatrix;\n	vec3 opos, T,B,N;\n	float foams=0.;\n	vec2 uvpos = uv*GEOWAVE_UV_SCALE+vec2(modelMat[3][0],0.);//TODO 如果有旋转缩放怎么办\n	calcGerstnerWave(u_curTm, pos,fDeep, uvpos,opos,B,T,N,foams);\n	fFoam = foams;\n	gl_Position = mvp*vec4(opos,1.);\n	vWorldPos = modelMat*vec4(opos,1.);\n\n	vWorldNorm = normalize((modelMatrix*vec4(N,0.0)).xyz);\n	vWorldTan = normalize((modelMatrix*vec4(T,0.0)).xyz);\n	vWorldBin = normalize((modelMatrix*vec4(B,0.0)).xyz);\n    vViewDir = vWorldPos.xyz-cameraPosition; //这个不能取normalize，否则会引入非线性\n	\n	float s = sin(u_WaveMainDir);\n	float c = cos(u_WaveMainDir);\n	matUVTrans = mat2(c,-s,s,c);\n}\n',e="//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec3 vViewDir;//入射。pos-cam\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying float fDeep;\nvarying mat2 matUVTrans;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nvarying vec4 vWaterInfo;\n#endif\nmat3 matTBNOff;//\n\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n#ifdef CUBE_ENV\nuniform samplerCube texSky;\n#else\nuniform sampler2D texSky;\n#endif\nuniform sampler2D texUnderWater;\nuniform sampler2D texWaveDetail;\n//uniform sampler2D texDeepColor;\nuniform sampler2D texFoam;\nvarying float fFoam;\nuniform float u_curTm;\nuniform vec2 u_scrsize;\nuniform vec3 u_SeaColor;//\n\nconst int NumTexWaves=4;\nconst float Amp_over_L = 0.01;\n//const vec3 SEA_COLOR1 = vec3(0.0292,0.672,0.7467);//大洋\n//const vec3 SEA_COLOR2 = vec3(0,0.927,0.43);//近海\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\n/*\n	各种 ToneMap\n*/\n//Reinhard\nvec3 ReinhardToneMapping(vec3 color, float adapted_lum) {\n    const float MIDDLE_GREY = 1.;\n    color *= MIDDLE_GREY / adapted_lum;\n    return color / (1.0 + color);\n}\n\n//CE2\nvec3 CEToneMapping(vec3 color, float adapted_lum){\n    return 1. - exp(-adapted_lum * color);\n}\n\n//UC2\nvec3 F1(vec3 x){\n	const float A = 0.22;\n	const float B = 0.30;\n	const float C = 0.10;\n	const float D = 0.20;\n	const float E = 0.01;\n	const float F = 0.30;\n \n	return ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;\n}\n\nvec3 Uncharted2ToneMapping(vec3 color, float adapted_lum){\n	const vec3 WHITE = vec3(11.2);\n	return F1(1.6 * adapted_lum * color) / F1(WHITE);\n}\n\n//ACES\nvec3 ACESToneMapping(vec3 color, float adapted_lum){\n	const float A = 2.51;\n	const float B = 0.03;\n	const float C = 2.43;\n	const float D = 0.59;\n	const float E = 0.14;\n\n	color *= adapted_lum;\n	return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n	float envu = atan(dir.z,dir.x)/_2PI+0.5; 	\n	float envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n	return texture2D(tex,vec2(envu,envv));\n}\n\n/*\n	与位于0点的测试棒的相交测试交点\n	这个是瞎写的，只是为了测试\n*/\nbool hitClydiner(vec3 pos, vec3 dir, out vec3 hitpos, out vec3 hitnormal){\n	const float r = 0.5;\n	float a = dir.x*dir.x+dir.z*dir.z;\n	float b = 2.*dir.x*pos.x+2.*dir.z*pos.z;\n	float c = pos.x*pos.x+pos.z*pos.z-r*r;\n	float d = b*b-4.*a*c;\n	if(d>=0.0){\n		float t = (-b+sqrt(d))/2./a;\n		t =min(t, (-b-sqrt(d))/2./a);\n		hitpos = pos+dir*t;\n		return true;\n	}\n	/*\n	vec3 v1 = normalize(cross(dir,vec3(0.,1.,0.)));//公垂线\n	float dist = dot(pos,v1);//最短距离\n	if(abs(dist)<r){\n		return true;\n	}\n	*/\n	return false;\n}\n\n///* 根据散射公式来计算某个方向的颜色 *///\n//\nfloat phase_function(float costheta, float g, float g2){\n	return 1.5*( (1.0-g2) / (2.0+g2) ) * (1.0+costheta*costheta) / pow(1.0+g2-2.0*g*costheta, 1.5);	\n}\n\nconst float _density = .2;\nconst vec3 _vLightDir=vec3(0.,-1.,0.);//必须是规格化的\nconst int _SAMPLENUM = 20;\nconst float _K1 = 1.0;\nconst float _g = -0.93;\n//\nvec3 calcScatter(vec3 start, vec3 dir, vec3 end){\n	float len = length(end-start);\n	float costheta = dot(dir,_vLightDir);\n	float g2 = _g*_g;\n	float K = _K1*len*_density*phase_function(costheta,_g,g2);\n	//用分段的方式来积分\n	float dlen = len/float(_SAMPLENUM);//距离平分\n	float ddeep = (start.y-end.y)/float(_SAMPLENUM);//深度平分\n	float sum=0.;\n	for( int i=0; i<_SAMPLENUM; i++){\n		float fi = float(i);\n		float v1 = exp(-_density*(dlen+ddeep)*fi);//TODO 应该可以用分析法计算出来\n		sum += v1;\n	}\n	return vec3(K*sum);\n}\n///* 根据散射公式来计算某个方向的亮度  END *///\n\nconst float cDeep = -2.;	//假设水的深度\nvec3 getShuiDiColor(vec3 pos, vec3 dir, vec3 normal){\n	//一个无限大的水底，黑白格纹理。纹理长度为1米\n	float t = ( cDeep-pos.y )/dir.y;\n	if(t<0.) return vec3(1.,0.,0.);//TEST\n	bool bhit = false;\n	vec3 hitpos;\n	vec3 hitcolor;\n	vec3 hn;\n	if(hitClydiner(pos,dir,hitpos,hn) && hitpos.y>cDeep && hitpos.y<pos.y){\n		bhit=true;\n		hitcolor = vec3(.8,.8,.8);\n\n	}else\n	{\n		hitpos = pos+dir*t;\n		vec3 hp = floor(hitpos);\n		float a = mod((hp.x+hp.z),2.);\n		hitcolor = (a<.9)?vec3(0.,0.,0.):vec3(1.,1.,1.);\n		//hitcolor = texture2D(texUnderWater,hitpos.xz/10.).rgb;\n	}\n	\n	float l = length(hitpos-pos);\n	//return texture2D(texDeepColor,vec2(min(max(l/400.,0.),1.),0.5)).rgb;\n	//return SEA_COLOR1*calcScatter(pos,dir,hitpos);\n	float left = pow(0.8,l);//假设透过率为80%，则到达水底的时候的光强。\n	return mix(hitcolor,u_SeaColor,1.-left);\n}\n\n/*\n	view已经normalize了\n*/\nvec3 getRefractColor(vec3 view,vec3 normal){\n	vec3 T = refract(-view, normal, 0.7);\n	return getShuiDiColor(vWorldPos.xyz,T,normal); \n}\n\nvec4 calcWaterC(vec3 view, vec3 normal, float von, vec3 R, float rough){\n	/*\n	只有浪顶的法线向下，也就是波形形成了交叠的时候，才会这样，所以要通过参数控制避免出现这种情况，而不是在这里保护。\n	if(dot(R,vec3(0.,1.,0.))<0.){\n		R = -R;\n	}\n	*/\n	//vec3 refr = getRefractColor(-view,normal);\n#ifdef USE_REFR_TEX	\n	vec3 refr = texture2D(texUnderWater, gl_FragCoord.xy/u_scrsize+normal.xz/8.).rgb;\n#else\n	vec3 refr = u_SeaColor;\n#endif\n	float F0=0.02;\n	//菲涅尔，越大反射越强\n	float f =  F0+(1.0-F0)*exp2((-5.55473*von-6.98316)*von);\n	//float f = F0+(1.0-F0)*pow(1.-von,5.);\n	//能看到水底的程度。反射剩余的*水中的衰减\n	//float a = (1.-f)*(1.-deepk);\n#ifdef CUBE_ENV\n	vec4 reflc = textureCube(texSky,R);\n#else\n	vec4 reflc = texPanorama(texSky, R);\n#endif\n#ifdef HDR_ENV\n	vec3 refl = _RGBEToRGB(reflc)*f;\n#else\n	vec3 refl = reflc.rgb*f;\n#endif\n	//return vec4(refl*(1.-rough),1.);\n	\n	//vec3 refl = reflc.rgb*f;\n	vec3 final = mix(refr, u_SeaColor, min(fDeep/10.,1.))+refl*(max(0.,1.-rough));\n#ifdef HDR_ENV\n	final = ACESToneMapping(final,1.);//TODO 这个要uniform传入\n#endif\n	return vec4(final,f);\n}\n\nvoid main() {\n    vec3 normal =  normalize(vWorldNorm);\n	//如果uv=1为100米，希望每个细节纹理表示20米的小波形，则uv缩放是 100/20。细节纹理内部也要用这个值，即pos=uv*20\n	vec2 ruv = matUVTrans*vUv;\n	vec3 detailNorm = texture2D(texWaveDetail,fract(ruv*5.)).rgb*2.-vec3(1.);//TODO uv怎么算\n	float texNormScale = 2.*PI*float(NumTexWaves)*Amp_over_L*2.5;\n	detailNorm *= vec3(texNormScale,1.,texNormScale);\n	//旋转\n	//细节纹理来自rendertarget，因此需要颠倒z\n	\n	matTBNOff = mat3(matUVTrans[0][0],0.,matUVTrans[1][0],\n	0.,1.,0.,\n	matUVTrans[0][1],0.,matUVTrans[1][1]\n	);\n	\n	/*\n	matTBNOff = mat3(0.,0.,1.,\n	0.,1.,0.,\n	-1.,0.,0.\n	);\n	*/\n\n    mat3 tsn = mat3( vWorldBin, normal, vWorldTan);	\n    //normal = normalize(tsn * matTBNOff * detailNorm);\n	normal = normalize(tsn * detailNorm); //这个应该更正确。因为本身方向就是根据uv算的，如果是静态图片才需要转换。\n	//vec4 normtex = texture2D( texNormal, vUv );\n    vec3 view   = -normalize(vViewDir);//view 是指向camera的\n    float NoV = saturate(dot( view, normal ));\n    //vec3 R = 2. * NoV * normal - view;\n	\n#ifdef USE_FOAM	\n	vec4 foamc = (texture2D(texFoam,vUv*50.)+texture2D(texFoam,vUv*20.))/2.;\n	float nearcoast = 1.-min(fDeep/10.,1.);// 1.-vWaterInfo.r;\n	float foams = (nearcoast/4.+fFoam)*2.*nearcoast;\n#else\n	float foams =0.;\n#endif\n	\n	vec3 R = reflect(-view,normal);\n	vec4 wc = calcWaterC(view, normal,NoV,R, foams);\n\n	gl_FragColor.rgb = wc.rgb;//normalize(detailNorm).rrr;//((normal)+vec3(0.0))/1.;//normalize(normal).rgb;//texture2D(texWaveDetail,vUv).rgb;// fracColor * texture2D(texUnderWater, vUv*20.0).rgb;// vec3(1.0);//pbrl.rgb;\n    gl_FragColor.a = 1.0;//wc.a;\n#ifdef USE_FOAM\n	gl_FragColor.rgb = mix(gl_FragColor.rgb,vec3(1.),foamc.a*foams);\n	gl_FragColor.a = foamc.r;\n#endif\n	//if(mod(vUv.x*100.,1.0)<0.02 || mod(vUv.y*100.,1.0)<0.02) gl_FragColor.rgb=vec3(0.5,.5,.5);\n	//gl_FragColor.rgb = detailNorm;\n}\n",a=me.add(h,t,e,i,n),xi.SHADERDEFINE_CUBE_ENV=a.registerMaterialDefine("CUBE_ENV"),xi.SHADERDEFINE_HDR_ENV=a.registerMaterialDefine("HDR_ENV"),xi.SHADERDEFINE_SHOW_NORMAL=a.registerMaterialDefine("SHOW_NORMAL"),xi.SHADERDEFINE_USEVERTEXHEIGHT=a.registerMaterialDefine("USE_VERTEX_DEEPINFO"),xi.SHADERDEFINE_USE_FOAM=a.registerMaterialDefine("USE_FOAM"),xi.SHADERDEFINE_USE_REFRACT_TEX=a.registerMaterialDefine("USE_REFR_TEX"),i={a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},n={u_Tintcolor:[2,1],u_texture:[1,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],
u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]};var l=di.nameKey.add("PARTICLESHURIKEN");t="#ifdef defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n	attribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n	attribute vec3 a_MeshPosition;\n	attribute vec2 a_MeshTextureCoordinate;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#ifdef defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||definedSIZEOVERLIFETIMERANDOMCURVESSEPERATE||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n	varying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\nuniform vec3 u_CameraPosition;//TODO:只有拉伸模式和雾化使用\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#ifdef defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#ifdef defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #ifdef defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #ifdef defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #ifdef defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec4 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec4 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #ifdef defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n	uniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n	uniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#ifdef defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#if FOG\n	varying vec3 v_PositionWorld;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n	float halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n	float halfYaw = rot.y * 0.5;\n\n	float sinRoll = sin(halfRoll);\n	float cosRoll = cos(halfRoll);\n	float sinPitch = sin(halfPitch);\n	float cosPitch = cos(halfPitch);\n	float sinYaw = sin(halfYaw);\n	float cosYaw = cos(halfYaw);\n\n	float quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n	float quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n	float quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n	float quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n	\n	//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n	//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n	//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n	\n	float x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n	float xx = quaX * x;\n    float xy = quaX * y;\n	float xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n	\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n	float halfAngle = angle * 0.5;\n	float sin = sin(halfAngle);\n	\n	float quaX = axis.x * sin;\n	float quaY = axis.y * sin;\n	float quaZ = axis.z * sin;\n	float quaW = cos(halfAngle);\n	\n	//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n	//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n	//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n	\n	float x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n	float xx = quaX * x;\n    float xy = quaX * y;\n	float xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n	\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n	return v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n	float curValue;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientNumber=gradientNumbers[i];\n		float key=gradientNumber.x;\n		if(key>=normalizedAge)\n		{\n			vec2 lastGradientNumber=gradientNumbers[i-1];\n			float lastKey=lastGradientNumber.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			curValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n			break;\n		}\n	}\n	return curValue;\n}\n#endif\n\n#ifdef defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n	float totalValue=0.0;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientNumber=gradientNumbers[i];\n		float key=gradientNumber.x;\n		vec2 lastGradientNumber=gradientNumbers[i-1];\n		float lastValue=lastGradientNumber.y;\n		\n		if(key>=normalizedAge){\n			float lastKey=lastGradientNumber.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			totalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n			break;\n		}\n		else{\n			totalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n		}\n	}\n	return totalValue;\n}\n#endif\n\n#ifdef defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n	vec4 overTimeColor;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientAlpha=gradientAlphas[i];\n		float alphaKey=gradientAlpha.x;\n		if(alphaKey>=normalizedAge)\n		{\n			vec2 lastGradientAlpha=gradientAlphas[i-1];\n			float lastAlphaKey=lastGradientAlpha.x;\n			float age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n			overTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n			break;\n		}\n	}\n	\n	for(int i=1;i<4;i++)\n	{\n		vec4 gradientColor=gradientColors[i];\n		float colorKey=gradientColor.x;\n		if(colorKey>=normalizedAge)\n		{\n			vec4 lastGradientColor=gradientColors[i-1];\n			float lastColorKey=lastGradientColor.x;\n			float age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n			overTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n			break;\n		}\n	}\n	return overTimeColor;\n}\n#endif\n\n\n#ifdef defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n	float overTimeFrame;\n	for(int i=1;i<4;i++)\n	{\n		vec2 gradientFrame=gradientFrames[i];\n		float key=gradientFrame.x;\n		if(key>=normalizedAge)\n		{\n			vec2 lastGradientFrame=gradientFrames[i-1];\n			float lastKey=lastGradientFrame.x;\n			float age=(normalizedAge-lastKey)/(key-lastKey);\n			overTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n			break;\n		}\n	}\n	return floor(overTimeFrame);\n}\n#endif\n\n#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n	 outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n	 outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n	                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n					 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n					\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n	#ifdef VELOCITYOVERLIFETIMECONSTANT\n		  startPosition=startVelocity*age;\n		  lifePosition=lifeVelocity*age;\n	#endif\n	#ifdef VELOCITYOVERLIFETIMECURVE\n		  startPosition=startVelocity*age;\n		  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n	#endif\n	#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n		  startPosition=startVelocity*age;\n		  lifePosition=lifeVelocity*age;\n	#endif\n	#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n		  startPosition=startVelocity*age;\n		  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n	      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n	      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n	#endif\n	\n	vec3 finalPosition;\n	if(u_VOLSpaceType==0){\n	  if(u_ScalingMode!=2)\n	   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n	  else\n	   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n	}\n	else{\n	  if(u_ScalingMode!=2)\n	    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n	  else\n	    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n	}\n  #else\n	 startPosition=startVelocity*age;\n	 vec3 finalPosition;\n	 if(u_ScalingMode!=2)\n	   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n	 else\n	   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n	#ifdef COLOROVERLIFETIME\n	  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n	#endif\n	\n	#ifdef RANDOMCOLOROVERLIFETIME\n	  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n	#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n	#ifdef SIZEOVERLIFETIMECURVE\n		size*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVES\n	    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n	#endif\n	#ifdef SIZEOVERLIFETIMECURVESEPERATE\n		size*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n	    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n	    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n	#endif\n	return size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n	#ifdef SIZEOVERLIFETIMECURVE\n		size*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVES\n	    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n	#endif\n	#ifdef SIZEOVERLIFETIMECURVESEPERATE\n		size*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n	#endif\n	#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n	    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n	    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n		,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n	#endif\n	return size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n	#ifdef ROTATIONOVERLIFETIME\n	#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConst*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n		#endif\n	#endif\n	#ifdef ROTATIONOVERLIFETIMESEPERATE\n	#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n		#endif\n	#endif\n	return rotation;\n}\n\n#ifdef defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationMesh(in vec3 rotation,in float age,in float normalizedAge)\n{ \n	#ifdef ROTATIONOVERLIFETIME\n	#ifdef ROTATIONOVERLIFETIMECONSTANT\n			float ageRot=u_ROLAngularVelocityConst*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			float ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n		#endif\n	#endif\n	#ifdef ROTATIONOVERLIFETIMESEPERATE\n	#ifdef ROTATIONOVERLIFETIMECONSTANT\n			vec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n	        rotation+=ageRot;\n		#endif\n		#ifdef ROTATIONOVERLIFETIMECURVE\n			rotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n		#endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n			vec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n	        rotation+=ageRot;\n	    #endif\n		#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n			rotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n	        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n	        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n		#endif\n	#endif\n	return rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n	#ifdef TEXTURESHEETANIMATIONCURVE\n		float cycleNormalizedAge=normalizedAge*u_TSACycles;\n		float frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n		float totalULength=frame*u_TSASubUVLength.x;\n		float floorTotalULength=floor(totalULength);\n	    uv.x=uv.x+totalULength-floorTotalULength;\n		uv.y=uv.y+floorTotalULength*u_TSASubUVLength.y;\n    #endif\n	#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n		float cycleNormalizedAge=normalizedAge*u_TSACycles;\n		float uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n	    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n		float totalULength=frame*u_TSASubUVLength.x;\n		float floorTotalULength=floor(totalULength);\n	    uv.x=uv.x+totalULength-floorTotalULength;\n		uv.y=uv.y+floorTotalULength*u_TSASubUVLength.y;\n    #endif\n	return uv;\n}\n\nvoid main()\n{\n   float age = u_CurrentTime - a_DirectionTime.w;\n   float normalizedAge = age/a_ShapePositionStartLifeTime.w;\n   vec3 lifeVelocity;\n   if(normalizedAge<1.0){ \n	  vec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n   #ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n	  lifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n   #endif \n	vec3 gravityVelocity=u_Gravity*age;\n	\n	vec4 worldRotation;\n	if(u_SimulationSpace==0)\n		worldRotation=a_SimulationWorldRotation;\n	else\n		worldRotation=u_WorldRotation;\n	\n   vec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n	    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n		#ifdef defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n			if(u_ThreeDStartRotation){\n				vec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n				center += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n			}\n			else{\n				float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n				float c = cos(rot);\n				float s = sin(rot);\n				mat2 rotation= mat2(c, -s, s, c);\n				corner=rotation*corner;\n				center += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n			}\n		#else\n			if(u_ThreeDStartRotation){\n				center += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n			}\n			else{\n				float c = cos(a_StartRotation0.x);\n				float s = sin(a_StartRotation0.x);\n				mat2 rotation= mat2(c, -s, s, c);\n				corner=rotation*corner;\n				center += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n			}\n		#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n	vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n	vec3 velocity;\n	#ifdef defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n	    if(u_VOLSpaceType==0)\n		  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n	    else\n		  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n	    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif	\n		vec3 cameraUpVector = normalize(velocity);\n		vec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n		\n		sideVector=u_SizeScale.xzy*sideVector;\n		cameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n		\n	    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n		\n	    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n	    corner=rotaionZHalfPI*corner;\n	    corner.y=corner.y-abs(corner.y);\n		\n	    float speed=length(velocity);//TODO:\n	    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,-1.0);\n	    const vec3 sideVector = vec3(1.0,0.0,0.0);\n		corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n		float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n	    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n		vec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n		corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n		float rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n	    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n	    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n		#ifdef defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n			if(u_ThreeDStartRotation){\n				float angle=computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge);\n				center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByEuler(a_MeshPosition*size,vec3(a_StartRotation0.xy,angle)),worldRotation));\n			}\n			else{\n				float angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n				if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0)\n				{\n					center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));\n				}\n				else\n				{\n					#ifdef SHAPE\n						center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n					#else\n						center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation));\n					#endif\n				}\n					\n			}\n		#else\n			if(u_ThreeDStartRotation){\n				center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation));\n			}\n			else{\n				if(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0)\n				{\n					if(u_SimulationSpace==0)\n						center+= u_SizeScale.xzy*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n					else if(u_SimulationSpace==1)\n						center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));\n				}\n				else\n				{\n					#ifdef SHAPE\n						if(u_SimulationSpace==0)\n							center+= u_SizeScale.xzy*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n						else if(u_SimulationSpace==1)\n							center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation));	\n					#else\n						if(u_SimulationSpace==0)\n							center+= u_SizeScale.xzy*(rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x));\n						else if(u_SimulationSpace==1)\n							center+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation));\n					#endif\n				}\n			}\n		#endif\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n	#ifdef DIFFUSEMAP\n		#ifdef defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n			v_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n		#endif\n		#ifdef RENDERMODE_MESH\n			v_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n		#endif\n	#endif\n      v_Discard=0.0;\n	  \n	#if FOG\n		v_PositionWorld=center;\n	#endif\n   }\n   else\n	{\n		v_Discard=1.0;\n	}\n}\n\n",e="#ifdef FSHIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#if FOG\n	varying vec3 v_PositionWorld;\n	uniform vec3 u_CameraPosition;\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	#if ADDTIVEFOG\n	#else\n		uniform vec3 u_FogColor;\n	#endif\n#endif\n\n\nvoid main()\n{	\n	#ifdef DIFFUSEMAP\n		if(v_Discard!=0.0)\n			discard;\n		#ifdef TINTCOLOR\n			gl_FragColor=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n		#else\n			gl_FragColor=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n		#endif\n	#else\n		#ifdef TINTCOLOR\n			gl_FragColor=u_Tintcolor*2.0*v_Color;\n		#else\n			gl_FragColor=v_Color;\n		#endif\n	#endif\n	\n	#ifdef FOG\n		vec3 toEye=u_CameraPosition-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n		\n		float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n		#if ADDTIVEFOG\n			gl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n		#else\n			gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n		#endif\n	#endif\n}",
a=me.add(l,t,e,i,n),Ti.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),Ti.SHADERDEFINE_TINTCOLOR=a.registerMaterialDefine("TINTCOLOR"),Ti.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),Fi.SHADERDEFINE_RENDERMODE_BILLBOARD=a.registerSpriteDefine("SPHERHBILLBOARD"),Fi.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=a.registerSpriteDefine("STRETCHEDBILLBOARD"),Fi.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=a.registerSpriteDefine("HORIZONTALBILLBOARD"),Fi.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=a.registerSpriteDefine("VERTICALBILLBOARD"),Fi.SHADERDEFINE_COLOROVERLIFETIME=a.registerSpriteDefine("COLOROVERLIFETIME"),Fi.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=a.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),Fi.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),Fi.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),Fi.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),Fi.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),Fi.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),Fi.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),Fi.SHADERDEFINE_ROTATIONOVERLIFETIME=a.registerSpriteDefine("ROTATIONOVERLIFETIME"),Fi.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=a.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),Fi.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=a.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),Fi.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=a.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),Fi.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),Fi.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),Fi.SHADERDEFINE_SIZEOVERLIFETIMECURVE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),Fi.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),Fi.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),Fi.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),Fi.SHADERDEFINE_RENDERMODE_MESH=a.registerSpriteDefine("RENDERMODE_MESH"),Fi.SHADERDEFINE_SHAPE=a.registerSpriteDefine("SHAPE"),i={a_Position:0,a_Texcoord0:2,a_Time:33},n={u_Texture:[1,1],u_Albedo:[2,1],u_Color:[3,1],u_CurrentTime:[2,2],u_Duration:[3,2],u_MvpMatrix:[1,2]};var u=di.nameKey.add("GLITTER");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",e="#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{	\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",a=me.add(u,t,e,i,n),i={a_Position:0},n={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_CubeTexture:[3,1],u_MvpMatrix:[4,3]};var c=di.nameKey.add("SkyBox");t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",e="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{	\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",me.add(c,t,e,i,n),i={a_Position:0,a_Texcoord0:2},n={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_texture:[3,1],u_MvpMatrix:[4,3]};var _=di.nameKey.add("SkyDome");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",e="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{	\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",me.add(_,t,e,i,n),i={a_Position:0,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15},n={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_NormalTexture:[1,1],u_DiffuseTexture1:[2,1],u_DiffuseTexture2:[3,1],u_DiffuseTexture3:[4,1],u_DiffuseTexture4:[5,1],u_DiffuseScale1:[6,1],u_DiffuseScale2:[7,1],u_DiffuseScale3:[8,1],u_DiffuseScale4:[9,1],u_MaterialDiffuse:[11,1],u_MaterialAmbient:[10,1],u_MaterialSpecular:[12,1],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var d=di.nameKey.add("Terrain");t="attribute vec4 a_Position;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n	attribute vec3 a_Normal;\n	varying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n	uniform mat4 u_WorldMat;\n	varying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef LIGHTMAP\n	uniform vec4 u_LightmapScaleOffset;\n	varying vec2 v_LightMapUV;\n#endif\n\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nuniform mat4 u_MvpMatrix;\n\nvoid main()\n{\n	gl_Position = u_MvpMatrix * a_Position;\n	v_Texcoord0=a_Texcoord0;\n	v_Texcoord1=a_Texcoord1;\n	\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	v_Normal=a_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n	v_PositionWorld=(u_WorldMat*a_Position).xyz;\n#endif\n\n#ifdef LIGHTMAP\n	//这个地方使用a_Normal 并不是真的代表normal，其实凑巧法线图的uv正好是符合 light_Map的UV\n	v_LightMapUV=vec2(a_Normal.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Normal.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n#endif\n\n#ifdef RECEIVESHADOW\n	v_posViewZ = gl_Position.w;\n	#ifdef SHADOWMAP_PSSM1\n		v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n	#endif\n#endif\n\n}",e='#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	uniform vec3 u_MaterialDiffuse;\n	uniform vec4 u_MaterialSpecular;\n	uniform vec3 u_CameraPos;\n	varying vec3 v_Normal;\n	varying vec3 v_PositionWorld;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n	uniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	uniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n	uniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n	uniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n	uniform SpotLight u_SpotLight;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n	uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n	varying vec4 v_lightMVPPos;\n	#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\nuniform sampler2D u_NormalTexture;\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform vec2 u_DiffuseScale1;\nuniform vec2 u_DiffuseScale2;\nuniform vec2 u_DiffuseScale3;\nuniform vec2 u_DiffuseScale4;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#ifdef LIGHTMAP\n	uniform sampler2D u_LightMap;\n	varying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n#ifdef DETAIL_NUM1\n	vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n	vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n	gl_FragColor.xyz = color1.xyz;\n#endif\n#ifdef DETAIL_NUM2\n	vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n	vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n	vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n	gl_FragColor.xyz = color1.xyz * (1.0-splatAlpha.r) + color2.xyz * splatAlpha.r;\n#endif\n#ifdef DETAIL_NUM3\n	vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n	vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n	vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n	vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n	gl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g)) + color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g;\n#endif\n#ifdef DETAIL_NUM4\n	vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n	vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n	vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n	vec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord1/u_DiffuseScale4);\n	vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n	gl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g+splatAlpha.b))+ color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g + color4.xyz * splatAlpha.b;\n#endif\n	gl_FragColor.w = splatAlpha.a;\n		\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = texture2D(u_NormalTexture,v_Normal.xy).xyz;\n	normal = normal*2.0 - vec3(1.0);\n	vec3 diffuse = vec3(0.0);\n	vec3 ambient = vec3(0.0);\n	vec3 specular= vec3(0.0);\n	vec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n	vec3 toEye;\n	#ifdef FOG\n		toEye=u_CameraPos-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n	#else\n		toEye=normalize(u_CameraPos-v_PositionWorld);\n	#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n	computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n	computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n	ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n	float shadowValue = 1.0;\n	#ifdef SHADOWMAP_PSSM3\n		shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif\n	#ifdef SHADOWMAP_PSSM2\n		shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif \n	#ifdef SHADOWMAP_PSSM1\n		shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n	#endif\n#endif\n\n#ifdef LIGHTMAP\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n	#else\n		#if defined(RECEIVESHADOW)\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n		#else\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n		#endif\n	#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	#ifdef RECEIVESHADOW\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n	#else\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n	#endif\n#endif\n\n#ifdef FOG\n	float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n	gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n';var f=me.add(d,t,e,i,n);yi.SHADERDEFINE_DETAIL_NUM1=f.registerMaterialDefine("DETAIL_NUM1"),yi.SHADERDEFINE_DETAIL_NUM2=f.registerMaterialDefine("DETAIL_NUM2"),yi.SHADERDEFINE_DETAIL_NUM4=f.registerMaterialDefine("DETAIL_NUM4"),yi.SHADERDEFINE_DETAIL_NUM3=f.registerMaterialDefine("DETAIL_NUM3"),i={a_Position:0,a_Normal:3,a_Texcoord0:2},n={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_DiffuseTexture1:[1,1],u_DiffuseTexture2:[2,1],u_DiffuseTexture3:[3,1],u_DiffuseTexture4:[4,1],u_DiffuseTexture5:[5,1],u_DiffuseScaleOffset1:[6,1],u_DiffuseScaleOffset2:[7,1],u_DiffuseScaleOffset3:[8,1],u_DiffuseScaleOffset4:[9,1],u_DiffuseScaleOffset5:[10,1],u_MaterialAlbedo:[14,1],u_MaterialDiffuse:[12,1],u_MaterialAmbient:[11,1],u_MaterialSpecular:[13,1],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var p=di.nameKey.add("ExtendTerrain");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n	attribute vec3 a_Normal;\n	varying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n	uniform mat4 u_WorldMat;\n	varying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n	varying vec2 v_LightMapUV;\n	uniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n	varying float v_posViewZ;\n	#ifdef SHADOWMAP_PSSM1 \n		varying vec4 v_lightMVPPos;\n		uniform mat4 u_lightShadowVP[4];\n	#endif\n#endif\n\nvoid main()\n{\n	gl_Position = u_MvpMatrix * a_Position;\n  \n	v_Texcoord0 = a_Texcoord0;\n  \n	#ifdef LIGHTMAP\n		v_LightMapUV = vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n	#endif\n  \n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		v_Normal = a_Normal;\n	#endif\n\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n		v_PositionWorld=(u_WorldMat*a_Position).xyz;\n	#endif\n\n	#ifdef RECEIVESHADOW\n		v_posViewZ = gl_Position.w;\n		#ifdef SHADOWMAP_PSSM1\n			v_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n		#endif\n	#endif\n}",e='#ifdef FSHIGHPRECISION\n	precision highp float;\n#else\n	precision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n	uniform vec3 u_MaterialDiffuse;\n	uniform vec4 u_MaterialSpecular;\n	uniform vec3 u_CameraPos;\n	varying vec3 v_Normal;\n	varying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n	uniform float u_FogStart;\n	uniform float u_FogRange;\n	uniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n	uniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n	uniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n	uniform SpotLight u_SpotLight;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n	#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n	uniform mat4 u_lightShadowVP[4];\n	#endif\n	#ifdef SHADOWMAP_PSSM1 \n	varying vec4 v_lightMVPPos;\n	#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\nuniform vec3 u_MaterialAmbient;\nuniform vec4 u_MaterialAlbedo;\n\n#ifdef LIGHTMAP\n	uniform sampler2D u_LightMap;\n	varying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n	#ifdef ExtendTerrain_DETAIL_NUM1\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r;\n	#endif\n	#ifdef ExtendTerrain_DETAIL_NUM2\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n	#endif\n	#ifdef ExtendTerrain_DETAIL_NUM3\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n		vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n	#endif\n	#ifdef ExtendTerrain_DETAIL_NUM4\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n		vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n		vec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n	#endif\n	#ifdef ExtendTerrain_DETAIL_NUM5\n		vec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n		vec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n		vec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n		vec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n		vec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n		vec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n		gl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n	#endif\n		gl_FragColor.w = splatAlpha.a;\n		\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n	vec3 diffuse = vec3(0.0);\n	vec3 ambient = vec3(0.0);\n	vec3 specular= vec3(0.0);\n	vec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n	vec3 toEye;\n	#ifdef FOG\n		toEye=u_CameraPos-v_PositionWorld;\n		float toEyeLength=length(toEye);\n		toEye/=toEyeLength;\n	#else\n		toEye=normalize(u_CameraPos-v_PositionWorld);\n	#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n	computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n	computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n	ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n	diffuse+=dif;\n	ambient+=amb;\n	specular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n	float shadowValue = 1.0;\n	#ifdef SHADOWMAP_PSSM3\n		shadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif\n	#ifdef SHADOWMAP_PSSM2\n		shadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n	#endif \n	#ifdef SHADOWMAP_PSSM1\n		shadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n	#endif\n#endif\n\n#ifdef LIGHTMAP\n	#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n		gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb) * 2.0;\n	#else\n		#if defined(RECEIVESHADOW)		\n			vec3 tColor= u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue + mix(vec3(0.2,0.2,0.2),vec3(0.0),shadowValue) * 2.0;\n			gl_FragColor.rgb*=tColor;\n		#else\n			gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb) * 2.0;\n		#endif\n	#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_MaterialAlbedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n	#ifdef RECEIVESHADOW\n		gl_FragColor = vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n	#else\n		gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n	#endif\n#endif\n\n#ifdef FOG\n	float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n	gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n';var m=me.add(p,t,e,i,n);fi.SHADERDEFINE_DETAIL_NUM1=m.registerMaterialDefine("ExtendTerrain_DETAIL_NUM1"),fi.SHADERDEFINE_DETAIL_NUM2=m.registerMaterialDefine("ExtendTerrain_DETAIL_NUM2"),fi.SHADERDEFINE_DETAIL_NUM3=m.registerMaterialDefine("ExtendTerrain_DETAIL_NUM3"),fi.SHADERDEFINE_DETAIL_NUM4=m.registerMaterialDefine("ExtendTerrain_DETAIL_NUM4"),fi.SHADERDEFINE_DETAIL_NUM5=m.registerMaterialDefine("ExtendTerrain_DETAIL_NUM5")},t}(),ye=function(){function t(){this._data=null,this._data=[]}r(t,"laya.d3.shader.ValusArray");var e=t.prototype;return e.setValue=function(t,e){this._data[t]=e},a(0,e,"data",function(){return this._data}),t}(),xe=function(){function t(){this._currentPSSM=-1,this._numberOfPSSM=3,this._maxDistance=200,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0,this._lightCulling=null,this._renderTarget=null,this._lightVPMatrix=null,this._lightCameras=null,this._shadowQuenes=null,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._shaderValueVPs=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new _e(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new _e,this._tempLookAt4=new de,this._tempValue=new de,this._tempPos=new _e,this._tempLightUp=new _e,this._tempMin=new de,this._tempMax=new de,this._tempMatrix44=new ae,this._splitFrustumCulling=new te(ae.DEFAULT),this._tempScaleMatrix44=new ae,this._shadowPCFOffset=new ce(1/1024,1/1024),this._shaderValueDistance=new de;var t=0;for(t=0;t<this._spiltDistance.length;t++)this._spiltDistance[t]=0;for(t=0;t<this._dimension.length;t++)this._dimension[t]=new ce;for(t=0;t<this._frustumPos.length;t++)this._frustumPos[t]=new _e;for(t=0;t<this._boundingBox.length;t++)this._boundingBox[t]=new Jt(new _e,new _e);for(t=0;t<this._boundingSphere.length;t++)this._boundingSphere[t]=new ee(new _e,0);ae.createScaling(new _e(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}r(t,"laya.d3.shadowMap.ParallelSplitShadowMap");var e=t.prototype;return e.setInfo=function(t,e,i,n,r,a){r>3&&(this._numberOfPSSM=3),this._scene=t,this._maxDistance=e,this.PSSMNum=r,this._globalParallelLightDir=i,this._ratioOfDistance=1/this._numberOfPSSM;for(var s=0;s<this._spiltDistance.length;s++)this._spiltDistance[s]=0;this._shadowMapTextureSize=n,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(a),this._statesDirty=!0},e.setPCFType=function(t){switch(this._PCFType=t,this._PCFType){case 0:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 1:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 2:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 3:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2)}},e.getPCFType=function(){return this._PCFType},e.setFarDistance=function(t){this._maxDistance!=t&&(this._maxDistance=t,this._statesDirty=!0)},e.getFarDistance=function(){return this._maxDistance},e._setGlobalParallelLightDir=function(t){this._globalParallelLightDir=t},e.getGlobalParallelLightDir=function(){return this._globalParallelLightDir},e.getCurrentPSSM=function(){return this._currentPSSM},e.getLightCamera=function(t){return this._lightCameras[t]},e._beginSampler=function(t,e){if(0>t||t>this._numberOfPSSM)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=t,this._update(e)},e.endSampler=function(t){this._currentPSSM=-1},e._calcAllLightCameraInfo=function(t){if(1===this._numberOfPSSM)this._beginSampler(0,t),this.endSampler(t);else for(var e=0,i=this._numberOfPSSM+1;i>e;e++)this._beginSampler(e,t),this.endSampler(t)},e._recalculate=function(t,e,i){this._calcSplitDistance(t),this._calcBoundingBox(e,i),this._rebuildRenderInfo()},e._update=function(t){var e=t.nearPlane,i=t.fieldOfView,n=t.aspectRatio;(this._statesDirty||this.lastNearPlane!==e||this.lastFieldOfView!==i||this.lastAspectRatio!==n)&&(this._recalculate(e,i,n),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=e,this.lastFieldOfView=i,this.lastAspectRatio=n),this._calcLightViewProject(t)},e._uploadShaderValue=function(){var t=this._scene;switch(this._numberOfPSSM){case 1:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 2:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 3:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2)}var e=t._shaderValues;switch(e.setValue(15,this._shaderValueDistance.elements),e.setValue(16,this._shaderValueLightVP),e.setValue(17,this._shadowPCFOffset.elements),this._numberOfPSSM){case 3:e.setValue(18,this.getRenderTarget(1).source),e.setValue(19,this.getRenderTarget(2).source),e.setValue(20,this.getRenderTarget(3).source);break;case 2:e.setValue(18,this.getRenderTarget(1).source),e.setValue(19,this.getRenderTarget(2).source);break;case 1:e.setValue(18,this.getRenderTarget(1).source)}},e._calcSplitDistance=function(t){var e=this._maxDistance,i=1/this._numberOfPSSM,n=0;for(n=0;n<=this._numberOfPSSM;n++)this._uniformDistance[n]=t+(e-t)*n*i;var r=e/t;for(n=0;n<=this._numberOfPSSM;n++){var a=Math.pow(r,n*i);this._logDistance[n]=t*a}for(n=0;n<=this._numberOfPSSM;n++)this._spiltDistance[n]=this._uniformDistance[n]*this._ratioOfDistance+this._logDistance[n]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3],this._shaderValueDistance.w=this._spiltDistance[4]},e._calcBoundingBox=function(t,e){var i=3.1415926*t/180,n=Math.tan(i/2),r=NaN,a=NaN,s=NaN,o=0;for(o=0;o<=this._numberOfPSSM;o++){s=this._spiltDistance[o],r=s*n,a=r*e;var h=this._frustumPos[4*o+0].elements;h[0]=-a,h[1]=-r,h[2]=-s,h=this._frustumPos[4*o+1].elements,h[0]=a,h[1]=-r,h[2]=-s,h=this._frustumPos[4*o+2].elements,h[0]=-a,h[1]=r,h[2]=-s,h=this._frustumPos[4*o+3].elements,h[0]=a,h[1]=r,h[2]=-s,h=this._dimension[o].elements,h[0]=a,h[1]=r}var l,u,c,_;for(o=1;o<=this._numberOfPSSM;o++)l=this._dimension[o].elements,u=this._boundingBox[o].min.elements,u[0]=-l[0],u[1]=-l[1],u[2]=-this._spiltDistance[o],c=this._boundingBox[o].max.elements,c[0]=l[0],c[1]=l[1],c[2]=-this._spiltDistance[o-1],_=this._boundingSphere[o].center.elements,_[0]=.5*(u[0]+c[0]),_[1]=.5*(u[1]+c[1]),_[2]=.5*(u[2]+c[2]),this._boundingSphere[o].radius=.5*Math.sqrt(Math.pow(c[0]-u[0],2)+Math.pow(c[1]-u[1],2)+Math.pow(c[2]-u[2],2));u=this._boundingBox[0].min.elements,l=this._dimension[this._numberOfPSSM].elements,u[0]=-l[0],u[1]=-l[1],u[2]=-this._spiltDistance[this._numberOfPSSM],c=this._boundingBox[0].max.elements,
c[0]=l[0],c[1]=l[1],c[2]=-this._spiltDistance[0],_=this._boundingSphere[0].center.elements,_[0]=.5*(u[0]+c[0]),_[1]=.5*(u[1]+c[1]),_[2]=.5*(u[2]+c[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(c[0]-u[0],2)+Math.pow(c[1]-u[1],2)+Math.pow(c[2]-u[2],2))},e.calcSplitFrustum=function(t){this._currentPSSM>0?ae.createPerspective(3.1416*t.fieldOfView/180,t.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):ae.createPerspective(3.1416*t.fieldOfView/180,t.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._numberOfPSSM],this._tempMatrix44),ae.multiply(this._tempMatrix44,t.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},e._rebuildRenderInfo=function(){var t=this._numberOfPSSM+1,e=0;if(null==this._renderTarget)for(this._renderTarget=s(t),this._renderTarget[0]=null,e=1;t>e;e++)this._renderTarget[e]=new Ai(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else if(this._renderTarget.length!=t)for(this.disposeAllRenderTarget(),this._renderTarget.length=t,this._renderTarget[0]=null,e=1;t>e;e++)this._renderTarget[e]=new Ai(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else for(e=1;t>e;e++)(null==this._renderTarget[e]||this._renderTarget[e].width!=this._shadowMapTextureSize||this._renderTarget[e].height!=this._shadowMapTextureSize)&&(null!=this._renderTarget[e]&&this._renderTarget[e].dispose(),this._renderTarget[e]=new Ai(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728));if(null==this._lightCulling||this._lightCulling.length!=t)for(this._lightCulling?this._lightCulling.length=t:this._lightCulling=s(t),e=0;e<this._lightCulling.length;e++)this._lightCulling[e]=new te(ae.DEFAULT);if(null==this._lightVPMatrix||this._lightVPMatrix.length!=t)for(this._lightVPMatrix?this._lightVPMatrix.length=t:this._lightVPMatrix=s(t),e=0;e<this._lightVPMatrix.length;e++)this._lightVPMatrix[e]=new ae;if(null==this._lightCameras||this._lightCameras.length!=t)for(this._lightCameras?this._lightCameras.length=t:this._lightCameras=s(t),e=0;e<this._lightCameras.length;e++)this._lightCameras[e]=new Oi,this._lightCameras[e].name="lightCamera"+e;if(null==this._shadowQuenes||this._shadowQuenes.length!=this._numberOfPSSM)for(this._shadowQuenes?this._shadowQuenes.length=this._numberOfPSSM:this._shadowQuenes=s(this._numberOfPSSM),e=0;e<this._shadowQuenes.length;e++)this._shadowQuenes[e]=new ht(this._scene);if(null==this._shaderValueVPs||this._shaderValueVPs.length!=t)for(this._shaderValueVPs?this._shaderValueVPs.length=t:this._shaderValueVPs=s(t),this._shaderValueLightVP=new Float32Array(16*t),e=0;t>e;e++)this._shaderValueVPs[e]=new Float32Array(this._shaderValueLightVP.buffer,64*e)},e._calcLightViewProject=function(e){var i=this._boundingSphere[this._currentPSSM],n=e.transform.worldMatrix;i.radius;i.center.cloneTo(this._tempLookAt3),_e.transformV3ToV4(this._tempLookAt3,n,this._tempLookAt4);var r=this._tempLookAt3.elements,a=this._tempLookAt4.elements;r[0]=a[0],r[1]=a[1],r[2]=a[2];var s=this._tempLightUp.elements,o=e.forward.elements;s[0]=o[0],s[1]=1,s[2]=o[2],_e.normalize(this._tempLightUp,this._tempLightUp),_e.scale(this._globalParallelLightDir,4*i.radius,this._tempPos),_e.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var h=this._lightCameras[this._currentPSSM];h.transform.position=this._tempPos,h.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var l=this._tempMax.elements,u=this._tempMin.elements;l[0]=l[1]=l[2]=-1e5,l[3]=1,u[0]=u[1]=u[2]=1e5,u[3]=1,ae.multiply(h.viewMatrix,n,this._tempMatrix44);var c=this._tempValue.elements,_=[];_.length=8,this._boundingBox[this._currentPSSM].getCorners(_);for(var d=0;8>d;d++){var f=_[d].elements;c[0]=f[0],c[1]=f[1],c[2]=f[2],c[3]=1,de.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),u[0]=c[0]<u[0]?c[0]:u[0],u[1]=c[1]<u[1]?c[1]:u[1],u[2]=c[2]<u[2]?c[2]:u[2],l[0]=c[0]>l[0]?c[0]:l[0],l[1]=c[1]>l[1]?c[1]:l[1],l[2]=c[2]>l[2]?c[2]:l[2]}de.add(this._tempMax,this._tempMin,this._tempValue),c[0]*=.5,c[1]*=.5,c[2]*=.5,c[3]=1,de.transformByM4x4(this._tempValue,h.transform.worldMatrix,this._tempValue);var p=Math.abs(-this._tempMax.z),m=p>this._maxDistance?p:this._maxDistance;_e.scale(this._globalParallelLightDir,m,this._tempPos);var g=this._tempPos.elements;g[0]=c[0]-g[0],g[1]=c[1]-g[1],g[2]=c[2]-g[2],h.transform.position=this._tempPos,h.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),ae.createOrthogonal(u[0],l[0],u[1],l[1],1,m+.5*(l[2]-u[2]),h.projectionMatrix),h.projectionViewMatrix.cloneTo(this._lightVPMatrix[this._currentPSSM]),this._lightCulling[this._currentPSSM].matrix=this._lightVPMatrix[this._currentPSSM],t.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,this._lightVPMatrix[this._currentPSSM],this._shaderValueVPs[this._currentPSSM])},e.getLightFrustumCulling=function(t){return this._lightCulling[t]},e.getSplitFrustumCulling=function(){return this._splitFrustumCulling},e.getSplitDistance=function(t){return this._spiltDistance[t]},e.setShadowMapTextureSize=function(t){t!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=t,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)},e.getShadowMapTextureSize=function(){return this._shadowMapTextureSize},e.beginRenderTarget=function(t){this._renderTarget[t].start()},e.endRenderTarget=function(t){this._renderTarget[t].end()},e.getRenderTarget=function(t){return this._renderTarget[t]},e.disposeAllRenderTarget=function(){for(var t=0,e=this._numberOfPSSM+1;e>t;t++)this._renderTarget[t]&&(this._renderTarget[t].dispose(),this._renderTarget[t]=null)},a(0,e,"PSSMNum",function(){return this._numberOfPSSM},function(t){t=t>0?t:1,t=3>=t?t:3,this._numberOfPSSM!=t&&(this._numberOfPSSM=t,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0)}),t.multiplyMatrixOutFloat32Array=function(t,e,i){var n,r,a,s,o,h,l;for(r=t.elements,a=e.elements,n=0;4>n;n++)s=r[n],o=r[n+4],h=r[n+8],l=r[n+12],i[n]=s*a[0]+o*a[1]+h*a[2]+l*a[3],i[n+4]=s*a[4]+o*a[5]+h*a[6]+l*a[7],i[n+8]=s*a[8]+o*a[9]+h*a[10]+l*a[11],i[n+12]=s*a[12]+o*a[13]+h*a[14]+l*a[15]},t.SHADERDEFINE_RECEIVE_SHADOW=1,t.SHADERDEFINE_CAST_SHADOW=512,t.SHADERDEFINE_SHADOW_PSSM1=1024,t.SHADERDEFINE_SHADOW_PSSM2=2048,t.SHADERDEFINE_SHADOW_PSSM3=4096,t.SHADERDEFINE_SHADOW_PCF_NO=8192,t.SHADERDEFINE_SHADOW_PCF1=16384,t.SHADERDEFINE_SHADOW_PCF2=32768,t.SHADERDEFINE_SHADOW_PCF3=65536,t.MAX_PSSM_COUNT=3,t}(),ve=function(){function t(){this._boundingSphere=null,this._boundingBox=null,this._sizeOfY=null,this._currentLODLevel=0,this._lastDistanceToEye=NaN,this._originalBoundingSphere=null,this._originalBoundingBox=null,this._originalBoundingBoxCorners=null,this._bUseStrip=!1,this._gridSize=NaN,this._beginGridX=0,this._beginGridZ=0,this._LODError=null,t.__init__(),this._currentLODLevel=0}r(t,"laya.d3.terrain.TerrainLeaf");var e=t.prototype;return e.calcVertextNorml=function(e,i,n,r,a,s){var o=0,h=0;h=-1*t.getHeightFromTerrainHeightData(e-1,i-1,n,r,a),h+=-1*t.getHeightFromTerrainHeightData(e-1,i,n,r,a),h+=-1*t.getHeightFromTerrainHeightData(e-1,i+1,n,r,a),h+=1*t.getHeightFromTerrainHeightData(e+1,i-1,n,r,a),h+=1*t.getHeightFromTerrainHeightData(e+1,i,n,r,a),h+=1*t.getHeightFromTerrainHeightData(e+1,i+1,n,r,a),o=-1*t.getHeightFromTerrainHeightData(e-1,i-1,n,r,a),o+=-1*t.getHeightFromTerrainHeightData(e,i-1,n,r,a),o+=-1*t.getHeightFromTerrainHeightData(e+1,i-1,n,r,a),o+=1*t.getHeightFromTerrainHeightData(e-1,i+1,n,r,a),o+=1*t.getHeightFromTerrainHeightData(e,i+1,n,r,a),o+=1*t.getHeightFromTerrainHeightData(e+1,i+1,n,r,a),s.x=-h,s.y=6,s.z=-o,_e.normalize(s,s)},e.calcVertextNormlUV=function(t,e,i,n,r){r.x=t/i,r.y=e/n,r.z=e/n},e.calcVertextBuffer=function(e,i,n,r,a,s,o,h,l,u,c,_){if(1==_&&!t.__ADAPT_MATRIX__){t.__ADAPT_MATRIX__=new ae;var d=new ae;ae.createRotationY(Math.PI,t.__ADAPT_MATRIX__),ae.createTranslate(new _e(0,0,(c-1)*a),d),ae.multiply(d,t.__ADAPT_MATRIX__,t.__ADAPT_MATRIX__),t.__ADAPT_MATRIX_INV__=new ae,t.__ADAPT_MATRIX__.invert(t.__ADAPT_MATRIX_INV__)}this._gridSize=a,this._beginGridX=e*t.CHUNK_GRID_NUM+n,this._beginGridZ=i*t.CHUNK_GRID_NUM+r;for(var f=o*h,p=2147483647,m=-2147483648,g=new _e,y=0,x=t.LEAF_GRID_NUM+1;x>y;y++)for(var v=0,S=t.LEAF_GRID_NUM+1;S>v;v++)t.__VECTOR3__.x=(this._beginGridX+v)*this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+y)*this._gridSize,t.__VECTOR3__.y=l[(this._beginGridZ+y)*u+(this._beginGridX+v)],p=t.__VECTOR3__.y<p?t.__VECTOR3__.y:p,m=t.__VECTOR3__.y>m?t.__VECTOR3__.y:m,t.__ADAPT_MATRIX__&&_e.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[f]=t.__VECTOR3__.x,f++,s[f]=t.__VECTOR3__.y,f++,s[f]=t.__VECTOR3__.z,f++,this.calcVertextNormlUV(this._beginGridX+v,this._beginGridZ+y,u,c,g),s[f]=g.x,f++,s[f]=g.y,f++,s[f]=g.z,f++,s[f]=(n+v)/t.CHUNK_GRID_NUM,f++,s[f]=(r+y)/t.CHUNK_GRID_NUM,f++,s[f]=this._beginGridX+v,f++,s[f]=this._beginGridZ+y,f++;this._sizeOfY=new ce(p-1,m+1),this.calcLODErrors(l,u,c),this.calcOriginalBoudingBoxAndSphere()},e.calcSkirtVertextBuffer=function(e,i,n,r,a,s,o,h,l,u,c){this._gridSize=a,this._beginGridX=e*t.CHUNK_GRID_NUM+n,this._beginGridZ=i*t.CHUNK_GRID_NUM+r;var _=o*h,d=0,f=0,p=t.LEAF_GRID_NUM+1,m=new _e,g=0,y=0;for(d=0;2>d;d++)for(f=0;p>f;f++)t.__VECTOR3__.x=(this._beginGridX+f)*this._gridSize,t.__VECTOR3__.y=1==d?l[this._beginGridZ*u+(this._beginGridX+f)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+0)*this._gridSize,t.__ADAPT_MATRIX__&&_e.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[_]=t.__VECTOR3__.x,_++,s[_]=t.__VECTOR3__.y,_++,s[_]=t.__VECTOR3__.z,_++,g=0==d?this._beginGridZ-1:this._beginGridZ,this.calcVertextNormlUV(this._beginGridX+f,g,u,c,m),s[_]=m.x,_++,s[_]=m.y,_++,s[_]=m.z,_++,s[_]=(n+f)/t.CHUNK_GRID_NUM,_++,s[_]=(r+0)/t.CHUNK_GRID_NUM,_++,s[_]=this._beginGridX+f,_++,s[_]=g,_++;for(d=0;2>d;d++)for(f=0;p>f;f++)t.__VECTOR3__.x=(this._beginGridX+f)*this._gridSize,t.__VECTOR3__.y=0==d?l[(this._beginGridZ+t.LEAF_GRID_NUM)*u+(this._beginGridX+f)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+t.LEAF_GRID_NUM)*this._gridSize,t.__ADAPT_MATRIX__&&_e.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[_]=t.__VECTOR3__.x,_++,s[_]=t.__VECTOR3__.y,_++,s[_]=t.__VECTOR3__.z,_++,g=0==d?this._beginGridZ+t.LEAF_GRID_NUM:this._beginGridZ+t.LEAF_GRID_NUM+1,this.calcVertextNormlUV(this._beginGridX+f,g,u,c,m),s[_]=m.x,_++,s[_]=m.y,_++,s[_]=m.z,_++,s[_]=(n+f)/t.CHUNK_GRID_NUM,_++,s[_]=(r+t.LEAF_GRID_NUM)/t.CHUNK_GRID_NUM,_++,s[_]=this._beginGridX+f,_++,s[_]=g,_++;for(d=0;2>d;d++)for(f=0;p>f;f++)t.__VECTOR3__.x=(this._beginGridX+0)*this._gridSize,t.__VECTOR3__.y=0==d?l[(this._beginGridZ+f)*u+(this._beginGridX+0)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+f)*this._gridSize,t.__ADAPT_MATRIX__&&_e.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[_]=t.__VECTOR3__.x,_++,s[_]=t.__VECTOR3__.y,_++,s[_]=t.__VECTOR3__.z,_++,y=0==d?this._beginGridX:this._beginGridX-1,this.calcVertextNormlUV(y,this._beginGridZ+f,u,c,m),s[_]=m.x,_++,s[_]=m.y,_++,s[_]=m.z,_++,s[_]=(n+0)/t.CHUNK_GRID_NUM,_++,s[_]=(r+f)/t.CHUNK_GRID_NUM,_++,s[_]=y,_++,s[_]=this._beginGridZ+f,_++;for(d=0;2>d;d++)for(f=0;p>f;f++)t.__VECTOR3__.x=(this._beginGridX+t.LEAF_GRID_NUM)*this._gridSize,t.__VECTOR3__.y=1==d?l[(this._beginGridZ+f)*u+(this._beginGridX+t.LEAF_GRID_NUM)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+f)*this._gridSize,t.__ADAPT_MATRIX__&&_e.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[_]=t.__VECTOR3__.x,_++,s[_]=t.__VECTOR3__.y,_++,s[_]=t.__VECTOR3__.z,_++,y=0==d?this._beginGridX+t.LEAF_GRID_NUM+1:this._beginGridX+t.LEAF_GRID_NUM,this.calcVertextNormlUV(y,this._beginGridZ+f,u,c,m),s[_]=m.x,_++,s[_]=m.y,_++,s[_]=m.z,_++,s[_]=(n+t.LEAF_GRID_NUM)/t.CHUNK_GRID_NUM,_++,s[_]=(r+f)/t.CHUNK_GRID_NUM,_++,s[_]=y,_++,s[_]=this._beginGridZ+f,_++},e.calcOriginalBoudingBoxAndSphere=function(){var e=new _e(this._beginGridX*this._gridSize,this._sizeOfY.x,this._beginGridZ*this._gridSize),i=new _e((this._beginGridX+t.LEAF_GRID_NUM)*this._gridSize,this._sizeOfY.y,(this._beginGridZ+t.LEAF_GRID_NUM)*this._gridSize);t.__ADAPT_MATRIX__&&(_e.transformV3ToV3(e,t.__ADAPT_MATRIX__,e),_e.transformV3ToV3(i,t.__ADAPT_MATRIX__,i)),this._originalBoundingBox=new Jt(e,i);var n=new _e;_e.subtract(i,e,n),_e.scale(n,.5,n);var r=new _e;_e.add(e,n,r),this._originalBoundingSphere=new ee(r,_e.scalarLength(n)),this._originalBoundingBoxCorners=[],this._originalBoundingBoxCorners.length=8,this._originalBoundingBox.getCorners(this._originalBoundingBoxCorners),this._boundingBox=new Jt(new _e(-.5,-.5,-.5),new _e(.5,.5,.5)),this._boundingSphere=new ee(new _e(0,0,0),1)},e.calcLeafBoudingBox=function(t){for(var e=0;8>e;e++)_e.transformCoordinate(this._originalBoundingBoxCorners[e],t,Le._tempBoundBoxCorners[e]);Jt.createfromPoints(Le._tempBoundBoxCorners,this._boundingBox)},e.calcLeafBoudingSphere=function(t,e){_e.transformCoordinate(this._originalBoundingSphere.center,t,this._boundingSphere.center),this._boundingSphere.radius=this._originalBoundingSphere.radius*e},e.calcLODErrors=function(e,i,n){this._LODError=new Float32Array(t._maxLODLevel+1);for(var r=1,a=0,s=t._maxLODLevel+1;s>a;a++){for(var o=0,h=0,l=t.LEAF_GRID_NUM;l>h;h+=r)for(var u=0,c=t.LEAF_GRID_NUM;c>u;u+=r)for(var _=e[(this._beginGridZ+h)*i+(this._beginGridX+u)],d=e[(this._beginGridZ+h)*i+(this._beginGridX+u)+r],f=e[(this._beginGridZ+h+r)*i+(this._beginGridX+u)],p=e[(this._beginGridZ+h+r)*i+(this._beginGridX+u)+r],m=0;r>m;m++)for(var g=m/r,y=0;r>y;y++){var x=y/r,v=e[(this._beginGridZ+h+m)*i+(this._beginGridX+u)+y],S=1>=x+g?_+(d-_)*x+(f-_)*g:p+(f-p)*(1-x)+(d-p)*(1-g),T=Math.abs(S-v);o=Math.max(o,T)}r*=2,this._LODError[a]=o}},e.determineLod=function(e,i,n,r){var a=_e.distance(e,this._boundingSphere.center),s=t._maxLODLevel;if(!r){if(this._lastDistanceToEye==a)return this._currentLODLevel;this._lastDistanceToEye>a&&(s=this._currentLODLevel)}for(var o=s;o>=1;o--)if(Ei.LOD_DISTANCE_FACTOR*this._LODError[o]/a*i<n){this._currentLODLevel=o;break}return this._lastDistanceToEye=a,this._currentLODLevel},t.__init__=function(){if(!t._bInit){var e=t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM*(t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM);t._planeLODIndex=s(e);var i=0,n=0,r=0,a=0,o=0,h=0,l=null,u=null;for(i=0;e>i;i++)t._planeLODIndex[i]=new Array(t._maxLODLevel+1);for(i=0,a=t._maxLODLevel+1;a>i;i++)t._planeLODIndex[0][i]=t.calcPlaneLODIndex(i);for(i=1;e>i;i++)for(h=i*t.LEAF_PLANE_VERTEXT_COUNT,n=0,o=t._maxLODLevel+1;o>n;n++){for(l=t._planeLODIndex[0][n],u=new Uint16Array(l.length),r=0;r<l.length;r++)u[r]=l[r]+h;t._planeLODIndex[i][n]=u}for(t._skirtLODIndex=s(e),i=0;e>i;i++)t._skirtLODIndex[i]=new Array(t._maxLODLevel+1);for(i=0,a=t._maxLODLevel+1;a>i;i++)t._skirtLODIndex[0][i]=t.calcSkirtLODIndex(i);for(i=1;e>i;i++)for(h=i*t.LEAF_SKIRT_VERTEXT_COUNT,n=0,o=t._maxLODLevel+1;o>n;n++){for(l=t._skirtLODIndex[0][n],u=new Uint16Array(l.length),r=0;r<l.length;r++)u[r]=l[r]+h;t._skirtLODIndex[i][n]=u}t._bInit=!0}},t.getPlaneLODIndex=function(e,i){return t._planeLODIndex[e][i]},t.getSkirtLODIndex=function(e,i){return t._skirtLODIndex[e][i]},t.calcPlaneLODIndex=function(e){e>t._maxLODLevel&&(e=t._maxLODLevel);var i=t.LEAF_GRID_NUM+1,n=0,r=null,a=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e);r=new Uint16Array(a*a*6);for(var s=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/a,o=0;o<t.LEAF_GRID_NUM;o+=s)for(var h=0;h<t.LEAF_GRID_NUM;h+=s)r[n]=(o+s)*i+h,n++,r[n]=o*i+h,n++,r[n]=o*i+h+s,n++,r[n]=o*i+h+s,n++,r[n]=(o+s)*i+h+s,n++,r[n]=(o+s)*i+h,n++;return r},t.calcSkirtLODIndex=function(e){e>t._maxLODLevel&&(e=t._maxLODLevel);var i=t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM*(t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM)*t.LEAF_PLANE_VERTEXT_COUNT,n=t.LEAF_GRID_NUM+1,r=0,a=null,s=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e);a=new Uint16Array(4*s*6);for(var o=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/s,h=0;4>h;h++){for(var l=0;l<t.LEAF_GRID_NUM;l+=o)a[r]=i+n+l,r++,a[r]=i+l,r++,a[r]=i+l+o,r++,a[r]=i+l+o,r++,a[r]=i+n+l+o,r++,a[r]=i+n+l,r++;i+=2*n}return a},t.getHeightFromTerrainHeightData=function(t,e,i,n,r){return t=0>t?0:t,t=t>=n?n-1:t,e=0>e?0:e,e=e>=r?r-1:e,i[e*n+t]},t.CHUNK_GRID_NUM=64,t.LEAF_GRID_NUM=32,t.__ADAPT_MATRIX__=null,t.__ADAPT_MATRIX_INV__=null,t._planeLODIndex=null,t._skirtLODIndex=null,t._bInit=!1,n(t,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(t.LEAF_GRID_NUM+1)*(t.LEAF_GRID_NUM+1)},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(t.LEAF_GRID_NUM+1)*4},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=t.LEAF_PLANE_VERTEXT_COUNT+t.LEAF_SKIRT_VERTEXT_COUNT},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=t.LEAF_GRID_NUM*t.LEAF_GRID_NUM*6},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*t.LEAF_GRID_NUM*6},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=t.LEAF_PLANE_MAX_INDEX_COUNT+t.LEAF_SKIRT_MAX_INDEX_COUNT},"__VECTOR3__",function(){return this.__VECTOR3__=new _e},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(t.LEAF_GRID_NUM)}]),t}(),Se=function(){function t(){this.alphaMap=null,this.detailID=null,this.normalMap=null}return r(t,"laya.d3.terrain.unit.ChunkInfo"),t}(),Te=function(){function t(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null}return r(t,"laya.d3.terrain.unit.DetailTextureInfo"),t}(),Ee=function(){function t(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null}return r(t,"laya.d3.terrain.unit.MaterialInfo"),t}(),we=function(){function t(){}return r(t,"laya.d3.utils.Physics"),t.rayCast=function(e,i,n,r){void 0===n&&(n=Number.MAX_VALUE),void 0===r&&(r=0),t._outHitAllInfo.length=0;for(var a=k.getLayerByNumber(r)._colliders,s=0,o=a.length;o>s;s++)if(a[s].raycast(e,t._outHitInfo,n),-1!==t._outHitInfo.distance&&t._outHitInfo.distance<=n){var h=new Ce;t._outHitInfo.cloneTo(h),t._outHitAllInfo.push(h)}if(0==t._outHitAllInfo.length)return i.sprite3D=null,void(i.distance=-1);for(var l=Number.MAX_VALUE,u=0,c=0;c<t._outHitAllInfo.length;c++)t._outHitAllInfo[c].distance<l&&(l=t._outHitAllInfo[c].distance,u=c);t._outHitAllInfo[u].cloneTo(i)},t.rayCastAll=function(e,i,n,r){void 0===n&&(n=Number.MAX_VALUE),void 0===r&&(r=0),i.length=0;for(var a=k.getLayerByNumber(r)._colliders,s=0,o=a.length;o>s;s++)if(t._outHitInfo.distance=-1,t._outHitInfo.sprite3D=null,a[s].raycast(e,t._outHitInfo,n),-1!==t._outHitInfo.distance&&t._outHitInfo.distance<=n){var h=new Ce;t._outHitInfo.cloneTo(h),i.push(h)}},t._outHitAllInfo=[],n(t,["_outHitInfo",function(){return this._outHitInfo=new Ce},"gravity",function(){return this.gravity=new _e(0,-9.81,0)}]),t}(),be=function(){function t(){}return r(t,"laya.d3.utils.Picker"),t.calculateCursorRay=function(e,i,n,r,a,s){var o=e.elements[0],h=e.elements[1],l=t._tempVector30,u=l.elements;u[0]=o,u[1]=h,u[2]=i.minDepth;var c=t._tempVector31,_=c.elements;_[0]=o,_[1]=h,_[2]=i.maxDepth;var d=s.origin,f=t._tempVector32;i.unprojectFromWVP(l,n,r,a,d),i.unprojectFromWVP(c,n,r,a,f);var p=s.direction.elements;p[0]=f.x-d.x,p[1]=f.y-d.y,p[2]=f.z-d.z,_e.normalize(s.direction,s.direction)},t.rayIntersectsPositionsAndIndices=function(e,i,n,r,a){for(var s=n.vertexStride/4,o=n.getVertexElementByUsage(0).offset/4,h=Number.MAX_VALUE,l=-1,u=-1,c=-1,_=0;_<r.length;_+=3){var d=t._tempVector35,f=d.elements,p=r[_]*s,m=p+o;f[0]=i[m],f[1]=i[m+1],f[2]=i[m+2];var g=t._tempVector36,y=g.elements,x=r[_+1]*s,v=x+o;y[0]=i[v],y[1]=i[v+1],y[2]=i[v+2];var S=t._tempVector37,T=S.elements,E=r[_+2]*s,w=E+o;T[0]=i[w],T[1]=i[w+1],T[2]=i[w+2];var b=laya.d3.utils.Picker.rayIntersectsTriangle(e,d,g,S);!isNaN(b)&&h>b&&(h=b,l=p,u=x,c=E)}if(h!==Number.MAX_VALUE){a.distance=h,_e.scale(e.direction,h,a.position),_e.add(e.origin,a.position,a.position);var C=a.trianglePositions,M=C[0],D=C[1],A=C[2],R=M.elements,I=D.elements,P=A.elements,L=l+o;R[0]=i[L],R[1]=i[L+1],R[2]=i[L+2];var N=u+o;I[0]=i[N],I[1]=i[N+1],I[2]=i[N+2];var O=c+o;P[0]=i[O],P[1]=i[O+1],P[2]=i[O+2];var V=n.getVertexElementByUsage(3);if(V){var F=V.offset/4,B=a.triangleNormals,U=B[0],k=B[1],H=B[2],z=U.elements,W=k.elements,G=H.elements,j=l+F;z[0]=i[j],z[1]=i[j+1],z[2]=i[j+2];var Y=u+F;W[0]=i[Y],W[1]=i[Y+1],W[2]=i[Y+2];var X=c+F;G[0]=i[X],G[1]=i[X+1],G[2]=i[X+2]}return!0}return a.position.toDefault(),a.distance=Number.MAX_VALUE,a.trianglePositions[0].toDefault(),a.trianglePositions[1].toDefault(),a.trianglePositions[2].toDefault(),a.triangleNormals[0].toDefault(),a.triangleNormals[1].toDefault(),a.triangleNormals[2].toDefault(),!1},t.rayIntersectsTriangle=function(e,i,n,r){var a,s=t._tempVector30,o=t._tempVector31;_e.subtract(n,i,s),_e.subtract(r,i,o);var h=t._tempVector32;_e.cross(e.direction,o,h);var l;if(l=_e.dot(s,h),l>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return a=Number.NaN;var u=1/l,c=t._tempVector33;_e.subtract(e.origin,i,c);var _;if(_=_e.dot(c,h),_*=u,0>_||_>1)return a=Number.NaN;var d=t._tempVector34;_e.cross(c,s,d);var f;if(f=_e.dot(e.direction,d),f*=u,0>f||_+f>1)return a=Number.NaN;var p;return p=_e.dot(o,d),p*=u,a=0>p?Number.NaN:p},n(t,["_tempVector30",function(){return this._tempVector30=new _e},"_tempVector31",function(){return this._tempVector31=new _e},"_tempVector32",function(){return this._tempVector32=new _e},"_tempVector33",function(){return this._tempVector33=new _e},"_tempVector34",function(){return this._tempVector34=new _e},"_tempVector35",function(){return this._tempVector35=new _e},"_tempVector36",function(){return this._tempVector36=new _e},"_tempVector37",function(){return this._tempVector37=new _e}]),t}(),Ce=function(){function t(){this.distance=NaN,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.sprite3D=null,this.distance=-1,this.trianglePositions=[new _e,new _e,new _e],this.trianglePositions.length=3,this.triangleNormals=[new _e,new _e,new _e],this.triangleNormals.length=3,this.position=new _e}r(t,"laya.d3.utils.RaycastHit");var e=t.prototype;return e.cloneTo=function(t){t.distance=this.distance,this.trianglePositions[0].cloneTo(t.trianglePositions[0]),this.trianglePositions[1].cloneTo(t.trianglePositions[1]),this.trianglePositions[2].cloneTo(t.trianglePositions[2]),this.triangleNormals[0].cloneTo(t.triangleNormals[0]),this.triangleNormals[1].cloneTo(t.triangleNormals[1]),this.triangleNormals[2].cloneTo(t.triangleNormals[2]),this.position.cloneTo(t.position),t.sprite3D=this.sprite3D},t}(),Me=function(){function t(t,e){this._width=0,this._height=0,this._width=t,this._height=e}r(t,"laya.d3.utils.Size");var e=t.prototype;return a(0,e,"width",function(){return-1===this._width?lt.clientWidth:this._width}),a(0,e,"height",function(){return-1===this._height?lt.clientHeight:this._height}),a(1,t,"fullScreen",function(){return new t(-1,-1)}),t}(),De=function(){function t(){}r(t,"laya.d3.utils.Utils3D");var e=t.prototype;return e.testTangent=function(t,e,i,n){var r=e.vertexDeclaration,a=t._material;if(a.normalTexture&&!r.getVertexElementByUsage(5)){var s=e.getData(),o=laya.d3.utils.Utils3D.generateTangent(s,r.vertexStride/4,r.getVertexElementByUsage(0).offset/4,r.getVertexElementByUsage(2).offset/4,i.getData());r=laya.d3.utils.Utils3D.getVertexTangentDeclaration(r.getVertexElements());var h=Si.create(r,35044);return h.setData(o),e.dispose(),n[5]=h,h}return e},t._rotationTransformScaleSkinAnimation=function(e,i,n,r,a,s,o,h,l,u,c,_){var d=t._tempArray16_0,f=t._tempArray16_1,p=t._tempArray16_2,m=r+r,g=a+a,y=s+s,x=r*m,v=a*m,S=a*g,T=s*m,E=s*g,w=s*y,b=o*m,C=o*g,M=o*y;d[15]=1,d[0]=1-S-w,d[1]=v+M,d[2]=T-C,d[4]=v-M,d[5]=1-x-w,d[6]=E+b,d[8]=T+C,d[9]=E-b,d[10]=1-x-S,f[15]=1,f[0]=h,f[5]=l,f[10]=u;var D,A,R,I,P;for(D=0;4>D;D++)A=d[D],R=d[D+4],I=d[D+8],P=d[D+12],p[D]=A,p[D+4]=R,p[D+8]=I,p[D+12]=A*e+R*i+I*n+P;for(D=0;4>D;D++)A=p[D],R=p[D+4],I=p[D+8],P=p[D+12],c[D+_]=A*f[0]+R*f[1]+I*f[2]+P*f[3],c[D+_+4]=A*f[4]+R*f[5]+I*f[6]+P*f[7],c[D+_+8]=A*f[8]+R*f[9]+I*f[10]+P*f[11],c[D+_+12]=A*f[12]+R*f[13]+I*f[14]+P*f[15]},t._createNodeByJson=function(e,i,n){if(!i)switch(e.type){case"Sprite3D":i=new We;break;case"MeshSprite3D":i=new Vi;break;case"SkinnedMeshSprite3D":i=new Bi;break;case"ShuriKenParticle3D":i=new Fi;break;case"Terrain":i=new Ei;break;case"Camera":i=new Oi;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var r=e.props;if(r)for(var a in r)void 0!==i[a]&&(i[a]=r[a]);var s=e.customProps;s&&i._parseCustomProps(n,s,e);var o=e.child;if(o)for(var h=0,l=o.length;l>h;h++){var u=t._createNodeByJson(o[h],null,n);i.addChild(u)}return i},t._computeBoneAndAnimationDatasByBindPoseMatrxix=function(t,e,i,n,r,a){var s,o,h=0,l=0,u=t.length;for(s=0;u>s;h+=t[s].keyframeWidth,l+=16,s++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(e[h+0],e[h+1],e[h+2],e[h+3],e[h+4],e[h+5],e[h+6],e[h+7],e[h+8],e[h+9],n,l),0!=s&&(o=16*t[s].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(n,o,n,l,n,l));var c=i.length;for(s=0;c>s;s++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(n,16*a[s],i[s],r,16*s)},t._computeAnimationDatasByArrayAndMatrixFast=function(t,e,i,n){for(var r=0,a=t.length;a>r;r++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(e,16*n[r],t[r],i,16*r)},t._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(t,e,i,n,r){var a,s,o=0,h=0,l=t.length;for(a=0;l>a;o+=t[a].keyframeWidth,h+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(e[o+7],e[o+8],e[o+9],e[o+3],e[o+4],e[o+5],e[o+6],e[o+0],e[o+1],e[o+2],n,h),0!=a&&(s=16*t[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(n,s,n,h,n,h));var u=i.length;for(a=0;u>a;a++){var c=16*a;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(n,c,i[a],r,c)}},t._computeAnimationDatasByArrayAndMatrixFastOld=function(t,e,i){for(var n=t.length,r=0;n>r;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(e,a,t[r],i,a)}},t._computeRootAnimationData=function(t,e,i){for(var n=0,r=0,a=0,s=t.length;s>n;r+=t[n].keyframeWidth,a+=16,n++)laya.d3.utils.Utils3D.createAffineTransformationArray(e[r+0],e[r+1],e[r+2],e[r+3],e[r+4],e[r+5],e[r+6],e[r+7],e[r+8],e[r+9],i,a)},t.generateTangent=function(e,i,n,r,a){for(var s=3,o=i+s,h=new Float32Array(o*(e.length/i)),l=0;l<a.length;l+=3){var u=a[l+0],c=a[l+1],_=a[l+2],d=i*u+n,f=t._tempVector3_0;f.x=e[d+0],f.y=e[d+1],f.z=e[d+2];var p=i*c+n,m=t._tempVector3_1;m.x=e[p+0],m.y=e[p+1],m.z=e[p+2];var g=i*_+n,y=t._tempVector3_2;y.x=e[g+0],y.y=e[g+1],y.z=e[g+2];var x=i*u+r,v=e[x+0],S=e[x+1],T=i*c+r,E=e[T+0],w=e[T+1],b=i*_+r,C=e[b+0],M=e[b+1],D=t._tempVector3_3;_e.subtract(m,f,D);var A=t._tempVector3_4;_e.subtract(y,f,A),_e.scale(D,M-S,D),_e.scale(A,w-S,A);var R=t._tempVector3_5;_e.subtract(D,A,R),_e.scale(R,1/((E-v)*(M-S)-(w-S)*(C-v)),R);var I=0;for(I=0;i>I;I++)h[o*u+I]=e[i*u+I];for(I=0;s>I;I++)h[o*u+i+I]=+R.elements[I];for(I=0;i>I;I++)h[o*c+I]=e[i*c+I];for(I=0;s>I;I++)h[o*c+i+I]=+R.elements[I];for(I=0;i>I;I++)h[o*_+I]=e[i*_+I];for(I=0;s>I;I++)h[o*_+i+I]=+R.elements[I]}for(l=0;l<h.length;l+=o){var P=o*l+i,L=t._tempVector3_6;L.x=h[P+0],L.y=h[P+1],L.z=h[P+2],_e.normalize(L,L),h[P+0]=L.x,h[P+1]=L.y,h[P+2]=L.z}return h},t.getVertexTangentDeclaration=function(t){for(var e=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=!1,h=0;h<t.length;h++)switch(t[h].elementUsage){case"POSITION":e=!0;break;case"NORMAL":i=!0;break;case"COLOR":n=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0}var l;return e&&i&&n&&r&&a&&s&&o&&(l=Dt.vertexDeclaration),e&&i&&n&&r&&s&&o?l=It.vertexDeclaration:e&&i&&r&&a&&s&&o?l=Ft.vertexDeclaration:e&&i&&r&&s&&o?l=kt.vertexDeclaration:e&&i&&n&&s&&o?l=Et.vertexDeclaration:e&&i&&n&&r&&a?l=At.vertexDeclaration:e&&i&&n&&r?l=Pt.vertexDeclaration:e&&i&&r&&a?l=Bt.vertexDeclaration:e&&i&&r?l=Ht.vertexDeclaration:e&&i&&n?l=wt.vertexDeclaration:e&&r&&(l=Yt.vertexDeclaration),l},t.transformVector3ArrayByQuat=function(t,e,i,n,r){var a=i.elements,s=t[e],o=t[e+1],h=t[e+2],l=a[0],u=a[1],c=a[2],_=a[3],d=_*s+u*h-c*o,f=_*o+c*s-l*h,p=_*h+l*o-u*s,m=-l*s-u*o-c*h;n[r]=d*_+m*-l+f*-c-p*-u,n[r+1]=f*_+m*-u+p*-l-d*-c,n[r+2]=p*_+m*-c+d*-u-f*-l},t.mulMatrixByArray=function(e,i,n,r,a,s){var o,h,l,u,c;if(a===n){for(n=t._tempArray16_3,o=0;16>o;++o)n[o]=a[s+o];r=0}for(o=0;4>o;o++)h=e[i+o],l=e[i+o+4],u=e[i+o+8],c=e[i+o+12],a[s+o]=h*n[r+0]+l*n[r+1]+u*n[r+2]+c*n[r+3],a[s+o+4]=h*n[r+4]+l*n[r+5]+u*n[r+6]+c*n[r+7],a[s+o+8]=h*n[r+8]+l*n[r+9]+u*n[r+10]+c*n[r+11],a[s+o+12]=h*n[r+12]+l*n[r+13]+u*n[r+14]+c*n[r+15]},t.mulMatrixByArrayFast=function(t,e,i,n,r,a){var s,o,h,l,u;for(s=0;4>s;s++)o=t[e+s],h=t[e+s+4],l=t[e+s+8],u=t[e+s+12],r[a+s]=o*i[n+0]+h*i[n+1]+l*i[n+2]+u*i[n+3],r[a+s+4]=o*i[n+4]+h*i[n+5]+l*i[n+6]+u*i[n+7],r[a+s+8]=o*i[n+8]+h*i[n+9]+l*i[n+10]+u*i[n+11],r[a+s+12]=o*i[n+12]+h*i[n+13]+l*i[n+14]+u*i[n+15]},t.mulMatrixByArrayAndMatrixFast=function(t,e,i,n,r){var a,s,o,h,l,u=i.elements,c=u[0],_=u[1],d=u[2],f=u[3],p=u[4],m=u[5],g=u[6],y=u[7],x=u[8],v=u[9],S=u[10],T=u[11],E=u[12],w=u[13],b=u[14],C=u[15],M=e,D=e+4,A=e+8,R=e+12,I=r,P=r+4,L=r+8,N=r+12;for(a=0;4>a;a++)s=t[M+a],o=t[D+a],h=t[A+a],l=t[R+a],n[I+a]=s*c+o*_+h*d+l*f,n[P+a]=s*p+o*m+h*g+l*y,n[L+a]=s*x+o*v+h*S+l*T,n[N+a]=s*E+o*w+h*b+l*C},t.createAffineTransformationArray=function(t,e,i,n,r,a,s,o,h,l,u,c){var _=n+n,d=r+r,f=a+a,p=n*_,m=n*d,g=n*f,y=r*d,x=r*f,v=a*f,S=s*_,T=s*d,E=s*f;u[c+0]=(1-(y+v))*o,u[c+1]=(m+E)*o,u[c+2]=(g-T)*o,u[c+3]=0,u[c+4]=(m-E)*h,u[c+5]=(1-(p+v))*h,u[c+6]=(x+S)*h,u[c+7]=0,u[c+8]=(g+T)*l,u[c+9]=(x-S)*l,u[c+10]=(1-(p+y))*l,u[c+11]=0,u[c+12]=t,u[c+13]=e,u[c+14]=i,u[c+15]=1},t.transformVector3ArrayToVector3ArrayCoordinate=function(e,i,n,r,a){var s=t._tempArray4_0,o=e[i+0],h=e[i+1],l=e[i+2],u=n.elements;s[0]=o*u[0]+h*u[4]+l*u[8]+u[12],s[1]=o*u[1]+h*u[5]+l*u[9]+u[13],s[2]=o*u[2]+h*u[6]+l*u[10]+u[14],s[3]=1/(o*u[3]+h*u[7]+l*u[11]+u[15]),r[a+0]=s[0]*s[3],r[a+1]=s[1]*s[3],r[a+2]=s[2]*s[3]},t.transformLightingMapTexcoordByUV0Array=function(t,e,i,n,r){var a=i.elements;n[r+0]=t[e+0]*a[0]+a[2],n[r+1]=(t[e+1]-1)*a[1]+a[3]},t.transformLightingMapTexcoordByUV1Array=function(t,e,i,n,r){var a=i.elements;n[r+0]=t[e+0]*a[0]+a[2],n[r+1]=1+t[e+1]*a[1]+a[3]},t.convert3DCoordTo2DScreenCoord=function(t,e){var i=t.elements,n=e.elements;n[0]=-lt.clientWidth/2+i[0],n[1]=lt.clientHeight/2-i[1],n[2]=i[2]},t.getURLVerion=function(t){var e=t.indexOf("?");return e>=0?t.substr(e):null},t._quaternionCreateFromYawPitchRollArray=function(t,e,i,n){var r=.5*i,a=.5*e,s=.5*t,o=Math.sin(r),h=Math.cos(r),l=Math.sin(a),u=Math.cos(a),c=Math.sin(s),_=Math.cos(s);n[0]=_*l*h+c*u*o,n[1]=c*u*h-_*l*o,n[2]=_*u*o-c*l*h,n[3]=_*u*h+c*l*o},t._createAffineTransformationArray=function(t,e,i,n){var r=n.elements,a=e[0],s=e[1],o=e[2],h=e[3],l=a+a,u=s+s,c=o+o,_=a*l,d=a*u,f=a*c,p=s*u,m=s*c,g=o*c,y=h*l,x=h*u,v=h*c,S=i[0],T=i[1],E=i[2];r[0]=(1-(p+g))*S,r[1]=(d+v)*S,r[2]=(f-x)*S,r[3]=0,r[4]=(d-v)*T,r[5]=(1-(_+g))*T,r[6]=(m+y)*T,r[7]=0,r[8]=(f+x)*E,r[9]=(m-y)*E,r[10]=(1-(_+p))*E,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1},t._mulMatrixArray=function(t,e,i,n){var r,a,s,o,h,l=e.elements,u=t.elements,c=l[0],_=l[1],d=l[2],f=l[3],p=l[4],m=l[5],g=l[6],y=l[7],x=l[8],v=l[9],S=l[10],T=l[11],E=l[12],w=l[13],b=l[14],C=l[15],M=n,D=n+4,A=n+8,R=n+12;for(r=0;4>r;r++)a=u[r],s=u[r+4],o=u[r+8],h=u[r+12],i[M+r]=a*c+s*_+o*d+h*f,i[D+r]=a*p+s*m+o*g+h*y,i[A+r]=a*x+s*v+o*S+h*T,i[R+r]=a*E+s*w+o*b+h*C},t._tempVector3_0=new _e,t._tempVector3_1=new _e,t._tempVector3_2=new _e,t._tempVector3_3=new _e,t._tempVector3_4=new _e,t._tempVector3_5=new _e,t._tempVector3_6=new _e,t._tempArray4_0=new Float32Array(4),t._tempArray16_0=new Float32Array(16),t._tempArray16_1=new Float32Array(16),t._tempArray16_2=new Float32Array(16),t._tempArray16_3=new Float32Array(16),n(t,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}}]),t}(),Ae=function(){function t(){}return r(t,"Laya3D"),t._changeWebGLSize=function(t,e){P.onStageResize(t,e),lt.clientWidth=t,lt.clientHeight=e},t.__init__=function(){var e=v.createMap;e.lh=[We,"SPRITE3DHIERARCHY"],e.ls=[li,"SPRITE3DHIERARCHY"],
e.lm=[Di,"MESH"],e.lmat=[gi,"MATERIAL"],e.lpbr=[mi,"MATERIAL"],e.ltc=[Li,"TEXTURECUBE"],e.jpg=[Pi,"nativeimage"],e.jpeg=[Pi,"nativeimage"],e.png=[Pi,"nativeimage"],e.pkm=[Pi,"arraybuffer"],e.lsani=[h,"arraybuffer"],e.lrani=[h,"arraybuffer"],e.raw=[Ci,"arraybuffer"],e.mipmaps=[Ci,"arraybuffer"],e.thdata=[Ze,"arraybuffer"],e.lt=[$e,"TERRAIN"],e.lani=[Ge,"arraybuffer"],e.lav=[je,"json"],e.ani=[h,"arraybuffer"],x.parserMap.SPRITE3DHIERARCHY=t._loadHierarchy,x.parserMap.MESH=t._loadMesh,x.parserMap.MATERIAL=t._loadMaterial,x.parserMap.TEXTURECUBE=t._loadTextureCube,x.parserMap.TERRAIN=t._loadTerrain,t._innerFirstLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerSecondLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerThirdLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerFourthLevelLoaderManager.on("error",null,t._eventLoadManagerError)},t.READ_BLOCK=function(){return t._readData.pos+=4,!0},t.READ_DATA=function(){return t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32(),!0},t.READ_STRINGS=function(){var e=[],i={offset:0,size:0};i.offset=t._readData.getUint16(),i.size=t._readData.getUint16();t._readData.pos;t._readData.pos=i.offset+t._DATA.offset;for(var n=0;n<i.size;n++){var r=t._readData.readUTFString();(-1!==r.lastIndexOf(".lmat")||-1!==r.lastIndexOf(".lpbr"))&&e.push(r)}return e},t._eventLoadManagerError=function(t){i.loader.event("error",t)},t._addHierarchyInnerUrls=function(t,e,i,n,r,a){var s=R.formatURL(r,n);i&&(s+=i),t.push({url:s,clas:a}),e[r]=s},t._getSprite3DHierarchyInnerUrls=function(e,i,n,r,a,s,o){var h,l=0,u=0;switch(e.type){case"Scene":var c=e.customProps.lightmaps;for(l=0,u=c.length;u>l;l++){var d=c[l].replace("exr","png");t._addHierarchyInnerUrls(r,a,s,o,d,Pi)}break;case"MeshSprite3D":case"SkinnedMeshSprite3D":var f;if(e.instanceParams)f=e.instanceParams.loadPath,f&&t._addHierarchyInnerUrls(i,a,s,o,f,Di);else{h=e.customProps,f=h.meshPath,f&&t._addHierarchyInnerUrls(i,a,s,o,f,Di);var p=h.materials;if(p)for(l=0,u=p.length;u>l;l++){var m=p[l],g=m.type.split("."),y=_.window;if(g.forEach(function(t){y=y[t]}),"function"!=typeof y)throw"_getSprite3DHierarchyInnerUrls 错误: "+m.type+" 不是类";t._addHierarchyInnerUrls(n,a,s,o,m.path,y)}}break;case"ShuriKenParticle3D":h=e.customProps;var x=h.meshPath;x&&t._addHierarchyInnerUrls(i,a,s,o,x,Di);var v=h.material;if(v)t._addHierarchyInnerUrls(n,a,s,o,v.path,Ti);else{var S=h.materialPath;S?t._addHierarchyInnerUrls(n,a,s,o,S,Ti):t._addHierarchyInnerUrls(r,a,s,o,h.texturePath,Pi)}break;case"Terrain":t._addHierarchyInnerUrls(r,a,s,o,e.customProps.dataPath,$e)}var T=e.components;for(var E in T){var w=T[E];switch(E){case"Animator":t._addHierarchyInnerUrls(r,a,s,o,w.avatarPath,je);var b=w.clipPaths;for(l=0,u=b.length;u>l;l++)t._addHierarchyInnerUrls(r,a,s,o,b[l],Ge)}}var C=e.child;for(l=0,u=C.length;u>l;l++)t._getSprite3DHierarchyInnerUrls(C[l],i,n,r,a,s,o)},t._loadHierarchy=function(e){e.on("loaded",null,t._onHierarchylhLoaded,[e]),e.load(e.url,"text",!1,null,!0)},t._onHierarchylhLoaded=function(e,i){var n=e.url,r=De.getURLVerion(n),a=R.getPath(R.formatURL(n)),s=[],o=[],h=[],l={},u=JSON.parse(i);t._getSprite3DHierarchyInnerUrls(u,s,o,h,l,r,a);var c=s.length+o.length+h.length,_=c+1,d=1/_;if(t._onProcessChange(e,0,d,1),h.length>0){var f=c/_,p=y.create(null,t._onProcessChange,[e,d,f],!1);t._innerFourthLevelLoaderManager.create(h,y.create(null,t._onHierarchyInnerForthLevResouLoaded,[e,p,i,l,s,o,d+f*h.length,f]),p)}else t._onHierarchyInnerForthLevResouLoaded(e,null,i,l,s,o,d,f)},t._onHierarchyInnerForthLevResouLoaded=function(e,i,n,r,a,s,o,h){if(i&&i.recover(),s.length>0){var l=y.create(null,t._onProcessChange,[e,o,h],!1);t._innerSecondLevelLoaderManager.create(s,y.create(null,t._onHierarchyInnerSecondLevResouLoaded,[e,l,n,r,a,o+h*s.length,h]),i)}else t._onHierarchyInnerSecondLevResouLoaded(e,null,n,r,a,o,h)},t._onHierarchyInnerSecondLevResouLoaded=function(e,i,n,r,a,s,o){if(i&&i.recover(),a.length>0){var h=y.create(null,t._onProcessChange,[e,s,o],!1);t._innerFirstLevelLoaderManager.create(a,y.create(null,t._onHierarchyInnerFirstLevResouLoaded,[e,h,n,r]),i)}else t._onHierarchyInnerFirstLevResouLoaded(e,null,n,r)},t._onHierarchyInnerFirstLevResouLoaded=function(t,e,i,n){e&&e.recover(),t.endLoad([i,n])},t._loadTerrain=function(e){e.on("loaded",null,t._onTerrainLtLoaded,[e]),e.load(e.url,"json",!1,null,!0)},t._onTerrainLtLoaded=function(e,i){var n,r,a=e.url,s=De.getURLVerion(a),o=R.getPath(R.formatURL(a)),h=[],l={},u=0,c=0,_=i.heightData;n=_.url,r=R.formatURL(n,o),s&&(r+=s),l[n]=r,n=r;var d=i.detailTexture;for(u=0,c=d.length;c>u;u++)h.push({url:d[u].diffuse});var f=i.normalMap;for(u=0,c=f.length;c>u;u++)h.push({url:f[u]});var p=i.alphaMap;for(u=0,c=p.length;c>u;u++)h.push({url:p[u],params:[!1,!1,6408,!0]});for(u=0,c=h.length;c>u;u++){var m=h[u].url;r=R.formatURL(m,o),s&&(r+=s),h[u].url=r,l[m]=r}var g=h.length,x=g+2,v=1/x;t._onProcessChange(e,0,v,1);var S={heightMapLoaded:!1,texturesLoaded:!1},T=y.create(null,t._onProcessChange,[e,v,v],!1);t._innerFourthLevelLoaderManager.create(n,y.create(null,t._onTerrainHeightMapLoaded,[e,T,i,l,S]),T,null,[_.numX,_.numZ,_.bitType,_.value]);var E=y.create(null,t._onProcessChange,[e,2*v,g/x],!1);t._innerFourthLevelLoaderManager.create(h,y.create(null,t._onTerrainTexturesLoaded,[e,E,i,l,S]),E)},t._onTerrainHeightMapLoaded=function(t,e,i,n,r){r.heightMapLoaded=!0,r.texturesLoaded&&(t.endLoad([i,n]),e.recover())},t._onTerrainTexturesLoaded=function(t,e,i,n,r){r.texturesLoaded=!0,r.heightMapLoaded&&(t.endLoad([i,n]),e.recover())},t._loadMesh=function(e){e.on("loaded",null,t._onMeshLmLoaded,[e]),e.load(e.url,"arraybuffer",!1,null,!0)},t._onMeshLmLoaded=function(e,i){var n,r,a=e.url,s=De.getURLVerion(a),o=R.getPath(R.formatURL(a)),h={},l=0,u=0,c=0;t._readData=new f(i),t._readData.pos=0;var _=t._readData.readUTFString();switch(_){case"LAYAMODEL:02":case"LAYAMODEL:03":var d=t._readData.getUint32();t._readData.pos=t._readData.pos+4,c=t._readData.getUint16(),t._readData.pos=t._readData.pos+8*c;var p=t._readData.getUint32();for(c=t._readData.getUint16(),t._readData.pos=d+p,n=[],l=0;c>l;l++){var m=t._readData.readUTFString();-1!==m.lastIndexOf(".lmat")&&n.push(m)}break;default:for(t.READ_BLOCK(),l=0;2>l;l++){var g=t._readData.getUint16(),x=t._strings[g],v=t["READ_"+x];if(null==v)throw new Error("model file err,no this function:"+g+" "+x);1===l?n=v.call():v.call()}}for(l=0,u=n.length;u>l;l++){var S=n[l];r=R.formatURL(S,o),s&&(r+=s),n[l]=r,h[S]=r}if(n.length>0){var T=1,E=T+1,w=1/E;t._onProcessChange(e,0,w,1);var b=y.create(null,t._onProcessChange,[e,w,T/E],!1);t._innerSecondLevelLoaderManager.create(n,y.create(null,t._onMeshMateialLoaded,[e,b,i,h]),b)}else e.endLoad([i,h])},t._onMeshMateialLoaded=function(t,e,i,n){t.endLoad([i,n]),e.recover()},t._getMaterialTexturePath=function(t,e,i){var n=t.length-4;return(t.indexOf(".dds")==n||t.indexOf(".tga")==n||t.indexOf(".exr")==n||t.indexOf(".DDS")==n||t.indexOf(".TGA")==n||t.indexOf(".EXR")==n)&&(t=t.substr(0,n)+".png"),t=R.formatURL(t,i),e&&(t+=e),t},t._loadMaterial=function(e){e.on("loaded",null,t._onMaterilLmatLoaded,[e]),e.load(e.url,"json",!1,null,!0)},t._onMaterilLmatLoaded=function(e,i){var n,r=e.url,a=De.getURLVerion(r),s=R.getPath(R.formatURL(r)),o=[],h={},l=i.customProps,u=i.version;if(u)switch(u){case"LAYAMATERIAL:01":for(var c=i.props.textures,_=0,d=c.length;d>_;_++){var f=c[_],p=f.path;if(p){var m=p.length-4;(p.indexOf(".exr")==m||p.indexOf(".EXR")==m)&&(p=p.substr(0,m)+".png"),n=R.formatURL(p,s),a&&(n+=a),o.push({url:n,params:f.params}),h[p]=n}}break;default:throw new Error("Laya3D:unkonwn version.")}else{var g=l.diffuseTexture.texture2D;if(g&&(n=t._getMaterialTexturePath(g,a,s),o.push(n),h[g]=n),l.normalTexture){var x=l.normalTexture.texture2D;x&&(n=t._getMaterialTexturePath(x,a,s),o.push(n),h[x]=n)}if(l.specularTexture){var v=l.specularTexture.texture2D;v&&(n=t._getMaterialTexturePath(v,a,s),o.push(n),h[v]=n)}if(l.emissiveTexture){var S=l.emissiveTexture.texture2D;S&&(n=t._getMaterialTexturePath(S,a,s),o.push(n),h[S]=n)}if(l.ambientTexture){var T=l.ambientTexture.texture2D;T&&(n=t._getMaterialTexturePath(T,a,s),o.push(n),h[T]=n)}if(l.reflectTexture){var E=l.reflectTexture.texture2D;E&&(n=t._getMaterialTexturePath(E,a,s),o.push(n),h[E]=n)}}var w=o.length,b=w+1,C=1/b;if(t._onProcessChange(e,0,C,1),w>0){var M=y.create(null,t._onProcessChange,[e,C,w/b],!1);t._innerFourthLevelLoaderManager.create(o,y.create(null,t._onMateialTexturesLoaded,[e,M,i,h]),M,Pi)}else t._onMateialTexturesLoaded(e,null,i,null)},t._onMateialTexturesLoaded=function(t,e,i,n){t.endLoad([i,n]),e&&e.recover()},t._loadTextureCube=function(e){e.on("loaded",null,t._onTextureCubeLtcLoaded,[e]),e.load(e.url,"json",!1,null,!0)},t._onTextureCubeLtcLoaded=function(e,i){var n=R.getPath(R.formatURL(e.url)),r=[R.formatURL(i.px,n),R.formatURL(i.nx,n),R.formatURL(i.py,n),R.formatURL(i.ny,n),R.formatURL(i.pz,n),R.formatURL(i.nz,n)],a=1/7;t._onProcessChange(e,0,a,1);var s=y.create(null,t._onProcessChange,[e,a,6/7],!1);t._innerFourthLevelLoaderManager.load(r,y.create(null,t._onTextureCubeImagesLoaded,[e,r,s]),s,"nativeimage")},t._onTextureCubeImagesLoaded=function(t,e,i){var n=[];n.length=6;for(var r=0;6>r;r++){var a=e[r];n[r]=x.getRes(a),x.clearRes(a)}t.endLoad(n),i.recover()},t._onProcessChange=function(t,e,i,n){n=e+n*i,1>n&&t.event("progress",n)},t.init=function(e,n,r,a,s,o){return void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===s&&(s=!0),void 0===o&&(o=!0),m.isAntialias=r,m.isAlpha=a,m.premultipliedAlpha=s,m.isStencil=o,E.isConchNode||P.enable()?(C.changeWebGLSize=t._changeWebGLSize,E.is3DMode=!0,i.init(e,n),k.__init__(),me.__init__(),ge.__init__(),Vi.__init__(),O.__init__(),t.__init__(),u.maxTextureCount=2,void((t.debugMode||ut.debugMode)&&(t._debugPhasorSprite=new st))):void alert("Laya3D init error,must support webGL!")},t.HIERARCHY="SPRITE3DHIERARCHY",t.MESH="MESH",t.MATERIAL="MATERIAL",t.PBRMATERIAL="PBRMTL",t.TEXTURECUBE="TEXTURECUBE",t.TERRAIN="TERRAIN",t._readData=null,t._debugPhasorSprite=null,t.debugMode=!1,n(t,["_DATA",function(){return this._DATA={offset:0,size:0}},"_strings",function(){return this._strings=["BLOCK","DATA","STRINGS"]},"_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new v},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new v},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new v},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new v}]),t}(),Re=function(t){function e(){this._worldMatrix=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._associatedAnimationNode=null,this._worldUpdate=!0,this._entity=null,e.__super.call(this),this._localMatrix=new ae,this._localPosition=new _e,this._localRotation=new he(0,0,0,1),this._localScale=new _e(1,1,1),this._localRotationEuler=new _e,this._childs=[]}r(e,"laya.d3.animation.AnimationTransform3D",t);var i=e.prototype;return i._updateLocalMatrix=function(){ae.createAffineTransformation(this._localPosition,this._localRotation,this._localScale,this._localMatrix)},i._onLocalTransform=function(){this._localUpdate=!0},i._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldPositionTransform()}},i._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldRotationTransform()}},i._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldScaleTransform()}},i._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldTransform()}},i._setWorldMatrixAndUpdate=function(t){if(this._worldMatrix=t,null==this._parent)throw new Error("don't need to set worldMatrix to root Node.");null==this._parent._parent?this.localMatrix.cloneTo(this._worldMatrix):ae.multiply(this._parent._getWorldMatrix(),this.localMatrix,this._worldMatrix),this._worldUpdate=!1},i._setWorldMatrixNoUpdate=function(t){this._worldMatrix=t,this._worldUpdate=!1},i._setLocalPosition=function(t){if(this._parent)this._localPosition=t,this._onLocalTransform(),this._onWorldPositionTransform();else{var e=this._entity.owner._transform,i=this._entity.localPosition;t.cloneTo(i),e.localPosition=i}},i._setLocalRotation=function(t){if(this._parent)this._localRotation=t,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldRotationTransform();else{var e=this._entity.owner._transform,i=this._entity.localRotation;t.cloneTo(i),e.localRotation=i}},i._setLocalScale=function(t){if(this._parent)this._localScale=t,this._onLocalTransform(),this._onWorldScaleTransform();else{var e=this._entity.owner._transform,i=this._entity.localScale;t.cloneTo(i),e.localScale=i}},i._setLocalRotationEuler=function(t){if(this._parent){var i=t.elements;he.createFromYawPitchRoll(i[1]/e._angleToRandin,i[0]/e._angleToRandin,i[2]/e._angleToRandin,this._localRotation),this._localRotationEuler=t,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldRotationTransform()}else{var n=this._entity.owner._transform,r=this._entity.localRotationEuler;t.cloneTo(r),n.localRotationEuler=r}},i._getWorldMatrix=function(){return this._worldUpdate?(null!=this._parent._parent?(ae.multiply(this._parent._getWorldMatrix(),this.localMatrix,this._worldMatrix),this._worldUpdate=!1):(this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix):this._worldMatrix},a(0,i,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix}),a(0,i,"associatedAnimationNode",function(){return this._associatedAnimationNode}),a(0,i,"localPosition",function(){return this._localPosition},function(t){this._localPosition=t,this._onLocalTransform(),this._onWorldPositionTransform()}),a(0,i,"localRotation",function(){if(this._localQuaternionUpdate){var t=this._localRotationEuler.elements;he.createFromYawPitchRoll(t[1]/e._angleToRandin,t[0]/e._angleToRandin,t[2]/e._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},function(t){this._localRotation=t,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._onLocalTransform(),this._onWorldRotationTransform()}),a(0,i,"localScale",function(){return this._localScale},function(t){this._localScale=t,this._onLocalTransform(),this._onWorldScaleTransform()}),a(0,i,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(e._tempVector3);var t=e._tempVector3.elements,i=this._localRotationEuler.elements;i[0]=t[1]/e._randinToAngle,i[1]=t[0]/e._randinToAngle,i[2]=t[2]/e._randinToAngle,this._locaEulerlUpdate=!1}return this._localRotationEuler},function(t){t.elements;this._localRotationEuler=t,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._onLocalTransform(),this._onWorldRotationTransform()}),a(0,i,"parent",function(){return this._parent},function(t){if(this._parent!==t){if(this._parent){var e=this._parent._childs,i=e.indexOf(this);e.splice(i,1)}t&&(t._childs.push(this),t&&this._onWorldTransform()),this._parent=t}}),n(e,["_tempVector3",function(){return this._tempVector3=new _e},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI},"_randinToAngle",function(){return this._randinToAngle=180*Math.PI}]),e}(g),Ie=function(t){function e(){this._destroyed=!1,this._id=0,this._cachedOwnerLayerMask=0,this._cachedOwnerActiveInHierarchy=!1,this._enable=!1,this._owner=null,this.started=!1,e.__super.call(this),this._destroyed=!1,this._id=e._uniqueIDCounter,e._uniqueIDCounter++}r(e,"laya.d3.component.Component3D",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IUpdate":!0,"laya.resource.IDestroy":!0}),n._onLayerChanged=function(t){this._cachedOwnerLayerMask=t.mask},n._onActiveHierarchyChanged=function(t){this._cachedOwnerActiveInHierarchy=t},n._initialize=function(t){this._owner=t,this.enable=!0,this.started=!1,this._cachedOwnerLayerMask=t.layer.mask,this._owner.on("layerchanged",this,this._onLayerChanged),this._cachedOwnerActiveInHierarchy=t.activeInHierarchy,this._owner.on("activeinhierarchychanged",this,this._onActiveHierarchyChanged),this._load(t)},n._destroy=function(){this._unload(this.owner),this._owner=null,this._destroyed=!0},n._load=function(t){},n._start=function(t){},n._update=function(t){},n._lateUpdate=function(t){},n._preRenderUpdate=function(t){},n._postRenderUpdate=function(t){},n._unload=function(t){this.offAll()},n._cloneTo=function(t){},a(0,n,"id",function(){return this._id}),a(0,n,"destroyed",function(){return this._destroyed}),a(0,n,"owner",function(){return this._owner}),a(0,n,"enable",function(){return this._enable},function(t){this._enable!==t&&(this._enable=t,this.event("enablechanged",this._enable))}),a(0,n,"isSingleton",function(){return e._isSingleton}),e._isSingleton=!0,e._uniqueIDCounter=1,e}(g),Pe=function(t){function e(){this._destroyed=!1,e.__super.call(this),this._destroyed=!1}r(e,"laya.d3.core.GeometryFilter",t);var n=e.prototype;return i.imps(n,{"laya.resource.IDestroy":!0}),n._destroy=function(){this.offAll(),this._destroyed=!0},a(0,n,"_isAsyncLoaded",function(){return!0}),a(0,n,"_originalBoundingBoxCorners",function(){throw new Error("BaseRender: must override it.")}),a(0,n,"_originalBoundingSphere",function(){throw new Error("BaseRender: must override it.")}),a(0,n,"_originalBoundingBox",function(){throw new Error("BaseRender: must override it.")}),a(0,n,"destroyed",function(){return this._destroyed}),e}(g),Le=function(t){function e(t){this._id=0,this._destroyed=!1,this._lightmapScaleOffset=null,this._lightmapIndex=0,this._enable=!1,this._receiveShadow=!1,this._boundingSphere=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphereNeedChange=!1,this._boundingBoxNeedChange=!1,this._boundingBoxCenterNeedChange=!1,this._octreeNodeNeedChange=!1,this._indexInSceneFrustumCullingObjects=0,this._materials=null,this._owner=null,this._renderElements=null,this._distanceForSort=NaN,this._treeNode=null,this._isPartOfStaticBatch=!1,this._staticBatchRootSprite3D=null,this._staticBatchRenderElements=null,this.sortingFudge=NaN,this.castShadow=!1,e.__super.call(this),this._id=++e._uniqueIDCounter,this._indexInSceneFrustumCullingObjects=-1,this._boundingBox=new Jt(new _e,new _e),this._boundingBoxCenter=new _e,this._boundingSphere=new ee(new _e,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._materials=[],this._renderElements=[],this._isPartOfStaticBatch=!1,this._destroyed=!1,this._owner=t,this._enable=!0,this.lightmapIndex=-1,this.castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange)}r(e,"laya.d3.core.render.BaseRender",t);var s=e.prototype;return i.imps(s,{"laya.resource.IDestroy":!0}),s._setShaderValuelightMap=function(t){this._setShaderValueTexture(3,t)},s._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},s._renderRenderableBoundBox=function(){var t=Ae._debugPhasorSprite,i=this.boundingBox,n=e._tempBoundBoxCorners;i.getCorners(n),t.line(n[0],e._greenColor,n[1],e._greenColor),t.line(n[2],e._greenColor,n[3],e._greenColor),t.line(n[4],e._greenColor,n[5],e._greenColor),t.line(n[6],e._greenColor,n[7],e._greenColor),t.line(n[0],e._greenColor,n[3],e._greenColor),t.line(n[1],e._greenColor,n[2],e._greenColor),t.line(n[2],e._greenColor,n[6],e._greenColor),t.line(n[3],e._greenColor,n[7],e._greenColor),t.line(n[0],e._greenColor,n[4],e._greenColor),t.line(n[1],e._greenColor,n[5],e._greenColor),t.line(n[4],e._greenColor,n[7],e._greenColor),t.line(n[5],e._greenColor,n[6],e._greenColor)},s._calculateBoundingSphere=function(){throw"BaseRender: must override it."},s._calculateBoundingBox=function(){throw"BaseRender: must override it."},s._setShaderValueTexture=function(t,e){this._owner._shaderValues.setValue(t,e?e.source:null)},s._setShaderValueMatrix4x4=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},s._setShaderValueColor=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},s._setShaderValueBuffer=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueInt=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueBool=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueNumber=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueVector2=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},s._addShaderDefine=function(t){this._owner._shaderDefineValue|=t},s._removeShaderDefine=function(t){this._owner._shaderDefineValue&=~t},s._renderUpdate=function(t){},s._applyLightMapParams=function(){if(this._lightmapIndex>=0){var t=this._owner.scene;if(t){var e=t.getlightmaps(),i=e[this._lightmapIndex];i?(this._addShaderDefine(4),i.loaded?this._setShaderValuelightMap(i):i.once("loaded",this,this._setShaderValuelightMap)):this._removeShaderDefine(4)}else this._removeShaderDefine(4)}else this._removeShaderDefine(4)},s._updateOctreeNode=function(){var t=this._treeNode;t&&this._octreeNodeNeedChange&&(t.updateObject(this),this._octreeNodeNeedChange=!1)},s._destroy=function(){this.offAll();for(var t=0,e=this._renderElements.length;e>t;t++)this._renderElements[t]._destroy();this._renderElements=null,this._owner=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._lightmapScaleOffset=null,this._destroyed=!0},a(0,s,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),a(0,s,"id",function(){return this._id}),a(0,s,"material",function(){var t=this._materials[0];if(t&&!t._isInstance){var e=new t.constructor;t.cloneTo(e),e.name=e.name+"(Instance)",e._isInstance=!0,this._materials[0]=e,this.event("materialchanged",[this,0,e])}return this._materials[0]},function(t){this._materials[0]=t,this.event("materialchanged",[this,0,t])}),a(0,s,"sharedMaterial",function(){return this._materials[0]},function(t){this._materials[0]=t,this.event("materialchanged",[this,0,t])}),a(0,s,"lightmapIndex",function(){return this._lightmapIndex},function(t){this._lightmapIndex=t,this._applyLightMapParams()}),a(0,s,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(t){this._lightmapScaleOffset=t,this._setShaderValueColor(2,t),this._addShaderDefine(2)}),a(0,s,"enable",function(){return this._enable},function(t){this._enable=t,this.event("enablechanged",[this,t])}),a(0,s,"materials",function(){for(var t=0,e=this._materials.length;e>t;t++){var i=this._materials[t];if(!i._isInstance){var n=new i.constructor;i.cloneTo(n),n.name=n.name+"(Instance)",n._isInstance=!0,this._materials[t]=n,this.event("materialchanged",[this,t,n])}}return this._materials.slice()},function(t){if(!t)throw new Error("MeshRender: materials value can't be null.");this._materials=t;for(var e=0,i=t.length;i>e;e++)this.event("materialchanged",[this,e,t[e]])}),a(0,s,"sharedMaterials",function(){var t=this._materials.slice();return t},function(t){if(!t)throw new Error("MeshRender: shadredMaterials value can't be null.");this._materials=t;for(var e=0,i=t.length;i>e;e++)this.event("materialchanged",[this,e,t[e]])}),a(0,s,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),a(0,s,"boundingBoxCenter",function(){if(this._boundingBoxCenterNeedChange){var t=this.boundingBox;_e.add(t.min,t.max,this._boundingBoxCenter),_e.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1}return this._boundingBoxCenter}),a(0,s,"receiveShadow",function(){return this._receiveShadow},function(t){this._receiveShadow!==t&&(this._receiveShadow=t,t?this._addShaderDefine(1):this._removeShaderDefine(1))}),a(0,s,"destroyed",function(){return this._destroyed}),e._uniqueIDCounter=0,n(e,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new _e,new _e,new _e,new _e,new _e,new _e,new _e,new _e]},"_greenColor",function(){return this._greenColor=new de(0,1,0,1)}]),e}(g),Ne=function(t){function e(t){this._owner=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._dummy=null,this.pivot=null,e.__super.call(this),this._localPosition=new _e,this._localRotation=new he(0,0,0,1),this._localScale=new _e(1,1,1),this._localRotationEuler=new _e,this._localMatrix=new ae,this._position=new _e,this._rotation=new he(0,0,0,1),this._scale=new _e(1,1,1),this._worldMatrix=new ae,this._forward=new _e,this._up=new _e,this._right=new _e,this._owner=t,this._childs=[]}r(e,"laya.d3.core.Transform3D",t);var i=e.prototype;return i._updateLocalMatrix=function(){if(!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z)ae.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix);else{var t=e._tempVector30;_e.multiply(this.pivot,this._localScale,t);var i=e._tempVector31;_e.subtract(t,this.pivot,i);var n=e._tempVector32,r=this.localRotation;_e.transformQuat(t,r,n),_e.subtract(n,t,n);var a=e._tempVector33;_e.subtract(this._localPosition,i,a),_e.subtract(a,n,a),ae.createAffineTransformation(a,r,this._localScale,this._localMatrix)}},i._onWorldPositionRotationTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._rotationUpdate){this._worldUpdate=this._positionUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldPositionRotationTransform()}},i._onWorldPositionScaleTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._scaleUpdate){this._worldUpdate=this._positionUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldPositionScaleTransform()}},i._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldPositionTransform()}},i._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldPositionRotationTransform()}},i._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldPositionScaleTransform()}},i._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._onWorldTransform()}},i.translate=function(t,i){void 0===i&&(i=!0),i?(ae.createFromQuaternion(this.localRotation,e._tempMatrix0),_e.transformCoordinate(t,e._tempMatrix0,e._tempVector30),_e.add(this.localPosition,e._tempVector30,this._localPosition),this.localPosition=this._localPosition):(_e.add(this.position,t,this._position),this.position=this._position)},i.rotate=function(t,i,n){void 0===i&&(i=!0),void 0===n&&(n=!0);var r;n?r=t:(_e.scale(t,Math.PI/180,e._tempVector30),r=e._tempVector30),he.createFromYawPitchRoll(r.y,r.x,r.z,e._tempQuaternion0),i?(he.multiply(this._localRotation,e._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(he.multiply(e._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},i.lookAt=function(t,e,i){void 0===i&&(i=!1);var n,r=t.elements;if(i){if(n=this._localPosition.elements,Math.abs(n[0]-r[0])<ne.zeroTolerance&&Math.abs(n[1]-r[1])<ne.zeroTolerance&&Math.abs(n[2]-r[2])<ne.zeroTolerance)return;he.lookAt(this._localPosition,t,e,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(n=a.elements,Math.abs(n[0]-r[0])<ne.zeroTolerance&&Math.abs(n[1]-r[1])<ne.zeroTolerance&&Math.abs(n[2]-r[2])<ne.zeroTolerance)return;he.lookAt(a,t,e,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}},a(0,i,"_isFrontFaceInvert",function(){var t=this.scale,e=t.x<0;return t.y<0&&(e=!e),t.z<0&&(e=!e),e}),a(0,i,"owner",function(){return this._owner}),a(0,i,"localRotation",function(){if(this._localQuaternionUpdate){var t=this._localRotationEuler.elements;he.createFromYawPitchRoll(t[1]/e._angleToRandin,t[0]/e._angleToRandin,t[2]/e._angleToRandin,this._localRotation)}return this._localRotation},function(t){this._localRotation=t,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),a(0,i,"worldMatrix",function(){return this._worldUpdate&&(null!=this._parent?ae.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix},function(t){null===this._parent?t.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),ae.multiply(this._localMatrix,t,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix=t,this._worldUpdate=!1}),a(0,i,"worldNeedUpdate",function(){return this._worldUpdate}),a(0,i,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(t){this._localMatrix=t,this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._localUpdate=!1,this._onWorldTransform()}),a(0,i,"dummy",function(){return this._dummy},function(t){this._dummy!==t&&(this._dummy&&(this._dummy._entity=null),t&&(t._entity=this),this._dummy=t)}),a(0,i,"localPosition",function(){return this._localPosition},function(t){this._localPosition=t,this._localUpdate=!0,this._onWorldPositionTransform()}),a(0,i,"position",function(){if(this._positionUpdate){if(null!=this._parent){var t=this._parent.position;_e.transformQuat(this._localPosition,this._parent.rotation,e._tempVector30),_e.multiply(e._tempVector30,this._parent.scale,e._tempVector30),_e.add(t,e._tempVector30,this._position)}else this._localPosition.cloneTo(this._position);this._positionUpdate=!1}return this._position},function(t){if(null!=this._parent){_e.subtract(t,this._parent.position,this._localPosition);var i=this._parent.rotation;i.invert(e._tempQuaternion0),_e.transformQuat(this._localPosition,e._tempQuaternion0,this._localPosition),
this.localPosition=this._localPosition}else t.cloneTo(this._localPosition),this.localPosition=this._localPosition;this._position=t,this._positionUpdate=!1}),a(0,i,"localScale",function(){return this._localScale},function(t){this._localScale=t,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldScaleTransform():this._onWorldPositionScaleTransform()}),a(0,i,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(e._tempVector30);var t=e._tempVector30.elements,i=this._localRotationEuler.elements;i[0]=t[1]/e._randinToAngle,i[1]=t[0]/e._randinToAngle,i[2]=t[2]/e._randinToAngle}return this._localRotationEuler},function(t){this._localRotationEuler=t,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),a(0,i,"rotation",function(){return this._rotationUpdate&&(null!=this._parent?he.multiply(this._parent.rotation,this._localRotation,this._rotation):this._localRotation.cloneTo(this._rotation),this._rotationUpdate=!1),this._rotation},function(t){null!=this._parent?(this._parent.rotation.invert(e._tempQuaternion0),he.multiply(t,e._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(t.cloneTo(this._localRotation),this.localRotation=this._localRotation),this._rotation=t,this._rotationUpdate=!1}),a(0,i,"scale",function(){return this._scaleUpdate?(null!==this._parent?_e.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1,this._scale):this._scale}),a(0,i,"rotationEuler",null,function(t){he.createFromYawPitchRoll(t.y,t.x,t.z,this._rotation),this.rotation=this._rotation}),a(0,i,"forward",function(){var t=this.worldMatrix.elements;return this._forward.elements[0]=-t[8],this._forward.elements[1]=-t[9],this._forward.elements[2]=-t[10],this._forward}),a(0,i,"up",function(){var t=this.worldMatrix.elements;return this._up.elements[0]=t[4],this._up.elements[1]=t[5],this._up.elements[2]=t[6],this._up}),a(0,i,"right",function(){var t=this.worldMatrix.elements;return this._right.elements[0]=t[0],this._right.elements[1]=t[1],this._right.elements[2]=t[2],this._right}),a(0,i,"parent",function(){return this._parent},function(t){if(this._parent!==t){if(this._parent){var e=this._parent._childs,i=e.indexOf(this);e.splice(i,1)}t&&(t._childs.push(this),t&&this._onWorldTransform()),this._parent=t}}),n(e,["_tempVector30",function(){return this._tempVector30=new _e},"_tempVector31",function(){return this._tempVector31=new _e},"_tempVector32",function(){return this._tempVector32=new _e},"_tempVector33",function(){return this._tempVector33=new _e},"_tempQuaternion0",function(){return this._tempQuaternion0=new he},"_tempMatrix0",function(){return this._tempMatrix0=new ae},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI},"_randinToAngle",function(){return this._randinToAngle=180*Math.PI}]),e}(g),Oe=(function(t){function e(){this._rotation=0,this._matNeedUpdte=!1,e.__super.call(this),this._matrix=new ae,this._offset=new ce,this._tiling=new ce(1,1)}r(e,"laya.d3.core.TransformUV",t);var s=e.prototype;return i.imps(s,{"laya.d3.core.IClone":!0}),s._updateMatrix=function(){e._tempOffsetV3.elements[0]=this._offset.x,e._tempOffsetV3.elements[1]=this._offset.y,he.createFromYawPitchRoll(0,0,this._rotation,e._tempRotationQua),e._tempTitlingV3.elements[0]=this._tiling.x,e._tempTitlingV3.elements[1]=this._tiling.y,ae.createAffineTransformation(e._tempOffsetV3,e._tempRotationQua,e._tempTitlingV3,this._matrix)},s.cloneTo=function(t){t._matrix=this._matrix.clone(),t._offset=this._offset.clone(),t._rotation=this._rotation,t._tiling=this._tiling.clone()},s.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,s,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),a(0,s,"tiling",function(){return this._tiling},function(t){this._tiling=t,this._matNeedUpdte=!0}),a(0,s,"offset",function(){return this._offset},function(t){this._offset=t,this._matNeedUpdte=!0}),a(0,s,"rotation",function(){return this._rotation},function(t){this._rotation=t,this._matNeedUpdte=!0}),n(e,["_tempOffsetV3",function(){return this._tempOffsetV3=new _e(0,0,0)},"_tempRotationQua",function(){return this._tempRotationQua=new he},"_tempTitlingV3",function(){return this._tempTitlingV3=new _e(1,1,1)}]),e}(g),function(t){function e(){e.__super.call(this)}r(e,"laya.d3.core.glitter.SplineCurvePosition",t);var i=e.prototype;return i._CalcVelocity=function(t,e,i){_e.subtract(t,e,i),_e.scale(i,.5,i)},i.Init=function(e,i,n,r){this._CalcVelocity(i,e,this._tempVector30),this._CalcVelocity(r,n,this._tempVector31),t.prototype.Init.call(this,i,this._tempVector30,r,this._tempVector31)},e}(B),function(t){function e(){this.x=NaN,this.y=NaN,this.z=NaN,e.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.BoxShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=.5*-this.x,e[1]=.5*-this.y,e[2]=.5*-this.z;var i=t.max.elements;i[0]=.5*this.x,i[1]=.5*this.y,i[2]=.5*this.z},i._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=0,e[1]=0,e[2]=0;var i=t.max.elements;i[0]=0,i[1]=1,i[2]=0},i.generatePositionAndDirection=function(t,e,i,n){var r=t.elements,a=e.elements;i?(i.seed=n[16],tt._randomPointInsideHalfUnitBox(t,i),n[16]=i.seed):tt._randomPointInsideHalfUnitBox(t),r[0]=this.x*r[0],r[1]=this.y*r[1],r[2]=this.z*r[2],this.randomDirection?i?(i.seed=n[17],tt._randomPointUnitSphere(e,i),n[17]=i.seed):tt._randomPointUnitSphere(e):(a[0]=0,a[1]=0,a[2]=1)},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.x=this.x,i.y=this.y,i.z=this.z,i.randomDirection=this.randomDirection},e}(J)),Ve=function(t){function e(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,e.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.CircleShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[2]=-this.radius,e[1]=0;var i=t.max.elements;i[0]=i[2]=this.radius,i[1]=0},i._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=-1,e[2]=0;var i=t.max.elements;i[0]=i[1]=1,i[2]=0},i.generatePositionAndDirection=function(t,i,n,r){var a=t.elements,s=e._tempPositionPoint.elements;n?(n.seed=r[16],this.emitFromEdge?tt._randomPointUnitArcCircle(this.arc,e._tempPositionPoint,n):tt._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint,n),r[16]=n.seed):this.emitFromEdge?tt._randomPointUnitArcCircle(this.arc,e._tempPositionPoint):tt._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint),a[0]=-s[0],a[1]=s[1],a[2]=0,_e.scale(t,this.radius,t),this.randomDirection?n?(n.seed=r[17],tt._randomPointUnitSphere(i,n),r[17]=n.seed):tt._randomPointUnitSphere(i):t.cloneTo(i)},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.radius=this.radius,i.arc=this.arc,i.emitFromEdge=this.emitFromEdge,i.randomDirection=this.randomDirection},n(e,["_tempPositionPoint",function(){return this._tempPositionPoint=new ce}]),e}(J),Fe=function(t){function e(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,e.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.ConeShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=this.radius+this.length*Math.sin(this.angle),i=this.length*Math.cos(this.angle),n=t.min.elements;n[0]=n[1]=-e,n[2]=0;var r=t.max.elements;r[0]=r[1]=e,r[2]=i},i._getSpeedBoundBox=function(t){var e=Math.sin(this.angle),i=t.min.elements;i[0]=i[1]=-e,i[2]=0;var n=t.max.elements;n[0]=i[1]=e,n[2]=1},i.generatePositionAndDirection=function(t,i,n,r){var a,s=t.elements,o=i.elements,h=e._tempPositionPoint.elements,l=NaN,u=NaN,c=Math.cos(this.angle),_=Math.sin(this.angle);switch(this.emitType){case 0:n?(n.seed=r[16],tt._randomPointInsideUnitCircle(e._tempPositionPoint,n),r[16]=n.seed):tt._randomPointInsideUnitCircle(e._tempPositionPoint),l=h[0],u=h[1],s[0]=l*this.radius,s[1]=u*this.radius,s[2]=0,this.randomDirection?(n?(n.seed=r[17],tt._randomPointInsideUnitCircle(e._tempDirectionPoint,n),r[17]=n.seed):tt._randomPointInsideUnitCircle(e._tempDirectionPoint),a=e._tempDirectionPoint.elements,o[0]=a[0]*_,o[1]=a[1]*_):(o[0]=l*_,o[1]=u*_),o[2]=c;break;case 1:n?(n.seed=r[16],tt._randomPointUnitCircle(e._tempPositionPoint,n),r[16]=n.seed):tt._randomPointUnitCircle(e._tempPositionPoint),l=h[0],u=h[1],s[0]=l*this.radius,s[1]=u*this.radius,s[2]=0,this.randomDirection?(n?(n.seed=r[17],tt._randomPointInsideUnitCircle(e._tempDirectionPoint,n),r[17]=n.seed):tt._randomPointInsideUnitCircle(e._tempDirectionPoint),a=e._tempDirectionPoint.elements,o[0]=a[0]*_,o[1]=a[1]*_):(o[0]=l*_,o[1]=u*_),o[2]=c;break;case 2:n?(n.seed=r[16],tt._randomPointInsideUnitCircle(e._tempPositionPoint,n)):tt._randomPointInsideUnitCircle(e._tempPositionPoint),l=h[0],u=h[1],s[0]=l*this.radius,s[1]=u*this.radius,s[2]=0,o[0]=l*_,o[1]=u*_,o[2]=c,_e.normalize(i,i),n?(_e.scale(i,this.length*n.getFloat(),i),r[16]=n.seed):_e.scale(i,this.length*Math.random(),i),_e.add(t,i,t),this.randomDirection&&(n?(n.seed=r[17],tt._randomPointUnitSphere(i,n),r[17]=n.seed):tt._randomPointUnitSphere(i));break;case 3:n?(n.seed=r[16],tt._randomPointUnitCircle(e._tempPositionPoint,n)):tt._randomPointUnitCircle(e._tempPositionPoint),l=h[0],u=h[1],s[0]=l*this.radius,s[1]=u*this.radius,s[2]=0,o[0]=l*_,o[1]=u*_,o[2]=c,_e.normalize(i,i),n?(_e.scale(i,this.length*n.getFloat(),i),r[16]=n.seed):_e.scale(i,this.length*Math.random(),i),_e.add(t,i,t),this.randomDirection&&(n?(n.seed=r[17],tt._randomPointUnitSphere(i,n),r[17]=n.seed):tt._randomPointUnitSphere(i));break;default:throw new Error("ConeShape:emitType is invalid.")}},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.angle=this.angle,i.radius=this.radius,i.length=this.length,i.emitType=this.emitType,i.randomDirection=this.randomDirection},n(e,["_tempPositionPoint",function(){return this._tempPositionPoint=new ce},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new ce}]),e}(J),Be=function(t){function e(){this.radius=NaN,this.emitFromShell=!1,e.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-this.radius;var i=t.max.elements;i[0]=i[1]=this.radius,i[2]=0},i._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=-1,e[2]=0;var i=t.max.elements;i[0]=i[1]=i[2]=1},i.generatePositionAndDirection=function(t,e,i,n){var r=t.elements;i?(i.seed=n[16],this.emitFromShell?tt._randomPointUnitSphere(t,i):tt._randomPointInsideUnitSphere(t,i),n[16]=i.seed):this.emitFromShell?tt._randomPointUnitSphere(t):tt._randomPointInsideUnitSphere(t),_e.scale(t,this.radius,t);var a=r[2];0>a&&(r[2]=-1*a),this.randomDirection?i?(i.seed=n[17],tt._randomPointUnitSphere(e,i),n[17]=i.seed):tt._randomPointUnitSphere(e):t.cloneTo(e)},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.radius=this.radius,i.emitFromShell=this.emitFromShell,i.randomDirection=this.randomDirection},e}(J),Ue=function(t){function e(){this.radius=NaN,this.emitFromShell=!1,e.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.SphereShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-this.radius;var i=t.max.elements;i[0]=i[1]=i[2]=this.radius},i._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-1;var i=t.max.elements;i[0]=i[1]=i[2]=1},i.generatePositionAndDirection=function(t,e,i,n){i?(i.seed=n[16],this.emitFromShell?tt._randomPointUnitSphere(t,i):tt._randomPointInsideUnitSphere(t,i),n[16]=i.seed):this.emitFromShell?tt._randomPointUnitSphere(t):tt._randomPointInsideUnitSphere(t),_e.scale(t,this.radius,t),this.randomDirection?i?(i.seed=n[17],tt._randomPointUnitSphere(e,i),n[17]=i.seed):tt._randomPointUnitSphere(e):t.cloneTo(e)},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.radius=this.radius,i.emitFromShell=this.emitFromShell,i.randomDirection=this.randomDirection},e}(J),ke=function(t){function e(){this._batchIndexStart=0,this._batchIndexEnd=0,this._skinAnimationDatas=null,e.__super.call(this)}return r(e,"laya.d3.core.render.SubMeshRenderElement",t),e}(ot),He=function(t){function e(){e.__super.call(this)}r(e,"laya.d3.graphics.MeshSprite3DStaticBatchManager",t);var i=e.prototype;return i._getStaticBatch=function(t,e,i,n){var r,a;return a=t?t.id.toString()+i.id.toString()+e.id.toString()+n.toString():i.id.toString()+e.id.toString()+n.toString(),this._staticBatches[a]?r=this._staticBatches[a]:this._staticBatches[a]=r=new ze(a,this,t,e,i),r},i._initStaticBatchs=function(t){this._initBatchRenderElements.sort(e._sortPrepareStaticBatch);for(var i,n,r,a=!1,s=0,o=0,h=this._initBatchRenderElements.length;h>o;o++){var l=this._initBatchRenderElements[o],u=l.renderObj._getVertexBuffer(0);l._sprite3D;if(n===u.vertexDeclaration&&i===l._material){var c;if(a)r._addCombineBatchRenderObjTest(l)?(c=l._staticBatch,c&&c!==r&&c._deleteCombineBatchRenderObj(l),r._addCombineBatchRenderObj(l)):(a=!1,s++);else{var _=this._initBatchRenderElements[o-1],d=_.renderObj,f=l.renderObj;d._getVertexBuffer().vertexCount+f._getVertexBuffer().vertexCount>65535?a=!1:(r=this._getStaticBatch(t,n,i,s),c=_._staticBatch,c&&c!==r&&c._deleteCombineBatchRenderObj(_),r._addCombineBatchRenderObj(_),c=l._staticBatch,c&&c!==r&&c._deleteCombineBatchRenderObj(l),r._addCombineBatchRenderObj(l),a=!0)}}else a=!1,s=0;i=l._material,n=u.vertexDeclaration}},e._sortPrepareStaticBatch=function(t,e){var i=t._render,n=e._render,r=i.lightmapIndex-n.lightmapIndex;if(0===r){var a=i.receiveShadow-n.receiveShadow;if(0===a){var s=t._mainSortID-e._mainSortID;return 0===s?t.renderObj.triangleCount-e.renderObj.triangleCount:s}return a}return r},e}(ft),ze=function(t){function e(t,i,n,r,a){this._batchOwnerIndices=null,this._batchOwners=null,this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=null,this._vertexBuffer=null,this._indexBuffer=null,e.__super.call(this,t,i,n),this._batchOwnerIndices=[],this._batchOwners=[],this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=r,this._material=a}r(e,"laya.d3.graphics.SubMeshStaticBatch",t);var i=e.prototype;return i._compareBatchRenderElement=function(t,e){return t._batchIndexStart>e._batchIndexStart},i._addCombineBatchRenderObjTest=function(t){var e=0,i=t.renderObj._vertexCount;return e=i>0?this._currentCombineVertexCount+i:this._currentCombineVertexCount+t.renderObj._getVertexBuffer().vertexCount,e>65535?!1:!0},i._addCombineBatchRenderObj=function(t){var e=t.renderObj,i=e._vertexCount;this._initBatchRenderElements.push(t),t._staticBatch=this,i>0?(this._currentCombineIndexCount+=e._indexCount,this._currentCombineVertexCount+=i):(this._currentCombineIndexCount=this._currentCombineIndexCount+e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+e._getVertexBuffer().vertexCount),this._needFinishCombine=!0},i._deleteCombineBatchRenderObj=function(t){var e=t.renderObj,i=this._initBatchRenderElements.indexOf(t);if(-1!==i){this._initBatchRenderElements.splice(i,1),t._staticBatch=null;var n=e._vertexCount;n>0?(this._currentCombineIndexCount=this._currentCombineIndexCount-e._indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-n):(this._currentCombineIndexCount=this._currentCombineIndexCount-e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-e._getVertexBuffer().vertexCount),this._needFinishCombine=!0}},i._finshInit=function(){if(this._needFinishCombine){var t=0,e=0;this._initBatchRenderElements[0]._sprite3D._render.lightmapIndex>=0?this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration):this._material instanceof laya.d3.core.material.StandardMaterial&&this._material.ambientTexture&&(this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration));var i=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount),n=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose()),this._vertexBuffer=Si.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=vi.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._initBatchRenderElements.length;a>r;r++){var s=this._initBatchRenderElements[r],o=s.renderObj,h=o._getStaticBatchBakedVertexs(this._rootOwner?this._rootOwner._transform:null,s._sprite3D),l=o.getIndices(),u=s._sprite3D.transform._isFrontFaceInvert,c=t/(this._vertexDeclaration.vertexStride/4)-o._vertexStart,_=e,d=_+l.length;s._batchIndexStart=_,s._batchIndexEnd=d,n.set(l,e);var f=0;if(u)for(f=_;d>f;f+=3){n[f]=c+n[f];var p=n[f+1],m=n[f+2];n[f+1]=c+m,n[f+2]=c+p}else for(f=_;d>f;f+=3)n[f]=c+n[f],n[f+1]=c+n[f+1],n[f+2]=c+n[f+2];e+=l.length,i.set(h,t),t+=h.length}this._vertexBuffer.setData(i),this._indexBuffer.setData(n),this._needFinishCombine=!1}},i._getCombineRenderElementFromPool=function(){var t=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return t||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new ke)},i._getRenderElement=function(t,e,i){for(var n,r,a=this._batchRenderElements.length,s=!0,o=0;a>o;o++){r=this._batchRenderElements[o];var h,l=r._sprite3D._render;0!==o&&(n=this._batchRenderElements[o-1],h=n._sprite3D._render,s=h.lightmapIndex!==l.lightmapIndex||h.receiveShadow!==l.receiveShadow||n._batchIndexEnd!==r._batchIndexStart);var u;if(s){u=this._getCombineRenderElementFromPool(),u.renderObj=this,u._material=this._material,u._batchIndexStart=r._batchIndexStart,u._batchIndexEnd=r._batchIndexEnd;var c=l.lightmapIndex,_=c+1,d=this._batchOwnerIndices[_];d||(d=this._batchOwnerIndices[_]=[]);var f,p=d[r._render.receiveShadow?1:0];void 0===p?(d[l.receiveShadow?1:0]=this._batchOwners.length,f=new Vi(null,"StaticBatchMeshSprite3D"),f._scene=e,f._transform=this._rootOwner?this._rootOwner._transform:null,f._render.lightmapIndex=c,f._render.receiveShadow=r._render.receiveShadow,this._batchOwners.push(f)):f=this._batchOwners[p],f._render._renderUpdate(i),u._sprite3D=f,t.push(u)}else u._batchIndexEnd=r._batchIndexEnd}},i._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},i._render=function(t){var e=t.renderElement,i=e._batchIndexStart,n=e._batchIndexEnd-i;P.mainContext.drawElements(4,n,5123,2*i),D.drawCall++,D.trianglesFaces+=n/3},i.dispose=function(){this._batchOwnerIndices=null,this._batchOwners=null,this._vertexDeclaration=null,this._vertexBuffer.dispose(),this._indexBuffer.dispose()},i._getVertexBuffer=function(t){return void 0===t&&(t=0),this._vertexBuffer},e}(pt),We=function(t){function e(t){e.__super.call(this),this.__loaded=!0,this._projectionViewWorldUpdateLoopCount=-1,this._projectionViewWorldMatrix=new ae,this._shaderValues=new ye,this._colliders=[],this._componentsMap=[],this._typeComponentsIndices=[],this._components=[],this._belongScene=!1,t?this.name=t:this.name="Sprite3D-"+e._nameNumberCounter++,this._activeInHierarchy=!1,this._id=++e._uniqueIDCounter,this.layer=k.currentCreationLayer,this._transform=new Ne(this),this.active=!0}r(e,"laya.d3.core.Sprite3D",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IUpdate":!0,"laya.resource.ICreateResource":!0,"laya.d3.core.IClone":!0}),n._setBelongAnimator=function(t){if(this._belongAnimator=t,t){var e=t.avatar,i=t._avatarNodes;if(i)for(var n=0,r=i.length;r>n;n++){var a=i[n];a.name!==this.name||this._transform.dummy||this._associateSpriteToAnimationNode(e,a)}}},n._associateSpriteToAnimationNode=function(t,e){this._transform.dummy=e._transform;var i=this._belongAnimator._avatarNodes.indexOf(e),n=this._belongAnimator._cacheSpriteToNodesMap;this._belongAnimator._cacheNodesToSpriteMap[i]=n.length,n.push(i)},n._setAnimator=function(t,e){this._setBelongAnimator(t);for(var i=0,n=this._childs.length;n>i;i++){var r=this._childs[i];r._belongAnimator==e&&r._setAnimator(t,e)}},n._clearAnimator=function(t,e){this._setBelongAnimator(e);for(var i=0,n=this._childs.length;n>i;i++){var r=this._childs[i];r._belongAnimator==t&&r._clearAnimator(t,e)}},n._setBelongScene=function(t){this._scene=t,this._belongScene=!0;for(var e=0,i=this._childs.length;i>e;e++)this._childs[e]._setBelongScene(t)},n._setUnBelongScene=function(){this._scene=null,this._belongScene=!1;for(var t=0,e=this._childs.length;e>t;t++)this._childs[t]._setUnBelongScene()},n._activeHierarchy=function(){this._activeInHierarchy=!0,this._addSelfRenderObjects(),this.event("activeinhierarchychanged",!0);for(var t=0,e=this._childs.length;e>t;t++){var i=this._childs[t];i._active&&i._activeHierarchy()}},n._inActiveHierarchy=function(){this._activeInHierarchy=!1,this._clearSelfRenderObjects(),this.event("activeinhierarchychanged",!1);for(var t=0,e=this._childs.length;e>t;t++){var i=this._childs[t];i._active&&i._inActiveHierarchy()}},n._removeComponent=function(t,e){var i=this._typeComponentsIndices[t],n=i[e],r=this._components[n];if(r instanceof laya.d3.component.physics.Collider){var a=r,s=this._layer._colliders;s.splice(s.indexOf(a),1),this._colliders.splice(this._colliders.indexOf(a),1)}else if(r instanceof laya.d3.component.Animator){var o=r;this._clearAnimator(o,this._parent?this._parent._belongAnimator:null)}this._components.splice(n,1),i.splice(e,1),0===i.length&&(this._typeComponentsIndices.splice(t,1),this._componentsMap.splice(t,1));for(var h=0,l=this._componentsMap.length;l>h;h++){i=this._typeComponentsIndices[h];for(var u=i.length-1;u>=0;u--){var c=i[u];if(!(c>n))break;i[u]=--c}}r._destroy(),this.event("componentremoved",r)},n.createConchModel=function(){return null},n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._updateComponents=function(t){for(var e=0,i=this._components.length;i>e;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._update(t)}},n._lateUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._lateUpdate(t)}},n._parseCustomProps=function(t,e,i){var n=e.translate,r=this.transform.localPosition,a=r.elements;a[0]=n[0],a[1]=n[1],a[2]=n[2],this.transform.localPosition=r;var s=e.rotation,o=this.transform.localRotation,h=o.elements;h[0]=s[0],h[1]=s[1],h[2]=s[2],h[3]=s[3],this.transform.localRotation=o;var l=e.scale,u=this.transform.localScale,c=u.elements;c[0]=l[0],c[1]=l[1],c[2]=l[2],this.transform.localScale=u;var _=i.components;for(var d in _){var f=_[d];switch(d){case"Animator":var p=this.addComponent(Je);p.avatar=x.getRes(t[f.avatarPath]);for(var m=f.clipPaths,g=m.length,y=0;g>y;y++)p.addClip(x.getRes(t[m[y]]));p.clip=x.getRes(t[m[0]]);var v=f.entryPlayIndex;v>=0&&p.play(x.getRes(t[m[v]]).name)}}},n._updateChilds=function(t){var e=this._childs.length;if(0!==e)for(var i=0;e>i;++i)this._childs[i]._update(t)},n._updateChildsConch=function(t){var e=this._childs.length;if(0!==e)for(var i=0;e>i;++i)this._childs[i]._update(t)},n._getSortID=function(t,e){return 1e3*e.id+t._getVertexBuffer().vertexDeclaration.id},n._update=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._lateUpdateComponents(t),D.spriteCount++,this._childs.length&&this._updateChilds(t))},n._updateConch=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._lateUpdateComponents(t),D.spriteCount++,this._childs.length&&this._updateChilds(t))},n.getProjectionViewWorldMatrix=function(t){return ae.multiply(t,this.transform.worldMatrix,this._projectionViewWorldMatrix),this._projectionViewWorldMatrix},n.loadHierarchy=function(t){this.addChild(laya.d3.core.Sprite3D.load(t))},n.addChildAt=function(t,e){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),e>=0&&e<=this._childs.length){if(t._parent===this){var i=this.getChildIndex(t);this._childs.splice(i,1),this._childs.splice(e,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,e)),this._childChanged()}else{t.parent&&t.parent.removeChild(t),this._childs===T.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(e,0,t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,e),t.parent=this;var n=t;n.transform.parent=this.transform,this._belongAnimator&&!n._belongAnimator&&n._setAnimator(this._belongAnimator,null),this._belongScene&&(n._setBelongScene(this._scene),this._activeInHierarchy&&n._active&&n._activeHierarchy())}return t}throw new Error("appendChildAt:The index is out of bounds")},n.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),t._parent===this){var e=this.getChildIndex(t);e!==this._childs.length-1&&(this._childs.splice(e,1),this._childs.push(t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,this._childs.length-1)),this._childChanged())}else{t.parent&&t.parent.removeChild(t),this._childs===T.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,this._childs.length-1),t.parent=this,this._childChanged();var i=t;i.transform.parent=this.transform,this._belongAnimator&&!i._belongAnimator&&i._setAnimator(this._belongAnimator,null),this._belongScene&&(i._setBelongScene(this._scene),this._activeInHierarchy&&i._active&&i._activeHierarchy())}return t},n.removeChildAt=function(t){var e=this.getChildAt(t);if(e){var i=e;i.transform.parent=null,this._belongScene&&(this._activeInHierarchy&&i._active&&i._inActiveHierarchy(),i._setUnBelongScene()),this._belongAnimator&&i._belongAnimator==this._belongAnimator&&i._clearAnimator(this._belongAnimator,null),this._childs.splice(t,1),this.conchModel&&this.conchModel.removeChild(e.conchModel),e.parent=null}return e},n.removeChildren=function(t,e){if(void 0===t&&(t=0),void 0===e&&(e=2147483647),this._childs&&this._childs.length>0){var i=this._childs;if(0===t&&e>=a){var n=i;this._childs=T.ARRAY_EMPTY}else n=i.splice(t,e-t);for(var r=0,a=n.length;a>r;r++){n[r].parent=null;var s=n[r];s.transform.parent=null,this._belongScene&&(this._activeInHierarchy&&s._active&&s._inActiveHierarchy(),s._setUnBelongScene()),this._belongAnimator&&s._belongAnimator==this._belongAnimator&&s._clearAnimator(this._belongAnimator,null),this.conchModel&&this.conchModel.removeChild(n[r].conchModel)}}return this},n.addComponent=function(t){var e,i=this._componentsMap.indexOf(t);if(-1===i)e=[],this._componentsMap.push(t),this._typeComponentsIndices.push(e);else if(e=this._typeComponentsIndices[i],this._components[e[0]].isSingleton)throw new Error("无法单实例创建"+t+"组件，"+t+"组件已存在！");var n=p.getInstance(t);if(e.push(this._components.length),this._components.push(n),n instanceof laya.d3.component.physics.Collider)this._layer._colliders.push(n),this._colliders.push(n);else if(n instanceof laya.d3.component.Animator){var r=n;this._setAnimator(r,this._parent?this._parent._belongAnimator:null)}return n._initialize(this),this.event("componentadded",n),n},n.getComponentByType=function(t,e){void 0===e&&(e=0);var i=this._componentsMap.indexOf(t);return-1===i?null:this._components[this._typeComponentsIndices[i][e]]},n.getComponentsByType=function(t,e){var i=this._componentsMap.indexOf(t);if(-1===i)return void(e.length=0);var n=this._typeComponentsIndices[i],r=n.length;e.length=r;for(var a=0;r>a;a++)e[a]=this._components[n[a]]},n.getComponentByIndex=function(t){return this._components[t]},n.removeComponentByType=function(t,e){void 0===e&&(e=0);var i=this._componentsMap.indexOf(t);-1!==i&&this._removeComponent(i,e)},n.removeComponentsByType=function(t){var e=this._componentsMap.indexOf(t);if(-1!==e)for(var i=this._typeComponentsIndices[e],n=0,r=i.length;r>n;i.length<r?r--:n++)this._removeComponent(e,n)},n.removeAllComponent=function(){for(var t=0,e=this._componentsMap.length;e>t;this._componentsMap.length<e?e--:t++)this.removeComponentsByType(this._componentsMap[t])},n.onAsynLoaded=function(t,e,i){if(!this.destroyed){var n=JSON.parse(e[0]);if("Sprite3D"!==n.type)throw new Error("Sprite3D: The .lh file root type must be Sprite3D,please use other function to  load  this file.");var r=e[1];De._createNodeByJson(n,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0}},n.cloneTo=function(t){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Spriote3D has destroyed.");var e=t;e.name=this.name,e.destroyed=this.destroyed,e.timer=this.timer,e._$P=this._$P,e.active=this._active;var i=e.transform.localPosition;this.transform.localPosition.cloneTo(i),e.transform.localPosition=i;var n=e.transform.localRotation;this.transform.localRotation.cloneTo(n),e.transform.localRotation=n;var r=e.transform.localScale;this.transform.localScale.cloneTo(r),e.transform.localScale=r,e.isStatic=this.isStatic;var a=0,s=0;for(a=0,s=this._componentsMap.length;s>a;a++){var o=e.addComponent(this._componentsMap[a]);this._components[a]._cloneTo(o)}for(a=0,s=this._childs.length;s>a;a++)e.addChild(this._childs[a].clone())},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e);var i=0,n=0;for(i=0,n=this._components.length;n>i;i++)this._components[i]._destroy();this._components=null,this._componentsMap=null,this._typeComponentsIndices=null,this._transform=null;var r=this._layer._colliders;for(i=0,n=this._colliders.length;n>i;i++)r.splice(r.indexOf(this._colliders[i]),1);this._colliders=null,x.clearRes(this.url)},a(0,n,"componentsCount",function(){return this._typeComponentsIndices.length}),a(0,n,"loaded",function(){return this.__loaded}),a(0,n,"id",function(){return this._id}),a(0,n,"url",function(){return this._url},function(t){this._url=t}),a(0,n,"layer",function(){return this._layer},function(t){if(!t)throw new Error("Layer value can be null.");var e=0,i=this._colliders.length;if(this._layer){var n=this._layer._colliders;for(e=0;i>e;e++)n.splice(n.indexOf(this._colliders[e]),1)}var r=t._colliders;for(e=0;i>e;e++)r.push(this._colliders[e]);this._layer=t,this.event("layerchanged",t)}),a(0,n,"belongScene",function(){return this._belongScene}),a(0,n,"activeInHierarchy",function(){return this._activeInHierarchy}),a(0,n,"_loaded",null,function(t){this.__loaded=t}),a(0,n,"active",function(){return this._active},function(t){this._active!==t&&(this._active=t,this._belongScene&&(t?this._activeHierarchy():this._inActiveHierarchy()))}),a(0,n,"scene",function(){return this._scene}),a(0,n,"transform",function(){return this._transform}),e.instantiate=function(t,e,i,n,r){void 0===i&&(i=!0);var a=t.clone();e&&e.addChild(a);var s=a.transform;if(i){var o=s.worldMatrix;t.transform.worldMatrix.cloneTo(o),s.worldMatrix=o}else n&&(s.position=n),r&&(s.rotation=r);return a},e.load=function(t){return i.loader.create(t,null,null,e)},e.WORLDMATRIX=0,e.MVPMATRIX=1,e._uniqueIDCounter=0,e._nameNumberCounter=0,e}(T),Ge=function(t){function e(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._nodes=null,this._rootTransformNodes=null,this._cachePropertyToNodeMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyToNodeMap=null,this._duration=NaN,
this._frameRate=0,this.islooping=!1,e.__super.call(this),this._fullKeyframeIndicesCache={},this._animationDatasCache=[],this._avatarDatasCache=[],this._skinnedDatasCache=[]}r(e,"laya.d3.animation.AnimationClip",t);var n=e.prototype;return n._hermiteInterpolate=function(t,e,i,n){for(var r=t.data,a=t.outTangent,s=t.next,o=s.data,h=s.inTangent,l=!1,u=NaN,c=NaN,_=NaN,d=NaN,f=0,p=n.length;p>f;f++){var m=a[f],g=h[f];if(Number.isFinite(m)&&Number.isFinite(g)){if(!l){var y=e*e,x=y*e;u=2*x-3*y+1,c=x-2*y+e,_=x-y,d=-2*x+3*y,l=!0}n[f]=u*r[f]+c*m*i+_*g*i+d*o[f]}else n[f]=r[f]}},n._getFullKeyframeIndicesWithCache=function(t){return this._fullKeyframeIndicesCache[t]},n._cacheFullKeyframeIndices=function(t,e){this._fullKeyframeIndicesCache[t]=e},n._getAnimationDataWithCache=function(t,e){var i=this._animationDatasCache[t];return i?i[e]:null},n._cacheAnimationData=function(t,e,i){var n=this._animationDatasCache[t]||(this._animationDatasCache[t]=[]);n[e]=i},n._getAvatarDataWithCache=function(t,e,i){var n=this._avatarDatasCache[t.id];if(n){var r=n[e];return r?r[i]:null}return null},n._cacheAvatarData=function(t,e,i,n){var r=this._avatarDatasCache[t.id]||(this._avatarDatasCache[t.id]=[]),a=r[e]||(r[e]=[]);a[i]=n},n._getSkinnedDatasWithCache=function(t,e,i,n){var r=this._skinnedDatasCache[t.id];if(r){var a=r[e.id];if(a){var s=a[i];return s?s[n]:null}return null}return null},n._cacheSkinnedDatasWithCache=function(t,e,i,n,r){var a=this._skinnedDatasCache[t.id]||(this._skinnedDatasCache[t.id]=[]),s=a[e.id]||(a[e.id]=[]),o=s[i]||(s[i]=[]);o[n]=r},n._evaluateAnimationlDatasCacheFrame=function(t,e,i,n,r,a){for(var s=0,o=0,h=0,l=this._nodes.length;l>h;h++){var u=this._nodes[h],c=u._cacheProperty;if(a[h]&&(!c||r)){var _,d=t[h],f=d[e.currentFrameIndex],p=0;if(-1!==f){var m=u.keyFrames[f],g=m.next;if(g){c?(_=new Float32Array(u.keyFrameWidth),r[this._nodeToCachePropertyMap[h]]=_):_=n[h];var y=NaN,x=m.duration;y=0!==x?(e.currentFrameTime-m.startTime)/x:0,this._hermiteInterpolate(m,y,x,_)}else{if(c){if(p=e._lastFrameIndex,-1!==p&&d[p]===f)continue;_=new Float32Array(u.keyFrameWidth),r[this._nodeToCachePropertyMap[h]]=_}else _=n[h];var v=m.data;for(s=0,o=_.length;o>s;s++)_[s]=v[s]}}else{if(c){if(p=e._lastFrameIndex,-1!==p&&d[p]===f)continue;_=new Float32Array(u.keyFrameWidth),r[this._nodeToCachePropertyMap[h]]=_}else _=n[h];var S=u.keyFrames[0].data;for(s=0,o=_.length;o>s;s++)_[s]=S[s]}}}},n._evaluateAnimationlDatasRealTime=function(t,e){var i=0,n=0,r=this._nodes;if(!this._realTimeCurrentFrameIndexes){for(this._realTimeCurrentFrameIndexes=new Int32Array(r.length),i=0,n=r.length;n>i;i++)this._realTimeCurrentFrameIndexes[i]=-1;this._realTimeCurrentTimes=new Float32Array(r.length)}for(i=0,n=r.length;n>i;i++){var a=r[i];t<this._realTimeCurrentTimes[i]&&(this._realTimeCurrentFrameIndexes[i]=-1),this._realTimeCurrentTimes[i]=t;for(var s=this._realTimeCurrentFrameIndexes[i]+1,o=a.keyFrames,h=o.length;h>s;){if(o[s].startTime>t){this._realTimeCurrentFrameIndexes[i]=s-1;break}s++}s===h&&(this._realTimeCurrentFrameIndexes[i]=h-1);var l=o[this._realTimeCurrentFrameIndexes[i]];if(l){var u=e[i],c=l.next;if(c){var _=l.duration,d=NaN;d=0!==_?(t-l.startTime)/_:0,this._hermiteInterpolate(l,d,_,u)}}else u=null}},n.onAsynLoaded=function(t,e,i){var n=new f(e),r=n.readUTFString();switch(r){case"LAYAANIMATION:01":N.parse(this,n)}this._endLoaded()},e.load=function(t){return i.loader.create(t,null,null,e)},e}(b),je=function(t){function e(){e.__super.call(this)}r(e,"laya.d3.core.Avatar",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.IClone":!0}),n._initCloneAvatar=function(t,e){e._nodeMap[t.name]=t,e._nodes.push(t);for(var i=0,n=t.getChildCount();n>i;i++)this._initCloneAvatar(t.getChildByIndex(i),e)},n._initCloneToAnimator=function(t,e){e._avatarNodeMap[t.name]=t,e._avatarNodes.push(t);for(var i=0,n=t.getChildCount();n>i;i++)this._initCloneToAnimator(t.getChildByIndex(i),e)},n._parseNode=function(t,e){var i=t.props.name;e.name=i,this._nodes.push(e),this._nodeMap[i]=e;var n=t.customProps,r=e._transform,a=r.localPosition,s=a.elements,o=n.translate;s[0]=o[0],s[1]=o[1],s[2]=o[2],r.localPosition=a;var h=r.localRotation,l=h.elements,u=n.rotation;l[0]=u[0],l[1]=u[1],l[2]=u[2],l[3]=u[3],r.localRotation=h;var c=r.localScale,_=c.elements,d=n.scale;_[0]=d[0],_[1]=d[1],_[2]=d[2],r.localScale=c;for(var f=t.child,p=0,m=f.length;m>p;p++){var g=f[p],y=new O;e.addChild(y),this._parseNode(g,y)}},n.onAsynLoaded=function(t,e,i){this._nodeMap={},this._nodes=[],this._rootNode=new O,this._parseNode(e,this._rootNode),this._endLoaded()},n._cloneDatasToAnimator=function(t){var e=this._rootNode.clone(),i=(this._nodes.length,[]);t._avatarRootNode=e,t._avatarNodeMap={},t._avatarNodes=i,this._initCloneToAnimator(e,t);for(var n=0,r=i.length;r>n;n++){var a=i[n];a._parent?a._transform._setWorldMatrixAndUpdate(new ae):a._transform._setWorldMatrixNoUpdate(null)}},n.cloneTo=function(t){var e=t,i=this._rootNode.clone();e._rootNode=i,e._nodeMap={};var n=[];e._nodes=n,this._initCloneAvatar(i,e)},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.load=function(t){return i.loader.create(t,null,null,e)},e}(b),Ye=function(t){function e(){e.__super.call(this),this._isInstance=!1,this._shaderDefineValue=0,this._disablePublicShaderDefine=0,this._shaderValues=new ye,this._values=[],this._textureSharderIndices=[],this.renderQueue=1,this._alphaTest=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new de(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=!0,this.depthFunc=513,this.depthWrite=!0,E.isConchNode&&(this._conchMaterial=new ConchMaterial)}r(e,"laya.d3.core.material.BaseMaterial",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.IClone":!0}),n._uploadTextures=function(){for(var t=0,e=this._textureSharderIndices.length;e>t;t++){var i=this._textureSharderIndices[t],n=this._values[i];n&&this._uploadTexture(i,n.source||n.defaulteTexture.source)}},n._uploadTexture=function(t,e){this._shaderValues.data[t]=e},n._addShaderDefine=function(t){this._shaderDefineValue|=t,this._conchMaterial&&this._conchMaterial.addShaderDefine(t)},n._removeShaderDefine=function(t){this._shaderDefineValue&=~t,this._conchMaterial&&this._conchMaterial.removeShaderDefine(t)},n._addDisablePublicShaderDefine=function(t){this._disablePublicShaderDefine|=t},n._removeDisablePublicShaderDefine=function(t){this._disablePublicShaderDefine&=~t},n._setBuffer=function(t,e){var i=this._shaderValues;i.setValue(t,e),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e,0)},n._getBuffer=function(t){return this._values[t]},n._setMatrix4x4=function(t,e){this._shaderValues.setValue(t,e?e.elements:null),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e.elements,0)},n._getMatrix4x4=function(t){return this._values[t]},n._setInt=function(t,e){var i=this._shaderValues;i.setValue(t,e),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e,1)},n._getInt=function(t){return this._values[t]},n._setNumber=function(t,e){var i=this._shaderValues;i.setValue(t,e),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e,2)},n._getNumber=function(t){return this._values[t]},n._setBool=function(t,e){var i=this._shaderValues;i.setValue(t,e),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e,1)},n._getBool=function(t){return this._values[t]},n._setVector2=function(t,e){var i=this._shaderValues;i.setValue(t,e?e.elements:null),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setShaderValue(t,e.elements,0)},n._getVector2=function(t){return this._values[t]},n._setColor=function(t,e){var i=this._shaderValues;i.setValue(t,e?e.elements:null),this._values[t]=e,this._conchMaterial&&e&&this._conchMaterial.setShaderValue(t,e.elements,0)},n._getColor=function(t){return this._values[t]},n._setTexture=function(t,e){var i=(this._shaderValues,this._values[t]);!i&&e?this._textureSharderIndices.push(t):i&&!e&&this._textureSharderIndices.splice(this._textureSharderIndices.indexOf(t),1),this._values[t]=e,this._conchMaterial&&this._conchMaterial.setTexture(e._conchTexture,this._textureSharderIndices.indexOf(t),t)},n._getTexture=function(t){return this._values[t]},n._upload=function(){this._uploadTextures(),this._shader.uploadMaterialUniforms(this._shaderValues.data)},n._getShader=function(t,e,i){var n=(t|e)&~this._disablePublicShaderDefine;return this._shader=this._shaderCompile.withCompile(n,i,this._shaderDefineValue),this._shader},n._setRenderStateBlendDepth=function(){var t=P.mainContext;switch(L.setDepthTest(t,this.depthTest),L.setDepthMask(t,this.depthWrite),L.setDepthFunc(t,this.depthFunc),this.blend){case 0:L.setBlend(t,!1);break;case 1:L.setBlend(t,!0),L.setBlendFunc(t,this.srcBlend,this.dstBlend);break;case 2:L.setBlend(t,!0)}},n._setRenderStateFrontFace=function(t,e){var i=P.mainContext,n=0;switch(this.cull){case 0:L.setCullFace(i,!1);break;case 1:L.setCullFace(i,!0),n=t?e&&e._isFrontFaceInvert?2305:2304:e&&e._isFrontFaceInvert?2304:2305,L.setFrontFace(i,n);break;case 2:L.setCullFace(i,!0),n=t?e&&e._isFrontFaceInvert?2304:2305:e&&e._isFrontFaceInvert?2305:2304,L.setFrontFace(i,n)}},n.setShaderName=function(t){this._shaderCompile=me._preCompileShader[di.nameKey.getID(t)],this._conchMaterial&&this._conchMaterial.setShader(this._shaderCompile._conchShader)},n.onAsynLoaded=function(t,e,i){var n=e[0],r=e[1];switch(n.version){case"LAYAMATERIAL:01":var a=0,s=0,o=n.props;for(var h in o)switch(h){case"vectors":var l=o[h];for(a=0,s=l.length;s>a;a++){var u=l[a],c=u.value;switch(c.length){case 2:this[u.name]=new ce(c[0],c[1]);break;case 3:this[u.name]=new _e(c[0],c[1],c[2]);break;case 4:this[u.name]=new de(c[0],c[1],c[2],c[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var _=o[h];for(a=0,s=_.length;s>a;a++){var d=_[a],f=d.path;f&&(this[d.name]=x.getRes(r[f]))}break;case"defines":var p=o[h];for(a=0,s=p.length;s>a;a++){var m=this._shaderCompile.getMaterialDefineByName(p[a]);this._addShaderDefine(m)}break;default:this[h]=o[h]}break;default:throw new Error("BaseMaterial:unkonwn version.")}this._endLoaded()},n.cloneTo=function(t){var e=t;e.name=this.name,e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(e.blendConstColor),e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthFunc=this.depthFunc,e.depthWrite=this.depthWrite,e.renderQueue=this.renderQueue,e._shader=this._shader,e._disablePublicShaderDefine=this._disablePublicShaderDefine,e._shaderDefineValue=this._shaderDefineValue;var i=0,n=0,r=e._shaderValues;e._shaderValues.data.length=this._shaderValues.data.length;var a=this._values.length,s=e._values;for(s.length=a,i=0,n=a;n>i;i++){var o=this._values[i];if(o)if("number"==typeof o)s[i]=o,r.data[i]=o;else if("number"==typeof o&&Math.floor(o)==o)s[i]=o,r.data[i]=o;else if("boolean"==typeof o)s[i]=o,r.data[i]=o;else if(o instanceof laya.d3.math.Vector2){var h=s[i]||(s[i]=new ce);o.cloneTo(h),r.data[i]=h.elements}else if(o instanceof laya.d3.math.Vector3){var l=s[i]||(s[i]=new _e);o.cloneTo(l),r.data[i]=l.elements}else if(o instanceof laya.d3.math.Vector4){var u=s[i]||(s[i]=new de);o.cloneTo(u),r.data[i]=u.elements}else if(o instanceof laya.d3.math.Matrix4x4){var c=s[i]||(s[i]=new ae);o.cloneTo(c),r.data[i]=c.elements}else o instanceof laya.d3.resource.BaseTexture&&(s[i]=o)}e._textureSharderIndices=this._textureSharderIndices.slice()},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,n,"alphaTestValue",function(){return this._getNumber(0)},function(t){this._setNumber(0,t)}),a(0,n,"alphaTest",function(){return this._alphaTest},function(t){this._alphaTest=t,t?this._addShaderDefine(1):this._removeShaderDefine(1)}),e.CULL_NONE=0,e.CULL_FRONT=1,e.CULL_BACK=2,e.BLEND_DISABLE=0,e.BLEND_ENABLE_ALL=1,e.BLEND_ENABLE_SEPERATE=2,e.BLENDPARAM_ZERO=0,e.BLENDPARAM_ONE=1,e.BLENDPARAM_SRC_COLOR=768,e.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,e.BLENDPARAM_DST_COLOR=774,e.BLENDPARAM_ONE_MINUS_DST_COLOR=775,e.BLENDPARAM_SRC_ALPHA=770,e.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,e.BLENDPARAM_DST_ALPHA=772,e.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,e.BLENDPARAM_CONSTANT_COLOR=32769,e.BLENDPARAM_ONE_MINUS_CONSTANT_COLOR=32770,e.BLENDPARAM_CONSTANT_ALPHA=32771,e.BLENDPARAM_ONE_MINUS_CONSTANT_ALPHA=32772,e.BLENDPARAM_SRC_ALPHA_SATURATE=776,e.BLENDEQUATION_ADD=0,e.BLENDEQUATION_SUBTRACT=1,e.BLENDEQUATION_REVERSE_SUBTRACT=2,e.DEPTHFUNC_NEVER=512,e.DEPTHFUNC_LESS=513,e.DEPTHFUNC_EQUAL=514,e.DEPTHFUNC_LEQUAL=515,e.DEPTHFUNC_GREATER=516,e.DEPTHFUNC_NOTEQUAL=517,e.DEPTHFUNC_GEQUAL=518,e.DEPTHFUNC_ALWAYS=519,e.SHADERDEFINE_ALPHATEST=1,e.ALPHATESTVALUE=0,e}(b),Xe=function(t){function e(){this._type=0,this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._format=0,this._source=null,e.__super.call(this),this._conchTexture,E.isConchNode&&(this._conchTexture=new ConchTexture),this._repeat=!0,this.mipmap=!0,this.minFifter=-1,this.magFifter=-1}r(e,"laya.d3.resource.BaseTexture",t);var i=e.prototype;return a(0,i,"width",function(){return this._width}),a(0,i,"format",function(){return this._format}),a(0,i,"repeat",function(){return this._repeat},function(t){if(this._repeat!==t&&(this._repeat=t,this._source)){var e=P.mainContext;L.bindTexture(e,this._type,this._source);var i=l.isPOT(this._width,this._height);i&&this._repeat?(e.texParameteri(this._type,10242,10497),e.texParameteri(this._type,10243,10497)):(e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071))}}),a(0,i,"height",function(){return this._height}),a(0,i,"magFifter",function(){return this._magFifter},function(t){this._magFifter=t,t!=this._magFifter&&this._conchTexture&&this._conchTexture.setMaxFifter(t)}),a(0,i,"size",function(){return this._size}),a(0,i,"mipmap",function(){return this._mipmap},function(t){this._mipmap=t,this._mipmap!=t&&this._conchTexture&&this._conchTexture.setMipMap(t)}),a(0,i,"minFifter",function(){return this._minFifter},function(t){this._minFifter=t,this._minFifter!=t&&this._conchTexture&&this._conchTexture.setMinFifter(t)}),a(0,i,"source",function(){return this.activeResource(),this._source}),a(0,i,"defaulteTexture",function(){return Ri.grayTexture}),e}(b),qe=function(t){function e(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,e.__super.call(this),this._boundingBoxCorners=new Array(8)}r(e,"laya.d3.resource.models.BaseMesh",t);var i=e.prototype;return i._generateBoundingObject=function(){var t=this.positions;this._boundingSphere=new ee(new _e,0),ee.createfromPoints(t,this._boundingSphere),this._boundingBox=new Jt(new _e,new _e),Jt.createfromPoints(t,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},i.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},i.getRenderElement=function(t){throw new Error("未Override,请重载该属性！")},a(0,i,"positions",function(){throw new Error("未Override,请重载该属性！")}),a(0,i,"subMeshCount",function(){return this._subMeshCount}),a(0,i,"boundingBox",function(){return this._boundingBox}),a(0,i,"boundingBoxCorners",function(){return this._boundingBoxCorners}),a(0,i,"boundingSphere",function(){return this._boundingSphere}),e}(b),Ke=function(t){function e(){this.__ownerCamera=null,this._alphaBlending=1,this._colorIntensity=1,this._vertexBuffer=null,this._indexBuffer=null,this._sharderNameID=0,this._shader=null,this._shaderValue=null,this._shaderCompile=null,this._environmentDiffuse=null,this._environmentSpecular=null,this._conchSky=null,e.__super.call(this),this._shaderValue=new ye,E.isConchNode&&(this._conchSky=new ConchSkyMesh)}r(e,"laya.d3.resource.models.Sky",t);var i=e.prototype;return i._setEnvironmentDiffuse=function(){this._environmentDiffuse.loaded?this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse.source):this._environmentDiffuse.on("loaded",this,this._environmentDiffuseLoaded)},i._setEnvironmentSpecular=function(){if(this._environmentSpecular.loaded){var t=this._environmentSpecular.simLodInfo;t&&t instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,t),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular.source)}else this._environmentSpecular.on("loaded",this,this._environmentSpecularLoaded)},i._environmentDiffuseLoaded=function(){this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse.source)},i._environmentSpecularLoaded=function(){var t=this._environmentSpecular.simLodInfo;t&&t instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,t),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular.source)},i._render=function(t){},a(0,i,"_ownerCamera",null,function(t){this.__ownerCamera=t,this._environmentDiffuse&&this._setEnvironmentDiffuse(),this._environmentSpecular&&this._setEnvironmentSpecular()}),a(0,i,"alphaBlending",function(){return this._alphaBlending},function(t){this._alphaBlending=t,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1),this._conchSky&&this._conchSky.setShaderValue(2,this._alphaBlending,2)}),a(0,i,"envDiffuseSHBlue",null,function(t){this.__ownerCamera._shaderValues.setValue(12,t)}),a(0,i,"colorIntensity",function(){return this._colorIntensity},function(t){this._colorIntensity=t,this._colorIntensity<0&&(this._colorIntensity=0),this._conchSky&&this._conchSky.setShaderValue(1,this._colorIntensity,2)}),a(0,i,"envDiffuseSHGreen",null,function(t){this.__ownerCamera._shaderValues.setValue(11,t)}),a(0,i,"envDiffuseSHRed",null,function(t){this.__ownerCamera._shaderValues.setValue(10,t)}),a(0,i,"environmentDiffuse",function(){return this._environmentDiffuse},function(t){t.minFifter=9728,this._environmentDiffuse=t,this.__ownerCamera&&this._setEnvironmentDiffuse()}),a(0,i,"environmentSpecular",function(){return this._environmentSpecular},function(t){this._environmentSpecular=t,this.__ownerCamera&&this._setEnvironmentSpecular()}),e.MVPMATRIX=0,e.INTENSITY=1,e.ALPHABLENDING=2,e.DIFFUSETEXTURE=3,e}(b),Ze=function(t){function e(){this._terrainHeightData=null,this._width=0,this._height=0,this._bitType=0,this._value=NaN,e.__super.call(this)}r(e,"laya.d3.terrain.TerrainHeightData",t);var n=e.prototype;return n.onAsynLoaded=function(t,e,i){this._width=i[0],this._height=i[1],this._bitType=i[2],this._value=i[3];var n,r=NaN;8==this._bitType?(n=new Uint8Array(e),r=1/255):16==this._bitType&&(n=new Int16Array(e),r=1/32766),this._terrainHeightData=new Float32Array(this._height*this._width);for(var a=0,s=this._height*this._width;s>a;a++)this._terrainHeightData[a]=n[a]*r*this._value/2;this._endLoaded()},e.load=function(t,n,r,a,s){return i.loader.create(t,null,null,e,[n,r,a,s],1,!1)},e}(b),$e=function(t){function e(){this._version=NaN,this._cameraCoordinateInverse=!1,this._gridSize=NaN,this._chunkNumX=0,this._chunkNumZ=0,this._heightDataX=0,this._heightDataZ=0,this._heightDataBitType=0,this._heightDataValue=NaN,this._heightDataUrl=null,this._detailTextureInfos=null,this._chunkInfos=null,this._heightData=null,this._materialInfo=null,this._alphaMaps=null,this._normalMaps=null,e.__super.call(this)}r(e,"laya.d3.terrain.TerrainRes",t);var n=e.prototype;return n.parseData=function(t){var e=t[0],i=t[1];if(this._version=e.version,1==this._version){this._cameraCoordinateInverse=e.cameraCoordinateInverse,this._gridSize=e.gridSize,this._chunkNumX=e.chunkNumX,this._chunkNumZ=e.chunkNumZ;var n=e.heightData;if(this._heightDataX=n.numX,this._heightDataZ=n.numZ,this._heightDataBitType=n.bitType,this._heightDataValue=n.value,this._heightDataUrl=i[n.url],this._materialInfo=new Ee,e.material){var r=e.material.ambient,a=e.material.diffuse,o=e.material.specular;this._materialInfo.ambientColor=new _e(r[0],r[1],r[2]),this._materialInfo.diffuseColor=new _e(a[0],a[1],a[2]),this._materialInfo.specularColor=new de(o[0],o[1],o[2],o[3])}var h=e.detailTexture;this._detailTextureInfos=s(h.length);for(var l=0;l<h.length;l++){var u=h[l],c=new Te;c.diffuseTexture=i[u.diffuse],c.normalTexture=u.normal?i[u.normal]:null,u.scale?c.scale=new ce(u.scale[0],u.scale[1]):c.scale=new ce(1,1),u.offset?c.offset=new ce(u.offset[0],u.offset[1]):c.offset=new ce(0,0),this._detailTextureInfos[l]=c}var _=e.alphaMap;for(this._alphaMaps=s(_.length),l=0;l<this._alphaMaps.length;l++)this._alphaMaps[l]=e.alphaMap[l];var d=e.normalMap;for(this._normalMaps=s(d.length),l=0;l<this._normalMaps.length;l++)this._normalMaps[l]=e.normalMap[l];var f=e.chunkInfo;if(this._chunkNumX*this._chunkNumZ!=f.length)return alert("terrain data error"),!1;for(this._chunkInfos=s(f.length),l=0;l<f.length;l++){var p=f[l],m=new Se,g=p.alphaMap.length,y=p.detailID.length;if(g!=y)return alert("terrain chunk data error"),!1;m.alphaMap=s(g),m.detailID=s(y),m.normalMap=i[this._normalMaps[p.normalMap]];for(var v=0;g>v;v++){m.alphaMap[v]=i[this._alphaMaps[p.alphaMap[v]]];var S=p.detailID[v],T=S.length;m.detailID[v]=new Uint8Array(T);for(var E=0;T>E;E++)m.detailID[v][E]=S[E]}this._chunkInfos[l]=m}this._heightData=x.getRes(this._heightDataUrl),this.onLoadTerrainComplete(this._heightData)}return!0},n.onLoadTerrainComplete=function(t){this._endLoaded()},n.onAsynLoaded=function(t,e,i){this.parseData(e)},e.load=function(t){return i.loader.create(t,null,null,e,null,1,!1)},e}(b),Qe=function(t){function e(){this._player=null,this._templet=null,e.__super.call(this),this._player=new o}r(e,"laya.d3.component.animation.KeyframeAnimations",t);var n=e.prototype;return n._updateAnimtionPlayer=function(){this._player._update(i.timer.delta)},n._addUpdatePlayerToTimer=function(){i.timer.frameLoop(1,this,this._updateAnimtionPlayer)},n._removeUpdatePlayerToTimer=function(){i.timer.clear(this,this._updateAnimtionPlayer)},n._onOwnerActiveHierarchyChanged=function(t){this._owner.displayedInStage&&(t?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},n._onDisplayInStage=function(){this._owner.activeInHierarchy&&this._addUpdatePlayerToTimer()},n._onUnDisplayInStage=function(){this._owner.activeInHierarchy&&this._removeUpdatePlayerToTimer()},n._load=function(t){this._owner.displayedInStage&&this._owner.activeInHierarchy&&this._addUpdatePlayerToTimer(),this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._owner.on("display",this,this._onDisplayInStage),this._owner.on("undisplay",this,this._onUnDisplayInStage)},n._unload=function(e){t.prototype._unload.call(this,e),this._owner.displayedInStage&&this._owner.activeInHierarchy&&this._removeUpdatePlayerToTimer(),this._owner.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._owner.off("display",this,this._onDisplayInStage),this._owner.off("undisplay",this,this._onUnDisplayInStage),this._player._destroy(),this._player=null,this._templet=null},a(0,n,"url",null,function(t){console.log("Warning: discard property,please use templet property instead.");var e=i.loader.create(t,null,null,h);this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this.event("animationchanged",this))}),a(0,n,"player",function(){return this._player}),a(0,n,"templet",function(){return this._templet},function(t){this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this.event("animationchanged",this))}),a(0,n,"currentFrameIndex",function(){return this._player.currentKeyframeIndex}),a(0,n,"currentAnimationClipIndex",function(){return this._player.currentAnimationClipIndex}),a(0,n,"nodeCount",function(){return this._templet.getNodeCount(this._player.currentAnimationClipIndex)}),e}(Ie),Je=function(t){function e(){e.__super.call(this),this._clipNames=[],this._clips=[],this._cacheNodesOwners=[],this._cacheNodesOriginalValue=[],this._cacheNodesToSpriteMap=[],this._cacheSpriteToNodesMap=[],this._cacheFullFrames=[],this._publicClipAnimationDatas=[],this._updateTransformPropertyLoopCount=-1,this._lastFrameIndex=-1,this._defaultClipIndex=-1,this._cachePlayRate=1,this._playStart=0,this._playEnd=0,this._playDuration=0,this._currentPlayClip=null,this._currentFrameIndex=-1,this._currentTime=0,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this.isCache=!0,this.cacheFrameRate=60,this.returnToZeroStopped=!1,this.playbackRate=1}r(e,"laya.d3.component.Animator",t);var n=e.prototype;return i.imps(n,{"laya.resource.IDestroy":!0}),n._getClipOwnersAndInitRelateDatas=function(t){var e=this._clips[t]._nodes,i=e.length,n=this._cacheNodesOwners[t],r=this._cacheNodesOriginalValue[t],a=this._publicClipAnimationDatas[t];n.length=i,r.length=i,a.length=i;for(var s=this._avatarRootNode,o=0;i>o;o++){for(var h=s,l=e[o],u=l.path,c=0,_=u.length;_>c;c++){var d=u[c];if(""===d)break;if(h=h.getChildByName(u[c]),!h)break}h&&(n[o]=h,r[o]=new Float32Array(l.keyFrameWidth),l._cacheProperty||(a[o]=new Float32Array(l.keyFrameWidth)))}},n._getOriginalValues=function(t){var e=this._clips[t]._nodes,i=this._cacheNodesOwners[t],n=this._cacheNodesOriginalValue[t],r=i.length;n.length=r;for(var a=0;r>a;a++){var s=i[a];if(s){var o=e[a],h=O._propertyGetFuncs[o.propertyNameID](s);if(h)for(var l=n[a],u=0,c=h.length;c>u;u++)l[u]=h[u]}}},n._offClipAndAvatarRelateEvent=function(t,e){t.loaded?e.loaded||(e.off("loaded",this,this._getClipOwnersAndInitRelateDatas),e===this._currentPlayClip&&e.off("loaded",this,this._getOriginalValues)):(t.off("loaded",this,this._getClipsOwnersAndInitAvatarDatasAsync),this._currentPlayClip&&t.off("loaded",this,this._getOriginalValuesAsync))},n._getClipOwnersAndInitRelateDatasAsync=function(t,e){e.loaded?this._getClipOwnersAndInitRelateDatas(t):e.once("loaded",this,this._getClipOwnersAndInitRelateDatas,[t])},n._getClipsOwnersAndInitAvatarDatasAsync=function(){for(var t=0,e=this._clips.length;e>t;t++)this._getClipOwnersAndInitRelateDatasAsync(t,this._clips[t]);this._avatar._cloneDatasToAnimator(this);var i=this._avatarNodes.length;for(this._publicAvatarAnimationDatas=[],this._publicAvatarAnimationDatas.length=i,t=0;i>t;t++)this._publicAvatarAnimationDatas[t]=new ae;for(t=0,e=this._avatarNodes.length;e>t;t++)this._checkAnimationNode(this._avatarNodes[t],this._owner)},n._offGetOriginalValuesEvent=function(t,e){t.loaded?e.loaded||e.off("loaded",this,this._getOriginalValues):t.off("loaded",this,this._getOriginalValuesAsync)},n._getOriginalValuesAsync=function(t,e){e.loaded?this._getOriginalValues(t):e.once("loaded",this,this._getOriginalValues,[t])},n._offGetClipCacheFullKeyframeIndicesEvent=function(t){t.loaded||t.off("loaded",this,this._computeCacheFullKeyframeIndices)},n._computeCacheFullKeyframeIndices=function(t){var e=this._clips[t],i=this._cacheFrameRateInterval*this._cachePlayRate,n=e._getFullKeyframeIndicesWithCache(i);if(n)return void(this._cacheFullFrames[t]=n);n=this._cacheFullFrames[t]=[];var r=e._nodes,a=r.length;n.length=a;for(var s=Math.ceil(e._duration/i+1e-5)+1,o=0;a>o;o++){for(var h=r[o],l=new Int32Array(s),u=-1,c=h.keyFrames,_=0,d=c.length;d>_;_++){var f=c[_],p=f.startTime,m=p+f.duration;do{for(var g=Math.ceil(p/i-1e-5),y=u+1;g>y;y++)l[y]=-1;l[g]=_,u=g,p+=i}while(m>p)}n[o]=l}e._cacheFullKeyframeIndices(i,n)},n._updateAnimtionPlayer=function(){this._updatePlayer(i.timer.delta/1e3)},n._onOwnerActiveHierarchyChanged=function(){this._owner&&(this._owner.displayedInStage&&this._owner.activeInHierarchy?i.timer.frameLoop(1,this,this._updateAnimtionPlayer):i.timer.clear(this,this._updateAnimtionPlayer))},n._calculatePlayDuration=function(){if(0!==this.playState){var t=this._currentPlayClip._duration;0===this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart}},n._setPlayParams=function(t,e){this._currentTime=t,this._currentFrameIndex=Math.floor(this.currentPlayTime/e+1e-5),this._currentFrameTime=this._currentFrameIndex*e},n._setPlayParamsWhenStop=function(t,e){this._currentTime=t,this._currentFrameIndex=Math.floor(t/e+1e-5),this._currentFrameTime=this._currentFrameIndex*e,this._currentPlayClip=null},n._onAnimationStop=function(){if(this._lastFrameIndex=-1,this.returnToZeroStopped)this._revertKeyframeNodes(this._currentPlayClip,this._currentPlayClipIndex);else for(var t=this._cacheNodesOriginalValue[this._currentPlayClipIndex],e=this.clip._nodes,i=this._cacheNodesOwners[this._currentPlayClipIndex],n=0,r=i.length;r>n;n++){for(var a=i[n],s=e[n],o=s.keyFrames,h=o[o.length-1].data,l=t[n],u=0,c=t.length;c>u;u++)l[u]=h[u];a&&O._propertySetFuncs[s.propertyNameID](a,l)}},n._setAnimationClipProperty=function(t,e){for(var i=this._currentPlayClip._nodeToCachePropertyMap,n=0,r=t.length;r>n;n++){var a=t[n];if(a){var s=this._currentPlayClip._nodes[n],o=s._cacheProperty?this._curClipAnimationDatas[i[n]]:e[n];o&&O._propertySetFuncs[s.propertyNameID](a,o)}}},n._setAnimationClipPropertyCache=function(t){for(var e=this._currentPlayClip._cachePropertyToNodeMap,i=0,n=e.length;n>i;i++){var r=e[i],a=t[r];if(a){var s=this._currentPlayClip._nodes[r],o=this._curClipAnimationDatas[i];o&&O._propertySetFuncs[s.propertyNameID](a,o)}}},n._setAnimationClipPropertyUnCache=function(t,e){for(var i=this._currentPlayClip._unCachePropertyToNodeMap,n=0,r=i.length;r>n;n++){var a=i[n],s=t[a];if(s){var o=this._currentPlayClip._nodes[a],h=e[n];h&&O._propertySetFuncs[o.propertyNameID](s,h)}}},n._revertKeyframeNodes=function(t,e){for(var i=this._cacheNodesOriginalValue[e],n=t._nodes,r=this._cacheNodesOwners[e],a=0,s=r.length;s>a;a++){var o=r[a];o&&O._propertySetFuncs[n[a].propertyNameID](o,i[a])}},n._updateAvatarNodes=function(t){for(var e=0,i=this._cacheSpriteToNodesMap.length;i>e;e++){var n=this._avatarNodes[this._cacheSpriteToNodesMap[e]],r=n._transform._entity,a=n._transform;if(a._worldUpdate){var s=new ae;t[e]=s,a._setWorldMatrixAndUpdate(s);var o=r.worldMatrix;ae.multiply(this._owner._transform.worldMatrix,s,o),r.worldMatrix=o}}},n._updateAvatarNodesCache=function(t){for(var e=0,i=this._cacheSpriteToNodesMap.length;i>e;e++){var n=this._avatarNodes[this._cacheSpriteToNodesMap[e]],r=n._transform._entity,a=t[e];if(a){var s=r.worldMatrix;ae.multiply(this._owner._transform.worldMatrix,a,s),r.worldMatrix=s}}},n._updatePlayer=function(t){if(null!=this._currentPlayClip&&!this._paused&&this._currentPlayClip.loaded){var e=this._cacheFrameRateInterval*this._cachePlayRate,i=0;this._startUpdateLoopCount!==D.loopCount&&(i=t*this.playbackRate,this._elapsedPlaybackTime+=i);var n=this.playDuration;if(!this._currentPlayClip.islooping&&this._elapsedPlaybackTime>=n)return this._setPlayParamsWhenStop(n,e),this._onAnimationStop(),void this.event("stopped");if(i+=this._currentTime,n>0)if(i>=n){do{if(i-=n,this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(n,e),this._stopWhenCircleFinish=!1,this._onAnimationStop(),void this.event("stopped");n>i&&(this._setPlayParams(i,e),this.event("complete"))}while(i>=n)}else this._setPlayParams(i,e);else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(n,e),this._stopWhenCircleFinish=!1,this._onAnimationStop(),void this.event("stopped");this._currentTime=this._currentFrameTime=this._currentFrameIndex=0,this.event("complete")}}},n._updateTansformProperty=function(){if(this._updateTransformPropertyLoopCount!==D.loopCount){var t=this._publicClipAnimationDatas[this._currentPlayClipIndex];this.currentPlayClip._evaluateAnimationlDatasCacheFrame(this._cacheFullFrames[this._currentPlayClipIndex],this,this._cacheNodesOriginalValue[this._currentPlayClipIndex],t,null,this._cacheNodesOwners[this._currentPlayClipIndex]),this._setAnimationClipPropertyUnCache(this._cacheNodesOwners[this._currentPlayClipIndex],t)}},n._update=function(t){var e=this._currentPlayClip;if(2===this.playState&&e&&e.loaded){var n=this.playbackRate*i.timer.scale,r=this._cachePlayRate;
this._canCache=this.isCache&&n>=r;var a=-1;if(this._canCache){if(a=this._currentFrameIndex,this._lastFrameIndex===a)return;var s=e._getAvatarDataWithCache(this._avatar,this._cachePlayRate,a);if(s)return this._curClipAnimationDatas=e._getAnimationDataWithCache(r,a),this._setAnimationClipPropertyCache(this._cacheNodesOwners[this._currentPlayClipIndex]),this._updateAvatarNodesCache(s),void(this._lastFrameIndex=a);var o=this._cacheNodesOwners[this._currentPlayClipIndex],h=this._publicClipAnimationDatas[this._currentPlayClipIndex];if(this._curClipAnimationDatas=e._getAnimationDataWithCache(r,a),this._curClipAnimationDatas)e._evaluateAnimationlDatasCacheFrame(this._cacheFullFrames[this._currentPlayClipIndex],this,this._cacheNodesOriginalValue[this._currentPlayClipIndex],h,null,o),this._setAnimationClipProperty(o,h);else{var l=e._cachePropertyToNodeMap;this._curClipAnimationDatas=[],this._curClipAnimationDatas.length=l.length,e._evaluateAnimationlDatasCacheFrame(this._cacheFullFrames[this._currentPlayClipIndex],this,this._cacheNodesOriginalValue[this._currentPlayClipIndex],h,this._curClipAnimationDatas,o),this._setAnimationClipProperty(o,h),e._cacheAnimationData(r,a,this._curClipAnimationDatas)}this._curAvatarAnimationDatas=[],this._curAvatarAnimationDatas.length=this._cacheSpriteToNodesMap.length,this._updateAvatarNodes(this._curAvatarAnimationDatas),e._cacheAvatarData(this._avatar,r,a,this._curAvatarAnimationDatas),this._updateTransformPropertyLoopCount=D.loopCount}else this._curClipAnimationDatas=this._publicClipAnimationDatas[this._currentPlayClipIndex],this._curAvatarAnimationDatas=this._publicAvatarAnimationDatas,e._evaluateAnimationlDatasRealTime(this.currentPlayTime,this._curClipAnimationDatas),this._setAnimationClipProperty(this._cacheNodesOwners[this._currentPlayClipIndex],this._curClipAnimationDatas),this._updateAvatarNodes(this._curAvatarAnimationDatas);this._lastFrameIndex=a}},n._checkAnimationNode=function(t,e){t.name!==e.name||e._transform.dummy||e._associateSpriteToAnimationNode(this._avatar,t);for(var i=0,n=e._childs.length;n>i;i++)this._checkAnimationNode(t,e.getChildAt(i))},n._load=function(t){this._owner.on("display",this,this._onOwnerActiveHierarchyChanged),this._owner.on("undisplay",this,this._onOwnerActiveHierarchyChanged),this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},n._unload=function(e){t.prototype._unload.call(this,e),this._curClipAnimationDatas=null,this._publicClipAnimationDatas=null,this._curAvatarAnimationDatas=null,this._publicAvatarAnimationDatas=null},n._destroy=function(){t.prototype._destroy.call(this),this._currentPlayClip&&(this._currentPlayClip.loaded||this._currentPlayClip.off("loaded",this,this._calculatePlayDuration)),this._currentPlayClip=null,this._clipNames=null,this._cacheNodesOwners=null,this._cacheNodesOriginalValue=null,this._publicClipAnimationDatas=null,this._clips=null,this._cacheFullFrames=null},n._cloneTo=function(t){var e=t;e.avatar=this.avatar;for(var i=(this._clips.length,0),n=this._clips.length;n>i;i++)e.addClip(this._clips[i]);e.clip=this.clip,e.play()},n.addClip=function(t,e){e=e||t.name;var i=this._clipNames.indexOf(e);if(-1!==i){if(this._clips[i]!==t)throw new Error("Animation:this playName has exist with another clip.")}else{var n=this._clips.indexOf(t);if(-1!==n)throw new Error("Animation:this clip has exist with another playName.");this._clipNames.push(e),this._clips.push(t),this._cacheNodesOwners.push([]),this._cacheNodesOriginalValue.push([]),this._publicClipAnimationDatas.push([]),n=this._clips.length-1,this._avatar&&(this._avatar.loaded?this._getClipOwnersAndInitRelateDatasAsync(n,t):this._avatar.once("loaded",this,this._getClipOwnersAndInitRelateDatasAsync,[n,t])),t.loaded?this._computeCacheFullKeyframeIndices(n):t.once("loaded",this,this._computeCacheFullKeyframeIndices,[n])}},n.removeClip=function(t){var e=this._clips.indexOf(t);-1!==e&&(this._avatar&&this._offClipAndAvatarRelateEvent(this._avatar,t),this._offGetClipCacheFullKeyframeIndicesEvent(t),this._offGetOriginalValuesEvent(this._avatar,t),this._clipNames.splice(e,1),this._clips.splice(e,1),this._cacheNodesOwners.splice(e,1),this._cacheNodesOriginalValue.splice(e,1),this._publicClipAnimationDatas.splice(e,1))},n.removeClipByName=function(t){var e=this._clipNames.indexOf(t);if(-1!==e){var i=this._clips[e];this._avatar&&this._offClipAndAvatarRelateEvent(this._avatar,i),this._offGetClipCacheFullKeyframeIndicesEvent(i),this._offGetOriginalValuesEvent(this._avatar,i),this._clipNames.splice(e,1),this._clips.splice(e,1),this._cacheNodesOwners.splice(e,1),this._cacheNodesOriginalValue.splice(e,1),this._publicClipAnimationDatas.splice(e,1)}},n.getClip=function(t){var e=this._clipNames.indexOf(t);return-1!==e?this._clips[e]:null},n.getClipCount=function(){return this._clips.length},n.play=function(t,e,i,n){if(void 0===e&&(e=1),void 0===i&&(i=0),void 0===n&&(n=-1),!t&&-1==this._defaultClipIndex)throw new Error("Animator:must have  default clip value,please set clip property.");if(0>i||-1>n)throw new Error("Animator:playStart and playEnd must large than zero.");if(-1!==n&&i>n)throw new Error("Animator:start must less than end.");var r=this._currentPlayClip,a=this._currentPlayClipIndex;t?(this._currentPlayClipIndex=this._clipNames.indexOf(t),this._currentPlayClip=this._clips[this._currentPlayClipIndex]):(this._currentPlayClipIndex=this._defaultClipIndex,this._currentPlayClip=this._clips[this._defaultClipIndex]),this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=e,this._playStart=1*i/this._currentPlayClip._frameRate,this._playEnd=-1===n?this._currentPlayClip._duration:1*n/this._currentPlayClip._frameRate,this._paused=!1,this._currentFrameIndex=0,this._startUpdateLoopCount=D.loopCount,this.event("played"),r&&(r!==this._currentPlayClip&&this._revertKeyframeNodes(r,a),this._offGetOriginalValuesEvent(this._avatar,r)),this._avatar&&(this._avatar.loaded?this._getOriginalValuesAsync(this._currentPlayClipIndex,this._currentPlayClip):this._avatar.once("loaded",this,this._getOriginalValuesAsync,[this._currentPlayClipIndex,this.clip])),this._currentPlayClip.loaded?this._calculatePlayDuration():this._currentPlayClip.once("loaded",this,this._calculatePlayDuration),this._updatePlayer(0)},n.stop=function(t){void 0===t&&(t=!0),t?(this._currentTime=this._currentFrameTime=this._currentFrameIndex=0,this._currentPlayClip=null,this._onAnimationStop(),this.event("stopped")):this._stopWhenCircleFinish=!0},a(0,n,"avatar",function(){return this._avatar},function(t){if(this._avatar!==t){var e=this._avatar;this._avatar=t;for(var i=this._clips.length,n=0;i>n;n++)this._offClipAndAvatarRelateEvent(e,this._clips[n]);t&&(t.loaded?this._getClipsOwnersAndInitAvatarDatasAsync():t.once("loaded",this,this._getClipsOwnersAndInitAvatarDatasAsync))}}),a(0,n,"cacheFrameRate",function(){return this._cacheFrameRate},function(t){if(this._cacheFrameRate!==t){this._cacheFrameRate=t,this._cacheFrameRateInterval=1/this._cacheFrameRate;for(var e=0,i=this._clips.length;i>e;e++)this._clips[e].loaded&&this._computeCacheFullKeyframeIndices(e)}}),a(0,n,"currentTime",null,function(t){if(null!=this._currentPlayClip&&this._currentPlayClip&&this._currentPlayClip.loaded){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=D.loopCount;var e=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentFrameIndex=Math.floor(this.currentPlayTime/e),this._currentFrameTime=this._currentFrameIndex*e}}),a(0,n,"clip",function(){return this._clips[this._defaultClipIndex]},function(t){var e=t?this._clips.indexOf(t):-1;this._defaultClipIndex!==e&&(-1!==this._defaultClipIndex&&this.removeClip(this._clips[this._defaultClipIndex]),-1!==e&&this.addClip(t,t.name),this._defaultClipIndex=e)}),a(0,n,"currentFrameIndex",function(){return this._currentFrameIndex}),a(0,n,"cachePlayRate",function(){return this._cachePlayRate},function(t){if(this._cachePlayRate!==t){this._cachePlayRate=t;for(var e=0,i=this._clips.length;i>e;e++)this._clips[e].loaded&&this._computeCacheFullKeyframeIndices(e)}}),a(0,n,"playDuration",function(){return this._playDuration}),a(0,n,"currentFrameTime",function(){return this._currentFrameTime}),a(0,n,"currentPlayClip",function(){return this._currentPlayClip}),a(0,n,"currentPlayTime",function(){return this._currentTime+this._playStart}),a(0,n,"paused",function(){return this._paused},function(t){this._paused=t,t&&this.event("paused")}),a(0,n,"playState",function(){return null==this._currentPlayClip?0:this._paused?1:2}),a(0,n,"curAnimationDatas",function(){return this._curClipAnimationDatas}),e}(Ie),ti=(function(t){function e(){this._attachSkeleton=null,this._extenData=null,this.attachBones=null,this.matrixs=null,e.__super.call(this),this.attachBones=[],this.matrixs=[]}r(e,"laya.d3.component.AttachPoint",t);var i=e.prototype;return i._load=function(e){t.prototype._load.call(this,e),this._attachSkeleton=e.getComponentByType(bi)},i._update=function(t){if(this._attachSkeleton&&!this._attachSkeleton.destroyed&&0!==this._attachSkeleton.player.state&&this._attachSkeleton.curBonesDatas){var e=this._attachSkeleton.player,i=this._attachSkeleton.templet;this.matrixs.length=this.attachBones.length;for(var n=this._attachSkeleton.curBonesDatas,r=this.owner.transform.worldMatrix,a=0,s=this.attachBones.length;s>a;a++){var o=16*i.getNodeIndexWithName(e.currentAnimationClipIndex,this.attachBones[a]),h=this.matrixs[a];h||(h=this.matrixs[a]=new ae);for(var l=h.elements,u=0;16>u;u++)l[u]=n[o+u];ae.multiply(r,h,h)}this.event("complete")}},e}(Ie),function(t){function e(){this._needUpdate=!1,e.__super.call(this)}r(e,"laya.d3.component.physics.Collider",t);var i=e.prototype;return i.raycast=function(t,e,i){throw void 0===i&&(i=Number.MAX_VALUE),new Error("Must override it.")},a(0,i,"isSingleton",function(){return e._isSingleton}),e._isSingleton=!1,e}(Ie)),ei=(function(t){function e(){e.__super.call(this)}r(e,"laya.d3.component.Script",t);var i=e.prototype;return a(0,i,"isSingleton",function(){return e._isSingleton}),e._isSingleton=!1,e}(Ie),function(t){function e(t){e.__super.call(this,t)}r(e,"laya.d3.core.GlitterRender",t);var i=e.prototype;return i._calculateBoundingBox=function(){var t=this._boundingBox.min.elements;t[0]=-Number.MAX_VALUE,t[1]=-Number.MAX_VALUE,t[2]=-Number.MAX_VALUE;var e=this._boundingBox.min.elements;e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},i._calculateBoundingSphere=function(){var t=this._boundingSphere.center.elements;t[0]=0,t[1]=0,t[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},i._renderUpdate=function(t){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var e=this._owner.getProjectionViewWorldMatrix(t);this._setShaderValueMatrix4x4(1,e);var i=this._owner.templet;this._setShaderValueNumber(3,i.lifeTime),this._setShaderValueNumber(2,i._currentTime)},e}(Le)),ii=function(t){function e(t){this._owner=null,this._sharedMesh=null,e.__super.call(this),this._owner=t}r(e,"laya.d3.core.MeshFilter",t);var i=e.prototype;return i._sharedMeshLoaded=function(){this.event("loaded")},i._destroy=function(){t.prototype._destroy.call(this),this._owner=null,this._sharedMesh=null},a(0,i,"sharedMesh",function(){return this._sharedMesh},function(t){var e=this._sharedMesh;this._sharedMesh=t,this.event("meshchanged",[this,e,t]),t.loaded||this._sharedMesh.once("loaded",this,this._sharedMeshLoaded)}),a(0,i,"_isAsyncLoaded",function(){return this._sharedMesh.loaded}),a(0,i,"_originalBoundingBoxCorners",function(){return this._sharedMesh.boundingBoxCorners}),a(0,i,"_originalBoundingSphere",function(){return this._sharedMesh.boundingSphere}),a(0,i,"_originalBoundingBox",function(){return this._sharedMesh.boundingBox}),e}(Pe),ni=function(t){function e(t){e.__super.call(this,t),t.meshFilter.on("meshchanged",this,this._onMeshChanged)}r(e,"laya.d3.core.MeshRender",t);var i=e.prototype;return i._onMeshChanged=function(t,e,i){i.loaded?this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0:i.once("loaded",this,this._onMeshLoaed)},i._onMeshLoaed=function(t,e){this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0},i._calculateBoundingSphere=function(){var t=this._owner.meshFilter.sharedMesh;if(null==t||null==t.boundingSphere)this._boundingSphere.toDefault();else{var e=t.boundingSphere,i=NaN,n=this._owner.transform,r=n.scale;i=r.x>=r.y&&r.x>=r.z?r.x:r.y>=r.z?r.y:r.z,_e.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*i}},i._calculateBoundingBox=function(){var t=this._owner.meshFilter.sharedMesh;if(null==t||null==t.boundingBox)this._boundingBox.toDefault();else{for(var e=this._owner.transform.worldMatrix,i=t.boundingBoxCorners,n=0;8>n;n++)_e.transformCoordinate(i[n],e,Le._tempBoundBoxCorners[n]);Jt.createfromPoints(Le._tempBoundBoxCorners,this._boundingBox)}},i._renderUpdate=function(t){var e=this._owner.transform;if(e){this._setShaderValueMatrix4x4(0,e.worldMatrix);var i=this._owner.getProjectionViewWorldMatrix(t);this._setShaderValueMatrix4x4(1,i)}else this._setShaderValueMatrix4x4(0,ae.DEFAULT),this._setShaderValueMatrix4x4(1,t)},e}(Le),ri=function(t){function e(t){e.__super.call(this),this._tempRotationMatrix=new ae,this._uvLength=new ce,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=t,this._ownerRender=t.particleRender,this._boundingBoxCorners=new Array(8),this._boundingSphere=new ee(new _e,0),this._boundingBox=new Jt(new _e,new _e),this._currentTime=0,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameTime=0,this._emissionTime=0,this._playbackTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this.startLifetimeType=0,this.startLifetimeConstant=5,this.startLifeTimeGradient=new K,this.startLifetimeConstantMin=0,this.startLifetimeConstantMax=5,this.startLifeTimeGradientMin=new K,this.startLifeTimeGradientMax=new K,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new _e(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new _e(0,0,0),this.startSizeConstantMaxSeparate=new _e(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new _e(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new _e(0,0,0),this.startRotationConstantMaxSeparate=new _e(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new de(1,1,1,1),this.startColorConstantMin=new de(1,1,1,1),this.startColorConstantMax=new de(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new le(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(e._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._owner.on("display",this,this._onDisplayInStage),this._owner.on("undisplay",this,this._onUnDisplayInStage)}r(e,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",t);var s=e.prototype;return i.imps(s,{"laya.d3.core.render.IRenderable":!0,"laya.d3.core.IClone":!0}),s._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},s._getIndexBuffer=function(){return this._indexBuffer},s._generateBoundingSphere=function(){var t=this._boundingSphere.center.elements;t[0]=0,t[1]=0,t[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},s._generateBoundingBox=function(){var t=this._owner,i=t.particleRender,n=this._boundingBox.min,r=this._boundingBox.max,a=0,s=0,o=NaN;switch(this.startLifetimeType){case 0:o=this.startLifetimeConstant;break;case 1:o=-Number.MAX_VALUE;var h=h;for(a=0,s=h.gradientCount;s>a;a++)o=Math.max(o,h.getValueByIndex(a));break;case 2:o=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:o=-Number.MAX_VALUE;var l=l;for(a=0,s=l.gradientCount;s>a;a++)o=Math.max(o,l.getValueByIndex(a));var u=u;for(a=0,s=u.gradientCount;s>a;a++)o=Math.max(o,u.getValueByIndex(a))}var c=NaN,_=NaN;switch(this.startSpeedType){case 0:c=_=this.startSpeedConstant;break;case 1:break;case 2:c=this.startLifetimeConstantMin,_=this.startLifetimeConstantMax;break;case 3:}var d,f,p,m;this._shape&&this._shape.enable||(d=f=_e.ZERO,p=_e.ZERO,m=_e.UnitZ);var g=new _e(p.x*c,p.y*c,p.z*c),y=new _e(m.x*_,m.y*_,m.z*_);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var x,v,S=this._velocityOverLifetime.velocity;switch(S.type){case 0:x=v=S.constant;break;case 1:x=v=new _e(S.gradientX.getAverageValue(),S.gradientY.getAverageValue(),S.gradientZ.getAverageValue());break;case 2:x=S.constantMin,v=S.constantMax;break;case 3:x=new _e(S.gradientXMin.getAverageValue(),S.gradientYMin.getAverageValue(),S.gradientZMin.getAverageValue()),v=new _e(S.gradientXMax.getAverageValue(),S.gradientYMax.getAverageValue(),S.gradientZMax.getAverageValue())}}var T,E,w=this._owner.transform,b=w.position,C=e._tempVector39,M=C.elements,D=i.renderMode;switch(this.scaleMode){case 0:var A=w.scale;T=A,M[0]=A.x,M[1]=A.z,M[2]=A.y,1===D&&(E=A);break;case 1:var R=w.localScale;T=R,M[0]=R.x,M[1]=R.z,M[2]=R.y,1===D&&(E=R);break;case 2:T=w.scale,M[0]=M[1]=M[2]=1,1===D&&(E=_e.ONE)}var I,P;switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(I=new _e(g.x*o,g.y*o,g.z*o),P=new _e(y.x*o,y.y*o,y.z*o),2!=this.scaleMode?(_e.add(d,I,n),_e.multiply(T,n,n),_e.add(f,P,r),_e.multiply(T,r,r)):(_e.multiply(T,d,n),_e.add(n,I,n),_e.multiply(T,f,r),_e.add(r,P,r))),this.simulationSpace){case 0:break;case 1:_e.add(n,b,n),_e.add(r,b,r)}var L=NaN,N=NaN;switch(this.startSizeType){case 0:if(this.threeDStartSize){var O=O;L=Math.max(O.x,O.y),1===D&&(N=O.y)}else L=this.startSizeConstant,1===D&&(N=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var V=V;L=Math.max(V.x,V.y),1===D&&(N=V.y)}else L=this.startSizeConstantMax,1===D&&(N=this.startSizeConstantMax);break;case 3:}if(this._sizeOverLifetime&&this._sizeOverLifetime.enbale){this._sizeOverLifetime.size;L*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var F=e._tempVector30,B=F.elements,U=NaN,k=NaN;switch(D){case 0:U=L*e.halfKSqrtOf2,_e.scale(C,L,F),_e.subtract(n,F,n),_e.add(r,F,r);break;case 1:var H=e._tempVector31,z=e._tempVector32,W=e._tempVector33,G=e._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(_e.multiply(E,y,z),_e.multiply(E,g,W));var j=N*i.stretchedBillboardLengthScale,Y=_e.scalarLength(z)*i.stretchedBillboardSpeedScale+j,X=_e.scalarLength(W)*i.stretchedBillboardSpeedScale+j,q=e._tempVector35,K=e._tempVector36;_e.normalize(z,q),_e.scale(q,Y,G),_e.subtract(P,G,G),_e.normalize(W,K),_e.scale(K,X,H),_e.add(I,H,H),U=L*e.halfKSqrtOf2,_e.scale(C,U,F);var Z=e._tempVector37,$=e._tempVector38;_e.scale(q,.5,Z),_e.scale(K,.5,$),_e.multiply(Z,C,Z),_e.multiply($,C,$),_e.add(n,$,n),_e.min(n,G,n),_e.subtract(n,F,n),_e.subtract(r,Z,r),_e.max(r,H,r),_e.add(r,F,r);break;case 2:L*=Math.cos(.7853981633974483),k=.5*L,B[0]=C.x*k,B[1]=C.z*k,_e.subtract(n,F,n),_e.add(r,F,r);break;case 3:L*=Math.cos(.7853981633974483),k=.5*L,_e.scale(C,k,F),_e.subtract(n,F,n),_e.add(r,F,r)}this._boundingBox.getCorners(this._boundingBoxCorners)},s._updateEmission=function(){if(i.stage.isVisibility)if(this._simulateUpdate)this._simulateUpdate=!1;else{var t=this._startUpdateLoopCount===D.loopCount||this._isPaused?0:i.timer.delta/1e3;t=Math.min(e._maxElapsedTime,t),this._updateParticles(t)}},s._updateParticles=function(t){var e=this._playbackTime+t;return e<this._playStartDelay?void(this._playbackTime=e):(this._currentTime+=t,this._retireActiveParticles(),this._freeRetiredParticles(),void(this._emission.enbale&&this._isPlaying&&!this._isPaused&&this._advanceTime(t,this._currentTime)))},s._updateParticlesSimulationRestart=function(t){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameTime=0,this._emissionTime=0,this._playbackTime=0,this._currentTime=t;var e=t;return e<this._playStartDelay?void(this._playbackTime=e):void(this._emission.enbale&&this._advanceTime(t,t))},s._addUpdateEmissionToTimer=function(){i.timer.frameLoop(1,this,this._updateEmission)},s._removeUpdateEmissionToTimer=function(){i.timer.clear(this,this._updateEmission)},s._onOwnerActiveHierarchyChanged=function(t){this._owner.displayedInStage&&(t?this._addUpdateEmissionToTimer():this._removeUpdateEmissionToTimer())},s._onDisplayInStage=function(){this._owner.activeInHierarchy&&this._addUpdateEmissionToTimer()},s._onUnDisplayInStage=function(){this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer()},s._retireActiveParticles=function(){for(var t=1e-4;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,i=e+this._timeIndex,n=this._currentTime-this._vertices[i];if(n+t<this._vertices[e+this._startLifeTimeIndex])break;this._vertices[i]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},s._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var t=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&3>t)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},s._burst=function(t,e){for(var i=0,n=this._emission._bursts,r=n.length;this._burstsIndex<r;this._burstsIndex++){var a=n[this._burstsIndex],s=a.time;if(!(s>=t&&e>s))break;var o=0;this.autoRandomSeed?o=S.lerp(a.minCount,a.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=S.lerp(a.minCount,a.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),i+=o}return i},s._advanceTime=function(t,e){var i=0,n=this._emissionTime;this._emissionTime+=t;var r=0;if(this._emissionTime>this.duration){if(!this.looping){for(this._isPlaying=!1,r=Math.min(this.maxParticles-this.aliveParticleCount,r),i=0;r>i;i++)this.emit(e);return void this.event("stopped")}r+=this._burst(n,this._emissionTime),this._emissionTime-=this.duration,this.event("complete"),this._burstsIndex=0,r+=this._burst(0,this._emissionTime)}else r+=this._burst(n,this._emissionTime);for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),i=0;r>i;i++)this.emit(e);var a=this.emission._minEmissionTime;for(this._frameTime+=a;this._frameTime<=e&&this.emit(this._frameTime);)this._frameTime+=a;this._frameTime=Math.floor(e/a)*a},s._initBufferDatas=function(){var t=this._ownerRender,e=t.renderMode;if(-1!==e&&this.maxParticles>0){var i,n,r=0,a=0,s=0,o=0,h=0,l=t.mesh;if(4===e&&l){var u=l._vertexBuffers.length;if(u>1)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");n=qt.vertexDeclaration,this._floatCountPerVertex=n.vertexStride/4,this._startLifeTimeIndex=8,this._timeIndex=12,this._vertexStride=l._vertexBuffers[0].vertexCount;var c=this._bufferMaxParticles*this._vertexStride,_=Math.floor(c/65535)+1,d=c%65535;if(_>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");this._vertexBuffer=Si.create(n,d,35048),this._vertices=new Float32Array(this._floatCountPerVertex*d),this._indexStride=l._indexBuffer.indexCount;var f=l._indexBuffer.getData(),p=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=vi.create("ushort",p,35044),i=new Uint16Array(p),o=0,r=0;r<this._bufferMaxParticles;r++){var m=r*this._vertexStride;for(a=0,s=f.length;s>a;a++)i[o++]=m+f[a]}this._indexBuffer.setData(i)}else{for(n=Xt.vertexDeclaration,this._floatCountPerVertex=n.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,this._vertexBuffer=Si.create(n,this._bufferMaxParticles*this._vertexStride,35048),this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),r=0;r<this._bufferMaxParticles;r++)h=r*this._floatCountPerVertex*this._vertexStride,this._vertices[h]=-.5,this._vertices[h+1]=-.5,this._vertices[h+2]=0,this._vertices[h+3]=1,h+=this._floatCountPerVertex,this._vertices[h]=.5,this._vertices[h+1]=-.5,this._vertices[h+2]=1,this._vertices[h+3]=1,h+=this._floatCountPerVertex,this._vertices[h]=.5,this._vertices[h+1]=.5,this._vertices[h+2]=1,this._vertices[h+3]=0,h+=this._floatCountPerVertex,this._vertices[h]=-.5,this._vertices[h+1]=.5,this._vertices[h+2]=0,this._vertices[h+3]=0;for(this._indexStride=6,this._indexBuffer=vi.create("ushort",6*this._bufferMaxParticles,35044),i=new Uint16Array(6*this._bufferMaxParticles),r=0;r<this._bufferMaxParticles;r++){o=6*r;var g=r*this._vertexStride,y=g+2;i[o++]=g,i[o++]=y,i[o++]=g+1,i[o++]=g,i[o++]=g+3,i[o++]=y}this._indexBuffer.setData(i)}}},s._destroy=function(){t.prototype._destroy.call(this),this._owner.displayedInStage&&this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer(),this._vertexBuffer.dispose(),this._indexBuffer.dispose(),this._emission._destroy(),this._owner=null,this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},s.emit=function(t){var i=e._tempPosition,n=e._tempDirection;if(this._shape.enable)this.autoRandomSeed?this._shape.generatePositionAndDirection(i,n):this._shape.generatePositionAndDirection(i,n,this._rand,this._randomSeeds);else{var r=i.elements,a=n.elements;r[0]=r[1]=r[2]=0,a[0]=a[1]=0,a[2]=1}return this.addParticle(i,n,t)},s.addParticle=function(t,e,i){_e.normalize(e,e);var n=this._firstFreeElement+1;if(n>=this._bufferMaxParticles&&(n=0),n===this._firstRetiredElement)return!1;at.create(this,this._ownerRender,this._owner.transform);var r=this._currentTime-i;if(r>=at.startLifeTime)return!0;var a=NaN,s=NaN,o=NaN,h=NaN,l=NaN,u=NaN,c=NaN,_=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(_){var d=this._velocityOverLifetime.velocity.type;2===d||3===d?this.autoRandomSeed?(a=Math.random(),s=Math.random(),o=Math.random()):(this._rand.seed=this._randomSeeds[9],a=this._rand.getFloat(),s=this._rand.getFloat(),o=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):_=!1}else _=!1;var f=this._colorOverLifetime&&this._colorOverLifetime.enbale;if(f){var p=this._colorOverLifetime.color.type;3===p?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[10],h=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):f=!1}else f=!1;var m=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;if(m){var g=this._sizeOverLifetime.size.type;3===g?this.autoRandomSeed?l=Math.random():(this._rand.seed=this._randomSeeds[11],l=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):m=!1}else m=!1;var y=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(y){var x=this._rotationOverLifetime.angularVelocity.type;2===x||3===x?this.autoRandomSeed?u=Math.random():(this._rand.seed=this._randomSeeds[12],u=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):y=!1}else y=!1;var v=this._textureSheetAnimation&&this._textureSheetAnimation.enable;if(v){var S=this._textureSheetAnimation.frame.type;3===S?this.autoRandomSeed?c=Math.random():(this._rand.seed=this._randomSeeds[15],c=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):v=!1}else v=!1;var T,E=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,w=at.startUVInfo[0],b=at.startUVInfo[1],C=at.startUVInfo[2],M=at.startUVInfo[3],D=t.elements,A=e.elements,R=0,I=0,P=0,L=0,N=this._ownerRender;if(4===N.renderMode){var O=N.mesh._vertexBuffers[0];T=O.getData();var V=O.vertexDeclaration;P=V.getVertexElementByUsage(0).offset/4,I=V.getVertexElementByUsage(2).offset/4,R=V.vertexStride/4,L=0}else{this._vertices[E+2]=C,this._vertices[E+3]=M+b;var F=E+this._floatCountPerVertex;this._vertices[F+2]=C+w,this._vertices[F+3]=M+b;var B=F+this._floatCountPerVertex;this._vertices[B+2]=C+w,this._vertices[B+3]=M;var U=B+this._floatCountPerVertex;this._vertices[U+2]=C,this._vertices[U+3]=M}for(var k=E,H=E+this._floatCountPerVertex*this._vertexStride;H>k;k+=this._floatCountPerVertex){var z=0;if(4===N.renderMode){z=k;var W=R*L++,G=W+P;this._vertices[z++]=T[G+0],this._vertices[z++]=T[G+1],this._vertices[z++]=T[G+2];var j=W+I;this._vertices[z++]=C+T[j]*w,this._vertices[z++]=M+T[++j]*b}else z=k+4;switch(this._vertices[z++]=D[0],this._vertices[z++]=D[1],this._vertices[z++]=D[2],this._vertices[z++]=at.startLifeTime,this._vertices[z++]=A[0],this._vertices[z++]=A[1],this._vertices[z++]=A[2],this._vertices[z++]=i,this._vertices[z++]=at.startColor[0],this._vertices[z++]=at.startColor[1],this._vertices[z++]=at.startColor[2],this._vertices[z++]=at.startColor[3],this._vertices[z++]=at.startSize[0],this._vertices[z++]=at.startSize[1],this._vertices[z++]=at.startSize[2],this._vertices[z++]=at.startRotation[0],this._vertices[z++]=at.startRotation[1],this._vertices[z++]=at.startRotation[2],this._vertices[z++]=at.startSpeed,f&&(this._vertices[z+1]=h),m&&(this._vertices[z+2]=l),y&&(this._vertices[z+3]=u),v&&(this._vertices[z+4]=c),_&&(this._vertices[z+5]=a,this._vertices[z+6]=s,this._vertices[z+7]=o),this.simulationSpace){case 0:z+=8,this._vertices[z++]=at.simulationWorldPostion[0],this._vertices[z++]=at.simulationWorldPostion[1],this._vertices[z++]=at.simulationWorldPostion[2],this._vertices[z++]=at.simulationWorldRotation[0],this._vertices[z++]=at.simulationWorldRotation[1],this._vertices[z++]=at.simulationWorldRotation[2],this._vertices[z++]=at.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=n,!0},s.addNewParticlesToVertexBuffer=function(){var t=0;this._firstNewElement<this._firstFreeElement?(t=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(t=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},s._beforeRender=function(t){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement?(this._vertexBuffer._bind(),this._indexBuffer._bind(),!0):!1},s._render=function(t){var e=0,i=P.mainContext;this._firstActiveElement<this._firstFreeElement?(e=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,i.drawElements(4,e,5123,2*this._firstActiveElement*this._indexStride),D.trianglesFaces+=e/3,D.drawCall++):(e=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,
i.drawElements(4,e,5123,2*this._firstActiveElement*this._indexStride),D.trianglesFaces+=e/3,D.drawCall++,this._firstFreeElement>0&&(e=this._firstFreeElement*this._indexStride,i.drawElements(4,e,5123,0),D.trianglesFaces+=e/3,D.drawCall++))},s.play=function(){if(this._burstsIndex=0,this._isPlaying=!0,this._isPaused=!1,this._frameTime=0,this._emissionTime=0,!this.autoRandomSeed)for(var t=0,i=this._randomSeeds.length;i>t;t++)this._randomSeeds[t]=this.randomSeed[0]+e._RANDOMOFFSET[t];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=S.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=S.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._startUpdateLoopCount=D.loopCount,this.event("played")},s.pause=function(){this._isPaused=!0,this.event("paused")},s.simulate=function(t,e){void 0===e&&(e=!0),this._simulateUpdate=!0,e?this._updateParticlesSimulationRestart(t):(this._isPaused=!1,this._updateParticles(t)),this.pause()},s.stop=function(){this._burstsIndex=0,this._frameTime=0,this._isPlaying=!1,this._emissionTime=0,this._playbackTime=0,this.event("stopped")},s.cloneTo=function(t){var e=t;e.duration=this.duration,e.looping=this.looping,e.prewarm=this.prewarm,e.startDelayType=this.startDelayType,e.startDelay=this.startDelay,e.startDelayMin=this.startDelayMin,e.startDelayMax=this.startDelayMax,e.startLifetimeType=this.startLifetimeType,e.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(e.startLifeTimeGradient),e.startLifetimeConstantMin=this.startLifetimeConstantMin,e.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(e.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(e.startLifeTimeGradientMax),e.startSpeedType=this.startSpeedType,e.startSpeedConstant=this.startSpeedConstant,e.startSpeedConstantMin=this.startSpeedConstantMin,e.startSpeedConstantMax=this.startSpeedConstantMax,e.threeDStartSize=this.threeDStartSize,e.startSizeType=this.startSizeType,e.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(e.startSizeConstantSeparate),e.startSizeConstantMin=this.startSizeConstantMin,e.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(e.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(e.startSizeConstantMaxSeparate),e.threeDStartRotation=this.threeDStartRotation,e.startRotationType=this.startRotationType,e.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(e.startRotationConstantSeparate),e.startRotationConstantMin=this.startRotationConstantMin,e.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(e.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(e.startRotationConstantMaxSeparate),e.randomizeRotationDirection=this.randomizeRotationDirection,e.startColorType=this.startColorType,this.startColorConstant.cloneTo(e.startColorConstant),this.startColorConstantMin.cloneTo(e.startColorConstantMin),this.startColorConstantMax.cloneTo(e.startColorConstantMax),e.gravityModifier=this.gravityModifier,e.simulationSpace=this.simulationSpace,e.scaleMode=this.scaleMode,e.playOnAwake=this.playOnAwake,e.maxParticles=this.maxParticles,this.emission&&(e.emission=this.emission.clone()),this.shape&&(e.shape=this.shape.clone()),this.velocityOverLifetime&&(e.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(e.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(e.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(e.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(e.textureSheetAnimation=this.textureSheetAnimation.clone()),e.isPerformanceMode=this.isPerformanceMode,e._isPlaying=this._isPlaying,e._isPaused=this._isPaused,e._playStartDelay=this._playStartDelay,e._frameTime=this._frameTime,e._emissionTime=this._emissionTime,e._playbackTime=this._playbackTime,e._burstsIndex=this._burstsIndex},s.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},s._renderRuntime=function(t,e,i){},a(0,s,"maxParticles",function(){return this._bufferMaxParticles-1},function(t){var e=t+1;e!==this._bufferMaxParticles&&(this._bufferMaxParticles=e,this._vertexBuffer&&(this._vertexBuffer.dispose(),this._indexBuffer.dispose()),this._initBufferDatas())}),a(0,s,"isAlive",function(){return this._isPlaying||this.aliveParticleCount>0?!0:!1}),a(0,s,"shape",function(){return this._shape},function(t){this._shape!==t&&(t&&t.enable?this._ownerRender._addShaderDefine(Fi.SHADERDEFINE_SHAPE):this._ownerRender._removeShaderDefine(Fi.SHADERDEFINE_SHAPE),this._shape=t,this._emission._shape=t)}),a(0,s,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(t){var e=this._ownerRender;if(t){var i=t.angularVelocity;if(!i)return;var n=i.separateAxes,r=i.type;if(t.enbale)switch(n?e._addShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):e._addShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIME),r){case 0:e._addShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:e._addShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:e._addShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:e._addShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIME),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(r){case 0:n?e._setShaderValueColor(35,i.constantSeparate):e._setShaderValueNumber(34,i.constant);break;case 1:n?(e._setShaderValueBuffer(37,i.gradientX._elements),e._setShaderValueBuffer(38,i.gradientY._elements),e._setShaderValueBuffer(39,i.gradientZ._elements),e._setShaderValueBuffer(40,i.gradientW._elements)):e._setShaderValueBuffer(36,i.gradient._elements);break;case 2:n?(e._setShaderValueColor(35,i.constantMinSeparate),e._setShaderValueColor(42,i.constantMaxSeparate)):(e._setShaderValueNumber(34,i.constantMin),e._setShaderValueNumber(41,i.constantMax));break;case 3:n?(e._setShaderValueBuffer(37,i.gradientXMin._elements),e._setShaderValueBuffer(44,i.gradientXMax._elements),e._setShaderValueBuffer(38,i.gradientYMin._elements),e._setShaderValueBuffer(45,i.gradientYMax._elements),e._setShaderValueBuffer(39,i.gradientZMin._elements),e._setShaderValueBuffer(46,i.gradientZMax._elements),e._setShaderValueBuffer(40,i.gradientWMin._elements),e._setShaderValueBuffer(47,i.gradientWMax._elements)):(e._setShaderValueBuffer(36,i.gradientMin._elements),e._setShaderValueBuffer(43,i.gradientMax._elements))}}else e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIME),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),e._removeShaderDefine(Fi.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),e._setShaderValueColor(35,null),e._setShaderValueColor(42,null),e._setShaderValueNumber(34,void 0),e._setShaderValueNumber(41,void 0),e._setShaderValueBuffer(37,null),e._setShaderValueBuffer(44,null),e._setShaderValueBuffer(38,null),e._setShaderValueBuffer(45,null),e._setShaderValueBuffer(39,null),e._setShaderValueBuffer(46,null),e._setShaderValueBuffer(40,null),e._setShaderValueBuffer(47,null),e._setShaderValueBuffer(36,null),e._setShaderValueBuffer(43,null);this._rotationOverLifetime=t}),a(0,s,"emission",function(){return this._emission},function(t){this._emission=t,t._particleSystem=this,t._shape=this._shape}),a(0,s,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),a(0,s,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),a(0,s,"playbackTime",function(){return this._playbackTime}),a(0,s,"isPlaying",function(){return this._isPlaying}),a(0,s,"isPaused",function(){return this._isPaused}),a(0,s,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(t){var e=this._ownerRender;if(t){var i=t.velocity,n=i.type;if(t.enbale)switch(n){case 0:e._addShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:e._addShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:e._addShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:e._addShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else e._removeShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),e._removeShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),e._removeShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),e._removeShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(n){case 0:e._setShaderValueColor(13,i.constant);break;case 1:e._setShaderValueBuffer(14,i.gradientX._elements),e._setShaderValueBuffer(15,i.gradientY._elements),e._setShaderValueBuffer(16,i.gradientZ._elements);break;case 2:e._setShaderValueColor(13,i.constantMin),e._setShaderValueColor(17,i.constantMax);break;case 3:e._setShaderValueBuffer(14,i.gradientXMin._elements),e._setShaderValueBuffer(18,i.gradientXMax._elements),e._setShaderValueBuffer(15,i.gradientYMin._elements),e._setShaderValueBuffer(19,i.gradientYMax._elements),e._setShaderValueBuffer(16,i.gradientZMin._elements),e._setShaderValueBuffer(20,i.gradientZMax._elements)}e._setShaderValueInt(21,t.space)}else e._removeShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),e._removeShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),e._removeShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),e._removeShaderDefine(Fi.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),e._setShaderValueColor(13,null),e._setShaderValueBuffer(14,null),e._setShaderValueBuffer(15,null),e._setShaderValueBuffer(16,null),e._setShaderValueColor(13,null),e._setShaderValueColor(17,null),e._setShaderValueBuffer(14,null),e._setShaderValueBuffer(18,null),e._setShaderValueBuffer(15,null),e._setShaderValueBuffer(19,null),e._setShaderValueBuffer(16,null),e._setShaderValueBuffer(20,null),e._setShaderValueInt(21,void 0);this._velocityOverLifetime=t}),a(0,s,"colorOverLifetime",function(){return this._colorOverLifetime},function(t){var e=this._ownerRender;if(t){var i=t.color;if(t.enbale)switch(i.type){case 1:e._addShaderDefine(Fi.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:e._addShaderDefine(Fi.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else e._removeShaderDefine(Fi.SHADERDEFINE_COLOROVERLIFETIME),e._removeShaderDefine(Fi.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(i.type){case 1:var n=i.gradient;e._setShaderValueBuffer(22,n._alphaElements),e._setShaderValueBuffer(23,n._rgbElements);break;case 3:var r=i.gradientMin,a=i.gradientMax;e._setShaderValueBuffer(22,r._alphaElements),e._setShaderValueBuffer(23,r._rgbElements),e._setShaderValueBuffer(24,a._alphaElements),e._setShaderValueBuffer(25,a._rgbElements)}}else e._removeShaderDefine(Fi.SHADERDEFINE_COLOROVERLIFETIME),e._removeShaderDefine(Fi.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),e._setShaderValueBuffer(22,n._alphaElements),e._setShaderValueBuffer(23,n._rgbElements),e._setShaderValueBuffer(22,r._alphaElements),e._setShaderValueBuffer(23,r._rgbElements),e._setShaderValueBuffer(24,a._alphaElements),e._setShaderValueBuffer(25,a._rgbElements);this._colorOverLifetime=t}),a(0,s,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(t){var e=this._ownerRender;if(t){var i=t.size,n=i.separateAxes,r=i.type;if(t.enbale)switch(r){case 0:n?e._addShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):e._addShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:n?e._addShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):e._addShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else e._removeShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMECURVE),e._removeShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),e._removeShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),e._removeShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(r){case 0:n?(e._setShaderValueBuffer(27,i.gradientX._elements),e._setShaderValueBuffer(28,i.gradientY._elements),e._setShaderValueBuffer(29,i.gradientZ._elements)):e._setShaderValueBuffer(26,i.gradient._elements);break;case 2:n?(e._setShaderValueBuffer(27,i.gradientXMin._elements),e._setShaderValueBuffer(31,i.gradientXMax._elements),e._setShaderValueBuffer(28,i.gradientYMin._elements),e._setShaderValueBuffer(32,i.gradientYMax._elements),e._setShaderValueBuffer(29,i.gradientZMin._elements),e._setShaderValueBuffer(33,i.gradientZMax._elements)):(e._setShaderValueBuffer(26,i.gradientMin._elements),e._setShaderValueBuffer(30,i.gradientMax._elements))}}else e._removeShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMECURVE),e._removeShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),e._removeShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),e._removeShaderDefine(Fi.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),e._setShaderValueBuffer(27,null),e._setShaderValueBuffer(31,null),e._setShaderValueBuffer(28,null),e._setShaderValueBuffer(32,null),e._setShaderValueBuffer(29,null),e._setShaderValueBuffer(33,null),e._setShaderValueBuffer(26,null),e._setShaderValueBuffer(30,null);this._sizeOverLifetime=t}),a(0,s,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(t){var e=this._ownerRender;if(t){var i=t.frame,n=i.type;if(t.enable)switch(n){case 1:e._addShaderDefine(Fi.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:}else e._removeShaderDefine(Fi.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),e._removeShaderDefine(Fi.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===n||3===n){e._setShaderValueInt(48,t.cycles);var r=t.tiles,a=this._uvLength.elements;a[0]=1/r.x,a[1]=1/r.y,e._setShaderValueVector2(49,this._uvLength)}switch(n){case 1:e._setShaderValueBuffer(50,i.frameOverTimeData._elements);break;case 3:e._setShaderValueBuffer(50,i.frameOverTimeDataMin._elements),e._setShaderValueBuffer(51,i.frameOverTimeDataMax._elements)}}else e._removeShaderDefine(Fi.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),e._removeShaderDefine(Fi.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),e._setShaderValueInt(48,void 0),e._setShaderValueVector2(49,null),e._setShaderValueBuffer(50,null),e._setShaderValueBuffer(51,null);this._textureSheetAnimation=t}),a(0,s,"_vertexBufferCount",function(){return 1}),a(0,s,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,s,"_originalBoundingSphere",function(){return this._boundingSphere}),a(0,s,"_originalBoundingBox",function(){return this._boundingBox}),a(0,s,"_originalBoundingBoxCorners",function(){return this._boundingBoxCorners}),e.halfKSqrtOf2=.71,n(e,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3},"_tempVector30",function(){return this._tempVector30=new _e},"_tempVector31",function(){return this._tempVector31=new _e},"_tempVector32",function(){return this._tempVector32=new _e},"_tempVector33",function(){return this._tempVector33=new _e},"_tempVector34",function(){return this._tempVector34=new _e},"_tempVector35",function(){return this._tempVector35=new _e},"_tempVector36",function(){return this._tempVector36=new _e},"_tempVector37",function(){return this._tempVector37=new _e},"_tempVector38",function(){return this._tempVector38=new _e},"_tempVector39",function(){return this._tempVector39=new _e},"_tempPosition",function(){return this._tempPosition=new _e},"_tempDirection",function(){return this._tempDirection=new _e}]),e}(Pe),ai=function(t){function e(t){this._finalGravity=new _e,this._tempRotationMatrix=new ae,e.__super.call(this,t),this._defaultBoundBox=new Jt(new _e,new _e),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}r(e,"laya.d3.core.particleShuriKen.ShurikenParticleRender",t);var i=e.prototype;return i._calculateBoundingBox=function(){var t=this._boundingBox.min.elements;t[0]=-Number.MAX_VALUE,t[1]=-Number.MAX_VALUE,t[2]=-Number.MAX_VALUE;var e=this._boundingBox.min.elements;e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},i._calculateBoundingSphere=function(){var t=this._boundingSphere.center.elements;t[0]=0,t[1]=0,t[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},i._renderUpdate=function(t){var e=this._owner.particleSystem,i=this._owner.transform;switch(e.simulationSpace){case 0:break;case 1:this._setShaderValueColor(0,i.position),this._setShaderValueColor(1,i.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(e.scaleMode){case 0:var n=i.scale;this._setShaderValueColor(4,n),this._setShaderValueColor(5,n);break;case 1:var r=i.localScale;this._setShaderValueColor(4,r),this._setShaderValueColor(5,r);break;case 2:this._setShaderValueColor(4,i.scale),this._setShaderValueColor(5,_e.ONE)}var a=this._finalGravity.elements,s=we.gravity.elements,o=e.gravityModifier;a[0]=s[0]*o,a[1]=s[1]*o,a[2]=s[2]*o,this._setShaderValueBuffer(7,a),this._setShaderValueInt(11,e.simulationSpace),this._setShaderValueBool(8,e.threeDStartRotation),this._setShaderValueInt(6,e.scaleMode),this._setShaderValueInt(9,this.stretchedBillboardLengthScale),this._setShaderValueInt(10,this.stretchedBillboardSpeedScale),this._setShaderValueNumber(12,e._currentTime),Ae.debugMode&&this._renderRenderableBoundBox()},a(0,i,"boundingBox",function(){return this._owner.particleSystem.isAlive?(this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox):this._defaultBoundBox}),a(0,i,"renderMode",function(){return this._renderMode},function(t){if(this._renderMode!==t){switch(this._renderMode){case 0:this._removeShaderDefine(Fi.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._removeShaderDefine(Fi.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._removeShaderDefine(Fi.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._removeShaderDefine(Fi.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._removeShaderDefine(Fi.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=t,t){case 0:this._addShaderDefine(Fi.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._addShaderDefine(Fi.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._addShaderDefine(Fi.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._addShaderDefine(Fi.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._addShaderDefine(Fi.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}this._owner.particleSystem._initBufferDatas()}}),a(0,i,"mesh",function(){return this._mesh},function(t){this._mesh!==t&&(this._mesh=t,this._owner.particleSystem._initBufferDatas())}),e}(Le),si=function(t){function e(t){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=NaN,this.lifeTime=NaN,this.minSegmentDistance=NaN,this.minInterpDistance=NaN,this.maxSlerpCount=0,this._maxSegments=0,e.__super.call(this),this._tempVector0=new _e,this._tempVector1=new _e,this._tempVector2=new _e,this._tempVector3=new _e,this._posModeLastPosition0=new _e,this._posModeLastPosition1=new _e,this._posModePosition0=new _e,this._posModePosition1=new _e,this._posVelModePosition0=new _e,this._posVelModeVelocity0=new _e,this._posVelModePosition1=new _e,this._posVelModeVelocity1=new _e,this._owner=t,this._lastTime=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this._lastPatchAddPos0=new _e,this._lastPatchAddPos1=new _e,this.scLeft=new B,this.scRight=new B,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this._maxSegments=200,this._owner.on("activeinhierarchychanged",this,this._onActiveHierarchyChanged)}r(e,"laya.d3.resource.tempelet.GlitterTemplet",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},n._getIndexBuffer=function(){return null},n._initialize=function(){this._vertexBuffer=Si.create(yt.vertexDeclaration,2*this.maxSegments,35048),this._vertices=new Float32Array(this.maxSegments*this._floatCountPerVertex*2)},n._onActiveHierarchyChanged=function(t){t||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},n._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},n._updateSubTextureCoordinates=function(t,e){for(var i=2*t,n=0;e>n;n+=2){var r=i+n,a=r*this._floatCountPerVertex,s=(r+1)*this._floatCountPerVertex;this._vertices[a+3]=this._vertices[s+3]=(this._vertices[a+5]-this._currentTime)/this.lifeTime}},n._retireActiveGlitter=function(){for(var t=this.lifeTime,e=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var i=this._firstActiveElement*e+5,n=this._currentTime-this._vertices[i];if(t>n)break;this._vertices[i]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.maxSegments&&(this._firstActiveElement=0)}},n._freeRetiredGlitter=function(){for(var t=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement;){var e=this._drawCounter-this._vertices[this._firstRetiredElement*t+5];if(3>e)break;this._firstRetiredElement++,this._firstRetiredElement>=this.maxSegments&&(this._firstRetiredElement=0)}},n._calcVelocity=function(t,e,i){_e.subtract(t,e,i),_e.scale(i,.5,i)},n._addNewGlitterSegementToVertexBuffer=function(){var t=0;this._firstActiveElement<this._firstFreeElement?(t=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(t=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,2*(this.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},n._addGlitter=function(t,e,i){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));var n=this._firstFreeElement+1;if(n>=this.maxSegments&&(n=0,t.cloneTo(this._lastPatchAddPos0),e.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=i,this._needPatch=!0),n===this._firstRetiredElement)throw new Error("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency.");var r=t.elements,a=e.elements,s=0,o=this._firstFreeElement*this._floatCountPerVertex*2;for(s=0;3>s;s++)this._vertices[o+s]=r[s];this._vertices[o+3]=0,this._vertices[o+4]=0,this._vertices[o+5]=i;var h=o+this._floatCountPerVertex;for(s=0;3>s;s++)this._vertices[h+s]=a[s];this._vertices[h+3]=0,this._vertices[h+4]=1,this._vertices[h+5]=i,this._firstFreeElement=n},n._update=function(t){this._currentTime+=t/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},n._beforeRender=function(t){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement?(this._vertexBuffer.bindWithIndexBuffer(null),!0):!1},n._render=function(t){var e=0,i=P.mainContext;this._firstActiveElement<this._firstFreeElement?(e=2*(this._firstFreeElement-this._firstActiveElement),i.drawArrays(5,2*this._firstActiveElement,e),D.trianglesFaces+=e-2,D.drawCall++):(e=2*(this.maxSegments-this._firstActiveElement),i.drawArrays(5,2*this._firstActiveElement,e),D.trianglesFaces+=e-2,D.drawCall++,this._firstFreeElement>0&&(e=2*this._firstFreeElement,i.drawArrays(5,0,e),D.trianglesFaces+=e-2,D.drawCall++))},n.addVertexPosition=function(t,e){if(this._owner.activeInHierarchy)if(this._numPositionMode<2)0===this._numPositionMode?(t.cloneTo(this._posModeLastPosition0),e.cloneTo(this._posModeLastPosition1)):(t.cloneTo(this._posModePosition0),e.cloneTo(this._posModePosition1)),this._numPositionMode++;else{var i=this._tempVector2;this._calcVelocity(t,this._posModeLastPosition0,i);var n=this._tempVector3;this._calcVelocity(e,this._posModeLastPosition1,n),this.addVertexPositionVelocity(this._posModePosition0,i,this._posModePosition1,n),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),t.cloneTo(this._posModePosition0),e.cloneTo(this._posModePosition1)}},n.addVertexPositionVelocity=function(t,e,i,n){if(this._owner.activeInHierarchy){if(0===this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r=this._tempVector0;_e.subtract(t,this._posVelModePosition0,r);var a=_e.scalarLength(r);_e.subtract(i,this._posVelModePosition1,r);var s=_e.scalarLength(r),o=0,h=h;if(h>a&&h>s)return;if(o=1+Math.floor(Math.max(a,s)/this.minInterpDistance),1===o)this._addGlitter(t,i,this._currentTime);else{o=Math.min(o,this.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,t,e),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,i,n);for(var l=1/o,u=l,c=this._currentTime-this._lastTime,_=1;o>=_;_++){var d=this._tempVector0;this.scLeft.Slerp(u,d);var f=this._tempVector1;this.scRight.Slerp(u,f);var p=this._lastTime+c*_/o;this._addGlitter(d,f,p),u+=l}}}this._lastTime=this._currentTime,t.cloneTo(this._posVelModePosition0),e.cloneTo(this._posVelModeVelocity0),i.cloneTo(this._posVelModePosition1),n.cloneTo(this._posVelModeVelocity1)}},n._destroy=function(){t.prototype._destroy.call(this),this._tempVector0=null,this._tempVector1=null,this._tempVector2=null,this._tempVector3=null,this._owner=null,this._vertices=null,this._vertexBuffer.dispose(),this._vertexBuffer=null,this.scLeft=null,this.scRight=null,this._posModeLastPosition0=null,this._posModeLastPosition1=null,this._posModePosition0=null,this._posModePosition1=null,this._posVelModePosition0=null,this._posVelModeVelocity0=null,this._posVelModePosition1=null,this._posVelModeVelocity1=null,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null},n._renderRuntime=function(t,e,i){},a(0,n,"maxSegments",function(){return this._maxSegments-1},function(t){var e=t+1;e!==this._maxSegments&&(this._maxSegments=e,this._vertexBuffer&&this._vertexBuffer.dispose(),this._initialize())}),a(0,n,"_vertexBufferCount",function(){return 1}),a(0,n,"triangleCount",function(){var t=0;return this._firstActiveElement<this._firstFreeElement?t=2*(this._firstFreeElement-this._firstActiveElement)-2:(t=2*(this.maxSegments-this._firstActiveElement)-2,t+=2*this._firstFreeElement-2),t}),a(0,n,"_originalBoundingSphere",function(){return t.prototype._$get__originalBoundingSphere.call(this)}),a(0,n,"_originalBoundingBox",function(){return t.prototype._$get__originalBoundingBox.call(this)}),e}(Pe),oi=function(t){function e(t,i,n,r,a,o,h,l){this._owner=null,this._gridSize=NaN,this.memorySize=0,this._numberVertices=0,this._maxNumberIndices=0,this._currentNumberIndices=0,this._numberTriangle=0,this._vertexBuffer=null,this._indexBuffer=null,this._boundingSphere=null,this._boundingBox=null,this._indexArrayBuffer=null,this._boundingBoxCorners=null,this._leafs=null,this._leafNum=0,this._terrainHeightData=null,this._terrainHeightDataWidth=0,this._terrainHeightDataHeight=0,this._chunkOffsetX=0,this._chunkOffsetZ=0,this._cameraCoordinateInverse=!1,this._cameraPos=null,this._currentLOD=0,this._perspectiveFactor=NaN,this._LODTolerance=0,e.__super.call(this),this._owner=t,this._cameraPos=new _e,this._chunkOffsetX=i,this._chunkOffsetZ=n,this._gridSize=r,this._terrainHeightData=a,this._terrainHeightDataWidth=o,this._terrainHeightDataHeight=h,this._leafNum=ve.CHUNK_GRID_NUM/ve.LEAF_GRID_NUM*(ve.CHUNK_GRID_NUM/ve.LEAF_GRID_NUM),this._leafs=s(this._leafNum),this._cameraCoordinateInverse=l;for(var u=0;u<this._leafNum;u++)this._leafs[u]=new ve;this.recreateResource()}r(e,"laya.d3.terrain.TerrainFilter",t);var o=e.prototype;return i.imps(o,{"laya.d3.core.render.IRenderable":!0}),o._destroy=function(){t.prototype._destroy.call(this),this._owner=null,this._vertexBuffer&&this._vertexBuffer.dispose(),this._indexBuffer&&this._indexBuffer.dispose()},o.recreateResource=function(){this._currentNumberIndices=0,this._numberTriangle=0;var t=ve.LEAF_VERTEXT_COUNT,e=ve.LEAF_MAX_INDEX_COUNT;this._numberVertices=t*this._leafNum,this._maxNumberIndices=e*this._leafNum,this._indexArrayBuffer=new Uint16Array(this._maxNumberIndices);var i=jt.vertexDeclaration,n=i.vertexStride/4,r=new Float32Array(this._numberVertices*n),a=ve.CHUNK_GRID_NUM/ve.LEAF_GRID_NUM,s=0,o=0,h=0;for(s=0;s<this._leafNum;s++)o=s%a,h=Math.floor(s/a),this._leafs[s].calcVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*ve.LEAF_GRID_NUM,h*ve.LEAF_GRID_NUM,this._gridSize,r,s*ve.LEAF_PLANE_VERTEXT_COUNT,n,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight,this._cameraCoordinateInverse);for(s=0;s<this._leafNum;s++)o=s%a,h=Math.floor(s/a),this._leafs[s].calcSkirtVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*ve.LEAF_GRID_NUM,h*ve.LEAF_GRID_NUM,this._gridSize,r,this._leafNum*ve.LEAF_PLANE_VERTEXT_COUNT+s*ve.LEAF_SKIRT_VERTEXT_COUNT,n,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight);this.assembleIndexInit(),this._vertexBuffer=new Si(i,this._numberVertices,35044,!1),this._indexBuffer=new vi("ushort",this._maxNumberIndices,35044,!1),this._vertexBuffer.setData(r),this._indexBuffer.setData(this._indexArrayBuffer),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.calcOriginalBoudingBoxAndSphere()},o.setLODLevel=function(t){if(4!=t.length)return!0;var e=(t[0]+1<<24)+(t[1]+1<<16)+(t[2]+1<<8)+(t[3]+1);return this._currentLOD==e?!1:(this._currentLOD=e,!0)},o.assembleIndexInit=function(){this._currentNumberIndices=0,this._numberTriangle=0;for(var t=0,e=0;e<this._leafNum;e++){var i=ve.getPlaneLODIndex(e,0);this._indexArrayBuffer.set(i,t),t+=i.length;var n=ve.getSkirtLODIndex(e,0);
this._indexArrayBuffer.set(n,t),t+=n.length,this._currentNumberIndices+=i.length+n.length}this._numberTriangle=this._currentNumberIndices/3},o.isNeedAssemble=function(t,e){var i=Math.min(t.viewport.width,t.viewport.height)/(2*Math.tan(Math.PI*t.fieldOfView/180));return this._perspectiveFactor!=i?(this._perspectiveFactor=i,1):this._LODTolerance!=Ei.LOD_TOLERANCE_VALUE?(this._LODTolerance=Ei.LOD_TOLERANCE_VALUE,1):0==_e.equals(e,this._cameraPos)?(this._cameraPos.x=e.x,this._cameraPos.y=e.y,this._cameraPos.z=e.z,2):0},o.assembleIndex=function(t,i){var n=this.isNeedAssemble(t,i);if(n>0){for(var r=0;r<this._leafNum;r++)e._TEMP_ARRAY_BUFFER[r]=this._leafs[r].determineLod(i,this._perspectiveFactor,Ei.LOD_TOLERANCE_VALUE,1==n);if(this.setLODLevel(e._TEMP_ARRAY_BUFFER)){this._currentNumberIndices=0,this._numberTriangle=0;var a=0;for(r=0;r<this._leafNum;r++){var s=e._TEMP_ARRAY_BUFFER[r],o=ve.getPlaneLODIndex(r,s);this._indexArrayBuffer.set(o,a),a+=o.length;var h=ve.getSkirtLODIndex(r,s);this._indexArrayBuffer.set(h,a),a+=h.length,this._currentNumberIndices+=o.length+h.length}return this._numberTriangle=this._currentNumberIndices/3,!0}}return!1},o.calcOriginalBoudingBoxAndSphere=function(){for(var t=new ce(2147483647,-2147483647),e=0;e<this._leafNum;e++)t.x=this._leafs[e]._sizeOfY.x<t.x?this._leafs[e]._sizeOfY.x:t.x,t.y=this._leafs[e]._sizeOfY.y>t.y?this._leafs[e]._sizeOfY.y:t.y;var i=new _e(this._chunkOffsetX*ve.CHUNK_GRID_NUM*this._gridSize,t.x,this._chunkOffsetZ*ve.CHUNK_GRID_NUM*this._gridSize),n=new _e((this._chunkOffsetX+1)*ve.CHUNK_GRID_NUM*this._gridSize,t.y,(this._chunkOffsetZ+1)*ve.CHUNK_GRID_NUM*this._gridSize);ve.__ADAPT_MATRIX__&&(_e.transformV3ToV3(i,ve.__ADAPT_MATRIX__,i),_e.transformV3ToV3(n,ve.__ADAPT_MATRIX__,n)),this._boundingBox=new Jt(i,n);var r=new _e;_e.subtract(n,i,r),_e.scale(r,.5,r);var a=new _e;_e.add(i,r,a),this._boundingSphere=new ee(a,_e.scalarLength(r)),this._boundingBoxCorners=[],this._boundingBoxCorners.length=8,this._boundingBox.getCorners(this._boundingBoxCorners)},o.calcLeafBoudingBox=function(t){for(var e=0;e<this._leafNum;e++)this._leafs[e].calcLeafBoudingBox(t)},o.calcLeafBoudingSphere=function(t,e){for(var i=0;i<this._leafNum;i++)this._leafs[i].calcLeafBoudingSphere(t,e)},o._getVertexBuffer=function(t){return void 0===t&&(t=0),0==t?this._vertexBuffer:null},o._getIndexBuffer=function(){return this._indexBuffer},o._beforeRender=function(t){this._vertexBuffer._bind(),this._indexBuffer._bind();var e=t.renderElement._material;if(0==e.blend){var i=t.camera;this.assembleIndex(i,i.position)&&this._indexBuffer.setData(this._indexArrayBuffer)}return!0},o._render=function(t){P.mainContext.drawElements(Ei.RENDER_LINE_MODEL?1:4,this._currentNumberIndices,5123,0),D.trianglesFaces+=this._numberTriangle,D.drawCall++},o._renderRuntime=function(t,e,i){},a(0,o,"_originalBoundingSphere",function(){return this._boundingSphere}),a(0,o,"_originalBoundingBox",function(){return this._boundingBox}),a(0,o,"_vertexBufferCount",function(){return this._numberVertices}),a(0,o,"triangleCount",function(){return this._numberTriangle}),n(e,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(ve.CHUNK_GRID_NUM/ve.LEAF_GRID_NUM*ve.CHUNK_GRID_NUM/ve.LEAF_GRID_NUM)}]),e}(Pe),hi=function(t){function e(t){this._terrainSprite3DOwner=null,e.__super.call(this,t),this._terrainSprite3DOwner=t}r(e,"laya.d3.terrain.TerrainRender",t);var i=e.prototype;return i._calculateBoundingSphere=function(){var t=this._terrainSprite3DOwner.terrainFilter;if(null==t)this._boundingSphere.toDefault();else{var e=t._originalBoundingSphere,i=NaN,n=this._terrainSprite3DOwner.transform,r=n.scale;i=r.x>=r.y&&r.x>=r.z?r.x:r.y>=r.z?r.y:r.z,_e.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*i,t.calcLeafBoudingSphere(n.worldMatrix,i)}},i._calculateBoundingBox=function(){var t=this._terrainSprite3DOwner.terrainFilter;if(null==t)this._boundingBox.toDefault();else{for(var e=this._terrainSprite3DOwner.transform.worldMatrix,i=t._boundingBoxCorners,n=0;8>n;n++)_e.transformCoordinate(i[n],e,Le._tempBoundBoxCorners[n]);Jt.createfromPoints(Le._tempBoundBoxCorners,this._boundingBox),t.calcLeafBoudingBox(e)}},i._renderUpdate=function(t){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var e=this._owner.getProjectionViewWorldMatrix(t);this._setShaderValueMatrix4x4(1,e)},i._destroy=function(){t.prototype._destroy.call(this),this._terrainSprite3DOwner=null},e}(Le),li=(function(t){function e(t){e.__super.call(this,t)}r(e,"laya.d3.water.WaterRender",t);var i=e.prototype;return i._calculateBoundingSphere=function(){},i._calculateBoundingBox=function(){},i._destroy=function(){t.prototype._destroy.call(this)},e}(Le),function(t){function e(){this.__loaded=!1,this._url=null,this._lightmaps=null,this._enableLightCount=3,this._renderTargetTexture=null,this._customRenderQueneIndex=11,this._lastCurrentTime=NaN,this._enableFog=!1,this._enableDepthFog=!1,this._fogStart=NaN,this._fogRange=NaN,this._fogColor=null,this._shaderValues=null,this._shaderDefineValue=0,this._cullingRendersLength=0,this._cullingRenders=null,this._dynamicBatchManager=null,this.enableLight=!0,this.treeRoot=null,this.treeSize=null,this.treeLevel=0,this.parallelSplitShadowMaps=null,e.__super.call(this),this._renderState=new lt,this._lights=[],this._quenes=[],this._cameraPool=[],this._renderableSprite3Ds=[],this.__loaded=!0,this._lightmaps=[],this._shaderValues=new ye,this.parallelSplitShadowMaps=[],this._dynamicBatchManager=new _t,this._cullingRenders=[],this._cullingRendersLength=0,this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new _e(.7,.7,.7),P.frameShaderHighPrecision&&this.addShaderDefine(me.SHADERDEFINE_FSHIGHPRECISION),this.on("display",this,this._$3__onDisplay),this.on("undisplay",this,this._onUnDisplay)}r(e,"laya.d3.core.scene.Scene",t);var n=e.prototype;return i.imps(n,{"laya.webgl.submit.ISubmit":!0,"laya.resource.ICreateResource":!0}),n.initOctree=function(t,e,i,n,r){void 0===r&&(r=6),this.treeSize=new _e(t,e,i),this.treeLevel=r,this.treeRoot=new ut(this,0),this.treeRoot.init(n,this.treeSize)},n._$3__onDisplay=function(){i.stage._scenes.push(this),i.stage._scenes.sort(e._sortScenes)},n._onUnDisplay=function(){var t=i.stage._scenes;t.splice(t.indexOf(this),1)},n._prepareUpdateToRenderState=function(t,e){e.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,e.scene=this},n._prepareSceneToRender=function(t){var e=this._lights.length;if(e>0)for(var i=0,n=0;e>n&&!(this._lights[n].updateToWorldState(t)&&(i++,i>=this._enableLightCount));n++);},n._updateChilds=function(t){for(var e=0,i=this._childs.length;i>e;++e)this._childs[e]._update(t)},n._updateChildsConch=function(t){for(var e=0,i=this._childs.length;i>e;++e)this._childs[e]._updateConch(t)},n._preRenderScene=function(t,e){var i=e._viewMatrix,n=e._projectionMatrix,r=e._projectionViewMatrix,a=0,s=0,o=e.camera;for(o.useOcclusionCulling?this.treeRoot?dt.renderObjectCullingOctree(e._boundFrustum,this,o,i,n,r):dt.renderObjectCulling(e._boundFrustum,this,o,i,n,r):dt.renderObjectCullingNoBoundFrustum(this,o,i,n,r),a=0,s=this._quenes.length;s>a;a++)this._quenes[a]&&this._quenes[a]._preRender(e)},n._clear=function(t,e){var i=e._viewport,n=e.camera,r=i.x,a=n.renderTargetSize.height-i.y-i.height,s=i.width,o=i.height;t.viewport(r,a,s,o);var h=256,l=n.renderTarget;switch(n.clearFlag){case 0:var u=n.clearColor;if(u){t.enable(3089),t.scissor(r,a,s,o);var c=u.elements;t.clearColor(c[0],c[1],c[2],c[3]),h|=16384}if(l)switch(u||(h=16384),l.depthStencilFormat){case 33189:h|=256;break;case 36168:h|=1024;break;case 34041:h|=256,h|=1024}t.clear(h),u&&t.disable(3089);break;case 1:case 2:if(l)switch(h=16384,l.depthStencilFormat){case 33189:h|=256;break;case 36168:h|=1024;break;case 34041:h|=256,h|=1024}t.clear(h);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},n._renderScene=function(t,e){var i,n=e.camera,r=0,a=0;for(r=0;2>r;r++)i=this._quenes[r],i&&(n.renderTarget?i._render(e,!0):i._render(e,!1));if(1===n.clearFlag){var s=n.sky;s&&(L.setCullFace(t,!1),L.setDepthFunc(t,515),L.setDepthMask(t,!1),s._render(e),L.setDepthFunc(t,513),L.setDepthMask(t,!0))}for(r=2,a=this._quenes.length;a>r;r++)i=this._quenes[r],i&&(i._sortAlpha(e.camera.transform.position),n.renderTarget?i._render(e,!0):i._render(e,!1))},n._set3DRenderConfig=function(t){t.disable(3042),L._blend=!1,t.blendFunc(770,771),L._sFactor=770,L._dFactor=771,t.disable(2929),L._depthTest=!1,t.enable(2884),L._cullFace=!0,t.depthMask(1),L._depthMask=!0,t.frontFace(2304),L._frontFace=2304},n._set2DRenderConfig=function(t){L.setBlend(t,!0),L.setBlendFunc(t,1,771),L.setDepthTest(t,!1),L.setCullFace(t,!1),L.setDepthMask(t,!0),L.setFrontFace(t,2305),t.viewport(0,0,w.width,w.height)},n._parseCustomProps=function(t,e,i){var n=i.customProps.lightmaps,r=n.length,a=this._lightmaps;a.length=r;for(var s=0;r>s;s++)a[s]=x.getRes(t[n[s].replace("exr","png")]);this.setlightmaps(a)},n._addLight=function(t){this._lights.indexOf(t)<0&&this._lights.push(t)},n._removeLight=function(t){var e=this._lights.indexOf(t);e>=0&&this._lights.splice(e,1)},n._updateScene=function(){var t=this._renderState;this._prepareUpdateToRenderState(P.mainContext,t),this.beforeUpdate(t),this._updateChilds(t),this.lateUpdate(t)},n._updateSceneConch=function(){var t=this._renderState;this._prepareUpdateToRenderState(P.mainContext,t),this.beforeUpdate(t),this._updateChildsConch(t),this.lateUpdate(t),this._prepareSceneToRender(t);for(var e=0,i=this._cameraPool.length;i>e;e++){var n=this._cameraPool[e];t.camera=n,n._prepareCameraToRender()}},n._preRenderShadow=function(t,e,i,n,r){this.treeRoot?dt.renderShadowObjectCullingOctree(this,e,i,n,r):dt.renderShadowObjectCulling(this,e,i,n,r);for(var a=0,s=i.length;s>a;a++)i[a]&&i[a]._preRender(t)},n._renderShadowMap=function(t,e,i){var n=this.parallelSplitShadowMaps[0];n._calcAllLightCameraInfo(i);var r=n.PSSMNum;this._preRenderShadow(e,n._lightCulling,n._shadowQuenes,n._lightVPMatrix[0],r),this.addShaderDefine(xe.SHADERDEFINE_CAST_SHADOW);var a,s,o;if(r>1)for(var h=0;r>h;h++)a=n.getRenderTarget(h+1),n.beginRenderTarget(h+1),t.clearColor(1,1,1,1),t.clear(16640),t.viewport(0,0,a.width,a.height),e.camera=o=n.getLightCamera(h),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),e._projectionViewMatrix=n._lightVPMatrix[h+1],s=n._shadowQuenes[h],s._preRender(e),s._renderShadow(e,!1),n.endRenderTarget(h+1);else a=n.getRenderTarget(1),n.beginRenderTarget(1),t.clearColor(1,1,1,1),t.clear(16640),t.viewport(0,0,a.width,a.height),e.camera=o=n.getLightCamera(0),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),e._projectionViewMatrix=n._lightVPMatrix[0],s=n._shadowQuenes[0],s._preRender(e),s._renderShadow(e,!0),n.endRenderTarget(1);this.removeShaderDefine(xe.SHADERDEFINE_CAST_SHADOW)},n.addTreeNode=function(t){this.treeRoot.addTreeNode(t)},n.removeTreeNode=function(t){this.treeSize&&t._treeNode&&t._treeNode.removeObject(t)},n.setlightmaps=function(t){this._lightmaps=t;for(var e=0,i=this._renderableSprite3Ds.length;i>e;e++)this._renderableSprite3Ds[e]._render._applyLightMapParams()},n.getlightmaps=function(){return this._lightmaps},n.addChildAt=function(t,e){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),e>=0&&e<=this._childs.length){if(t._parent===this){var i=this.getChildIndex(t);this._childs.splice(i,1),this._childs.splice(e,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,e)),this._childChanged()}else{t.parent&&t.parent.removeChild(t),this._childs===T.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(e,0,t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,e),t.parent=this;var n=t;n.transform._onWorldTransform(),n._setBelongScene(this),n.active&&n._activeHierarchy()}return t}throw new Error("appendChildAt:The index is out of bounds")},n.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),t._parent===this){var e=this.getChildIndex(t);e!==this._childs.length-1&&(this._childs.splice(e,1),this._childs.push(t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,this._childs.length-1)),this._childChanged())}else{t.parent&&t.parent.removeChild(t),this._childs===T.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,this._childs.length-1),t.parent=this,this._childChanged();var i=t;i.transform._onWorldTransform(),i._setBelongScene(this),i.active&&i._activeHierarchy()}return t},n.removeChildAt=function(t){var e=this.getChildAt(t);if(e){var i=e;i.transform.parent=null,i.active&&i._inActiveHierarchy(),i._setUnBelongScene(),this._childs.splice(t,1),this.conchModel&&this.conchModel.removeChild(e.conchModel),e.parent=null}return e},n.removeChildren=function(t,e){if(void 0===t&&(t=0),void 0===e&&(e=2147483647),this._childs&&this._childs.length>0){var i=this._childs;if(0===t&&e>=a){var n=i;this._childs=T.ARRAY_EMPTY}else n=i.splice(t,e-t);for(var r=0,a=n.length;a>r;r++){n[r].parent=null;var s=n[r];s.transform.parent=null,s.active&&s._inActiveHierarchy(),s._setUnBelongScene(),this.conchModel&&this.conchModel.removeChild(n[r].conchModel)}}return this},n.addFrustumCullingObject=function(t){this.treeRoot?this.addTreeNode(t):(this._cullingRendersLength===this._cullingRenders.length?this._cullingRenders.push(t):this._cullingRenders[this._cullingRendersLength]=t,t._indexInSceneFrustumCullingObjects=this._cullingRendersLength++)},n.removeFrustumCullingObject=function(t){if(this.treeRoot)this.removeTreeNode(t);else{this._cullingRendersLength--;var e=t._indexInSceneFrustumCullingObjects;if(e!==this._cullingRendersLength){var i=this._cullingRenders[this._cullingRendersLength];this._cullingRenders[e]=i,i._indexInSceneFrustumCullingObjects=e,t._indexInSceneFrustumCullingObjects=-1}}},n.getRenderQueue=function(t){return this._quenes[t]||(this._quenes[t]=new ht(this))},n.addRenderQuene=function(){this._quenes[this._customRenderQueneIndex++]=new ht(this)},n.beforeUpdate=function(t){},n.lateUpdate=function(t){},n.beforeRender=function(t){},n.lateRender=function(t){},n.addShaderDefine=function(t){this._shaderDefineValue|=t},n.removeShaderDefine=function(t){this._shaderDefineValue&=~t},n.render=function(e,i,n){E._context.ctx._shader2D.glTexture=null,this._childs.length>0&&e.addRenderObject(this),this._renderType&=-2049,t.prototype.render.call(this,e,i,n)},n.renderSubmit=function(){var t=P.mainContext,e=this._renderState;this._set3DRenderConfig(t),this._prepareSceneToRender(this._renderState);var i,n=0,r=0;if(Ae.debugMode||ut.debugMode)for(n=0,r=this._cameraPool.length;r>n;n++)i=this._cameraPool[n],Ae._debugPhasorSprite.begin(1,i),i.activeInHierarchy&&i._renderCamera(t,e,this),Ae._debugPhasorSprite.end();else for(n=0,r=this._cameraPool.length;r>n;n++)i=this._cameraPool[n],i.activeInHierarchy&&i._renderCamera(t,e,this);return this._set2DRenderConfig(t),1},n.onAsynLoaded=function(t,e,i){if(!this.destroyed){var n=JSON.parse(e[0]);if("Scene"!==n.type)throw new Error("Scene: the .lh file root type must be Scene,please use other function to  load  this file.");var r=e[1];De._createNodeByJson(n,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0}},n.getRenderType=function(){return 0},n.releaseRender=function(){},n.createConchModel=function(){var t=new ConchScene;return t.init(512,512,512,4),t},a(0,n,"_loaded",null,function(t){this.__loaded=t}),a(0,n,"fogColor",function(){return this._fogColor},function(t){this._fogColor=t,this._shaderValues.setValue(0,t.elements)}),a(0,n,"enableFog",function(){return this._enableFog},function(t){this._enableFog!==t&&(this._enableFog=t,t?(this.addShaderDefine(me.SHADERDEFINE_FOG),this.removeShaderDefine(me.SAHDERDEFINE_DEPTHFOG)):this.removeShaderDefine(me.SHADERDEFINE_FOG))}),a(0,n,"url",function(){return this._url},function(t){this._url=t}),a(0,n,"loaded",function(){return this.__loaded}),a(0,n,"enableDepthFog",function(){return this._enableDepthFog},function(t){this._enableDepthFog!=t&&(this._enableDepthFog=t,t?(this.addShaderDefine(me.SAHDERDEFINE_DEPTHFOG),this.removeShaderDefine(me.SHADERDEFINE_FOG)):this.removeShaderDefine(me.SAHDERDEFINE_DEPTHFOG))}),a(0,n,"fogStart",function(){return this._fogStart},function(t){this._fogStart=t,this._shaderValues.setValue(1,t)}),a(0,n,"fogRange",function(){return this._fogRange},function(t){this._fogRange=t,this._shaderValues.setValue(2,t)}),a(0,n,"scene",function(){return this}),a(0,n,"renderableSprite3Ds",function(){return this._renderableSprite3Ds.slice()}),e._sortScenes=function(t,n){if(t.parent===i.stage&&n.parent===i.stage){var r=i.stage._childs;return r.indexOf(t)-r.indexOf(n)}return t.parent!==i.stage&&n.parent!==i.stage?e._sortScenes(t.parent,n.parent):t.parent===i.stage?-1:1},e.load=function(t){return i.loader.create(t,null,null,e)},e.FOGCOLOR=0,e.FOGSTART=1,e.FOGRANGE=2,e.LIGHTDIRECTION=3,e.LIGHTDIRCOLOR=4,e.POINTLIGHTPOS=5,e.POINTLIGHTRANGE=6,e.POINTLIGHTATTENUATION=7,e.POINTLIGHTCOLOR=8,e.SPOTLIGHTPOS=9,e.SPOTLIGHTDIRECTION=10,e.SPOTLIGHTSPOT=11,e.SPOTLIGHTRANGE=12,e.SPOTLIGHTATTENUATION=13,e.SPOTLIGHTCOLOR=14,e.SHADOWDISTANCE=15,e.SHADOWLIGHTVIEWPROJECT=16,e.SHADOWMAPPCFOFFSET=17,e.SHADOWMAPTEXTURE1=18,e.SHADOWMAPTEXTURE2=19,e.SHADOWMAPTEXTURE3=20,e}(M)),ui=function(t){function e(t,n){e.__super.call(this),void 0===t&&(t=.3),void 0===n&&(n=1e3),this._tempVector3=new _e,this._position=new _e,this._up=new _e,this._forward=new _e,this._right=new _e,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=Me.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=t,this._farPlane=n,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),i.stage.on("resize",this,this._onScreenSizeChanged)}r(e,"laya.d3.core.BaseCamera",t);var s=e.prototype;return s.createConchModel=function(){return new ConchCamera},s._sortCamerasByRenderingOrder=function(){if(this._displayedInStage)for(var t=this.scene._cameraPool,e=t.length-1,i=0;e>i;i++)if(t[i].renderingOrder>t[e].renderingOrder){var n=t[i];t[i]=t[e],t[e]=n}},s._calculateProjectionMatrix=function(){},s._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},s._prepareCameraToRender=function(){k._currentCameraCullingMask=this.cullingMask;var t=this._shaderValues;t.setValue(0,this.transform.position.elements),t.setValue(5,this.forward.elements),t.setValue(6,this.up.elements)},s._prepareCameraViewProject=function(t,e){var i=this._shaderValues;i.setValue(1,t.elements),i.setValue(2,e.elements)},s._renderCamera=function(t,e,i){},s.addLayer=function(t){29!==t.number&&30!=t.number&&(this.cullingMask=this.cullingMask|t.mask)},s.removeLayer=function(t){29!==t.number&&30!=t.number&&(this.cullingMask=this.cullingMask&~t.mask)},s.addAllLayers=function(){this.cullingMask=2147483647},s.removeAllLayers=function(){this.cullingMask=0|k.getLayerByNumber(29).mask|k.getLayerByNumber(30).mask},s.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},s.destroy=function(e){void 0===e&&(e=!0),this._sky&&(this._sky._ownerCamera=null,this._sky=null),this.renderTarget=null,i.stage.off("resize",this,this._onScreenSizeChanged),t.prototype.destroy.call(this,e)},s.moveForward=function(t){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=t,this.transform.translate(this._tempVector3)},s.moveRight=function(t){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=t,this.transform.translate(this._tempVector3)},s.moveVertical=function(t){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=t,this.transform.translate(this._tempVector3,!1)},s._addSelfRenderObjects=function(){var t=this.scene._cameraPool,e=t.length;if(e>0){for(var i=e-1;i>=0;i--)if(this.renderingOrder<=t[i].renderingOrder){t.splice(i+1,0,this);break}}else t.push(this),this.scene.conchModel&&this.scene.conchModel.setCurrentCamera(this.conchModel)},s._clearSelfRenderObjects=function(){var t=this.scene._cameraPool;t.splice(t.indexOf(this),1)},a(0,s,"sky",function(){return this._sky},function(t){this._sky=t,t._ownerCamera=this,this.conchModel&&this.conchModel.setSkyMesh(this._sky._conchSky)}),a(0,s,"forward",function(){var t=this.transform.worldMatrix.elements,e=this._forward.elements;return e[0]=-t[8],e[1]=-t[9],e[2]=-t[10],this._forward}),a(0,s,"position",function(){var t=this.transform.worldMatrix.elements,e=this._position.elements;return e[0]=t[12],e[1]=t[13],e[2]=t[14],this._position}),a(0,s,"renderTarget",function(){return this._renderTarget},function(t){this._renderTarget=t,null!=t&&(this._renderTargetSize=t.size)}),a(0,s,"up",function(){var t=this.transform.worldMatrix.elements,e=this._up.elements;return e[0]=t[4],e[1]=t[5],e[2]=t[6],this._up}),a(0,s,"right",function(){var t=this.transform.worldMatrix.elements,e=this._right.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],this._right}),a(0,s,"renderTargetSize",function(){return this._renderTargetSize},function(t){null!=this.renderTarget&&this._renderTargetSize!=t,this._renderTargetSize=t,this._calculateProjectionMatrix()}),a(0,s,"fieldOfView",function(){return this._fieldOfView},function(t){this._fieldOfView=t,this._calculateProjectionMatrix()}),a(0,s,"nearPlane",function(){return this._nearPlane},function(t){this._nearPlane=t,this._calculateProjectionMatrix()}),a(0,s,"farPlane",function(){return this._farPlane},function(t){this._farPlane=t,this._calculateProjectionMatrix()}),a(0,s,"orthographicProjection",function(){return this._orthographic},function(t){this._orthographic=t,this._calculateProjectionMatrix()}),a(0,s,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(t){this._orthographicVerticalSize=t,this._calculateProjectionMatrix()}),a(0,s,"renderingOrder",function(){return this._renderingOrder},function(t){this._renderingOrder=t,this._sortCamerasByRenderingOrder()}),e.CAMERAPOS=0,e.VIEWMATRIX=1,e.PROJECTMATRIX=2,e.VPMATRIX=3,e.VPMATRIX_NO_TRANSLATE=4,e.CAMERADIRECTION=5,e.CAMERAUP=6,e.ENVIRONMENTDIFFUSE=7,e.ENVIRONMENTSPECULAR=8,e.SIMLODINFO=9,e.DIFFUSEIRRADMATR=10,e.DIFFUSEIRRADMATG=11,e.DIFFUSEIRRADMATB=12,e.HDREXPOSURE=13,e.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",e.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",e.CLEARFLAG_SOLIDCOLOR=0,e.CLEARFLAG_SKY=1,e.CLEARFLAG_DEPTHONLY=2,e.CLEARFLAG_NONE=3,n(e,["_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new ae(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1)},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new ae},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new ae}]),e}(We),ci=function(t){function e(t){this._render=null,this._geometryFilter=null,e.__super.call(this,t)}r(e,"laya.d3.core.RenderableSprite3D",t);var i=e.prototype;return i._addToInitStaticBatchManager=function(){},i._setBelongScene=function(e){t.prototype._setBelongScene.call(this,e),e._renderableSprite3Ds.push(this),this._render._applyLightMapParams()},i._setUnBelongScene=function(){var e=this._scene._renderableSprite3Ds,i=e.indexOf(this);e.splice(i,1),this._render._removeShaderDefine(4),t.prototype._setUnBelongScene.call(this)},i._update=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._render._updateOctreeNode(),this._lateUpdateComponents(t),D.spriteCount++,this._childs.length&&this._updateChilds(t))},i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._render._destroy(),this._render=null},i._updateConch=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._render._updateOctreeNode(),this._lateUpdateComponents(t),D.spriteCount++,this._childs.length&&this._updateChildsConch(t))},e.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=2,e.SAHDERDEFINE_LIGHTMAP=4,e.LIGHTMAPSCALEOFFSET=2,e.LIGHTMAP=3,e}(We),_i=function(t){function e(){this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this.color=null,e.__super.call(this),this.color=new _e(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0}r(e,"laya.d3.core.light.LightSprite",t);var i=e.prototype;return i._addSelfRenderObjects=function(){this.scene._addLight(this)},i._clearSelfRenderObjects=function(){this.scene._removeLight(this)},i.updateToWorldState=function(t){return!1},a(0,i,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},function(t){console.log("LightSprite: discard property,please use color property instead."),this.color=t}),a(0,i,"shadow",function(){return this._shadow},function(t){throw new Error("LightSprite: must override it.")}),a(0,i,"shadowDistance",function(){return this._shadowFarPlane},function(t){this._shadowFarPlane=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(t)}),a(0,i,"shadowPSSMCount",function(){return this._shadowMapCount},function(t){this._shadowMapCount=t,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.PSSMNum=t)}),a(0,i,"shadowResolution",function(){return this._shadowMapSize},function(t){this._shadowMapSize=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(t)}),a(0,i,"shadowPCFType",function(){return this._shadowMapPCFType},function(t){this._shadowMapPCFType=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(t)}),a(0,i,"lightType",function(){return-1}),e.TYPE_DIRECTIONLIGHT=1,e.TYPE_POINTLIGHT=2,e.TYPE_SPOTLIGHT=3,e}(We),di=function(t){function e(t,i,n,r,a,s,o,h){if(this.customCompile=!1,this._curActTexIndex=0,this._program=null,this._attributeParams=null,this._uniformParams=null,this._attributeParamsMap=[],this._sceneUniformParamsMap=[],this._cameraUniformParamsMap=[],this._spriteUniformParamsMap=[],this._materialUniformParamsMap=[],this._renderElementUniformParamsMap=[],e.__super.call(this),!t||!i)throw"Shader Error";(E.isConchApp||E.isFlash)&&(this.customCompile=!0),this._id=++e._count,this._vs=t,this._ps=i,this._attributeMap=n,this._sceneUniformMap=r,this._cameraUniformMap=a,this._spriteUniformMap=s,this._materialUniformMap=o,this._renderElementUniformMap=h,this.recreateResource()}r(e,"laya.d3.shader.Shader3D",t);var i=e.prototype;return i.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},i.detoryResource=function(){P.mainContext.deleteShader(this._vshader),P.mainContext.deleteShader(this._pshader),P.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._attributeParams=null,this._uniformParams=null,this.memorySize=0,this._curActTexIndex=0},i._compile=function(){if(this._vs&&this._ps&&!this._attributeParams&&!this._uniformParams){this._reCompile=!0,this._attributeParams=[],this._uniformParams=[];var t,i=[this._vs,this._ps];this.customCompile&&(t=this._preGetParams(this._vs,this._ps));var n=P.mainContext;if(this._program=n.createProgram(),this._vshader=e._createShader(n,i[0],35633),this._pshader=e._createShader(n,i[1],35632),n.attachShader(this._program,this._vshader),n.attachShader(this._program,this._pshader),n.linkProgram(this._program),!this.customCompile&&!n.getProgramParameter(this._program,35714))throw n.getProgramInfoLog(this._program);var r,a,s=0,o=0,h=this.customCompile?t.attributes.length:n.getProgramParameter(this._program,35721);for(s=0;h>s;s++){var l=this.customCompile?t.attributes[s]:n.getActiveAttrib(this._program,s);a=n.getAttribLocation(this._program,l.name),r={vartype:"attribute",ivartype:0,attrib:l,location:a,name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._attributeParams.push(r)}var u=this.customCompile?t.uniforms.length:n.getProgramParameter(this._program,35718);for(s=0;u>s;s++){var c=this.customCompile?t.uniforms[s]:n.getActiveUniform(this._program,s);a=n.getUniformLocation(this._program,c.name),r={vartype:"uniform",ivartype:1,attrib:l,location:a,name:c.name,type:c.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},r.name.indexOf("[0]")>0&&(r.name=r.name.substr(0,r.name.length-3),r.isArray=!0,r.location=n.getUniformLocation(this._program,r.name)),this._uniformParams.push(r)}for(s=0,o=this._attributeParams.length;o>s;s++)r=this._attributeParams[s],r.indexOfParams=s,r.index=1,r.value=[r.location,null],r.codename=r.name,r.name=null!=this._attributeMap[r.codename]?this._attributeMap[r.codename]:r.codename,this._attributeParamsMap.push(r.name),this._attributeParamsMap.push(r),r._this=this,r.uploadedValue=[],r.fun=this._attribute;for(s=0,o=this._uniformParams.length;o>s;s++)switch(r=this._uniformParams[s],r.indexOfParams=s,r.index=1,r.value=[r.location,null],r.codename=r.name,null!=this._sceneUniformMap[r.codename]?(r.name=this._sceneUniformMap[r.codename],this._sceneUniformParamsMap.push(r.name),this._sceneUniformParamsMap.push(r)):null!=this._cameraUniformMap[r.codename]?(r.name=this._cameraUniformMap[r.codename],this._cameraUniformParamsMap.push(r.name),this._cameraUniformParamsMap.push(r)):null!=this._spriteUniformMap[r.codename]?(r.name=this._spriteUniformMap[r.codename],this._spriteUniformParamsMap.push(r.name),this._spriteUniformParamsMap.push(r)):null!=this._materialUniformMap[r.codename]?(r.name=this._materialUniformMap[r.codename],this._materialUniformParamsMap.push(r.name),this._materialUniformParamsMap.push(r)):null!=this._renderElementUniformMap[r.codename]?(r.name=this._renderElementUniformMap[r.codename],this._renderElementUniformParamsMap.push(r.name),this._renderElementUniformParamsMap.push(r)):console.log("Shader:can't find uinform name:"+r.codename+"in shader file."),r._this=this,r.uploadedValue=[],r.type){case 5124:r.fun=r.isArray?this._uniform1iv:this._uniform1i;break;case 5126:r.fun=r.isArray?this._uniform1fv:this._uniform1f;break;case 35664:r.fun=r.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:r.fun=r.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:r.fun=r.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:r.fun=this._uniform_sampler2D;break;case 35680:r.fun=this._uniform_samplerCube;break;case 35676:r.fun=this._uniformMatrix4fv;break;case 35670:r.fun=this._uniform1i;break;case 35674:r.fun=this._uinformMatrix2fv;break;case 35675:r.fun=this._uinformMatrix3fv;break;default:throw new Error("compile shader err!")}}},i._attribute=function(t,e){var i=P.mainContext;return i.enableVertexAttribArray(t.location),i.vertexAttribPointer(t.location,e[0],e[1],e[2],e[3],e[4]),2},i._uniform1f=function(t,e){var i=t.uploadedValue;return i[0]!==e?(P.mainContext.uniform1f(t.location,i[0]=e),1):0},i._uniform1fv=function(t,e){if(e.length<4){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(P.mainContext.uniform1fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return P.mainContext.uniform1fv(t.location,e),1},i._uniform_vec2=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(P.mainContext.uniform2f(t.location,i[0]=e[0],i[1]=e[1]),1):0},i._uniform_vec2v=function(t,e){if(e.length<2){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(P.mainContext.uniform2fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return P.mainContext.uniform2fv(t.location,e),1},i._uniform_vec3=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(P.mainContext.uniform3f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),
1):0},i._uniform_vec3v=function(t,e){return P.mainContext.uniform3fv(t.location,e),1},i._uniform_vec4=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(P.mainContext.uniform4f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0},i._uniform_vec4v=function(t,e){return P.mainContext.uniform4fv(t.location,e),1},i._uniformMatrix2fv=function(t,e){return P.mainContext.uniformMatrix2fv(t.location,!1,e),1},i._uniformMatrix3fv=function(t,e){return P.mainContext.uniformMatrix3fv(t.location,!1,e),1},i._uniformMatrix4fv=function(t,e){return P.mainContext.uniformMatrix4fv(t.location,!1,e),1},i._uinformMatrix2fv=function(t,e){return P.mainContext.uniformMatrix2fv(t.location,!1,e),1},i._uinformMatrix3fv=function(t,e){return P.mainContext.uniformMatrix3fv(t.location,!1,e),1},i._uniform1i=function(t,e){var i=t.uploadedValue;return i[0]!==e?(P.mainContext.uniform1i(t.location,i[0]=e),1):0},i._uniform1iv=function(t,e){return P.mainContext.uniform1iv(t.location,e),1},i._uniform_ivec2=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(P.mainContext.uniform2i(t.location,i[0]=e[0],i[1]=e[1]),1):0},i._uniform_ivec2v=function(t,e){return P.mainContext.uniform2iv(t.location,e),1},i._uniform_vec3i=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(P.mainContext.uniform3i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0},i._uniform_vec3vi=function(t,e){return P.mainContext.uniform3iv(t.location,e),1},i._uniform_vec4i=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(P.mainContext.uniform4i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0},i._uniform_vec4vi=function(t,e){return P.mainContext.uniform4iv(t.location,e),1},i._uniform_sampler2D=function(t,i){var n=P.mainContext,r=t.uploadedValue;if(null==r[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return r[0]=this._curActTexIndex,n.uniform1i(t.location,this._curActTexIndex),n.activeTexture(e._TEXTURES[this._curActTexIndex]),i&&L.bindTexture(n,3553,i),this._curActTexIndex++,1}return n.activeTexture(e._TEXTURES[r[0]]),i&&L.bindTexture(n,3553,i),0},i._uniform_samplerCube=function(t,i){var n=P.mainContext,r=t.uploadedValue;if(null==r[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return r[0]=this._curActTexIndex,n.uniform1i(t.location,this._curActTexIndex),n.activeTexture(e._TEXTURES[this._curActTexIndex]),i?L.bindTexture(n,34067,i):L.bindTexture(n,34067,Ii.grayTexture.source),this._curActTexIndex++,1}return n.activeTexture(e._TEXTURES[r[0]]),i?L.bindTexture(n,34067,i):L.bindTexture(n,34067,Ii.grayTexture.source),0},i._noSetValue=function(t){console.log("no....:"+t.name)},i.uploadTexture2D=function(t){D.shaderCall++;var e=P.mainContext;e.activeTexture(33984),L.bindTexture(e,3553,t)},i.bind=function(){return c.activeShader=this,c.bindShader=this,this.activeResource(),L.UseProgram(this._program)},i.uploadAttributes=function(t,e){for(var i,n,r=0,a=0,s=this._attributeParamsMap.length;s>a;a+=2)n=this._attributeParamsMap[a+1],i=t[this._attributeParamsMap[a]],null!=i&&(e&&e[n.name]&&e[n.name].bind(),r+=n.fun.call(this,n,i));D.shaderCall+=r},i.uploadSceneUniforms=function(t){for(var e,i,n=0,r=0,a=this._sceneUniformParamsMap.length;a>r;r+=2)i=this._sceneUniformParamsMap[r+1],e=t[this._sceneUniformParamsMap[r]],null!=e&&(n+=i.fun.call(this,i,e));D.shaderCall+=n},i.uploadCameraUniforms=function(t){for(var e,i,n=0,r=0,a=this._cameraUniformParamsMap.length;a>r;r+=2)i=this._cameraUniformParamsMap[r+1],e=t[this._cameraUniformParamsMap[r]],null!=e&&(n+=i.fun.call(this,i,e));D.shaderCall+=n},i.uploadSpriteUniforms=function(t){for(var e,i,n=0,r=0,a=this._spriteUniformParamsMap.length;a>r;r+=2)i=this._spriteUniformParamsMap[r+1],e=t[this._spriteUniformParamsMap[r]],null!=e&&(n+=i.fun.call(this,i,e));D.shaderCall+=n},i.uploadMaterialUniforms=function(t){for(var e,i,n=0,r=0,a=this._materialUniformParamsMap.length;a>r;r+=2)i=this._materialUniformParamsMap[r+1],e=t[this._materialUniformParamsMap[r]],null!=e&&(n+=i.fun.call(this,i,e));D.shaderCall+=n},i.uploadRenderElementUniforms=function(t){for(var e,i,n=0,r=0,a=this._renderElementUniformParamsMap.length;a>r;r+=2)i=this._renderElementUniformParamsMap[r+1],e=t[this._renderElementUniformParamsMap[r]],null!=e&&(n+=i.fun.call(this,i,e));D.shaderCall+=n},i._preGetParams=function(t,e){var i=[t,e],n={},r=[],a=[],s={},o=[];n.attributes=r,n.uniforms=a,n.defines=s;for(var h=new RegExp("(/\\*([^*]|[\\r\\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/)|(//.*)","g"),l=new RegExp("(\".*\")|('.*')|([#\\w\\*-\\.+/()=<>{}\\\\]+)|([,;:\\\\])","g"),u=0,c=0,_=0;2>_;_++){i[_]=i[_].replace(h,"");var d,f=i[_].match(l);for(u=0,c=f.length;c>u;u++){var p=f[u];if("attribute"==p||"uniform"==p)u=this.parseOne(r,a,f,u,p,!0);else{if("#define"==p){p=f[++u],o[p]=1;continue}if("#ifdef"==p){d=f[++u];s[d]=s[d]||[];for(u++;c>u;u++)if(p=f[u],"attribute"==p||"uniform"==p)u=this.parseOne(r,a,f,u,p,o[d]);else if("#else"==p)for(u++;c>u;u++)if(p=f[u],"attribute"==p||"uniform"==p)u=this.parseOne(r,a,f,u,p,!o[d]);else if("#endif"==p)break}}}}return n},i.parseOne=function(t,i,n,r,a,s){var o={type:e.shaderParamsMap[n[r+1]],name:n[r+2],size:isNaN(parseInt(n[r+3]))?1:parseInt(n[r+3])};return s&&("attribute"==a?t.push(o):i.push(o)),":"==n[r+3]&&(o.type=n[r+4],r+=2),r+=2},e.create=function(t,i,n,r,a,s,o,h){return new e(t,i,n,r,a,s,o,h)},e.addInclude=function(t,i){if(!i||0===i.length)throw new Error("add shader include file err:"+t);if(e._includeFiles[t])throw new Error("add shader include file err, has add:"+t);e._includeFiles[t]=i},e._createShader=function(t,e,i){var n=t.createShader(i);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,35713))throw t.getShaderInfoLog(n);return n},e.PERIOD_RENDERELEMENT=0,e.PERIOD_MATERIAL=1,e.PERIOD_SPRITE=2,e.PERIOD_CAMERA=3,e.PERIOD_SCENE=4,e._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,33991],e._includeFiles={},e._count=0,n(e,["shaderParamsMap",function(){return this.shaderParamsMap={"float":5126,"int":5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new A}]),e}(c),fi=function(t){function e(){e.__super.call(this),this.setShaderName("ExtendTerrain"),this.renderMode=1}r(e,"laya.d3.core.material.ExtendTerrainMaterial",t);var i=e.prototype;return i._setDetailNum=function(t){switch(t){case 1:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}},i.disableLight=function(){this._addDisablePublicShaderDefine(me.SHADERDEFINE_POINTLIGHT|me.SHADERDEFINE_SPOTLIGHT|me.SHADERDEFINE_DIRECTIONLIGHT)},a(0,i,"diffuseScaleOffset2",null,function(t){this._setColor(7,t)}),a(0,i,"splatAlphaTexture",function(){return this._getTexture(0)},function(t){this._setTexture(0,t)}),a(0,i,"diffuseScaleOffset3",null,function(t){this._setColor(8,t)}),a(0,i,"diffuseTexture1",null,function(t){this._setTexture(1,t),this._setDetailNum(1)}),a(0,i,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.depthTest=!0,this.cull=2,this.blend=0,this.depthFunc=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.depthTest=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthFunc=515;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,i,"diffuseTexture2",function(){return this._getTexture(2)},function(t){this._setTexture(2,t),this._setDetailNum(2)}),a(0,i,"diffuseScaleOffset1",null,function(t){this._setColor(6,t)}),a(0,i,"diffuseTexture3",function(){return this._getTexture(3)},function(t){this._setTexture(3,t),this._setDetailNum(3)}),a(0,i,"diffuseTexture4",function(){return this._getTexture(4)},function(t){this._setTexture(4,t),this._setDetailNum(4)}),a(0,i,"diffuseTexture5",function(){return this._getTexture(5)},function(t){this._setTexture(5,t),this._setDetailNum(5)}),a(0,i,"diffuseScaleOffset4",null,function(t){this._setColor(9,t)}),a(0,i,"diffuseScaleOffset5",null,function(t){this._setColor(10,t)}),a(0,i,"albedo",function(){return this._getColor(14)},function(t){this._setColor(14,t)}),a(0,i,"ambientColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),a(0,i,"diffuseColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),a(0,i,"specularColor",function(){return this._getColor(13)},function(t){this._setColor(13,t)}),e.RENDERMODE_OPAQUE=1,e.RENDERMODE_TRANSPARENT=2,e.SPLATALPHATEXTURE=0,e.DIFFUSETEXTURE1=1,e.DIFFUSETEXTURE2=2,e.DIFFUSETEXTURE3=3,e.DIFFUSETEXTURE4=4,e.DIFFUSETEXTURE5=5,e.DIFFUSESCALEOFFSET1=6,e.DIFFUSESCALEOFFSET2=7,e.DIFFUSESCALEOFFSET3=8,e.DIFFUSESCALEOFFSET4=9,e.DIFFUSESCALEOFFSET5=10,e.MATERIALAMBIENT=11,e.MATERIALDIFFUSE=12,e.MATERIALSPECULAR=13,e.MATERIALALBEDO=14,e.SHADERDEFINE_DETAIL_NUM1=0,e.SHADERDEFINE_DETAIL_NUM2=0,e.SHADERDEFINE_DETAIL_NUM3=0,e.SHADERDEFINE_DETAIL_NUM4=0,e.SHADERDEFINE_DETAIL_NUM5=0,e}(Ye),pi=function(t){function e(){e.__super.call(this),this.setShaderName("GLITTER"),this.renderMode=1,this._setColor(3,new de(1,1,1,1)),this._setColor(2,new de(1,1,1,1))}r(e,"laya.d3.core.material.GlitterMaterial",t);var s=e.prototype;return s.setShaderName=function(e){t.prototype.setShaderName.call(this,e)},a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 9:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 10:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 11:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 12:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),a(0,s,"albedo",function(){return this._getColor(2)},function(t){this._setColor(2,t)}),a(0,s,"color",function(){return this._getColor(3)},function(t){this._setColor(3,t)}),e.load=function(t){return i.loader.create(t,null,null,e)},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.DIFFUSETEXTURE=1,e.ALBEDO=2,e.UNICOLOR=3,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(Ye),mi=function(t){function e(){if(this._transformUV=null,e.__super.call(this),!laya.d3.core.material.PBRMaterial.pbrlutTex){var t=_.window.__pbrlutdata;if(!t)throw alert("no pbr lutdata, need pbrlut.js"),"no pbr lutdata, need pbrlut.js";var i=Ci.create(new Uint32Array(t).buffer,256,256,9728,9728,!1);laya.d3.core.material.PBRMaterial.pbrlutTex=i}this._setTexture(4,laya.d3.core.material.PBRMaterial.pbrlutTex),this.setShaderName("PBR"),this._setNumber(0,.5),this.use_groundtruth=!1}r(e,"laya.d3.core.material.PBRMaterial",t);var s=e.prototype;return s.disableLight=function(){this._addDisablePublicShaderDefine(me.SHADERDEFINE_POINTLIGHT|me.SHADERDEFINE_SPOTLIGHT|me.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisablePublicShaderDefine(me.SHADERDEFINE_FOG)},s.onAsynLoaded=function(e,i,n){t.prototype.onAsynLoaded.call(this,e,i,n)},s.radicalInverse_VdC=function(t){var e=new Uint32Array(1);return function(t){return t=t<<16|t>>>16,t=(1431655765&t)<<1|(2863311530&t)>>>1,t=(858993459&t)<<2|(3435973836&t)>>>2,t=(252645135&t)<<4|(4042322160&t)>>>4,t=(16711935&t)<<8|(4278255360&t)>>>8,e[0]=t,2.3283064365386963e-10*e[0]}(t)},s.createHammersleyTex=function(t,e){var i=new Uint8Array(t*e*4),n=0,r=0;for(r=0;t*e>r;r++){var a=this.radicalInverse_VdC(r);i[n++]=255*a,i[n++]=0,i[n++]=0,i[n++]=255}return i},a(0,s,"normalTexture",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),a(0,s,"has_tangent",null,function(t){this._addShaderDefine(e.SHADERDEFINE_HAS_TANGENT)}),a(0,s,"roughness",function(){return this._getNumber(6)},function(t){this._setNumber(6,t),this._addShaderDefine(e.SHADERDEFINE_FIX_ROUGHNESS)}),a(0,s,"metaless",function(){return this._getNumber(7)},function(t){this._setNumber(7,t),this._addShaderDefine(e.SHADERDEFINE_FIX_METALESS)}),a(0,s,"pbrlutTexture",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),a(0,s,"use_groundtruth",null,function(t){if(t){if(this._addShaderDefine(e.SHADERDEFINE_USE_GROUNDTRUTH),!laya.d3.core.material.PBRMaterial.HammersleyNoiseTex){var i=this.createHammersleyTex(32,32);laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=Ci.create(i.buffer,32,32,9728,9728,!1)}this._setTexture(15,e.HammersleyNoiseTex)}else laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=null,this._removeShaderDefine(e.SHADERDEFINE_USE_GROUNDTRUTH)}),a(0,s,"transformUV",function(){return this._transformUV},function(t){this._transformUV=t,this._setMatrix4x4(8,t.matrix),this._conchMaterial&&this._conchMaterial.setShaderValue(8,t.matrix.elements,0)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),a(0,s,"pbrInfoTexture",function(){return this._getTexture(3)},function(t){this._setTexture(3,t),this._addShaderDefine(e.SHADERDEFINE_HAS_PBRINFO)}),a(0,s,"testClipZ",null,function(t){this._addShaderDefine(e.SHADERDEFINE_TEST_CLIPZ)}),e.load=function(t){return i.loader.create(t,null,null,e)},e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.PBRINFOTEXTURE=3,e.PBRLUTTEXTURE=4,e.UVANIAGE=5,e.MATERIALROUGHNESS=6,e.MATERIALMETALESS=7,e.UVMATRIX=8,e.UVAGE=9,e.AOOBJPOS=14,e.HSNOISETEXTURE=15,e.SHADERDEFINE_FIX_ROUGHNESS=0,e.SHADERDEFINE_FIX_METALESS=0,e.SHADERDEFINE_HAS_TANGENT=0,e.SHADERDEFINE_TEST_CLIPZ=0,e.SHADERDEFINE_HAS_PBRINFO=0,e.SHADERDEFINE_USE_GROUNDTRUTH=0,e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.pbrlutTex=null,e.HammersleyNoiseTex=null,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(Ye),gi=function(t){function e(){this._transformUV=null,e.__super.call(this),this.setShaderName("SIMPLE"),this._setColor(9,new _e(.6,.6,.6)),this._setColor(10,new _e(1,1,1)),this._setColor(11,new de(1,1,1,8)),this._setColor(12,new _e(1,1,1)),this._setColor(7,new de(1,1,1,1)),this._setNumber(0,.5),this._setColor(15,new de(1,1,0,0)),this.renderMode=1}r(e,"laya.d3.core.material.StandardMaterial",t);var s=e.prototype;return s.disableLight=function(){this._addDisablePublicShaderDefine(me.SHADERDEFINE_POINTLIGHT|me.SHADERDEFINE_SPOTLIGHT|me.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisablePublicShaderDefine(me.SHADERDEFINE_FOG)},s.onAsynLoaded=function(i,n,r){var a=n[0];if(a.version)t.prototype.onAsynLoaded.call(this,i,n,r);else{var s=n[1],o=a.props;for(var h in o)this[h]=o[h];e._parseStandardMaterial(s,this,a),this._endLoaded()}},s.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;this._transformUV&&(i._transformUV=this._transformUV.clone())},a(0,s,"ambientColor",function(){return this._getColor(9)},function(t){this._setColor(9,t)}),a(0,s,"ambientTexture",function(){return this._getTexture(5)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP),this._setTexture(5,t)}),a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0;break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 9:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 10:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1;break;case 11:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;case 12:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1;break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"normalTexture",function(){return this._getTexture(2)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,t)}),a(0,s,"reflectColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),a(0,s,"tilingOffset",function(){return this._getColor(15)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(15,t)}),a(0,s,"albedo",function(){return this._getColor(7)},function(t){this._setColor(7,t)}),a(0,s,"diffuseColor",function(){return this._getColor(10)},function(t){this._setColor(10,t)}),a(0,s,"specularColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,t)}),a(0,s,"specularTexture",function(){return this._getTexture(3)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,t)}),a(0,s,"emissiveTexture",function(){return this._getTexture(4)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP),this._setTexture(4,t)}),a(0,s,"reflectTexture",function(){return this._getTexture(6)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(6,t)}),a(0,s,"transformUV",function(){return this._transformUV},function(t){this._transformUV=t,this._setMatrix4x4(13,t.matrix),t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM),this._conchMaterial&&this._conchMaterial.setShaderValue(13,t.matrix.elements,0)}),e.load=function(t){return i.loader.create(t,null,null,e)},e._parseStandardMaterial=function(t,e,i){var n=i.customProps,r=n.ambientColor;e.ambientColor=new _e(r[0],r[1],r[2]);var a=n.diffuseColor;e.diffuseColor=new _e(a[0],a[1],a[2]);var s=n.specularColor;e.specularColor=new de(s[0],s[1],s[2],s[3]);var o=n.reflectColor;e.reflectColor=new _e(o[0],o[1],o[2]);var h=n.albedoColor;h&&(e.albedo=new de(h[0],h[1],h[2],h[3]));var l=n.diffuseTexture.texture2D;l&&(e.diffuseTexture=x.getRes(t[l]));var u=n.normalTexture.texture2D;u&&(e.normalTexture=x.getRes(t[u]));var c=n.specularTexture.texture2D;c&&(e.specularTexture=x.getRes(t[c]));var _=n.emissiveTexture.texture2D;_&&(e.emissiveTexture=x.getRes(t[_]));var d=n.ambientTexture.texture2D;d&&(e.ambientTexture=x.getRes(t[d]));var f=n.reflectTexture.texture2D;f&&(e.reflectTexture=x.getRes(t[f]))},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.SHADERDEFINE_DIFFUSEMAP=0,e.SHADERDEFINE_NORMALMAP=0,e.SHADERDEFINE_SPECULARMAP=0,e.SHADERDEFINE_EMISSIVEMAP=0,e.SHADERDEFINE_AMBIENTMAP=0,e.SHADERDEFINE_REFLECTMAP=0,e.SHADERDEFINE_UVTRANSFORM=0,e.SHADERDEFINE_TILINGOFFSET=0,e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.SPECULARTEXTURE=3,e.EMISSIVETEXTURE=4,e.AMBIENTTEXTURE=5,e.REFLECTTEXTURE=6,e.ALBEDO=7,e.UVANIAGE=8,e.MATERIALAMBIENT=9,e.MATERIALDIFFUSE=10,e.MATERIALSPECULAR=11,e.MATERIALREFLECT=12,e.UVMATRIX=13,e.UVAGE=14,e.TILINGOFFSET=15,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(Ye),yi=function(t){function e(){this._diffuseScale1=null,this._diffuseScale2=null,this._diffuseScale3=null,this._diffuseScale4=null,e.__super.call(this),this.setShaderName("Terrain"),this.renderMode=1,this._diffuseScale1=new ce,this._diffuseScale2=new ce,this._diffuseScale3=new ce,this._diffuseScale4=new ce,this.ambientColor=new _e(.6,.6,.6),this.diffuseColor=new _e(1,1,1),this.specularColor=new de(.2,.2,.2,32)}r(e,"laya.d3.core.material.TerrainMaterial",t);var s=e.prototype;return s.setDiffuseScale1=function(t,e){this._diffuseScale1.x=t,this._diffuseScale1.y=e,this._setColor(6,this._diffuseScale1)},s.setDiffuseScale2=function(t,e){this._diffuseScale2.x=t,this._diffuseScale2.y=e,this._setColor(7,this._diffuseScale2)},s.setDiffuseScale3=function(t,e){this._diffuseScale3.x=t,this._diffuseScale3.y=e,this._setColor(8,this._diffuseScale3)},s.setDiffuseScale4=function(t,e){this._diffuseScale4.x=t,this._diffuseScale4.y=e,this._setColor(9,this._diffuseScale4)},s.setDetailNum=function(t){switch(t){case 1:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 2:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 3:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 4:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3)}},s.disableLight=function(){this._addDisablePublicShaderDefine(me.SHADERDEFINE_POINTLIGHT|me.SHADERDEFINE_SPOTLIGHT|me.SHADERDEFINE_DIRECTIONLIGHT)},s.setShaderName=function(e){t.prototype.setShaderName.call(this,e)},a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.depthTest=!0,this.cull=2,this.blend=0,this.depthFunc=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.depthTest=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthFunc=515;break;default:throw new Error("TerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"diffuseTexture2",function(){return this._getTexture(3)},function(t){this._setTexture(3,t)}),a(0,s,"ambientColor",function(){return this._getColor(10)},function(t){this._setColor(10,t)}),a(0,s,"diffuseTexture4",function(){return this._getTexture(5)},function(t){this._setTexture(5,t)}),a(0,s,"diffuseColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),a(0,s,"diffuseTexture1",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),a(0,s,"specularColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),a(0,s,"diffuseTexture3",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),a(0,s,"splatAlphaTexture",function(){return this._getTexture(0)},function(t){this._setTexture(0,t)}),a(0,s,"normalTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),e.load=function(t){return i.loader.create(t,null,null,e)},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_TRANSPARENT=2,e.SPLATALPHATEXTURE=0,e.NORMALTEXTURE=1,e.DIFFUSETEXTURE1=2,e.DIFFUSETEXTURE2=3,e.DIFFUSETEXTURE3=4,e.DIFFUSETEXTURE4=5,e.DIFFUSESCALE1=6,e.DIFFUSESCALE2=7,e.DIFFUSESCALE3=8,e.DIFFUSESCALE4=9,e.MATERIALAMBIENT=10,e.MATERIALDIFFUSE=11,e.MATERIALSPECULAR=12,e.SHADERDEFINE_DETAIL_NUM1=0,e.SHADERDEFINE_DETAIL_NUM2=0,e.SHADERDEFINE_DETAIL_NUM3=0,e.SHADERDEFINE_DETAIL_NUM4=0,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(Ye),xi=function(t){function e(){this._useVertexDeep=!1,e.__super.call(this),this.setShaderName("Water")}r(e,"laya.d3.core.material.WaterMaterial",t);var s=e.prototype;return s.disableFog=function(){this._addDisablePublicShaderDefine(me.SHADERDEFINE_FOG)},s.onAsynLoaded=function(e,i,n){t.prototype.onAsynLoaded.call(this,e,i,n)},a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),a(0,s,"normalTexture",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),a(0,s,"underWaterTexture",function(){return this._getTexture(3)},function(t){this._setTexture(3,t)}),a(0,s,"deepColorTexture",function(){return this._getTexture(10)},function(t){this._setTexture(10,t)}),a(0,s,"useFoam",null,function(t){t?this._addShaderDefine(e.SHADERDEFINE_USE_FOAM):this._removeShaderDefine(e.SHADERDEFINE_USE_FOAM)}),a(0,s,"skyTexture",function(){return this._getTexture(11)},function(t){this._setTexture(11,t)}),a(0,s,"deepScale",function(){return this._getNumber(20)},function(t){
this._setNumber(20,t)}),a(0,s,"detailTexture",function(){return this._getTexture(9)},function(t){this._setTexture(9,t)}),a(0,s,"foamTexture",function(){return this._getTexture(17)},function(t){this._setTexture(17,t)}),a(0,s,"waterInfoTexture",function(){return this._getTexture(16)},function(t){this._setTexture(16,t)}),a(0,s,"vertexDispTexture",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),a(0,s,"currentTm",function(){return this._getNumber(8)},function(t){this._setNumber(8,t)}),a(0,s,"waveInfo",function(){return this._getBuffer(12)},function(t){this._setBuffer(12,t)}),a(0,s,"waveInfoD",function(){return this._getBuffer(13)},function(t){this._setBuffer(13,t)}),a(0,s,"waveMainDir",function(){return this._getNumber(14)},function(t){this._setNumber(14,t*Math.PI/180)}),a(0,s,"geoWaveUVScale",function(){return this._getNumber(18)},function(t){this._setNumber(18,t)}),a(0,s,"windSpeed",function(){return 0},function(t){}),a(0,s,"scrsize",null,function(t){this._setBuffer(15,t)}),a(0,s,"seaColor",function(){return this._getBuffer(19)},function(t){this._setBuffer(19,t)}),a(0,s,"useVertexDeep",function(){return this._useVertexDeep},function(t){this._useVertexDeep=t,t?this._addShaderDefine(e.SHADERDEFINE_USEVERTEXHEIGHT):this._removeShaderDefine(e.SHADERDEFINE_USEVERTEXHEIGHT)}),a(0,s,"windDir",function(){return 0},function(t){}),a(0,s,"useRefractTexture",null,function(t){t?this._addShaderDefine(e.SHADERDEFINE_USE_REFRACT_TEX):this._removeShaderDefine(e.SHADERDEFINE_USE_REFRACT_TEX)}),a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),e.load=function(t){return i.loader.create(t,null,null,e)},e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.UNDERWATERTEXTURE=3,e.VERTEXDISPTEXTURE=4,e.UVANIAGE=5,e.UVMATRIX=6,e.UVAGE=7,e.CURTM=8,e.DETAILTEXTURE=9,e.DEEPCOLORTEXTURE=10,e.SKYTEXTURE=11,e.WAVEINFO=12,e.WAVEINFOD=13,e.WAVEMAINDIR=14,e.SCRSIZE=15,e.WATERINFO=16,e.FOAMTEXTURE=17,e.GEOWAVE_UV_SCALE=18,e.SEA_COLOR=19,e.WAVEINFODEEPSCALE=20,e.SHADERDEFINE_SHOW_NORMAL=0,e.SHADERDEFINE_CUBE_ENV=0,e.SHADERDEFINE_HDR_ENV=0,e.SHADERDEFINE_USE_FOAM=0,e.SHADERDEFINE_USE_REFRACT_TEX=0,e.SHADERDEFINE_USEVERTEXHEIGHT=0,e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(Ye),vi=function(t){function e(t,i,n,r){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===n&&(n=35044),void 0===r&&(r=!1),e.__super.call(this),this._indexType=t,this._indexCount=i,this._bufferUsage=n,this._bufferType=34963,this._canRead=r;var a=0;if("ushort"==t)this._indexTypeByteCount=2;else{if("ubyte"!=t)throw new Error("unidentification index type.");this._indexTypeByteCount=1}a=this._indexTypeByteCount*i,this._byteLength=a,E.isConchNode||(this._bind(),d._gl.bufferData(this._bufferType,a,this._bufferUsage)),r?("ushort"==t?this._buffer=new Uint16Array(i):"ubyte"==t&&(this._buffer=new Uint8Array(i)),this.memorySize=2*a):this.memorySize=a}r(e,"laya.d3.graphics.IndexBuffer3D",t);var i=e.prototype;return i.setData=function(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=4294967295);var r=0;if("ushort"==this._indexType?(r=2,(0!==i||4294967295!==n)&&(t=new Uint16Array(t.buffer,i*r,n))):"ubyte"==this._indexType&&(r=1,(0!==i||4294967295!==n)&&(t=new Uint8Array(t.buffer,i*r,n))),E.isConchNode||(this._bind(),d._gl.bufferSubData(this._bufferType,e*r,t)),this._canRead)if(0!==e||0!==i||4294967295!==n){var a=this._buffer.length-e;n>a&&(n=a);for(var s=0;n>s;s++)this._buffer[e+s]=t[s]}else this._buffer=t},i.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},i.detoryResource=function(){t.prototype.detoryResource.call(this),this._buffer=null,this.memorySize=0},a(0,i,"indexType",function(){return this._indexType}),a(0,i,"indexTypeByteCount",function(){return this._indexTypeByteCount}),a(0,i,"indexCount",function(){return this._indexCount}),a(0,i,"canRead",function(){return this._canRead}),e.INDEXTYPE_UBYTE="ubyte",e.INDEXTYPE_USHORT="ushort",e.create=function(t,i,n,r){return void 0===n&&(n=35044),void 0===r&&(r=!1),new e(t,i,n,r)},e}(d),Si=function(t){function e(t,i,n,r){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===r&&(r=!1),e.__super.call(this),this._vertexDeclaration=t,this._vertexCount=i,this._bufferUsage=n,this._bufferType=34962,this._canRead=r,this.memorySize=this._byteLength=this._vertexDeclaration.vertexStride*i,E.isConchNode||(this._bind(),d._gl.bufferData(this._bufferType,this._byteLength,this._bufferUsage)),r&&(this._buffer=new Float32Array(this.byteLength/4))}r(e,"laya.d3.graphics.VertexBuffer3D",t);var i=e.prototype;return i.bindWithIndexBuffer=function(t){t&&t._bind(),this._bind()},i.setData=function(t,e,i,n){if(void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=4294967295),(0!==i||4294967295!==n)&&(t=new Float32Array(t.buffer,4*i,n)),E.isConchNode||(this._bind(),d._gl.bufferSubData(this._bufferType,4*e,t)),this._canRead)if(0!==e||0!==i||4294967295!==n){var r=this._buffer.length-e;n>r&&(n=r);for(var a=0;n>a;a++)this._buffer[e+a]=t[a]}else this._buffer=t},i.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},i.detoryResource=function(){for(var e=this._vertexDeclaration.getVertexElements(),i=0;i<e.length;i++)P.mainContext.disableVertexAttribArray(i);t.prototype.detoryResource.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},a(0,i,"vertexDeclaration",function(){return this._vertexDeclaration}),a(0,i,"vertexCount",function(){return this._vertexCount}),a(0,i,"canRead",function(){return this._canRead}),e.create=function(t,i,n,r){return void 0===n&&(n=35044),void 0===r&&(r=!1),new e(t,i,n,r)},e}(d),Ti=function(t){function e(){e.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this.renderMode=6}r(e,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",t);var s=e.prototype;return s.onAsynLoaded=function(i,n,r){var a=n[0];if(a.version)t.prototype.onAsynLoaded.call(this,i,n,r);else{var s=n[1],o=a.props;for(var h in o)this[h]=o[h];e._parseShurikenParticleMaterial(s,this,a),this._endLoaded()}},a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=2,this.depthTest=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=2,this.depthTest=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"tintColor",function(){return this._getColor(2)},function(t){t?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._setColor(2,t)}),a(0,s,"diffuseTexture",function(){return this._getTexture(0)},function(t){t?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,t)}),e.load=function(t){return i.loader.create(t,null,null,e)},e._parseShurikenParticleMaterial=function(t,e,i){var n=i.customProps,r=n.diffuseTexture.texture2D;r&&(e.diffuseTexture=x.getRes(t[r]));var a=n.tintColor;a&&(e.tintColor=new de(a[0],a[1],a[2],a[3]))},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.SHADERDEFINE_DIFFUSEMAP=0,e.SHADERDEFINE_TINTCOLOR=0,e.SHADERDEFINE_ADDTIVEFOG=0,e.DIFFUSETEXTURE=1,e.TINTCOLOR=2,e._diffuseTextureIndex=0,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(Ye),Ei=function(t){function e(t){this._terrainRes=null,this._lightmapScaleOffset=null,e.__super.call(this),this._lightmapScaleOffset=new de(1,1,0,0),t&&(this._terrainRes=t,t.loaded?this.buildTerrain(t):t.once("loaded",this,this.buildTerrain))}r(e,"laya.d3.terrain.Terrain",t);var n=e.prototype;return n._parseCustomProps=function(e,i,n){t.prototype._parseCustomProps.call(this,e,i,n),this.terrainRes=x.getRes(e[i.dataPath]);var r=i.lightmapIndex;null!=r&&this.setLightmapIndex(r);var a=i.lightmapScaleOffset;a&&this.setLightmapScaleOffset(new de(a[0],a[1],a[2],a[3]))},n.setLightmapIndex=function(t){for(var e=0;e<this._childs.length;e++){var i=this._childs[e];i.terrainRender.lightmapIndex=t}},n.setLightmapScaleOffset=function(t){if(t){t.cloneTo(this._lightmapScaleOffset);for(var e=0;e<this._childs.length;e++){var i=this._childs[e];i.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset}}},n.disableLight=function(){for(var t=0,e=this._childs.length;e>t;t++)for(var i=this._childs[t],n=0,r=i._render.sharedMaterials.length;r>n;n++){var a=i._render.sharedMaterials[n];a.disableLight()}},n.buildTerrain=function(t){for(var e=t._chunkNumX,i=t._chunkNumZ,n=t._heightData,r=0,a=0;i>a;a++)for(var s=0;e>s;s++){for(var o=new Ui(s,a,t._gridSize,n._terrainHeightData,n._width,n._height,t._cameraCoordinateInverse),h=t._chunkInfos[r++],l=0;l<h.alphaMap.length;l++){var u=h.detailID[l].length,c=u>0?t._detailTextureInfos[h.detailID[l][0]].diffuseTexture:null,_=u>1?t._detailTextureInfos[h.detailID[l][1]].diffuseTexture:null,d=u>2?t._detailTextureInfos[h.detailID[l][2]].diffuseTexture:null,f=u>3?t._detailTextureInfos[h.detailID[l][3]].diffuseTexture:null,p=u>0?t._detailTextureInfos[h.detailID[l][0]].scale:null,m=u>1?t._detailTextureInfos[h.detailID[l][1]].scale:null,g=u>2?t._detailTextureInfos[h.detailID[l][2]].scale:null,y=u>3?t._detailTextureInfos[h.detailID[l][3]].scale:null;o.buildRenderElementAndMaterial(u,h.normalMap,h.alphaMap[l],c,_,d,f,t._materialInfo.ambientColor,t._materialInfo.diffuseColor,t._materialInfo.specularColor,p?p.x:1,p?p.y:1,m?m.x:1,m?m.y:1,g?g.x:1,g?g.y:1,y?y.x:1,y?y.y:1)}o.terrainRender.receiveShadow=!0,o.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset,this.addChild(o)}},n.width=function(){return this._terrainRes._chunkNumX*ve.CHUNK_GRID_NUM*this._terrainRes._gridSize},n.depth=function(){return this._terrainRes._chunkNumZ*ve.CHUNK_GRID_NUM*this._terrainRes._gridSize},n.getHeightXZ=function(t,i){if(!this._terrainRes||!this._terrainRes.loaded)return NaN;if(t-=this.transform.position.x,i-=this.transform.position.z,e.__VECTOR3__||(e.__VECTOR3__=new _e),e.__VECTOR3__.elements[0]=t,e.__VECTOR3__.elements[1]=0,e.__VECTOR3__.elements[2]=i,_e.transformV3ToV3(e.__VECTOR3__,ve.__ADAPT_MATRIX_INV__,e.__VECTOR3__),t=e.__VECTOR3__.elements[0],i=e.__VECTOR3__.elements[2],0>t||t>this.width()||0>i||i>this.depth())return NaN;var n=this._terrainRes._gridSize,r=parseInt(""+t/n),a=parseInt(""+i/n),s=t-r*n,o=i-a*n,h=NaN,l=NaN,u=NaN,c=NaN,_=NaN,d=this._terrainRes._heightData;return s+o>n?(h=d._terrainHeightData[(a+1-1)*d._width+r+1],l=d._terrainHeightData[(a+1-1)*d._width+r],u=d._terrainHeightData[(a-1)*d._width+r+1],c=(n-s)/n,_=(n-o)/n,h+(l-h)*c+(u-h)*_):(h=d._terrainHeightData[Math.max(0,a-1)*d._width+r],l=d._terrainHeightData[Math.min(d._width*d._height-1,(a+1-1)*d._width+r)],u=d._terrainHeightData[Math.min(d._width*d._height-1,Math.max(0,a-1)*d._width+r+1)],c=s/n,_=o/n,h+(l-h)*_+(u-h)*c)},a(0,n,"terrainRes",null,function(t){t&&(this._terrainRes=t,t.loaded?this.buildTerrain(t):t.once("loaded",this,this.buildTerrain))}),e.load=function(t){return i.loader.create(t,null,null,e,null,1,!1)},e.RENDER_LINE_MODEL=!1,e.LOD_TOLERANCE_VALUE=4,e.LOD_DISTANCE_FACTOR=2,e.__VECTOR3__=null,e}(We),wi=function(t){function e(){this._startTm=0,e.__super.call(this),laya.d3.water.WaterDetailMaterial.init(),this.setShaderName("WaterDetail"),this.cull=0,this._startTm=i.timer.currTimer}r(e,"laya.d3.water.WaterDetailMaterial",t);var n=e.prototype;return a(0,n,"currentTm",function(){return this._getNumber(1)},function(t){this._setNumber(1,t-this._startTm)}),a(0,n,"waveInfo",function(){return this._getBuffer(12)},function(t){this._setBuffer(12,t)}),a(0,n,"waveInfoD",function(){return this._getBuffer(13)},function(t){this._setBuffer(13,t)}),a(0,n,"texWaveUVScale",function(){return this._getNumber(15)},function(t){this._setNumber(15,t)}),e.init=function(){if(!laya.d3.water.WaterDetailMaterial._bInited){laya.d3.water.WaterDetailMaterial._bInited=!0;var t={a_position:0,a_normal:3,uv:2},e={u_curTm:[1,1],u_WaveInfo:[12,1],u_WaveInfoD:[13,1],TEXWAVE_UV_SCALE:[15,1]},i=di.nameKey.add("WaterDetail"),n="\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\n\nvoid main() {\n	vec3 pos = a_position;\n	if(pos.z!=0.)pos.y=pos.z;\n	pos.z=0.5;\n	gl_Position = vec4(pos,1.);\n    vUv = uv;\n	//vWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n	//vWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n	//vWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n}\n",r='precision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\nuniform float u_curTm;\n\n#include "WaveFunction.glsl"\n\nvoid main() {\n	vec3 wave_N,wave_B,wave_T;\n	calcWave(u_curTm, vUv,wave_B,wave_T,wave_N);\n	gl_FragColor.rgb = normalize(wave_N)*0.5+vec3(0.5);// vec3(0.1,.4,0.1);\n    gl_FragColor.a = 1.0;\n}\n';me.add(i,n,r,t,e)}},e.CURTM=1,e.WAVEINFO=12,e.WAVEINFOD=13,e.WAVEMAINDIR=14,e.TEXWAVE_UV_SCALE=15,e._bInited=!1,e}(Ye),bi=(function(t){function e(){this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curAnimationDatas=null,e.__super.call(this),this._animationSprites=[],this._animationSpritesInitLocalMatrix=[]}r(e,"laya.d3.component.animation.RigidAnimations",t);var n=e.prototype;return n._init=function(){for(var t=this._templet.getNodes(this.currentAnimationClipIndex),e=this._owner,i=t.length,n=0,r=new Uint16Array(this._templet.getPublicExtData()),a=0;i>a;a++){var s=r.slice(n+1,n+1+r[n]);n+=r[n]+1;for(var o=1;o<s.length;o++){s[o];e=e._childs[s[o]]}var h=e.getChildByName(t[a].name);if(!h)break;this._animationSprites[a]=h;var l=this._animationSpritesInitLocalMatrix[a];l||(l=this._animationSpritesInitLocalMatrix[a]=new ae),h.transform.localMatrix.cloneTo(l),e=this._owner}},n._animtionPlay=function(){this._templet.loaded?this._init():this._templet.once("loaded",this,this._init)},n._animtionStop=function(){if(this._lastFrameIndex=-1,this._player.returnToZeroStopped){this._curAnimationDatas=null;for(var t=0;t<this._animationSprites.length;t++)this._animationSprites[t].transform.localMatrix=this._animationSpritesInitLocalMatrix[t]}},n._effectAnimation=function(t){for(var e=0,i=this._animationSprites.length;i>e;e++){for(var n=this._animationSprites[e],r=n.transform.localMatrix,a=r.elements,s=0;16>s;s++)a[s]=this._curAnimationDatas[16*e+s];n.transform.localMatrix=r}},n._load=function(e){t.prototype._load.call(this,e),this._player.on("stopped",this,this._animtionStop),this._player.on("played",this,this._animtionPlay)},n._update=function(t){if(2===this._player.state&&this._templet&&this._templet.loaded){var e=this._player.playbackRate*i.timer.scale,n=this._player.cachePlayRate,r=this._player.isCache&&e>=n,a=r?this.currentFrameIndex:-1;if(-1===a||this._lastFrameIndex!==a){var s=this.currentAnimationClipIndex,o=this._templet.getNodes(s),h=this._templet._animationDatasCache;if(r){var l=this._templet.getAnimationDataWithCache(n,h,s,a);if(l)return this._curAnimationDatas=l,this._lastFrameIndex=a,void this._effectAnimation(o)}var u=16*o.length;r?this._curAnimationDatas=new Float32Array(u):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(u)),this._curAnimationDatas=this._tempCurAnimationData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(s))),r?this._templet.getOriginalData(s,this._curOriginalData,this._player._fullFrames[s],a,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(s,this._curOriginalData,this._player.currentPlayTime),De._computeRootAnimationData(o,this._curOriginalData,this._curAnimationDatas),r&&this._templet.setAnimationDataWithCache(n,h,s,a,this._curAnimationDatas),this._lastFrameIndex=a,this._effectAnimation(o)}}},n._unload=function(e){t.prototype._unload.call(this,e),this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._curAnimationDatas=null},a(0,n,"url",null,function(t){console.log("Warning: discard property,please use templet property instead.");var e=i.loader.create(t,null,null,h);this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),a(0,n,"templet",t.prototype._$get_templet,function(t){this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),e}(Qe),function(t){function e(){this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,this._boneIndexToMeshList=null,this._oldVersion=!1,e.__super.call(this),this._boneIndexToMeshList=[]}r(e,"laya.d3.component.animation.SkinAnimations",t);var n=e.prototype;return n._computeBoneIndexToMeshOnTemplet=function(){this._templet.loaded?this._computeBoneIndexToMeshOnMesh():this._templet.once("loaded",this,this._computeBoneIndexToMeshOnMesh)},n._computeBoneIndexToMeshOnMesh=function(){"LAYAANIMATION:02"===this._templet._aniVersion?this._oldVersion=!1:this._oldVersion=!0;var t=this._owner.meshFilter.sharedMesh;t.loaded?this._computeBoneIndexToMesh(t):t.on("loaded",this,this._computeBoneIndexToMesh)},n._computeBoneIndexToMesh=function(t){var e=t._boneNames;if(e)for(var i=e.length,n=this._templet._anis,r=0,a=n.length;a>r;r++){var s=this._boneIndexToMeshList[r];s||(s=this._boneIndexToMeshList[r]=[]),s.length=i;for(var o=n[r],h=0;i>h;h++)s[h]=o.bone3DMap[e[h]]}},n._getAnimationDatasWithCache=function(t,e,i,n,r){var a=i[n];if(a){var s=a[t];if(s){var o=s[e.id];return o?o[r]:null}return null}return null},n._setAnimationDatasWithCache=function(t,e,i,n,r,a){var s=i[n]||(i[n]={}),o=s[t]||(s[t]={}),h=o[e.id]||(o[e.id]=[]);h[r]=a},n._onAnimationPlayMeshLoaded=function(){for(var t=this._ownerMesh.meshRender._renderElements,e=0,i=t.length;i>e;e++)t[e]._canDynamicBatch=!1},n._onAnimationPlay=function(){this._ownerMesh._render._addShaderDefine(Bi.SHADERDEFINE_BONE);var t=this._ownerMesh.meshFilter.sharedMesh;t.loaded?this._onAnimationPlayMeshLoaded():t.once("loaded",this,this._onAnimationPlayMeshLoaded)},n._onAnimationStop=function(){this._lastFrameIndex=-1,this._player.returnToZeroStopped&&(this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh._render._removeShaderDefine(Bi.SHADERDEFINE_BONE));for(var t=this._ownerMesh.meshRender._renderElements,e=0,i=t.length;i>e;e++)t[e]._canDynamicBatch=!0},n._load=function(e){t.prototype._load.call(this,e),this._ownerMesh=e,this._player.on("played",this,this._onAnimationPlay),this._player.on("stopped",this,this._onAnimationStop),this._owner.meshFilter.on("meshchanged",this,this._computeBoneIndexToMeshOnTemplet)},n._update=function(t){var n=this._ownerMesh.meshFilter.sharedMesh;if(2===this._player.state&&this._templet&&this._templet.loaded&&n.loaded){var r=this._player.playbackRate*i.timer.scale,a=this._player.cachePlayRate,s=this._player.isCache&&r>=a,o=s?this.currentFrameIndex:-1;if(-1===o||this._lastFrameIndex!==o){var h=this.currentAnimationClipIndex,l=this._templet._animationDatasCache[0],u=this._templet._animationDatasCache[1];if(s){var c=this._getAnimationDatasWithCache(a,n,u,h,o);if(c)return this._curAnimationDatas=c,this._curBonesDatas=this._templet.getAnimationDataWithCache(a,l,h,o),void(this._lastFrameIndex=o)}var _=!1;s&&(this._curBonesDatas=this._templet.getAnimationDataWithCache(a,l,h,o),_=this._curBonesDatas?!0:!1);var d=this._templet.getNodes(h),f=16*d.length,p=n.InverseAbsoluteBindPoses;this._oldVersion?this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(f)):this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(16*p.length));var m,g,y=0,x=0,v=0,S=n.getSubMeshCount();if(s){for(this._curAnimationDatas=[],this._curAnimationDatas.length=S,y=0;S>y;y++)for(m=this._curAnimationDatas[y]=[],g=n.getSubMesh(y),v=g._boneIndicesList.length,m.length=v,x=0;v>x;x++)m[x]=new Float32Array(16*g._boneIndicesList[x].length);_||(this._curBonesDatas=new Float32Array(f))}else{if(!this._tempCurAnimationData)for(this._tempCurAnimationData=[],this._tempCurAnimationData.length=S,y=0;S>y;y++)for(m=this._tempCurAnimationData[y]=[],g=n.getSubMesh(y),v=g._boneIndicesList.length,m.length=v,x=0;v>x;x++)m[x]=new Float32Array(16*g._boneIndicesList[x].length);this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(f)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData}if(this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(h))),s?this._templet.getOriginalData(h,this._curOriginalData,this._player._fullFrames[h],o,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(h,this._curOriginalData,this._player.currentPlayTime),this._oldVersion)s&&_?De._computeAnimationDatasByArrayAndMatrixFastOld(p,this._curBonesDatas,this._curMeshAnimationData):De._computeBoneAndAnimationDatasByBindPoseMatrxixOld(d,this._curOriginalData,p,this._curBonesDatas,this._curMeshAnimationData);else{var T=this._boneIndexToMeshList[h];s&&_?De._computeAnimationDatasByArrayAndMatrixFast(p,this._curBonesDatas,this._curMeshAnimationData,T):De._computeBoneAndAnimationDatasByBindPoseMatrxix(d,this._curOriginalData,p,this._curBonesDatas,this._curMeshAnimationData,T)}for(y=0;S>y;y++){var E=n.getSubMesh(y)._boneIndicesList;for(v=E.length,m=this._curAnimationDatas[y],x=0;v>x;x++)e._splitAnimationDatas(E[x],this._curMeshAnimationData,m[x])}s&&(this._setAnimationDatasWithCache(a,n,u,h,o,this._curAnimationDatas),_||this._templet.setAnimationDataWithCache(a,l,h,o,this._curBonesDatas)),this._lastFrameIndex=o}}},n._preRenderUpdate=function(t){var e=t.renderElement.renderObj;this._curAnimationDatas?e._skinAnimationDatas=this._curAnimationDatas[e._indexInMesh]:e._skinAnimationDatas=null},n._unload=function(e){2==this.player.state&&this._ownerMesh._render._removeShaderDefine(Bi.SHADERDEFINE_BONE),this._templet.loaded||this._templet.off("loaded",this,this._computeBoneIndexToMeshOnMesh);var i=this._ownerMesh.meshFilter.sharedMesh;i.loaded||i.off("loaded",this,this._onAnimationPlayMeshLoaded),t.prototype._unload.call(this,e),this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null},a(0,n,"curBonesDatas",function(){return this._curBonesDatas}),a(0,n,"templet",t.prototype._$get_templet,function(t){this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this._computeBoneIndexToMeshOnTemplet(),this._curOriginalData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]]),this.event("animationchanged",this))}),e._splitAnimationDatas=function(t,e,i){for(var n=0,r=t.length,a=0;r>n;n++)for(var s=0;16>s;s++,a++)i[a]=e[(t[n]<<4)+s]},e}(Qe)),Ci=(function(t){function e(){this._size=null,this._transformOrientedBoundBox=null,this.center=null,e.__super.call(this),this._needUpdate=!1}r(e,"laya.d3.component.physics.BoxCollider",t);var i=e.prototype;return i._updateCollider=function(){if(this._needUpdate){var t=this._owner.transform,i=t.worldMatrix;i.cloneTo(this._transformOrientedBoundBox.transformation),_e.multiply(t.scale,this.center,e._deviationV3),_e.transformQuat(e._deviationV3,t.rotation,e._deviationV3),this._transformOrientedBoundBox.getCenter(e._obbCenterV3),_e.add(e._obbCenterV3,e._deviationV3,e._deviationV3),this._transformOrientedBoundBox.transformation.setTranslationVector(e._deviationV3),this._needUpdate=!1}},i._onGeometryFilterLoaded=function(){this.destroyed||this._initBoundBox()},i._onWorldMatrixChanged=function(){this._needUpdate=!0},i._initBoundBox=function(){var t=this.owner._geometryFilter._originalBoundingBox;se.createByBoundBox(t,this._transformOrientedBoundBox);var e=this._transformOrientedBoundBox.extents;this._size=new _e(2*e.x,2*e.y,2*e.z),this.center=new _e,_e.add(t.min,t.max,this.center),_e.scale(this.center,.5,this.center),this.owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},i._initialize=function(t){if(laya.d3.component.Component3D.prototype._initialize.call(this,t),this._owner instanceof laya.d3.core.RenderableSprite3D){var e=t;this._transformOrientedBoundBox=new se(new _e,new ae),e._geometryFilter._isAsyncLoaded?this._initBoundBox():e._geometryFilter.once("loaded",this,this._onGeometryFilterLoaded)}else this._transformOrientedBoundBox=new se(new _e,new ae),this._size=new _e,this.center=new _e,t.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},i.raycast=function(t,e,i){void 0===i&&(i=Number.MAX_VALUE),this._updateCollider();var n=this._transformOrientedBoundBox.intersectsRay(t,e.position);return-1!==n&&i>=n?(e.distance=n,e.sprite3D=this._owner,!0):(e.distance=-1,e.sprite3D=null,!1)},a(0,i,"boundBox",function(){return this._updateCollider(),this._transformOrientedBoundBox}),a(0,i,"size",function(){return this._size},function(t){this._size=t,_e.scale(t,.5,this._transformOrientedBoundBox.extents)}),n(e,["_deviationV3",function(){return this._deviationV3=new _e},"_obbCenterV3",function(){return this._obbCenterV3=new _e}]),e}(ti),function(t){function e(){this._transformBoundSphere=null,this._mesh=null,e.__super.call(this),this._transformBoundSphere=new ee(new _e(0,0,0),0)}r(e,"laya.d3.component.physics.MeshCollider",t);var i=e.prototype;return i._raycastMesh=function(t,i,n,r){void 0===r&&(r=Number.MAX_VALUE);var a=i.transform.worldMatrix,s=e._tempMatrix4x40;a.invert(s);var o=t.origin,h=t.direction,l=e._tempRay0;_e.transformCoordinate(o,s,l.origin),_e.TransformNormal(h,s,l.direction);for(var u=Number.MAX_VALUE,c=0,_=this._mesh.getRenderElementsCount();_>c;c++){var d=this._mesh.getRenderElement(c),f=d._getVertexBuffer(0),p=f.getData(),m=d._getIndexBuffer().getData(),g=e._tempRaycastHit,y=be.rayIntersectsPositionsAndIndices(l,p,f.vertexDeclaration,m,g);if(y){_e.transformCoordinate(g.position,a,g.position);var x=e._tempVector30;_e.subtract(o,g.position,x);var v=_e.scalarLength(x);if(r>v&&u>v){g.distance=v,g.sprite3D=i;var S=g.trianglePositions;_e.transformCoordinate(S[0],a,S[0]),_e.transformCoordinate(S[1],a,S[1]),_e.transformCoordinate(S[2],a,S[2]);var T=g.triangleNormals;return _e.transformCoordinate(T[0],a,T[0]),_e.transformCoordinate(T[1],a,T[1]),_e.transformCoordinate(T[2],a,T[2]),u=v,g.cloneTo(n),!0}return!1}}return!1},i._initialize=function(t){if(laya.d3.component.Component3D.prototype._initialize.call(this,t),this._owner instanceof laya.d3.core.MeshSprite3D){var e=t;this._mesh=e.meshFilter.sharedMesh}},i.raycast=function(t,e,i){if(void 0===i&&(i=Number.MAX_VALUE),null==this._mesh||!this._mesh.loaded)return!1;var n=NaN,r=this._owner.transform,a=r.scale;n=a.x>=a.y&&a.x>=a.z?a.x:a.y>=a.z?a.y:a.z;var s=this._mesh.boundingSphere;_e.transformCoordinate(s.center,r.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=s.radius*n;var o=this._transformBoundSphere.intersectsRayPoint(t,e.position);return-1!==o&&i>=o&&this._raycastMesh(t,this._owner,e,i)?!0:(e.distance=-1,e.sprite3D=null,!1)},a(0,i,"mesh",function(){return this._mesh},function(t){this._mesh=t}),n(e,["_tempRay0",function(){return this._tempRay0=new ue(new _e,new _e)},"_tempVector30",function(){return this._tempVector30=new _e},"_tempMatrix4x40",function(){
return this._tempMatrix4x40=new ae},"_tempRaycastHit",function(){return this._tempRaycastHit=new Ce}]),e}(ti),function(t){function e(){this._originalBoundSphere=null,this._transformBoundSphere=null,e.__super.call(this),this._needUpdate=!1}r(e,"laya.d3.component.physics.SphereCollider",t);var i=e.prototype;return i._updateCollider=function(){if(this._needUpdate){var t=NaN,e=this._owner.transform,i=e.scale;t=i.x>=i.y&&i.x>=i.z?i.x:i.y>=i.z?i.y:i.z,_e.transformCoordinate(this._originalBoundSphere.center,e.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=this._originalBoundSphere.radius*t,this._needUpdate=!1}},i._onGeometryFilterLoaded=function(){this.destroyed||this._initBoundSphere()},i._onWorldMatrixChanged=function(){this._needUpdate=!0},i._initBoundSphere=function(){this.owner._geometryFilter._originalBoundingSphere.cloneTo(this._originalBoundSphere),this.owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},i._initialize=function(t){if(laya.d3.component.Component3D.prototype._initialize.call(this,t),t instanceof laya.d3.core.RenderableSprite3D){var e=t;this._originalBoundSphere=new ee(new _e(0,0,0),0),this._transformBoundSphere=new ee(new _e(0,0,0),0),e._geometryFilter._isAsyncLoaded?this._initBoundSphere():e._geometryFilter.once("loaded",this,this._onGeometryFilterLoaded)}else this._originalBoundSphere=new ee(new _e(0,0,0),.5),this._transformBoundSphere=new ee(new _e(0,0,0),.5),t.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},i.raycast=function(t,e,i){void 0===i&&(i=Number.MAX_VALUE),this._updateCollider();var n=this._transformBoundSphere.intersectsRayPoint(t,e.position);return-1!==n&&i>=n?(e.distance=n,e.sprite3D=this._owner,!0):(e.distance=-1,e.sprite3D=null,!1)},a(0,i,"center",function(){return this._originalBoundSphere.center},function(t){this._originalBoundSphere.center=t}),a(0,i,"radius",function(){return this._originalBoundSphere.radius},function(t){this._originalBoundSphere.radius=t}),a(0,i,"boundSphere",function(){return this._updateCollider(),this._transformBoundSphere}),e}(ti),function(t){function e(){this.simLodInfo=null,this._src=null,this._buffer=null,this._mipmaps=null,this._recreateLock=!1,this._needReleaseAgain=!1,e.__super.call(this),this._type=3553}r(e,"laya.d3.resource.DataTexture2D",t);var s=e.prototype;return s.genDebugMipmaps=function(){var t=[];return t.push(new Uint8Array(new Uint32Array(131072).fill(4278190335).buffer)),t.push(new Uint8Array(new Uint32Array(32768).fill(4278223103).buffer)),t.push(new Uint8Array(new Uint32Array(8192).fill(4278255615).buffer)),t.push(new Uint8Array(new Uint32Array(2048).fill(4278255360).buffer)),t.push(new Uint8Array(new Uint32Array(512).fill(4286595072).buffer)),t.push(new Uint8Array(new Uint32Array(128).fill(4294901760).buffer)),t.push(new Uint8Array(new Uint32Array(32).fill(4294901888).buffer)),t.push(new Uint8Array(new Uint32Array(8).fill(0).buffer)),t.push(new Uint8Array(new Uint32Array(2).fill(4286611584).buffer)),t.push(new Uint8Array(new Uint32Array(1).fill(4294967295).buffer)),t},s._onTextureLoaded=function(t){},s._createWebGlTexture=function(){if(!this._buffer&&!this._mipmaps)throw"create GLTextur err:no data";var t=P.mainContext;t.getExtension("EXT_shader_texture_lod");var i=this._source=t.createTexture(),n=this._width,r=this._height,a=L.curBindTexTarget,s=L.curBindTexValue;if(L.bindTexture(t,this._type,i),this._mipmaps){if(laya.d3.resource.DataTexture2D.lodasatlas){var o=0;t.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null);for(var h=0;h<this._mipmaps.length;h++){if(this._mipmaps[h].byteLength!=u*c*4)throw"mipmap size error  level:"+h;t.texSubImage2D(this._type,0,e.simLodRect[o++],e.simLodRect[o++],e.simLodRect[o++],e.simLodRect[o++],6408,5121,new Uint8Array(this._mipmaps[h]))}this.minFifter=9729,this.magFifter=9729}else{var u=this._width,c=this._height;for(o=0,t.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null),h=0;h<this._mipmaps.length;h++){if(this._mipmaps[h].byteLength!=u*c*4)throw"mipmap size error  level:"+h;t.texImage2D(this._type,h,6408,u,c,0,6408,5121,new Uint8Array(this._mipmaps[h])),u/=2,c/=2,1>u&&(u=1),1>c&&(c=1),this.minFifter=9987,this.magFifter=9729}}this.mipmap=!1}else t.texImage2D(this._type,0,6408,n,r,0,6408,5121,new Uint8Array(this._buffer));var _=this._minFifter,d=this._magFifter,f=this._repeat?10497:33071,p=l.isPOT(n,r);if(!p)throw"data texture must be POT";this._mipmap||this._mipmaps?-1!==_||(_=9987):-1!==_||(_=9729),-1!==d||(d=9729),t.texParameteri(this._type,10241,_),t.texParameteri(this._type,10240,d),t.texParameteri(this._type,10242,f),this._mipmaps?t.texParameteri(this._type,10243,33071):t.texParameteri(this._type,10243,f),this._mipmap&&t.generateMipmap(this._type),a&&s&&L.bindTexture(t,a,s),this.src&&this.src.length>0&&(this._buffer=null),p?this.memorySize=n*r*4*(1+1/3):this.memorySize=n*r*4,this._recreateLock=!1},s.recreateResource=function(){if(this._buffer||null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._buffer||this._mipmaps){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0}},s.onAsynLoaded=function(t,e,i){var n;i&&(n=i[0].call(this,e)),n&&(this._width=n.width,this._height=n.height,this._buffer=n.data),this._src=t,this._size=new Me(this._width,this._height),this._conchTexture?alert("怎么给runtime传递datatexture数据"):this.activeResource(),this._endLoaded()},s.getPixels=function(){return new Uint8Array(this._buffer)},s.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this._buffer=null,this.memorySize=0)},a(0,s,"src",function(){return this._src}),e.create=function(t,i,n,r,a,s){if(void 0===r&&(r=9729),void 0===a&&(a=9729),void 0===s&&(s=!0),!t||t.byteLength<i*n*4)throw"DataTexture2D create error";var o=new e;return o._buffer=t,o._width=i,o._height=n,o._mipmap=s,o._magFifter=r,o._minFifter=a,o._size=new Me(o._width,o._height),o._conchTexture?alert("怎么给runtime传递datatexture数据"):o.activeResource(),o},e.load=function(t,n,r,a,s){void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=9729),void 0===s&&(s=9729);var o=I.getFileExtension(t);if("mipmaps"===o){var h=i.loader.create(t,null,null,e,[function(t){this._mipmaps=[];var e=new Uint32Array(t);this._width=e[0];var i=512;if(laya.d3.resource.DataTexture2D.lodasatlas&&(this._width*=2,i=1024),this._width!=i)throw console.error("现在只支持512x256的环境贴图。当前的是"+e[0]),"现在只支持512x256的环境贴图。当前的是"+e[0];this._height=e[1];for(var n=laya.d3.resource.DataTexture2D.lodasatlas?this._width/2:this._width,r=this._height,a=8;;){var s=n*r*4;if(a+s>t.byteLength)throw"load mipmaps data size error ";var o=new Uint8Array(t,a,s);if(this._mipmaps.push(o),a+=s,1==n&&1==r)break;n/=2,r/=2,1>n&&(n=1),1>r&&(r=1)}return null}]);if(laya.d3.resource.DataTexture2D.lodasatlas){h.simLodInfo=new Float32Array(40);for(var l=0;l<h.simLodInfo.length;)h.simLodInfo[l]=(e.simLodRect[l]+.5)/1024,l++,h.simLodInfo[l]=(e.simLodRect[l]+.5)/256,l++,h.simLodInfo[l]=Math.max(e.simLodRect[l]-1,.1)/1024,l++,h.simLodInfo[l]=Math.max(e.simLodRect[l]-1.5,.1)/256,l++}return h}if("number"==typeof n)return i.loader.create(t,null,null,e,[function(t){return this._width=n,this._height=r,this._buffer=t,null}]);if("function"==typeof n)return i.loader.create(t,null,null,e,[n]);throw new Error("unknown params.")},e.lodasatlas=!1,n(e,["simLodRect",function(){return this.simLodRect=new Uint32Array([0,0,512,256,512,0,256,128,768,0,128,64,896,0,64,32,960,0,32,16,992,0,16,8,1008,0,8,4,1016,0,4,2,1020,0,2,1,1022,0,1,1])}]),e}(Xe)),Mi=function(t){function e(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,e.__super.call(this)}r(e,"laya.d3.resource.models.PrimitiveMesh",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},n._getIndexBuffer=function(){return this._indexBuffer},n.getRenderElement=function(t){return this},n.getRenderElementsCount=function(){return 1},n.detoryResource=function(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.dispose(),this._indexBuffer=null),this.memorySize=0},n._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},n._render=function(t){P.mainContext.drawElements(4,this._numberIndices,5123,0),D.drawCall++,D.trianglesFaces+=this._numberIndices/3},n._renderRuntime=function(t,e,i){t.drawSubmesh(e._conchSubmesh,0,4,0,this._numberIndices)},a(0,n,"_vertexBufferCount",function(){return 1}),a(0,n,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,n,"positions",function(){var t,e=[],i=this._vertexBuffer.vertexDeclaration.getVertexElements(),n=0;for(n=0;n<i.length;n++){var r=i[n];if("vector3"===r.elementFormat&&0===r.elementUsage){t=r;break}}var a=this._vertexBuffer.getData();for(n=0;n<a.length;n+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var s=n+t.offset/4,o=new _e(a[s+0],a[s+1],a[s+2]);e.push(o)}return e}),e}(qe),Di=function(t){function e(){this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._bindPoses=null,this._inverseBindPoses=null,e.__super.call(this),this._subMeshes=[],this._materials=[],this._vertexBuffers=[]}r(e,"laya.d3.resource.models.Mesh",t);var n=e.prototype;return n._setSubMeshes=function(t){this._subMeshes=t,this._subMeshCount=t.length;for(var e=0;e<this._subMeshCount;e++)t[e]._indexInMesh=e;this._generateBoundingObject()},n.onAsynLoaded=function(t,e,i){var n=e[0],r=e[1];Qt.read(n,this,this._materials,this._subMeshes,r),this.completeCreate(),this._endLoaded()},n.getSubMesh=function(t){return this._subMeshes[t]},n.getSubMeshCount=function(){return this._subMeshes.length},n.getRenderElementsCount=function(){return this._subMeshes.length},n.getRenderElement=function(t){return this._subMeshes[t]},n.detoryResource=function(){for(var t=0;t<this._subMeshes.length;t++)this._subMeshes[t].dispose();this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._bindPoses=null,this._inverseBindPoses=null},a(0,n,"positions",function(){var t,e,i,n,r,a=[],s=0,o=0,h=0;if(0!==this._vertexBuffers.length){var l=this._vertexBuffers.length;for(s=0;l>s;s++){for(t=this._vertexBuffers[s],i=t.vertexDeclaration.getVertexElements(),o=0;o<i.length;o++)if(n=i[o],"vector3"===n.elementFormat&&0===n.elementUsage){e=n;break}for(r=t.getData(),o=0;o<r.length;o+=t.vertexDeclaration.vertexStride/4)h=o+e.offset/4,a.push(new _e(r[h+0],r[h+1],r[h+2]))}}else{var u=this._subMeshes.length;for(s=0;u>s;s++){var c=this._subMeshes[s];for(t=c._getVertexBuffer(),i=t.vertexDeclaration.getVertexElements(),o=0;o<i.length;o++)if(n=i[o],"vector3"===n.elementFormat&&0===n.elementUsage){e=n;break}for(r=t.getData(),o=0;o<r.length;o+=t.vertexDeclaration.vertexStride/4)h=o+e.offset/4,a.push(new _e(r[h+0],r[h+1],r[h+2]))}}return a}),a(0,n,"materials",function(){return this._materials.slice()}),a(0,n,"bindPoses",function(){return this._bindPoses}),a(0,n,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),e.load=function(t){return i.loader.create(t,null,null,e)},e}(qe),Ai=function(t){function e(t,i,n,r,a,s,o,h,l){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===h&&(h=-1),void 0===l&&(l=-1),e.__super.call(this),this._type=3553,this._width=t,this._height=i,this._size=new Me(t,i),this._surfaceFormat=n,this._surfaceType=r,this._depthStencilFormat=a,this._mipmap=s,this._repeat=o,this._minFifter=h,this._magFifter=l,this.activeResource(),this._alreadyResolved=!0}r(e,"laya.d3.resource.RenderTexture",t);var i=e.prototype;return i.recreateResource=function(){var t=P.mainContext;this._frameBuffer=t.createFramebuffer(),this._source=t.createTexture();var e=L.curBindTexTarget,i=L.curBindTexValue;L.bindTexture(t,this._type,this._source),t.texImage2D(this._type,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null);var n=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071,s=l.isPOT(this._width,this._height);if(s?(this._mipmap?-1!==n||(n=9987):-1!==n||(n=9729),-1!==r||(r=9729),t.texParameteri(this._type,10241,n),t.texParameteri(this._type,10240,r),t.texParameteri(this._type,10242,a),t.texParameteri(this._type,10243,a),this._mipmap&&t.generateMipmap(this._type)):(-1!==n||(n=9729),-1!==r||(r=9729),t.texParameteri(this._type,10241,n),t.texParameteri(this._type,10240,r),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),t.bindFramebuffer(36160,this._frameBuffer),t.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,this._depthStencilBuffer),t.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:t.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:t.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:t.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}t.bindFramebuffer(36160,null),e&&i&&L.bindTexture(t,e,i),t.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},i.start=function(){P.mainContext.bindFramebuffer(36160,this.frameBuffer),e._currentRenderTarget=this,this._alreadyResolved=!1},i.end=function(){P.mainContext.bindFramebuffer(36160,null),e._currentRenderTarget=null,this._alreadyResolved=!0},i.getData=function(t,e,i,n){var r=P.mainContext;r.bindFramebuffer(36160,this._frameBuffer);var a=36053===r.checkFramebufferStatus(36160);if(!a)return r.bindFramebuffer(36160,null),null;var s=new Uint8Array(this._width*this._height*4);return r.readPixels(t,e,i,n,this._surfaceFormat,this._surfaceType,s),r.bindFramebuffer(36160,null),s},i.detoryResource=function(){if(this._frameBuffer){var t=P.mainContext;t.deleteTexture(this._source),t.deleteFramebuffer(this._frameBuffer),t.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0}},a(0,i,"surfaceFormat",function(){return this._surfaceFormat}),a(0,i,"surfaceType",function(){return this._surfaceType}),a(0,i,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,i,"source",function(){return this._alreadyResolved?t.prototype._$get_source.call(this):null}),a(0,i,"depthStencilBuffer",function(){return this._depthStencilBuffer}),a(0,i,"frameBuffer",function(){return this._frameBuffer}),e._currentRenderTarget=null,e}(Xe),Ri=function(t){function e(t){this._color=null,this._pixels=null,e.__super.call(this),this._type=3553,this._width=1,this._height=1,this._size=new Me(this.width,this.height),this._color=t,this._pixels=new Uint8Array([255*t.x,255*t.y,255*t.z,255*t.w])}r(e,"laya.d3.resource.SolidColorTexture2D",t);var i=e.prototype;return i._createWebGlTexture=function(){var t=P.mainContext,e=this._source=t.createTexture(),i=this._width,n=this._height,r=L.curBindTexTarget,a=L.curBindTexValue;L.bindTexture(t,this._type,e),t.texImage2D(this._type,0,6408,i,n,0,6408,5121,this._pixels);var s=this._minFifter,o=this._magFifter,h=this._repeat?10497:33071,u=l.isPOT(i,n);u?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,h),t.texParameteri(this._type,10243,h),this._mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&L.bindTexture(t,r,a),u?this.memorySize=i*n*4*(1+1/3):this.memorySize=i*n*4},i.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},i.detoryResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,i,"source",function(){return t.prototype._$get_source.call(this)}),n(e,["magentaTexture",function(){return this.magentaTexture=new e(new de(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new e(new de(.5,.5,.5,1))}]),e}(Xe),Ii=function(t){function e(t){this._color=null,this._pixels=null,this._texCount=6,e.__super.call(this),this._type=34067,this._width=1,this._height=1,this._size=new Me(this.width,this.height),this._color=t,this._pixels=new Uint8Array([255*t.x,255*t.y,255*t.z,255*t.w])}r(e,"laya.d3.resource.SolidColorTextureCube",t);var i=e.prototype;return i._createWebGlTexture=function(){var t=P.mainContext,e=this._source=t.createTexture(),i=this._width,n=this._height,r=L.curBindTexTarget,a=L.curBindTexValue;L.bindTexture(t,this._type,e),t.texImage2D(34069,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34070,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34071,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34072,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34073,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34074,0,6408,i,n,0,6408,5121,this._pixels);var s=this.minFifter,o=this.magFifter,h=this._repeat?10497:33071,u=l.isPOT(i,n);u?(this.mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,h),t.texParameteri(this._type,10243,h),this.mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&L.bindTexture(t,r,a),u?this.memorySize=i*n*4*(1+1/3)*this._texCount:this.memorySize=i*n*4*this._texCount},i.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},i.detoryResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n(e,["magentaTexture",function(){return this.magentaTexture=new e(new de(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new e(new de(.5,.5,.5,1))}]),e}(Xe),Pi=function(t){function e(t,i,n,r){this._canRead=!1,this._image=null,this._pixels=null,void 0===t&&(t=!1),void 0===i&&(i=!0),void 0===n&&(n=6408),void 0===r&&(r=!0),e.__super.call(this),this._type=3553,this._repeat=i,this._canRead=t,this._format=n,this._mipmap=r}r(e,"laya.d3.resource.Texture2D",t);var n=e.prototype;return n._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var t=P.mainContext,e=this._source=t.createTexture(),i=this._width,n=this._height,r=L.curBindTexTarget,a=L.curBindTexValue;switch(L.bindTexture(t,this._type,e),this._format){case 6407:case 6408:this._canRead?t.texImage2D(this._type,0,this._format,i,n,0,this._format,5121,this._pixels):t.texImage2D(this._type,0,this._format,this._format,5121,this._image);break;case P.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:t.compressedTexImage2D(this._type,0,this._format,this._width,this._height,0,this._image)}var s=this._minFifter,o=this._magFifter,h=this._repeat?10497:33071,u=l.isPOT(i,n);u?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,h),t.texParameteri(this._type,10243,h),this._mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&L.bindTexture(t,r,a),this._image.onload=null,this._image=null,u?this.memorySize=i*n*4*(1+1/3):this.memorySize=i*n*4},n.recreateResource=function(){this.loaded&&(this._createWebGlTexture(),this.completeCreate())},n.onAsynLoaded=function(t,e,i){if(i){var n=i[0];n&&(this._canRead=n);var r=i[1];r&&(this._repeat=r);var a=i[2];a&&(this._format=a);var s=i[3];s&&(this._mipmap=s)}switch(this.url=t,this._format){case 6407:case 6408:this._image=e;var o=e.width,h=e.height;this._width=o,this._height=h,this._size=new Me(o,h),this._canRead&&(_.canvas.size(o,h),_.canvas.clear(),_.context.drawImage(e,0,0,o,h),this._pixels=new Uint8Array(_.context.getImageData(0,0,o,h).data.buffer));break;case P.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:var l=new f(e);l.readUTFBytes(4),l.readUTFBytes(2),l.getInt16();l.endian="bigEndian",this._width=l.getInt16(),this._height=l.getInt16(),this._size=new Me(this._width,this._height);l.getInt16(),l.getInt16();this._image=new Uint8Array(e,l.pos)}this._conchTexture?this._conchTexture.setTexture2DImage(this._image):this.activeResource(),this._endLoaded()},n.getPixels=function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")},n.detoryResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},a(0,n,"_src",function(){return this.url}),a(0,n,"src",function(){return this.url}),e.load=function(t){return i.loader.create(t,null,null,e)},e}(Xe),Li=function(t){function e(){this._texCount=6,this._recreateLock=!1,this._needReleaseAgain=!1,e.__super.call(this),this._type=34067}r(e,"laya.d3.resource.TextureCube",t);var n=e.prototype;return n._onTextureLoaded=function(t){this._images=t;for(var e=2147483647,i=2147483647,n=0;6>n;n++){var r=t[n];e=Math.min(e,r.width),i=Math.min(i,r.height)}this._width=e,this._height=i,this._size=new Me(e,i)},n._createWebGlTexture=function(){var t=0;for(t=0;t<this._texCount;t++)if(!this._images[t])throw"create GLTextur err:no data:"+this._images[t];var e=P.mainContext,i=this._source=e.createTexture(),n=this._width,r=this._height,a=L.curBindTexTarget,s=L.curBindTexValue;L.bindTexture(e,this._type,i),e.texImage2D(34069,0,6408,6408,5121,this._images[0]),e.texImage2D(34070,0,6408,6408,5121,this._images[1]),e.texImage2D(34071,0,6408,6408,5121,this._images[2]),e.texImage2D(34072,0,6408,6408,5121,this._images[3]),e.texImage2D(34073,0,6408,6408,5121,this._images[4]),e.texImage2D(34074,0,6408,6408,5121,this._images[5]);var o=this.minFifter,h=this.magFifter,u=this._repeat?10497:33071,c=l.isPOT(n,r);for(c?(this.mipmap?-1!==o||(o=9987):-1!==o||(o=9729),-1!==h||(h=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,h),e.texParameteri(this._type,10242,u),e.texParameteri(this._type,10243,u),this.mipmap&&e.generateMipmap(this._type)):(-1!==o||(o=9729),-1!==h||(h=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,h),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),a&&s&&L.bindTexture(e,a,s),t=0;6>t;t++)this._images[t].onload=null,this._images[t]=null;c?this.memorySize=n*r*4*(1+1/3)*this._texCount:this.memorySize=n*r*4*this._texCount,this._recreateLock=!1},n.recreateResource=function(){var t=this;if(null!=this._srcs)if(this._needReleaseAgain=!1,this._images[0]){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0;for(var e=this,i=0;i<this._texCount;i++){this._images[i]=new _.window.Image,this._images[i].crossOrigin="";var n=i;this._images[n].onload=function(){var i=0;if(e._needReleaseAgain){for(i=0;i<t._texCount;i++)if(!e._images[i].complete)return;for(e._needReleaseAgain=!1,i=0;i<t._texCount;i++)e._images[i].onload=null,e._images[i]=null}else{for(i=0;i<t._texCount;i++)if(!e._images[i].complete)return;e._createWebGlTexture(),e.completeCreate()}},this._images[i].src=this._srcs[i]}}},n.onAsynLoaded=function(t,e,i){this._srcs=t,this._onTextureLoaded(e),this._conchTexture?this._conchTexture.setTextureCubeImages(this._images):this.activeResource(),this._endLoaded()},n.detoryResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,n,"srcs",function(){return this._srcs}),a(0,n,"defaulteTexture",function(){return Ii.grayTexture}),e.load=function(t){return i.loader.create(t,null,null,e)},e}(Xe),Ni=(function(t){function e(){this._numberVertices=0,this._numberIndices=0,this._textureCube=null,e.__super.call(this),this.name="Skybox-"+e._nameNumber,e._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}r(e,"laya.d3.resource.models.SkyBox",t);var i=e.prototype;return i._getShader=function(t){var e=t.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(e,0,0),this._shader},i.recreateResource=function(){this._numberVertices=36,this._numberIndices=36;var t=new Uint16Array(this._numberIndices),i=e._vertexDeclaration.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=1,a=1,s=1,o=r/2,h=a/2,l=s/2,u=new _e(-o,h,l),c=new _e(-o,-h,l),_=new _e(o,h,l),d=new _e(o,-h,l),f=new _e(-o,h,-l),p=new _e(o,h,-l),m=new _e(-o,-h,-l),g=new _e(o,-h,-l),y=0;y=this._addVertex(n,y,u),y=this._addVertex(n,y,c),y=this._addVertex(n,y,_),y=this._addVertex(n,y,c),y=this._addVertex(n,y,d),y=this._addVertex(n,y,_),y=this._addVertex(n,y,f),y=this._addVertex(n,y,p),y=this._addVertex(n,y,m),y=this._addVertex(n,y,m),y=this._addVertex(n,y,p),y=this._addVertex(n,y,g),y=this._addVertex(n,y,u),y=this._addVertex(n,y,p),y=this._addVertex(n,y,f),y=this._addVertex(n,y,u),y=this._addVertex(n,y,_),y=this._addVertex(n,y,p),y=this._addVertex(n,y,c),y=this._addVertex(n,y,m),y=this._addVertex(n,y,g),y=this._addVertex(n,y,c),y=this._addVertex(n,y,g),y=this._addVertex(n,y,d),y=this._addVertex(n,y,u),y=this._addVertex(n,y,m),y=this._addVertex(n,y,c),y=this._addVertex(n,y,f),y=this._addVertex(n,y,m),y=this._addVertex(n,y,u),y=this._addVertex(n,y,_),y=this._addVertex(n,y,d),y=this._addVertex(n,y,g),y=this._addVertex(n,y,p),y=this._addVertex(n,y,_),y=this._addVertex(n,y,g);for(var x=0;36>x;x++)t[x]=x;if(this._vertexBuffer=new Si(e._vertexDeclaration,this._numberVertices,35044,!0),this._indexBuffer=new vi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(t),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate(),this._conchSky){this._conchSky.setVBIB(e._vertexDeclaration._conchVertexDeclaration,n,t),this._sharderNameID=di.nameKey.getID("SkyBox");var v=me._preCompileShader[this._sharderNameID];this._conchSky.setShader(v._conchShader)}},i._addVertex=function(t,e,i){var n=i.elements;return t[e+0]=n[0],t[e+1]=n[1],t[e+2]=n[2],e+3},i.loadShaderParams=function(){this._sharderNameID=di.nameKey.getID("SkyBox"),this._shaderCompile=me._preCompileShader[this._sharderNameID]},i._render=function(t){this._textureCube&&this._textureCube.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(t),this._shader.bind(),t.camera.transform.worldMatrix.cloneTo(e._tempMatrix4x40),e._tempMatrix4x40.transpose(),ae.multiply(t._projectionMatrix,e._tempMatrix4x40,e._tempMatrix4x41),t.camera._shaderValues.setValue(4,e._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(t.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.textureCube.source),this._shader.uploadAttributes(e._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),P.mainContext.drawElements(4,36,5123,0),D.trianglesFaces+=12,D.drawCall++)},a(0,i,"textureCube",function(){return this._textureCube},function(t){this._textureCube=t,this._conchSky&&this._conchSky.setTextureCube(this._textureCube._conchTexture,0,3)}),e._nameNumber=1,n(e,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new ae},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new ae},"_vertexDeclaration",function(){return this._vertexDeclaration=new mt(12,[new gt(0,"vector3",0)])}]),e}(Ke),function(t){function e(){this._numberVertices=0,this._numberIndices=0,this._texture=null,this._stacks=16,this._slices=16,this._radius=1,e.__super.call(this),this.name="SkyDome-"+e._nameNumber,e._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}r(e,"laya.d3.resource.models.SkyDome",t);var s=e.prototype;return s._getShader=function(t){var e=t.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(e,0,0),this._shader},s.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var t=new Uint16Array(this._numberIndices),i=e._vertexDeclaration.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,h=0,l=0;l<this._stacks+1;l++)for(var u=Math.sin(l*r),c=Math.cos(l*r),_=0;_<this._slices+1;_++){var d=u*Math.sin(_*a),f=u*Math.cos(_*a);n[o+0]=d*this._radius,n[o+1]=c*this._radius,n[o+2]=f*this._radius,n[o+3]=-(_/this._slices)+.75,n[o+4]=l/this._stacks,o+=i,l!=this._stacks-1&&(t[h++]=s+1,t[h++]=s,t[h++]=s+(this._slices+1),t[h++]=s+(this._slices+1),t[h++]=s,t[h++]=s+this._slices,s++)}if(this._vertexBuffer=new Si(e._vertexDeclaration,this._numberVertices,35044),this._indexBuffer=new vi("ushort",this._numberIndices,35044),this._vertexBuffer.setData(n),this._indexBuffer.setData(t),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate(),this._conchSky){this._conchSky.setVBIB(e._vertexDeclaration._conchVertexDeclaration,n,t),this._sharderNameID=di.nameKey.getID("SkyDome");var p=me._preCompileShader[this._sharderNameID];this._conchSky.setShader(p._conchShader)}},s.loadShaderParams=function(){this._sharderNameID=di.nameKey.getID("SkyDome"),this._shaderCompile=me._preCompileShader[this._sharderNameID]},s._render=function(t){this._texture&&this._texture.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(t),this._shader.bind(),t.camera.transform.worldMatrix.cloneTo(e._tempMatrix4x40),e._tempMatrix4x40.transpose(),ae.multiply(t._projectionMatrix,e._tempMatrix4x40,e._tempMatrix4x41),t.camera._shaderValues.setValue(4,e._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(t.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.texture.source),this._shader.uploadAttributes(e._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),P.mainContext.drawElements(4,this._indexBuffer.indexCount,5123,0),D.trianglesFaces+=this._numberIndices/3,D.drawCall++)},s.onEnvDescLoaded=function(t){var e="",n=Math.max(t.lastIndexOf("/"),t.lastIndexOf("\\"));n>0&&(e=t.substr(0,n+1));var r=i.loader.getRes(t);void 0!=r.ev&&this.__ownerCamera?this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,r.ev)):this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,0)),this.texture=Pi.load(e+r.skytex),this.environmentSpecular=Ci.load(e+r.prefiltedEnv);var a=new Float32Array(r.IrradianceMat);this.envDiffuseSHRed=a.slice(0,16),this.envDiffuseSHGreen=a.slice(16,32),this.envDiffuseSHBlue=a.slice(32,48)},s.loadEnvInfo=function(t){i.loader.load(t,y.create(this,this.onEnvDescLoaded,[t]))},a(0,s,"texture",function(){return this._texture},function(t){this._texture=t,this._conchSky&&this._conchSky.setTexture(this._texture._conchTexture,0,3)}),e._nameNumber=1,n(e,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new ae},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new ae},"_vertexDeclaration",function(){return this._vertexDeclaration=new mt(20,[new gt(0,"vector3",0),new gt(12,"vector2",2)])}]),e}(Ke),function(t){function e(t){this._cacheAvatar=null,this._cacheMesh=null,this._cacheAnimationNode=null,this._skinnedDatas=null,this._publicSubSkinnedDatas=null,
e.__super.call(this,t),this._cacheAnimationNode=[],this._owner.meshFilter.on("meshchanged",this,this._$3__onMeshChanged)}r(e,"laya.d3.core.SkinnedMeshRender",t);var i=e.prototype;return i._getCacheAnimationNodes=function(){var t=this._cacheMesh._boneNames,e=t.length;this._cacheAnimationNode.length=e;for(var i=this._owner._belongAnimator._avatarNodeMap,n=0;e>n;n++)this._cacheAnimationNode[n]=i[t[n]]},i._offComputeBoneIndexToMeshEvent=function(t,e){t.loaded?e.loaded||e.off("loaded",this,this._getCacheAnimationNodes):t.off("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},i._computeBoneIndexToMeshWithAsyncAvatar=function(){this._cacheAvatar.loaded?this._computeBoneIndexToMeshWithAsyncMesh():this._cacheAvatar.once("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},i._computeBoneIndexToMeshWithAsyncMesh=function(){this._cacheMesh.loaded?this._getCacheAnimationNodes():this._cacheMesh.on("loaded",this,this._getCacheAnimationNodes)},i._$3__onMeshChanged=function(t,e,i){this._cacheMesh=i;var n=i.subMeshCount;this._skinnedDatas=new Float32Array(16*i.InverseAbsoluteBindPoses.length),this._publicSubSkinnedDatas=[],this._publicSubSkinnedDatas.length=n;for(var r=0;n>r;r++)for(var a=this._publicSubSkinnedDatas[r]=[],s=i.getSubMesh(r)._boneIndicesList,o=0,h=s.length;h>o;o++)a[o]=new Float32Array(16*s[o].length);this._cacheAvatar&&(e&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,e),i&&this._computeBoneIndexToMeshWithAsyncAvatar())},i._setCacheAvatar=function(t){this._cacheAvatar!==t&&(this._cacheMesh?(this._cacheAvatar&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,this._cacheMesh),this._cacheAvatar=t,t&&(this._addShaderDefine(Bi.SHADERDEFINE_BONE),this._computeBoneIndexToMeshWithAsyncAvatar())):this._cacheAvatar=t)},i._renderUpdate=function(t){var i,n=0,r=this._owner._belongAnimator,a=this._cacheMesh.subMeshCount;if(r){var s=r.owner;if(this._setShaderValueMatrix4x4(0,s._transform.worldMatrix),i=s.getProjectionViewWorldMatrix(t),this._setShaderValueMatrix4x4(1,i),this._cacheMesh&&this._cacheMesh.loaded&&this._cacheAvatar&&this._cacheAvatar.loaded){var o,h,l,u,c,_=0,d=0,f=0;if(0!==r.playState&&r._canCache){if(o=r.currentPlayClip._getSkinnedDatasWithCache(this._cacheMesh,this._cacheAvatar,r.cachePlayRate,r.currentFrameIndex)){for(n=0;a>n;n++)this._renderElements[n]._skinAnimationDatas=o[n];return}for(r._updateTansformProperty(),l=this._cacheMesh._inverseBindPoses,n=0,_=l.length;_>n;n++)De._mulMatrixArray(this._cacheAnimationNode[n]._transform._getWorldMatrix(),l[n],this._skinnedDatas,16*n);for(o=[],o.length=a,n=0;a>n;n++){for(c=o[n]=[],u=this._cacheMesh.getSubMesh(n)._boneIndicesList,f=u.length,c.length=f,d=0;f>d;d++)c[d]=new Float32Array(16*u[d].length),e._splitAnimationDatas(u[d],this._skinnedDatas,c[d]);this._renderElements[n]._skinAnimationDatas=c}r.currentPlayClip._cacheSkinnedDatasWithCache(this._cacheMesh,this._cacheAvatar,r.cachePlayRate,r.currentFrameIndex,o)}else{for(l=this._cacheMesh._inverseBindPoses,n=0,_=l.length;_>n;n++)De._mulMatrixArray(this._cacheAnimationNode[n]._transform._getWorldMatrix(),l[n],this._skinnedDatas,16*n);for(n=0;a>n;n++){for(h=this._cacheMesh.getSubMesh(n),u=h._boneIndicesList,f=u.length,c=this._publicSubSkinnedDatas[n],d=0;f>d;d++)e._splitAnimationDatas(u[d],this._skinnedDatas,c[d]);this._renderElements[n]._skinAnimationDatas=c}}}}else this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix),i=this._owner.getProjectionViewWorldMatrix(t),this._setShaderValueMatrix4x4(1,i)},e._splitAnimationDatas=function(t,e,i){for(var n=0,r=t.length,a=0;r>n;n++)for(var s=0;16>s;s++,a++)i[a]=e[(t[n]<<4)+s]},e}(ni)),Oi=function(t){function e(t,i,n){void 0===t&&(t=0),void 0===i&&(i=.3),void 0===n&&(n=1e3),this._viewMatrix=new ae,this._projectionMatrix=new ae,this._projectionViewMatrix=new ae,this._viewport=new fe(0,0,0,0),this._normalizedViewport=new fe(0,0,1,1),this._aspectRatio=t,this._boundFrustumUpdate=!0,this._boundFrustum=new te(ae.DEFAULT),e.__super.call(this,i,n),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}r(e,"laya.d3.core.Camera",t);var s=e.prototype;return s._onWorldMatrixChanged=function(){this._boundFrustumUpdate=!0},s._parseCustomProps=function(t,e,i){laya.d3.core.Sprite3D.prototype._parseCustomProps.call(this,t,e,i);var n=e.clearColor;this.clearColor=new de(n[0],n[1],n[2],n[3]);var r=e.viewport;this.normalizedViewport=new fe(r[0],r[1],r[2],r[3])},s._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var t=this.orthographicVerticalSize*this.aspectRatio*.5,e=.5*this.orthographicVerticalSize;ae.createOrthogonal(-t,t,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else ae.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._boundFrustumUpdate=!0},s._update=function(t){this.conchModel&&(this.conchModel.setViewMatrix(this.viewMatrix.elements),this.conchModel.setProjectMatrix(this.projectionMatrix.elements)),laya.d3.core.Sprite3D.prototype._update.call(this,t)},s._renderCamera=function(t,e,i){i.parallelSplitShadowMaps[0]&&i._renderShadowMap(t,e,this),e.camera=this,this._prepareCameraToRender(),i.beforeRender(e);var n,r;n=e._viewMatrix=this.viewMatrix;var a=this._renderTarget;a?(a.start(),ae.multiply(ui._invertYScaleMatrix,this._projectionMatrix,ui._invertYProjectionMatrix),ae.multiply(ui._invertYScaleMatrix,this.projectionViewMatrix,ui._invertYProjectionViewMatrix),r=e._projectionMatrix=ui._invertYProjectionMatrix,e._projectionViewMatrix=ui._invertYProjectionViewMatrix):(r=e._projectionMatrix=this._projectionMatrix,e._projectionViewMatrix=this.projectionViewMatrix),this._prepareCameraViewProject(n,r),e._boundFrustum=this.boundFrustum,e._viewport=this.viewport,i._preRenderScene(t,e),i._clear(t,e),i._renderScene(t,e),i.lateRender(e),a&&a.end()},s.viewportPointToRay=function(t,e){be.calculateCursorRay(t,this.viewport,this._projectionMatrix,this.viewMatrix,null,e)},s.normalizedViewportPointToRay=function(t,i){var n=e._tempVector20,r=this.viewport,a=t.elements,s=n.elements;s[0]=a[0]*r.width,s[1]=a[1]*r.height,be.calculateCursorRay(n,this.viewport,this._projectionMatrix,this.viewMatrix,null,i)},s.worldToViewportPoint=function(t,e){ae.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(t,this._projectionViewMatrix,e);var n=e.elements;e.z<0||e.z>1?n[0]=n[1]=n[2]=NaN:(n[0]=n[0]/i.stage.clientScaleX,n[1]=n[1]/i.stage.clientScaleY)},s.worldToNormalizedViewportPoint=function(t,e){ae.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(t,this._projectionViewMatrix,e);var n=e.elements;e.z<0||e.z>1?n[0]=n[1]=n[2]=NaN:(n[0]=n[0]/i.stage.clientScaleX,n[1]=n[1]/i.stage.clientScaleY)},a(0,s,"projectionViewMatrix",function(){return ae.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),a(0,s,"aspectRatio",function(){if(0===this._aspectRatio){var t=this.viewport;return t.width/t.height}return this._aspectRatio},function(t){if(0>t)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=t,this._calculateProjectionMatrix()}),a(0,s,"boundFrustum",function(){return this._boundFrustumUpdate&&(this._boundFrustum.matrix=this.projectionViewMatrix),this._boundFrustum}),a(0,s,"needViewport",function(){var t=this.normalizedViewport;return 0===t.x&&0===t.y&&1===t.width&&1===t.height}),a(0,s,"viewport",function(){if(this._viewportExpressedInClipSpace){var t=this._normalizedViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._viewport.x=t.x*i,this._viewport.y=t.y*n,this._viewport.width=t.width*i,this._viewport.height=t.height*n}return this._viewport},function(t){if(null!=this.renderTarget&&(t.x<0||t.y<0||0==t.width||0==t.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=t,this._calculateProjectionMatrix()}),a(0,s,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var t=this._viewport,e=this.renderTargetSize,i=e.width,n=e.height;this._normalizedViewport.x=t.x/i,this._normalizedViewport.y=t.y/n,this._normalizedViewport.width=t.width/i,this._normalizedViewport.height=t.height/n}return this._normalizedViewport},function(t){if(t.x<0||t.y<0||t.x+t.width>1||t.y+t.height>1)throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._normalizedViewport=t,this._calculateProjectionMatrix()}),a(0,s,"projectionMatrix",function(){return this._projectionMatrix},function(t){this._projectionMatrix=t,this._useUserProjectionMatrix=!0}),a(0,s,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),n(e,["_tempVector20",function(){return this._tempVector20=new ce}]),e}(ui),Vi=(function(t){function e(){e.__super.call(this),this._render=new ei(this),this._render.on("materialchanged",this,this._onMaterialChanged);var t=new pi;this._render.sharedMaterial=t,this._geometryFilter=new si(this),t.renderMode=8,this._changeRenderObject(0)}r(e,"laya.d3.core.glitter.Glitter",t);var i=e.prototype;return i._changeRenderObject=function(t){var e=this._render._renderElements,i=e[t];i||(i=e[t]=new ot),i._render=this._render;var n=this._render.sharedMaterials[t];n||(n=pi.defaultMaterial);var r=this._geometryFilter;return i._mainSortID=0,i._sprite3D=this,i.renderObj=r,i._material=n,i},i._onMaterialChanged=function(t,e,i){var n=t._renderElements.length;n>e&&this._changeRenderObject(e)},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},i._update=function(e){this._geometryFilter._update(e.elapsedTime),t.prototype._update.call(this,e)},i.addGlitterByPositions=function(t,e){this._geometryFilter.addVertexPosition(t,e)},i.addGlitterByPositionsVelocitys=function(t,e,i,n){this._geometryFilter.addVertexPositionVelocity(t,e,i,n)},i.cloneTo=function(t){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t);var e=t,i=e.templet,n=this._geometryFilter;i.lifeTime=n.lifeTime,i.minSegmentDistance=n.minSegmentDistance,i.minInterpDistance=n.minInterpDistance,i.maxSlerpCount=n.maxSlerpCount,i._maxSegments=n._maxSegments;var r=e._render,a=this._render;r.sharedMaterials=a.sharedMaterials,r.enable=a.enable},i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null},a(0,i,"templet",function(){return this._geometryFilter}),a(0,i,"glitterRender",function(){return this._render}),e.CURRENTTIME=2,e.DURATION=3,e}(ci),function(t){function e(){this._updateDirection=!1,this._direction=null,e.__super.call(this),this._updateDirection=!1,this.direction=new _e(0,-.5,-1),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}r(e,"laya.d3.core.light.DirectionLight",t);var i=e.prototype;return i._initShadow=function(){if(this._shadow)this._parallelSplitShadowMap=new xe,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this.direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var t=this.scene.parallelSplitShadowMaps;t.splice(t.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,this.scene.removeShaderDefine(xe.SHADERDEFINE_SHADOW_PSSM1),this.scene.removeShaderDefine(xe.SHADERDEFINE_SHADOW_PSSM2),this.scene.removeShaderDefine(xe.SHADERDEFINE_SHADOW_PSSM3)}},i._onWorldMatrixChange=function(){this._updateDirection=!0},i._addSelfRenderObjects=function(){t.prototype._addSelfRenderObjects.call(this),this._shadow&&this._initShadow()},i._clearSelfRenderObjects=function(){var t=this.scene,e=t._shaderValues;e.setValue(4,null),e.setValue(3,null),t.removeShaderDefine(me.SHADERDEFINE_DIRECTIONLIGHT)},i.updateToWorldState=function(t){var e=t.scene;if(e.enableLight&&this._activeInHierarchy){var i=e._shaderValues;return e.addShaderDefine(me.SHADERDEFINE_DIRECTIONLIGHT),i.setValue(4,this.color.elements),i.setValue(3,this.direction.elements),!0}return e.removeShaderDefine(me.SHADERDEFINE_DIRECTIONLIGHT),!1},a(0,i,"direction",function(){return this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),_e.normalize(this._direction,this._direction),this._updateDirection=!1),this._direction},function(t){var e=this.transform.worldMatrix;e.setForward(t),this.transform.worldMatrix=e,_e.normalize(t,t),this._direction=t,this.shadow&&this._parallelSplitShadowMap&&this._parallelSplitShadowMap._setGlobalParallelLightDir(this._direction)}),a(0,i,"lightType",function(){return 1}),a(0,i,"shadow",t.prototype._$get_shadow,function(t){this._shadow!==t&&(this._shadow=t,this.scene&&this._initShadow())}),e}(_i),function(t){function e(){this._attenuation=null,this._range=NaN,e.__super.call(this),this.transform.position=new _e(0,0,0),this._range=6,this._attenuation=new _e(.6,.6,.6)}r(e,"laya.d3.core.light.PointLight",t);var i=e.prototype;return i._clearSelfRenderObjects=function(){var t=this.scene,e=t._shaderValues;e.setValue(8,null),e.setValue(5,null),e.setValue(6,null),e.setValue(7,null),t.removeShaderDefine(me.SHADERDEFINE_POINTLIGHT)},i.updateToWorldState=function(t){var e=t.scene;if(e.enableLight&&this._activeInHierarchy){var i=e._shaderValues;return e.addShaderDefine(me.SHADERDEFINE_POINTLIGHT),i.setValue(8,this.color.elements),i.setValue(5,this.transform.position.elements),i.setValue(6,this.range),i.setValue(7,this.attenuation.elements),!0}return e.removeShaderDefine(me.SHADERDEFINE_POINTLIGHT),!1},a(0,i,"range",function(){return this._range},function(t){this._range=t}),a(0,i,"lightType",function(){return 2}),a(0,i,"attenuation",function(){return this._attenuation},function(t){this._attenuation=t}),e}(_i),function(t){function e(){this._updateDirection=!1,this._direction=null,this._attenuation=null,this._spot=NaN,this._range=NaN,e.__super.call(this),this.transform.position=new _e(0,1,1),this._updateDirection=!1,this.direction=new _e(0,-1,-1),this._attenuation=new _e(.6,.6,.6),this._spot=96,this._range=6,this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}r(e,"laya.d3.core.light.SpotLight",t);var i=e.prototype;return i._onWorldMatrixChange=function(){this._updateDirection=!0},i._clearSelfRenderObjects=function(){var t=this.scene,e=t._shaderValues;e.setValue(14,null),e.setValue(9,null),e.setValue(10,null),e.setValue(12,null),e.setValue(11,null),e.setValue(13,null),t.removeShaderDefine(me.SHADERDEFINE_SPOTLIGHT)},i.updateToWorldState=function(t){var e=t.scene;if(e.enableLight&&this._activeInHierarchy){var i=e._shaderValues;return e.addShaderDefine(me.SHADERDEFINE_SPOTLIGHT),i.setValue(14,this.color.elements),i.setValue(9,this.transform.position.elements),i.setValue(10,this.direction.elements),i.setValue(12,this.range),i.setValue(11,this.spot),i.setValue(13,this.attenuation.elements),!0}return e.removeShaderDefine(me.SHADERDEFINE_SPOTLIGHT),!1},a(0,i,"range",function(){return this._range},function(t){this._range=t}),a(0,i,"direction",function(){return this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),this._updateDirection=!1),this._direction},function(t){var e=this.transform.worldMatrix;e.setForward(t),this.transform.worldMatrix=e,this._direction=t}),a(0,i,"lightType",function(){return 3}),a(0,i,"attenuation",function(){return this._attenuation},function(t){this._attenuation=t}),a(0,i,"spot",function(){return this._spot},function(t){this._spot=t}),e}(_i),function(t){function e(t,i){e.__super.call(this,i),this._geometryFilter=new ii(this),this._render=new ni(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),t&&(this._geometryFilter.sharedMesh=t,t instanceof laya.d3.resource.models.Mesh&&(t.loaded?this._render.sharedMaterials=t.materials:t.once("loaded",this,this._applyMeshMaterials)))}r(e,"laya.d3.core.MeshSprite3D",t);var s=e.prototype;return s._changeRenderObjectByMesh=function(t){var e=this._render._renderElements,i=e[t];i||(i=e[t]=new ke),i._render=this._render;var n=this._render.sharedMaterials[t];n||(n=gi.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(t);if(i._mainSortID=this._getSortID(r,n),i._sprite3D=this,i.renderObj=r,i._material=n,E.isConchNode){var a=r._getVertexBuffer();i._conchSubmesh.setVBIB(a.vertexDeclaration._conchVertexDeclaration,a.getData(),r._getIndexBuffer().getData())}return i},s._changeRenderObjectByMaterial=function(t,e){var i=this._render._renderElements[t],n=this._geometryFilter.sharedMesh.getRenderElement(t);return i._mainSortID=this._getSortID(n,e),i._sprite3D=this,i.renderObj=n,i._material=e,E.isConchNode&&i._conchSubmesh.setMaterial(e._conchMaterial),i},s._changeRenderObjectsByMesh=function(){E.isConchNode;var t=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=t;for(var e=0;t>e;e++)this._changeRenderObjectByMesh(e)},s._onMeshChanged=function(t){var e=t.sharedMesh;e.loaded?this._changeRenderObjectsByMesh():e.once("loaded",this,this._onMeshLoaded)},s._onMeshLoaded=function(t){t===this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},s._onMaterialChanged=function(t,e,i){var n=this._render._renderElements.length;n>e&&this._changeRenderObjectByMaterial(e,i)},s._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},s._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},s._parseCustomProps=function(t,e,i){laya.d3.core.Sprite3D.prototype._parseCustomProps.call(this,t,e,i);var n=this.meshRender,r=e.lightmapIndex;null!=r&&(n.lightmapIndex=r);var a=e.lightmapScaleOffset;a&&(n.lightmapScaleOffset=new de(a[0],a[1],a[2],a[3]));var s,o;if(i.instanceParams)s=i.instanceParams.loadPath,s&&(o=x.getRes(t[s]),this.meshFilter.sharedMesh=o,o.loaded?n.sharedMaterials=o.materials:o.once("loaded",this,this._applyMeshMaterials));else{s=e.meshPath,s&&(o=x.getRes(t[s]),this.meshFilter.sharedMesh=o);var h=e.materials;if(h){var l=n.sharedMaterials,u=h.length;l.length=u;for(var c=0;u>c;c++)l[c]=x.getRes(t[h[c].path]);n.sharedMaterials=l}}},s._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,i=t.materials,n=0,r=i.length;r>n;n++)e[n]||(e[n]=i[n]);this._render.sharedMaterials=e},s._addToInitStaticBatchManager=function(){e._staticBatchManager._addInitBatchSprite(this)},s.cloneTo=function(t){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t);var e=t;e._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var i=this._render,n=e._render;n.enable=i.enable,n.sharedMaterials=i.sharedMaterials,n.castShadow=i.castShadow;var r=i.lightmapScaleOffset;r&&(n.lightmapScaleOffset=r.clone()),n.receiveShadow=i.receiveShadow,n.sortingFudge=i.sortingFudge},s.destroy=function(e){void 0===e&&(e=!0);var i=this.meshFilter.sharedMesh;i.loaded||i.off("loaded",this,this._applyMeshMaterials),t.prototype.destroy.call(this,e),this._geometryFilter._destroy()},s.createConchModel=function(){return null},a(0,s,"meshFilter",function(){return this._geometryFilter}),a(0,s,"meshRender",function(){return this._render}),e.__init__=function(){ft._staticBatchManagers.push(e._staticBatchManager)},e.load=function(t){return i.loader.create(t,null,null,e,null,1,!1)},n(e,["_staticBatchManager",function(){return this._staticBatchManager=new He}]),e}(ci)),Fi=function(t){function e(t){e.__super.call(this),this._render=new ai(this),this._render.on("materialchanged",this,this._onMaterialChanged),this._geometryFilter=new ri(this),this._changeRenderObject(0),t&&(this._render.sharedMaterial=t)}r(e,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",t);var n=e.prototype;return n._initParticleVelocity=function(t){for(var e=new K,i=t.velocitys,n=0,r=i.length;r>n;n++){var a=i[n];e.add(a.key,a.value)}return e},n._initParticleColor=function(t){var e=new X,i=t.alphas,n=0,r=0;for(n=0,r=i.length;r>n;n++){var a=i[n];e.addAlpha(a.key,a.value)}var s=t.rgbs;for(n=0,r=s.length;r>n;n++){var o=s[n],h=o.value;e.addRGB(o.key,new _e(h[0],h[1],h[2]))}return e},n._initParticleSize=function(t){for(var e=new K,i=t.sizes,n=0,r=i.length;r>n;n++){var a=i[n];e.add(a.key,a.value)}return e},n._initParticleRotation=function(t){for(var e=new K,i=t.angularVelocitys,n=0,r=i.length;r>n;n++){var a=i[n];e.add(a.key,a.value/180*Math.PI)}return e},n._initParticleFrame=function(t){for(var e=new q,i=t.frames,n=0,r=i.length;r>n;n++){var a=i[n];e.add(a.key,a.value)}return e},n._changeRenderObject=function(t){var e=this._render._renderElements,i=e[t];i||(i=e[t]=new ot),i._render=this._render;var n=this._render.sharedMaterials[t];n||(n=Ti.defaultMaterial);var r=this._geometryFilter;return i._mainSortID=0,i._sprite3D=this,i.renderObj=r,i._material=n,i},n._onMaterialChanged=function(t,e,i){var n=t._renderElements.length;n>e&&this._changeRenderObject(e)},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._parseCustomProps=function(t,i,n){laya.d3.core.Sprite3D.prototype._parseCustomProps.call(this,t,i,n);var r,a=Math.PI/180,s=0,o=0,h=this.particleRender,l=i.material;if(l)r=x.getRes(t[l.path]);else{var u=i.materialPath;u?r=x.getRes(t[u]):(r=new Ti,r.diffuseTexture=t?x.getRes(t[i.texturePath]):Pi.load(i.texturePath))}h.sharedMaterial=r;var c=i.meshPath;c&&(h.mesh=x.getRes(t[c])),h.renderMode=i.renderMode,h.stretchedBillboardCameraSpeedScale=i.stretchedBillboardCameraSpeedScale,h.stretchedBillboardSpeedScale=i.stretchedBillboardSpeedScale,h.stretchedBillboardLengthScale=i.stretchedBillboardLengthScale,h.sortingFudge=i.sortingFudge?i.sortingFudge:0;var _=this.particleSystem;_.isPerformanceMode=i.isPerformanceMode,_.duration=i.duration,_.looping=i.looping,_.prewarm=i.prewarm,_.startDelayType=i.startDelayType,_.startDelay=i.startDelay,_.startDelayMin=i.startDelayMin,_.startDelayMax=i.startDelayMax,_.startLifetimeType=i.startLifetimeType,_.startLifetimeConstant=i.startLifetimeConstant,_.startLifeTimeGradient=e._initStartLife(i.startLifetimeGradient),_.startLifetimeConstantMin=i.startLifetimeConstantMin,_.startLifetimeConstantMax=i.startLifetimeConstantMax,_.startLifeTimeGradientMin=e._initStartLife(i.startLifetimeGradientMin),_.startLifeTimeGradientMax=e._initStartLife(i.startLifetimeGradientMax),_.startSpeedType=i.startSpeedType,_.startSpeedConstant=i.startSpeedConstant,_.startSpeedConstantMin=i.startSpeedConstantMin,_.startSpeedConstantMax=i.startSpeedConstantMax,_.threeDStartSize=i.threeDStartSize,_.startSizeType=i.startSizeType,_.startSizeConstant=i.startSizeConstant;var d=i.startSizeConstantSeparate,f=_.startSizeConstantSeparate.elements;f[0]=d[0],f[1]=d[1],f[2]=d[2],_.startSizeConstantMin=i.startSizeConstantMin,_.startSizeConstantMax=i.startSizeConstantMax;var p=i.startSizeConstantMinSeparate,m=_.startSizeConstantMinSeparate.elements;m[0]=p[0],m[1]=p[1],m[2]=p[2];var g=i.startSizeConstantMaxSeparate,y=_.startSizeConstantMaxSeparate.elements;y[0]=g[0],y[1]=g[1],y[2]=g[2],_.threeDStartRotation=i.threeDStartRotation,_.startRotationType=i.startRotationType,_.startRotationConstant=i.startRotationConstant*a;var v=i.startRotationConstantSeparate,S=_.startRotationConstantSeparate.elements;S[0]=v[0]*a,S[1]=v[1]*a,S[2]=v[2]*a,_.startRotationConstantMin=i.startRotationConstantMin*a,_.startRotationConstantMax=i.startRotationConstantMax*a;var T=i.startRotationConstantMinSeparate,E=_.startRotationConstantMinSeparate.elements;E[0]=T[0]*a,E[1]=T[1]*a,E[2]=T[2]*a;var w=i.startRotationConstantMaxSeparate,b=_.startRotationConstantMaxSeparate.elements;b[0]=w[0]*a,b[1]=w[1]*a,b[2]=w[2]*a,_.randomizeRotationDirection=i.randomizeRotationDirection,_.startColorType=i.startColorType;var C=i.startColorConstant,M=_.startColorConstant.elements;M[0]=C[0],M[1]=C[1],M[2]=C[2],M[3]=C[3];var D=i.startColorConstantMin,A=_.startColorConstantMin.elements;A[0]=D[0],A[1]=D[1],A[2]=D[2],A[3]=D[3];var R=i.startColorConstantMax,I=_.startColorConstantMax.elements;I[0]=R[0],I[1]=R[1],I[2]=R[2],I[3]=R[3],_.gravityModifier=i.gravityModifier,_.simulationSpace=i.simulationSpace,_.scaleMode=i.scaleMode,_.playOnAwake=i.playOnAwake,_.maxParticles=i.maxParticles;var P=i.autoRandomSeed;null!=P&&(_.autoRandomSeed=P);var L=i.randomSeed;null!=L&&(_.randomSeed[0]=L);var N=i.emission,O=new W;O.emissionRate=N.emissionRate;var V=N.bursts;if(V)for(s=0,o=V.length;o>s;s++){var F=V[s];O.addBurst(new H(F.time,F.min,F.max))}O.enbale=N.enable,_.emission=O;var B,U=i.shape;switch(U.shapeType){case 0:var k;B=k=new Ue,k.radius=U.sphereRadius,k.emitFromShell=U.sphereEmitFromShell,k.randomDirection=U.sphereRandomDirection;break;case 1:var X;B=X=new Be,X.radius=U.hemiSphereRadius,X.emitFromShell=U.hemiSphereEmitFromShell,X.randomDirection=U.hemiSphereRandomDirection;break;case 2:var q;B=q=new Fe,q.angle=U.coneAngle*a,q.radius=U.coneRadius,q.length=U.coneLength,q.emitType=U.coneEmitType,q.randomDirection=U.coneRandomDirection;break;case 3:var K;B=K=new Oe,K.x=U.boxX,K.y=U.boxY,K.z=U.boxZ,K.randomDirection=U.boxRandomDirection;break;case 7:var J;B=J=new Ve,J.radius=U.circleRadius,J.arc=U.circleArc*a,J.emitFromEdge=U.circleEmitFromEdge,J.randomDirection=U.circleRandomDirection;break;default:var tt;B=tt=new Ve,tt.radius=U.circleRadius,tt.arc=U.circleArc*a,tt.emitFromEdge=U.circleEmitFromEdge,tt.randomDirection=U.circleRandomDirection}B.enable=U.enable,_.shape=B;var at=i.velocityOverLifetime;if(at){var st,ot=at.velocity;switch(ot.type){case 0:var ht=ot.constant;st=$.createByConstant(new _e(ht[0],ht[1],ht[2]));break;case 1:st=$.createByGradient(this._initParticleVelocity(ot.gradientX),this._initParticleVelocity(ot.gradientY),this._initParticleVelocity(ot.gradientZ));break;case 2:var lt=ot.constantMin,ut=ot.constantMax;st=$.createByRandomTwoConstant(new _e(lt[0],lt[1],lt[2]),new _e(ut[0],ut[1],ut[2]));break;case 3:st=$.createByRandomTwoGradient(this._initParticleVelocity(ot.gradientXMin),this._initParticleVelocity(ot.gradientXMax),this._initParticleVelocity(ot.gradientYMin),this._initParticleVelocity(ot.gradientYMax),this._initParticleVelocity(ot.gradientZMin),this._initParticleVelocity(ot.gradientZMax))}var ct=new rt(st);ct.space=at.space,ct.enbale=at.enable,_.velocityOverLifetime=ct}var _t=i.colorOverLifetime;if(_t){var dt,ft=_t.color;switch(ft.type){case 0:var pt=ft.constant;dt=Y.createByConstant(new de(pt[0],pt[1],pt[2],pt[3]));break;case 1:dt=Y.createByGradient(this._initParticleColor(ft.gradient));break;case 2:var mt=ft.constantMin,gt=ft.constantMax;dt=Y.createByRandomTwoConstant(new de(mt[0],mt[1],mt[2],mt[3]),new de(gt[0],gt[1],gt[2],gt[3]));break;case 3:dt=Y.createByRandomTwoGradient(this._initParticleColor(ft.gradientMin),this._initParticleColor(ft.gradientMax))}var yt=new z(dt);yt.enbale=_t.enable,_.colorOverLifetime=yt}var xt=i.sizeOverLifetime;if(xt){var vt,St=xt.size;switch(St.type){case 0:vt=St.separateAxes?Z.createByGradientSeparate(this._initParticleSize(St.gradientX),this._initParticleSize(St.gradientY),this._initParticleSize(St.gradientZ)):Z.createByGradient(this._initParticleSize(St.gradient));break;case 1:if(St.separateAxes){var Tt=St.constantMinSeparate,Et=St.constantMaxSeparate;vt=Z.createByRandomTwoConstantSeparate(new _e(Tt[0],Tt[1],Tt[2]),new _e(Et[0],Et[1],Et[2]))}else vt=Z.createByRandomTwoConstant(St.constantMin,St.constantMax);break;case 2:vt=St.separateAxes?Z.createByRandomTwoGradientSeparate(this._initParticleSize(St.gradientXMin),this._initParticleSize(St.gradientYMin),this._initParticleSize(St.gradientZMin),this._initParticleSize(St.gradientXMax),this._initParticleSize(St.gradientYMax),this._initParticleSize(St.gradientZMax)):Z.createByRandomTwoGradient(this._initParticleSize(St.gradientMin),this._initParticleSize(St.gradientMax))}var wt=new et(vt);wt.enbale=xt.enable,_.sizeOverLifetime=wt}var bt=i.rotationOverLifetime;if(bt){var Ct,Mt=bt.angularVelocity;switch(Mt.type){case 0:Mt.separateAxes||(Ct=j.createByConstant(Mt.constant*a));break;case 1:Mt.separateAxes||(Ct=j.createByGradient(this._initParticleRotation(Mt.gradient)));break;case 2:Mt.separateAxes||(Ct=j.createByRandomTwoConstant(Mt.constantMin*a,Mt.constantMax*a));break;case 3:Mt.separateAxes||(Ct=j.createByRandomTwoGradient(this._initParticleRotation(Mt.gradientMin),this._initParticleRotation(Mt.gradientMax)))}var Dt=new Q(Ct);Dt.enbale=bt.enable,_.rotationOverLifetime=Dt}var At=i.textureSheetAnimation;if(At){var Rt,It=At.frame;switch(It.type){case 0:Rt=G.createByConstant(It.constant);break;case 1:Rt=G.createByOverTime(this._initParticleFrame(It.overTime));break;case 2:Rt=G.createByRandomTwoConstant(It.constantMin,It.constantMax);break;case 3:Rt=G.createByRandomTwoOverTime(this._initParticleFrame(It.overTimeMin),this._initParticleFrame(It.overTimeMax))}var Pt,Lt=At.startFrame;switch(Lt.type){case 0:Pt=it.createByConstant(Lt.constant);break;case 1:Pt=it.createByRandomTwoConstant(Lt.constantMin,Lt.constantMax)}var Nt=new nt(Rt,Pt);Nt.enable=At.enable;var Ot=At.tiles;Nt.tiles=new ce(Ot[0],Ot[1]),Nt.type=At.type,Nt.randomRow=At.randomRow,Nt.cycles=At.cycles,_.textureSheetAnimation=Nt}_.playOnAwake&&_.play()},n.cloneTo=function(t){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t);var e=t,i=e._geometryFilter;this._geometryFilter.cloneTo(i);var n=e._render,r=this._render;n.sharedMaterials=r.sharedMaterials,n.enable=r.enable,n.renderMode=r.renderMode,n.mesh=r.mesh,n.stretchedBillboardCameraSpeedScale=r.stretchedBillboardCameraSpeedScale,n.stretchedBillboardSpeedScale=r.stretchedBillboardSpeedScale,n.stretchedBillboardLengthScale=r.stretchedBillboardLengthScale,n.sortingFudge=r.sortingFudge},n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null},a(0,n,"particleSystem",function(){return this._geometryFilter}),a(0,n,"particleRender",function(){return this._render}),e.load=function(t){return i.loader.create(t,null,null,e,null,1,!1)},e._initStartLife=function(t){for(var e=new K,i=t.startLifetimes,n=0,r=i.length;r>n;n++){var a=i[n];e.add(a.key,a.value)}return e},e.SHADERDEFINE_RENDERMODE_BILLBOARD=0,e.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,e.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,e.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,e.SHADERDEFINE_RENDERMODE_MESH=0,e.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,e.SHADERDEFINE_COLOROVERLIFETIME=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,e.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,e.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIME=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,e.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,e.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,e.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,e.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,e.SHADERDEFINE_SHAPE=0,e.WORLDPOSITION=0,e.WORLDROTATION=1,e.POSITIONSCALE=4,e.SIZESCALE=5,e.SCALINGMODE=6,e.GRAVITY=7,e.THREEDSTARTROTATION=8,e.STRETCHEDBILLBOARDLENGTHSCALE=9,e.STRETCHEDBILLBOARDSPEEDSCALE=10,e.SIMULATIONSPACE=11,e.CURRENTTIME=12,e.VOLVELOCITYCONST=13,e.VOLVELOCITYGRADIENTX=14,e.VOLVELOCITYGRADIENTY=15,e.VOLVELOCITYGRADIENTZ=16,e.VOLVELOCITYCONSTMAX=17,e.VOLVELOCITYGRADIENTXMAX=18,e.VOLVELOCITYGRADIENTYMAX=19,e.VOLVELOCITYGRADIENTZMAX=20,e.VOLSPACETYPE=21,e.COLOROVERLIFEGRADIENTALPHAS=22,e.COLOROVERLIFEGRADIENTCOLORS=23,e.MAXCOLOROVERLIFEGRADIENTALPHAS=24,e.MAXCOLOROVERLIFEGRADIENTCOLORS=25,e.SOLSIZEGRADIENT=26,e.SOLSIZEGRADIENTX=27,e.SOLSIZEGRADIENTY=28,e.SOLSizeGradientZ=29,e.SOLSizeGradientMax=30,e.SOLSIZEGRADIENTXMAX=31,e.SOLSIZEGRADIENTYMAX=32,e.SOLSizeGradientZMAX=33,
e.ROLANGULARVELOCITYCONST=34,e.ROLANGULARVELOCITYCONSTSEPRARATE=35,e.ROLANGULARVELOCITYGRADIENT=36,e.ROLANGULARVELOCITYGRADIENTX=37,e.ROLANGULARVELOCITYGRADIENTY=38,e.ROLANGULARVELOCITYGRADIENTZ=39,e.ROLANGULARVELOCITYGRADIENTW=40,e.ROLANGULARVELOCITYCONSTMAX=41,e.ROLANGULARVELOCITYCONSTMAXSEPRARATE=42,e.ROLANGULARVELOCITYGRADIENTMAX=43,e.ROLANGULARVELOCITYGRADIENTXMAX=44,e.ROLANGULARVELOCITYGRADIENTYMAX=45,e.ROLANGULARVELOCITYGRADIENTZMAX=46,e.ROLANGULARVELOCITYGRADIENTWMAX=47,e.TEXTURESHEETANIMATIONCYCLES=48,e.TEXTURESHEETANIMATIONSUBUVLENGTH=49,e.TEXTURESHEETANIMATIONGRADIENTUVS=50,e.TEXTURESHEETANIMATIONGRADIENTMAXUVS=51,e}(ci),Bi=(function(t){function e(t,i,n,r,a){void 0===t&&(t=.1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=.3),void 0===a&&(a=1e3),this._tempMatrix=new ae,this._leftViewMatrix=new ae,this._leftProjectionMatrix=new ae,this._leftProjectionViewMatrix=new ae,this._leftViewport=new fe(0,0,0,0),this._leftNormalizedViewport=new fe(0,0,.5,1),this._leftAspectRatio=i,this._rightViewMatrix=new ae,this._rightProjectionMatrix=new ae,this._rightProjectionViewMatrix=new ae,this._rightViewport=new fe(0,0,0,0),this._rightNormalizedViewport=new fe(.5,0,.5,1),this._rightAspectRatio=n,this._pupilDistande=t,this._leftBoundFrustumUpdate=!0,this._leftBoundFrustum=new te(ae.DEFAULT),this._rightBoundFrustumUpdate=!0,this._rightBoundFrustum=new te(ae.DEFAULT),e.__super.call(this,r,a),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}r(e,"laya.d3.core.VRCamera",t);var i=e.prototype;return i._onWorldMatrixChanged=function(){this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},i._calculatePupilOffset=function(){var t=this._tempVector3;return _e.scale(this.right,this._pupilDistande/2,t),t.elements},i._calculateLeftProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var t=this.orthographicVerticalSize*this.leftAspectRatio*.5,e=.5*this.orthographicVerticalSize;ae.createOrthogonal(-t,t,-e,e,this.nearPlane,this.farPlane,this._leftProjectionMatrix)}else ae.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._leftBoundFrustumUpdate=!0},i._calculateRightProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var t=this.orthographicVerticalSize*this.rightAspectRatio*.5,e=.5*this.orthographicVerticalSize;ae.createOrthogonal(-t,t,e,e,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else ae.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._rightBoundFrustumUpdate=!0},i._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this.orthographicProjection){var t=this.orthographicVerticalSize*this.leftAspectRatio*.5,e=.5*this.orthographicVerticalSize,i=this.orthographicVerticalSize*this.rightAspectRatio*.5,n=.5*this.orthographicVerticalSize;ae.createOrthogonal(-t,t,-e,e,this.nearPlane,this.farPlane,this._leftProjectionMatrix),ae.createOrthogonal(-i,i,n,n,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else ae.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),ae.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},i._renderCamera=function(t,e,i){e.camera=this,this._prepareCameraToRender(),e.scene.addShaderDefine(me.SHADERDEFINE_VR),i.beforeRender(e);var n,r;n=e._viewMatrix=this.leftViewMatrix;var a=this._renderTarget;a?(a.start(),ae.multiply(ui._invertYScaleMatrix,this._leftProjectionMatrix,ui._invertYProjectionMatrix),ae.multiply(ui._invertYScaleMatrix,this.leftProjectionViewMatrix,ui._invertYProjectionViewMatrix),r=e._projectionMatrix=ui._invertYProjectionMatrix,e._projectionViewMatrix=ui._invertYProjectionViewMatrix):(r=e._projectionMatrix=this._leftProjectionMatrix,e._projectionViewMatrix=this.leftProjectionViewMatrix),this._prepareCameraViewProject(n,r),e._boundFrustum=this.leftBoundFrustum,e._viewport=this.leftViewport,i._preRenderScene(t,e),i._clear(t,e),i._renderScene(t,e);var s,o;s=e._viewMatrix=this.rightViewMatrix,a?(a.start(),ae.multiply(ui._invertYScaleMatrix,this._rightProjectionMatrix,ui._invertYProjectionMatrix),ae.multiply(ui._invertYScaleMatrix,this.rightProjectionViewMatrix,ui._invertYProjectionViewMatrix),e._projectionMatrix=ui._invertYProjectionMatrix,o=e._projectionViewMatrix=ui._invertYProjectionViewMatrix):(o=e._projectionMatrix=this._rightProjectionMatrix,e._projectionViewMatrix=this.rightProjectionViewMatrix),this._prepareCameraViewProject(s,o),e._boundFrustum=this.rightBoundFrustum,e._viewport=this.rightViewport,i._preRenderScene(t,e),i._clear(t,e),i._renderScene(t,e),i.lateRender(e),a&&a.end()},a(0,i,"rightBoundFrustum",function(){return this._rightBoundFrustumUpdate&&(this._rightBoundFrustum.matrix=this.rightProjectionViewMatrix),this._rightBoundFrustum}),a(0,i,"leftNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var t=this._leftViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._leftNormalizedViewport.x=t.x/i,this._leftNormalizedViewport.y=t.y/n,this._leftNormalizedViewport.width=t.width/i,this._leftNormalizedViewport.height=t.height/n}return this._leftNormalizedViewport}),a(0,i,"rightViewport",function(){if(this._viewportExpressedInClipSpace){var t=this._rightNormalizedViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._rightViewport.x=t.x*i,this._rightViewport.y=t.y*n,this._rightViewport.width=t.width*i,this._rightViewport.height=t.height*n}return this._rightViewport}),a(0,i,"viewport",null,function(t){if(null!=this.renderTarget&&(t.x<0||t.y<0||0==t.width||0==t.height))throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._leftViewport=new fe(0,0,t.width/2,t.height),this._rightViewport=new fe(t.width/2,0,t.width/2,t.height),this._calculateProjectionMatrix()}),a(0,i,"leftAspectRatio",function(){if(0===this._leftAspectRatio){var t=this.leftViewport;return t.width/t.height}return this._leftAspectRatio}),a(0,i,"rightAspectRatio",function(){if(0===this._rightAspectRatio){var t=this.rightViewport;return t.width/t.height}return this._rightAspectRatio}),a(0,i,"aspectRatio",null,function(t){if(0>t)throw new Error("VRCamera: the aspect ratio has to be a positive real number.");this._leftAspectRatio=t,this._rightAspectRatio=t,this._calculateRightProjectionMatrix()}),a(0,i,"rightNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var t=this._rightViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._rightNormalizedViewport.x=t.x/i,this._rightNormalizedViewport.y=t.y/n,this._rightNormalizedViewport.width=t.width/i,this._rightNormalizedViewport.height=t.height/n}return this._rightNormalizedViewport}),a(0,i,"normalizedViewport",null,function(t){if(t.x<0||t.y<0||t.x+t.width>1||t.x+t.height>1)throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._leftNormalizedViewport=new fe(0,0,t.width/2,t.height),this._rightNormalizedViewport=new fe(t.width/2,0,t.width/2,t.height),this._calculateProjectionMatrix()}),a(0,i,"leftViewport",function(){if(this._viewportExpressedInClipSpace){var t=this._leftNormalizedViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._leftViewport.x=t.x*i,this._leftViewport.y=t.y*n,this._leftViewport.width=t.width*i,this._leftViewport.height=t.height*n}return this._leftViewport}),a(0,i,"needLeftViewport",function(){var t=this.leftNormalizedViewport;return 0===t.x&&0===t.y&&1===t.width&&1===t.height}),a(0,i,"needRightViewport",function(){var t=this.rightNormalizedViewport;return 0===t.x&&0===t.y&&1===t.width&&1===t.height}),a(0,i,"leftViewMatrix",function(){var t=this._calculatePupilOffset(),e=this._tempMatrix;this.transform.worldMatrix.cloneTo(e);var i=e.elements;return i[12]-=t[0],i[13]-=t[1],i[14]-=t[2],e.invert(this._leftViewMatrix),this._leftViewMatrix}),a(0,i,"rightViewMatrix",function(){var t=this._calculatePupilOffset(),e=this._tempMatrix;this.transform.worldMatrix.cloneTo(e);var i=e.elements;return i[12]+=t[0],i[13]+=t[1],i[14]+=t[2],e.invert(this._rightViewMatrix),this._rightViewMatrix}),a(0,i,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),a(0,i,"leftProjectionViewMatrix",function(){return ae.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),a(0,i,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),a(0,i,"rightProjectionViewMatrix",function(){return ae.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),a(0,i,"leftBoundFrustum",function(){return this._leftBoundFrustumUpdate&&(this._leftBoundFrustum.matrix=this.leftProjectionViewMatrix),this._leftBoundFrustum}),e}(ui),function(t){function e(t,i){this._subMeshOffset=null,e.__super.call(this,i),this._subMeshOffset=[];var n=this;this._geometryFilter=new ii(n),this._render=new Ni(n),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),t&&(this._geometryFilter.sharedMesh=t,t instanceof laya.d3.resource.models.Mesh&&(t.loaded?this._render.sharedMaterials=t.materials:t.once("loaded",this,this._applyMeshMaterials)))}r(e,"laya.d3.core.SkinnedMeshSprite3D",t);var n=e.prototype;return n._changeRenderObjectByMesh=function(t){var e=this._render._renderElements,i=e[t];i||(i=e[t]=new ke),i._render=this._render;var n=this._render.sharedMaterials[t];n||(n=gi.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(t);return i._mainSortID=this._getSortID(r,n),i._sprite3D=this,i.renderObj=r,i._material=n,i},n._changeRenderObjectByMaterial=function(t,e){var i=this._render._renderElements[t],n=this._geometryFilter.sharedMesh.getRenderElement(t);return i._mainSortID=this._getSortID(n,e),i._sprite3D=this,i.renderObj=n,i._material=e,i},n._changeRenderObjectsByMesh=function(){var t=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=t;for(var e=0;t>e;e++)this._changeRenderObjectByMesh(e)},n._onMeshChanged=function(t){var e=t.sharedMesh;e.loaded?this._changeRenderObjectsByMesh():e.once("loaded",this,this._changeRenderObjectsByMesh)},n._onMaterialChanged=function(t,e,i){var n=this._render._renderElements.length;n>e&&this._changeRenderObjectByMaterial(e,i)},n._parseCustomProps=function(t,e,i){laya.d3.core.Sprite3D.prototype._parseCustomProps.call(this,t,e,i);var n=this.skinnedMeshRender,r=e.lightmapIndex;null!=r&&(n.lightmapIndex=r);var a=e.lightmapScaleOffset;a&&(n.lightmapScaleOffset=new de(a[0],a[1],a[2],a[3]));var s,o;if(i.instanceParams)s=i.instanceParams.loadPath,s&&(o=x.getRes(t[s]),this.meshFilter.sharedMesh=o,o.loaded?n.sharedMaterials=o.materials:o.once("loaded",this,this._applyMeshMaterials));else{s=e.meshPath,s&&(o=x.getRes(t[s]),this.meshFilter.sharedMesh=o);var h=e.materials;if(h){var l=n.sharedMaterials,u=h.length;l.length=u;for(var c=0;u>c;c++)l[c]=x.getRes(t[h[c].path]);n.sharedMaterials=l}}},n._setBelongAnimator=function(t){if(this._belongAnimator=t,t){var e=t.avatar,i=t._avatarNodes;if(i){for(var n=0,r=i.length;r>n;n++){var a=i[n];a.name!==this.name||this._transform.dummy||this._associateSpriteToAnimationNode(e,a)}this.skinnedMeshRender._setCacheAvatar(e)}}},n._associateSpriteToAnimationNode=function(t,e){this._transform.dummy=e._transform;var i=this._belongAnimator._avatarNodes.indexOf(e),n=this._belongAnimator._cacheSpriteToNodesMap;this._belongAnimator._cacheNodesToSpriteMap[i]=n.length,n.push(i),this.skinnedMeshRender._setCacheAvatar(t)},n._clearSelfRenderObjects=function(){this._scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this._scene.addFrustumCullingObject(this._render)},n._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,i=t.materials,n=0,r=i.length;r>n;n++)e[n]||(e[n]=i[n]);this._render.sharedMaterials=e},n.cloneTo=function(t){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t);var e=t;e._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var i=this._render,n=e._render;n.enable=i.enable,n.sharedMaterials=i.sharedMaterials,n.castShadow=i.castShadow;var r=i.lightmapScaleOffset;r&&(n.lightmapScaleOffset=r.clone()),n.receiveShadow=i.receiveShadow,n.sortingFudge=i.sortingFudge},n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._geometryFilter._destroy()},n.createConchModel=function(){return null},a(0,n,"meshFilter",function(){return this._geometryFilter}),a(0,n,"skinnedMeshRender",function(){return this._render}),e.load=function(t){return i.loader.create(t,null,null,Vi,null,1,!1)},e.BONES=0,e.SHADERDEFINE_BONE=8,e}(ci)),Ui=function(t){function e(t,i,n,r,a,s,o,h){e.__super.call(this,h),this._geometryFilter=new oi(this,t,i,n,r,a,s,o),this._render=new hi(this)}r(e,"laya.d3.terrain.TerrainChunk",t);var n=e.prototype;return n.buildRenderElementAndMaterial=function(t,e,i,n,r,a,s,o,h,l,u,c,_,d,f,p,m,g){void 0===u&&(u=1),void 0===c&&(c=1),void 0===_&&(_=1),void 0===d&&(d=1),void 0===f&&(f=1),void 0===p&&(p=1),void 0===m&&(m=1),void 0===g&&(g=1);var y=new yi;h&&(y.diffuseColor=h),o&&(y.ambientColor=o),l&&(y.specularColor=l),y.splatAlphaTexture=x.getRes(i),y.normalTexture=e?x.getRes(e):null,y.diffuseTexture1=n?x.getRes(n):null,y.diffuseTexture2=r?x.getRes(r):null,y.diffuseTexture3=a?x.getRes(a):null,y.diffuseTexture4=s?x.getRes(s):null,y.setDiffuseScale1(u,c),y.setDiffuseScale2(_,d),y.setDiffuseScale3(f,p),y.setDiffuseScale4(m,g),y.setDetailNum(t),0!=this._render._renderElements.length&&(y.renderMode=2);var v=new ot;v._mainSortID=0,v._sprite3D=this,v.renderObj=this._geometryFilter,v._material=y,this._render._materials.push(y),this._render._renderElements.push(v)},n.createConchModel=function(){return null},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,i=t.materials,n=0,r=i.length;r>n;n++)e[n]||(e[n]=i[n]);this._render.sharedMaterials=e},n.cloneTo=function(t){console.log("Terrain Chunk can't clone")},n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._geometryFilter._destroy()},a(0,n,"terrainFilter",function(){return this._geometryFilter}),a(0,n,"terrainRender",function(){return this._render}),e.load=function(t){return i.loader.create(t,null,null,e,null,1,!1)},e}(ci),ki=(function(t){function e(t,i,n){this._long=NaN,this._width=NaN,this._height=NaN,void 0===t&&(t=1),void 0===i&&(i=1),void 0===n&&(n=1),e.__super.call(this),this._long=t,this._width=i,this._height=n,this.activeResource(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.BoxMesh",t);var i=e.prototype;return i.recreateResource=function(){this._numberVertices=24,this._numberIndices=36;var t=Nt.vertexDeclaration,e=(t.vertexStride/4,this._long/2),i=this._height/2,n=this._width/2,r=new Float32Array([-e,i,-n,0,1,0,0,0,e,i,-n,0,1,0,1,0,e,i,n,0,1,0,1,1,-e,i,n,0,1,0,0,1,-e,-i,-n,0,-1,0,0,1,e,-i,-n,0,-1,0,1,1,e,-i,n,0,-1,0,1,0,-e,-i,n,0,-1,0,0,0,-e,i,-n,-1,0,0,0,0,-e,i,n,-1,0,0,1,0,-e,-i,n,-1,0,0,1,1,-e,-i,-n,-1,0,0,0,1,e,i,-n,1,0,0,1,0,e,i,n,1,0,0,0,0,e,-i,n,1,0,0,0,1,e,-i,-n,1,0,0,1,1,-e,i,n,0,0,1,0,0,e,i,n,0,0,1,1,0,e,-i,n,0,0,1,1,1,-e,-i,n,0,0,1,0,1,-e,i,-n,0,0,-1,1,0,e,i,-n,0,0,-1,0,0,e,-i,-n,0,0,-1,0,1,-e,-i,-n,0,0,-1,1,1]),a=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);this._vertexBuffer=new Si(t,this._numberVertices,35044,!0),this._indexBuffer=new vi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(r),this._indexBuffer.setData(a),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,i,"long",function(){return this._long},function(t){this._long!==t&&(this._long=t,this.releaseResource(),this.activeResource())}),a(0,i,"width",function(){return this._width},function(t){this._width!==t&&(this._width=t,this.releaseResource(),this.activeResource())}),a(0,i,"height",function(){return this._height},function(t){this._height!==t&&(this._height=t,this.releaseResource(),this.activeResource())}),e}(Mi),function(t){function e(t,i,n,r){this._radius=NaN,this._height=NaN,this._slices=0,this._stacks=0,void 0===t&&(t=.5),void 0===i&&(i=2),void 0===n&&(n=16),void 0===r&&(r=32),e.__super.call(this),this._radius=t,this._height=2*t>i?2*t:i,this._stacks=n,this._slices=r,this.recreateResource(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.CapsuleMesh",t);var i=e.prototype;return i.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this.slices+1)*2+2*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2*2+2*this._slices*3;var t=Nt.vertexDeclaration,e=t.vertexStride/4,i=new Float32Array(this._numberVertices*e),n=new Uint16Array(this._numberIndices),r=Math.PI/2/this._stacks,a=2*Math.PI/this._slices,s=this._height/2-this._radius,o=0,h=0,l=0,u=0,c=0,_=0,d=0,f=0;for(d=0;d<=this._stacks;d++)for(f=0;f<=this._slices;f++)o=this._radius*Math.cos(d*r)*Math.cos(f*a+Math.PI),h=this._radius*Math.sin(d*r),l=this._radius*Math.cos(d*r)*Math.sin(f*a+Math.PI),i[u++]=o,i[u++]=h+s,i[u++]=l,i[u++]=o,i[u++]=h,i[u++]=l,i[u++]=1-f/this._slices,i[u++]=(1-d/this._stacks)*(Math.PI*this._radius/2/(this._height+Math.PI*this._radius)),d<this._stacks&&(n[c++]=d*(this._slices+1)+f+(this._slices+1),n[c++]=d*(this._slices+1)+f,n[c++]=d*(this._slices+1)+f+1,n[c++]=d*(this._slices+1)+f+this._slices,n[c++]=d*(this._slices+1)+f,n[c++]=d*(this._slices+1)+f+(this._slices+1));for(_+=(this._stacks+1)*(this._slices+1),d=0;d<=this._stacks;d++)for(f=0;f<=this._slices;f++)o=this._radius*Math.cos(d*r)*Math.cos(f*a+Math.PI),h=this._radius*Math.sin(-d*r),l=this._radius*Math.cos(d*r)*Math.sin(f*a+Math.PI),i[u++]=o,i[u++]=h-s,i[u++]=l,i[u++]=o,i[u++]=h,i[u++]=l,i[u++]=1-f/this._slices,i[u++]=(d/this._stacks*(Math.PI*this._radius/2)+(this._height+Math.PI*this._radius/2))/(this._height+Math.PI*this._radius),d<this._stacks&&(n[c++]=_+d*(this._slices+1)+f,n[c++]=_+d*(this._slices+1)+f+(this._slices+1),n[c++]=_+d*(this._slices+1)+f+1,n[c++]=_+d*(this._slices+1)+f,n[c++]=_+d*(this._slices+1)+f+this._slices,n[c++]=_+d*(this._slices+1)+f+(this._slices+1));for(_+=(this._stacks+1)*(this._slices+1),f=0;f<=this._slices;f++)o=this._radius*Math.cos(f*a+Math.PI),h=s,l=this._radius*Math.sin(f*a+Math.PI),i[u++]=o,i[u+8*(this._slices+1)-1]=o,i[u++]=h,i[u+8*(this._slices+1)-1]=-h,i[u++]=l,i[u+8*(this._slices+1)-1]=l,i[u++]=o,i[u+8*(this._slices+1)-1]=o,i[u++]=0,i[u+8*(this._slices+1)-1]=0,i[u++]=l,i[u+8*(this._slices+1)-1]=l,i[u++]=1-1*f/this._slices,i[u+8*(this._slices+1)-1]=1-1*f/this._slices,i[u++]=Math.PI*this._radius/2/(this._height+Math.PI*this._radius),i[u+8*(this._slices+1)-1]=(Math.PI*this._radius/2+this._height)/(this._height+Math.PI*this._radius);for(f=0;f<this._slices;f++)n[c++]=f+_+(this._slices+1),n[c++]=f+_+1,n[c++]=f+_,n[c++]=f+_+(this._slices+1),n[c++]=f+_+(this._slices+1)+1,n[c++]=f+_+1;_+=2*(this._slices+1),this._vertexBuffer=new Si(t,this._numberVertices,35044,!0),this._indexBuffer=new vi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(n),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,i,"radius",function(){return this._radius},function(t){this._radius!==t&&(this._radius=t,this.releaseResource(),this.activeResource())}),a(0,i,"height",function(){return this._height},function(t){this._height!==t&&(this._height=t,this.releaseResource(),this.activeResource())}),a(0,i,"stacks",function(){return this._stacks},function(t){this._stacks!==t&&(this._stacks=t,this.releaseResource(),this.activeResource())}),a(0,i,"slices",function(){return this._slices},function(t){this._slices!==t&&(this._slices=t,this.releaseResource(),this.activeResource())}),e}(Mi),function(t){function e(t,i,n){this._radius=NaN,this._height=NaN,this._slices=0,void 0===t&&(t=.5),void 0===i&&(i=2),void 0===n&&(n=32),e.__super.call(this),this._radius=t,this._height=i,this._slices=n,this.recreateResource(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.CylinderMesh",t);var i=e.prototype;return i.recreateResource=function(){this._numberVertices=this._slices+1+1+2*(this._slices+1)+(this._slices+1+1),this._numberIndices=3*this._slices+6*this._slices+3*this._slices;for(var t=Nt.vertexDeclaration,e=t.vertexStride/4,i=new Float32Array(this._numberVertices*e),n=new Uint16Array(this._numberIndices),r=2*Math.PI/this._slices,a=this._height/2,s=0,o=0,h=0,l=0,u=0,c=0,_=0,d=0;d<=this._slices;d++)0===d&&(i[c++]=0,i[c++]=a,i[c++]=0,i[c++]=0,i[c++]=1,i[c++]=0,i[c++]=.5,i[c++]=.5),s=d*r,h=Math.cos(s)*this._radius,l=a,u=Math.sin(s)*this._radius,i[c++]=h,i[c++]=l,i[c++]=u,i[c++]=0,i[c++]=1,i[c++]=0,i[c++]=.5+.5*Math.cos(s),i[c++]=.5+.5*Math.sin(s);for(var f=0;f<this._slices;f++)n[_++]=0,n[_++]=f+1,n[_++]=f+2;o+=this._slices+1+1;for(var p=0;p<=this._slices;p++)s=p*r,h=Math.cos(s+Math.PI)*this._radius,l=a,u=Math.sin(s+Math.PI)*this._radius,i[c++]=h,i[c+8*(this._slices+1)-1]=h,i[c++]=l,i[c+8*(this._slices+1)-1]=-l,i[c++]=u,i[c+8*(this._slices+1)-1]=u,i[c++]=h,i[c+8*(this._slices+1)-1]=h,i[c++]=0,i[c+8*(this._slices+1)-1]=0,i[c++]=u,i[c+8*(this._slices+1)-1]=u,i[c++]=1-1*p/this._slices,i[c+8*(this._slices+1)-1]=1-1*p/this._slices,i[c++]=0,i[c+8*(this._slices+1)-1]=1;c+=8*(this._slices+1);for(var m=0;m<this._slices;m++)n[_++]=m+o+(this._slices+1),n[_++]=m+o+1,n[_++]=m+o,n[_++]=m+o+(this._slices+1),n[_++]=m+o+(this._slices+1)+1,n[_++]=m+o+1;o+=2*(this._slices+1);for(var g=0;g<=this._slices;g++)0===g&&(i[c++]=0,i[c++]=-a,i[c++]=0,i[c++]=0,i[c++]=-1,i[c++]=0,i[c++]=.5,i[c++]=.5),s=g*r,h=Math.cos(s+Math.PI)*this._radius,l=-a,u=Math.sin(s+Math.PI)*this._radius,i[c++]=h,i[c++]=l,i[c++]=u,i[c++]=0,i[c++]=-1,i[c++]=0,i[c++]=.5+.5*Math.cos(s),i[c++]=.5+.5*Math.sin(s);for(var y=0;y<this._slices;y++)n[_++]=0+o,n[_++]=y+2+o,n[_++]=y+1+o;o+=this._slices+1+1,this._vertexBuffer=new Si(t,this._numberVertices,35044,!0),this._indexBuffer=new vi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(n),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,i,"radius",function(){return this._radius},function(t){this._radius!==t&&(this._radius=t,this.releaseResource(),this.activeResource())}),a(0,i,"height",function(){return this._height},function(t){this._height!==t&&(this._height=t,this.releaseResource(),this.activeResource())}),a(0,i,"slices",function(){return this._slices},function(t){this._slices!==t&&(this._slices=t,this.releaseResource(),this.activeResource())}),e}(Mi),function(t){function e(t,i,n,r){this._long=NaN,this._width=NaN,this._stacks=0,this._slices=0,void 0===t&&(t=10),void 0===i&&(i=10),void 0===n&&(n=10),void 0===r&&(r=10),e.__super.call(this),this._long=t,this._width=i,this._stacks=n,this._slices=r,this.activeResource(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.PlaneMesh",t);var i=e.prototype;return i.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=this._stacks*this._slices*2*3;for(var t=new Uint16Array(this._numberIndices),e=Nt.vertexDeclaration,i=e.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=this._long/2,a=this._width/2,s=this._long/this._stacks,o=this._width/this._slices,h=0,l=0;l<=this._slices;l++)for(var u=0;u<=this._stacks;u++)n[h++]=u*s-r,n[h++]=0,n[h++]=l*o-a,n[h++]=0,n[h++]=1,n[h++]=0,n[h++]=1*u/this._stacks,n[h++]=1*l/this._slices;var c=0;for(l=0;l<this._slices;l++)for(u=0;u<this._stacks;u++)t[c++]=(l+1)*(this._stacks+1)+u,t[c++]=l*(this._stacks+1)+u,t[c++]=(l+1)*(this._stacks+1)+u+1,t[c++]=l*(this._stacks+1)+u,t[c++]=l*(this._stacks+1)+u+1,t[c++]=(l+1)*(this._stacks+1)+u+1;this._vertexBuffer=new Si(e,this._numberVertices,35044,!0),this._indexBuffer=new vi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(t),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,i,"long",function(){return this._long},function(t){this._long!==t&&(this._long=t,this.releaseResource(),this.activeResource())}),a(0,i,"width",function(){return this._width},function(t){this._width!==t&&(this._width=t,this.releaseResource(),this.activeResource())}),a(0,i,"stacks",function(){return this._stacks},function(t){this._stacks!==t&&(this._stacks=t,this.releaseResource(),this.activeResource())}),a(0,i,"slices",function(){return this._slices},function(t){this._slices!==t&&(this._slices=t,this.releaseResource(),this.activeResource())}),e}(Mi),function(t){function e(t,i){this._long=NaN,this._width=NaN,void 0===t&&(t=1),void 0===i&&(i=1),e.__super.call(this),this._long=t,this._width=i,this.activeResource(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.QuadMesh",t);var i=e.prototype;return i.recreateResource=function(){this._numberVertices=4,this._numberIndices=6;var t=Nt.vertexDeclaration,e=(t.vertexStride/4,this._long/2),i=this._width/2,n=new Float32Array([-e,i,0,0,0,1,0,0,e,i,0,0,0,1,1,0,-e,-i,0,0,0,1,0,1,e,-i,0,0,0,1,1,1]),r=new Uint16Array([0,1,2,3,2,1]);this._vertexBuffer=new Si(t,this._numberVertices,35044,!0),this._indexBuffer=new vi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(r),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,i,"long",function(){return this._long},function(t){this._long!==t&&(this._long=t,this.releaseResource(),this.activeResource())}),a(0,i,"width",function(){return this._width},function(t){this._width!==t&&(this._width=t,this.releaseResource(),this.activeResource())}),e}(Mi));(function(t){function e(t,i,n){this._radius=NaN,this._slices=0,this._stacks=0,void 0===t&&(t=.5),void 0===i&&(i=32),void 0===n&&(n=32),e.__super.call(this),this._radius=t,this._stacks=i,this._slices=n,this.activeResource(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.SphereMesh",t);var i=e.prototype;return i.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var t=new Uint16Array(this._numberIndices),e=Nt.vertexDeclaration,i=e.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,h=0,l=0;l<this._stacks+1;l++)for(var u=Math.sin(l*r),c=Math.cos(l*r),_=0;_<this._slices+1;_++){var d=u*Math.sin(_*a+1*Math.PI/2),f=u*Math.cos(_*a+1*Math.PI/2);n[o+0]=d*this._radius,n[o+1]=c*this._radius,n[o+2]=f*this._radius,n[o+3]=d,n[o+4]=c,n[o+5]=f,n[o+6]=_/this._slices,n[o+7]=l/this._stacks,o+=i,l!=this._stacks-1&&(t[h++]=s+(this._slices+1),t[h++]=s,t[h++]=s+1,t[h++]=s+this._slices,t[h++]=s,t[h++]=s+(this._slices+1),s++)}this._vertexBuffer=new Si(e,this._numberVertices,35044,!0),this._indexBuffer=new vi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(t),this.memorySize=2*(this._vertexBuffer.byteLength+this._indexBuffer.byteLength),this.completeCreate()},a(0,i,"radius",function(){return this._radius},function(t){this._radius!==t&&(this._radius=t,this.releaseResource(),this.activeResource())}),a(0,i,"slices",function(){return this._slices},function(t){this._slices!==t&&(this._slices=t,this.releaseResource(),this.activeResource())}),a(0,i,"stacks",function(){return this._stacks},function(t){this._stacks!==t&&(this._stacks=t,this.releaseResource(),this.activeResource())}),e})(Mi),function(t){function e(t,i,n){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,e.__super.call(this,t,n),this._heightMap=i,this._cellSize=new ce}r(e,"laya.d3.core.MeshTerrainSprite3D",t);var i=e.prototype;return i._disableRotation=function(){var t=this.transform.rotation;t.elements[0]=0,t.elements[1]=0,t.elements[2]=0,t.elements[3]=1,this.transform.rotation=t},i._getScaleX=function(){var t=this.transform.worldMatrix,e=t.elements,i=e[0],n=e[1],r=e[2];return Math.sqrt(i*i+n*n+r*r)},i._getScaleZ=function(){var t=this.transform.worldMatrix,e=t.elements,i=e[8],n=e[9],r=e[10];return Math.sqrt(i*i+n*n+r*r)},i._initCreateFromMesh=function(t,e){this._heightMap=U.creatFromMesh(this.meshFilter.sharedMesh,t,e,this._cellSize);var i=this.meshFilter.sharedMesh.boundingBox,n=i.min;i.max;this._minX=n.x,this._minZ=n.z},i._initCreateFromMeshHeightMap=function(t,e,i){var n=this,r=this.meshFilter.sharedMesh.boundingBox;t.loaded?(this._heightMap=U.createFromImage(t,e,i),this._computeCellSize(r)):t.once("loaded",null,function(){n._heightMap=U.createFromImage(t,e,i),n._computeCellSize(r)});var a=r.min;r.max;this._minX=a.x,this._minZ=a.z},i._computeCellSize=function(t){var e=t.min,i=t.max,n=e.x,r=e.z,a=i.x,s=i.z,o=a-n,h=s-r;this._cellSize.elements[0]=o/(this._heightMap.width-1),this._cellSize.elements[1]=h/(this._heightMap.height-1)},i._update=function(t){this._disableRotation(),laya.d3.core.RenderableSprite3D.prototype._update.call(this,t)},i.getHeight=function(t,i){e._tempVector3.elements[0]=t,e._tempVector3.elements[1]=0,e._tempVector3.elements[2]=i,this._disableRotation();var n=this.transform.worldMatrix;n.invert(e._tempMatrix4x4),_e.transformCoordinate(e._tempVector3,e._tempMatrix4x4,e._tempVector3),t=e._tempVector3.elements[0],i=e._tempVector3.elements[2];var r=(t-this._minX)/this._cellSize.x,a=(i-this._minZ)/this._cellSize.y,s=Math.floor(a),o=Math.floor(r),h=r-o,l=a-s,u=NaN,c=NaN,_=n.elements,d=_[4],f=_[5],p=_[6],m=Math.sqrt(d*d+f*f+p*p),g=_[13],y=this._heightMap.getHeight(s,o+1),x=this._heightMap.getHeight(s+1,o);if(isNaN(y)||isNaN(x))return NaN;if(1>=h+l){var v=this._heightMap.getHeight(s,o);return isNaN(v)?NaN:(u=y-v,c=x-v,(v+h*u+l*c)*m+g)}var S=this._heightMap.getHeight(s+1,o+1);return isNaN(S)?NaN:(u=x-S,c=y-S,(S+(1-h)*u+(1-l)*c)*m+g)},a(0,i,"minX",function(){var t=this.transform.worldMatrix,e=t.elements;return this._minX*this._getScaleX()+e[12]}),a(0,i,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),a(0,i,"minZ",function(){var t=this.transform.worldMatrix,e=t.elements;return this._minZ*this._getScaleZ()+e[14]}),a(0,i,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),e.createFromMesh=function(t,i,n,r){var a=new e(t,null,r);return t.loaded?a._initCreateFromMesh(i,n):t.once("loaded",a,a._initCreateFromMesh,[i,n]),a},e.createFromMeshAndHeightMap=function(t,i,n,r,a){var s=new e(t,null,a);return t.loaded?s._initCreateFromMeshHeightMap(i,n,r):t.once("loaded",s,s._initCreateFromMeshHeightMap,[i,n,r]),s},n(e,["_tempVector3",function(){return this._tempVector3=new _e},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new ae}]),e}(Vi),function(e){function s(t,e){this.mtl=null,this.detailMtl=null,this.mesh=null,this.useRefrTex=!0,this.renderDetailWav=!0,this._stop=!1,this._texWave=null,this._texRefract=null,this._detailMesh=null,this._texWaveDegTest=0,this._shownormal=!1,this._refractQueue=null,this._$5__loaded=!1,this._waterFogStart=0,this._waterFogRange=20,this.startTm=0,this.curTm=0,this._syncObj=null,this.afterDescLoaded=null,this._geoWaveInfo=new Float32Array(4*s._waveInfoEleNum),this._geoWaveInfoDir=new Float32Array(8),this._texWaveInfo=new Float32Array(15*s._waveInfoEleNum),this._texWaveInfoDir=new Float32Array(30),this._texWaveTrans=new Float32Array(9),this._refractObjStack=[],this._refractObjecs=[],this._scrSizeInfo=new Float32Array(2),this._waterColor=new _e,s.__super.call(this,t,e),this.mtl=new xi,this.startTm=i.timer.currTimer,this.curTm=0}r(s,"laya.d3.water.WaterSprite",e);var o=s.prototype;return o._getWaveInfo=function(t,e,i,n,r,a,o){var h=i*s._waveInfoEleNum,l=2*i,u=n*s.deg2rad;e[l++]=Math.cos(u),
e[l++]=Math.sin(u),t[h++]=a,t[h++]=o,t[h++]=s._2pi/r,t[h++]=7.846987702957/Math.sqrt(r)},o.onDescLoaded=function(t){var e=this,i=Di.load(t.mesh);this._texWave=new Ai(t.detailTexSize[0],t.detailTexSize[1],6408,5121,33189,!1,!1),this.useRefrTex?(this._texRefract=new Ai(t.refracTexSize[0],t.refracTexSize[1]),this._texRefract.repeat=!1,this._texRefract.mipmap=!0,this.mtl.useRefractTexture=!0):this.mtl.useRefractTexture=!1,this._geometryFilter.sharedMesh=i,i.once("loaded",this,this._applyMeshMaterials),i.on("loaded",this,this.onMeshLoaded),".ltc"===t.skyTexture.substr(t.skyTexture.length-4).toLowerCase()?(this.mtl.skyTexture=Li.load(t.skyTexture),this.mtl._addShaderDefine(xi.SHADERDEFINE_CUBE_ENV)):(this.mtl.skyTexture=Pi.load(t.skyTexture),this.mtl._removeShaderDefine(xi.SHADERDEFINE_CUBE_ENV)),t.hdrsky&&this.mtl._addShaderDefine(xi.SHADERDEFINE_HDR_ENV),void 0!=t.deepScale&&(this.mtl.deepScale=t.deepScale),t.useVertexDeep&&(this.mtl.useVertexDeep=!0),this.mtl.skyTexture.repeat=!0;var n=Pi.load(t.infoTexture);n.repeat=!1,this.mtl.waterInfoTexture=n;var r=Pi.load(t.foamTexture);if(r.repeat=!0,this.mtl.foamTexture=r,this.mtl.renderMode=13,this.mtl.waveMainDir=t.geoWaveData[0].dir,this.mtl.geoWaveUVScale=t.geoWaveUVScale,this._detailMesh=new ki(2,2),this.detailMtl=new wi,this.detailMtl.texWaveUVScale=t.detailWaveUVScale,4!=t.geoWaveData.length)throw"error 3";if(4!=t.detailData.length)throw"error 4";t.geoWaveData.forEach(function(t,i){e._getWaveInfo(e._geoWaveInfo,e._geoWaveInfoDir,i,t.dir,t.L,t.Q,t.A)});var a=.01;t.detailData.forEach(function(t,i){e._getWaveInfo(e._texWaveInfo,e._texWaveInfoDir,i,t.dir,t.L,1.5,t.L*a)}),this._waterColor.x=t.color[0]/255,this._waterColor.y=t.color[1]/255,this._waterColor.z=t.color[2]/255,this.mtl.seaColor=new Float32Array([this._waterColor.x,this._waterColor.y,this._waterColor.z]),this._waterFogStart=t.fogStart,this._waterFogRange=t.fogRange,this.afterDescLoaded&&this.afterDescLoaded.call(this)},o.onMeshLoaded=function(){if(this._refractQueue=new ht(this._scene),this._scrSizeInfo[0]=i.stage.width,this._scrSizeInfo[1]=i.stage.height,this.mtl.scrsize=this._scrSizeInfo,this.meshRender.sharedMaterial=this.mtl,!(this._render._renderElements.length>0))throw"error2";this._render._renderElements[0]._onPreRenderFunction=this.onPreRender,this._$5__loaded=!0},o.stop=function(){this._stop=!this._stop},o.addRefractObj=function(t){this._refractObjStack.push(t),this._refractObjecs.push(t)},o.onPreRender=function(e){var n=this;if(this._$5__loaded){if(this._refractObjStack.length)for(var r=0;r<this._refractObjStack.length;r++){var a=this._refractObjStack[r];a._render._renderElements.length&&(a._render._renderElements.forEach(function(t){n._refractQueue._addRenderElement(t)}),this._refractObjStack.splice(r,1),r--)}var o=P.mainContext,h=o.getParameter(2929),l=o.getParameter(2884),u=o.getParameter(2978),c=!1;if(this.useRefrTex&&(this._texRefract.start(),c=!0,o.viewport(0,0,this._texRefract.width,this._texRefract.height),o.clearColor(this._waterColor.x,this._waterColor.y,this._waterColor.z,1),o.clear(16640),this._refractObjecs.forEach(function(t){t._renderUpdate(e._projectionViewMatrix)}),this._refractQueue._preRender(e),this._refractQueue._render(e,!1),this._texRefract.end(),this._texRefract.repeat=!0),this.renderDetailWav){this._texWave.start(),o.disable(2929),o.disable(2884),c=!0,o.viewport(0,0,s.detailTexWidth,s.detailTexHeight);var _=this._detailMesh.getRenderElement(0);_._beforeRender(e),this.detailMtl.currentTm=i.timer.currTimer,this.detailMtl.waveInfo=this._texWaveInfo,this.detailMtl.waveInfoD=this._texWaveInfoDir;var d=this.detailMtl._getShader(0,0,0);d.bind();var f=this._detailMesh._getVertexBuffer(0);d.uploadAttributes(f.vertexDeclaration.shaderValues.data,null),this.detailMtl._upload(),_._render(e),this._texWave.end(),h&&o.enable(2929),l&&o.enable(2884)}c&&o.viewport(u[0],u[1],u[2],u[3]),this._syncObj?this.mtl.detailTexture=this._syncObj._texWave:this.mtl.detailTexture=this._texWave,this.mtl.waveInfo=this._geoWaveInfo,this.mtl.waveInfoD=this._geoWaveInfoDir,this.mtl.underWaterTexture=this._texRefract,this._stop||(this._syncObj?this.curTm=this._syncObj.curTm:this.curTm=i.timer.currTimer-this.startTm,this.mtl._setNumber(8,this.curTm)),t.shownormal&&!this._shownormal&&(this._shownormal=!0,this.mtl._addShaderDefine(xi.SHADERDEFINE_SHOW_NORMAL)),t.shownormal&&this._shownormal&&(this._shownormal=!1,this.mtl._removeShaderDefine(xi.SHADERDEFINE_SHOW_NORMAL))}},o._update=function(t){laya.d3.core.RenderableSprite3D.prototype._update.call(this,t)},a(0,o,"src",null,function(t){var e=new x;e.on("complete",this,this.onDescLoaded),e.load(t)}),a(0,o,"syncObj",null,function(t){this._syncObj=t,this.renderDetailWav=!1}),s._waveInfoEleNum=4,s.detailTexWidth=256,s.detailTexHeight=256,n(s,["deg2rad",function(){return this.deg2rad=Math.PI/180},"_2pi",function(){return this._2pi=2*Math.PI}]),s}(Vi);i.__init([me])}(window,document,Laya)}).call(window)},function(t,e,i){(function(){!function(t,e,i){var n=(i.un,i.uns,i["static"]),r=i["class"],a=i.getset,s=(i.__newvec,laya.display.Animation),o=laya.utils.ClassUtils,h=laya.filters.ColorFilter,l=laya.utils.Ease,u=laya.events.Event,c=laya.display.css.Font,_=laya.display.FrameAnimation,d=laya.display.Graphics,f=laya.utils.Handler,p=laya.display.Input,m=laya.net.Loader,g=(laya.display.Node,laya.maths.Point),y=laya.maths.Rectangle,x=laya.renders.Render,v=laya.display.Sprite,S=laya.display.Text,T=laya.resource.Texture,E=laya.utils.Tween,w=laya.utils.Utils;i["interface"]("laya.ui.IItem"),i["interface"]("laya.ui.ISelect"),i["interface"]("laya.ui.IRender"),i["interface"]("laya.ui.IComponent"),i["interface"]("laya.ui.IBox","IComponent");var b=function(){function t(){this.enable=!1,this.top=NaN,this.bottom=NaN,this.left=NaN,this.right=NaN,this.centerX=NaN,this.centerY=NaN,this.anchorX=NaN,this.anchorY=NaN}return r(t,"laya.ui.LayoutStyle"),n(t,["EMPTY",function(){return this.EMPTY=new t}]),t}(),C=function(){function t(){}return r(t,"laya.ui.Styles"),t.labelColor="#000000",t.buttonStateNum=3,t.scrollBarMinNum=15,t.scrollBarDelayTime=500,n(t,["defaultSizeGrid",function(){return this.defaultSizeGrid=[4,4,4,4,0]},"labelPadding",function(){return this.labelPadding=[2,2,2,2]},"inputLabelPadding",function(){return this.inputLabelPadding=[1,1,1,3]},"buttonLabelColors",function(){return this.buttonLabelColors=["#32556b","#32cc6b","#ff0000","#C0C0C0"]},"comboBoxItemColors",function(){return this.comboBoxItemColors=["#5e95b6","#ffffff","#000000","#8fa4b1","#ffffff"]}]),t}(),M=function(){function t(){}return r(t,"laya.ui.UIUtils"),t.fillArray=function(t,e,i){var n=t.concat();if(e)for(var r=e.split(","),a=0,s=Math.min(n.length,r.length);s>a;a++){var o=r[a];n[a]="true"==o?!0:"false"==o?!1:o,null!=i&&(n[a]=i(o))}return n},t.toColor=function(t){return w.toHexColor(t)},t.gray=function(e,i){void 0===i&&(i=!0),i?t.addFilter(e,t.grayFilter):t.clearFilter(e,h)},t.addFilter=function(t,e){var i=t.filters||[];i.push(e),t.filters=i},t.clearFilter=function(t,e){var n=t.filters;if(null!=n&&n.length>0){for(var r=n.length-1;r>-1;r--){var a=n[r];i.__typeof(a,e)&&n.splice(r,1)}t.filters=n}},t._getReplaceStr=function(e){return t.escapeSequence[e]},t.adptString=function(e){return e.replace(/\\(\w)/g,t._getReplaceStr)},n(t,["grayFilter",function(){return this.grayFilter=new h([.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0])},"escapeSequence",function(){return this.escapeSequence={"\\n":"\n","\\t":"	"}}]),t}(),D=function(){function t(){}return r(t,"UIConfig"),t.touchScrollEnable=!0,t.mouseWheelEnable=!0,t.showButtons=!0,t.popupBgColor="#000000",t.popupBgAlpha=.5,t.closeDialogOnSide=!0,t}(),A=function(t){function e(){this.autoCacheCmd=!0,this._width=0,this._height=0,this._source=null,this._sizeGrid=null,this._isChanged=!1,this._offset=null,e.__super.call(this)}r(e,"laya.ui.AutoBitmap",t);var n=e.prototype;return n.destroy=function(){t.prototype.destroy.call(this),this._source=null,this._sizeGrid=null,this._offset=null},n._setChanged=function(){this._isChanged||(this._isChanged=!0,i.timer.callLater(this,this.changeSource))},n.changeSource=function(){e.cacheCount++>50&&e.clearCache(),this._isChanged=!1;var t=this._source;if(t&&t.bitmap){var i=this.width,n=this.height,r=this._sizeGrid,a=t.sourceWidth,s=t.sourceHeight;if(!r||a===i&&s===n)this.cleanByTexture(t,this._offset?this._offset[0]:0,this._offset?this._offset[1]:0,i,n);else{t.$_GID||(t.$_GID=w.getGID());var o=t.$_GID+"."+i+"."+n+"."+r.join(".");if(e.cmdCaches[o])return void(this.cmds=e.cmdCaches[o]);this.clear();var h=r[0],l=r[1],u=r[2],c=r[3],_=r[4],d=!1;if(c+l>i){var f=i;d=!0,i=c+l}d&&(this.save(),this.clipRect(0,0,f,n)),c&&h&&this.drawTexture(e.getTexture(t,0,0,c,h),0,0,c,h),l&&h&&this.drawTexture(e.getTexture(t,a-l,0,l,h),i-l,0,l,h),c&&u&&this.drawTexture(e.getTexture(t,0,s-u,c,u),0,n-u,c,u),l&&u&&this.drawTexture(e.getTexture(t,a-l,s-u,l,u),i-l,n-u,l,u),h&&this.drawBitmap(_,e.getTexture(t,c,0,a-c-l,h),c,0,i-c-l,h),u&&this.drawBitmap(_,e.getTexture(t,c,s-u,a-c-l,u),c,n-u,i-c-l,u),c&&this.drawBitmap(_,e.getTexture(t,0,h,c,s-h-u),0,h,c,n-h-u),l&&this.drawBitmap(_,e.getTexture(t,a-l,h,l,s-h-u),i-l,h,l,n-h-u),this.drawBitmap(_,e.getTexture(t,c,h,a-c-l,s-h-u),c,h,i-c-l,n-h-u),d&&this.restore(),this.autoCacheCmd&&!x.isConchApp&&(e.cmdCaches[o]=this.cmds)}this._repaint()}},n.drawBitmap=function(t,e,i,n,r,a){void 0===r&&(r=0),void 0===a&&(a=0),.1>r||.1>a||(!t||e.width==r&&e.height==a?this.drawTexture(e,i,n,r,a):this.fillTexture(e,i,n,r,a))},n.clear=function(e){void 0===e&&(e=!0),t.prototype.clear.call(this,!1)},a(0,n,"sizeGrid",function(){return this._sizeGrid},function(t){this._sizeGrid=t,this._setChanged()}),a(0,n,"width",function(){return this._width?this._width:this._source?this._source.sourceWidth:0},function(t){this._width!=t&&(this._width=t,this._setChanged())}),a(0,n,"height",function(){return this._height?this._height:this._source?this._source.sourceHeight:0},function(t){this._height!=t&&(this._height=t,this._setChanged())}),a(0,n,"source",function(){return this._source},function(t){t?(this._source=t,this._setChanged()):(this._source=null,this.clear())}),e.getTexture=function(t,i,n,r,a){0>=r&&(r=1),0>=a&&(a=1),t.$_GID||(t.$_GID=w.getGID());var s=t.$_GID+"."+i+"."+n+"."+r+"."+a,o=e.textureCache[s];return o||(o=e.textureCache[s]=T.createFromTexture(t,i,n,r,a)),o},e.clearCache=function(){e.cacheCount=0,e.cmdCaches={},e.textureCache={}},e.setCache=function(t,i){e.cacheCount++,e.textureCache[t]=i},e.getCache=function(t){return e.textureCache[t]},e.cmdCaches={},e.cacheCount=0,e.textureCache={},e}(d),R=(function(t){function e(){e.__super.call(this)}return r(e,"laya.ui.UIEvent",t),e.SHOW_TIP="showtip",e.HIDE_TIP="hidetip",e}(u),function(t){function e(){this._comXml=null,this._dataSource=null,this._toolTip=null,this._tag=null,this._disabled=!1,this._gray=!1,this.layoutEnabled=!0,e.__super.call(this),this._layout=b.EMPTY,this.preinitialize(),this.createChildren(),this.initialize()}r(e,"laya.ui.Component",t);var n=e.prototype;return i.imps(n,{"laya.ui.IComponent":!0}),n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._dataSource=this._layout=null,this._tag=null,this._toolTip=null},n.preinitialize=function(){},n.createChildren=function(){},n.initialize=function(){},n.callLater=function(t,e){i.timer.callLater(this,t,e)},n.runCallLater=function(t){i.timer.runCallLater(this,t)},n.commitMeasure=function(){},n.changeSize=function(){this.event("resize")},n.getLayout=function(){return this._layout===b.EMPTY&&(this._layout=new b),this._layout},n._setLayoutEnabled=function(t){this._layout&&this._layout.enable!=t&&(this._layout.enable=t,this.on("added",this,this.onAdded),this.on("removed",this,this.onRemoved),this.parent&&this.onAdded())},n.onRemoved=function(){this.parent.off("resize",this,this.onCompResize)},n.onAdded=function(){this.parent.on("resize",this,this.onCompResize),this.resetLayoutX(),this.resetLayoutY()},n.onCompResize=function(){this._layout&&this._layout.enable&&(this.resetLayoutX(),this.resetLayoutY())},n.resetLayoutX=function(){var t=this._layout;if(isNaN(t.anchorX)||(this.pivotX=t.anchorX*this.width),this.layoutEnabled){var e=this.parent;e&&(isNaN(t.centerX)?isNaN(t.left)?isNaN(t.right)||(this.x=Math.round(e.width-this.displayWidth-t.right+this.pivotX*this.scaleX)):(this.x=Math.round(t.left+this.pivotX*this.scaleX),isNaN(t.right)||(this.width=(e._width-t.left-t.right)/(this.scaleX||.01))):this.x=Math.round(.5*(e.width-this.displayWidth)+t.centerX+this.pivotX*this.scaleX))}},n.resetLayoutY=function(){var t=this._layout;if(isNaN(t.anchorY)||(this.pivotY=t.anchorY*this.height),this.layoutEnabled){var e=this.parent;e&&(isNaN(t.centerY)?isNaN(t.top)?isNaN(t.bottom)||(this.y=Math.round(e.height-this.displayHeight-t.bottom+this.pivotY*this.scaleY)):(this.y=Math.round(t.top+this.pivotY*this.scaleY),isNaN(t.bottom)||(this.height=(e._height-t.top-t.bottom)/(this.scaleY||.01))):this.y=Math.round(.5*(e.height-this.displayHeight)+t.centerY+this.pivotY*this.scaleY))}},n.onMouseOver=function(t){i.stage.event("showtip",this._toolTip)},n.onMouseOut=function(t){i.stage.event("hidetip",this._toolTip)},a(0,n,"displayWidth",function(){return this.width*this.scaleX}),a(0,n,"width",function(){return this._width?this._width:this.measureWidth},function(t){this._width!=t&&(this._width=t,this.conchModel&&this.conchModel.size(this._width,this._height),this.callLater(this.changeSize),!this._layout.enable||isNaN(this._layout.centerX)&&isNaN(this._layout.right)&&isNaN(this._layout.anchorX)||this.resetLayoutX())}),a(0,n,"measureWidth",function(){var t=0;this.commitMeasure();for(var e=this.numChildren-1;e>-1;e--){var i=this.getChildAt(e);i.visible&&(t=Math.max(i.x+i.width*i.scaleX,t))}return t}),a(0,n,"displayHeight",function(){return this.height*this.scaleY}),a(0,n,"height",function(){return this._height?this._height:this.measureHeight},function(t){this._height!=t&&(this._height=t,this.conchModel&&this.conchModel.size(this._width,this._height),this.callLater(this.changeSize),!this._layout.enable||isNaN(this._layout.centerY)&&isNaN(this._layout.bottom)&&isNaN(this._layout.anchorY)||this.resetLayoutY())}),a(0,n,"dataSource",function(){return this._dataSource},function(t){this._dataSource=t;for(var e in this._dataSource)this.hasOwnProperty(e)&&"function"!=typeof this[e]&&(this[e]=this._dataSource[e])}),a(0,n,"scaleY",t.prototype._$get_scaleY,function(e){t.prototype._$get_scaleY.call(this)!=e&&(t.prototype._$set_scaleY.call(this,e),this.callLater(this.changeSize),this._layout.enable&&this.resetLayoutY())}),a(0,n,"measureHeight",function(){var t=0;this.commitMeasure();for(var e=this.numChildren-1;e>-1;e--){var i=this.getChildAt(e);i.visible&&(t=Math.max(i.y+i.height*i.scaleY,t))}return t}),a(0,n,"scaleX",t.prototype._$get_scaleX,function(e){t.prototype._$get_scaleX.call(this)!=e&&(t.prototype._$set_scaleX.call(this,e),this.callLater(this.changeSize),this._layout.enable&&this.resetLayoutX())}),a(0,n,"top",function(){return this._layout.top},function(t){t!=this._layout.top&&(this.getLayout().top=t,this._setLayoutEnabled(!0)),this.resetLayoutY()}),a(0,n,"bottom",function(){return this._layout.bottom},function(t){t!=this._layout.bottom&&(this.getLayout().bottom=t,this._setLayoutEnabled(!0)),this.resetLayoutY()}),a(0,n,"left",function(){return this._layout.left},function(t){t!=this._layout.left&&(this.getLayout().left=t,this._setLayoutEnabled(!0)),this.resetLayoutX()}),a(0,n,"right",function(){return this._layout.right},function(t){t!=this._layout.right&&(this.getLayout().right=t,this._setLayoutEnabled(!0)),this.resetLayoutX()}),a(0,n,"centerX",function(){return this._layout.centerX},function(t){t!=this._layout.centerX&&(this.getLayout().centerX=t,this._setLayoutEnabled(!0)),this.resetLayoutX()}),a(0,n,"centerY",function(){return this._layout.centerY},function(t){t!=this._layout.centerY&&(this.getLayout().centerY=t,this._setLayoutEnabled(!0)),this.resetLayoutY()}),a(0,n,"anchorX",function(){return this._layout.anchorX},function(t){t!=this._layout.anchorX&&(this.getLayout().anchorX=t,this._setLayoutEnabled(!0)),this.resetLayoutX()}),a(0,n,"anchorY",function(){return this._layout.anchorY},function(t){t!=this._layout.anchorY&&(this.getLayout().anchorY=t,this._setLayoutEnabled(!0)),this.resetLayoutY()}),a(0,n,"tag",function(){return this._tag},function(t){this._tag=t}),a(0,n,"toolTip",function(){return this._toolTip},function(t){this._toolTip!=t&&(this._toolTip=t,null!=t?(this.on("mouseover",this,this.onMouseOver),this.on("mouseout",this,this.onMouseOut)):(this.off("mouseover",this,this.onMouseOver),this.off("mouseout",this,this.onMouseOut)))}),a(0,n,"comXml",function(){return this._comXml},function(t){this._comXml=t}),a(0,n,"gray",function(){return this._gray},function(t){t!==this._gray&&(this._gray=t,M.gray(this,t))}),a(0,n,"disabled",function(){return this._disabled},function(t){t!==this._disabled&&(this.gray=this._disabled=t,this.mouseEnabled=!t)}),e}(v)),I=function(t){function e(){this.lockLayer=null,this.popupEffect=function(t){t.scale(1,1),E.from(t,{x:i.stage.width/2,y:i.stage.height/2,scaleX:0,scaleY:0},300,l.backOut,f.create(this,this.doOpen,[t]))},this.closeEffect=function(t,e){E.to(t,{x:i.stage.width/2,y:i.stage.height/2,scaleX:0,scaleY:0},300,l.strongOut,f.create(this,this.doClose,[t,e]))},e.__super.call(this),this.maskLayer=new v,this.popupEffectHandler=new f(this,this.popupEffect),this.closeEffectHandler=new f(this,this.closeEffect),this.mouseEnabled=this.maskLayer.mouseEnabled=!0,this.zOrder=1e3,i.stage.addChild(this),i.stage.on("resize",this,this._onResize),D.closeDialogOnSide&&this.maskLayer.on("click",this,this._closeOnSide),this._onResize(null)}r(e,"laya.ui.DialogManager",t);var n=e.prototype;return n._closeOnSide=function(){var t=this.getChildAt(this.numChildren-1);t instanceof laya.ui.Dialog&&t.close("side")},n.setLockView=function(t){this.lockLayer||(this.lockLayer=new P,this.lockLayer.mouseEnabled=!0,this.lockLayer.size(i.stage.width,i.stage.height)),this.lockLayer.removeChildren(),t&&(t.centerX=t.centerY=0,this.lockLayer.addChild(t))},n._onResize=function(t){var e=this.maskLayer.width=i.stage.width,n=this.maskLayer.height=i.stage.height;this.lockLayer&&this.lockLayer.size(e,n),this.maskLayer.graphics.clear(),this.maskLayer.graphics.drawRect(0,0,e,n,D.popupBgColor),this.maskLayer.alpha=D.popupBgAlpha;for(var r=this.numChildren-1;r>-1;r--){var a=this.getChildAt(r);a.popupCenter&&this._centerDialog(a)}},n._centerDialog=function(t){t.x=Math.round((i.stage.width-t.width>>1)+t.pivotX),t.y=Math.round((i.stage.height-t.height>>1)+t.pivotY)},n.open=function(t,e){void 0===e&&(e=!1),e&&this.removeChildren(),t.popupCenter&&this._centerDialog(t),this.addChild(t),(t.isModal||this._$P.hasZorder)&&this.timer.callLater(this,this._checkMask),null!=t.popupEffect?t.popupEffect.runWith(t):this.doOpen(t),this.event("open")},n.doOpen=function(t){t.onOpened()},n.lock=function(t){this.lockLayer&&(t?this.addChild(this.lockLayer):this.lockLayer.removeSelf())},n.close=function(t,e){null!=t.closeEffect?t.closeEffect.runWith([t,e]):this.doClose(t,e),this.event("close")},n.doClose=function(t,e){t.removeSelf(),t.isModal&&this._checkMask(),t.closeHandler&&t.closeHandler.runWith(e),t.onClosed(e)},n.closeAll=function(){this.removeChildren(),this.event("close")},n.getDialogsByGroup=function(t){for(var e=[],i=this.numChildren-1;i>-1;i--){var n=this.getChildAt(i);n.group===t&&e.push(n)}return e},n.closeByGroup=function(t){for(var e=[],i=this.numChildren-1;i>-1;i--){var n=this.getChildAt(i);n.group===t&&(n.close(),e.push(n))}return e},n._checkMask=function(){this.maskLayer.removeSelf();for(var t=this.numChildren-1;t>-1;t--){var e=this.getChildAt(t);if(e&&e.isModal)return void this.addChildAt(this.maskLayer,t)}},e}(v),P=function(t){function e(){e.__super.call(this)}r(e,"laya.ui.Box",t);var n=e.prototype;return i.imps(n,{"laya.ui.IBox":!0}),a(0,n,"dataSource",t.prototype._$get_dataSource,function(t){this._dataSource=t;for(var e in t){var i=this.getChildByName(e);i?i.dataSource=t[e]:this.hasOwnProperty(e)&&"function"!=typeof this[e]&&(this[e]=t[e])}}),e}(R),L=function(t){function e(t,i){this.toggle=!1,this._bitmap=null,this._text=null,this._strokeColors=null,this._state=0,this._selected=!1,this._skin=null,this._autoSize=!0,this._sources=null,this._clickHandler=null,this._stateChanged=!1,e.__super.call(this),this._labelColors=C.buttonLabelColors,this._stateNum=C.buttonStateNum,void 0===i&&(i=""),this.skin=t,this.label=i}r(e,"laya.ui.Button",t);var s=e.prototype;return i.imps(s,{"laya.ui.ISelect":!0}),s.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._bitmap&&this._bitmap.destroy(),this._text&&this._text.destroy(e),this._bitmap=null,this._text=null,this._clickHandler=null,this._labelColors=this._sources=this._strokeColors=null},s.createChildren=function(){this.graphics=this._bitmap=new A},s.createText=function(){this._text||(this._text=new S,this._text.overflow=S.HIDDEN,this._text.align="center",this._text.valign="middle",this._text.width=this._width,this._text.height=this._height)},s.initialize=function(){1!==this._mouseEnableState&&(this.mouseEnabled=!0,this._setBit(2,!0)),this._createListener("mouseover",this,this.onMouse,null,!1,!1),this._createListener("mouseout",this,this.onMouse,null,!1,!1),this._createListener("mousedown",this,this.onMouse,null,!1,!1),this._createListener("mouseup",this,this.onMouse,null,!1,!1),this._createListener("click",this,this.onMouse,null,!1,!1)},s.onMouse=function(t){return this.toggle===!1&&this._selected?void 0:"click"===t.type?(this.toggle&&(this.selected=!this._selected),void(this._clickHandler&&this._clickHandler.run())):void(!this._selected&&(this.state=e.stateMap[t.type]))},s.changeClips=function(){var t=m.getRes(this._skin);if(!t)return void console.log("lose skin",this._skin);var e=t.sourceWidth,i=t.sourceHeight/this._stateNum;t.$_GID||(t.$_GID=w.getGID());var n=t.$_GID+"-"+this._stateNum,r=A.getCache(n);if(r)this._sources=r;else{if(this._sources=[],1===this._stateNum)this._sources.push(t);else for(var a=0;a<this._stateNum;a++)this._sources.push(T.createFromTexture(t,0,i*a,e,i));A.setCache(n,this._sources)}this._autoSize?(this._bitmap.width=this._width||e,this._bitmap.height=this._height||i,this._text&&(this._text.width=this._bitmap.width,this._text.height=this._bitmap.height)):this._text&&(this._text.x=e)},s.changeState=function(){this._stateChanged=!1,this.runCallLater(this.changeClips);var t=this._state<this._stateNum?this._state:this._stateNum-1;this._sources&&(this._bitmap.source=this._sources[t]),this.label&&(this._text.color=this._labelColors[t],this._strokeColors&&(this._text.strokeColor=this._strokeColors[t]))},s._setStateChanged=function(){this._stateChanged||(this._stateChanged=!0,this.callLater(this.changeState))},a(0,s,"labelStrokeColor",function(){return this.createText(),this._text.strokeColor},function(t){this.createText(),this._text.strokeColor=t}),a(0,s,"measureHeight",function(){return this.runCallLater(this.changeClips),this._text?Math.max(this._bitmap.height,this._text.height):this._bitmap.height}),a(0,s,"skin",function(){return this._skin},function(t){this._skin!=t&&(this._skin=t,this.callLater(this.changeClips),this._setStateChanged())}),a(0,s,"state",function(){return this._state},function(t){this._state!=t&&(this._state=t,this._setStateChanged())}),a(0,s,"text",function(){return this.createText(),this._text}),a(0,s,"stateNum",function(){return this._stateNum},function(t){t=parseInt(t),this._stateNum!=t&&(this._stateNum=1>t?1:t>3?3:t,this.callLater(this.changeClips))}),a(0,s,"strokeColors",function(){return this._strokeColors?this._strokeColors.join(","):""},function(t){this._strokeColors=M.fillArray(C.buttonLabelColors,t,String),this._setStateChanged()}),a(0,s,"labelColors",function(){return this._labelColors.join(",")},function(t){this._labelColors=M.fillArray(C.buttonLabelColors,t,String),this._setStateChanged()}),a(0,s,"measureWidth",function(){return this.runCallLater(this.changeClips),this._autoSize?this._bitmap.width:(this.runCallLater(this.changeState),this._bitmap.width+(this._text?this._text.width:0))}),a(0,s,"label",function(){return this._text?this._text.text:null},function(t){(this._text||t)&&(this.createText(),this._text.text!=t&&(t&&!this._text.parent&&this.addChild(this._text),this._text.text=(t+"").replace(/\\n/g,"\n"),this._setStateChanged()))}),a(0,s,"selected",function(){return this._selected},function(t){this._selected!=t&&(this._selected=t,this.state=this._selected?2:0,this.event("change"))}),a(0,s,"labelPadding",function(){return this.createText(),this._text.padding.join(",")},function(t){this.createText(),this._text.padding=M.fillArray(C.labelPadding,t,Number)}),a(0,s,"labelSize",function(){return this.createText(),this._text.fontSize},function(t){this.createText(),this._text.fontSize=t}),a(0,s,"labelStroke",function(){return this.createText(),this._text.stroke},function(t){this.createText(),this._text.stroke=t}),a(0,s,"labelBold",function(){return this.createText(),this._text.bold},function(t){this.createText(),this._text.bold=t}),a(0,s,"labelFont",function(){return this.createText(),this._text.font},function(t){this.createText(),this._text.font=t}),a(0,s,"labelAlign",function(){return this.createText(),this._text.align},function(t){this.createText(),this._text.align=t}),a(0,s,"clickHandler",function(){return this._clickHandler},function(t){this._clickHandler=t}),a(0,s,"sizeGrid",function(){return this._bitmap.sizeGrid?this._bitmap.sizeGrid.join(","):null},function(t){this._bitmap.sizeGrid=M.fillArray(C.defaultSizeGrid,t,Number)}),a(0,s,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this._autoSize&&(this._bitmap.width=e,this._text&&(this._text.width=e))}),a(0,s,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this._autoSize&&(this._bitmap.height=e,this._text&&(this._text.height=e))}),a(0,s,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e||"string"==typeof e?this.label=e+"":t.prototype._$set_dataSource.call(this,e)}),a(0,s,"iconOffset",function(){return this._bitmap._offset?this._bitmap._offset.join(","):null},function(t){t?this._bitmap._offset=M.fillArray([1,1],t,Number):this._bitmap._offset=[]}),n(e,["stateMap",function(){return this.stateMap={mouseup:0,mouseover:1,mousedown:2,mouseout:0}}]),e}(R),N=function(t){function e(t,i,n){this._sources=null,this._bitmap=null,this._skin=null,this._clipX=1,this._clipY=1,this._clipWidth=0,this._clipHeight=0,this._autoPlay=!1,this._interval=50,this._complete=null,this._isPlaying=!1,this._index=0,this._clipChanged=!1,this._group=null,e.__super.call(this),void 0===i&&(i=1),void 0===n&&(n=1),this._clipX=i,this._clipY=n,this.skin=t}r(e,"laya.ui.Clip",t);var n=e.prototype;return n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,!0),this._bitmap&&this._bitmap.destroy(),this._bitmap=null,this._sources=null},n.dispose=function(){this.destroy(!0),i.loader.clearRes(this._skin)},n.createChildren=function(){this.graphics=this._bitmap=new A},n._onDisplay=function(t){this._isPlaying?this._displayedInStage?this.play():this.stop():this._autoPlay&&this.play()},n.changeClip=function(){if(this._clipChanged=!1,this._skin){var t=m.getRes(this._skin);t?this.loadComplete(this._skin,t):i.loader.load(this._skin,f.create(this,this.loadComplete,[this._skin]))}},n.loadComplete=function(t,e){if(t===this._skin&&e){var i=this._clipWidth||Math.ceil(e.sourceWidth/this._clipX),n=this._clipHeight||Math.ceil(e.sourceHeight/this._clipY),r=this._skin+i+n,a=A.getCache(r);if(a)this._sources=a;else{this._sources=[];for(var s=0;s<this._clipY;s++)for(var o=0;o<this._clipX;o++)this._sources.push(T.createFromTexture(e,i*o,n*s,i,n));A.setCache(r,this._sources)}this.index=this._index,this.event("loaded"),this.onCompResize()}},n.play=function(){this._isPlaying=!0,this.index=0,this._index++,i.timer.loop(this.interval,this,this._loop),this.on("display",this,this._onDisplay),this.on("undisplay",this,this._onDisplay)},n._loop=function(){this._style.visible&&this._sources&&(this.index=this._index,this._index++,this._index>=this._sources.length&&(this._index=0))},n.stop=function(){this._isPlaying=!1,i.timer.clear(this,this._loop)},n._setClipChanged=function(){this._clipChanged||(this._clipChanged=!0,this.callLater(this.changeClip))},a(0,n,"interval",function(){return this._interval},function(t){this._interval!=t&&(this._interval=t,this._isPlaying&&this.play())}),a(0,n,"skin",function(){return this._skin},function(t){this._skin!=t&&(this._skin=t,t?this._setClipChanged():this._bitmap.source=null)}),a(0,n,"sources",function(){return this._sources},function(t){this._sources=t,this.index=this._index,this.event("loaded")}),a(0,n,"clipX",function(){return this._clipX},function(t){this._clipX=t||1,this._setClipChanged()}),a(0,n,"clipY",function(){return this._clipY},function(t){this._clipY=t||1,this._setClipChanged()}),a(0,n,"total",function(){return this.runCallLater(this.changeClip),this._sources?this._sources.length:0}),a(0,n,"clipWidth",function(){return this._clipWidth},function(t){this._clipWidth=t,this._setClipChanged()}),a(0,n,"sizeGrid",function(){return this._bitmap.sizeGrid?this._bitmap.sizeGrid.join(","):null},function(t){this._bitmap.sizeGrid=M.fillArray(C.defaultSizeGrid,t,Number)}),a(0,n,"group",function(){return this._group},function(t){t&&this._skin&&m.setGroup(this._skin,t),this._group=t}),a(0,n,"clipHeight",function(){return this._clipHeight},function(t){this._clipHeight=t,this._setClipChanged()}),a(0,n,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this._bitmap.width=e}),a(0,n,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this._bitmap.height=e}),a(0,n,"measureWidth",function(){return this.runCallLater(this.changeClip),this._bitmap.width}),a(0,n,"measureHeight",function(){return this.runCallLater(this.changeClip),this._bitmap.height}),a(0,n,"index",function(){return this._index},function(t){this._index=t,this._bitmap&&this._sources&&(this._bitmap.source=this._sources[t]),this.event("change")}),a(0,n,"autoPlay",function(){return this._autoPlay},function(t){this._autoPlay!=t&&(this._autoPlay=t,t?this.play():this.stop())}),a(0,n,"isPlaying",function(){return this._isPlaying},function(t){this._isPlaying=t}),a(0,n,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e&&Math.floor(e)==e||"string"==typeof e?this.index=parseInt(e):t.prototype._$set_dataSource.call(this,e)}),a(0,n,"bitmap",function(){return this._bitmap}),e}(R),O=function(t){function e(){this.changeHandler=null,this._gridSize=11,this._bgColor="#ffffff",this._borderColor="#000000",this._inputColor="#000000",this._inputBgColor="#efefef",this._colorPanel=null,this._colorTiles=null,this._colorBlock=null,this._colorInput=null,this._colorButton=null,this._colors=[],this._selectedColor="#000000",this._panelChanged=!1,e.__super.call(this)}r(e,"laya.ui.ColorPicker",t);var n=e.prototype;return n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._colorPanel&&this._colorPanel.destroy(e),this._colorButton&&this._colorButton.destroy(e),this._colorPanel=null,this._colorTiles=null,this._colorBlock=null,this._colorInput=null,this._colorButton=null,this._colors=null,this.changeHandler=null},n.createChildren=function(){this.addChild(this._colorButton=new L),this._colorPanel=new P,this._colorPanel.size(230,166),this._colorPanel.addChild(this._colorTiles=new v),this._colorPanel.addChild(this._colorBlock=new v),this._colorPanel.addChild(this._colorInput=new p)},n.initialize=function(){this._colorButton.on("click",this,this.onColorButtonClick),this._colorBlock.pos(5,5),this._colorInput.pos(60,5),this._colorInput.size(60,20),this._colorInput.on("change",this,this.onColorInputChange),this._colorInput.on("keydown",this,this.onColorFieldKeyDown),this._colorTiles.pos(5,30),this._colorTiles.on("mousemove",this,this.onColorTilesMouseMove),this._colorTiles.on("click",this,this.onColorTilesClick),
this._colorTiles.size(20*this._gridSize,12*this._gridSize),this._colorPanel.on("mousedown",this,this.onPanelMouseDown),this.bgColor=this._bgColor},n.onPanelMouseDown=function(t){t.stopPropagation()},n.changePanel=function(){this._panelChanged=!1;var t=this._colorPanel.graphics;t.clear(),t.drawRect(0,0,230,166,this._bgColor,this._borderColor),this.drawBlock(this._selectedColor),this._colorInput.borderColor=this._borderColor,this._colorInput.bgColor=this._inputBgColor,this._colorInput.color=this._inputColor,t=this._colorTiles.graphics,t.clear();for(var e=[0,3355443,6710886,10066329,13421772,16777215,16711680,65280,255,16776960,65535,16711935],i=0;12>i;i++)for(var n=0;20>n;n++){var r=0;r=0===n?e[i]:1===n?0:51*(((3*i+n/6)%3<<0)+3*(i/6<<0))<<16|n%6*51<<8|(i<<0)%6*51;var a=M.toColor(r);this._colors.push(a);var s=n*this._gridSize,o=i*this._gridSize;t.drawRect(s,o,this._gridSize,this._gridSize,a,"#000000")}},n.onColorButtonClick=function(t){this._colorPanel.parent?this.close():this.open()},n.open=function(){var t=this.localToGlobal(new g),e=t.x+this._colorPanel.width<=i.stage.width?t.x:i.stage.width-this._colorPanel.width,n=t.y+this._colorButton.height;n=n+this._colorPanel.height<=i.stage.height?n:t.y-this._colorPanel.height,this._colorPanel.pos(e,n),this._colorPanel.zOrder=1001,i._currentStage.addChild(this._colorPanel),i.stage.on("mousedown",this,this.removeColorBox)},n.close=function(){i.stage.off("mousedown",this,this.removeColorBox),this._colorPanel.removeSelf()},n.removeColorBox=function(t){this.close()},n.onColorFieldKeyDown=function(t){13==t.keyCode&&(this._colorInput.text?this.selectedColor=this._colorInput.text:this.selectedColor=null,this.close(),t.stopPropagation())},n.onColorInputChange=function(t){this._colorInput.text?this.drawBlock(this._colorInput.text):this.drawBlock("#FFFFFF")},n.onColorTilesClick=function(t){this.selectedColor=this.getColorByMouse(),this.close()},n.onColorTilesMouseMove=function(t){this._colorInput.focus=!1;var e=this.getColorByMouse();this._colorInput.text=e,this.drawBlock(e)},n.getColorByMouse=function(){var t=this._colorTiles.getMousePoint(),e=Math.floor(t.x/this._gridSize),i=Math.floor(t.y/this._gridSize);return this._colors[20*i+e]},n.drawBlock=function(t){var e=this._colorBlock.graphics;e.clear();var i=t?t:"#ffffff";e.drawRect(0,0,50,20,i,this._borderColor),t||e.drawLine(0,0,50,20,"#ff0000")},n.changeColor=function(){var t=this.graphics;t.clear();var e=this._selectedColor||"#000000";t.drawRect(0,0,this._colorButton.width,this._colorButton.height,e)},n._setPanelChanged=function(){this._panelChanged||(this._panelChanged=!0,this.callLater(this.changePanel))},a(0,n,"inputBgColor",function(){return this._inputBgColor},function(t){this._inputBgColor=t,this._setPanelChanged()}),a(0,n,"selectedColor",function(){return this._selectedColor},function(t){this._selectedColor!=t&&(this._selectedColor=this._colorInput.text=t,this.drawBlock(t),this.changeColor(),this.changeHandler&&this.changeHandler.runWith(this._selectedColor),this.event("change",u.EMPTY.setTo("change",this,this)))}),a(0,n,"skin",function(){return this._colorButton.skin},function(t){this._colorButton.skin=t,this.changeColor()}),a(0,n,"bgColor",function(){return this._bgColor},function(t){this._bgColor=t,this._setPanelChanged()}),a(0,n,"borderColor",function(){return this._borderColor},function(t){this._borderColor=t,this._setPanelChanged()}),a(0,n,"inputColor",function(){return this._inputColor},function(t){this._inputColor=t,this._setPanelChanged()}),e}(R),V=function(t){function e(t,i){this._visibleNum=6,this._button=null,this._list=null,this._isOpen=!1,this._itemSize=12,this._labels=[],this._selectedIndex=-1,this._selectHandler=null,this._itemHeight=NaN,this._listHeight=NaN,this._listChanged=!1,this._itemChanged=!1,this._scrollBarSkin=null,this._isCustomList=!1,this.itemRender=null,e.__super.call(this),this._itemColors=C.comboBoxItemColors,this.skin=t,this.labels=i}r(e,"laya.ui.ComboBox",t);var n=e.prototype;return n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._button&&this._button.destroy(e),this._list&&this._list.destroy(e),this._button=null,this._list=null,this._itemColors=null,this._labels=null,this._selectHandler=null},n.createChildren=function(){this.addChild(this._button=new L),this._button.text.align="left",this._button.labelPadding="0,0,0,5",this._button.on("mousedown",this,this.onButtonMouseDown)},n._createList=function(){this._list=new Y,this._scrollBarSkin&&(this._list.vScrollBarSkin=this._scrollBarSkin),this._setListEvent(this._list)},n._setListEvent=function(t){this._list.selectEnable=!0,this._list.on("mousedown",this,this.onListDown),this._list.mouseHandler=f.create(this,this.onlistItemMouse,null,!1),this._list.scrollBar&&this._list.scrollBar.on("mousedown",this,this.onScrollBarDown)},n.onListDown=function(t){t.stopPropagation()},n.onScrollBarDown=function(t){t.stopPropagation()},n.onButtonMouseDown=function(t){this.callLater(this.switchTo,[!this._isOpen])},n.changeList=function(){this._listChanged=!1;var t=this.width-2,e=this._itemColors[2];this._itemHeight=this._itemSize+6,this._list.itemRender=this.itemRender||{type:"Box",child:[{type:"Label",props:{name:"label",x:1,padding:"3,3,3,3",width:t,height:this._itemHeight,fontSize:this._itemSize,color:e}}]},this._list.repeatY=this._visibleNum,this._list.refresh()},n.onlistItemMouse=function(t,e){var i=t.type;if("mouseover"===i||"mouseout"===i){if(this._isCustomList)return;var n=this._list.getCell(e);if(!n)return;var r=n.getChildByName("label");r&&("mouseover"===i?(r.bgColor=this._itemColors[0],r.color=this._itemColors[1]):(r.bgColor=null,r.color=this._itemColors[2]))}else"click"===i&&(this.selectedIndex=e,this.isOpen=!1)},n.switchTo=function(t){this.isOpen=t},n.changeOpen=function(){this.isOpen=!this._isOpen},n.changeItem=function(){if(this._itemChanged=!1,this._listHeight=this._labels.length>0?Math.min(this._visibleNum,this._labels.length)*this._itemHeight:this._itemHeight,!this._isCustomList){var t=this._list.graphics;t.clear(),t.drawRect(0,0,this.width-1,this._listHeight,this._itemColors[4],this._itemColors[3])}var e=this._list.array||[];e.length=0;for(var i=0,n=this._labels.length;n>i;i++)e.push({label:this._labels[i]});this._list.height=this._listHeight,this._list.array=e},n.changeSelected=function(){this._button.label=this.selectedLabel},n.removeList=function(t){this.isOpen=!1},a(0,n,"selectedIndex",function(){return this._selectedIndex},function(t){this._selectedIndex!=t&&(this._selectedIndex=t,this._labels.length>0?this.changeSelected():this.callLater(this.changeSelected),this.event("change",[u.EMPTY.setTo("change",this,this)]),this._selectHandler&&this._selectHandler.runWith(this._selectedIndex))}),a(0,n,"measureHeight",function(){return this._button.height}),a(0,n,"skin",function(){return this._button.skin},function(t){this._button.skin!=t&&(this._button.skin=t,this._listChanged=!0)}),a(0,n,"measureWidth",function(){return this._button.width}),a(0,n,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this._button.width=this._width,this._itemChanged=!0,this._listChanged=!0}),a(0,n,"selectedLabel",function(){return this._selectedIndex>-1&&this._selectedIndex<this._labels.length?this._labels[this._selectedIndex]:null},function(t){this.selectedIndex=this._labels.indexOf(t)}),a(0,n,"labels",function(){return this._labels.join(",")},function(t){this._labels.length>0&&(this.selectedIndex=-1),t?this._labels=t.split(","):this._labels.length=0,this._itemChanged=!0}),a(0,n,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this._button.height=this._height}),a(0,n,"selectHandler",function(){return this._selectHandler},function(t){this._selectHandler=t}),a(0,n,"visibleNum",function(){return this._visibleNum},function(t){this._visibleNum=t,this._listChanged=!0}),a(0,n,"labelBold",function(){return this._button.text.bold},function(t){this._button.text.bold=t}),a(0,n,"itemColors",function(){return String(this._itemColors)},function(t){this._itemColors=M.fillArray(this._itemColors,t,String),this._listChanged=!0}),a(0,n,"itemSize",function(){return this._itemSize},function(t){this._itemSize=t,this._listChanged=!0}),a(0,n,"scrollBar",function(){return this.list.scrollBar}),a(0,n,"isOpen",function(){return this._isOpen},function(t){if(this._isOpen!=t)if(this._isOpen=t,this._button.selected=this._isOpen,this._isOpen){this._list||this._createList(),this._listChanged&&!this._isCustomList&&this.changeList(),this._itemChanged&&this.changeItem();var e=this.localToGlobal(g.TEMP.setTo(0,0)),n=e.y+this._button.height;n=n+this._listHeight<=i.stage.height?n:e.y-this._listHeight,this._list.pos(e.x,n),this._list.zOrder=1001,i._currentStage.addChild(this._list),i.stage.once("mousedown",this,this.removeList),this._list.selectedIndex=this._selectedIndex}else this._list&&this._list.removeSelf()}),a(0,n,"scrollBarSkin",function(){return this._scrollBarSkin},function(t){this._scrollBarSkin=t}),a(0,n,"sizeGrid",function(){return this._button.sizeGrid},function(t){this._button.sizeGrid=t}),a(0,n,"button",function(){return this._button}),a(0,n,"list",function(){return this._list||this._createList(),this._list},function(t){t&&(t.removeSelf(),this._isCustomList=!0,this._list=t,this._setListEvent(t),this._itemHeight=t.getCell(0).height+t.spaceY)}),a(0,n,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e&&Math.floor(e)==e||"string"==typeof e?this.selectedIndex=parseInt(e):e instanceof Array?this.labels=e.join(","):t.prototype._$set_dataSource.call(this,e)}),a(0,n,"labelColors",function(){return this._button.labelColors},function(t){this._button.labelColors!=t&&(this._button.labelColors=t)}),a(0,n,"labelPadding",function(){return this._button.text.padding.join(",")},function(t){this._button.text.padding=M.fillArray(C.labelPadding,t,Number)}),a(0,n,"labelSize",function(){return this._button.text.fontSize},function(t){this._button.text.fontSize=t}),a(0,n,"labelFont",function(){return this._button.text.font},function(t){this._button.text.font=t}),a(0,n,"stateNum",function(){return this._button.stateNum},function(t){this._button.stateNum=t}),e}(R),F=function(t){function e(t){this.rollRatio=.95,this.changeHandler=null,this.scaleBar=!0,this.autoHide=!1,this.elasticDistance=0,this.elasticBackTime=500,this.upButton=null,this.downButton=null,this.slider=null,this._scrollSize=1,this._skin=null,this._thumbPercent=1,this._target=null,this._lastPoint=null,this._lastOffset=0,this._checkElastic=!1,this._isElastic=!1,this._value=NaN,this._hide=!1,this._clickOnly=!0,this._offsets=null,e.__super.call(this),this._showButtons=D.showButtons,this._touchScrollEnable=D.touchScrollEnable,this._mouseWheelEnable=D.mouseWheelEnable,this.skin=t,this.max=1}r(e,"laya.ui.ScrollBar",t);var n=e.prototype;return n.destroy=function(e){void 0===e&&(e=!0),this.stopScroll(),this.target=null,t.prototype.destroy.call(this,e),this.upButton&&this.upButton.destroy(e),this.downButton&&this.downButton.destroy(e),this.slider&&this.slider.destroy(e),this.upButton=this.downButton=null,this.slider=null,this.changeHandler=null,this._offsets=null},n.createChildren=function(){this.addChild(this.slider=new B),this.addChild(this.upButton=new L),this.addChild(this.downButton=new L)},n.initialize=function(){this.slider.showLabel=!1,this.slider.on("change",this,this.onSliderChange),this.slider.setSlider(0,0,0),this.upButton.on("mousedown",this,this.onButtonMouseDown),this.downButton.on("mousedown",this,this.onButtonMouseDown)},n.onSliderChange=function(){this.value=this.slider.value},n.onButtonMouseDown=function(t){var e=t.currentTarget===this.upButton;this.slide(e),i.timer.once(C.scrollBarDelayTime,this,this.startLoop,[e]),i.stage.once("mouseup",this,this.onStageMouseUp)},n.startLoop=function(t){i.timer.frameLoop(1,this,this.slide,[t])},n.slide=function(t){t?this.value-=this._scrollSize:this.value+=this._scrollSize},n.onStageMouseUp=function(t){i.timer.clear(this,this.startLoop),i.timer.clear(this,this.slide)},n.changeScrollBar=function(){this.upButton.visible=this._showButtons,this.downButton.visible=this._showButtons,this._showButtons&&(this.upButton.skin=this._skin.replace(".png","$up.png"),this.downButton.skin=this._skin.replace(".png","$down.png")),this.slider.isVertical?this.slider.y=this._showButtons?this.upButton.height:0:this.slider.x=this._showButtons?this.upButton.width:0,this.resetPositions()},n.changeSize=function(){t.prototype.changeSize.call(this),this.resetPositions(),this.event("change"),this.changeHandler&&this.changeHandler.runWith(this.value)},n.resetPositions=function(){this.slider.isVertical?this.slider.height=this.height-(this._showButtons?this.upButton.height+this.downButton.height:0):this.slider.width=this.width-(this._showButtons?this.upButton.width+this.downButton.width:0),this.resetButtonPosition()},n.resetButtonPosition=function(){this.slider.isVertical?this.downButton.y=this.slider.y+this.slider.height:this.downButton.x=this.slider.x+this.slider.width},n.setScroll=function(t,e,i){this.runCallLater(this.changeSize),this.slider.setSlider(t,e,i),this.slider.bar.visible=e>0,!this._hide&&this.autoHide&&(this.visible=!1)},n.onTargetMouseWheel=function(t){this.value-=t.delta*this._scrollSize,this.target=this._target},n.onTargetMouseDown=function(t){this._clickOnly=!0,this._lastOffset=0,this._checkElastic=!1,this._lastPoint||(this._lastPoint=new g),this._lastPoint.setTo(i.stage.mouseX,i.stage.mouseY),i.timer.clear(this,this.tweenMove),E.clearTween(this),i.stage.once("mouseup",this,this.onStageMouseUp2),i.stage.once("mouseout",this,this.onStageMouseUp2),i.timer.frameLoop(1,this,this.loop)},n.loop=function(){var t=i.stage.mouseY,e=i.stage.mouseX;if(this._lastOffset=this.isVertical?t-this._lastPoint.y:e-this._lastPoint.x,this._clickOnly){if(!(Math.abs(this._lastOffset*(this.isVertical?i.stage._canvasTransform.getScaleY():i.stage._canvasTransform.getScaleX()))>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this._target.mouseEnabled=!1,!this.hide&&this.autoHide&&(this.alpha=1,this.visible=!0),this.event("start")}this._offsets.push(this._lastOffset),this._lastPoint.x=e,this._lastPoint.y=t,0!==this._lastOffset&&(this._checkElastic||(this.elasticDistance>0?this._checkElastic||0==this._lastOffset||(this._lastOffset>0&&this._value<=this.min||this._lastOffset<0&&this._value>=this.max?(this._isElastic=!0,this._checkElastic=!0):this._isElastic=!1):this._checkElastic=!0),this._isElastic?this._value<=this.min?this.value-=this._lastOffset*Math.max(0,1-(this.min-this._value)/this.elasticDistance):this._value>=this.max&&(this.value-=this._lastOffset*Math.max(0,1-(this._value-this.max)/this.elasticDistance)):this.value-=this._lastOffset)},n.onStageMouseUp2=function(t){if(i.stage.off("mouseup",this,this.onStageMouseUp2),i.stage.off("mouseout",this,this.onStageMouseUp2),i.timer.clear(this,this.loop),!this._clickOnly)if(this._target.mouseEnabled=!0,this._isElastic)this._value<this.min?E.to(this,{value:this.min},this.elasticBackTime,l.sineOut,f.create(this,this.elasticOver)):this._value>this.max&&E.to(this,{value:this.max},this.elasticBackTime,l.sineOut,f.create(this,this.elasticOver));else{if(!this._offsets)return;this._offsets.length<1&&(this._offsets[0]=this.isVertical?i.stage.mouseY-this._lastPoint.y:i.stage.mouseX-this._lastPoint.x);for(var e=0,n=Math.min(this._offsets.length,3),r=0;n>r;r++)e+=this._offsets[this._offsets.length-1-r];if(this._lastOffset=e/n,e=Math.abs(this._lastOffset),2>e)return void this.event("end");e>60&&(this._lastOffset=this._lastOffset>0?60:-60);var a=Math.round(Math.abs(this.elasticDistance*(this._lastOffset/240)));i.timer.frameLoop(1,this,this.tweenMove,[a])}},n.elasticOver=function(){this._isElastic=!1,!this.hide&&this.autoHide&&E.to(this,{alpha:0},500),this.event("end")},n.tweenMove=function(t){this._lastOffset*=this.rollRatio;var e=NaN;if(t>0&&(this._lastOffset>0&&this.value<=this.min?(this._isElastic=!0,e=.5*-(this.min-t-this.value),this._lastOffset>e&&(this._lastOffset=e)):this._lastOffset<0&&this.value>=this.max&&(this._isElastic=!0,e=.5*-(this.max+t-this.value),this._lastOffset<e&&(this._lastOffset=e))),this.value-=this._lastOffset,Math.abs(this._lastOffset)<1){if(i.timer.clear(this,this.tweenMove),this._isElastic)return void(this._value<this.min?E.to(this,{value:this.min},this.elasticBackTime,l.sineOut,f.create(this,this.elasticOver)):this._value>this.max?E.to(this,{value:this.max},this.elasticBackTime,l.sineOut,f.create(this,this.elasticOver)):this.elasticOver());this.event("end"),!this.hide&&this.autoHide&&E.to(this,{alpha:0},500)}},n.stopScroll=function(){this.onStageMouseUp2(null),i.timer.clear(this,this.tweenMove),E.clearTween(this)},a(0,n,"measureHeight",function(){return this.slider.isVertical?100:this.slider.height}),a(0,n,"skin",function(){return this._skin},function(t){this._skin!=t&&(this._skin=t,this.slider.skin=this._skin,this.callLater(this.changeScrollBar))}),a(0,n,"max",function(){return this.slider.max},function(t){this.slider.max=t}),a(0,n,"showButtons",function(){return this._showButtons},function(t){this._showButtons=t,this.callLater(this.changeScrollBar)}),a(0,n,"measureWidth",function(){return this.slider.isVertical?this.slider.width:100}),a(0,n,"min",function(){return this.slider.min},function(t){this.slider.min=t}),a(0,n,"value",function(){return this._value},function(t){t!==this._value&&(this._isElastic?this._value=t:(this.slider.value=t,this._value=this.slider.value),this.event("change"),this.changeHandler&&this.changeHandler.runWith(this.value))}),a(0,n,"isVertical",function(){return this.slider.isVertical},function(t){this.slider.isVertical=t}),a(0,n,"sizeGrid",function(){return this.slider.sizeGrid},function(t){this.slider.sizeGrid=t}),a(0,n,"scrollSize",function(){return this._scrollSize},function(t){this._scrollSize=t}),a(0,n,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e||"string"==typeof e?this.value=Number(e):t.prototype._$set_dataSource.call(this,e)}),a(0,n,"thumbPercent",function(){return this._thumbPercent},function(t){this.runCallLater(this.changeScrollBar),this.runCallLater(this.changeSize),t=t>=1?.99:t,this._thumbPercent=t,this.scaleBar&&(this.slider.isVertical?this.slider.bar.height=Math.max(this.slider.height*t,C.scrollBarMinNum):this.slider.bar.width=Math.max(this.slider.width*t,C.scrollBarMinNum))}),a(0,n,"target",function(){return this._target},function(t){this._target&&(this._target.off("mousewheel",this,this.onTargetMouseWheel),this._target.off("mousedown",this,this.onTargetMouseDown)),this._target=t,t&&(this._mouseWheelEnable&&this._target.on("mousewheel",this,this.onTargetMouseWheel),this._touchScrollEnable&&this._target.on("mousedown",this,this.onTargetMouseDown))}),a(0,n,"hide",function(){return this._hide},function(t){this._hide=t,this.visible=!t}),a(0,n,"touchScrollEnable",function(){return this._touchScrollEnable},function(t){this._touchScrollEnable=t,this.target=this._target}),a(0,n,"mouseWheelEnable",function(){return this._mouseWheelEnable},function(t){this._mouseWheelEnable=t}),a(0,n,"tick",function(){return this.slider.tick},function(t){this.slider.tick=t}),e}(R),B=function(t){function e(t){this.changeHandler=null,this.isVertical=!0,this.showLabel=!0,this._allowClickBack=!1,this._max=100,this._min=0,this._tick=1,this._value=0,this._skin=null,this._bg=null,this._progress=null,this._bar=null,this._tx=NaN,this._ty=NaN,this._maxMove=NaN,this._globalSacle=null,e.__super.call(this),this.skin=t}r(e,"laya.ui.Slider",t);var s=e.prototype;return s.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._bg&&this._bg.destroy(e),this._bar&&this._bar.destroy(e),this._progress&&this._progress.destroy(e),this._bg=null,this._bar=null,this._progress=null,this.changeHandler=null},s.createChildren=function(){this.addChild(this._bg=new U),this.addChild(this._bar=new L)},s.initialize=function(){this._bar.on("mousedown",this,this.onBarMouseDown),this._bg.sizeGrid=this._bar.sizeGrid="4,4,4,4,0",this._progress&&(this._progress.sizeGrid=this._bar.sizeGrid),this.allowClickBack=!0},s.onBarMouseDown=function(t){this._globalSacle||(this._globalSacle=new g),this._globalSacle.setTo(this.globalScaleX||.01,this.globalScaleY||.01),this._maxMove=this.isVertical?this.height-this._bar.height:this.width-this._bar.width,this._tx=i.stage.mouseX,this._ty=i.stage.mouseY,i.stage.on("mousemove",this,this.mouseMove),i.stage.once("mouseup",this,this.mouseUp),i.stage.once("mouseout",this,this.mouseUp),this.showValueText()},s.showValueText=function(){if(this.showLabel){var t=laya.ui.Slider.label;this.addChild(t),t.textField.changeText(this._value+""),this.isVertical?(t.x=this._bar.x+20,t.y=.5*(this._bar.height-t.height)+this._bar.y):(t.y=this._bar.y-20,t.x=.5*(this._bar.width-t.width)+this._bar.x)}},s.hideValueText=function(){laya.ui.Slider.label&&laya.ui.Slider.label.removeSelf()},s.mouseUp=function(t){i.stage.off("mousemove",this,this.mouseMove),i.stage.off("mouseup",this,this.mouseUp),i.stage.off("mouseout",this,this.mouseUp),this.sendChangeEvent("changed"),this.hideValueText()},s.mouseMove=function(t){var e=this._value;this.isVertical?(this._bar.y+=(i.stage.mouseY-this._ty)/this._globalSacle.y,this._bar.y>this._maxMove?this._bar.y=this._maxMove:this._bar.y<0&&(this._bar.y=0),this._value=this._bar.y/this._maxMove*(this._max-this._min)+this._min,this._progress&&(this._progress.height=this._bar.y+.5*this._bar.height)):(this._bar.x+=(i.stage.mouseX-this._tx)/this._globalSacle.x,this._bar.x>this._maxMove?this._bar.x=this._maxMove:this._bar.x<0&&(this._bar.x=0),this._value=this._bar.x/this._maxMove*(this._max-this._min)+this._min,this._progress&&(this._progress.width=this._bar.x+.5*this._bar.width)),this._tx=i.stage.mouseX,this._ty=i.stage.mouseY;var n=Math.pow(10,(this._tick+"").length-1);this._value=Math.round(Math.round(this._value/this._tick)*this._tick*n)/n,this._value!=e&&this.sendChangeEvent(),this.showValueText()},s.sendChangeEvent=function(t){void 0===t&&(t="change"),this.event(t),this.changeHandler&&this.changeHandler.runWith(this._value)},s.setBarPoint=function(){this.isVertical?this._bar.x=Math.round(.5*(this._bg.width-this._bar.width)):this._bar.y=Math.round(.5*(this._bg.height-this._bar.height))},s.changeSize=function(){t.prototype.changeSize.call(this),this.isVertical?this._bg.height=this.height:this._bg.width=this.width,this.setBarPoint(),this.changeValue()},s.setSlider=function(t,e,i){this._value=-1,this._min=t,this._max=e>t?e:t,this.value=t>i?t:i>e?e:i},s.changeValue=function(){var t=Math.pow(10,(this._tick+"").length-1);this._value=Math.round(Math.round(this._value/this._tick)*this._tick*t)/t,this._value=this._value>this._max?this._max:this._value<this._min?this._min:this._value;var e=this._max-this._min;0===e&&(e=1),this.isVertical?(this._bar.y=(this._value-this._min)/e*(this.height-this._bar.height),this._progress&&(this._progress.height=this._bar.y+.5*this._bar.height)):(this._bar.x=(this._value-this._min)/e*(this.width-this._bar.width),this._progress&&(this._progress.width=this._bar.x+.5*this._bar.width))},s.onBgMouseDown=function(t){var e=this._bg.getMousePoint();this.isVertical?this.value=e.y/(this.height-this._bar.height)*(this._max-this._min)+this._min:this.value=e.x/(this.width-this._bar.width)*(this._max-this._min)+this._min},a(0,s,"measureHeight",function(){return Math.max(this._bg.height,this._bar.height)}),a(0,s,"skin",function(){return this._skin},function(t){if(this._skin!=t){this._skin=t,this._bg.skin=this._skin,this._bar.skin=this._skin.replace(".png","$bar.png");var e=this._skin.replace(".png","$progress.png");m.getRes(e)&&(this._progress||(this.addChild(this._progress=new U),this._progress.sizeGrid=this._bar.sizeGrid,this.setChildIndex(this._progress,1)),this._progress.skin=e),this.setBarPoint(),this.callLater(this.changeValue)}}),a(0,s,"allowClickBack",function(){return this._allowClickBack},function(t){this._allowClickBack!=t&&(this._allowClickBack=t,t?this._bg.on("mousedown",this,this.onBgMouseDown):this._bg.off("mousedown",this,this.onBgMouseDown))}),a(0,s,"max",function(){return this._max},function(t){this._max!=t&&(this._max=t,this.callLater(this.changeValue))}),a(0,s,"measureWidth",function(){return Math.max(this._bg.width,this._bar.width)}),a(0,s,"tick",function(){return this._tick},function(t){this._tick!=t&&(this._tick=t,this.callLater(this.changeValue))}),a(0,s,"sizeGrid",function(){return this._bg.sizeGrid},function(t){this._bg.sizeGrid=t,this._bar.sizeGrid=t,this._progress&&(this._progress.sizeGrid=this._bar.sizeGrid)}),a(0,s,"min",function(){return this._min},function(t){this._min!=t&&(this._min=t,this.callLater(this.changeValue))}),a(0,s,"value",function(){return this._value},function(t){if(this._value!=t){var e=this._value;this._value=t,this.changeValue(),this._value!=e&&this.sendChangeEvent()}}),a(0,s,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e||"string"==typeof e?this.value=Number(e):t.prototype._$set_dataSource.call(this,e)}),a(0,s,"bar",function(){return this._bar}),n(e,["label",function(){return this.label=new k}]),e}(R),U=function(t){function e(t){this._bitmap=null,this._skin=null,this._group=null,e.__super.call(this),this.skin=t}r(e,"laya.ui.Image",t);var n=e.prototype;return n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,!0),this._bitmap&&this._bitmap.destroy(),this._bitmap=null},n.dispose=function(){this.destroy(!0),i.loader.clearRes(this._skin)},n.createChildren=function(){this.graphics=this._bitmap=new A,this._bitmap.autoCacheCmd=!1},n.setSource=function(t,e){t===this._skin&&e&&(this.source=e,this.onCompResize())},a(0,n,"source",function(){return this._bitmap.source},function(t){this._bitmap&&(this._bitmap.source=t,this.event("loaded"),this.repaint())}),a(0,n,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"string"==typeof e?this.skin=e:t.prototype._$set_dataSource.call(this,e)}),a(0,n,"measureHeight",function(){return this._bitmap.height}),a(0,n,"skin",function(){return this._skin},function(t){if(this._skin!=t)if(this._skin=t,t){var e=m.getRes(t);e?(this.source=e,this.onCompResize()):i.loader.load(this._skin,f.create(this,this.setSource,[this._skin]),null,"image",1,!0,this._group)}else this.source=null}),a(0,n,"group",function(){return this._group},function(t){t&&this._skin&&m.setGroup(this._skin,t),this._group=t}),a(0,n,"sizeGrid",function(){return this._bitmap.sizeGrid?this._bitmap.sizeGrid.join(","):null},function(t){this._bitmap.sizeGrid=M.fillArray(C.defaultSizeGrid,t,Number)}),a(0,n,"measureWidth",function(){return this._bitmap.width}),a(0,n,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this._bitmap.width=0==e?1e-7:e}),a(0,n,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this._bitmap.height=0==e?1e-7:e}),e}(R),k=function(t){function e(t){this._tf=null,e.__super.call(this),void 0===t&&(t=""),c.defaultColor=C.labelColor,this.text=t}r(e,"laya.ui.Label",t);var i=e.prototype;return i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._tf=null},i.createChildren=function(){this.addChild(this._tf=new S)},i.changeText=function(t){this._tf.changeText(t)},a(0,i,"padding",function(){return this._tf.padding.join(",")},function(t){this._tf.padding=M.fillArray(C.labelPadding,t,Number)}),a(0,i,"bold",function(){return this._tf.bold},function(t){this._tf.bold=t}),a(0,i,"align",function(){return this._tf.align},function(t){this._tf.align=t}),a(0,i,"text",function(){return this._tf.text},function(t){this._tf.text!=t&&(t&&(t=M.adptString(t+"")),this._tf.text=t,this.event("change"),this._width&&this._height||this.onCompResize())}),a(0,i,"italic",function(){return this._tf.italic},function(t){this._tf.italic=t}),a(0,i,"wordWrap",function(){return this._tf.wordWrap},function(t){this._tf.wordWrap=t}),a(0,i,"font",function(){return this._tf.font},function(t){this._tf.font=t}),a(0,i,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e||"string"==typeof e?this.text=e+"":t.prototype._$set_dataSource.call(this,e)}),a(0,i,"color",function(){return this._tf.color},function(t){this._tf.color=t}),a(0,i,"valign",function(){return this._tf.valign},function(t){this._tf.valign=t}),a(0,i,"leading",function(){return this._tf.leading},function(t){this._tf.leading=t}),a(0,i,"fontSize",function(){return this._tf.fontSize},function(t){this._tf.fontSize=t}),a(0,i,"bgColor",function(){return this._tf.bgColor},function(t){this._tf.bgColor=t}),a(0,i,"borderColor",function(){return this._tf.borderColor},function(t){this._tf.borderColor=t}),a(0,i,"stroke",function(){return this._tf.stroke},function(t){this._tf.stroke=t}),a(0,i,"strokeColor",function(){return this._tf.strokeColor},function(t){this._tf.strokeColor=t}),a(0,i,"textField",function(){return this._tf}),a(0,i,"measureWidth",function(){return this._tf.width}),a(0,i,"measureHeight",function(){return this._tf.height}),a(0,i,"width",function(){return this._width||this._tf.text?t.prototype._$get_width.call(this):0},function(e){t.prototype._$set_width.call(this,e),this._tf.width=e}),a(0,i,"height",function(){return this._height||this._tf.text?t.prototype._$get_height.call(this):0},function(e){t.prototype._$set_height.call(this,e),this._tf.height=e}),a(0,i,"overflow",function(){return this._tf.overflow},function(t){this._tf.overflow=t}),a(0,i,"underline",function(){return this._tf.underline},function(t){this._tf.underline=t}),a(0,i,"underlineColor",function(){return this._tf.underlineColor},function(t){this._tf.underlineColor=t}),e}(R),H=function(t){function e(t){this.changeHandler=null,this._bg=null,this._bar=null,this._skin=null,this._value=.5,e.__super.call(this),this.skin=t}r(e,"laya.ui.ProgressBar",t);var i=e.prototype;return i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._bg&&this._bg.destroy(e),this._bar&&this._bar.destroy(e),this._bg=this._bar=null,this.changeHandler=null},i.createChildren=function(){this.addChild(this._bg=new U),this.addChild(this._bar=new U),this._bar._bitmap.autoCacheCmd=!1},i.changeValue=function(){if(this.sizeGrid){var t=this.sizeGrid.split(","),e=Number(t[3]),i=Number(t[1]),n=this.width-e-i,r=n*this._value;this._bar.width=e+i+r,this._bar.visible=this._bar.width>e+i}else this._bar.width=this.width*this._value},a(0,i,"measureHeight",function(){return this._bg.height}),a(0,i,"skin",function(){return this._skin},function(t){this._skin!=t&&(this._skin=t,this._bg.skin=this._skin,this._bar.skin=this._skin.replace(".png","$bar.png"),this.callLater(this.changeValue))}),a(0,i,"measureWidth",function(){return this._bg.width}),a(0,i,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this._bg.height=this._height,this._bar.height=this._height}),a(0,i,"bar",function(){return this._bar}),a(0,i,"value",function(){return this._value},function(t){this._value!=t&&(t=t>1?1:0>t?0:t,this._value=t,this.callLater(this.changeValue),this.event("change"),this.changeHandler&&this.changeHandler.runWith(t))}),a(0,i,"bg",function(){return this._bg}),a(0,i,"sizeGrid",function(){return this._bg.sizeGrid},function(t){this._bg.sizeGrid=this._bar.sizeGrid=t}),a(0,i,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this._bg.width=this._width,this.callLater(this.changeValue)}),a(0,i,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e||"string"==typeof e?this.value=Number(e):t.prototype._$set_dataSource.call(this,e)}),e}(R),z=(function(t){function e(){this._tipBox=null,this._tipText=null,this._defaultTipHandler=null,e.__super.call(this),this._tipBox=new R,this._tipBox.addChild(this._tipText=new S),this._tipText.x=this._tipText.y=5,this._tipText.color=e.tipTextColor,this._defaultTipHandler=this._showDefaultTip,i.stage.on("showtip",this,this._onStageShowTip),i.stage.on("hidetip",this,this._onStageHideTip),this.zOrder=1100;
}r(e,"laya.ui.TipManager",t);var n=e.prototype;return n._onStageHideTip=function(t){i.timer.clear(this,this._showTip),this.closeAll(),this.removeSelf()},n._onStageShowTip=function(t){i.timer.once(e.tipDelay,this,this._showTip,[t],!0)},n._showTip=function(t){if("string"==typeof t){var e=String(t);Boolean(e)&&this._defaultTipHandler(e)}else t instanceof laya.utils.Handler?t.run():"function"==typeof t&&t.apply();i.stage.on("mousemove",this,this._onStageMouseMove),i.stage.on("mousedown",this,this._onStageMouseDown),this._onStageMouseMove(null)},n._onStageMouseDown=function(t){this.closeAll()},n._onStageMouseMove=function(t){this._showToStage(this,e.offsetX,e.offsetY)},n._showToStage=function(t,e,n){void 0===e&&(e=0),void 0===n&&(n=0);var r=t.getBounds();t.x=i.stage.mouseX+e,t.y=i.stage.mouseY+n,t.x+r.width>i.stage.width&&(t.x-=r.width+e),t.y+r.height>i.stage.height&&(t.y-=r.height+n)},n.closeAll=function(){i.timer.clear(this,this._showTip),i.stage.off("mousemove",this,this._onStageMouseMove),i.stage.off("mousedown",this,this._onStageMouseDown),this.removeChildren()},n.showDislayTip=function(t){this.addChild(t),this._showToStage(this),i._currentStage.addChild(this)},n._showDefaultTip=function(t){this._tipText.text=t;var n=this._tipBox.graphics;n.clear(),n.drawRect(0,0,this._tipText.width+10,this._tipText.height+10,e.tipBackColor),this.addChild(this._tipBox),this._showToStage(this),i._currentStage.addChild(this)},a(0,n,"defaultTipHandler",function(){return this._defaultTipHandler},function(t){this._defaultTipHandler=t}),e.offsetX=10,e.offsetY=15,e.tipTextColor="#ffffff",e.tipBackColor="#111111",e.tipDelay=200,e}(R),function(t){function e(){this._idMap=null,this._aniList=null,e.__super.call(this)}r(e,"laya.ui.View",t);var a=e.prototype;return a.createView=function(t){if(t.animations&&!this._idMap&&(this._idMap={}),e.createComp(t,this,this),t.animations){var i,n,r=[],a=t.animations,s=0,o=a.length;for(s=0;o>s;s++){switch(i=new _,n=a[s],i._setUp(this._idMap,n),this[n.name]=i,i._setControlNode(this),n.action){case 1:i.play(0,!1);break;case 2:i.play(0,!0)}r.push(i)}this._aniList=r}this._width>0&&null==t.props.hitTestPrior&&!this.mouseThrough&&(this.hitTestPrior=!0)},a.loadUI=function(t){var i=e.uiMap[t];i&&this.createView(i)},a.destroy=function(t){void 0===t&&(t=!0),this._aniList&&(this._aniList.length=0),this._idMap=null,this._aniList=null,laya.ui.Component.prototype.destroy.call(this,t)},e._regs=function(){var t;for(t in e.uiClassMap)o.regClass(t,e.uiClassMap[t])},e.createComp=function(t,n,r){if(n=n||e.getCompInstance(t),!n)return console.warn("can not create:"+t.type),null;var a=t.child;if(a)for(var s=0,h=a.length;h>s;s++){var l=a[s];if(!n.hasOwnProperty("itemRender")||"render"!=l.props.name&&"render"!==l.props.renderType)if("Graphic"==l.type)o.addGraphicsToSprite(l,n);else if(o.isDrawType(l.type))o.addGraphicToSprite(l,n,!0);else{var u=e.createComp(l,null,r);"Script"==l.type?"owner"in u?u.owner=n:"target"in u&&(u.target=n):"mask"==l.props.renderType||"mask"==l.props.name?n.mask=u:u instanceof laya.display.Sprite&&n.addChild(u)}else n.itemRender=l}var c=t.props;for(var _ in c){var d=c[_];e.setCompValue(n,_,d,r)}return i.__typeof(n,"laya.ui.IItem")&&n.initItems(),t.compId&&r&&r._idMap&&(r._idMap[t.compId]=n),n},e.setCompValue=function(t,e,i,n){"var"===e&&n?n[i]=t:t[e]="true"===i?!0:"false"===i?!1:i},e.getCompInstance=function(t){var n,r=t.props?t.props.runtime:null;return n=r?e.viewClassMap[r]||e.uiClassMap[r]||i.__classmap[r]:e.uiClassMap[t.type],t.props&&t.props.hasOwnProperty("renderType")&&"instance"==t.props.renderType?n.instance:n?new n:null},e.regComponent=function(t,i){e.uiClassMap[t]=i,o.regClass(t,i)},e.regViewRuntime=function(t,i){e.viewClassMap[t]=i},e.uiMap={},e.viewClassMap={},n(e,["uiClassMap",function(){return this.uiClassMap={ViewStack:J,LinkButton:L,TextArea:ht,ColorPicker:O,Box:P,Button:L,CheckBox:W,Clip:N,ComboBox:V,Component:R,HScrollBar:q,HSlider:K,Image:U,Label:k,List:Y,Panel:X,ProgressBar:H,Radio:$,RadioGroup:st,ScrollBar:F,Slider:B,Tab:ot,TextInput:et,View:e,VScrollBar:tt,VSlider:it,Tree:Q,HBox:rt,VBox:at,Sprite:v,Animation:s,Text:S,FontClip:j}}]),e.__init$=function(){e._regs()},e}(P)),W=function(t){function e(t,i){void 0===i&&(i=""),e.__super.call(this,t,i)}r(e,"laya.ui.CheckBox",t);var i=e.prototype;return i.preinitialize=function(){laya.ui.Component.prototype.preinitialize.call(this),this.toggle=!0,this._autoSize=!1},i.initialize=function(){t.prototype.initialize.call(this),this.createText(),this._text.align="left",this._text.valign="top",this._text.width=0},a(0,i,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"boolean"==typeof e?this.selected=e:"string"==typeof e?this.selected="true"===e:t.prototype._$set_dataSource.call(this,e)}),e}(L),G=function(t){function e(){this._space=0,this._align="none",this._itemChanged=!1,e.__super.call(this)}r(e,"laya.ui.LayoutBox",t);var i=e.prototype;return i.addChild=function(t){return t.on("resize",this,this.onResize),this._setItemChanged(),laya.display.Node.prototype.addChild.call(this,t)},i.onResize=function(t){this._setItemChanged()},i.addChildAt=function(t,e){return t.on("resize",this,this.onResize),this._setItemChanged(),laya.display.Node.prototype.addChildAt.call(this,t,e)},i.removeChild=function(t){return t.off("resize",this,this.onResize),this._setItemChanged(),laya.display.Node.prototype.removeChild.call(this,t)},i.removeChildAt=function(t){return this.getChildAt(t).off("resize",this,this.onResize),this._setItemChanged(),laya.display.Node.prototype.removeChildAt.call(this,t)},i.refresh=function(){this._setItemChanged()},i.changeItems=function(){this._itemChanged=!1},i.sortItem=function(t){t&&t.sort(function(t,e){return t.y-e.y})},i._setItemChanged=function(){this._itemChanged||(this._itemChanged=!0,this.callLater(this.changeItems))},a(0,i,"space",function(){return this._space},function(t){this._space=t,this._setItemChanged()}),a(0,i,"align",function(){return this._align},function(t){this._align=t,this._setItemChanged()}),e}(P),j=function(t){function e(t,i){this._valueArr=null,this._indexMap=null,this._sheet=null,this._direction="horizontal",this._spaceX=0,this._spaceY=0,this._align="left",this._wordsW=0,this._wordsH=0,e.__super.call(this),t&&(this.skin=t),i&&(this.sheet=i)}r(e,"laya.ui.FontClip",t);var i=e.prototype;return i.createChildren=function(){this._bitmap=new A,this.on("loaded",this,this._onClipLoaded)},i._onClipLoaded=function(){this.callLater(this.changeValue)},i.changeValue=function(){if(this._sources&&this._valueArr){this.graphics.clear(!0);var t;if(t=this._sources[0]){var e="horizontal"===this._direction;e?(this._wordsW=this._valueArr.length*(t.sourceWidth+this.spaceX),this._wordsH=t.sourceHeight):(this._wordsW=t.sourceWidth,this._wordsH=(t.sourceHeight+this.spaceY)*this._valueArr.length);var i=0;if(this._width)switch(this._align){case"center":i=.5*(this._width-this._wordsW);break;case"right":i=this._width-this._wordsW;break;default:i=0}for(var n=0,r=this._valueArr.length;r>n;n++){var a=this._indexMap[this._valueArr.charAt(n)];this.sources[a]&&(t=this.sources[a],e?this.graphics.drawTexture(t,i+n*(t.sourceWidth+this.spaceX),0,t.sourceWidth,t.sourceHeight):this.graphics.drawTexture(t,0+i,n*(t.sourceHeight+this.spaceY),t.sourceWidth,t.sourceHeight))}this._width||(this.resetLayoutX(),this.callLater(this.changeSize)),this._height||(this.resetLayoutY(),this.callLater(this.changeSize))}}},i.destroy=function(e){void 0===e&&(e=!0),this._valueArr=null,this._indexMap=null,this.graphics.clear(!0),this.removeSelf(),this.off("loaded",this,this._onClipLoaded),t.prototype.destroy.call(this,e)},a(0,i,"sheet",function(){return this._sheet},function(t){t+="",this._sheet=t;var e=t.split(" ");this._clipX=String(e[0]).length,this.clipY=e.length,this._indexMap={};for(var i=0;i<this._clipY;i++)for(var n=e[i].split(""),r=0,a=n.length;a>r;r++)this._indexMap[n[r]]=i*this._clipX+r}),a(0,i,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this.callLater(this.changeValue)}),a(0,i,"direction",function(){return this._direction},function(t){this._direction=t,this.callLater(this.changeValue)}),a(0,i,"value",function(){return this._valueArr?this._valueArr:""},function(t){t+="",this._valueArr=t,this.callLater(this.changeValue)}),a(0,i,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this.callLater(this.changeValue)}),a(0,i,"spaceX",function(){return this._spaceX},function(t){this._spaceX=t,"horizontal"===this._direction&&this.callLater(this.changeValue)}),a(0,i,"spaceY",function(){return this._spaceY},function(t){this._spaceY=t,"horizontal"!==this._direction&&this.callLater(this.changeValue)}),a(0,i,"align",function(){return this._align},function(t){this._align=t,this.callLater(this.changeValue)}),a(0,i,"measureWidth",function(){return this._wordsW}),a(0,i,"measureHeight",function(){return this._wordsH}),e}(N),Y=function(t){function e(){this.selectHandler=null,this.renderHandler=null,this.mouseHandler=null,this.selectEnable=!1,this.totalPage=0,this._content=null,this._scrollBar=null,this._itemRender=null,this._repeatX=0,this._repeatY=0,this._repeatX2=0,this._repeatY2=0,this._spaceX=0,this._spaceY=0,this._array=null,this._startIndex=0,this._selectedIndex=-1,this._page=0,this._isVertical=!0,this._cellSize=20,this._cellOffset=0,this._isMoved=!1,this.cacheContent=!1,this._createdLine=0,this._cellChanged=!1,e.__super.call(this),this._cells=[],this._offset=new g}r(e,"laya.ui.List",t);var n=e.prototype;return i.imps(n,{"laya.ui.IRender":!0,"laya.ui.IItem":!0}),n.destroy=function(t){void 0===t&&(t=!0),this._content&&this._content.destroy(t),this._scrollBar&&this._scrollBar.destroy(t),laya.ui.Component.prototype.destroy.call(this,t),this._content=null,this._scrollBar=null,this._itemRender=null,this._cells=null,this._array=null,this.selectHandler=this.renderHandler=this.mouseHandler=null},n.createChildren=function(){this.addChild(this._content=new P)},n.onScrollStart=function(){this._$P.cacheAs||(this._$P.cacheAs=t.prototype._$get_cacheAs.call(this)),t.prototype._$set_cacheAs.call(this,"none"),this._scrollBar.once("end",this,this.onScrollEnd)},n.onScrollEnd=function(){t.prototype._$set_cacheAs.call(this,this._$P.cacheAs)},n._removePreScrollBar=function(){var t=this.removeChildByName("scrollBar");t&&t.destroy(!0)},n.changeCells=function(){if(this._cellChanged=!1,this._itemRender){this.scrollBar=this.getChildByName("scrollBar");var t=this._getOneCell(),e=t.width+this._spaceX||1,i=t.height+this._spaceY||1;this._width>0&&(this._repeatX2=this._isVertical?Math.round(this._width/e):Math.ceil(this._width/e)),this._height>0&&(this._repeatY2=this._isVertical?Math.ceil(this._height/i):Math.round(this._height/i));var n=this._width?this._width:e*this.repeatX-this._spaceX,r=this._height?this._height:i*this.repeatY-this._spaceY;this._cellSize=this._isVertical?i:e,this._cellOffset=this._isVertical?i*Math.max(this._repeatY2,this._repeatY)-r-this._spaceY:e*Math.max(this._repeatX2,this._repeatX)-n-this._spaceX,this._isVertical&&this._scrollBar?this._scrollBar.height=r:!this._isVertical&&this._scrollBar&&(this._scrollBar.width=n),this.setContentSize(n,r);var a=this._isVertical?this.repeatX:this.repeatY,s=(this._isVertical?this.repeatY:this.repeatX)+(this._scrollBar?1:0);this._createItems(0,a,s),this._createdLine=s,this._array&&(this.array=this._array,this.runCallLater(this.renderItems))}},n._getOneCell=function(){if(0===this._cells.length){var t=this.createItem();this._offset.setTo(t.x,t.y),this._cells.push(t)}return this._cells[0]},n._createItems=function(t,e,i){var n=this._content,r=this._getOneCell(),a=r.width+this._spaceX,s=r.height+this._spaceY;if(this.cacheContent){var o=new P;o.cacheAsBitmap=!0,o.pos((this._isVertical?0:t)*a,(this._isVertical?t:0)*s),this._content.addChild(o),this._content.optimizeScrollRect=!0,n=o}for(var h=[],l=this._cells.length-1;l>-1;l--){var u=this._cells[l];u.removeSelf(),h.push(u)}this._cells.length=0;for(var c=t;i>c;c++)for(var _=0;e>_;_++)r=h.length?h.pop():this.createItem(),r.x=(this._isVertical?_:c)*a-n.x,r.y=(this._isVertical?c:_)*s-n.y,r.name="item"+(c*e+_),n.addChild(r),this.addCell(r)},n.createItem=function(){return"function"==typeof this._itemRender?new this._itemRender:z.createComp(this._itemRender)},n.addCell=function(t){t.on("click",this,this.onCellMouse),t.on("rightclick",this,this.onCellMouse),t.on("mouseover",this,this.onCellMouse),t.on("mouseout",this,this.onCellMouse),t.on("mousedown",this,this.onCellMouse),t.on("mouseup",this,this.onCellMouse),this._cells.push(t)},n.initItems=function(){if(!this._itemRender&&null!=this.getChildByName("item0")){this.repeatX=1;var t=0;t=0;for(var e=0;1e4>e;e++){var i=this.getChildByName("item"+e);{if(!i)break;this.addCell(i),t++}}this.repeatY=t}},n.setContentSize=function(t,e){this._content.width=t,this._content.height=e,(this._scrollBar||0!=this._offset.x||0!=this._offset.y)&&(this._content.scrollRect||(this._content.scrollRect=new y),this._content.scrollRect.setTo(-this._offset.x,-this._offset.y,t,e),this._content.conchModel&&this._content.conchModel.scrollRect(-this._offset.x,-this._offset.y,t,e)),this.event("resize")},n.onCellMouse=function(t){"mousedown"===t.type&&(this._isMoved=!1);var e=t.currentTarget,i=this._startIndex+this._cells.indexOf(e);0>i||("click"===t.type||"rightclick"===t.type?this.selectEnable&&!this._isMoved?this.selectedIndex=i:this.changeCellState(e,!0,0):"mouseover"!==t.type&&"mouseout"!==t.type||this._selectedIndex===i||this.changeCellState(e,"mouseover"===t.type,0),this.mouseHandler&&this.mouseHandler.runWith([t,i]))},n.changeCellState=function(t,e,i){var n=t.getChildByName("selectBox");n&&(this.selectEnable=!0,n.visible=e,n.index=i)},n.changeSize=function(){laya.ui.Component.prototype.changeSize.call(this),this.setContentSize(this.width,this.height),this._scrollBar&&this.callLater(this.onScrollBarChange)},n.onScrollBarChange=function(t){this.runCallLater(this.changeCells);var e=this._scrollBar.value,i=this._isVertical?this.repeatX:this.repeatY,n=this._isVertical?this.repeatY:this.repeatX,r=Math.floor(e/this._cellSize);if(this.cacheContent)s=n+1,this._createdLine-r<s&&(this._createItems(this._createdLine,i,this._createdLine+s),this._createdLine+=s,this.renderItems(this._createdLine*i,0));else{var a=r*i,s=0;if(a>this._startIndex){s=a-this._startIndex;var o=!0,h=this._startIndex+i*(n+1);this._isMoved=!0}else a<this._startIndex&&(s=this._startIndex-a,o=!1,h=this._startIndex-1,this._isMoved=!0);for(var l=0;s>l;l++){if(o){var u=this._cells.shift();this._cells[this._cells.length]=u;var c=h+l}else u=this._cells.pop(),this._cells.unshift(u),c=h-l;var _=Math.floor(c/i)*this._cellSize;this._isVertical?u.y=_:u.x=_,this.renderItem(u,c)}this._startIndex=a,this.changeSelectStatus()}var d=this._content.scrollRect;this._isVertical?(d.y=e-this._offset.y,d.x=-this._offset.x):(d.y=-this._offset.y,d.x=e-this._offset.x),this._content.conchModel&&this._content.conchModel.scrollRect(d.x,d.y,d.width,d.height),this.repaint()},n.posCell=function(t,e){if(this._scrollBar){var i=this._isVertical?this.repeatX:this.repeatY,n=(this._isVertical?this.repeatY:this.repeatX,Math.floor(e/i)*this._cellSize);this._isVertical?t.y=n:t.x=n}},n.changeSelectStatus=function(){for(var t=0,e=this._cells.length;e>t;t++)this.changeCellState(this._cells[t],this._selectedIndex===this._startIndex+t,1)},n.renderItems=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0);for(var i=t,n=e||this._cells.length;n>i;i++)this.renderItem(this._cells[i],this._startIndex+i);this.changeSelectStatus()},n.renderItem=function(t,e){this._array&&e>=0&&e<this._array.length?(t.visible=!0,t.dataSource=this._array[e],this.cacheContent||this.posCell(t,e),this.hasListener("render")&&this.event("render",[t,e]),this.renderHandler&&this.renderHandler.runWith([t,e])):(t.visible=!1,t.dataSource=null)},n.refresh=function(){this.startIndex=this._startIndex},n.getItem=function(t){return t>-1&&t<this._array.length?this._array[t]:null},n.changeItem=function(t,e){t>-1&&t<this._array.length&&(this._array[t]=e,t>=this._startIndex&&t<this._startIndex+this._cells.length&&this.renderItem(this.getCell(t),t))},n.setItem=function(t,e){this.changeItem(t,e)},n.addItem=function(t){this._array.push(t),this.array=this._array},n.addItemAt=function(t,e){this._array.splice(e,0,t),this.array=this._array},n.deleteItem=function(t){this._array.splice(t,1),this.array=this._array},n.getCell=function(t){return this.runCallLater(this.changeCells),t>-1&&this._cells?this._cells[(t-this._startIndex)%this._cells.length]:null},n.scrollTo=function(t){if(this._scrollBar){var e=this._isVertical?this.repeatX:this.repeatY;this._scrollBar.value=Math.floor(t/e)*this._cellSize}else this.startIndex=t},n.tweenTo=function(t,e,i){if(void 0===e&&(e=200),this._scrollBar){var n=this._isVertical?this.repeatX:this.repeatY;E.to(this._scrollBar,{value:Math.floor(t/n)*this._cellSize},e,null,i,0,!0)}else this.startIndex=t,i&&i.run()},n._setCellChanged=function(){this._cellChanged||(this._cellChanged=!0,this.callLater(this.changeCells))},n.commitMeasure=function(){this.runCallLater(this.changeCells)},a(0,n,"cacheAs",t.prototype._$get_cacheAs,function(e){t.prototype._$set_cacheAs.call(this,e),this._scrollBar&&(this._$P.cacheAs=null,"none"!==e?this._scrollBar.on("start",this,this.onScrollStart):this._scrollBar.off("start",this,this.onScrollStart))}),a(0,n,"content",function(){return this._content}),a(0,n,"height",t.prototype._$get_height,function(e){e!=this._height&&(t.prototype._$set_height.call(this,e),this._setCellChanged())}),a(0,n,"itemRender",function(){return this._itemRender},function(t){if(this._itemRender!=t){this._itemRender=t;for(var e=this._cells.length-1;e>-1;e--)this._cells[e].destroy();this._cells.length=0,this._setCellChanged()}}),a(0,n,"vScrollBarSkin",function(){return this._scrollBar?this._scrollBar.skin:null},function(t){this._removePreScrollBar();var e=new tt;e.name="scrollBar",e.right=0,t&&" "!=t&&(e.skin=t),this.scrollBar=e,this.addChild(e),this._setCellChanged()}),a(0,n,"page",function(){return this._page},function(t){this._page=t,this._array&&(this._page=t>0?t:0,this._page=this._page<this.totalPage?this._page:this.totalPage-1,this.startIndex=this._page*this.repeatX*this.repeatY)}),a(0,n,"hScrollBarSkin",function(){return this._scrollBar?this._scrollBar.skin:null},function(t){this._removePreScrollBar();var e=new q;e.name="scrollBar",e.bottom=0,t&&" "!=t&&(e.skin=t),this.scrollBar=e,this.addChild(e),this._setCellChanged()}),a(0,n,"repeatX",function(){return this._repeatX>0?this._repeatX:this._repeatX2>0?this._repeatX2:1},function(t){this._repeatX=t,this._setCellChanged()}),a(0,n,"scrollBar",function(){return this._scrollBar},function(t){this._scrollBar!=t&&(this._scrollBar=t,t&&(this._isVertical=this._scrollBar.isVertical,this.addChild(this._scrollBar),this._scrollBar.on("change",this,this.onScrollBarChange)))}),a(0,n,"width",t.prototype._$get_width,function(e){e!=this._width&&(t.prototype._$set_width.call(this,e),this._setCellChanged())}),a(0,n,"repeatY",function(){return this._repeatY>0?this._repeatY:this._repeatY2>0?this._repeatY2:1},function(t){this._repeatY=t,this._setCellChanged()}),a(0,n,"spaceX",function(){return this._spaceX},function(t){this._spaceX=t,this._setCellChanged()}),a(0,n,"spaceY",function(){return this._spaceY},function(t){this._spaceY=t,this._setCellChanged()}),a(0,n,"selectedIndex",function(){return this._selectedIndex},function(t){this._selectedIndex!=t&&(this._selectedIndex=t,this.changeSelectStatus(),this.event("change"),this.selectHandler&&this.selectHandler.runWith(t),this.startIndex=this._startIndex)}),a(0,n,"selectedItem",function(){return-1!=this._selectedIndex?this._array[this._selectedIndex]:null},function(t){this.selectedIndex=this._array.indexOf(t)}),a(0,n,"length",function(){return this._array?this._array.length:0}),a(0,n,"selection",function(){return this.getCell(this._selectedIndex)},function(t){this.selectedIndex=this._startIndex+this._cells.indexOf(t)}),a(0,n,"startIndex",function(){return this._startIndex},function(t){this._startIndex=t>0?t:0,this.callLater(this.renderItems)}),a(0,n,"array",function(){return this._array},function(t){this.runCallLater(this.changeCells),this._array=t||[];var e=this._array.length;if(this.totalPage=Math.ceil(e/(this.repeatX*this.repeatY)),this._selectedIndex=this._selectedIndex<e?this._selectedIndex:e-1,this.startIndex=this._startIndex,this._scrollBar){this._scrollBar.stopScroll();var i=this._isVertical?this.repeatX:this.repeatY,n=this._isVertical?this.repeatY:this.repeatX,r=Math.ceil(e/i),a=this._cellOffset>0?this.totalPage+1:this.totalPage;a>1?(this._scrollBar.scrollSize=this._cellSize,this._scrollBar.thumbPercent=n/r,this._scrollBar.setScroll(0,(r-n)*this._cellSize+this._cellOffset,this._scrollBar.value),this._scrollBar.target=this._content):(this._scrollBar.setScroll(0,0,0),this._scrollBar.target=this._content)}}),a(0,n,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e&&Math.floor(e)==e||"string"==typeof e?this.selectedIndex=parseInt(e):e instanceof Array?this.array=e:t.prototype._$set_dataSource.call(this,e)}),a(0,n,"cells",function(){return this.runCallLater(this.changeCells),this._cells}),e}(P),X=function(t){function e(){this._content=null,this._vScrollBar=null,this._hScrollBar=null,this._scrollChanged=!1,e.__super.call(this),this.width=this.height=100,this._content.optimizeScrollRect=!0}r(e,"laya.ui.Panel",t);var i=e.prototype;return i.destroy=function(t){void 0===t&&(t=!0),laya.ui.Component.prototype.destroy.call(this,t),this._content&&this._content.destroy(t),this._vScrollBar&&this._vScrollBar.destroy(t),this._hScrollBar&&this._hScrollBar.destroy(t),this._vScrollBar=null,this._hScrollBar=null,this._content=null},i.destroyChildren=function(){this._content.destroyChildren()},i.createChildren=function(){laya.display.Node.prototype.addChild.call(this,this._content=new P)},i.addChild=function(t){return t.on("resize",this,this.onResize),this._setScrollChanged(),this._content.addChild(t)},i.onResize=function(){this._setScrollChanged()},i.addChildAt=function(t,e){return t.on("resize",this,this.onResize),this._setScrollChanged(),this._content.addChildAt(t,e)},i.removeChild=function(t){return t.off("resize",this,this.onResize),this._setScrollChanged(),this._content.removeChild(t)},i.removeChildAt=function(t){return this.getChildAt(t).off("resize",this,this.onResize),this._setScrollChanged(),this._content.removeChildAt(t)},i.removeChildren=function(t,e){void 0===t&&(t=0),void 0===e&&(e=2147483647);for(var i=this._content.numChildren-1;i>-1;i--)this._content.removeChildAt(i);return this._setScrollChanged(),this},i.getChildAt=function(t){return this._content.getChildAt(t)},i.getChildByName=function(t){return this._content.getChildByName(t)},i.getChildIndex=function(t){return this._content.getChildIndex(t)},i.changeScroll=function(){this._scrollChanged=!1;var t=this.contentWidth||1,e=this.contentHeight||1,i=this._vScrollBar,n=this._hScrollBar,r=i&&e>this._height,a=n&&t>this._width,s=r?this._width-i.width:this._width,o=a?this._height-n.height:this._height;i&&(i.x=this._width-i.width,i.y=0,i.height=this._height-(a?n.height:0),i.scrollSize=Math.max(.033*this._height,1),i.thumbPercent=o/e,i.setScroll(0,e-o,i.value)),n&&(n.x=0,n.y=this._height-n.height,n.width=this._width-(r?i.width:0),n.scrollSize=Math.max(.033*this._width,1),n.thumbPercent=s/t,n.setScroll(0,t-s,n.value))},i.changeSize=function(){laya.ui.Component.prototype.changeSize.call(this),this.setContentSize(this._width,this._height)},i.setContentSize=function(t,e){var i=this._content;i.width=t,i.height=e,i.scrollRect||(i.scrollRect=new y),i.scrollRect.setTo(0,0,t,e),i.conchModel&&i.conchModel.scrollRect(0,0,t,e)},i.onScrollBarChange=function(t){var e=this._content.scrollRect;if(e){var i=Math.round(t.value);t.isVertical?e.y=i:e.x=i,this._content.conchModel&&this._content.conchModel.scrollRect(e.x,e.y,e.width,e.height)}},i.scrollTo=function(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.vScrollBar&&(this.vScrollBar.value=e),this.hScrollBar&&(this.hScrollBar.value=t)},i.refresh=function(){this.changeScroll()},i.onScrollStart=function(){this._$P.cacheAs||(this._$P.cacheAs=t.prototype._$get_cacheAs.call(this)),t.prototype._$set_cacheAs.call(this,"none"),this._hScrollBar&&this._hScrollBar.once("end",this,this.onScrollEnd),this._vScrollBar&&this._vScrollBar.once("end",this,this.onScrollEnd)},i.onScrollEnd=function(){t.prototype._$set_cacheAs.call(this,this._$P.cacheAs)},i._setScrollChanged=function(){this._scrollChanged||(this._scrollChanged=!0,this.callLater(this.changeScroll))},a(0,i,"numChildren",function(){return this._content.numChildren}),a(0,i,"hScrollBarSkin",function(){return this._hScrollBar?this._hScrollBar.skin:null},function(t){null==this._hScrollBar&&(laya.display.Node.prototype.addChild.call(this,this._hScrollBar=new q),this._hScrollBar.on("change",this,this.onScrollBarChange,[this._hScrollBar]),this._hScrollBar.target=this._content,this._setScrollChanged()),this._hScrollBar.skin=t}),a(0,i,"contentWidth",function(){for(var t=0,e=this._content.numChildren-1;e>-1;e--){var i=this._content.getChildAt(e);t=Math.max(i.x+i.width*i.scaleX,t)}return t}),a(0,i,"contentHeight",function(){for(var t=0,e=this._content.numChildren-1;e>-1;e--){var i=this._content.getChildAt(e);t=Math.max(i.y+i.height*i.scaleY,t)}return t}),a(0,i,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this._setScrollChanged()}),a(0,i,"hScrollBar",function(){return this._hScrollBar}),a(0,i,"content",function(){return this._content}),a(0,i,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this._setScrollChanged()}),a(0,i,"vScrollBarSkin",function(){return this._vScrollBar?this._vScrollBar.skin:null},function(t){null==this._vScrollBar&&(laya.display.Node.prototype.addChild.call(this,this._vScrollBar=new tt),this._vScrollBar.on("change",this,this.onScrollBarChange,[this._vScrollBar]),this._vScrollBar.target=this._content,this._setScrollChanged()),this._vScrollBar.skin=t}),a(0,i,"vScrollBar",function(){return this._vScrollBar}),a(0,i,"cacheAs",t.prototype._$get_cacheAs,function(e){t.prototype._$set_cacheAs.call(this,e),this._$P.cacheAs=null,"none"!==e?(this._hScrollBar&&this._hScrollBar.on("start",this,this.onScrollStart),this._vScrollBar&&this._vScrollBar.on("start",this,this.onScrollStart)):(this._hScrollBar&&this._hScrollBar.off("start",this,this.onScrollStart),this._vScrollBar&&this._vScrollBar.off("start",this,this.onScrollStart))}),e}(P),q=function(t){function e(){e.__super.call(this)}r(e,"laya.ui.HScrollBar",t);var i=e.prototype;return i.initialize=function(){t.prototype.initialize.call(this),this.slider.isVertical=!1},e}(F),K=function(t){function e(t){e.__super.call(this,t),this.isVertical=!1}return r(e,"laya.ui.HSlider",t),e}(B),Z=function(t){function e(t,i){this.selectHandler=null,this._items=null,this._selectedIndex=-1,this._skin=null,this._direction="horizontal",this._space=0,this._labels=null,this._labelColors=null,this._labelFont=null,this._labelStrokeColor=null,this._strokeColors=null,this._labelStroke=NaN,this._labelSize=0,this._labelBold=!1,this._labelPadding=null,this._labelAlign=null,this._stateNum=0,this._labelChanged=!1,e.__super.call(this),this.skin=i,this.labels=t}r(e,"laya.ui.UIGroup",t);var n=e.prototype;return i.imps(n,{"laya.ui.IItem":!0}),n.preinitialize=function(){this.mouseEnabled=!0},n.destroy=function(t){void 0===t&&(t=!0),laya.ui.Component.prototype.destroy.call(this,t),this._items&&(this._items.length=0),this._items=null,this.selectHandler=null},n.addItem=function(t,e){void 0===e&&(e=!0);var i=t,n=this._items.length;if(i.name="item"+n,this.addChild(i),this.initItems(),e&&n>0){var r=this._items[n-1];"horizontal"==this._direction?i.x=r.x+r.width+this._space:i.y=r.y+r.height+this._space}else e&&(i.x=0,i.y=0);return n},n.delItem=function(t,e){void 0===e&&(e=!0);var i=this._items.indexOf(t);if(-1!=i){var n=t;this.removeChild(n);for(var r=i+1,a=this._items.length;a>r;r++){var s=this._items[r];s.name="item"+(r-1),e&&("horizontal"==this._direction?s.x-=n.width+this._space:s.y-=n.height+this._space)}if(this.initItems(),this._selectedIndex>-1){var o=0;o=this._selectedIndex<this._items.length?this._selectedIndex:this._selectedIndex-1,this._selectedIndex=-1,this.selectedIndex=o}}},n.initItems=function(){this._items||(this._items=[]),this._items.length=0;for(var t=0;1e4>t;t++){var e=this.getChildByName("item"+t);if(null==e)break;this._items.push(e),e.selected=t===this._selectedIndex,e.clickHandler=f.create(this,this.itemClick,[t],!1)}},n.itemClick=function(t){this.selectedIndex=t},n.setSelect=function(t,e){this._items&&t>-1&&t<this._items.length&&(this._items[t].selected=e)},n.createItem=function(t,e){return null},n.changeLabels=function(){if(this._labelChanged=!1,this._items)for(var t=0,e=0,i=this._items.length;i>e;e++){var n=this._items[e];this._skin&&(n.skin=this._skin),this._labelColors&&(n.labelColors=this._labelColors),this._labelSize&&(n.labelSize=this._labelSize),this._labelStroke&&(n.labelStroke=this._labelStroke),this._labelStrokeColor&&(n.labelStrokeColor=this._labelStrokeColor),this._strokeColors&&(n.strokeColors=this._strokeColors),this._labelBold&&(n.labelBold=this._labelBold),this._labelPadding&&(n.labelPadding=this._labelPadding),this._labelAlign&&(n.labelAlign=this._labelAlign),this._stateNum&&(n.stateNum=this._stateNum),this._labelFont&&(n.labelFont=this._labelFont),"horizontal"===this._direction?(n.y=0,n.x=t,t+=n.width+this._space):(n.x=0,n.y=t,t+=n.height+this._space)}this.changeSize()},n.commitMeasure=function(){this.runCallLater(this.changeLabels)},n._setLabelChanged=function(){this._labelChanged||(this._labelChanged=!0,this.callLater(this.changeLabels))},a(0,n,"labelStrokeColor",function(){return this._labelStrokeColor},function(t){this._labelStrokeColor!=t&&(this._labelStrokeColor=t,this._setLabelChanged())}),a(0,n,"skin",function(){return this._skin},function(t){this._skin!=t&&(this._skin=t,this._setLabelChanged())}),a(0,n,"selectedIndex",function(){return this._selectedIndex},function(t){this._selectedIndex!=t&&(this.setSelect(this._selectedIndex,!1),this._selectedIndex=t,this.setSelect(t,!0),this.event("change"),this.selectHandler&&this.selectHandler.runWith(this._selectedIndex))}),a(0,n,"labels",function(){return this._labels},function(t){if(this._labels!=t){if(this._labels=t,this.removeChildren(),this._setLabelChanged(),this._labels)for(var e=this._labels.split(","),i=0,n=e.length;n>i;i++){var r=this.createItem(this._skin,e[i]);r.name="item"+i,this.addChild(r)}this.initItems()}}),a(0,n,"strokeColors",function(){return this._strokeColors},function(t){this._strokeColors!=t&&(this._strokeColors=t,this._setLabelChanged())}),a(0,n,"labelColors",function(){return this._labelColors},function(t){this._labelColors!=t&&(this._labelColors=t,this._setLabelChanged())}),a(0,n,"labelStroke",function(){return this._labelStroke},function(t){this._labelStroke!=t&&(this._labelStroke=t,this._setLabelChanged())}),a(0,n,"labelSize",function(){return this._labelSize},function(t){this._labelSize!=t&&(this._labelSize=t,this._setLabelChanged())}),a(0,n,"stateNum",function(){return this._stateNum},function(t){this._stateNum!=t&&(this._stateNum=t,this._setLabelChanged())}),a(0,n,"labelBold",function(){return this._labelBold},function(t){this._labelBold!=t&&(this._labelBold=t,this._setLabelChanged())}),a(0,n,"labelFont",function(){return this._labelFont},function(t){this._labelFont!=t&&(this._labelFont=t,this._setLabelChanged())}),a(0,n,"labelPadding",function(){return this._labelPadding},function(t){this._labelPadding!=t&&(this._labelPadding=t,this._setLabelChanged())}),a(0,n,"direction",function(){return this._direction},function(t){this._direction=t,this._setLabelChanged()}),a(0,n,"space",function(){return this._space},function(t){this._space=t,this._setLabelChanged()}),a(0,n,"items",function(){return this._items}),a(0,n,"selection",function(){return this._selectedIndex>-1&&this._selectedIndex<this._items.length?this._items[this._selectedIndex]:null;
},function(t){this.selectedIndex=this._items.indexOf(t)}),a(0,n,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,"number"==typeof e&&Math.floor(e)==e||"string"==typeof e?this.selectedIndex=parseInt(e):e instanceof Array?this.labels=e.join(","):t.prototype._$set_dataSource.call(this,e)}),e}(P),$=function(t){function e(t,i){this._value=null,void 0===i&&(i=""),e.__super.call(this,t,i)}r(e,"laya.ui.Radio",t);var i=e.prototype;return i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._value=null},i.preinitialize=function(){laya.ui.Component.prototype.preinitialize.call(this),this.toggle=!1,this._autoSize=!1},i.initialize=function(){t.prototype.initialize.call(this),this.createText(),this._text.align="left",this._text.valign="top",this._text.width=0,this.on("click",this,this.onClick)},i.onClick=function(t){this.selected=!0},a(0,i,"value",function(){return null!=this._value?this._value:this.label},function(t){this._value=t}),e}(L),Q=function(t){function e(){this._list=null,this._source=null,this._renderHandler=null,this._spaceLeft=10,this._spaceBottom=0,this._keepStatus=!0,e.__super.call(this),this.width=this.height=200}r(e,"laya.ui.Tree",t);var n=e.prototype;return i.imps(n,{"laya.ui.IRender":!0}),n.destroy=function(t){void 0===t&&(t=!0),laya.ui.Component.prototype.destroy.call(this,t),this._list&&this._list.destroy(t),this._list=null,this._source=null,this._renderHandler=null},n.createChildren=function(){this.addChild(this._list=new Y),this._list.renderHandler=f.create(this,this.renderItem,null,!1),this._list.repeatX=1,this._list.on("change",this,this.onListChange)},n.onListChange=function(t){this.event("change")},n.getArray=function(){var t,e=[];for(var i in this._source)t=this._source[i],this.getParentOpenStatus(t)&&(t.x=this._spaceLeft*this.getDepth(t),e.push(t));return e},n.getDepth=function(t,e){return void 0===e&&(e=0),null==t.nodeParent?e:this.getDepth(t.nodeParent,e+1)},n.getParentOpenStatus=function(t){var e=t.nodeParent;return null==e?!0:e.isOpen?null!=e.nodeParent?this.getParentOpenStatus(e):!0:!1},n.renderItem=function(t,e){var i=t.dataSource;if(i){t.left=i.x;var n=t.getChildByName("arrow");n&&(i.hasChild?(n.visible=!0,n.index=i.isOpen?1:0,n.tag=e,n.off("click",this,this.onArrowClick),n.on("click",this,this.onArrowClick)):n.visible=!1);var r=t.getChildByName("folder");r&&(2==r.clipY?r.index=i.isDirectory?0:1:r.index=i.isDirectory?i.isOpen?1:0:2),this._renderHandler&&this._renderHandler.runWith([t,e])}},n.onArrowClick=function(t){var e=t.currentTarget,i=e.tag;this._list.array[i].isOpen=!this._list.array[i].isOpen,this.event("open"),this._list.array=this.getArray()},n.setItemState=function(t,e){this._list.array[t]&&(this._list.array[t].isOpen=e,this._list.array=this.getArray())},n.fresh=function(){this._list.array=this.getArray(),this.repaint()},n.parseXml=function(t,e,i,n){var r,a=t.childNodes,s=a.length;if(!n){r={};var o,h=t.attributes;for(var l in h){o=h[l];var u=o.nodeName,c=o.nodeValue;r[u]="true"==c?!0:"false"==c?!1:c}r.nodeParent=i,s>0&&(r.isDirectory=!0),r.hasChild=s>0,e.push(r)}for(var _=0;s>_;_++){var d=a[_];this.parseXml(d,e,r,!1)}},n.parseOpenStatus=function(t,e){for(var i=0,n=e.length;n>i;i++){var r=e[i];if(r.isDirectory)for(var a=0,s=t.length;s>a;a++){var o=t[a];if(o.isDirectory&&this.isSameParent(o,r)&&r.label==o.label){r.isOpen=o.isOpen;break}}}},n.isSameParent=function(t,e){return null==t.nodeParent&&null==e.nodeParent?!0:null==t.nodeParent||null==e.nodeParent?!1:t.nodeParent.label==e.nodeParent.label?this.isSameParent(t.nodeParent,e.nodeParent):!1},n.filter=function(t){if(Boolean(t)){var e=[];this.getFilterSource(this._source,e,t),this._list.array=e}else this._list.array=this.getArray()},n.getFilterSource=function(t,e,i){i=i.toLocaleLowerCase();var n;for(var r in t)n=t[r],!n.isDirectory&&String(n.label).toLowerCase().indexOf(i)>-1&&(n.x=0,e.push(n)),n.child&&n.child.length>0&&this.getFilterSource(n.child,e,i)},a(0,n,"spaceBottom",function(){return this._list.spaceY},function(t){this._list.spaceY=t}),a(0,n,"keepStatus",function(){return this._keepStatus},function(t){this._keepStatus=t}),a(0,n,"itemRender",function(){return this._list.itemRender},function(t){this._list.itemRender=t}),a(0,n,"array",function(){return this._list.array},function(t){this._keepStatus&&this._list.array&&t&&this.parseOpenStatus(this._list.array,t),this._source=t,this._list.array=this.getArray()}),a(0,n,"mouseHandler",function(){return this._list.mouseHandler},function(t){this._list.mouseHandler=t}),a(0,n,"dataSource",t.prototype._$get_dataSource,function(e){this._dataSource=e,t.prototype._$set_dataSource.call(this,e)}),a(0,n,"source",function(){return this._source}),a(0,n,"scrollBar",function(){return this._list.scrollBar}),a(0,n,"list",function(){return this._list}),a(0,n,"scrollBarSkin",function(){return this._list.vScrollBarSkin},function(t){this._list.vScrollBarSkin=t}),a(0,n,"renderHandler",function(){return this._renderHandler},function(t){this._renderHandler=t}),a(0,n,"selectedIndex",function(){return this._list.selectedIndex},function(t){this._list.selectedIndex=t}),a(0,n,"spaceLeft",function(){return this._spaceLeft},function(t){this._spaceLeft=t}),a(0,n,"selectedItem",function(){return this._list.selectedItem},function(t){this._list.selectedItem=t}),a(0,n,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this._list.width=e}),a(0,n,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this._list.height=e}),a(0,n,"xml",null,function(t){var e=[];this.parseXml(t.childNodes[0],e,null,!0),this.array=e}),a(0,n,"selectedPath",function(){return this._list.selectedItem?this._list.selectedItem.path:null}),e}(P),J=function(t){function e(){this._items=null,this._selectedIndex=0,e.__super.call(this),this._setIndexHandler=f.create(this,this.setIndex,null,!1)}r(e,"laya.ui.ViewStack",t);var n=e.prototype;return i.imps(n,{"laya.ui.IItem":!0}),n.setItems=function(t){this.removeChildren();for(var e=0,i=0,n=t.length;n>i;i++){var r=t[i];r&&(r.name="item"+e,this.addChild(r),e++)}this.initItems()},n.addItem=function(t){t.name="item"+this._items.length,this.addChild(t),this.initItems()},n.initItems=function(){this._items=[];for(var t=0;1e4>t;t++){var e=this.getChildByName("item"+t);if(null==e)break;this._items.push(e),e.visible=t==this._selectedIndex}},n.setSelect=function(t,e){this._items&&t>-1&&t<this._items.length&&(this._items[t].visible=e)},n.setIndex=function(t){this.selectedIndex=t},a(0,n,"dataSource",t.prototype._$get_dataSource,function(t){if(this._dataSource=t,"number"==typeof t&&Math.floor(t)==t||"string"==typeof t)this.selectedIndex=parseInt(t);else for(var e in this._dataSource)this.hasOwnProperty(e)&&(this[e]=this._dataSource[e])}),a(0,n,"selectedIndex",function(){return this._selectedIndex},function(t){this._selectedIndex!=t&&(this.setSelect(this._selectedIndex,!1),this._selectedIndex=t,this.setSelect(this._selectedIndex,!0))}),a(0,n,"selection",function(){return this._selectedIndex>-1&&this._selectedIndex<this._items.length?this._items[this._selectedIndex]:null},function(t){this.selectedIndex=this._items.indexOf(t)}),a(0,n,"items",function(){return this._items}),a(0,n,"setIndexHandler",function(){return this._setIndexHandler},function(t){this._setIndexHandler=t}),e}(P),tt=function(t){function e(){e.__super.call(this)}return r(e,"laya.ui.VScrollBar",t),e}(F),et=function(t){function e(t){this._bg=null,this._skin=null,e.__super.call(this),void 0===t&&(t=""),this.text=t,this.skin=this.skin}r(e,"laya.ui.TextInput",t);var i=e.prototype;return i.preinitialize=function(){this.mouseEnabled=!0},i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._bg&&this._bg.destroy(),this._bg=null},i.createChildren=function(){this.addChild(this._tf=new p),this._tf.padding=C.inputLabelPadding,this._tf.on("input",this,this._onInput),this._tf.on("enter",this,this._onEnter),this._tf.on("blur",this,this._onBlur),this._tf.on("focus",this,this._onFocus)},i._onFocus=function(){this.event("focus",this)},i._onBlur=function(){this.event("blur",this)},i._onInput=function(){this.event("input",this)},i._onEnter=function(){this.event("enter",this)},i.initialize=function(){this.width=128,this.height=22},i.select=function(){this._tf.select()},i.setSelection=function(t,e){this._tf.setSelection(t,e)},a(0,i,"text",t.prototype._$get_text,function(t){this._tf.text!=t&&(t+="",this._tf.text=t,this.event("change"))}),a(0,i,"bg",function(){return this._bg},function(t){this.graphics=this._bg=t}),a(0,i,"inputElementYAdjuster",function(){return this._tf.inputElementYAdjuster},function(t){this._tf.inputElementYAdjuster=t}),a(0,i,"multiline",function(){return this._tf.multiline},function(t){this._tf.multiline=t}),a(0,i,"skin",function(){return this._skin},function(t){this._skin!=t&&(this._skin=t,this._bg||(this.graphics=this._bg=new A),this._bg.source=m.getRes(this._skin),this._width&&(this._bg.width=this._width),this._height&&(this._bg.height=this._height))}),a(0,i,"sizeGrid",function(){return this._bg&&this._bg.sizeGrid?this._bg.sizeGrid.join(","):null},function(t){this._bg||(this.graphics=this._bg=new A),this._bg.sizeGrid=M.fillArray(C.defaultSizeGrid,t,Number)}),a(0,i,"inputElementXAdjuster",function(){return this._tf.inputElementXAdjuster},function(t){this._tf.inputElementXAdjuster=t}),a(0,i,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this._bg&&(this._bg.width=e)}),a(0,i,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this._bg&&(this._bg.height=e)}),a(0,i,"editable",function(){return this._tf.editable},function(t){this._tf.editable=t}),a(0,i,"restrict",function(){return this._tf.restrict},function(t){this._tf.restrict=t}),a(0,i,"prompt",function(){return this._tf.prompt},function(t){this._tf.prompt=t}),a(0,i,"promptColor",function(){return this._tf.promptColor},function(t){this._tf.promptColor=t}),a(0,i,"maxChars",function(){return this._tf.maxChars},function(t){this._tf.maxChars=t}),a(0,i,"focus",function(){return this._tf.focus},function(t){this._tf.focus=t}),a(0,i,"type",function(){return this._tf.type},function(t){this._tf.type=t}),a(0,i,"asPassword",function(){return this._tf.asPassword},function(t){this._tf.asPassword=t}),e}(k),it=function(t){function e(){e.__super.call(this)}return r(e,"laya.ui.VSlider",t),e}(B),nt=function(t){function e(){this.popupCenter=!0,this.closeHandler=null,this.popupEffect=null,this.closeEffect=null,this.group=null,this.isModal=!1,this._dragArea=null,e.__super.call(this)}r(e,"laya.ui.Dialog",t);var i=e.prototype;return i.initialize=function(){this.popupEffect=e.manager.popupEffectHandler,this.closeEffect=e.manager.closeEffectHandler,this._dealDragArea(),this.on("click",this,this._onClick)},i._dealDragArea=function(){var t=this.getChildByName("drag");t&&(this.dragArea=t.x+","+t.y+","+t.width+","+t.height,t.removeSelf())},i._onClick=function(t){var e=t.target;if(e)switch(e.name){case"close":case"cancel":case"sure":case"no":case"ok":case"yes":this.close(e.name)}},i.show=function(t){void 0===t&&(t=!1),this._open(!1,t)},i.popup=function(t){void 0===t&&(t=!1),this._open(!0,t)},i._open=function(t,i){e.manager.lock(!1),this.isModal=t,e.manager.open(this,i)},i.onOpened=function(){},i.close=function(t){e.manager.close(this,t)},i.onClosed=function(t){},i._onMouseDown=function(t){var e=this.getMousePoint();this._dragArea.contains(e.x,e.y)?this.startDrag():this.stopDrag()},a(0,i,"dragArea",function(){return this._dragArea?this._dragArea.toString():null},function(t){if(t){var e=M.fillArray([0,0,0,0],t,Number);this._dragArea=new y(e[0],e[1],e[2],e[3]),this.on("mousedown",this,this._onMouseDown)}else this._dragArea=null,this.off("mousedown",this,this._onMouseDown)}),a(0,i,"isPopup",function(){return null!=this.parent}),a(0,i,"zOrder",t.prototype._$get_zOrder,function(i){t.prototype._$set_zOrder.call(this,i),e.manager._checkMask()}),a(1,e,"manager",function(){return e._manager=e._manager||new I},function(t){e._manager=t}),e.setLockView=function(t){e.manager.setLockView(t)},e.lock=function(t){e.manager.lock(t)},e.closeAll=function(){e.manager.closeAll()},e.getDialogsByGroup=function(t){return e.manager.getDialogsByGroup(t)},e.closeByGroup=function(t){return e.manager.closeByGroup(t)},e.CLOSE="close",e.CANCEL="cancel",e.SURE="sure",e.NO="no",e.OK="ok",e.YES="yes",e._manager=null,e}(z),rt=function(t){function e(){e.__super.call(this)}r(e,"laya.ui.HBox",t);var i=e.prototype;return i.sortItem=function(t){t&&t.sort(function(t,e){return t.x-e.x})},i.changeItems=function(){this._itemChanged=!1;for(var t=[],e=0,i=0,n=this.numChildren;n>i;i++){var r=this.getChildAt(i);r&&r.layoutEnabled&&(t.push(r),e=this._height?this._height:Math.max(e,r.height*r.scaleY))}this.sortItem(t);var a=0;for(i=0,n=t.length;n>i;i++)r=t[i],r.x=a,a+=r.width*r.scaleX+this._space,"top"==this._align?r.y=0:"middle"==this._align?r.y=.5*(e-r.height*r.scaleY):"bottom"==this._align&&(r.y=e-r.height*r.scaleY);this.changeSize()},a(0,i,"height",t.prototype._$get_height,function(e){this._height!=e&&(t.prototype._$set_height.call(this,e),this.callLater(this.changeItems))}),e.NONE="none",e.TOP="top",e.MIDDLE="middle",e.BOTTOM="bottom",e}(G),at=function(t){function e(){e.__super.call(this)}r(e,"laya.ui.VBox",t);var i=e.prototype;return i.changeItems=function(){this._itemChanged=!1;for(var t=[],e=0,i=0,n=this.numChildren;n>i;i++){var r=this.getChildAt(i);r&&r.layoutEnabled&&(t.push(r),e=this._width?this._width:Math.max(e,r.width*r.scaleX))}this.sortItem(t);var a=0;for(i=0,n=t.length;n>i;i++)r=t[i],r.y=a,a+=r.height*r.scaleY+this._space,"left"==this._align?r.x=0:"center"==this._align?r.x=.5*(e-r.width*r.scaleX):"right"==this._align&&(r.x=e-r.width*r.scaleX);this.changeSize()},a(0,i,"width",t.prototype._$get_width,function(e){this._width!=e&&(t.prototype._$set_width.call(this,e),this.callLater(this.changeItems))}),e.NONE="none",e.LEFT="left",e.CENTER="center",e.RIGHT="right",e}(G),st=function(t){function e(){e.__super.call(this)}r(e,"laya.ui.RadioGroup",t);var i=e.prototype;return i.createItem=function(t,e){return new $(t,e)},e}(Z),ot=function(t){function e(){e.__super.call(this)}r(e,"laya.ui.Tab",t);var i=e.prototype;return i.createItem=function(t,e){return new L(t,e)},e}(Z),ht=function(t){function e(t){this._vScrollBar=null,this._hScrollBar=null,void 0===t&&(t=""),e.__super.call(this,t)}r(e,"laya.ui.TextArea",t);var i=e.prototype;return i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._vScrollBar&&this._vScrollBar.destroy(),this._hScrollBar&&this._hScrollBar.destroy(),this._vScrollBar=null,this._hScrollBar=null},i.initialize=function(){this.width=180,this.height=150,this._tf.wordWrap=!0,this.multiline=!0},i.onVBarChanged=function(t){this._tf.scrollY!=this._vScrollBar.value&&(this._tf.scrollY=this._vScrollBar.value)},i.onHBarChanged=function(t){this._tf.scrollX!=this._hScrollBar.value&&(this._tf.scrollX=this._hScrollBar.value)},i.changeScroll=function(){var t=this._vScrollBar&&this._tf.maxScrollY>0,e=this._hScrollBar&&this._tf.maxScrollX>0,i=t?this._width-this._vScrollBar.width:this._width,n=e?this._height-this._hScrollBar.height:this._height,r=this._tf.padding||C.labelPadding;this._tf.width=i,this._tf.height=n,this._vScrollBar&&(this._vScrollBar.x=this._width-this._vScrollBar.width-r[2],this._vScrollBar.y=r[1],this._vScrollBar.height=this._height-(e?this._hScrollBar.height:0)-r[1]-r[3],this._vScrollBar.scrollSize=1,this._vScrollBar.thumbPercent=n/Math.max(this._tf.textHeight,n),this._vScrollBar.setScroll(1,this._tf.maxScrollY,this._tf.scrollY),this._vScrollBar.visible=t),this._hScrollBar&&(this._hScrollBar.x=r[0],this._hScrollBar.y=this._height-this._hScrollBar.height-r[3],this._hScrollBar.width=this._width-(t?this._vScrollBar.width:0)-r[0]-r[2],this._hScrollBar.scrollSize=Math.max(.033*i,1),this._hScrollBar.thumbPercent=i/Math.max(this._tf.textWidth,i),this._hScrollBar.setScroll(0,this.maxScrollX,this.scrollX),this._hScrollBar.visible=e)},i.scrollTo=function(t){this.commitMeasure(),this._tf.scrollY=t},a(0,i,"scrollY",function(){return this._tf.scrollY}),a(0,i,"width",t.prototype._$get_width,function(e){t.prototype._$set_width.call(this,e),this.callLater(this.changeScroll)}),a(0,i,"hScrollBar",function(){return this._hScrollBar}),a(0,i,"height",t.prototype._$get_height,function(e){t.prototype._$set_height.call(this,e),this.callLater(this.changeScroll)}),a(0,i,"maxScrollX",function(){return this._tf.maxScrollX}),a(0,i,"vScrollBarSkin",function(){return this._vScrollBar?this._vScrollBar.skin:null},function(t){null==this._vScrollBar&&(this.addChild(this._vScrollBar=new tt),this._vScrollBar.on("change",this,this.onVBarChanged),this._vScrollBar.target=this._tf,this.callLater(this.changeScroll)),this._vScrollBar.skin=t}),a(0,i,"hScrollBarSkin",function(){return this._hScrollBar?this._hScrollBar.skin:null},function(t){null==this._hScrollBar&&(this.addChild(this._hScrollBar=new q),this._hScrollBar.on("change",this,this.onHBarChanged),this._hScrollBar.mouseWheelEnable=!1,this._hScrollBar.target=this._tf,this.callLater(this.changeScroll)),this._hScrollBar.skin=t}),a(0,i,"vScrollBar",function(){return this._vScrollBar}),a(0,i,"maxScrollY",function(){return this._tf.maxScrollY}),a(0,i,"scrollX",function(){return this._tf.scrollX}),e}(et);(function(t){function e(){this._uiView=null,this.isCloseOther=!1,e.__super.call(this)}r(e,"laya.ui.AsynDialog",t);var i=e.prototype;return i.createView=function(t){this._uiView=t},i._open=function(t,e){this.isModal=t,this.isCloseOther=e,nt.manager.lock(!0),this._uiView?this.onCreated():this.onOpen()},i.onCreated=function(){this.createUI(),this.onOpen()},i.createUI=function(){laya.ui.View.prototype.createView.call(this,this._uiView),this._uiView=null,this._dealDragArea()},i.onOpen=function(){nt.manager.open(this,this.isCloseOther),nt.manager.lock(!1)},i.close=function(t){nt.manager.close(this),this.onClose()},i.onClose=function(){},i.destroy=function(t){void 0===t&&(t=!0),laya.ui.View.prototype.destroy.call(this,t),this._uiView=null,this.onDestroy()},i.onDestroy=function(){},e})(nt);i.__init([z])}(window,document,Laya)}).call(window)}]);